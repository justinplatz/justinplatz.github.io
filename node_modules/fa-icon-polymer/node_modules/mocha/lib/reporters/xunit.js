'use strict';var Base=require("./base"),utils=require("../utils"),inherits=utils.inherits,fs=require("fs"),escape=utils.escape,mkdirp=require("mkdirp"),path=require("path"),Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;exports=module.exports=XUnit;function XUnit(runner,options){Base.call(this,runner);var stats=this.stats,tests=[],self=this;if(options&&options.reporterOptions&&options.reporterOptions.output){if(!fs.createWriteStream){throw new Error("file output not supported in browser")}mkdirp.sync(path.dirname(options.reporterOptions.output));self.fileStream=fs.createWriteStream(options.reporterOptions.output)}runner.on("pending",function(test){tests.push(test)});runner.on("pass",function(test){tests.push(test)});runner.on("fail",function(test){tests.push(test)});runner.on("end",function(){self.write(tag("testsuite",{name:"Mocha Tests",tests:stats.tests,failures:stats.failures,errors:stats.failures,skipped:stats.tests-stats.failures-stats.passes,timestamp:new Date().toUTCString(),time:stats.duration/1e3||0},!1));tests.forEach(function(t){self.test(t)});self.write("</testsuite>")})}inherits(XUnit,Base);XUnit.prototype.done=function(failures,fn){if(this.fileStream){this.fileStream.end(function(){fn(failures)})}else{fn(failures)}};XUnit.prototype.write=function(line){if(this.fileStream){this.fileStream.write(line+"\n")}else if("object"===typeof process&&process.stdout){process.stdout.write(line+"\n")}else{console.log(line)}};XUnit.prototype.test=function(test){var attrs={classname:test.parent.fullTitle(),name:test.title,time:test.duration/1e3||0};if("failed"===test.state){var err=test.err;this.write(tag("testcase",attrs,!1,tag("failure",{},!1,escape(err.message)+"\n"+escape(err.stack))))}else if(test.isPending()){this.write(tag("testcase",attrs,!1,tag("skipped",{},!0)))}else{this.write(tag("testcase",attrs,!0))}};function tag(name,attrs,close,content){var end=close?"/>":">",pairs=[],tag;for(var key in attrs){if(Object.prototype.hasOwnProperty.call(attrs,key)){pairs.push(key+"=\""+escape(attrs[key])+"\"")}}tag="<"+name+(pairs.length?" "+pairs.join(" "):"")+end;if(content){tag+=content+"</"+name+end}return tag}