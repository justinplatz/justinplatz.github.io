'use strict';var tty=require("tty"),diff=require("diff"),ms=require("../ms"),utils=require("../utils"),supportsColor=process.browser?null:require("supports-color");exports=module.exports=Base;var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval,isatty=tty.isatty(1)&&tty.isatty(2);exports.useColors=!process.browser&&(supportsColor||process.env.MOCHA_COLORS!==void 0);exports.inlineDiffs=!1;exports.colors={pass:90,fail:31,"bright pass":92,"bright fail":91,"bright yellow":93,pending:36,suite:0,"error title":0,"error message":31,"error stack":90,checkmark:32,fast:90,medium:33,slow:31,green:32,light:90,"diff gutter":90,"diff added":32,"diff removed":31};exports.symbols={ok:"\u2713",err:"\u2716",dot:"\u2024",comma:",",bang:"!"};if("win32"===process.platform){exports.symbols.ok="\u221A";exports.symbols.err="\xD7";exports.symbols.dot="."}var color=exports.color=function(type,str){if(!exports.useColors){return str+""}return"\x1B["+exports.colors[type]+"m"+str+"\x1B[0m"};exports.window={width:75};if(isatty){exports.window.width=process.stdout.getWindowSize?process.stdout.getWindowSize(1)[0]:tty.getWindowSize()[1]}exports.cursor={hide:function(){isatty&&process.stdout.write("\x1B[?25l")},show:function(){isatty&&process.stdout.write("\x1B[?25h")},deleteLine:function(){isatty&&process.stdout.write("\x1B[2K")},beginningOfLine:function(){isatty&&process.stdout.write("\x1B[0G")},CR:function(){if(isatty){exports.cursor.deleteLine();exports.cursor.beginningOfLine()}else{process.stdout.write("\r")}}};exports.list=function(failures){console.log();failures.forEach(function(test,i){var fmt=color("error title","  %s) %s:\n")+color("error message","     %s")+color("error stack","\n%s\n"),msg,err=test.err,message;if(err.message&&"function"===typeof err.message.toString){message=err.message+""}else if("function"===typeof err.inspect){message=err.inspect()+""}else{message=""}var stack=err.stack||message,index=message?stack.indexOf(message):-1,actual=err.actual,expected=err.expected,escape=!0;if(-1===index){msg=message}else{index+=message.length;msg=stack.slice(0,index);stack=stack.slice(index+1)}if(err.uncaught){msg="Uncaught "+msg}if(!1!==err.showDiff&&sameType(actual,expected)&&expected!==void 0){escape=!1;if(!(utils.isString(actual)&&utils.isString(expected))){err.actual=actual=utils.stringify(actual);err.expected=expected=utils.stringify(expected)}fmt=color("error title","  %s) %s:\n%s")+color("error stack","\n%s\n");var match=message.match(/^([^:]+): expected/);msg="\n      "+color("error message",match?match[1]:msg);if(exports.inlineDiffs){msg+=inlineDiff(err,escape)}else{msg+=unifiedDiff(err,escape)}}stack=stack.replace(/^/gm,"  ");console.log(fmt,i+1,test.fullTitle(),msg,stack)})};function Base(runner){var stats=this.stats={suites:0,tests:0,passes:0,pending:0,failures:0},failures=this.failures=[];if(!runner){return}this.runner=runner;runner.stats=stats;runner.on("start",function(){stats.start=new Date});runner.on("suite",function(suite){stats.suites=stats.suites||0;suite.root||stats.suites++});runner.on("test end",function(){stats.tests=stats.tests||0;stats.tests++});runner.on("pass",function(test){stats.passes=stats.passes||0;if(test.duration>test.slow()){test.speed="slow"}else if(test.duration>test.slow()/2){test.speed="medium"}else{test.speed="fast"}stats.passes++});runner.on("fail",function(test,err){stats.failures=stats.failures||0;stats.failures++;test.err=err;failures.push(test)});runner.on("end",function(){stats.end=new Date;stats.duration=new Date-stats.start});runner.on("pending",function(){stats.pending++})}Base.prototype.epilogue=function(){var stats=this.stats,fmt;console.log();fmt=color("bright pass"," ")+color("green"," %d passing")+color("light"," (%s)");console.log(fmt,stats.passes||0,ms(stats.duration));if(stats.pending){fmt=color("pending"," ")+color("pending"," %d pending");console.log(fmt,stats.pending)}if(stats.failures){fmt=color("fail","  %d failing");console.log(fmt,stats.failures);Base.list(this.failures);console.log()}console.log()};function pad(str,len){str=str+"";return Array(len-str.length+1).join(" ")+str}function inlineDiff(err,escape){var msg=errorDiff(err,"WordsWithSpace",escape),lines=msg.split("\n");if(4<lines.length){var width=(lines.length+"").length;msg=lines.map(function(str,i){return pad(++i,width)+" |"+" "+str}).join("\n")}msg="\n"+color("diff removed","actual")+" "+color("diff added","expected")+"\n\n"+msg+"\n";msg=msg.replace(/^/gm,"      ");return msg}function unifiedDiff(err,escape){var indent="      ";function cleanUp(line){if(escape){line=escapeInvisibles(line)}if("+"===line[0]){return indent+colorLines("diff added",line)}if("-"===line[0]){return indent+colorLines("diff removed",line)}if(line.match(/@@/)){return null}if(line.match(/\\ No newline/)){return null}return indent+line}function notBlank(line){return"undefined"!==typeof line&&null!==line}var msg=diff.createPatch("string",err.actual,err.expected),lines=msg.split("\n").splice(4);return"\n      "+colorLines("diff added","+ expected")+" "+colorLines("diff removed","- actual")+"\n\n"+lines.map(cleanUp).filter(notBlank).join("\n")}function errorDiff(err,type,escape){var actual=escape?escapeInvisibles(err.actual):err.actual,expected=escape?escapeInvisibles(err.expected):err.expected;return diff["diff"+type](actual,expected).map(function(str){if(str.added){return colorLines("diff added",str.value)}if(str.removed){return colorLines("diff removed",str.value)}return str.value}).join("")}function escapeInvisibles(line){return line.replace(/\t/g,"<tab>").replace(/\r/g,"<CR>").replace(/\n/g,"<LF>\n")}function colorLines(name,str){return str.split("\n").map(function(str){return color(name,str)}).join("\n")}var objToString=Object.prototype.toString;function sameType(a,b){return objToString.call(a)===objToString.call(b)}