'use strict';var escapeRe=require("escape-string-regexp"),path=require("path"),reporters=require("./reporters"),utils=require("./utils");exports=module.exports=Mocha;if(!process.browser){var cwd=process.cwd();module.paths.push(cwd,path.join(cwd,"node_modules"))}exports.utils=utils;exports.interfaces=require("./interfaces");exports.reporters=reporters;exports.Runnable=require("./runnable");exports.Context=require("./context");exports.Runner=require("./runner");exports.Suite=require("./suite");exports.Hook=require("./hook");exports.Test=require("./test");function image(name){return path.join(__dirname,"../images",name+".png")}function Mocha(options){options=options||{};this.files=[];this.options=options;if(options.grep){this.grep(new RegExp(options.grep))}if(options.fgrep){this.fgrep(options.fgrep)}this.suite=new exports.Suite("",new exports.Context());this.ui(options.ui);this.bail(options.bail);this.reporter(options.reporter,options.reporterOptions);if("undefined"!==typeof options.timeout&&null!==options.timeout){this.timeout(options.timeout)}if("undefined"!==typeof options.retries&&null!==options.retries){this.retries(options.retries)}this.useColors(options.useColors);if(null!==options.enableTimeouts){this.enableTimeouts(options.enableTimeouts)}if(options.slow){this.slow(options.slow)}}Mocha.prototype.bail=function(bail){if(!arguments.length){bail=!0}this.suite.bail(bail);return this};Mocha.prototype.addFile=function(file){this.files.push(file);return this};Mocha.prototype.reporter=function(reporter,reporterOptions){if("function"===typeof reporter){this._reporter=reporter}else{reporter=reporter||"spec";var _reporter;if(reporters[reporter]){_reporter=reporters[reporter]}if(!_reporter){try{_reporter=require(reporter)}catch(err){if(-1!==err.message.indexOf("Cannot find module")){try{_reporter=require(path.resolve(process.cwd(),reporter))}catch(_err){-1!==err.message.indexOf("Cannot find module")?console.warn("\""+reporter+"\" reporter not found"):console.warn("\""+reporter+"\" reporter blew up with error:\n"+err.stack)}}else{console.warn("\""+reporter+"\" reporter blew up with error:\n"+err.stack)}}}if(!_reporter&&"teamcity"===reporter){console.warn("The Teamcity reporter was moved to a package named "+"mocha-teamcity-reporter "+"(https://npmjs.org/package/mocha-teamcity-reporter).")}if(!_reporter){throw new Error("invalid reporter \""+reporter+"\"")}this._reporter=_reporter}this.options.reporterOptions=reporterOptions;return this};Mocha.prototype.ui=function(name){name=name||"bdd";this._ui=exports.interfaces[name];if(!this._ui){try{this._ui=require(name)}catch(err){throw new Error("invalid interface \""+name+"\"")}}this._ui=this._ui(this.suite);this.suite.on("pre-require",function(context){exports.afterEach=context.afterEach||context.teardown;exports.after=context.after||context.suiteTeardown;exports.beforeEach=context.beforeEach||context.setup;exports.before=context.before||context.suiteSetup;exports.describe=context.describe||context.suite;exports.it=context.it||context.test;exports.xit=context.xit||context.test.skip;exports.setup=context.setup||context.beforeEach;exports.suiteSetup=context.suiteSetup||context.before;exports.suiteTeardown=context.suiteTeardown||context.after;exports.suite=context.suite||context.describe;exports.teardown=context.teardown||context.afterEach;exports.test=context.test||context.it;exports.run=context.run});return this};Mocha.prototype.loadFiles=function(fn){var self=this,suite=this.suite;this.files.forEach(function(file){file=path.resolve(file);suite.emit("pre-require",global,file,self);suite.emit("require",require(file),file,self);suite.emit("post-require",global,file,self)});fn&&fn()};Mocha.prototype._growl=function(runner,reporter){var notify=require("growl");runner.on("end",function(){var stats=reporter.stats;if(stats.failures){var msg=stats.failures+" of "+runner.total+" tests failed";notify(msg,{name:"mocha",title:"Failed",image:image("error")})}else{notify(stats.passes+" tests passed in "+stats.duration+"ms",{name:"mocha",title:"Passed",image:image("ok")})}})};Mocha.prototype.fgrep=function(str){return this.grep(new RegExp(escapeRe(str)))};Mocha.prototype.grep=function(re){if(utils.isString(re)){var arg=re.match(/^\/(.*)\/(g|i|)$|.*/);this.options.grep=new RegExp(arg[1]||arg[0],arg[2])}else{this.options.grep=re}return this};Mocha.prototype.invert=function(){this.options.invert=!0;return this};Mocha.prototype.ignoreLeaks=function(ignore){this.options.ignoreLeaks=!!ignore;return this};Mocha.prototype.checkLeaks=function(){this.options.ignoreLeaks=!1;return this};Mocha.prototype.fullTrace=function(){this.options.fullStackTrace=!0;return this};Mocha.prototype.growl=function(){this.options.growl=!0;return this};Mocha.prototype.globals=function(globals){this.options.globals=(this.options.globals||[]).concat(globals);return this};Mocha.prototype.useColors=function(colors){if(colors!==void 0){this.options.useColors=colors}return this};Mocha.prototype.useInlineDiffs=function(inlineDiffs){this.options.useInlineDiffs=inlineDiffs!==void 0&&inlineDiffs;return this};Mocha.prototype.timeout=function(timeout){this.suite.timeout(timeout);return this};Mocha.prototype.retries=function(n){this.suite.retries(n);return this};Mocha.prototype.slow=function(slow){this.suite.slow(slow);return this};Mocha.prototype.enableTimeouts=function(enabled){this.suite.enableTimeouts(arguments.length&&enabled!==void 0?enabled:!0);return this};Mocha.prototype.asyncOnly=function(){this.options.asyncOnly=!0;return this};Mocha.prototype.noHighlighting=function(){this.options.noHighlighting=!0;return this};Mocha.prototype.allowUncaught=function(){this.options.allowUncaught=!0;return this};Mocha.prototype.delay=function delay(){this.options.delay=!0;return this};Mocha.prototype.forbidOnly=function(){this.options.forbidOnly=!0;return this};Mocha.prototype.forbidPending=function(){this.options.forbidPending=!0;return this};Mocha.prototype.run=function(fn){if(this.files.length){this.loadFiles()}var suite=this.suite,options=this.options;options.files=this.files;var runner=new exports.Runner(suite,options.delay),reporter=new this._reporter(runner,options);runner.ignoreLeaks=!1!==options.ignoreLeaks;runner.fullStackTrace=options.fullStackTrace;runner.hasOnly=options.hasOnly;runner.asyncOnly=options.asyncOnly;runner.allowUncaught=options.allowUncaught;runner.forbidOnly=options.forbidOnly;runner.forbidPending=options.forbidPending;if(options.grep){runner.grep(options.grep,options.invert)}if(options.globals){runner.globals(options.globals)}if(options.growl){this._growl(runner,reporter)}if(options.useColors!==void 0){exports.reporters.Base.useColors=options.useColors}exports.reporters.Base.inlineDiffs=options.useInlineDiffs;function done(failures){if(reporter.done){reporter.done(failures,fn)}else{fn&&fn(failures)}}return runner.run(done)};