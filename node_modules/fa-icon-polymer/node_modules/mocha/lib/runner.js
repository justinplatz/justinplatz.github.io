'use strict';var EventEmitter=require("events").EventEmitter,Pending=require("./pending"),utils=require("./utils"),inherits=utils.inherits,debug=require("debug")("mocha:runner"),Runnable=require("./runnable"),filter=utils.filter,indexOf=utils.indexOf,some=utils.some,keys=utils.keys,stackFilter=utils.stackTraceFilter(),stringify=utils.stringify,type=utils.type,undefinedError=utils.undefinedError,isArray=utils.isArray,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner;function Runner(suite,delay){var self=this;this._globals=[];this._abort=!1;this._delay=delay;this.suite=suite;this.started=!1;this.total=suite.total();this.failures=0;this.on("test end",function(test){self.checkGlobals(test)});this.on("hook end",function(hook){self.checkGlobals(hook)});this._defaultGrep=/.*/;this.grep(this._defaultGrep);this.globals(this.globalProps().concat(extraGlobals()))}Runner.immediately=global.setImmediate||process.nextTick;inherits(Runner,EventEmitter);Runner.prototype.grep=function(re,invert){debug("grep %s",re);this._grep=re;this._invert=invert;this.total=this.grepTotal(this.suite);return this};Runner.prototype.grepTotal=function(suite){var self=this,total=0;suite.eachTest(function(test){var match=self._grep.test(test.fullTitle());if(self._invert){match=!match}if(match){total++}});return total};Runner.prototype.globalProps=function(){for(var props=keys(global),i=0;i<globals.length;++i){if(~indexOf(props,globals[i])){continue}props.push(globals[i])}return props};Runner.prototype.globals=function(arr){if(!arguments.length){return this._globals}debug("globals %j",arr);this._globals=this._globals.concat(arr);return this};Runner.prototype.checkGlobals=function(test){if(this.ignoreLeaks){return}var ok=this._globals,globals=this.globalProps(),leaks;if(test){ok=ok.concat(test._allowedGlobals||[])}if(this.prevGlobalsLength===globals.length){return}this.prevGlobalsLength=globals.length;leaks=filterLeaks(ok,globals);this._globals=this._globals.concat(leaks);if(1<leaks.length){this.fail(test,new Error("global leaks detected: "+leaks.join(", ")+""))}else if(leaks.length){this.fail(test,new Error("global leak detected: "+leaks[0]))}};Runner.prototype.fail=function(test,err){if(test.isPending()){return}++this.failures;test.state="failed";if(!(err instanceof Error||err&&"string"===typeof err.message)){err=new Error("the "+type(err)+" "+stringify(err)+" was thrown, throw an Error :)")}try{err.stack=this.fullStackTrace||!err.stack?err.stack:stackFilter(err.stack)}catch(ignored){}this.emit("fail",test,err)};Runner.prototype.failHook=function(hook,err){if(hook.ctx&&hook.ctx.currentTest){hook.originalTitle=hook.originalTitle||hook.title;hook.title=hook.originalTitle+" for \""+hook.ctx.currentTest.title+"\""}this.fail(hook,err);if(this.suite.bail()){this.emit("end")}};Runner.prototype.hook=function(name,fn){var suite=this.suite,hooks=suite["_"+name],self=this;function next(i){var hook=hooks[i];if(!hook){return fn()}self.currentRunnable=hook;hook.ctx.currentTest=self.test;self.emit("hook",hook);if(!hook.listeners("error").length){hook.on("error",function(err){self.failHook(hook,err)})}hook.run(function(err){var testError=hook.error();if(testError){self.fail(self.test,testError)}if(err){if(err instanceof Pending){if("beforeEach"===name||"afterEach"===name){self.test.pending=!0}else{utils.forEach(suite.tests,function(test){test.pending=!0});hook.pending=!0}}else{self.failHook(hook,err);return fn(err)}}self.emit("hook end",hook);delete hook.ctx.currentTest;next(++i)})}Runner.immediately(function(){next(0)})};Runner.prototype.hooks=function(name,suites,fn){var self=this,orig=this.suite;function next(suite){self.suite=suite;if(!suite){self.suite=orig;return fn()}self.hook(name,function(err){if(err){var errSuite=self.suite;self.suite=orig;return fn(err,errSuite)}next(suites.pop())})}next(suites.pop())};Runner.prototype.hookUp=function(name,fn){var suites=[this.suite].concat(this.parents()).reverse();this.hooks(name,suites,fn)};Runner.prototype.hookDown=function(name,fn){var suites=[this.suite].concat(this.parents());this.hooks(name,suites,fn)};Runner.prototype.parents=function(){var suite=this.suite,suites=[];while(suite.parent){suite=suite.parent;suites.push(suite)}return suites};Runner.prototype.runTest=function(fn){var self=this,test=this.test;if(!test){return}if(this.asyncOnly){test.asyncOnly=!0}test.on("error",function(err){self.fail(test,err)});if(this.allowUncaught){test.allowUncaught=!0;return test.run(fn)}try{test.run(fn)}catch(err){fn(err)}};Runner.prototype.runTests=function(suite,fn){var self=this,tests=suite.tests.slice(),test;function hookErr(_,errSuite,after){var orig=self.suite;self.suite=after?errSuite.parent:errSuite;if(self.suite){self.hookUp("afterEach",function(err2,errSuite2){self.suite=orig;if(err2){return hookErr(err2,errSuite2,!0)}fn(errSuite)})}else{self.suite=orig;fn(errSuite)}}function next(err,errSuite){if(self.failures&&suite._bail){return fn()}if(self._abort){return fn()}if(err){return hookErr(err,errSuite,!0)}test=tests.shift();if(!test){return fn()}var match=self._grep.test(test.fullTitle());if(self._invert){match=!match}if(!match){if(self._grep!==self._defaultGrep){Runner.immediately(next)}else{next()}return}if(test.isPending()){self.emit("pending",test);self.emit("test end",test);return next()}self.emit("test",self.test=test);self.hookDown("beforeEach",function(err,errSuite){if(test.isPending()){self.emit("pending",test);self.emit("test end",test);return next()}if(err){return hookErr(err,errSuite,!1)}self.currentRunnable=self.test;self.runTest(function(err){test=self.test;if(err){var retry=test.currentRetry();if(err instanceof Pending){test.pending=!0;self.emit("pending",test)}else if(retry<test.retries()){var clonedTest=test.clone();clonedTest.currentRetry(retry+1);tests.unshift(clonedTest);return self.hookUp("afterEach",next)}else{self.fail(test,err)}self.emit("test end",test);if(err instanceof Pending){return next()}return self.hookUp("afterEach",next)}test.state="passed";self.emit("pass",test);self.emit("test end",test);self.hookUp("afterEach",next)})})}this.next=next;this.hookErr=hookErr;next()};Runner.prototype.runSuite=function(suite,fn){var i=0,self=this,total=this.grepTotal(suite),afterAllHookCalled=!1;debug("run suite %s",suite.fullTitle());if(!total||self.failures&&suite._bail){return fn()}this.emit("suite",this.suite=suite);function next(errSuite){if(errSuite){if(errSuite===suite){return done()}return done(errSuite)}if(self._abort){return done()}var curr=suite.suites[i++];if(!curr){return done()}if(self._grep!==self._defaultGrep){Runner.immediately(function(){self.runSuite(curr,next)})}else{self.runSuite(curr,next)}}function done(errSuite){self.suite=suite;self.nextSuite=next;if(afterAllHookCalled){fn(errSuite)}else{afterAllHookCalled=!0;delete self.test;self.hook("afterAll",function(){self.emit("suite end",suite);fn(errSuite)})}}this.nextSuite=next;this.hook("beforeAll",function(err){if(err){return done()}self.runTests(suite,next)})};Runner.prototype.uncaught=function(err){if(err){debug("uncaught exception %s",err===function(){return this}.call(err)?err.message||err:err)}else{debug("uncaught undefined exception");err=undefinedError()}err.uncaught=!0;var runnable=this.currentRunnable;if(!runnable){runnable=new Runnable("Uncaught error outside test suite");runnable.parent=this.suite;if(this.started){this.fail(runnable,err)}else{this.emit("start");this.fail(runnable,err);this.emit("end")}return}runnable.clearTimeout();if(runnable.state||runnable.isPending()){return}this.fail(runnable,err);if("test"===runnable.type){this.emit("test end",runnable);this.hookUp("afterEach",this.next);return}if("hook"===runnable.type){var errSuite=this.suite;if(-1<runnable.fullTitle().indexOf("after each")){return this.hookErr(err,errSuite,!0)}if(-1<runnable.fullTitle().indexOf("before each")){return this.hookErr(err,errSuite,!1)}return this.nextSuite(errSuite)}this.emit("end")};function cleanSuiteReferences(suite){function cleanArrReferences(arr){for(var i=0;i<arr.length;i++){delete arr[i].fn}}if(isArray(suite._beforeAll)){cleanArrReferences(suite._beforeAll)}if(isArray(suite._beforeEach)){cleanArrReferences(suite._beforeEach)}if(isArray(suite._afterAll)){cleanArrReferences(suite._afterAll)}if(isArray(suite._afterEach)){cleanArrReferences(suite._afterEach)}for(var i=0;i<suite.tests.length;i++){delete suite.tests[i].fn}}Runner.prototype.run=function(fn){var self=this,rootSuite=this.suite;if(this.hasOnly){filterOnly(rootSuite)}fn=fn||function(){};function uncaught(err){self.uncaught(err)}function start(){self.started=!0;self.emit("start");self.runSuite(rootSuite,function(){debug("finished running");self.emit("end")})}debug("start");this.on("suite end",cleanSuiteReferences);this.on("end",function(){if(self.forbidOnly&&self.hasOnly){self.failures+=self.stats.tests}if(self.forbidPending){self.failures+=self.stats.pending}debug("end");process.removeListener("uncaughtException",uncaught);fn(self.failures)});process.on("uncaughtException",uncaught);if(this._delay){this.emit("waiting",rootSuite);rootSuite.once("run",start)}else{start()}return this};Runner.prototype.abort=function(){debug("aborting");this._abort=!0;return this};function filterOnly(suite){if(suite._onlyTests.length){suite.tests=suite._onlyTests;suite.suites=[]}else{suite.tests=[];utils.forEach(suite._onlySuites,function(onlySuite){if(hasOnly(onlySuite)){filterOnly(onlySuite)}});suite.suites=filter(suite.suites,function(childSuite){return-1!==indexOf(suite._onlySuites,childSuite)||filterOnly(childSuite)})}return suite.tests.length||suite.suites.length}function hasOnly(suite){return suite._onlyTests.length||suite._onlySuites.length||some(suite.suites,hasOnly)}function filterLeaks(ok,globals){return filter(globals,function(key){if(/^\d+/.test(key)){return!1}if(global.navigator&&/^getInterface/.test(key)){return!1}if(global.navigator&&/^\d+/.test(key)){return!1}if(/^mocha-/.test(key)){return!1}var matched=filter(ok,function(ok){if(~ok.indexOf("*")){return 0===key.indexOf(ok.split("*")[0])}return key===ok});return!matched.length&&(!global.navigator||"onerror"!==key)})}function extraGlobals(){if("object"===typeof process&&"string"===typeof process.version){var parts=process.version.split("."),nodeVersion=utils.reduce(parts,function(a,v){return a<<8|v});if(2315>nodeVersion){return["errno"]}}return[]}