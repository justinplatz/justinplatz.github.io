'use strict';var JSON=require("json3"),basename=require("path").basename,debug=require("debug")("mocha:watch"),exists=require("fs").existsSync||require("path").existsSync,glob=require("glob"),path=require("path"),join=path.join,readdirSync=require("fs").readdirSync,statSync=require("fs").statSync,watchFile=require("fs").watchFile,lstatSync=require("fs").lstatSync,toISOString=require("./to-iso-string"),he=require("he"),ignore=["node_modules",".git"];exports.inherits=require("util").inherits;exports.escape=function(html){return he.encode(html+"",{useNamedReferences:!1})};exports.forEach=function(arr,fn,scope){for(var i=0,l=arr.length;i<l;i++){fn.call(scope,arr[i],i)}};exports.isString=function(obj){return"string"===typeof obj};exports.map=function(arr,fn,scope){for(var result=[],i=0,l=arr.length;i<l;i++){result.push(fn.call(scope,arr[i],i,arr))}return result};var indexOf=exports.indexOf=function(arr,obj,start){for(var i=start||0,l=arr.length;i<l;i++){if(arr[i]===obj){return i}}return-1},reduce=exports.reduce=function(arr,fn,val){for(var rval=val,i=0,l=arr.length;i<l;i++){rval=fn(rval,arr[i],i,arr)}return rval};exports.filter=function(arr,fn){for(var ret=[],i=0,l=arr.length,val;i<l;i++){val=arr[i];if(fn(val,i,arr)){ret.push(val)}}return ret};exports.some=function(arr,fn){for(var i=0,l=arr.length;i<l;i++){if(fn(arr[i])){return!0}}return!1};exports.keys="function"===typeof Object.keys?Object.keys:function(obj){var keys=[],has=Object.prototype.hasOwnProperty;for(var key in obj){if(has.call(obj,key)){keys.push(key)}}return keys};exports.watch=function(files,fn){var options={interval:100};files.forEach(function(file){debug("file %s",file);watchFile(file,options,function(curr,prev){if(prev.mtime<curr.mtime){fn(file)}})})};var isArray="function"===typeof Array.isArray?Array.isArray:function(obj){return"[object Array]"===Object.prototype.toString.call(obj)};exports.isArray=isArray;if("undefined"!==typeof Buffer&&Buffer.prototype){Buffer.prototype.toJSON=Buffer.prototype.toJSON||function(){return Array.prototype.slice.call(this,0)}}function ignored(path){return!~ignore.indexOf(path)}exports.files=function(dir,ext,ret){ret=ret||[];ext=ext||["js"];var re=new RegExp("\\.("+ext.join("|")+")$");readdirSync(dir).filter(ignored).forEach(function(path){path=join(dir,path);if(lstatSync(path).isDirectory()){exports.files(path,ext,ret)}else if(path.match(re)){ret.push(path)}});return ret};exports.slug=function(str){return str.toLowerCase().replace(/ +/g,"-").replace(/[^-\w]/g,"")};exports.clean=function(str){str=str.replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,"").replace(/^function(?:\s*|\s+[^(]*)\([^)]*\)\s*\{((?:.|\n)*?)\s*\}$|^\([^)]*\)\s*=>\s*(?:\{((?:.|\n)*?)\s*\}|((?:.|\n)*))$/,"$1$2$3");var spaces=str.match(/^\n?( *)/)[1].length,tabs=str.match(/^\n?(\t*)/)[1].length,re=new RegExp("^\n?"+(tabs?"\t":" ")+"{"+(tabs||spaces)+"}","gm");str=str.replace(re,"");return exports.trim(str)};exports.trim=function(str){return str.replace(/^\s+|\s+$/g,"")};exports.parseQuery=function(qs){return reduce(qs.replace("?","").split("&"),function(obj,pair){var i=pair.indexOf("="),key=pair.slice(0,i),val=pair.slice(++i);obj[key]=decodeURIComponent(val.replace(/\+/g,"%20"));return obj},{})};function highlight(js){return js.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\/\/(.*)/gm,"<span class=\"comment\">//$1</span>").replace(/('.*?')/gm,"<span class=\"string\">$1</span>").replace(/(\d+\.\d+)/gm,"<span class=\"number\">$1</span>").replace(/(\d+)/gm,"<span class=\"number\">$1</span>").replace(/\bnew[ \t]+(\w+)/gm,"<span class=\"keyword\">new</span> <span class=\"init\">$1</span>").replace(/\b(function|new|throw|return|var|if|else)\b/gm,"<span class=\"keyword\">$1</span>")}exports.highlightTags=function(name){for(var code=document.getElementById("mocha").getElementsByTagName(name),i=0,len=code.length;i<len;++i){code[i].innerHTML=highlight(code[i].innerHTML)}};function emptyRepresentation(value,typeHint){switch(typeHint){case"function":return"[Function]";case"object":return"{}";case"array":return"[]";default:return value.toString();}}var type=exports.type=function type(value){if(value===void 0){return"undefined"}else if(null===value){return"null"}else if("undefined"!==typeof Buffer&&Buffer.isBuffer(value)){return"buffer"}return Object.prototype.toString.call(value).replace(/^\[.+\s(.+?)]$/,"$1").toLowerCase()};exports.stringify=function(value){var typeHint=type(value);if(!~indexOf(["object","array","function"],typeHint)){if("buffer"===typeHint){var json=value.toJSON();return jsonStringify(json.data&&json.type?json.data:json,2).replace(/,(\n|$)/g,"$1")}if("string"===typeHint&&"object"===typeof value){value=reduce(value.split(""),function(acc,char,idx){acc[idx]=char;return acc},{});typeHint="object"}else{return jsonStringify(value)}}for(var prop in value){if(Object.prototype.hasOwnProperty.call(value,prop)){return jsonStringify(exports.canonicalize(value,null,typeHint),2).replace(/,(\n|$)/g,"$1")}}return emptyRepresentation(value,typeHint)};function jsonStringify(object,spaces,depth){if("undefined"===typeof spaces){return _stringify(object)}depth=depth||1;var space=spaces*depth,str=isArray(object)?"[":"{",end=isArray(object)?"]":"}",length="number"===typeof object.length?object.length:exports.keys(object).length;function repeat(s,n){return Array(n).join(s)}function _stringify(val){switch(type(val)){case"null":case"undefined":val="["+val+"]";break;case"array":case"object":val=jsonStringify(val,spaces,depth+1);break;case"boolean":case"regexp":case"symbol":case"number":val=0===val&&1/val===-Infinity?"-0":val.toString();break;case"date":var sDate;if(isNaN(val.getTime())){sDate=val.toString()}else{sDate=val.toISOString?val.toISOString():toISOString(val)}val="[Date: "+sDate+"]";break;case"buffer":var json=val.toJSON();json=json.data&&json.type?json.data:json;val="[Buffer: "+jsonStringify(json,2,depth+1)+"]";break;default:val="[Function]"===val||"[Circular]"===val?val:JSON.stringify(val);}return val}for(var i in object){if(!Object.prototype.hasOwnProperty.call(object,i)){continue}--length;str+="\n "+repeat(" ",space)+(isArray(object)?"":"\""+i+"\": ")+_stringify(object[i])+(length?",":"")}return str+(1!==str.length?"\n"+repeat(" ",--space)+end:end)}exports.isBuffer=function(value){return"undefined"!==typeof Buffer&&Buffer.isBuffer(value)};exports.canonicalize=function canonicalize(value,stack,typeHint){var canonicalizedObj,prop;typeHint=typeHint||type(value);function withStack(value,fn){stack.push(value);fn();stack.pop()}stack=stack||[];if(-1!==indexOf(stack,value)){return"[Circular]"}switch(typeHint){case"undefined":case"buffer":case"null":canonicalizedObj=value;break;case"array":withStack(value,function(){canonicalizedObj=exports.map(value,function(item){return exports.canonicalize(item,stack)})});break;case"function":for(prop in value){canonicalizedObj={};break}if(!canonicalizedObj){canonicalizedObj=emptyRepresentation(value,typeHint);break}case"object":canonicalizedObj=canonicalizedObj||{};withStack(value,function(){exports.forEach(exports.keys(value).sort(),function(key){canonicalizedObj[key]=exports.canonicalize(value[key],stack)})});break;case"date":case"number":case"regexp":case"boolean":case"symbol":canonicalizedObj=value;break;default:canonicalizedObj=value+"";}return canonicalizedObj};exports.lookupFiles=function lookupFiles(path,extensions,recursive){var files=[],re=new RegExp("\\.("+extensions.join("|")+")$");if(!exists(path)){if(exists(path+".js")){path+=".js"}else{files=glob.sync(path);if(!files.length){throw new Error("cannot resolve path (or pattern) '"+path+"'")}return files}}try{var stat=statSync(path);if(stat.isFile()){return path}}catch(err){return}readdirSync(path).forEach(function(file){file=join(path,file);try{var stat=statSync(file);if(stat.isDirectory()){if(recursive){files=files.concat(lookupFiles(file,extensions,recursive))}return}}catch(err){return}if(!stat.isFile()||!re.test(file)||"."===basename(file)[0]){return}files.push(file)});return files};exports.undefinedError=function(){return new Error("Caught undefined error, did you throw without specifying what?")};exports.getError=function(err){return err||exports.undefinedError()};exports.stackTraceFilter=function(){var is="undefined"===typeof document?{node:!0}:{browser:!0},slash=path.sep,cwd;if(is.node){cwd=process.cwd()+slash}else{cwd=("undefined"===typeof location?window.location:location).href.replace(/\/[^/]*$/,"/");slash="/"}function isMochaInternal(line){return~line.indexOf("node_modules"+slash+"mocha"+slash)||~line.indexOf("node_modules"+slash+"mocha.js")||~line.indexOf("bower_components"+slash+"mocha.js")||~line.indexOf(slash+"mocha.js")}function isNodeInternal(line){return~line.indexOf("(timers.js:")||~line.indexOf("(events.js:")||~line.indexOf("(node.js:")||~line.indexOf("(module.js:")||~line.indexOf("GeneratorFunctionPrototype.next (native)")||!1}return function(stack){stack=stack.split("\n");stack=reduce(stack,function(list,line){if(isMochaInternal(line)){return list}if(is.node&&isNodeInternal(line)){return list}if(/\(?.+:\d+:\d+\)?$/.test(line)){line=line.replace(cwd,"")}list.push(line);return list},[]);return stack.join("\n")}};exports.isPromise=function isPromise(value){return"object"===typeof value&&"function"===typeof value.then};exports.noop=function(){};