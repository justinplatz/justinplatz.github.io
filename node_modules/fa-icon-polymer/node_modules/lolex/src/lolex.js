(function(global){"use strict";var glbl=global;global.setTimeout=glbl.setTimeout;global.clearTimeout=glbl.clearTimeout;global.setInterval=glbl.setInterval;global.clearInterval=glbl.clearInterval;global.Date=glbl.Date;if("setImmediate"in global){global.setImmediate=glbl.setImmediate;global.clearImmediate=glbl.clearImmediate}var NOOP=function(){return},timeoutResult=setTimeout(NOOP,0),addTimerReturnsObject="object"===typeof timeoutResult;clearTimeout(timeoutResult);var NativeDate=Date,uniqueTimerId=1;function parseTime(str){if(!str){return 0}var strings=str.split(":"),l=strings.length,i=l,ms=0,parsed;if(3<l||!/^(\d\d:){0,2}\d\d?$/.test(str)){throw new Error("tick only understands numbers and 'h:m:s'")}while(i--){parsed=parseInt(strings[i],10);if(60<=parsed){throw new Error("Invalid time "+str)}ms+=parsed*Math.pow(60,l-i-1)}return 1e3*ms}function getEpoch(epoch){if(!epoch){return 0}if("function"===typeof epoch.getTime){return epoch.getTime()}if("number"===typeof epoch){return epoch}throw new TypeError("now should be milliseconds since UNIX epoch")}function inRange(from,to,timer){return timer&&timer.callAt>=from&&timer.callAt<=to}function mirrorDateProperties(target,source){var prop;for(prop in source){if(source.hasOwnProperty(prop)){target[prop]=source[prop]}}if(source.now){target.now=function now(){return target.clock.now}}else{delete target.now}if(source.toSource){target.toSource=function toSource(){return source.toSource()}}else{delete target.toSource}target.toString=function toString(){return source.toString()};target.prototype=source.prototype;target.parse=source.parse;target.UTC=source.UTC;target.prototype.toUTCString=source.prototype.toUTCString;return target}function createDate(){function ClockDate(year,month,date,hour,minute,second,ms){switch(arguments.length){case 0:return new NativeDate(ClockDate.clock.now);case 1:return new NativeDate(year);case 2:return new NativeDate(year,month);case 3:return new NativeDate(year,month,date);case 4:return new NativeDate(year,month,date,hour);case 5:return new NativeDate(year,month,date,hour,minute);case 6:return new NativeDate(year,month,date,hour,minute,second);default:return new NativeDate(year,month,date,hour,minute,second,ms);}}return mirrorDateProperties(ClockDate,NativeDate)}function addTimer(clock,timer){if(timer.func===void 0){throw new Error("Callback must be provided to timer calls")}if(!clock.timers){clock.timers={}}timer.id=uniqueTimerId++;timer.createdAt=clock.now;timer.callAt=clock.now+(timer.delay||(clock.duringTick?1:0));clock.timers[timer.id]=timer;if(addTimerReturnsObject){return{id:timer.id,ref:NOOP,unref:NOOP}}return timer.id}function compareTimers(a,b){if(a.callAt<b.callAt){return-1}if(a.callAt>b.callAt){return 1}if(a.immediate&&!b.immediate){return-1}if(!a.immediate&&b.immediate){return 1}if(a.createdAt<b.createdAt){return-1}if(a.createdAt>b.createdAt){return 1}if(a.id<b.id){return-1}if(a.id>b.id){return 1}}function firstTimerInRange(clock,from,to){var timers=clock.timers,timer=null,id,isInRange;for(id in timers){if(timers.hasOwnProperty(id)){isInRange=inRange(from,to,timers[id]);if(isInRange&&(!timer||1===compareTimers(timer,timers[id]))){timer=timers[id]}}}return timer}function callTimer(clock,timer){var exception;if("number"===typeof timer.interval){clock.timers[timer.id].callAt+=timer.interval}else{delete clock.timers[timer.id]}try{if("function"===typeof timer.func){timer.func.apply(null,timer.args)}else{eval(timer.func)}}catch(e){exception=e}if(!clock.timers[timer.id]){if(exception){throw exception}return}if(exception){throw exception}}function timerType(timer){if(timer.immediate){return"Immediate"}else if("undefined"!==typeof timer.interval){return"Interval"}else{return"Timeout"}}function clearTimer(clock,timerId,ttype){if(!timerId){return}if(!clock.timers){clock.timers=[]}if("object"===typeof timerId){timerId=timerId.id}if(clock.timers.hasOwnProperty(timerId)){var timer=clock.timers[timerId];if(timerType(timer)===ttype){delete clock.timers[timerId]}else{throw new Error("Cannot clear timer: timer created with set"+ttype+"() but cleared with clear"+timerType(timer)+"()")}}}function uninstall(clock,target){var method,i,l;for(i=0,l=clock.methods.length;i<l;i++){method=clock.methods[i];if(target[method].hadOwnProperty){target[method]=clock["_"+method]}else{try{delete target[method]}catch(ignore){}}}clock.methods=[]}function hijackMethod(target,method,clock){var prop;clock[method].hadOwnProperty=Object.prototype.hasOwnProperty.call(target,method);clock["_"+method]=target[method];if("Date"===method){var date=mirrorDateProperties(clock[method],target[method]);target[method]=date}else{target[method]=function(){return clock[method].apply(clock,arguments)};for(prop in clock[method]){if(clock[method].hasOwnProperty(prop)){target[method][prop]=clock[method][prop]}}}target[method].clock=clock}var timers={setTimeout:setTimeout,clearTimeout:clearTimeout,setImmediate:global.setImmediate,clearImmediate:global.clearImmediate,setInterval:setInterval,clearInterval:clearInterval,Date:Date},keys=Object.keys||function(obj){var ks=[],key;for(key in obj){if(obj.hasOwnProperty(key)){ks.push(key)}}return ks};exports.timers=timers;function createClock(now){var clock={now:getEpoch(now),timeouts:{},Date:createDate()};clock.Date.clock=clock;clock.setTimeout=function setTimeout(func,timeout){return addTimer(clock,{func:func,args:Array.prototype.slice.call(arguments,2),delay:timeout})};clock.clearTimeout=function clearTimeout(timerId){return clearTimer(clock,timerId,"Timeout")};clock.setInterval=function setInterval(func,timeout){return addTimer(clock,{func:func,args:Array.prototype.slice.call(arguments,2),delay:timeout,interval:timeout})};clock.clearInterval=function clearInterval(timerId){return clearTimer(clock,timerId,"Interval")};clock.setImmediate=function setImmediate(func){return addTimer(clock,{func:func,args:Array.prototype.slice.call(arguments,1),immediate:!0})};clock.clearImmediate=function clearImmediate(timerId){return clearTimer(clock,timerId,"Immediate")};clock.tick=function tick(ms){ms="number"===typeof ms?ms:parseTime(ms);var tickFrom=clock.now,tickTo=clock.now+ms,previous=clock.now,timer=firstTimerInRange(clock,tickFrom,tickTo),oldNow;clock.duringTick=!0;var firstException;while(timer&&tickFrom<=tickTo){if(clock.timers[timer.id]){tickFrom=clock.now=timer.callAt;try{oldNow=clock.now;callTimer(clock,timer);if(oldNow!==clock.now){tickFrom+=clock.now-oldNow;tickTo+=clock.now-oldNow;previous+=clock.now-oldNow}}catch(e){firstException=firstException||e}}timer=firstTimerInRange(clock,previous,tickTo);previous=tickFrom}clock.duringTick=!1;clock.now=tickTo;if(firstException){throw firstException}return clock.now};clock.reset=function reset(){clock.timers={}};clock.setSystemTime=function setSystemTime(now){var newNow=getEpoch(now),difference=newNow-clock.now;clock.now=newNow;for(var id in clock.timers){if(clock.timers.hasOwnProperty(id)){var timer=clock.timers[id];timer.createdAt+=difference;timer.callAt+=difference}}};return clock}exports.createClock=createClock;exports.install=function install(target,now,toFake){var i,l;if("number"===typeof target){toFake=now;now=target;target=null}if(!target){target=global}var clock=createClock(now);clock.uninstall=function(){uninstall(clock,target)};clock.methods=toFake||[];if(0===clock.methods.length){clock.methods=keys(timers)}for(i=0,l=clock.methods.length;i<l;i++){hijackMethod(target,clock.methods[i],clock)}return clock}})(global||this);