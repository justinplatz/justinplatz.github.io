<!DOCTYPE html><html><head><title>iron-request</title><script src="../../webcomponentsjs/webcomponents-lite.js"></script><script src="../../web-component-tester/browser.js"></script><link rel="import" href="../../polymer/polymer.html"><link rel="import" href="../../promise-polyfill/promise-polyfill.html"><link rel="import" href="../iron-request.html"></head><body><test-fixture id="TrivialRequest"><template><iron-request></iron-request></template></test-fixture><script>'use strict';suite("<iron-request>",function(){var jsonResponseHeaders,successfulRequestOptions,synchronousSuccessfulRequestOptions,asynchronousSuccessfulRequestOptions,asynchronousUndefSuccessfulRequestOptions,request,server;setup(function(){jsonResponseHeaders={"Content-Type":"application/json"};server=sinon.fakeServer.create();server.respondWith("GET","/responds_to_get_with_json",[200,jsonResponseHeaders,"{\"success\":true}"]);server.respondWith("GET","/responds_to_get_with_prefixed_json",[200,jsonResponseHeaders,"])}while(1);</x>{\"success\":true}"]);server.respondWith("GET","/responds_to_get_with_500",[500,{},""]);server.respondWith("GET","/responds_to_get_with_100",[100,{},""]);server.respondWith("GET","/responds_to_get_with_0",[0,jsonResponseHeaders,"{\"success\":true}"]);request=fixture("TrivialRequest");successfulRequestOptions={url:"/responds_to_get_with_json"};synchronousSuccessfulRequestOptions={url:"/responds_to_get_with_json",async:!1,timeout:100};asynchronousSuccessfulRequestOptions={url:"/responds_to_get_with_json",async:!0,timeout:100};asynchronousUndefSuccessfulRequestOptions={url:"/responds_to_get_with_json",async:void 0,timeout:100}});teardown(function(){server.restore()});suite("basic usage",function(){test("creates network requests, requiring only `url`",function(){request.send(successfulRequestOptions);server.respond();expect(request.response).to.be.ok});test("timeout not set if synchronous",function(){request.send(synchronousSuccessfulRequestOptions);expect(request.xhr.async).to.be.eql(!1);expect(request.xhr.timeout).to.be.eql(void 0)});test("timeout set if asynchronous is undefined",function(){request.send(asynchronousUndefSuccessfulRequestOptions);expect(request.xhr.async).to.be.eql(!0);expect(request.xhr.timeout).to.be.eql(100)});test("sets async to true by default",function(){request.send(successfulRequestOptions);expect(request.xhr.async).to.be.eql(!0)});test("can be aborted",function(){request.send(successfulRequestOptions);request.abort();server.respond();return request.completes.then(function(){throw new Error("Request did not abort appropriately!")}).catch(function(e){expect(request.response).to.not.be.ok})});test("can be aborted with request element",function(){var options={url:successfulRequestOptions.url,rejectWithRequest:!0};request.send(options);request.abort();server.respond();return request.completes.then(function(){throw new Error("Request did not abort appropriately!")}).catch(function(e){expect(e.error).to.be.instanceof(Error);expect(e.request).to.deep.equal(request)})});test("default responseType is text",function(){request.send(successfulRequestOptions);server.respond();return request.completes.then(function(){expect(request.response).to.be.an("string")})});test("default responseType of text is not applied, when async is false",function(){var options=Object.create(successfulRequestOptions);options.async=!1;request.send(options);server.respond();return request.completes.then(function(){expect(request.xhr.responseType).to.be.empty})});test("responseType can be configured via handleAs option",function(){var options=Object.create(successfulRequestOptions);options.handleAs="json";request.send(options);expect(server.requests.length).to.be.equal(1);expect(server.requests[0].requestHeaders.accept).to.be.equal("application/json");server.respond();return request.completes.then(function(){expect(request.response).to.be.an("object")})});test("setting jsonPrefix correctly strips it from the response",function(){var options={url:"/responds_to_get_with_prefixed_json",handleAs:"json",jsonPrefix:"])}while(1);</x>"};request.send(options);expect(server.requests.length).to.be.equal(1);expect(server.requests[0].requestHeaders.accept).to.be.equal("application/json");server.respond();return request.completes.then(function(){expect(request.response).to.deep.eq({success:!0})})});test("responseType cannot be configured via handleAs option, when async is false",function(){var options=Object.create(successfulRequestOptions);options.handleAs="json";options.async=!1;request.send(options);expect(server.requests.length).to.be.equal(1);expect(server.requests[0].requestHeaders.accept).to.be.equal("application/json");server.respond();return request.completes.then(function(){expect(request.response).to.be.a("string")})});test("headers are sent up",function(){var options=Object.create(successfulRequestOptions);options.headers={foo:"bar",accept:"this should override the default"};request.send(options);expect(server.requests.length).to.be.equal(1);var fakeXhr=server.requests[0];expect(fakeXhr.requestHeaders.foo).to.be.equal("bar");expect(fakeXhr.requestHeaders.accept).to.be.equal("this should override the default")});test("headers are deduped by lowercasing",function(){var options=Object.create(successfulRequestOptions);options.headers={foo:"bar",Foo:"bar",fOo:"bar",Accept:"this should also override the default"};request.send(options);expect(server.requests.length).to.be.equal(1);var fakeXhr=server.requests[0];expect(Object.keys(fakeXhr.requestHeaders).length).to.be.equal(2);expect(fakeXhr.requestHeaders.foo).to.be.equal("bar");expect(fakeXhr.requestHeaders.accept).to.be.equal("this should also override the default")})});suite("special cases",function(){test("treats status code 0 as success, though the outcome is ambiguous",function(){request.send({url:"/responds_to_get_with_0"});server.respond();expect(request.succeeded).to.be.equal(!0)});test("special form characters",function(){for(var testCases=[{test:null,answer:""},{test:void 0,answer:""},{test:NaN,answer:"NaN"},{test:new String("\n\r\n\r"),answer:"%0D%0A%0D%0A%0D"},{test:0,answer:"0"},{test:new String("hello world"),answer:"hello+world"}],testCase,i=0;i<testCases.length;i++){testCase=testCases[i];var encoded=request._wwwFormUrlEncodePiece(testCase.test);expect(encoded).to.be.equal(testCase.answer)}})});suite("errors",function(){test("treats status codes between 1 and 199 as errors",function(){request.send({url:"/responds_to_get_with_100"});server.respond();expect(request.succeeded).to.be.equal(!1)});test("treats status codes between 300 and \u221E as errors",function(){request.send({url:"/responds_to_get_with_500"});server.respond();expect(request.succeeded).to.be.equal(!1)})});suite("status codes",function(){test("status and statusText is set after a ambiguous request",function(){request.send({url:"/responds_to_get_with_0"});server.respond();expect(request.status).to.be.equal(0);expect(request.statusText).to.be.equal("")});test("status and statusText is set after a request that succeeded",function(){request.send({url:"/responds_to_get_with_json"});server.respond();expect(request.status).to.be.equal(200);expect(request.statusText).to.be.equal("OK")});test("status and statusText is set after a request that failed",function(){request.send({url:"/responds_to_get_with_500"});server.respond();expect(request.status).to.be.equal(500);expect(request.statusText).to.be.equal("Internal Server Error")})})});</script></body></html>