module.exports=globSync;globSync.GlobSync=GlobSync;var fs=require("fs"),rp=require("fs.realpath"),minimatch=require("minimatch"),Minimatch=minimatch.Minimatch,Glob=require("./glob.js").Glob,util=require("util"),path=require("path"),assert=require("assert"),isAbsolute=require("path-is-absolute"),common=require("./common.js"),alphasort=common.alphasort,alphasorti=common.alphasorti,setopts=common.setopts,ownProp=common.ownProp,childrenIgnored=common.childrenIgnored,isIgnored=common.isIgnored;function globSync(pattern,options){if("function"===typeof options||3===arguments.length)throw new TypeError("callback provided to sync glob\n"+"See: https://github.com/isaacs/node-glob/issues/167");return new GlobSync(pattern,options).found}function GlobSync(pattern,options){if(!pattern)throw new Error("must provide pattern");if("function"===typeof options||3===arguments.length)throw new TypeError("callback provided to sync glob\n"+"See: https://github.com/isaacs/node-glob/issues/167");if(!(this instanceof GlobSync))return new GlobSync(pattern,options);setopts(this,pattern,options);if(this.noprocess)return this;var n=this.minimatch.set.length;this.matches=Array(n);for(var i=0;i<n;i++){this._process(this.minimatch.set[i],i,!1)}this._finish()}GlobSync.prototype._finish=function(){assert(this instanceof GlobSync);if(this.realpath){var self=this;this.matches.forEach(function(matchset,index){var set=self.matches[index]=Object.create(null);for(var p in matchset){try{p=self._makeAbs(p);var real=rp.realpathSync(p,self.realpathCache);set[real]=!0}catch(er){if("stat"===er.syscall)set[self._makeAbs(p)]=!0;else throw er}}})}common.finish(this)};GlobSync.prototype._process=function(pattern,index,inGlobStar){assert(this instanceof GlobSync);var n=0;while("string"===typeof pattern[n]){n++}var prefix;switch(n){case pattern.length:this._processSimple(pattern.join("/"),index);return;case 0:prefix=null;break;default:prefix=pattern.slice(0,n).join("/");break;}var remain=pattern.slice(n),read;if(null===prefix)read=".";else if(isAbsolute(prefix)||isAbsolute(pattern.join("/"))){if(!prefix||!isAbsolute(prefix))prefix="/"+prefix;read=prefix}else read=prefix;var abs=this._makeAbs(read);if(childrenIgnored(this,read))return;var isGlobStar=remain[0]===minimatch.GLOBSTAR;if(isGlobStar)this._processGlobStar(prefix,read,abs,remain,index,inGlobStar);else this._processReaddir(prefix,read,abs,remain,index,inGlobStar)};GlobSync.prototype._processReaddir=function(prefix,read,abs,remain,index,inGlobStar){var entries=this._readdir(abs,inGlobStar);if(!entries)return;for(var pn=remain[0],negate=!!this.minimatch.negate,rawGlob=pn._glob,dotOk=this.dot||"."===rawGlob.charAt(0),matchedEntries=[],i=0,e;i<entries.length;i++){e=entries[i];if("."!==e.charAt(0)||dotOk){var m;if(negate&&!prefix){m=!e.match(pn)}else{m=e.match(pn)}if(m)matchedEntries.push(e)}}var len=matchedEntries.length;if(0===len)return;if(1===remain.length&&!this.mark&&!this.stat){if(!this.matches[index])this.matches[index]=Object.create(null);for(var i=0,e;i<len;i++){e=matchedEntries[i];if(prefix){if("/"!==prefix.slice(-1))e=prefix+"/"+e;else e=prefix+e}if("/"===e.charAt(0)&&!this.nomount){e=path.join(this.root,e)}this._emitMatch(index,e)}return}remain.shift();for(var i=0;i<len;i++){var e=matchedEntries[i],newPattern;if(prefix)newPattern=[prefix,e];else newPattern=[e];this._process(newPattern.concat(remain),index,inGlobStar)}};GlobSync.prototype._emitMatch=function(index,e){if(isIgnored(this,e))return;var abs=this._makeAbs(e);if(this.mark)e=this._mark(e);if(this.absolute){e=abs}if(this.matches[index][e])return;if(this.nodir){var c=this.cache[abs];if("DIR"===c||Array.isArray(c))return}this.matches[index][e]=!0;if(this.stat)this._stat(e)};GlobSync.prototype._readdirInGlobStar=function(abs){if(this.follow)return this._readdir(abs,!1);var entries,lstat,stat;try{lstat=fs.lstatSync(abs)}catch(er){if("ENOENT"===er.code){return null}}var isSym=lstat&&lstat.isSymbolicLink();this.symlinks[abs]=isSym;if(!isSym&&lstat&&!lstat.isDirectory())this.cache[abs]="FILE";else entries=this._readdir(abs,!1);return entries};GlobSync.prototype._readdir=function(abs,inGlobStar){var entries;if(inGlobStar&&!ownProp(this.symlinks,abs))return this._readdirInGlobStar(abs);if(ownProp(this.cache,abs)){var c=this.cache[abs];if(!c||"FILE"===c)return null;if(Array.isArray(c))return c}try{return this._readdirEntries(abs,fs.readdirSync(abs))}catch(er){this._readdirError(abs,er);return null}};GlobSync.prototype._readdirEntries=function(abs,entries){if(!this.mark&&!this.stat){for(var i=0,e;i<entries.length;i++){e=entries[i];if("/"===abs)e=abs+e;else e=abs+"/"+e;this.cache[e]=!0}}this.cache[abs]=entries;return entries};GlobSync.prototype._readdirError=function(f,er){switch(er.code){case"ENOTSUP":case"ENOTDIR":var abs=this._makeAbs(f);this.cache[abs]="FILE";if(abs===this.cwdAbs){var error=new Error(er.code+" invalid cwd "+this.cwd);error.path=this.cwd;error.code=er.code;throw error}break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(f)]=!1;break;default:this.cache[this._makeAbs(f)]=!1;if(this.strict)throw er;if(!this.silent)console.error("glob error",er);break;}};GlobSync.prototype._processGlobStar=function(prefix,read,abs,remain,index,inGlobStar){var entries=this._readdir(abs,inGlobStar);if(!entries)return;var remainWithoutGlobStar=remain.slice(1),gspref=prefix?[prefix]:[],noGlobStar=gspref.concat(remainWithoutGlobStar);this._process(noGlobStar,index,!1);var len=entries.length,isSym=this.symlinks[abs];if(isSym&&inGlobStar)return;for(var i=0,e;i<len;i++){e=entries[i];if("."===e.charAt(0)&&!this.dot)continue;var instead=gspref.concat(entries[i],remainWithoutGlobStar);this._process(instead,index,!0);var below=gspref.concat(entries[i],remain);this._process(below,index,!0)}};GlobSync.prototype._processSimple=function(prefix,index){var exists=this._stat(prefix);if(!this.matches[index])this.matches[index]=Object.create(null);if(!exists)return;if(prefix&&isAbsolute(prefix)&&!this.nomount){var trail=/[\/\\]$/.test(prefix);if("/"===prefix.charAt(0)){prefix=path.join(this.root,prefix)}else{prefix=path.resolve(this.root,prefix);if(trail)prefix+="/"}}if("win32"===process.platform)prefix=prefix.replace(/\\/g,"/");this._emitMatch(index,prefix)};GlobSync.prototype._stat=function(f){var abs=this._makeAbs(f),needDir="/"===f.slice(-1);if(f.length>this.maxLength)return!1;if(!this.stat&&ownProp(this.cache,abs)){var c=this.cache[abs];if(Array.isArray(c))c="DIR";if(!needDir||"DIR"===c)return c;if(needDir&&"FILE"===c)return!1}var exists,stat=this.statCache[abs];if(!stat){var lstat;try{lstat=fs.lstatSync(abs)}catch(er){if(er&&("ENOENT"===er.code||"ENOTDIR"===er.code)){this.statCache[abs]=!1;return!1}}if(lstat&&lstat.isSymbolicLink()){try{stat=fs.statSync(abs)}catch(er){stat=lstat}}else{stat=lstat}}this.statCache[abs]=stat;var c=!0;if(stat)c=stat.isDirectory()?"DIR":"FILE";this.cache[abs]=this.cache[abs]||c;if(needDir&&"FILE"===c)return!1;return c};GlobSync.prototype._mark=function(p){return common.mark(this,p)};GlobSync.prototype._makeAbs=function(f){return common.makeAbs(this,f)};