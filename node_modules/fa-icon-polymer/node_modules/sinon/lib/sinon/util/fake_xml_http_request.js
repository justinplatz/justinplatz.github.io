(function(sinonGlobal,global){"use strict";function getWorkingXHR(globalScope){var supportsXHR="undefined"!==typeof globalScope.XMLHttpRequest;if(supportsXHR){return globalScope.XMLHttpRequest}var supportsActiveX="undefined"!==typeof globalScope.ActiveXObject;if(supportsActiveX){return function(){return new globalScope.ActiveXObject("MSXML2.XMLHTTP.3.0")}}return!1}var supportsProgress="undefined"!==typeof ProgressEvent,supportsCustomEvent="undefined"!==typeof CustomEvent,supportsFormData="undefined"!==typeof FormData,supportsArrayBuffer="undefined"!==typeof ArrayBuffer,supportsBlob=function(){try{return!!new Blob}catch(e){return!1}}(),sinonXhr={XMLHttpRequest:global.XMLHttpRequest};sinonXhr.GlobalXMLHttpRequest=global.XMLHttpRequest;sinonXhr.GlobalActiveXObject=global.ActiveXObject;sinonXhr.supportsActiveX="undefined"!==typeof sinonXhr.GlobalActiveXObject;sinonXhr.supportsXHR="undefined"!==typeof sinonXhr.GlobalXMLHttpRequest;sinonXhr.workingXHR=getWorkingXHR(global);sinonXhr.supportsCORS=sinonXhr.supportsXHR&&"withCredentials"in new sinonXhr.GlobalXMLHttpRequest;var unsafeHeaders={"Accept-Charset":!0,"Accept-Encoding":!0,Connection:!0,"Content-Length":!0,Cookie:!0,Cookie2:!0,"Content-Transfer-Encoding":!0,Date:!0,Expect:!0,Host:!0,"Keep-Alive":!0,Referer:!0,TE:!0,Trailer:!0,"Transfer-Encoding":!0,Upgrade:!0,"User-Agent":!0,Via:!0};function UploadProgress(){this.eventListeners={abort:[],error:[],load:[],loadend:[],progress:[]}}UploadProgress.prototype.addEventListener=function addEventListener(event,listener){this.eventListeners[event].push(listener)};UploadProgress.prototype.removeEventListener=function removeEventListener(event,listener){for(var listeners=this.eventListeners[event]||[],i=0,l=listeners.length;i<l;++i){if(listeners[i]===listener){return listeners.splice(i,1)}}};UploadProgress.prototype.dispatchEvent=function dispatchEvent(event){for(var listeners=this.eventListeners[event.type]||[],i=0,listener;null!=(listener=listeners[i]);i++){listener(event)}};function FakeXMLHttpRequest(){this.readyState=FakeXMLHttpRequest.UNSENT;this.requestHeaders={};this.requestBody=null;this.status=0;this.statusText="";this.upload=new UploadProgress;this.responseType="";this.response="";if(sinonXhr.supportsCORS){this.withCredentials=!1}var xhr=this,events=["loadstart","load","abort","error","loadend"];function addEventListener(eventName){xhr.addEventListener(eventName,function(event){var listener=xhr["on"+eventName];if(listener&&"function"===typeof listener){listener.call(this,event)}})}for(var i=events.length-1;0<=i;i--){addEventListener(events[i])}if("function"===typeof FakeXMLHttpRequest.onCreate){FakeXMLHttpRequest.onCreate(this)}}function verifyState(xhr){if(xhr.readyState!==FakeXMLHttpRequest.OPENED){throw new Error("INVALID_STATE_ERR")}if(xhr.sendFlag){throw new Error("INVALID_STATE_ERR")}}function getHeader(headers,header){header=header.toLowerCase();for(var h in headers){if(h.toLowerCase()===header){return h}}return null}function each(collection,callback){if(!collection){return}for(var i=0,l=collection.length;i<l;i+=1){callback(collection[i])}}function some(collection,callback){for(var index=0;index<collection.length;index++){if(!0===callback(collection[index])){return!0}}return!1}var apply=function(obj,method,args){switch(args.length){case 0:return obj[method]();case 1:return obj[method](args[0]);case 2:return obj[method](args[0],args[1]);case 3:return obj[method](args[0],args[1],args[2]);case 4:return obj[method](args[0],args[1],args[2],args[3]);case 5:return obj[method](args[0],args[1],args[2],args[3],args[4]);}};FakeXMLHttpRequest.filters=[];FakeXMLHttpRequest.addFilter=function addFilter(fn){this.filters.push(fn)};var IE6Re=/MSIE 6/;FakeXMLHttpRequest.defake=function defake(fakeXhr,xhrArgs){var xhr=new sinonXhr.workingXHR;each(["open","setRequestHeader","send","abort","getResponseHeader","getAllResponseHeaders","addEventListener","overrideMimeType","removeEventListener"],function(method){fakeXhr[method]=function(){return apply(xhr,method,arguments)}});var copyAttrs=function(args){each(args,function(attr){try{fakeXhr[attr]=xhr[attr]}catch(e){if(!IE6Re.test(navigator.userAgent)){throw e}}})},stateChange=function stateChange(){fakeXhr.readyState=xhr.readyState;if(xhr.readyState>=FakeXMLHttpRequest.HEADERS_RECEIVED){copyAttrs(["status","statusText"])}if(xhr.readyState>=FakeXMLHttpRequest.LOADING){copyAttrs(["responseText","response"])}if(xhr.readyState===FakeXMLHttpRequest.DONE){copyAttrs(["responseXML"])}if(fakeXhr.onreadystatechange){fakeXhr.onreadystatechange.call(fakeXhr,{target:fakeXhr})}};if(xhr.addEventListener){for(var event in fakeXhr.eventListeners){if(fakeXhr.eventListeners.hasOwnProperty(event)){each(fakeXhr.eventListeners[event],function(handler){xhr.addEventListener(event,handler)})}}xhr.addEventListener("readystatechange",stateChange)}else{xhr.onreadystatechange=stateChange}apply(xhr,"open",xhrArgs)};FakeXMLHttpRequest.useFilters=!1;function verifyRequestOpened(xhr){if(xhr.readyState!==FakeXMLHttpRequest.OPENED){throw new Error("INVALID_STATE_ERR - "+xhr.readyState)}}function verifyRequestSent(xhr){if(xhr.readyState===FakeXMLHttpRequest.DONE){throw new Error("Request done")}}function verifyHeadersReceived(xhr){if(xhr.async&&xhr.readyState!==FakeXMLHttpRequest.HEADERS_RECEIVED){throw new Error("No headers received")}}function verifyResponseBodyType(body){if("string"!==typeof body){var error=new Error("Attempted to respond to fake XMLHttpRequest with "+body+", which is not a string.");error.name="InvalidBodyException";throw error}}function convertToArrayBuffer(body){for(var buffer=new ArrayBuffer(body.length),view=new Uint8Array(buffer),i=0,charCode;i<body.length;i++){charCode=body.charCodeAt(i);if(256<=charCode){throw new TypeError("arraybuffer or blob responseTypes require binary string, "+"invalid character "+body[i]+" found.")}view[i]=charCode}return buffer}function isXmlContentType(contentType){return!contentType||/(text\/xml)|(application\/xml)|(\+xml)/.test(contentType)}function convertResponseBody(responseType,contentType,body){if(""===responseType||"text"===responseType){return body}else if(supportsArrayBuffer&&"arraybuffer"===responseType){return convertToArrayBuffer(body)}else if("json"===responseType){try{return JSON.parse(body)}catch(e){return null}}else if(supportsBlob&&"blob"===responseType){var blobOptions={};if(contentType){blobOptions.type=contentType}return new Blob([convertToArrayBuffer(body)],blobOptions)}else if("document"===responseType){if(isXmlContentType(contentType)){return FakeXMLHttpRequest.parseXML(body)}return null}throw new Error("Invalid responseType "+responseType)}function clearResponse(xhr){if(""===xhr.responseType||"text"===xhr.responseType){xhr.response=xhr.responseText=""}else{xhr.response=xhr.responseText=null}xhr.responseXML=null}FakeXMLHttpRequest.parseXML=function parseXML(text){if(""!==text){try{if("undefined"!==typeof DOMParser){var parser=new DOMParser;return parser.parseFromString(text,"text/xml")}var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(text);return xmlDoc}catch(e){}}return null};FakeXMLHttpRequest.statusCodes={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};function makeApi(sinon){sinon.xhr=sinonXhr;sinon.extend(FakeXMLHttpRequest.prototype,sinon.EventTarget,{async:!0,open:function open(method,url,async,username,password){this.method=method;this.url=url;this.async="boolean"===typeof async?async:!0;this.username=username;this.password=password;clearResponse(this);this.requestHeaders={};this.sendFlag=!1;if(!0===FakeXMLHttpRequest.useFilters){var xhrArgs=arguments,defake=some(FakeXMLHttpRequest.filters,function(filter){return filter.apply(this,xhrArgs)});if(defake){return FakeXMLHttpRequest.defake(this,arguments)}}this.readyStateChange(FakeXMLHttpRequest.OPENED)},readyStateChange:function readyStateChange(state){this.readyState=state;var readyStateChangeEvent=new sinon.Event("readystatechange",!1,!1,this),event,progress;if("function"===typeof this.onreadystatechange){try{this.onreadystatechange(readyStateChangeEvent)}catch(e){sinon.logError("Fake XHR onreadystatechange handler",e)}}if(this.readyState===FakeXMLHttpRequest.DONE){progress={loaded:this.progress||0,total:this.progress||0};if(0===this.status){event=this.aborted?"abort":"error"}else{event="load"}if(supportsProgress){this.upload.dispatchEvent(new sinon.ProgressEvent("progress",progress,this));this.upload.dispatchEvent(new sinon.ProgressEvent(event,progress,this));this.upload.dispatchEvent(new sinon.ProgressEvent("loadend",progress,this))}this.dispatchEvent(new sinon.ProgressEvent("progress",progress,this));this.dispatchEvent(new sinon.ProgressEvent(event,progress,this));this.dispatchEvent(new sinon.ProgressEvent("loadend",progress,this))}this.dispatchEvent(readyStateChangeEvent)},setRequestHeader:function setRequestHeader(header,value){verifyState(this);if(unsafeHeaders[header]||/^(Sec-|Proxy-)/.test(header)){throw new Error("Refused to set unsafe header \""+header+"\"")}if(this.requestHeaders[header]){this.requestHeaders[header]+=","+value}else{this.requestHeaders[header]=value}},setResponseHeaders:function setResponseHeaders(headers){verifyRequestOpened(this);this.responseHeaders={};for(var header in headers){if(headers.hasOwnProperty(header)){this.responseHeaders[header]=headers[header]}}if(this.async){this.readyStateChange(FakeXMLHttpRequest.HEADERS_RECEIVED)}else{this.readyState=FakeXMLHttpRequest.HEADERS_RECEIVED}},send:function send(data){verifyState(this);if(!/^(get|head)$/i.test(this.method)){var contentType=getHeader(this.requestHeaders,"Content-Type");if(this.requestHeaders[contentType]){var value=this.requestHeaders[contentType].split(";");this.requestHeaders[contentType]=value[0]+";charset=utf-8"}else if(supportsFormData&&!(data instanceof FormData)){this.requestHeaders["Content-Type"]="text/plain;charset=utf-8"}this.requestBody=data}this.errorFlag=!1;this.sendFlag=this.async;clearResponse(this);this.readyStateChange(FakeXMLHttpRequest.OPENED);if("function"===typeof this.onSend){this.onSend(this)}this.dispatchEvent(new sinon.Event("loadstart",!1,!1,this))},abort:function abort(){this.aborted=!0;clearResponse(this);this.errorFlag=!0;this.requestHeaders={};this.responseHeaders={};if(this.readyState>FakeXMLHttpRequest.UNSENT&&this.sendFlag){this.readyStateChange(FakeXMLHttpRequest.DONE);this.sendFlag=!1}this.readyState=FakeXMLHttpRequest.UNSENT},error:function error(){clearResponse(this);this.errorFlag=!0;this.requestHeaders={};this.responseHeaders={};this.readyStateChange(FakeXMLHttpRequest.DONE)},getResponseHeader:function getResponseHeader(header){if(this.readyState<FakeXMLHttpRequest.HEADERS_RECEIVED){return null}if(/^Set-Cookie2?$/i.test(header)){return null}header=getHeader(this.responseHeaders,header);return this.responseHeaders[header]||null},getAllResponseHeaders:function getAllResponseHeaders(){if(this.readyState<FakeXMLHttpRequest.HEADERS_RECEIVED){return""}var headers="";for(var header in this.responseHeaders){if(this.responseHeaders.hasOwnProperty(header)&&!/^Set-Cookie2?$/i.test(header)){headers+=header+": "+this.responseHeaders[header]+"\r\n"}}return headers},setResponseBody:function setResponseBody(body){verifyRequestSent(this);verifyHeadersReceived(this);verifyResponseBodyType(body);var contentType=this.getResponseHeader("Content-Type"),isTextResponse=""===this.responseType||"text"===this.responseType;clearResponse(this);if(this.async){var chunkSize=this.chunkSize||10,index=0;do{this.readyStateChange(FakeXMLHttpRequest.LOADING);if(isTextResponse){this.responseText=this.response+=body.substring(index,index+chunkSize)}index+=chunkSize}while(index<body.length)}this.response=convertResponseBody(this.responseType,contentType,body);if(isTextResponse){this.responseText=this.response}if("document"===this.responseType){this.responseXML=this.response}else if(""===this.responseType&&isXmlContentType(contentType)){this.responseXML=FakeXMLHttpRequest.parseXML(this.responseText)}this.progress=body.length;this.readyStateChange(FakeXMLHttpRequest.DONE)},respond:function respond(status,headers,body){this.status="number"===typeof status?status:200;this.statusText=FakeXMLHttpRequest.statusCodes[this.status];this.setResponseHeaders(headers||{});this.setResponseBody(body||"")},uploadProgress:function uploadProgress(progressEventRaw){if(supportsProgress){this.upload.dispatchEvent(new sinon.ProgressEvent("progress",progressEventRaw))}},downloadProgress:function downloadProgress(progressEventRaw){if(supportsProgress){this.dispatchEvent(new sinon.ProgressEvent("progress",progressEventRaw))}},uploadError:function uploadError(error){if(supportsCustomEvent){this.upload.dispatchEvent(new sinon.CustomEvent("error",{detail:error}))}}});sinon.extend(FakeXMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4});sinon.useFakeXMLHttpRequest=function(){FakeXMLHttpRequest.restore=function restore(keepOnCreate){if(sinonXhr.supportsXHR){global.XMLHttpRequest=sinonXhr.GlobalXMLHttpRequest}if(sinonXhr.supportsActiveX){global.ActiveXObject=sinonXhr.GlobalActiveXObject}delete FakeXMLHttpRequest.restore;if(!0!==keepOnCreate){delete FakeXMLHttpRequest.onCreate}};if(sinonXhr.supportsXHR){global.XMLHttpRequest=FakeXMLHttpRequest}if(sinonXhr.supportsActiveX){global.ActiveXObject=function ActiveXObject(objId){if("Microsoft.XMLHTTP"===objId||/^Msxml2\.XMLHTTP/i.test(objId)){return new FakeXMLHttpRequest}return new sinonXhr.GlobalActiveXObject(objId)}}return FakeXMLHttpRequest};sinon.FakeXMLHttpRequest=FakeXMLHttpRequest}var isNode="undefined"!==typeof module&&module.exports&&"function"===typeof require,isAMD="function"===typeof define&&"object"===typeof define.amd&&define.amd;function loadDependencies(require,exports,module){var sinon=require("./core");require("../extend");require("./event");require("../log_error");makeApi(sinon);module.exports=sinon}if(isAMD){define(loadDependencies);return}if(isNode){loadDependencies(require,module.exports,module);return}if(sinonGlobal){makeApi(sinonGlobal)}})("object"===typeof sinon&&sinon,"undefined"!==typeof global?global:self);