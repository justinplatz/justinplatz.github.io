'use strict';exports.__esModule=!0;exports.applyPatch=applyPatch;exports.applyPatches=applyPatches;var _parse=require("./parse"),_distanceIterator=require("../util/distance-iterator"),_distanceIterator2=_interopRequireDefault(_distanceIterator);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function applyPatch(source,uniDiff){var options=2>=arguments.length||arguments[2]===void 0?{}:arguments[2];if("string"===typeof uniDiff){uniDiff=(0,_parse.parsePatch)(uniDiff)}if(Array.isArray(uniDiff)){if(1<uniDiff.length){throw new Error("applyPatch only works with a single input.")}uniDiff=uniDiff[0]}var lines=source.split(/\r\n|[\n\v\f\r\x85]/),delimiters=source.match(/\r\n|[\n\v\f\r\x85]/g)||[],hunks=uniDiff.hunks,compareLine=options.compareLine||function(lineNumber,line,operation,patchContent){return line===patchContent},errorCount=0,fuzzFactor=options.fuzzFactor||0,minLine=0,offset=0,removeEOFNL,addEOFNL;function hunkFits(hunk,toPos){for(var j=0;j<hunk.lines.length;j++){var line=hunk.lines[j],operation=line[0],content=line.substr(1);if(" "===operation||"-"===operation){if(!compareLine(toPos+1,lines[toPos],operation,content)){errorCount++;if(errorCount>fuzzFactor){return!1}}toPos++}}return!0}for(var i=0;i<hunks.length;i++){var hunk=hunks[i],maxLine=lines.length-hunk.oldLines,localOffset=0,toPos=offset+hunk.oldStart-1,iterator=(0,_distanceIterator2["default"])(toPos,minLine,maxLine);for(;localOffset!==void 0;localOffset=iterator()){if(hunkFits(hunk,toPos+localOffset)){hunk.offset=offset+=localOffset;break}}if(localOffset===void 0){return!1}minLine=hunk.offset+hunk.oldStart+hunk.oldLines}for(var _i=0;_i<hunks.length;_i++){var _hunk=hunks[_i],_toPos=_hunk.offset+_hunk.newStart-1;if(0==_hunk.newLines){_toPos++}for(var j=0;j<_hunk.lines.length;j++){var line=_hunk.lines[j],operation=line[0],content=line.substr(1),delimiter=_hunk.linedelimiters[j];if(" "===operation){_toPos++}else if("-"===operation){lines.splice(_toPos,1);delimiters.splice(_toPos,1)}else if("+"===operation){lines.splice(_toPos,0,content);delimiters.splice(_toPos,0,delimiter);_toPos++}else if("\\"===operation){var previousOperation=_hunk.lines[j-1]?_hunk.lines[j-1][0]:null;if("+"===previousOperation){removeEOFNL=!0}else if("-"===previousOperation){addEOFNL=!0}}}}if(removeEOFNL){while(!lines[lines.length-1]){lines.pop();delimiters.pop()}}else if(addEOFNL){lines.push("");delimiters.push("\n")}for(var _k=0;_k<lines.length-1;_k++){lines[_k]=lines[_k]+delimiters[_k]}return lines.join("")}function applyPatches(uniDiff,options){if("string"===typeof uniDiff){uniDiff=(0,_parse.parsePatch)(uniDiff)}var currentIndex=0;function processIndex(){var index=uniDiff[currentIndex++];if(!index){return options.complete()}options.loadFile(index,function(err,data){if(err){return options.complete(err)}var updatedContent=applyPatch(data,index,options);options.patched(index,updatedContent,function(err){if(err){return options.complete(err)}processIndex()})})}processIndex()}