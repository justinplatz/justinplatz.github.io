goog.provide("axs.color");goog.provide("axs.color.Color");axs.color.Color=function(red,green,blue,alpha){this.red=red;this.green=green;this.blue=blue;this.alpha=alpha};axs.color.YCbCr=function(coords){this.luma=this.z=coords[0];this.Cb=this.x=coords[1];this.Cr=this.y=coords[2]};axs.color.YCbCr.prototype={multiply:function(scalar){var result=[this.luma*scalar,this.Cb*scalar,this.Cr*scalar];return new axs.color.YCbCr(result)},add:function(other){var result=[this.luma+other.luma,this.Cb+other.Cb,this.Cr+other.Cr];return new axs.color.YCbCr(result)},subtract:function(other){var result=[this.luma-other.luma,this.Cb-other.Cb,this.Cr-other.Cr];return new axs.color.YCbCr(result)}};axs.color.calculateContrastRatio=function(fgColor,bgColor){if(1>fgColor.alpha)fgColor=axs.color.flattenColors(fgColor,bgColor);var fgLuminance=axs.color.calculateLuminance(fgColor),bgLuminance=axs.color.calculateLuminance(bgColor),contrastRatio=(Math.max(fgLuminance,bgLuminance)+.05)/(Math.min(fgLuminance,bgLuminance)+.05);return contrastRatio};axs.color.calculateLuminance=function(color){var ycc=axs.color.toYCbCr(color);return ycc.luma};axs.color.luminanceRatio=function(luminance1,luminance2){return(Math.max(luminance1,luminance2)+.05)/(Math.min(luminance1,luminance2)+.05)};axs.color.parseColor=function(colorString){if("transparent"===colorString){return new axs.color.Color(0,0,0,0)}var rgbRegex=/^rgb\((\d+), (\d+), (\d+)\)$/,match=colorString.match(rgbRegex);if(match){var r=parseInt(match[1],10),g=parseInt(match[2],10),b=parseInt(match[3],10),a=1;return new axs.color.Color(r,g,b,a)}var rgbaRegex=/^rgba\((\d+), (\d+), (\d+), (\d*(\.\d+)?)\)/;match=colorString.match(rgbaRegex);if(match){var r=parseInt(match[1],10),g=parseInt(match[2],10),b=parseInt(match[3],10),a=parseFloat(match[4]);return new axs.color.Color(r,g,b,a)}return null};axs.color.colorChannelToString=function(value){value=Math.round(value);if(15>=value)return"0"+value.toString(16);return value.toString(16)};axs.color.colorToString=function(color){if(1==color.alpha){return"#"+axs.color.colorChannelToString(color.red)+axs.color.colorChannelToString(color.green)+axs.color.colorChannelToString(color.blue)}else return"rgba("+[color.red,color.green,color.blue,color.alpha].join(",")+")"};axs.color.luminanceFromContrastRatio=function(luminance,contrast,higher){if(higher){var newLuminance=(luminance+.05)*contrast-.05;return newLuminance}else{var newLuminance=(luminance+.05)/contrast-.05;return newLuminance}};axs.color.translateColor=function(ycc,luma){for(var _Mathabs=Math.abs,endpoint=luma>ycc.luma?axs.color.WHITE_YCC:axs.color.BLACK_YCC,cubeFaces=endpoint==axs.color.WHITE_YCC?axs.color.YCC_CUBE_FACES_WHITE:axs.color.YCC_CUBE_FACES_BLACK,a=new axs.color.YCbCr([0,ycc.Cb,ycc.Cr]),b=new axs.color.YCbCr([1,ycc.Cb,ycc.Cr]),line={a:a,b:b},intersection=null,i=0,cubeFace;i<cubeFaces.length;i++){cubeFace=cubeFaces[i];intersection=axs.color.findIntersection(line,cubeFace);if(0<=intersection.z&&1>=intersection.z)break}if(!intersection){throw"Couldn't find intersection with YCbCr color cube for Cb="+ycc.Cb+", Cr="+ycc.Cr+"."}if(intersection.x!=ycc.x||intersection.y!=ycc.y){throw"Intersection has wrong Cb/Cr values."}if(_Mathabs(endpoint.luma-intersection.luma)<_Mathabs(endpoint.luma-luma)){var translatedColor=[luma,ycc.Cb,ycc.Cr];return axs.color.fromYCbCrArray(translatedColor)}var dLuma=luma-intersection.luma,scale=dLuma/(endpoint.luma-intersection.luma),translatedColor=[luma,intersection.Cb-intersection.Cb*scale,intersection.Cr-intersection.Cr*scale];return axs.color.fromYCbCrArray(translatedColor)};axs.color.SuggestedColors;axs.color.suggestColors=function(bgColor,fgColor,desiredContrastRatios){var colors={},bgLuminance=axs.color.calculateLuminance(bgColor),fgLuminance=axs.color.calculateLuminance(fgColor),fgLuminanceIsHigher=fgLuminance>bgLuminance,fgYCbCr=axs.color.toYCbCr(fgColor),bgYCbCr=axs.color.toYCbCr(bgColor);for(var desiredLabel in desiredContrastRatios){var desiredContrast=desiredContrastRatios[desiredLabel],desiredFgLuminance=axs.color.luminanceFromContrastRatio(bgLuminance,desiredContrast+.02,fgLuminanceIsHigher);if(1>=desiredFgLuminance&&0<=desiredFgLuminance){var newFgColor=axs.color.translateColor(fgYCbCr,desiredFgLuminance),newContrastRatio=axs.color.calculateContrastRatio(newFgColor,bgColor),suggestedColors={};suggestedColors.fg=axs.color.colorToString(newFgColor);suggestedColors.bg=axs.color.colorToString(bgColor);suggestedColors.contrast=newContrastRatio.toFixed(2);colors[desiredLabel]=suggestedColors;continue}var desiredBgLuminance=axs.color.luminanceFromContrastRatio(fgLuminance,desiredContrast+.02,!fgLuminanceIsHigher);if(1>=desiredBgLuminance&&0<=desiredBgLuminance){var newBgColor=axs.color.translateColor(bgYCbCr,desiredBgLuminance),newContrastRatio=axs.color.calculateContrastRatio(fgColor,newBgColor),suggestedColors={};suggestedColors.bg=axs.color.colorToString(newBgColor);suggestedColors.fg=axs.color.colorToString(fgColor);suggestedColors.contrast=newContrastRatio.toFixed(2);colors[desiredLabel]=suggestedColors}}return colors};axs.color.flattenColors=function(fgColor,bgColor){var alpha=fgColor.alpha,r=(1-alpha)*bgColor.red+alpha*fgColor.red,g=(1-alpha)*bgColor.green+alpha*fgColor.green,b=(1-alpha)*bgColor.blue+alpha*fgColor.blue,a=fgColor.alpha+bgColor.alpha*(1-fgColor.alpha);return new axs.color.Color(r,g,b,a)};axs.color.multiplyMatrixVector=function(matrix,vector){var a=matrix[0][0],b=matrix[0][1],c=matrix[0][2],d=matrix[1][0],e=matrix[1][1],f=matrix[1][2],g=matrix[2][0],h=matrix[2][1],k=matrix[2][2],x=vector[0],y=vector[1],z=vector[2];return[a*x+b*y+c*z,d*x+e*y+f*z,g*x+h*y+k*z]};axs.color.toYCbCr=function(color){var _Mathpow=Math.pow,rSRGB=color.red/255,gSRGB=color.green/255,bSRGB=color.blue/255,r=.03928>=rSRGB?rSRGB/12.92:_Mathpow((rSRGB+.055)/1.055,2.4),g=.03928>=gSRGB?gSRGB/12.92:_Mathpow((gSRGB+.055)/1.055,2.4),b=.03928>=bSRGB?bSRGB/12.92:_Mathpow((bSRGB+.055)/1.055,2.4);return new axs.color.YCbCr(axs.color.multiplyMatrixVector(axs.color.YCC_MATRIX,[r,g,b]))};axs.color.fromYCbCr=function(ycc){return axs.color.fromYCbCrArray([ycc.luma,ycc.Cb,ycc.Cr])};axs.color.fromYCbCrArray=function(yccArray){var _Mathpow2=Math.pow,_Mathround=Math.round,_Mathmin=Math.min,_Mathmax=Math.max,rgb=axs.color.multiplyMatrixVector(axs.color.INVERTED_YCC_MATRIX,yccArray),r=rgb[0],g=rgb[1],b=rgb[2],rSRGB=.00303949>=r?12.92*r:1.055*_Mathpow2(r,1/2.4)-.055,gSRGB=.00303949>=g?12.92*g:1.055*_Mathpow2(g,1/2.4)-.055,bSRGB=.00303949>=b?12.92*b:1.055*_Mathpow2(b,1/2.4)-.055,red=_Mathmin(_Mathmax(_Mathround(255*rSRGB),0),255),green=_Mathmin(_Mathmax(_Mathround(255*gSRGB),0),255),blue=_Mathmin(_Mathmax(_Mathround(255*bSRGB),0),255);return new axs.color.Color(red,green,blue,1)};axs.color.RGBToYCbCrMatrix=function(kR,kB){return[[kR,1-kR-kB,kB],[-kR/(2-2*kB),(kR+kB-1)/(2-2*kB),(1-kB)/(2-2*kB)],[(1-kR)/(2-2*kR),(kR+kB-1)/(2-2*kR),-kB/(2-2*kR)]]};axs.color.invert3x3Matrix=function(matrix){var a=matrix[0][0],b=matrix[0][1],c=matrix[0][2],d=matrix[1][0],e=matrix[1][1],f=matrix[1][2],g=matrix[2][0],h=matrix[2][1],k=matrix[2][2],A=e*k-f*h,B=f*g-d*k,C=d*h-e*g,D=c*h-b*k,E=a*k-c*g,F=g*b-a*h,G=b*f-c*e,H=c*d-a*f,K=a*e-b*d,det=a*(e*k-f*h)-b*(k*d-f*g)+c*(d*h-e*g),z=1/det;return axs.color.scalarMultiplyMatrix([[A,D,G],[B,E,H],[C,F,K]],z)};axs.color.Line;axs.color.Plane;axs.color.findIntersection=function(l,p){var lhs=[l.a.x-p.p0.x,l.a.y-p.p0.y,l.a.z-p.p0.z],matrix=[[l.a.x-l.b.x,p.p1.x-p.p0.x,p.p2.x-p.p0.x],[l.a.y-l.b.y,p.p1.y-p.p0.y,p.p2.y-p.p0.y],[l.a.z-l.b.z,p.p1.z-p.p0.z,p.p2.z-p.p0.z]],invertedMatrix=axs.color.invert3x3Matrix(matrix),tuv=axs.color.multiplyMatrixVector(invertedMatrix,lhs),t=tuv[0],result=l.a.add(l.b.subtract(l.a).multiply(t));return result};axs.color.scalarMultiplyMatrix=function(matrix,scalar){for(var result=[],i=0;3>i;i++)result[i]=axs.color.scalarMultiplyVector(matrix[i],scalar);return result};axs.color.scalarMultiplyVector=function(vector,scalar){for(var result=[],i=0;i<vector.length;i++)result[i]=vector[i]*scalar;return result};axs.color.kR=.2126;axs.color.kB=.0722;axs.color.YCC_MATRIX=axs.color.RGBToYCbCrMatrix(axs.color.kR,axs.color.kB);axs.color.INVERTED_YCC_MATRIX=axs.color.invert3x3Matrix(axs.color.YCC_MATRIX);axs.color.BLACK=new axs.color.Color(0,0,0,1);axs.color.BLACK_YCC=axs.color.toYCbCr(axs.color.BLACK);axs.color.WHITE=new axs.color.Color(255,255,255,1);axs.color.WHITE_YCC=axs.color.toYCbCr(axs.color.WHITE);axs.color.RED=new axs.color.Color(255,0,0,1);axs.color.RED_YCC=axs.color.toYCbCr(axs.color.RED);axs.color.GREEN=new axs.color.Color(0,255,0,1);axs.color.GREEN_YCC=axs.color.toYCbCr(axs.color.GREEN);axs.color.BLUE=new axs.color.Color(0,0,255,1);axs.color.BLUE_YCC=axs.color.toYCbCr(axs.color.BLUE);axs.color.CYAN=new axs.color.Color(0,255,255,1);axs.color.CYAN_YCC=axs.color.toYCbCr(axs.color.CYAN);axs.color.MAGENTA=new axs.color.Color(255,0,255,1);axs.color.MAGENTA_YCC=axs.color.toYCbCr(axs.color.MAGENTA);axs.color.YELLOW=new axs.color.Color(255,255,0,1);axs.color.YELLOW_YCC=axs.color.toYCbCr(axs.color.YELLOW);axs.color.YCC_CUBE_FACES_BLACK=[{p0:axs.color.BLACK_YCC,p1:axs.color.RED_YCC,p2:axs.color.GREEN_YCC},{p0:axs.color.BLACK_YCC,p1:axs.color.GREEN_YCC,p2:axs.color.BLUE_YCC},{p0:axs.color.BLACK_YCC,p1:axs.color.BLUE_YCC,p2:axs.color.RED_YCC}];axs.color.YCC_CUBE_FACES_WHITE=[{p0:axs.color.WHITE_YCC,p1:axs.color.CYAN_YCC,p2:axs.color.MAGENTA_YCC},{p0:axs.color.WHITE_YCC,p1:axs.color.MAGENTA_YCC,p2:axs.color.YELLOW_YCC},{p0:axs.color.WHITE_YCC,p1:axs.color.YELLOW_YCC,p2:axs.color.CYAN_YCC}];