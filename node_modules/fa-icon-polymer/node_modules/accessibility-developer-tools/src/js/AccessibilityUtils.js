goog.require("axs.browserUtils");goog.require("axs.color");goog.require("axs.color.Color");goog.require("axs.constants");goog.require("axs.dom");goog.provide("axs.utils");axs.utils.FOCUSABLE_ELEMENTS_SELECTOR="input:not([type=hidden]):not([disabled]),"+"select:not([disabled]),"+"textarea:not([disabled]),"+"button:not([disabled]),"+"a[href],"+"iframe,"+"[tabindex]";axs.utils.LABELABLE_ELEMENTS_SELECTOR="button,"+"input:not([type=hidden]),"+"keygen,"+"meter,"+"output,"+"progress,"+"select,"+"textarea";axs.utils.elementIsTransparent=function(element){return"0"==element.style.opacity};axs.utils.elementHasZeroArea=function(element){var rect=element.getBoundingClientRect(),width=rect.right-rect.left,height=rect.top-rect.bottom;if(!width||!height)return!0;return!1};axs.utils.elementIsOutsideScrollArea=function(element){var parent=axs.dom.parentElement(element),defaultView=element.ownerDocument.defaultView;while(parent!=defaultView.document.body){if(axs.utils.isClippedBy(element,parent))return!0;if(axs.utils.canScrollTo(element,parent)&&!axs.utils.elementIsOutsideScrollArea(parent))return!1;parent=axs.dom.parentElement(parent)}return!axs.utils.canScrollTo(element,defaultView.document.body)};axs.utils.canScrollTo=function(element,container){var rect=element.getBoundingClientRect(),containerRect=container.getBoundingClientRect();if(container==container.ownerDocument.body){var absoluteTop=containerRect.top,absoluteLeft=containerRect.left}else{var absoluteTop=containerRect.top-container.scrollTop,absoluteLeft=containerRect.left-container.scrollLeft}var containerScrollArea={top:absoluteTop,bottom:absoluteTop+container.scrollHeight,left:absoluteLeft,right:absoluteLeft+container.scrollWidth};if(rect.right<containerScrollArea.left||rect.bottom<containerScrollArea.top||rect.left>containerScrollArea.right||rect.top>containerScrollArea.bottom){return!1}var defaultView=element.ownerDocument.defaultView,style=defaultView.getComputedStyle(container);if(rect.left>containerRect.right||rect.top>containerRect.bottom){return"scroll"==style.overflow||"auto"==style.overflow||container instanceof defaultView.HTMLBodyElement}return!0};axs.utils.isClippedBy=function(element,container){var rect=element.getBoundingClientRect(),containerRect=container.getBoundingClientRect(),containerTop=containerRect.top,containerLeft=containerRect.left,containerScrollArea={top:containerTop-container.scrollTop,bottom:containerTop-container.scrollTop+container.scrollHeight,left:containerLeft-container.scrollLeft,right:containerLeft-container.scrollLeft+container.scrollWidth},defaultView=element.ownerDocument.defaultView,style=defaultView.getComputedStyle(container);if((rect.right<containerRect.left||rect.bottom<containerRect.top||rect.left>containerRect.right||rect.top>containerRect.bottom)&&"hidden"==style.overflow){return!0}if(rect.right<containerScrollArea.left||rect.bottom<containerScrollArea.top)return"visible"!=style.overflow;return!1};axs.utils.isAncestor=function(ancestor,node){if(null==node)return!1;if(node===ancestor)return!0;var parentNode=axs.dom.composedParentNode(node);return axs.utils.isAncestor(ancestor,parentNode)};axs.utils.overlappingElements=function(element){if(axs.utils.elementHasZeroArea(element))return null;for(var overlappingElements=[],clientRects=element.getClientRects(),i=0;i<clientRects.length;i++){var rect=clientRects[i],center_x=(rect.left+rect.right)/2,center_y=(rect.top+rect.bottom)/2,elementAtPoint=document.elementFromPoint(center_x,center_y);if(null==elementAtPoint||elementAtPoint==element||axs.utils.isAncestor(elementAtPoint,element)||axs.utils.isAncestor(element,elementAtPoint)){continue}var overlappingElementStyle=window.getComputedStyle(elementAtPoint,null);if(!overlappingElementStyle)continue;var overlappingElementBg=axs.utils.getBgColor(overlappingElementStyle,elementAtPoint);if(overlappingElementBg&&0<overlappingElementBg.alpha&&0>overlappingElements.indexOf(elementAtPoint)){overlappingElements.push(elementAtPoint)}}return overlappingElements};axs.utils.elementIsHtmlControl=function(element){var defaultView=element.ownerDocument.defaultView;if(element instanceof defaultView.HTMLButtonElement)return!0;if(element instanceof defaultView.HTMLInputElement)return!0;if(element instanceof defaultView.HTMLSelectElement)return!0;if(element instanceof defaultView.HTMLTextAreaElement)return!0;return!1};axs.utils.elementIsAriaWidget=function(element){if(element.hasAttribute("role")){var roleValue=element.getAttribute("role");if(roleValue){var role=axs.constants.ARIA_ROLES[roleValue];if(role&&"widget"in role.allParentRolesSet)return!0}}return!1};axs.utils.elementIsVisible=function(element){if(axs.utils.elementIsTransparent(element))return!1;if(axs.utils.elementHasZeroArea(element))return!1;if(axs.utils.elementIsOutsideScrollArea(element))return!1;var overlappingElements=axs.utils.overlappingElements(element);if(overlappingElements.length)return!1;return!0};axs.utils.isLargeFont=function(style){var fontSize=style.fontSize,bold="bold"==style.fontWeight,matches=fontSize.match(/(\d+)px/);if(matches){var fontSizePx=parseInt(matches[1],10),bodyStyle=window.getComputedStyle(document.body,null),bodyFontSize=bodyStyle.fontSize;matches=bodyFontSize.match(/(\d+)px/);if(matches){var bodyFontSizePx=parseInt(matches[1],10),boldLarge=1.2*bodyFontSizePx,large=1.5*bodyFontSizePx}else{var boldLarge=19.2,large=24}return bold&&fontSizePx>=boldLarge||fontSizePx>=large}matches=fontSize.match(/(\d+)em/);if(matches){var fontSizeEm=parseInt(matches[1],10);if(bold&&1.2<=fontSizeEm||1.5<=fontSizeEm)return!0;return!1}matches=fontSize.match(/(\d+)%/);if(matches){var fontSizePercent=parseInt(matches[1],10);if(bold&&120<=fontSizePercent||150<=fontSizePercent)return!0;return!1}matches=fontSize.match(/(\d+)pt/);if(matches){var fontSizePt=parseInt(matches[1],10);if(bold&&14<=fontSizePt||18<=fontSizePt)return!0;return!1}return!1};axs.utils.getBgColor=function(style,element){var bgColorString=style.backgroundColor,bgColor=axs.color.parseColor(bgColorString);if(!bgColor)return null;if(1>style.opacity)bgColor.alpha=bgColor.alpha*style.opacity;if(1>bgColor.alpha){var parentBg=axs.utils.getParentBgColor(element);if(null==parentBg)return null;bgColor=axs.color.flattenColors(bgColor,parentBg)}return bgColor};axs.utils.getParentBgColor=function(element){var parent=element,bgStack=[],foundSolidColor=null;while(parent=axs.dom.parentElement(parent)){var computedStyle=window.getComputedStyle(parent,null);if(!computedStyle)continue;var parentBg=axs.color.parseColor(computedStyle.backgroundColor);if(!parentBg)continue;if(1>computedStyle.opacity)parentBg.alpha=parentBg.alpha*computedStyle.opacity;if(0==parentBg.alpha)continue;bgStack.push(parentBg);if(1==parentBg.alpha){foundSolidColor=!0;break}}if(!foundSolidColor)bgStack.push(new axs.color.Color(255,255,255,1));var bg=bgStack.pop();while(bgStack.length){var fg=bgStack.pop();bg=axs.color.flattenColors(fg,bg)}return bg};axs.utils.getFgColor=function(style,element,bgColor){var fgColorString=style.color,fgColor=axs.color.parseColor(fgColorString);if(!fgColor)return null;if(1>fgColor.alpha)fgColor=axs.color.flattenColors(fgColor,bgColor);if(1>style.opacity){var parentBg=axs.utils.getParentBgColor(element);fgColor.alpha=fgColor.alpha*style.opacity;fgColor=axs.color.flattenColors(fgColor,parentBg)}return fgColor};axs.utils.getContrastRatioForElement=function(element){var style=window.getComputedStyle(element,null);return axs.utils.getContrastRatioForElementWithComputedStyle(style,element)};axs.utils.getContrastRatioForElementWithComputedStyle=function(style,element){if(axs.utils.isElementHidden(element))return null;var bgColor=axs.utils.getBgColor(style,element);if(!bgColor)return null;var fgColor=axs.utils.getFgColor(style,element,bgColor);if(!fgColor)return null;return axs.color.calculateContrastRatio(fgColor,bgColor)};axs.utils.isNativeTextElement=function(element){var tagName=element.tagName.toLowerCase(),type=element.type?element.type.toLowerCase():"";if("textarea"==tagName)return!0;if("input"!=tagName)return!1;switch(type){case"email":case"number":case"password":case"search":case"text":case"tel":case"url":case"":return!0;default:return!1;}};axs.utils.isLowContrast=function(contrastRatio,style,opt_strict){var roundedContrastRatio=Math.round(10*contrastRatio)/10;if(!opt_strict){return 3>roundedContrastRatio||!axs.utils.isLargeFont(style)&&4.5>roundedContrastRatio}else{return 4.5>roundedContrastRatio||!axs.utils.isLargeFont(style)&&7>roundedContrastRatio}};axs.utils.hasLabel=function(element){var tagName=element.tagName.toLowerCase(),type=element.type?element.type.toLowerCase():"";if(element.hasAttribute("aria-label"))return!0;if(element.hasAttribute("title"))return!0;if("img"==tagName&&element.hasAttribute("alt"))return!0;if("input"==tagName&&"image"==type&&element.hasAttribute("alt"))return!0;if("input"==tagName&&("submit"==type||"reset"==type))return!0;if(element.hasAttribute("aria-labelledby"))return!0;if(element.hasAttribute("id")){var labelsFor=document.querySelectorAll("label[for=\""+element.id+"\"]");if(0<labelsFor.length)return!0}var parent=axs.dom.parentElement(element);while(parent){if("label"==parent.tagName.toLowerCase()){var parentLabel=parent;if(parentLabel.control==element)return!0}parent=axs.dom.parentElement(parent)}return!1};axs.utils.isNativelyDisableable=function(element){var tagName=element.tagName.toUpperCase();return tagName in axs.constants.NATIVELY_DISABLEABLE};axs.utils.isElementDisabled=function(element,ignoreAncestors){var selector=ignoreAncestors?"[aria-disabled=true]":"[aria-disabled=true], [aria-disabled=true] *";if(axs.browserUtils.matchSelector(element,selector)){return!0}if(!axs.utils.isNativelyDisableable(element)||axs.browserUtils.matchSelector(element,"fieldset>legend:first-of-type *")){return!1}for(var next=element;null!==next;next=axs.dom.parentElement(next)){if(next.hasAttribute("disabled")){return!0}if(ignoreAncestors){return!1}}return!1};axs.utils.isElementHidden=function(element){if(!(element instanceof element.ownerDocument.defaultView.HTMLElement))return!1;if(element.hasAttribute("chromevoxignoreariahidden"))var chromevoxignoreariahidden=!0;var style=window.getComputedStyle(element,null);if("none"==style.display||"hidden"==style.visibility)return!0;if(element.hasAttribute("aria-hidden")&&"true"==element.getAttribute("aria-hidden").toLowerCase()){return!chromevoxignoreariahidden}return!1};axs.utils.isElementOrAncestorHidden=function(element){if(axs.utils.isElementHidden(element))return!0;if(axs.dom.parentElement(element))return axs.utils.isElementOrAncestorHidden(axs.dom.parentElement(element));else return!1};axs.utils.isInlineElement=function(element){var tagName=element.tagName.toUpperCase();return axs.constants.InlineElements[tagName]};axs.utils.getRoles=function(element,implicit){if(!element||element.nodeType!==Node.ELEMENT_NODE||!element.hasAttribute("role")&&!implicit)return null;var roleValue=element.getAttribute("role");if(!roleValue&&implicit)roleValue=axs.properties.getImplicitRole(element);if(!roleValue)return null;for(var roleNames=roleValue.split(" "),result={roles:[],valid:!1},i=0;i<roleNames.length;i++){var role=roleNames[i],ariaRole=axs.constants.ARIA_ROLES[role],roleObject={name:role};if(ariaRole&&!ariaRole.abstract){roleObject.details=ariaRole;if(!result.applied){result.applied=roleObject}roleObject.valid=result.valid=!0}else{roleObject.valid=!1}result.roles.push(roleObject)}return result};axs.utils.getAriaPropertyValue=function(propertyName,value,element){var propertyKey=propertyName.replace(/^aria-/,""),property=axs.constants.ARIA_PROPERTIES[propertyKey],result={name:propertyName,rawValue:value};if(!property){result.valid=!1;result.reason="\""+propertyName+"\" is not a valid ARIA property";return result}var propertyType=property.valueType;if(!propertyType){result.valid=!1;result.reason="\""+propertyName+"\" is not a valid ARIA property";return result}switch(propertyType){case"idref":var isValid=axs.utils.isValidIDRefValue(value,element);result.valid=isValid.valid;result.reason=isValid.reason;result.idref=isValid.idref;case"idref_list":var idrefValues=value.split(/\s+/);result.valid=!0;for(var i=0,refIsValid;i<idrefValues.length;i++){refIsValid=axs.utils.isValidIDRefValue(idrefValues[i],element);if(!refIsValid.valid)result.valid=!1;if(result.values)result.values.push(refIsValid);else result.values=[refIsValid]}return result;case"integer":var validNumber=axs.utils.isValidNumber(value);if(!validNumber.valid){result.valid=!1;result.reason=validNumber.reason;return result}if(Math.floor(validNumber.value)!==validNumber.value){result.valid=!1;result.reason=""+value+" is not a whole integer"}else{result.valid=!0;result.value=validNumber.value}return result;case"decimal":case"number":var validNumber=axs.utils.isValidNumber(value);result.valid=validNumber.valid;if(!validNumber.valid){result.reason=validNumber.reason;return result}result.value=validNumber.value;return result;case"string":result.valid=!0;result.value=value;return result;case"token":var validTokenValue=axs.utils.isValidTokenValue(propertyName,value.toLowerCase());if(validTokenValue.valid){result.valid=!0;result.value=validTokenValue.value;return result}else{result.valid=!1;result.value=value;result.reason=validTokenValue.reason;return result}case"token_list":var tokenValues=value.split(/\s+/);result.valid=!0;for(var i=0,validTokenValue;i<tokenValues.length;i++){validTokenValue=axs.utils.isValidTokenValue(propertyName,tokenValues[i].toLowerCase());if(!validTokenValue.valid){result.valid=!1;if(result.reason){result.reason=[result.reason];result.reason.push(validTokenValue.reason)}else{result.reason=validTokenValue.reason;result.possibleValues=validTokenValue.possibleValues}}if(result.values)result.values.push(validTokenValue.value);else result.values=[validTokenValue.value]}return result;case"tristate":var validTristate=axs.utils.isPossibleValue(value.toLowerCase(),axs.constants.MIXED_VALUES,propertyName);if(validTristate.valid){result.valid=!0;result.value=validTristate.value}else{result.valid=!1;result.value=value;result.reason=validTristate.reason}return result;case"boolean":var validBoolean=axs.utils.isValidBoolean(value);if(validBoolean.valid){result.valid=!0;result.value=validBoolean.value}else{result.valid=!1;result.value=value;result.reason=validBoolean.reason}return result;}result.valid=!1;result.reason="Not a valid ARIA property";return result};axs.utils.isValidTokenValue=function(propertyName,value){var propertyKey=propertyName.replace(/^aria-/,""),propertyDetails=axs.constants.ARIA_PROPERTIES[propertyKey],possibleValues=propertyDetails.valuesSet;return axs.utils.isPossibleValue(value,possibleValues,propertyName)};axs.utils.isPossibleValue=function(value,possibleValues,propertyName){if(!possibleValues[value])return{valid:!1,value:value,reason:"\""+value+"\" is not a valid value for "+propertyName,possibleValues:Object.keys(possibleValues)};return{valid:!0,value:value}};axs.utils.isValidBoolean=function(value){try{var parsedValue=JSON.parse(value)}catch(e){parsedValue=""}if("boolean"!=typeof parsedValue)return{valid:!1,value:value,reason:"\""+value+"\" is not a true/false value"};return{valid:!0,value:parsedValue}};axs.utils.isValidIDRefValue=function(value,element){if(0==value.length)return{valid:!0,idref:value};if(!element.ownerDocument.getElementById(value))return{valid:!1,idref:value,reason:"No element with ID \""+value+"\""};return{valid:!0,idref:value}};axs.utils.isValidNumber=function(value){var failResult={valid:!1,value:value,reason:"\""+value+"\" is not a number"};if(!value){return failResult}if(/^0x/i.test(value)){failResult.reason="\""+value+"\" is not a decimal number";return failResult}var parsedValue=1*value;if(!isFinite(parsedValue)){return failResult}return{valid:!0,value:parsedValue}};axs.utils.isElementImplicitlyFocusable=function(element){var defaultView=element.ownerDocument.defaultView;if(element instanceof defaultView.HTMLAnchorElement||element instanceof defaultView.HTMLAreaElement)return element.hasAttribute("href");if(element instanceof defaultView.HTMLInputElement||element instanceof defaultView.HTMLSelectElement||element instanceof defaultView.HTMLTextAreaElement||element instanceof defaultView.HTMLButtonElement||element instanceof defaultView.HTMLIFrameElement)return!element.disabled;return!1};axs.utils.values=function(obj){var values=[];for(var key in obj){if(obj.hasOwnProperty(key)&&"function"!=typeof obj[key])values.push(obj[key])}return values};axs.utils.namedValues=function(obj){var values={};for(var key in obj){if(obj.hasOwnProperty(key)&&"function"!=typeof obj[key])values[key]=obj[key]}return values};function escapeId(id){return id.replace(/[^a-zA-Z0-9_-]/g,function(match){return"\\"+match})}axs.utils.getQuerySelectorText=function(obj){if(null==obj||"HTML"==obj.tagName){return"html"}else if("BODY"==obj.tagName){return"body"}if(obj.hasAttribute){if(obj.id){return"#"+escapeId(obj.id)}if(obj.className){for(var selector="",i=0;i<obj.classList.length;i++)selector+="."+obj.classList[i];var total=0;if(obj.parentNode){for(i=0;i<obj.parentNode.children.length;i++){var similar=obj.parentNode.children[i];if(axs.browserUtils.matchSelector(similar,selector))total++;if(similar===obj)break}}else{total=1}if(1==total){return axs.utils.getQuerySelectorText(obj.parentNode)+" > "+selector}}if(obj.parentNode){var similarTags=obj.parentNode.children,total=1,i=0;while(similarTags[i]!==obj){if(similarTags[i].tagName==obj.tagName){total++}i++}var next="";if("BODY"!=obj.parentNode.tagName){next=axs.utils.getQuerySelectorText(obj.parentNode)+" > "}if(1==total){return next+obj.tagName}else{return next+obj.tagName+":nth-of-type("+total+")"}}}else if(obj.selectorText){return obj.selectorText}return""};axs.utils.getAriaIdReferrers=function(element,opt_attributeName){var propertyToSelector=function(propertyKey){var propertyDetails=axs.constants.ARIA_PROPERTIES[propertyKey];if(propertyDetails){if("idref"===propertyDetails.valueType){return"[aria-"+propertyKey+"='"+id+"']"}else if("idref_list"===propertyDetails.valueType){return"[aria-"+propertyKey+"~='"+id+"']"}}return""};if(!element)return null;var id=element.id;if(!id)return null;id=id.replace(/'/g,"\\'");if(opt_attributeName){var propertyKey=opt_attributeName.replace(/^aria-/,""),referrerQuery=propertyToSelector(propertyKey);if(referrerQuery){return element.ownerDocument.querySelectorAll(referrerQuery)}}else{var selectors=[];for(var propertyKey in axs.constants.ARIA_PROPERTIES){var referrerQuery=propertyToSelector(propertyKey);if(referrerQuery){selectors.push(referrerQuery)}}return element.ownerDocument.querySelectorAll(selectors.join(","))}return null};axs.utils.getHtmlIdReferrers=function(element){if(!element)return null;var id=element.id;if(!id)return null;id=id.replace(/'/g,"\\'");var selectorTemplates=["[contextmenu='{id}']","[itemref~='{id}']","button[form='{id}']","button[menu='{id}']","fieldset[form='{id}']","input[form='{id}']","input[list='{id}']","keygen[form='{id}']","label[for='{id}']","label[form='{id}']","menuitem[command='{id}']","object[form='{id}']","output[for~='{id}']","output[form='{id}']","select[form='{id}']","td[headers~='{id}']","textarea[form='{id}']","tr[headers~='{id}']"],selectors=selectorTemplates.map(function(selector){return selector.replace("{id}",id)});return element.ownerDocument.querySelectorAll(selectors.join(","))};axs.utils.getReferencedIds=function(element){for(var result=[],addResult=function(ids){if(ids){if(0<ids.indexOf(" ")){result=result.concat(attrib.value.split(" "))}else{result.push(ids)}}},i=0;i<element.attributes.length;i++){var tagName=element.tagName.toLowerCase(),attrib=element.attributes[i];if(attrib.specified){var attribName=attrib.name,ariaAttr=attribName.match(/aria-(.+)/);if(ariaAttr){var details=axs.constants.ARIA_PROPERTIES[ariaAttr[1]];if(details&&("idref"===details.valueType||"idref_list"===details.valueType)){addResult(attrib.value)}continue}switch(attribName){case"contextmenu":case"itemref":addResult(attrib.value);break;case"form":if("button"==tagName||"fieldset"==tagName||"input"==tagName||"keygen"==tagName||"label"==tagName||"object"==tagName||"output"==tagName||"select"==tagName||"textarea"==tagName){addResult(attrib.value)}break;case"for":if("label"==tagName||"output"==tagName){addResult(attrib.value)}break;case"menu":if("button"==tagName){addResult(attrib.value)}break;case"list":if("input"==tagName){addResult(attrib.value)}break;case"command":if("menuitem"==tagName){addResult(attrib.value)}break;case"headers":if("td"==tagName||"tr"==tagName){addResult(attrib.value)}break;}}}return result};axs.utils.getIdReferrers=function(element){var result=[],referrers=axs.utils.getHtmlIdReferrers(element);if(referrers){result=result.concat(Array.prototype.slice.call(referrers))}referrers=axs.utils.getAriaIdReferrers(element);if(referrers){result=result.concat(Array.prototype.slice.call(referrers))}return result};axs.utils.getIdReferents=function(attributeName,element){var result=[],propertyKey=attributeName.replace(/^aria-/,""),property=axs.constants.ARIA_PROPERTIES[propertyKey];if(!property||!element.hasAttribute(attributeName))return result;var propertyType=property.valueType;if("idref_list"===propertyType||"idref"===propertyType){var ownerDocument=element.ownerDocument,ids=element.getAttribute(attributeName);ids=ids.split(/\s+/);for(var i=0,len=ids.length,next;i<len;i++){next=ownerDocument.getElementById(ids[i]);if(next){result[result.length]=next}}}return result};axs.utils.getAriaPropertiesByValueType=function(valueTypes){var result={};for(var propertyName in axs.constants.ARIA_PROPERTIES){var property=axs.constants.ARIA_PROPERTIES[propertyName];if(property&&0<=valueTypes.indexOf(property.valueType)){result[propertyName]=property}}return result};axs.utils.getSelectorForAriaProperties=function(ariaProperties){var propertyNames=Object.keys(ariaProperties),result=propertyNames.map(function(propertyName){return"[aria-"+propertyName+"]"});result.sort();return result.join(",")};axs.utils.findDescendantsWithRole=function(element,role){if(!(element&&role))return[];var selector=axs.properties.getSelectorForRole(role);if(!selector)return[];var result=element.querySelectorAll(selector);if(result){result=Array.prototype.map.call(result,function(item){return item})}else{return[]}return result};