goog.require("axs.browserUtils");goog.require("axs.constants");goog.require("axs.dom");goog.provide("axs.AuditRule");goog.provide("axs.AuditRule.Spec");axs.AuditRule=function(spec){for(var requires=spec.opt_requires||{},isValid=!0,missingFields=[],i=0,requiredField;i<axs.AuditRule.requiredFields.length;i++){requiredField=axs.AuditRule.requiredFields[i];if(!(requiredField in spec)){isValid=!1;missingFields.push(requiredField)}}if(!isValid){throw"Invalid spec; the following fields were not specified: "+missingFields.join(", ")+"\n"+JSON.stringify(spec)}this.name=spec.name;this.severity=spec.severity;this.relevantElementMatcher_=spec.relevantElementMatcher;this.isRelevant_=spec.isRelevant||function(element,flags){return!0};this.test_=spec.test;this.code=spec.code;this.heading=spec.heading||"";this.url=spec.url||"";this.requiresConsoleAPI=!!requires.consoleAPI;this.relevantElements=[];this.relatedElements=[];this.collectIdRefs=requires.idRefs||!1};axs.AuditRule.SpecWithRequires;axs.AuditRule.SpecWithoutRequires;axs.AuditRule.Spec;axs.AuditRule.RelevantElement;axs.AuditRule.requiredFields=["name","severity","relevantElementMatcher","test","code","heading"];axs.AuditRule.NOT_APPLICABLE={result:axs.constants.AuditResult.NA};axs.AuditRule.prototype.addElement=function(elements,element){elements.push(element)};axs.AuditRule.prototype.collectMatchingElement=function(element,flags){if(this.relevantElementMatcher_(element,flags)&&flags.inScope){this.relevantElements.push({element:element,flags:flags});return!0}return!1};axs.AuditRule.prototype.canRun=function(configuration){if(this.disabled){return!1}if(!configuration.withConsoleApi&&this.requiresConsoleAPI){return!1}return!0};axs.AuditRule.Result=function(configuration,auditRule){var ruleValues=axs.utils.namedValues(auditRule);ruleValues.severity=configuration.getSeverity(auditRule.name)||ruleValues.severity;this.rule=ruleValues;this.maxResults=configuration.maxResults;this.update(axs.constants.AuditResult.NA)};axs.AuditRule.Result.prototype.update=function(auditResult,element){var result=this;if(auditResult===axs.constants.AuditResult.FAIL){var failingElements=result.elements||(result.elements=[]);result.result=auditResult;if(this.maxResults&&result.elements.length>=this.maxResults){result.resultsTruncated=!0}else if(element){failingElements.push(element)}}else if(auditResult===axs.constants.AuditResult.PASS){if(!result.elements)result.elements=[];if(result.result!==axs.constants.AuditResult.FAIL)result.result=auditResult}else if(!result.result){result.result=auditResult}};axs.AuditRule.prototype.run=function(configuration){try{var options=this._options||{},result=new axs.AuditRule.Result(configuration,this),next;while(next=this.relevantElements.shift()){var element=next.element,flags=next.flags;if(this.isRelevant_(element,flags)){if(this.test_(element,flags,options.config)){result.update(axs.constants.AuditResult.FAIL,element)}else{result.update(axs.constants.AuditResult.PASS,element)}}}return result}finally{this.relatedElements.length=0}};