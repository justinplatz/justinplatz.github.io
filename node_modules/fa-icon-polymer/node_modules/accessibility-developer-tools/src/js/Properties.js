goog.require("axs.browserUtils");goog.require("axs.color");goog.require("axs.dom");goog.require("axs.utils");goog.provide("axs.properties");axs.properties.TEXT_CONTENT_XPATH=".//text()[normalize-space(.)!=\"\"]/parent::*[name()!=\"script\"]";axs.properties.getFocusProperties=function(element){var focusProperties={},tabindex=element.getAttribute("tabindex");if(tabindex!=void 0){focusProperties.tabindex={value:tabindex,valid:!0}}else{if(axs.utils.isElementImplicitlyFocusable(element))focusProperties.implicitlyFocusable={value:!0,valid:!0}}if(0==Object.keys(focusProperties).length)return null;var transparent=axs.utils.elementIsTransparent(element),zeroArea=axs.utils.elementHasZeroArea(element),outsideScrollArea=axs.utils.elementIsOutsideScrollArea(element),overlappingElements=axs.utils.overlappingElements(element);if(transparent||zeroArea||outsideScrollArea||0<overlappingElements.length){var hidden=axs.utils.isElementOrAncestorHidden(element),visibleProperties={value:!1,valid:hidden};if(transparent)visibleProperties.transparent=!0;if(zeroArea)visibleProperties.zeroArea=!0;if(outsideScrollArea)visibleProperties.outsideScrollArea=!0;if(overlappingElements&&0<overlappingElements.length)visibleProperties.overlappingElements=overlappingElements;var hiddenProperties={value:hidden,valid:hidden};if(hidden)hiddenProperties.reason=axs.properties.getHiddenReason(element);visibleProperties.hidden=hiddenProperties;focusProperties.visible=visibleProperties}else{focusProperties.visible={value:!0,valid:!0}}return focusProperties};axs.properties.hiddenReason;axs.properties.getHiddenReason=function(element){if(!element||!(element instanceof element.ownerDocument.defaultView.HTMLElement))return null;if(element.hasAttribute("chromevoxignoreariahidden"))var chromevoxignoreariahidden=!0;var style=window.getComputedStyle(element,null);if("none"==style.display)return{property:"display: none",on:element};if("hidden"==style.visibility)return{property:"visibility: hidden",on:element};if(element.hasAttribute("aria-hidden")&&"true"==element.getAttribute("aria-hidden").toLowerCase()){if(!chromevoxignoreariahidden)return{property:"aria-hidden",on:element}}return axs.properties.getHiddenReason(axs.dom.parentElement(element))};axs.properties.getColorProperties=function(element){var colorProperties={},contrastRatioProperties=axs.properties.getContrastRatioProperties(element);if(contrastRatioProperties)colorProperties.contrastRatio=contrastRatioProperties;if(0==Object.keys(colorProperties).length)return null;return colorProperties};axs.properties.hasDirectTextDescendant=function(element){var ownerDocument;if(element.nodeType==Node.DOCUMENT_NODE)ownerDocument=element;else ownerDocument=element.ownerDocument;if(ownerDocument.evaluate){return hasDirectTextDescendantXpath()}return hasDirectTextDescendantTreeWalker();function hasDirectTextDescendantXpath(){for(var selectorResults=ownerDocument.evaluate(axs.properties.TEXT_CONTENT_XPATH,element,null,XPathResult.ANY_TYPE,null),resultElement=selectorResults.iterateNext();null!=resultElement;resultElement=selectorResults.iterateNext()){if(resultElement!==element)continue;return!0}return!1}function hasDirectTextDescendantTreeWalker(){var treeWalker=ownerDocument.createTreeWalker(element,NodeFilter.SHOW_TEXT,null,!1);while(treeWalker.nextNode()){var resultElement=treeWalker.currentNode,parent=resultElement.parentNode;parent=parent.host||parent;var tagName=parent.tagName.toLowerCase(),value=resultElement.nodeValue.trim();if(value&&"script"!==tagName&&element!==resultElement)return!0}return!1}};axs.properties.getContrastRatioProperties=function(element){if(!axs.properties.hasDirectTextDescendant(element))return null;var contrastRatioProperties={},style=window.getComputedStyle(element,null),bgColor=axs.utils.getBgColor(style,element);if(!bgColor)return null;contrastRatioProperties.backgroundColor=axs.color.colorToString(bgColor);var fgColor=axs.utils.getFgColor(style,element,bgColor);contrastRatioProperties.foregroundColor=axs.color.colorToString(fgColor);var contrast=axs.utils.getContrastRatioForElementWithComputedStyle(style,element);if(!contrast)return null;contrastRatioProperties.value=contrast.toFixed(2);if(axs.utils.isLowContrast(contrast,style))contrastRatioProperties.alert=!0;var levelAAContrast=axs.utils.isLargeFont(style)?3:4.5,levelAAAContrast=axs.utils.isLargeFont(style)?4.5:7,desiredContrastRatios={};if(levelAAContrast>contrast)desiredContrastRatios.AA=levelAAContrast;if(levelAAAContrast>contrast)desiredContrastRatios.AAA=levelAAAContrast;if(!Object.keys(desiredContrastRatios).length)return contrastRatioProperties;var suggestedColors=axs.color.suggestColors(bgColor,fgColor,desiredContrastRatios);if(suggestedColors&&Object.keys(suggestedColors).length)contrastRatioProperties.suggestedColors=suggestedColors;return contrastRatioProperties};axs.properties.findTextAlternatives=function(node,textAlternatives,opt_recursive,opt_force){var recursive=opt_recursive||!1,element=axs.dom.asElement(node);if(!element)return null;if(!opt_force&&axs.utils.isElementOrAncestorHidden(element))return null;if(node.nodeType==Node.TEXT_NODE){var textContentValue={type:"text",text:node.textContent};textContentValue.lastWord=axs.properties.getLastWord(textContentValue.text);textAlternatives.content=textContentValue;return node.textContent}var computedName=null;if(!recursive){computedName=axs.properties.getTextFromAriaLabelledby(element,textAlternatives)}if(element.hasAttribute("aria-label")){var ariaLabelValue={type:"text",text:element.getAttribute("aria-label")};ariaLabelValue.lastWord=axs.properties.getLastWord(ariaLabelValue.text);if(computedName)ariaLabelValue.unused=!0;else if(!(recursive&&axs.utils.elementIsHtmlControl(element)))computedName=ariaLabelValue.text;textAlternatives.ariaLabel=ariaLabelValue}if(!element.hasAttribute("role")||"presentation"!=element.getAttribute("role")){computedName=axs.properties.getTextFromHostLanguageAttributes(element,textAlternatives,computedName,recursive)}if(recursive&&axs.utils.elementIsHtmlControl(element)){var defaultView=element.ownerDocument.defaultView;if(element instanceof defaultView.HTMLInputElement){var inputElement=element;if("text"==inputElement.type){if(inputElement.value&&0<inputElement.value.length)textAlternatives.controlValue={text:inputElement.value}}if("range"==inputElement.type)textAlternatives.controlValue={text:inputElement.value}}if(element instanceof defaultView.HTMLSelectElement){var inputElement=element;textAlternatives.controlValue={text:inputElement.value}}if(textAlternatives.controlValue){var controlValue=textAlternatives.controlValue;if(computedName)controlValue.unused=!0;else computedName=controlValue.text}}if(recursive&&axs.utils.elementIsAriaWidget(element)){var role=element.getAttribute("role");if("textbox"==role){if(element.textContent&&0<element.textContent.length)textAlternatives.controlValue={text:element.textContent}}if("slider"==role||"spinbutton"==role){if(element.hasAttribute("aria-valuetext"))textAlternatives.controlValue={text:element.getAttribute("aria-valuetext")};else if(element.hasAttribute("aria-valuenow"))textAlternatives.controlValue={value:element.getAttribute("aria-valuenow"),text:""+element.getAttribute("aria-valuenow")}}if("menu"==role){for(var menuitems=element.querySelectorAll("[role=menuitemcheckbox], [role=menuitemradio]"),selectedMenuitems=[],i=0;i<menuitems.length;i++){if("true"==menuitems[i].getAttribute("aria-checked"))selectedMenuitems.push(menuitems[i])}if(0<selectedMenuitems.length){for(var selectedMenuText="",i=0;i<selectedMenuitems.length;i++){selectedMenuText+=axs.properties.findTextAlternatives(selectedMenuitems[i],{},!0);if(i<selectedMenuitems.length-1)selectedMenuText+=", "}textAlternatives.controlValue={text:selectedMenuText}}}if("combobox"==role||"select"==role){textAlternatives.controlValue={text:"TODO"}}if(textAlternatives.controlValue){var controlValue=textAlternatives.controlValue;if(computedName)controlValue.unused=!0;else computedName=controlValue.text}}var hasRole=element.hasAttribute("role"),canGetNameFromContents=!0;if(hasRole){var roleName=element.getAttribute("role"),role=axs.constants.ARIA_ROLES[roleName];if(role&&(!role.namefrom||0>role.namefrom.indexOf("contents")))canGetNameFromContents=!1}var textFromContent=axs.properties.getTextFromDescendantContent(element,opt_force);if(textFromContent&&canGetNameFromContents){var textFromContentValue={type:"text",text:textFromContent};textFromContentValue.lastWord=axs.properties.getLastWord(textFromContentValue.text);if(computedName)textFromContentValue.unused=!0;else computedName=textFromContent;textAlternatives.content=textFromContentValue}if(element.hasAttribute("title")){var titleValue={type:"string",valid:!0,text:element.getAttribute("title")};titleValue.lastWord=axs.properties.getLastWord(titleValue.lastWord);if(computedName)titleValue.unused=!0;else computedName=titleValue.text;textAlternatives.title=titleValue}if(0==Object.keys(textAlternatives).length&&null==computedName)return null;return computedName};axs.properties.getTextFromDescendantContent=function(element,opt_force){for(var children=element.childNodes,childrenTextContent=[],i=0,childTextContent;i<children.length;i++){childTextContent=axs.properties.findTextAlternatives(children[i],{},!0,opt_force);if(childTextContent)childrenTextContent.push(childTextContent.trim())}if(childrenTextContent.length){for(var result="",i=0;i<childrenTextContent.length;i++)result=[result,childrenTextContent[i]].join(" ").trim();return result}return null};axs.properties.getTextFromAriaLabelledby=function(element,textAlternatives){var computedName=null;if(!element.hasAttribute("aria-labelledby"))return computedName;var labelledbyAttr=element.getAttribute("aria-labelledby"),labelledbyIds=labelledbyAttr.split(/\s+/),labelledbyValue={};labelledbyValue.valid=!0;for(var labelledbyText=[],labelledbyValues=[],i=0,labelledby;i<labelledbyIds.length;i++){labelledby={};labelledby.type="element";var labelledbyId=labelledbyIds[i];labelledby.value=labelledbyId;var labelledbyElement=document.getElementById(labelledbyId);if(!labelledbyElement){labelledby.valid=!1;labelledbyValue.valid=!1;labelledby.errorMessage={messageKey:"noElementWithId",args:[labelledbyId]}}else{labelledby.valid=!0;labelledby.text=axs.properties.findTextAlternatives(labelledbyElement,{},!0,!0);labelledby.lastWord=axs.properties.getLastWord(labelledby.text);labelledbyText.push(labelledby.text);labelledby.element=labelledbyElement}labelledbyValues.push(labelledby)}if(0<labelledbyValues.length){labelledbyValues[labelledbyValues.length-1].last=!0;labelledbyValue.values=labelledbyValues;labelledbyValue.text=labelledbyText.join(" ");labelledbyValue.lastWord=axs.properties.getLastWord(labelledbyValue.text);computedName=labelledbyValue.text;textAlternatives.ariaLabelledby=labelledbyValue}return computedName};axs.properties.getTextFromHostLanguageAttributes=function(element,textAlternatives,existingComputedname,recursive){var computedName=existingComputedname;if(axs.browserUtils.matchSelector(element,"img")&&element.hasAttribute("alt")){var altValue={type:"string",valid:!0,text:element.getAttribute("alt")};if(computedName)altValue.unused=!0;else computedName=altValue.text;textAlternatives.alt=altValue}var controlsSelector=["input:not([type=\"hidden\"]):not([disabled])","select:not([disabled])","textarea:not([disabled])","button:not([disabled])","video:not([disabled])"].join(", ");if(axs.browserUtils.matchSelector(element,controlsSelector)&&!recursive){if(element.hasAttribute("id")){for(var labelForQuerySelector="label[for=\""+element.id+"\"]",labelsFor=document.querySelectorAll(labelForQuerySelector),labelForValue={},labelForValues=[],labelForText=[],i=0,labelFor;i<labelsFor.length;i++){labelFor={};labelFor.type="element";var label=labelsFor[i],labelText=axs.properties.findTextAlternatives(label,{},!0);if(labelText&&0<labelText.trim().length){labelFor.text=labelText.trim();labelForText.push(labelText.trim())}labelFor.element=label;labelForValues.push(labelFor)}if(0<labelForValues.length){labelForValues[labelForValues.length-1].last=!0;labelForValue.values=labelForValues;labelForValue.text=labelForText.join(" ");labelForValue.lastWord=axs.properties.getLastWord(labelForValue.text);if(computedName)labelForValue.unused=!0;else computedName=labelForValue.text;textAlternatives.labelFor=labelForValue}}var parent=axs.dom.parentElement(element),labelWrappedValue={};while(parent){if("label"==parent.tagName.toLowerCase()){var parentLabel=parent;if(parentLabel.control==element){labelWrappedValue.type="element";labelWrappedValue.text=axs.properties.findTextAlternatives(parentLabel,{},!0);labelWrappedValue.lastWord=axs.properties.getLastWord(labelWrappedValue.text);labelWrappedValue.element=parentLabel;break}}parent=axs.dom.parentElement(parent)}if(labelWrappedValue.text){if(computedName)labelWrappedValue.unused=!0;else computedName=labelWrappedValue.text;textAlternatives.labelWrapped=labelWrappedValue}if(axs.browserUtils.matchSelector(element,"input[type=\"image\"]")&&element.hasAttribute("alt")){var altValue={type:"string",valid:!0,text:element.getAttribute("alt")};if(computedName)altValue.unused=!0;else computedName=altValue.text;textAlternatives.alt=altValue}if(!Object.keys(textAlternatives).length)textAlternatives.noLabel=!0}return computedName};axs.properties.getLastWord=function(text){if(!text)return null;var lastSpace=text.lastIndexOf(" ")+1,MAXLENGTH=10,cutoff=text.length-MAXLENGTH,wordStart=lastSpace>cutoff?lastSpace:cutoff;return text.substring(wordStart)};axs.properties.getTextProperties=function(node){var textProperties={},computedName=axs.properties.findTextAlternatives(node,textProperties,!1,!0);if(0==Object.keys(textProperties).length){var element=axs.dom.asElement(node);if(element&&axs.browserUtils.matchSelector(element,"img")){var altValue={valid:!1,errorMessage:"No alt value provided"};textProperties.alt=altValue;var src=element.src;if("string"==typeof src){var parts=src.split("/"),filename=parts.pop(),filenameValue={text:filename};textProperties.filename=filenameValue;computedName=filename}}if(!computedName)return null}textProperties.hasProperties=!!Object.keys(textProperties).length;textProperties.computedText=computedName;textProperties.lastWord=axs.properties.getLastWord(computedName);return textProperties};axs.properties.getAriaProperties=function(element){var ariaProperties={},statesAndProperties=axs.properties.getGlobalAriaProperties(element);for(var property in axs.constants.ARIA_PROPERTIES){var attributeName="aria-"+property;if(element.hasAttribute(attributeName)){var propertyValue=element.getAttribute(attributeName);statesAndProperties[attributeName]=axs.utils.getAriaPropertyValue(attributeName,propertyValue,element)}}if(0<Object.keys(statesAndProperties).length)ariaProperties.properties=axs.utils.values(statesAndProperties);var roles=axs.utils.getRoles(element);if(!roles){if(Object.keys(ariaProperties).length)return ariaProperties;return null}ariaProperties.roles=roles;if(!roles.valid||!roles.roles)return ariaProperties;for(var roleDetails=roles.roles,i=0,role;i<roleDetails.length;i++){role=roleDetails[i];if(!role.details||!role.details.propertiesSet)continue;for(var property in role.details.propertiesSet){if(property in statesAndProperties)continue;if(element.hasAttribute(property)){var propertyValue=element.getAttribute(property);statesAndProperties[property]=axs.utils.getAriaPropertyValue(property,propertyValue,element);if("values"in statesAndProperties[property]){var values=statesAndProperties[property].values;values[values.length-1].isLast=!0}}else if(role.details.requiredPropertiesSet[property]){statesAndProperties[property]={name:property,valid:!1,reason:"Required property not set"}}}}if(0<Object.keys(statesAndProperties).length)ariaProperties.properties=axs.utils.values(statesAndProperties);if(0<Object.keys(ariaProperties).length)return ariaProperties;return null};axs.properties.getGlobalAriaProperties=function(element){var globalProperties={};for(var property in axs.constants.GLOBAL_PROPERTIES){if(element.hasAttribute(property)){var propertyValue=element.getAttribute(property);globalProperties[property]=axs.utils.getAriaPropertyValue(property,propertyValue,element)}}return globalProperties};axs.properties.getVideoProperties=function(element){var videoSelector="video";if(!axs.browserUtils.matchSelector(element,videoSelector))return null;var videoProperties={captionTracks:axs.properties.getTrackElements(element,"captions"),descriptionTracks:axs.properties.getTrackElements(element,"descriptions"),chapterTracks:axs.properties.getTrackElements(element,"chapters")};return videoProperties};axs.properties.getTrackElements=function(element,kind){var trackElements=element.querySelectorAll("track[kind="+kind+"]"),result={};if(!trackElements.length){result.valid=!1;result.reason={messageKey:"noTracksProvided",args:[[kind]]};return result}result.valid=!0;for(var values=[],i=0;i<trackElements.length;i++){var trackElement={},src=trackElements[i].getAttribute("src"),srcLang=trackElements[i].getAttribute("srcLang"),label=trackElements[i].getAttribute("label");if(!src){trackElement.valid=!1;trackElement.reason={messageKey:"noSrcProvided"}}else{trackElement.valid=!0;trackElement.src=src}var name="";if(label){name+=label;if(srcLang)name+=" "}if(srcLang)name+="("+srcLang+")";if(""==name)name="["+{messageKey:"unnamed"}+"]";trackElement.name=name;values.push(trackElement)}result.values=values;return result};axs.properties.getAllProperties=function(node){var element=axs.dom.asElement(node);if(!element)return{};var allProperties={ariaProperties:axs.properties.getAriaProperties(element),colorProperties:axs.properties.getColorProperties(element),focusProperties:axs.properties.getFocusProperties(element),textProperties:axs.properties.getTextProperties(node),videoProperties:axs.properties.getVideoProperties(element)};return allProperties};(function(){function getHtmlInfo(element){if(!element)return null;var tagName=element.tagName;if(!tagName)return null;tagName=tagName.toUpperCase();var infos=axs.constants.TAG_TO_IMPLICIT_SEMANTIC_INFO[tagName];if(!infos||!infos.length)return null;for(var defaultInfo=null,i=0,len=infos.length,htmlInfo;i<len;i++){htmlInfo=infos[i];if(htmlInfo.selector){if(axs.browserUtils.matchSelector(element,htmlInfo.selector))return htmlInfo}else{defaultInfo=htmlInfo}}return defaultInfo}axs.properties.getImplicitRole=function(element){var htmlInfo=getHtmlInfo(element);if(htmlInfo)return htmlInfo.role;return""};axs.properties.canTakeAriaAttributes=function(element){var htmlInfo=getHtmlInfo(element);if(htmlInfo)return!htmlInfo.reserved;return!0}})();axs.properties.getNativelySupportedAttributes=function(element){var result=[];if(!element){return result}for(var testElement=element.cloneNode(!1),ariaAttributes=Object.keys(axs.constants.ARIA_TO_HTML_ATTRIBUTE),i=0;i<ariaAttributes.length;i++){var ariaAttribute=ariaAttributes[i],nativeAttribute=axs.constants.ARIA_TO_HTML_ATTRIBUTE[ariaAttribute];if(nativeAttribute in testElement){result[result.length]=ariaAttribute}}return result};(function(){var roleToSelectorCache={};axs.properties.getSelectorForRole=function(role){if(!role)return"";if(roleToSelectorCache[role]&&roleToSelectorCache.hasOwnProperty(role))return roleToSelectorCache[role];var selectors=["[role=\""+role+"\"]"],tagNames=Object.keys(axs.constants.TAG_TO_IMPLICIT_SEMANTIC_INFO);tagNames.forEach(function(tagName){var htmlInfos=axs.constants.TAG_TO_IMPLICIT_SEMANTIC_INFO[tagName];if(htmlInfos&&htmlInfos.length){for(var i=0,htmlInfo;i<htmlInfos.length;i++){htmlInfo=htmlInfos[i];if(htmlInfo.role===role){if(htmlInfo.selector){selectors[selectors.length]=htmlInfo.selector}else{selectors[selectors.length]=tagName;break}}}}});return roleToSelectorCache[role]=selectors.join(",")}})();