goog.setTestOnly("goog.testing.MockClock");goog.provide("goog.testing.MockClock");goog.require("goog.Disposable");goog.require("goog.async.run");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.events");goog.require("goog.testing.events.Event");goog.testing.MockClock=function(opt_autoInstall){goog.Disposable.call(this);this.queue_=[];this.deletedKeys_={};if(opt_autoInstall){this.install()}};goog.inherits(goog.testing.MockClock,goog.Disposable);goog.testing.MockClock.REQUEST_ANIMATION_FRAME_TIMEOUT=20;goog.testing.MockClock.nextId=Math.round(1e4*Math.random());goog.testing.MockClock.prototype.timeoutsMade_=0;goog.testing.MockClock.prototype.callbacksTriggered_=0;goog.testing.MockClock.prototype.replacer_=null;goog.testing.MockClock.prototype.nowMillis_=0;goog.testing.MockClock.prototype.timeoutDelay_=0;goog.testing.MockClock.REAL_SETTIMEOUT_=goog.global.setTimeout;goog.testing.MockClock.prototype.install=function(){if(!this.replacer_){if(goog.testing.MockClock.REAL_SETTIMEOUT_!==goog.global.setTimeout){if("undefined"!==typeof console&&console.warn){console.warn("Non default setTimeout detected. "+"Use of multiple MockClock instances or other clock mocking "+"should be avoided due to unspecified behavior and "+"the resulting fragility.")}}var r=this.replacer_=new goog.testing.PropertyReplacer;r.set(goog.global,"setTimeout",goog.bind(this.setTimeout_,this));r.set(goog.global,"setInterval",goog.bind(this.setInterval_,this));r.set(goog.global,"setImmediate",goog.bind(this.setImmediate_,this));r.set(goog.global,"clearTimeout",goog.bind(this.clearTimeout_,this));r.set(goog.global,"clearInterval",goog.bind(this.clearInterval_,this));goog.async.run.forceNextTick&&goog.async.run.forceNextTick(goog.testing.MockClock.REAL_SETTIMEOUT_);this.replaceRequestAnimationFrame_();this.oldGoogNow_=goog.now;goog.now=goog.bind(this.getCurrentTime,this)}};goog.testing.MockClock.prototype.replaceRequestAnimationFrame_=function(){for(var r=this.replacer_,requestFuncs=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],cancelFuncs=["cancelAnimationFrame","cancelRequestAnimationFrame","webkitCancelRequestAnimationFrame","mozCancelRequestAnimationFrame","oCancelRequestAnimationFrame","msCancelRequestAnimationFrame"],i=0;i<requestFuncs.length;++i){if(goog.global&&goog.global[requestFuncs[i]]){r.set(goog.global,requestFuncs[i],goog.bind(this.requestAnimationFrame_,this))}}for(var i=0;i<cancelFuncs.length;++i){if(goog.global&&goog.global[cancelFuncs[i]]){r.set(goog.global,cancelFuncs[i],goog.bind(this.cancelRequestAnimationFrame_,this))}}};goog.testing.MockClock.prototype.uninstall=function(){if(this.replacer_){this.replacer_.reset();this.replacer_=null;goog.now=this.oldGoogNow_}this.resetAsyncQueue_()};goog.testing.MockClock.prototype.disposeInternal=function(){this.uninstall();this.queue_=null;this.deletedKeys_=null;goog.testing.MockClock.superClass_.disposeInternal.call(this)};goog.testing.MockClock.prototype.reset=function(){this.queue_=[];this.deletedKeys_={};this.nowMillis_=0;this.timeoutsMade_=0;this.callbacksTriggered_=0;this.timeoutDelay_=0;this.resetAsyncQueue_()};goog.testing.MockClock.prototype.resetAsyncQueue_=function(){goog.async.run.resetQueue()};goog.testing.MockClock.prototype.setTimeoutDelay=function(delay){this.timeoutDelay_=delay};goog.testing.MockClock.prototype.getTimeoutDelay=function(){return this.timeoutDelay_};goog.testing.MockClock.prototype.tick=function(opt_millis){if("number"!=typeof opt_millis){opt_millis=1}var endTime=this.nowMillis_+opt_millis;this.runFunctionsWithinRange_(endTime);this.nowMillis_=endTime;return endTime};goog.testing.MockClock.prototype.tickPromise=function(promise,opt_millis){var value,error,resolved=!1;promise.then(function(v){value=v;resolved=!0},function(e){error=e;resolved=!0});this.tick(opt_millis);if(!resolved){throw new Error("Promise was expected to be resolved after mock clock tick.")}if(error){throw error}return value};goog.testing.MockClock.prototype.getTimeoutsMade=function(){return this.timeoutsMade_};goog.testing.MockClock.prototype.getCallbacksTriggered=function(){return this.callbacksTriggered_};goog.testing.MockClock.prototype.getCurrentTime=function(){return this.nowMillis_};goog.testing.MockClock.prototype.isTimeoutSet=function(timeoutKey){return timeoutKey<goog.testing.MockClock.nextId&&timeoutKey>=goog.testing.MockClock.nextId-this.timeoutsMade_&&!this.deletedKeys_[timeoutKey]};goog.testing.MockClock.prototype.runFunctionsWithinRange_=function(endTime){var adjustedEndTime=endTime-this.timeoutDelay_;while(this.queue_&&this.queue_.length&&this.queue_[this.queue_.length-1].runAtMillis<=adjustedEndTime){var timeout=this.queue_.pop();if(!(timeout.timeoutKey in this.deletedKeys_)){this.nowMillis_=Math.max(this.nowMillis_,timeout.runAtMillis+this.timeoutDelay_);this.callbacksTriggered_++;timeout.funcToCall.call(goog.global,timeout.timeoutKey);if(timeout.recurring){this.scheduleFunction_(timeout.timeoutKey,timeout.funcToCall,timeout.millis,!0)}}}};goog.testing.MockClock.prototype.scheduleFunction_=function(timeoutKey,funcToCall,millis,recurring){if(!goog.isFunction(funcToCall)){throw new TypeError("The provided callback must be a function, not a "+typeof funcToCall)}var timeout={runAtMillis:this.nowMillis_+millis,funcToCall:funcToCall,recurring:recurring,timeoutKey:timeoutKey,millis:millis};goog.testing.MockClock.insert_(timeout,this.queue_)};goog.testing.MockClock.insert_=function(timeout,queue){for(var i=queue.length;0!=i;i--){if(queue[i-1].runAtMillis>timeout.runAtMillis){break}queue[i]=queue[i-1]}queue[i]=timeout};goog.testing.MockClock.MAX_INT_=2147483647;goog.testing.MockClock.prototype.setTimeout_=function(funcToCall,opt_millis){var millis=opt_millis||0;if(millis>goog.testing.MockClock.MAX_INT_){throw Error("Bad timeout value: "+millis+".  Timeouts over MAX_INT "+"(24.8 days) cause timeouts to be fired "+"immediately in most browsers, except for IE.")}this.timeoutsMade_++;this.scheduleFunction_(goog.testing.MockClock.nextId,funcToCall,millis,!1);return goog.testing.MockClock.nextId++};goog.testing.MockClock.prototype.setInterval_=function(funcToCall,opt_millis){var millis=opt_millis||0;this.timeoutsMade_++;this.scheduleFunction_(goog.testing.MockClock.nextId,funcToCall,millis,!0);return goog.testing.MockClock.nextId++};goog.testing.MockClock.prototype.requestAnimationFrame_=function(funcToCall){return this.setTimeout_(goog.bind(function(){if(funcToCall){funcToCall(this.getCurrentTime())}else if(goog.global.mozRequestAnimationFrame){var event=new goog.testing.events.Event("MozBeforePaint",goog.global);event.timeStamp=this.getCurrentTime();goog.testing.events.fireBrowserEvent(event)}},this),goog.testing.MockClock.REQUEST_ANIMATION_FRAME_TIMEOUT)};goog.testing.MockClock.prototype.setImmediate_=function(funcToCall){return this.setTimeout_(funcToCall,0)};goog.testing.MockClock.prototype.clearTimeout_=function(timeoutKey){if(this.isTimeoutSet(timeoutKey)){this.deletedKeys_[timeoutKey]=!0}};goog.testing.MockClock.prototype.clearInterval_=function(timeoutKey){this.clearTimeout_(timeoutKey)};goog.testing.MockClock.prototype.cancelRequestAnimationFrame_=function(timeoutKey){this.clearTimeout_(timeoutKey)};