goog.provide("goog.net.streams.XhrStreamReaderTest");goog.setTestOnly("goog.net.streams.XhrStreamReaderTest");goog.require("goog.net.ErrorCode");goog.require("goog.net.XmlHttp");goog.require("goog.net.streams.XhrStreamReader");goog.require("goog.object");goog.require("goog.testing.asserts");goog.require("goog.testing.jsunit");goog.require("goog.testing.net.XhrIo");var xhrReader,xhrIo,Status=goog.net.streams.XhrStreamReader.Status,ReadyState=goog.net.XmlHttp.ReadyState,CONTENT_TYPE_HEADER=goog.net.XhrIo.CONTENT_TYPE_HEADER,CONTENT_TRANSFER_ENCODING=goog.net.XhrIo.CONTENT_TRANSFER_ENCODING;function shouldRunTests(){return goog.net.streams.XhrStreamReader.isStreamingSupported()}function setUp(){xhrIo=new goog.testing.net.XhrIo;xhrReader=new goog.net.streams.XhrStreamReader(xhrIo)}function tearDown(){xhrIo=null;xhrReader=null}function testGetParserByResponseHeader(){xhrIo.getStreamingResponseHeader=function(){return null};assertNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(){return""};assertNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(){return"xxxxx"};assertNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(key){if(key==CONTENT_TYPE_HEADER)return"application/json";return null};assertNotNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(key){if(key==CONTENT_TYPE_HEADER)return"application/json; charset=utf-8";return null};assertNotNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(key){if(key==CONTENT_TYPE_HEADER)return"application/x-protobuf";return null};assertNotNull(xhrReader.getParserByResponseHeader_());xhrIo.getStreamingResponseHeader=function(key){if(key==CONTENT_TYPE_HEADER)return"application/x-protobuf";if(key==CONTENT_TRANSFER_ENCODING)return"BASE64";return null};assertNotNull(xhrReader.getParserByResponseHeader_())}function testNoData(){xhrReader.setDataHandler(function(messages){fail("Received unexpected messages: "+messages)});var streamStatus=[],httpStatus=[];xhrReader.setStatusHandler(function(){streamStatus.push(xhrReader.getStatus());httpStatus.push(xhrIo.getStatus())});var headers={"Content-Type":"application/json"};xhrIo.send("/foo/bar");xhrIo.simulateResponse(goog.net.HttpStatus.OK,"",headers);assertElementsEquals([Status.NO_DATA],streamStatus);assertElementsEquals([goog.net.HttpStatus.OK],httpStatus)}function testRetrieveHttpStatusInStatusHandler(){var received=[];xhrReader.setDataHandler(function(messages){received.push(messages)});var streamStatus=[],httpStatus=[];xhrReader.setStatusHandler(function(){console.log("in setStatusHandler");streamStatus.push(xhrReader.getStatus());httpStatus.push(xhrIo.getStatus())});var headers={"Content-Type":"application/json"};xhrIo.send("/foo/bar");xhrIo.simulateResponse(goog.net.HttpStatus.OK,"[{\"1\" : \"b\"}]",headers);assertEquals(1,received.length);assertEquals(1,received[0].length);assertElementsEquals(["1"],goog.object.getKeys(received[0][0]));assertElementsEquals("b",received[0][0][1]);assertElementsEquals([Status.ACTIVE,Status.SUCCESS],streamStatus);assertElementsEquals([goog.net.HttpStatus.OK,goog.net.HttpStatus.OK],httpStatus)}function testParsingSingleMessage(){var received=[];xhrReader.setDataHandler(function(messages){received.push(messages)});var body="CgX__gABdw==",headers={"Content-Type":"application/x-protobuf","Content-Transfer-Encoding":"BASE64"};xhrIo.send("/foo/bar");xhrIo.simulateResponse(goog.net.HttpStatus.OK,body,headers);assertEquals(1,received.length);assertEquals(1,received[0].length);assertElementsEquals(["1"],goog.object.getKeys(received[0][0]));assertElementsEquals([255,254,0,1,119],received[0][0][1])}function testParsingMultipleMessages(){var chunk1="CgNh",chunk2="YmMKA",chunk3="2RlZhIDZ2hpCg",chunk4="Nqa2w=",received=[];xhrReader.setDataHandler(function(messages){received.push(messages)});var headers={"Content-Type":"application/x-protobuf","Content-Transfer-Encoding":"BASE64"};xhrIo.send("/foo/bar");xhrIo.simulatePartialResponse(chunk1,headers);assertEquals(0,received.length);xhrIo.simulatePartialResponse(chunk2);assertEquals(1,received.length);assertEquals(1,received[0].length);assertElementsEquals(["1"],goog.object.getKeys(received[0][0]));assertElementsEquals([97,98,99],received[0][0][1]);received=[];xhrIo.simulatePartialResponse(chunk3);assertEquals(1,received.length);assertEquals(2,received[0].length);assertElementsEquals(["1"],goog.object.getKeys(received[0][0]));assertElementsEquals([100,101,102],received[0][0][1]);assertElementsEquals(["2"],goog.object.getKeys(received[0][1]));assertElementsEquals([103,104,105],received[0][1][2]);received=[];xhrIo.simulatePartialResponse(chunk4);assertEquals(1,received.length);assertEquals(1,received[0].length);assertElementsEquals(["1"],goog.object.getKeys(received[0][0]));assertElementsEquals([106,107,108],received[0][0][1]);xhrIo.simulateReadyStateChange(ReadyState.COMPLETE);assertEquals(Status.SUCCESS,xhrReader.getStatus())}function testXhrTimeout(){xhrIo.send("/test",null,"GET",null,null,1e3,!1);xhrIo.simulatePartialResponse("",{"Content-Type":"application/x-protobuf"});xhrIo.getLastErrorCode=function(){return goog.net.ErrorCode.TIMEOUT};xhrIo.simulateReadyStateChange(ReadyState.COMPLETE);assertEquals(Status.TIMEOUT,xhrReader.getStatus())}