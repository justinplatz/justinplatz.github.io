goog.provide("goog.net.NetworkTesterTest");goog.setTestOnly("goog.net.NetworkTesterTest");goog.require("goog.Uri");goog.require("goog.net.NetworkTester");goog.require("goog.testing.MockClock");goog.require("goog.testing.jsunit");var clock;function setUp(){clock=new goog.testing.MockClock(!0)}function tearDown(){clock.dispose()}function testSuccess(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onload.call(null);assertTrue(handler.dequeue());assertFalse(tester.isRunning())}function testFailure(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onerror.call(null);assertFalse(handler.dequeue());assertFalse(tester.isRunning())}function testAbort(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onabort.call(null);assertFalse(handler.dequeue());assertFalse(tester.isRunning())}function testTimeout(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());clock.tick(1e4);assertFalse(handler.dequeue());assertFalse(tester.isRunning())}function testRetries(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);tester.setNumRetries(1);assertEquals(tester.getAttemptCount(),0);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());assertEquals(tester.getAttemptCount(),1);var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onerror.call(null);assertTrue(handler.isEmpty());assertTrue(tester.isRunning());assertEquals(tester.getAttemptCount(),2);image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onload.call(null);assertTrue(handler.dequeue());assertFalse(tester.isRunning());assertEquals(tester.getAttemptCount(),2)}function testPauseBetweenRetries(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);tester.setNumRetries(1);tester.setPauseBetweenRetries(1e3);assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());var image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onerror.call(null);assertTrue(handler.isEmpty());assertTrue(tester.isRunning());assertNull(tester.image_);clock.tick(1e3);image=tester.image_;assertEquals(tester.getUri()+"",image.src);assertTrue(handler.isEmpty());image.onload.call(null);assertTrue(handler.dequeue());assertFalse(tester.isRunning())}function testNonDefaultUri(){var handler=new Handler,newUri=new goog.Uri("//www.google.com/images/cleardot2.gif"),tester=new goog.net.NetworkTester(handler.callback,handler,newUri),testerUri=tester.getUri();assertTrue(-1<testerUri.toString().indexOf("cleardot2"))}function testOffline(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler),orgGetNavigatorOffline=goog.net.NetworkTester.getNavigatorOffline_;goog.net.NetworkTester.getNavigatorOffline_=function(){return!0};try{assertFalse(tester.isRunning());tester.start();assertTrue(handler.isEmpty());assertTrue(tester.isRunning());clock.tick(1);assertFalse(handler.dequeue());assertFalse(tester.isRunning())}finally{goog.net.NetworkTester.getNavigatorOffline_=orgGetNavigatorOffline}}function Handler(){this.events_=[]}function testGetAttemptCount(){var handler=new Handler,tester=new goog.net.NetworkTester(handler.callback,handler);assertEquals(tester.getAttemptCount(),0);assertTrue(tester.attempt_===tester.getAttemptCount());assertFalse(tester.isRunning());tester.start();assertTrue(tester.isRunning());assertTrue(tester.attempt_===tester.getAttemptCount())}Handler.prototype.callback=function(result){this.events_.push(result)};Handler.prototype.isEmpty=function(){return 0==this.events_.length};Handler.prototype.dequeue=function(){if(this.isEmpty()){throw Error("Handler is empty")}return this.events_.shift()};function Image(){}