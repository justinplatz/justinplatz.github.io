goog.setTestOnly();goog.require("goog.array");goog.require("goog.html.SafeStyle");goog.require("goog.html.SafeUrl");goog.require("goog.html.sanitizer.CssSanitizer");goog.require("goog.string");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");goog.require("goog.userAgent.product");function isIE8(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(9)}function isSafari(){return goog.userAgent.product.SAFARI}function getStyleFromCssText(cssText){var styleDecleration=document.createElement("div").style;styleDecleration.cssText=cssText||"";return styleDecleration}function assertCSSTextEquals(expectedCssText,actualCssText){if(isIE8()){var actualCssArry=actualCssText.split(/\s*;\s*/),ie8StyleString="WIDTH: 0px; BOTTOM: 0px; HEIGHT: 0px; TOP: 0px; "+"RIGHT: 0px; TEXT-DECORATION: none underline overline line-through; "+"LEFT: 0px; TEXT-DECORATION: underline line-through;";goog.array.forEach(ie8StyleString.split(/\s*;\s*/),function(ie8Css){goog.array.remove(actualCssArry,ie8Css)});actualCssText=actualCssArry.join("; ")}assertEquals(getStyleFromCssText(expectedCssText).cssText,getStyleFromCssText(actualCssText).cssText)}function getSanitizedInlineStyle(sourceCss,opt_urlRewrite){try{return goog.html.SafeStyle.unwrap(goog.html.sanitizer.CssSanitizer.sanitizeInlineStyle(getStyleFromCssText(sourceCss),opt_urlRewrite))||""}catch(err){if(!isIE8()){throw err}return""}}function originalUrl(url){var sanitizedUrl=goog.html.SafeUrl.unwrap(goog.html.SafeUrl.sanitize(url));if(sanitizedUrl==goog.html.SafeUrl.INNOCUOUS_STRING){return null}return sanitizedUrl}function testValidCss(){var actualCSS="font-family: inherit",expectedCSS="font-family: inherit";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="padding: 1pt .1pt 1pt 1.0em";expectedCSS="padding: 1pt 0.1pt 1pt 1em";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="margin:    -7px -.5px -23px -1.25px";expectedCSS="margin: -7px -0.5px -23px -1.25px";if(isIE8()){expectedCSS=expectedCSS.replace("-1.25px","-1px")}assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="quotes: \"{\" \"}\" \"<\" \">\"";expectedCSS="quotes: \"{\" \"}\" \"<\" \">\";";if(isSafari()){expectedCSS="quotes: '{';"}assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS))}function testInvalidCssRemoved(){var actualCSS,expectedCSS="";actualCSS="font: Arial Black,monospace,Helvetica,#88ff88";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="border : -7px -0.5px -23px -1.25px";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="padding: -0 -.0 -0. -0.0 ";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="padding : #123 - 5 \"5\"";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="font-family: 7 .5 23 1.25 -7 -.5 -23 -1.25 +7 +.5 +23 +1.25 "+"7cm .5em 23.mm 1.25px -7cm -.5em -23.mm -1.25px "+"+7cm +.5em +23.mm +1.25px 0 .0 -0+00.0 /";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS));actualCSS="background: bogus url(\"foo.png\") transparent";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS,originalUrl));actualCSS="font-family: Arial Black,monospace,expression(return \"pwned\"),"+"Helvetica,#88ff88";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS))}function testCssBackground(){var actualCSS,expectedCSS;function proxyUrl(url){return"https://goo.gl/proxy?url="+url}actualCSS="background-image: url(\"javascript:evil(1337)\")";expectedCSS="";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS,originalUrl));actualCSS="background-image: url(\"http://goo.gl/foo.png\")";expectedCSS="background-image: url(https://goo.gl/proxy?url=http://goo.gl/foo.png)";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS,proxyUrl));actualCSS="background: transparent url(\"Bar.png\")";var sanitizedCss=getSanitizedInlineStyle(actualCSS);assertFalse(goog.string.contains(sanitizedCss,"background-image"));assertFalse(goog.string.contains(sanitizedCss,"Bar.png"))}function testVendorPrefixed(){var actualCSS="-webkit-text-stroke: calc(3px - 2px) red",expectedCSS="";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS))}function testColor(){for(var colors=["red","Red","RED","Gray","grey","#abc","#123","#ABC123","rgb( 127, 64 , 255 )"],notcolors=["killitwithfire","invisible","expression(red=blue)","#aa-1bb","#expression","#doevil"],i=0,validColorValue;i<colors.length;++i){validColorValue="color: "+colors[i];assertCSSTextEquals(validColorValue.toLowerCase(),getSanitizedInlineStyle(validColorValue))}for(var i=0,invalidColorValue;i<notcolors.length;++i){invalidColorValue="color: "+notcolors[i];assertCSSTextEquals("",getSanitizedInlineStyle(invalidColorValue))}}function testCustomVariablesSanitized(){var actualCSS="\\2d-leak: leakTest; background: var(--leak);";assertCSSTextEquals("",getSanitizedInlineStyle(actualCSS))}function testExpressionsPreserved(){if(isIE8()){return}var actualCSS,expectedCSS;actualCSS="background-image: linear-gradient(to bottom right, red, blue)";expectedCSS="background-image: linear-gradient(to right bottom, red, blue)";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS))}function testMultipleInlineStyles(){var actualCSS="margin: 1px ; padding: 0",expectedCSS="margin: 1px; padding: 0px;";assertCSSTextEquals(expectedCSS,getSanitizedInlineStyle(actualCSS))}function testSanitizeInlineStyleString(){for(var tests=[{inputCss:"",sanitizedCss:""},{inputCss:"color: red",sanitizedCss:"color: red;"},{inputCss:"color: green; padding: 10px",sanitizedCss:"color: green; padding: 10px;"},{inputCss:"color: expression(\"pwned\")",sanitizedCss:""},{inputCss:"background-image: url(\"http://example.com\")",sanitizedCss:""},{inputCss:"background-image: url(\"http://example.com\")",sanitizedCss:"",uriRewriter:function(uri){return null}},{inputCss:"background-image: url(\"http://example.com\")",sanitizedCss:"background-image: url(\"http://example.com\");",uriRewriter:function(uri){return uri}}],i=0;i<tests.length;i++){var test=tests[i],expectedOutput=test.sanitizedCss;if(goog.userAgent.IE&&10>document.documentMode){expectedOutput=""}var safeStyle=goog.html.sanitizer.CssSanitizer.sanitizeInlineStyleString(test.inputCss,test.uriRewriter),output=goog.html.SafeStyle.unwrap(safeStyle);assertCSSTextEquals(expectedOutput,output)}}function testInertDocument(){if(!document.implementation.createHTMLDocument){return}window.xssFiredInertDocument=!1;var doc=goog.html.sanitizer.CssSanitizer.createInertDocument_();try{doc.write("<script> window.xssFiredInertDocument = true; </script>")}catch(e){}assertFalse(window.xssFiredInertDocument)}function testInertCustomElements(){if("function"!=typeof HTMLTemplateElement||!document.registerElement){return}var inertDoc=goog.html.sanitizer.CssSanitizer.createInertDocument_(),xFooConstructor=document.registerElement("x-foo"),xFooElem=document.implementation.createHTMLDocument("").createElement("x-foo");assertTrue(xFooElem instanceof xFooConstructor);var inertXFooElem=inertDoc.createElement("x-foo");assertFalse(inertXFooElem instanceof xFooConstructor)}