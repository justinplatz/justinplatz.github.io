goog.provide("goog.editor.plugins.AbstractBubblePluginTest");goog.setTestOnly("goog.editor.plugins.AbstractBubblePluginTest");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.editor.plugins.AbstractBubblePlugin");goog.require("goog.events.BrowserEvent");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.functions");goog.require("goog.style");goog.require("goog.testing.editor.FieldMock");goog.require("goog.testing.editor.TestHelper");goog.require("goog.testing.events");goog.require("goog.testing.events.Event");goog.require("goog.testing.jsunit");goog.require("goog.ui.editor.Bubble");goog.require("goog.userAgent");var testHelper,fieldDiv,COMMAND="base",fieldMock,bubblePlugin,link,link2;function setUpPage(){fieldDiv=goog.dom.getElement("field");var viewportSize=goog.dom.getViewportSize();if(600>viewportSize.width||440>viewportSize.height){window.moveTo(0,0);window.resizeTo(640,480)}}function setUp(){testHelper=new goog.testing.editor.TestHelper(fieldDiv);testHelper.setUpEditableElement();fieldMock=new goog.testing.editor.FieldMock;bubblePlugin=new goog.editor.plugins.AbstractBubblePlugin(COMMAND);bubblePlugin.fieldObject=fieldMock;fieldDiv.innerHTML="<a href=\"http://www.google.com\">Google</a>"+"<a href=\"http://www.google.com\">Google2</a>";link=fieldDiv.firstChild;link2=fieldDiv.lastChild;window.scrollTo(0,0);goog.style.setStyle(document.body,"direction","ltr");goog.style.setStyle(document.getElementById("field"),"position","static")}function tearDown(){bubblePlugin.closeBubble();testHelper.tearDownEditableElement()}function prepareTargetWithGivenDirection(dir){goog.style.setStyle(document.body,"direction",dir);fieldDiv.style.direction=dir;fieldDiv.innerHTML="<a href=\"http://www.google.com\">Google</a>";link=fieldDiv.firstChild;fieldMock.$replay();bubblePlugin.createBubbleContents=function(bubbleContainer){bubbleContainer.innerHTML="<div style=\"border:1px solid blue;\">B</div>";goog.style.setStyle(bubbleContainer,"border","1px solid white")};bubblePlugin.registerFieldObject(fieldMock);bubblePlugin.enable(fieldMock);bubblePlugin.createBubble(link)}function resetFieldMock(){fieldMock=new goog.testing.editor.FieldMock;bubblePlugin.fieldObject=fieldMock}function helpTestCreateBubble(opt_fn){fieldMock.$replay();var numCalled=0;bubblePlugin.createBubbleContents=function(bubbleContainer){numCalled++;assertNotNull("bubbleContainer should not be null",bubbleContainer)};if(opt_fn){opt_fn()}bubblePlugin.createBubble(link);assertEquals("createBubbleContents should be called",1,numCalled);fieldMock.$verify()}function testCreateBubble(opt_fn){helpTestCreateBubble(opt_fn);assertTrue(bubblePlugin.getSharedBubble_()instanceof goog.ui.editor.Bubble);assertTrue("Bubble should be visible",bubblePlugin.isVisible())}function testOpeningBubbleCallsOnShow(){var numCalled=0;testCreateBubble(function(){bubblePlugin.onShow=function(){numCalled++}});assertEquals("onShow should be called",1,numCalled);fieldMock.$verify()}function testCloseBubble(){testCreateBubble();bubblePlugin.closeBubble();assertFalse("Bubble should not be visible",bubblePlugin.isVisible());fieldMock.$verify()}function testZindexBehavior(){fieldMock.$reset();fieldMock.getAppWindow().$anyTimes().$returns(window);fieldMock.getEditableDomHelper().$anyTimes().$returns(goog.dom.getDomHelper(document));fieldMock.getBaseZindex().$returns(2);bubblePlugin.createBubbleContents=goog.nullFunction;fieldMock.$replay();bubblePlugin.createBubble(link);assertEquals("2",""+bubblePlugin.getSharedBubble_().bubbleContainer_.style.zIndex);fieldMock.$verify()}function testNoTwoBubblesOpenAtSameTime(){fieldMock.$replay();var origClose=goog.bind(bubblePlugin.closeBubble,bubblePlugin),numTimesCloseCalled=0;bubblePlugin.closeBubble=function(){numTimesCloseCalled++;origClose()};bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;bubblePlugin.createBubbleContents=goog.nullFunction;bubblePlugin.handleSelectionChangeInternal(link);assertEquals(0,numTimesCloseCalled);assertEquals(link,bubblePlugin.targetElement_);fieldMock.$verify();bubblePlugin.handleSelectionChangeInternal(link2);assertEquals(1,numTimesCloseCalled);assertEquals(link2,bubblePlugin.targetElement_);fieldMock.$verify()}function testHandleSelectionChangeWithEvent(){fieldMock.$replay();var fakeEvent=new goog.events.BrowserEvent({type:"mouseup",target:link});bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;bubblePlugin.createBubbleContents=goog.nullFunction;bubblePlugin.handleSelectionChange(fakeEvent);assertTrue("Bubble should have been opened",bubblePlugin.isVisible());assertEquals("Bubble target should be provided event's target",link,bubblePlugin.targetElement_)}function testHandleSelectionChangeWithTarget(){fieldMock.$replay();bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;bubblePlugin.createBubbleContents=goog.nullFunction;bubblePlugin.handleSelectionChange(void 0,link2);assertTrue("Bubble should have been opened",bubblePlugin.isVisible());assertEquals("Bubble target should be provided target",link2,bubblePlugin.targetElement_)}function testSelectOneTextCharacterNoError(){fieldMock.$replay();bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;bubblePlugin.createBubbleContents=goog.nullFunction;testHelper.select(link.firstChild,0,link.firstChild,1);bubblePlugin.handleSelectionChange();assertTrue("Bubble should have been opened",bubblePlugin.isVisible());fieldMock.$verify()}function testTabKeyEvents(){fieldMock.$replay();bubblePlugin.enableKeyboardNavigation(!0);bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;var nonTabbable1,tabbable1,tabbable2,nonTabbable2;bubblePlugin.createBubbleContents=function(container){nonTabbable1=goog.dom.createDom(goog.dom.TagName.DIV);tabbable1=goog.dom.createDom(goog.dom.TagName.DIV);tabbable2=goog.dom.createDom(goog.dom.TagName.DIV);nonTabbable2=goog.dom.createDom(goog.dom.TagName.DIV);goog.dom.append(container,nonTabbable1,tabbable1,tabbable2,nonTabbable2);bubblePlugin.setTabbable(tabbable1);bubblePlugin.setTabbable(tabbable2)};bubblePlugin.handleSelectionChangeInternal(link);assertTrue("Bubble should be visible",bubblePlugin.isVisible());var tabHandledByBubble=simulateTabKeyOnBubble();assertTrue("The action should be handled by the plugin",tabHandledByBubble);assertFocused(tabbable1);goog.testing.events.fireKeySequence(tabbable1,goog.events.KeyCodes.TAB);fieldMock.$verify();resetFieldMock();fieldMock.focus();fieldMock.$replay();goog.testing.events.fireKeySequence(tabbable2,goog.events.KeyCodes.TAB);fieldMock.$verify()}function testTabKeyEventsWithShiftKey(){fieldMock.$replay();bubblePlugin.enableKeyboardNavigation(!0);bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;var nonTabbable,tabbable1,tabbable2;bubblePlugin.createBubbleContents=function(container){nonTabbable=goog.dom.createDom(goog.dom.TagName.DIV);tabbable1=goog.dom.createDom(goog.dom.TagName.DIV);tabbable2=goog.dom.createDom(goog.dom.TagName.DIV);goog.dom.append(container,nonTabbable,tabbable1,tabbable2);bubblePlugin.setTabbable(tabbable1);bubblePlugin.setTabbable(tabbable2)};bubblePlugin.handleSelectionChangeInternal(link);assertTrue("Bubble should be visible",bubblePlugin.isVisible());var tabHandledByBubble=simulateTabKeyOnBubble();assertTrue("The action should be handled by the plugin",tabHandledByBubble);assertFocused(tabbable1);fieldMock.$verify();resetFieldMock();fieldMock.focus();fieldMock.$replay();goog.testing.events.fireKeySequence(tabbable1,goog.events.KeyCodes.TAB,{shiftKey:!0});fieldMock.$verify()}function testLinksAreTabbable(){fieldMock.$replay();bubblePlugin.enableKeyboardNavigation(!0);bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;var nonTabbable1,link1,link2,nonTabbable2;bubblePlugin.createBubbleContents=function(container){nonTabbable1=goog.dom.createDom(goog.dom.TagName.DIV);goog.dom.appendChild(container,nonTabbable1);bubbleLink1=this.createLink("linkInBubble1","Foo",!1,container);bubbleLink2=this.createLink("linkInBubble2","Bar",!1,container);nonTabbable2=goog.dom.createDom(goog.dom.TagName.DIV);goog.dom.appendChild(container,nonTabbable2)};bubblePlugin.handleSelectionChangeInternal(link);assertTrue("Bubble should be visible",bubblePlugin.isVisible());var tabHandledByBubble=simulateTabKeyOnBubble();assertTrue("The action should be handled by the plugin",tabHandledByBubble);assertFocused(bubbleLink1);fieldMock.$verify();resetFieldMock();fieldMock.focus();fieldMock.$replay();goog.testing.events.fireKeySequence(bubbleLink2,goog.events.KeyCodes.TAB);fieldMock.$verify()}function testTabKeyNoEffectKeyboardNavDisabled(){fieldMock.$replay();bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;var bubbleLink;bubblePlugin.createBubbleContents=function(container){bubbleLink=this.createLink("linkInBubble","Foo",!1,container)};bubblePlugin.handleSelectionChangeInternal(link);assertTrue("Bubble should be visible",bubblePlugin.isVisible());var tabHandledByBubble=simulateTabKeyOnBubble();assertFalse("The action should not be handled by the plugin",tabHandledByBubble);assertNotFocused(bubbleLink);goog.testing.events.fireKeySequence(bubbleLink,goog.events.KeyCodes.TAB);fieldMock.$verify()}function testOtherKeyEventNoEffectKeyboardNavEnabled(){fieldMock.$replay();bubblePlugin.enableKeyboardNavigation(!0);bubblePlugin.getBubbleTargetFromSelection=goog.functions.identity;var bubbleLink;bubblePlugin.createBubbleContents=function(container){bubbleLink=this.createLink("linkInBubble","Foo",!1,container)};bubblePlugin.handleSelectionChangeInternal(link);assertTrue("Bubble should be visible",bubblePlugin.isVisible());var keyHandledByBubble=simulateKeyDownOnBubble(goog.events.KeyCodes.B,!0);assertFalse("The action should not be handled by the plugin",keyHandledByBubble);assertNotFocused(bubbleLink);fieldMock.$verify()}function testSetTabbableSetsTabIndex(){var element1=goog.dom.createDom(goog.dom.TagName.DIV),element2=goog.dom.createDom(goog.dom.TagName.DIV);element1.setAttribute("tabIndex","1");bubblePlugin.setTabbable(element1);bubblePlugin.setTabbable(element2);assertEquals("1",element1.getAttribute("tabIndex"));assertEquals("0",element2.getAttribute("tabIndex"))}function testDisable(){testCreateBubble();fieldMock.setUneditable(!0);bubblePlugin.disable(fieldMock);bubblePlugin.closeBubble()}function simulateTabKeyOnBubble(){return simulateKeyDownOnBubble(goog.events.KeyCodes.TAB,!1)}function simulateKeyDownOnBubble(keyCode,isCtrl){bubblePlugin.getSharedBubble_().getContentElement().ownerDocument.designMode="off";var event=new goog.testing.events.Event(goog.events.EventType.KEYDOWN,null);event.keyCode=keyCode;event.ctrlKey=isCtrl;return bubblePlugin.handleKeyDown(event)}function assertFocused(element){if(goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(8)){return}assertEquals("unexpected focus",element,document.activeElement)}function assertNotFocused(element){assertNotEquals("unexpected focus",element,document.activeElement)}