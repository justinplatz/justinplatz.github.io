goog.provide("goog.html.safeHtmlTest");goog.require("goog.html.SafeHtml");goog.require("goog.html.SafeScript");goog.require("goog.html.SafeStyle");goog.require("goog.html.SafeStyleSheet");goog.require("goog.html.SafeUrl");goog.require("goog.html.TrustedResourceUrl");goog.require("goog.html.testing");goog.require("goog.i18n.bidi.Dir");goog.require("goog.labs.userAgent.browser");goog.require("goog.object");goog.require("goog.string.Const");goog.require("goog.testing.jsunit");goog.setTestOnly("goog.html.safeHtmlTest");function testSafeHtml(){var safeHtml=goog.html.testing.newSafeHtmlForTest("Hello <em>World</em>");assertSameHtml("Hello <em>World</em>",safeHtml);assertEquals("Hello <em>World</em>",goog.html.SafeHtml.unwrap(safeHtml));assertEquals("SafeHtml{Hello <em>World</em>}",safeHtml+"");assertNull(safeHtml.getDirection());safeHtml=goog.html.testing.newSafeHtmlForTest("World <em>Hello</em>",goog.i18n.bidi.Dir.RTL);assertSameHtml("World <em>Hello</em>",safeHtml);assertEquals("World <em>Hello</em>",goog.html.SafeHtml.unwrap(safeHtml));assertEquals("SafeHtml{World <em>Hello</em>}",safeHtml+"");assertEquals(goog.i18n.bidi.Dir.RTL,safeHtml.getDirection());assertTrue(safeHtml.implementsGoogStringTypedString);assertTrue(safeHtml.implementsGoogI18nBidiDirectionalString);assertSameHtml("",goog.html.SafeHtml.EMPTY);assertSameHtml("<br>",goog.html.SafeHtml.BR)}function testUnwrap(){var privateFieldName="privateDoNotAccessOrElseSafeHtmlWrappedValue_",markerFieldName="SAFE_HTML_TYPE_MARKER_GOOG_HTML_SECURITY_PRIVATE_",propNames=goog.object.getKeys(goog.html.SafeHtml.htmlEscape(""));assertContains(privateFieldName,propNames);assertContains(markerFieldName,propNames);var evil={};evil[privateFieldName]="<script>evil()</script";evil[markerFieldName]={};var exception=assertThrows(function(){goog.html.SafeHtml.unwrap(evil)});assertContains("expected object of type SafeHtml",exception.message)}function testHtmlEscape(){var safeHtmlIn=goog.html.SafeHtml.htmlEscape("<b>in</b>");assertTrue(safeHtmlIn===goog.html.SafeHtml.htmlEscape(safeHtmlIn));var safeHtml=goog.html.SafeHtml.htmlEscape("Hello <em>\"'&World</em>");assertSameHtml("Hello &lt;em&gt;&quot;&#39;&amp;World&lt;/em&gt;",safeHtml);assertEquals("SafeHtml{Hello &lt;em&gt;&quot;&#39;&amp;World&lt;/em&gt;}",safeHtml+"");var safeUrl=goog.html.SafeUrl.fromConstant(goog.string.Const.from("http://example.com/?foo&bar")),escapedUrl=goog.html.SafeHtml.htmlEscape(safeUrl);assertSameHtml("http://example.com/?foo&amp;bar",escapedUrl);assertEquals(goog.i18n.bidi.Dir.LTR,escapedUrl.getDirection());assertSameHtml("this &amp; that",goog.html.SafeHtml.htmlEscape(goog.string.Const.from("this & that")))}function testSafeHtmlCreate(){var br=goog.html.SafeHtml.create("br");assertSameHtml("<br>",br);assertSameHtml("<span title=\"&quot;\"></span>",goog.html.SafeHtml.create("span",{title:"\""}));assertSameHtml("<span>&lt;</span>",goog.html.SafeHtml.create("span",{},"<"));assertSameHtml("<span><br></span>",goog.html.SafeHtml.create("span",{},br));assertSameHtml("<span></span>",goog.html.SafeHtml.create("span",{},[]));assertSameHtml("<span></span>",goog.html.SafeHtml.create("span",{title:null,class:void 0}));assertSameHtml("<span>x<br>y</span>",goog.html.SafeHtml.create("span",{},["x",br,"y"]));assertSameHtml("<table border=\"0\"></table>",goog.html.SafeHtml.create("table",{border:0}));var onclick=goog.string.Const.from("alert(/\"/)");assertSameHtml("<span onclick=\"alert(/&quot;/)\"></span>",goog.html.SafeHtml.create("span",{onclick:onclick}));var href=goog.html.testing.newSafeUrlForTest("?a&b");assertSameHtml("<a href=\"?a&amp;b\"></a>",goog.html.SafeHtml.create("a",{href:href}));var style=goog.html.testing.newSafeStyleForTest("border: /* \" */ 0;");assertSameHtml("<hr style=\"border: /* &quot; */ 0;\">",goog.html.SafeHtml.create("hr",{style:style}));assertEquals(goog.i18n.bidi.Dir.NEUTRAL,goog.html.SafeHtml.create("span").getDirection());assertNull(goog.html.SafeHtml.create("span",{dir:"x"}).getDirection());assertEquals(goog.i18n.bidi.Dir.NEUTRAL,goog.html.SafeHtml.create("span",{dir:"ltr"},"a").getDirection());assertThrows(function(){goog.html.SafeHtml.create("script")});assertThrows(function(){goog.html.SafeHtml.create("br",{},"x")});assertThrows(function(){goog.html.SafeHtml.create("img",{onerror:""})});assertThrows(function(){goog.html.SafeHtml.create("img",{OnError:""})});assertThrows(function(){goog.html.SafeHtml.create("a href=\"\"")});assertThrows(function(){goog.html.SafeHtml.create("a",{'title="" href':""})});assertThrows(function(){goog.html.SafeHtml.create("applet")});assertThrows(function(){goog.html.SafeHtml.create("applet",{code:"kittens.class"})});assertThrows(function(){goog.html.SafeHtml.create("base")});assertThrows(function(){goog.html.SafeHtml.create("base",{href:"http://example.org"})});assertThrows(function(){goog.html.SafeHtml.create("math")});assertThrows(function(){goog.html.SafeHtml.create("meta")});assertThrows(function(){goog.html.SafeHtml.create("svg")})}function testSafeHtmlCreate_styleAttribute(){var style="color:red;",expected="<hr style=\""+style+"\">";assertThrows(function(){goog.html.SafeHtml.create("hr",{style:style})});assertSameHtml(expected,goog.html.SafeHtml.create("hr",{style:goog.html.SafeStyle.fromConstant(goog.string.Const.from(style))}));assertSameHtml(expected,goog.html.SafeHtml.create("hr",{style:{color:"red"}}))}function testSafeHtmlCreate_urlAttributes(){var trustedResourceUrl=goog.html.TrustedResourceUrl.fromConstant(goog.string.Const.from("https://google.com/trusted"));assertSameHtml("<img src=\"https://google.com/trusted\">",goog.html.SafeHtml.create("img",{src:trustedResourceUrl}));var safeUrl=goog.html.SafeUrl.sanitize("https://google.com/safe");assertSameHtml("<imG src=\"https://google.com/safe\">",goog.html.SafeHtml.create("imG",{src:safeUrl}));var constUrl=goog.string.Const.from("https://google.com/const");assertSameHtml("<a href=\"https://google.com/const\"></a>",goog.html.SafeHtml.create("a",{href:constUrl}));assertSameHtml("<a href=\"http://google.com/safe&quot;\"></a>",goog.html.SafeHtml.create("a",{href:"http://google.com/safe\""}));var badUrl="javascript:evil();",sanitizedUrl=goog.html.SafeUrl.unwrap(goog.html.SafeUrl.sanitize(badUrl));assertTrue("string"==typeof sanitizedUrl);assertNotEquals(badUrl,sanitizedUrl);assertSameHtml("<a href=\""+sanitizedUrl+"\"></a>",goog.html.SafeHtml.create("a",{href:badUrl}));assertSameHtml("<a hReF=\""+sanitizedUrl+"\"></a>",goog.html.SafeHtml.create("a",{hReF:badUrl}))}function testSafeHtmlCreateIframe(){var url=goog.html.TrustedResourceUrl.fromConstant(goog.string.Const.from("https://google.com/trusted<"));assertSameHtml("<iframe src=\"https://google.com/trusted&lt;\"></iframe>",goog.html.SafeHtml.createIframe(url,null,{sandbox:null}));var srcdoc=goog.html.SafeHtml.BR;assertSameHtml("<iframe srcdoc=\"&lt;br&gt;\"></iframe>",goog.html.SafeHtml.createIframe(null,srcdoc,{sandbox:null}));assertSameHtml("<iframe sandbox=\"\"></iframe>",goog.html.SafeHtml.createIframe());assertSameHtml("<iframe Sandbox=\"allow-same-origin allow-top-navigation\"></iframe>",goog.html.SafeHtml.createIframe(null,null,{Sandbox:"allow-same-origin allow-top-navigation"}));assertThrows(function(){goog.html.SafeHtml.createIframe(null,null,{Src:url})});assertThrows(function(){goog.html.SafeHtml.createIframe(null,null,{Srcdoc:url})});assertThrows(function(){goog.html.SafeHtml.createIframe("http://example.com")});assertThrows(function(){goog.html.SafeHtml.createIframe(null,"<script>alert(1)</script>")});assertSameHtml("<iframe>&lt;</iframe>",goog.html.SafeHtml.createIframe(null,null,{sandbox:null},"<"))}function testSafeHtmlcreateSandboxIframe(){function assertSameHtmlIfSupportsSandbox(referenceHtml,testedHtmlFunction){if(!goog.html.SafeHtml.canUseSandboxIframe()){assertThrows(testedHtmlFunction)}else{assertSameHtml(referenceHtml,testedHtmlFunction())}}var url=goog.html.SafeUrl.fromConstant(goog.string.Const.from("https://google.com/trusted<"));assertSameHtmlIfSupportsSandbox("<iframe src=\"https://google.com/trusted&lt;\" sandbox=\"\"></iframe>",function(){return goog.html.SafeHtml.createSandboxIframe(url,null)});assertSameHtmlIfSupportsSandbox("<iframe src=\""+goog.html.SafeUrl.INNOCUOUS_STRING+"\" sandbox=\"\"></iframe>",function(){return goog.html.SafeHtml.createSandboxIframe("javascript:evil();",null)});var srcdoc="<br>";assertSameHtmlIfSupportsSandbox("<iframe srcdoc=\"&lt;br&gt;\" sandbox=\"\"></iframe>",function(){return goog.html.SafeHtml.createSandboxIframe(null,srcdoc)});assertThrows(function(){goog.html.SafeHtml.createSandboxIframe(null,null,{Src:url})});assertThrows(function(){goog.html.SafeHtml.createSandboxIframe(null,null,{Srcdoc:url})});assertSameHtmlIfSupportsSandbox("<iframe sandbox=\"\"></iframe>",function(){return goog.html.SafeHtml.createSandboxIframe()});assertThrows(function(){goog.html.SafeHtml.createSandboxIframe(null,null,{sandbox:""})});assertThrows(function(){goog.html.SafeHtml.createSandboxIframe(null,null,{SaNdBoX:"allow-scripts"})});assertThrows(function(){goog.html.SafeHtml.createSandboxIframe(null,null,{sandbox:"allow-same-origin allow-top-navigation"})});assertSameHtmlIfSupportsSandbox("<iframe sandbox=\"\">&lt;</iframe>",function(){return goog.html.SafeHtml.createSandboxIframe(null,null,null,"<")})}function testSafeHtmlCanUseIframeSandbox(){if(goog.labs.userAgent.browser.isIE()&&10>goog.labs.userAgent.browser.getVersion()){assertEquals(!1,goog.html.SafeHtml.canUseSandboxIframe())}else{assertEquals(!0,goog.html.SafeHtml.canUseSandboxIframe())}}function testSafeHtmlCreateScript(){var script=goog.html.SafeScript.fromConstant(goog.string.Const.from("function1();")),scriptHtml=goog.html.SafeHtml.createScript(script);assertSameHtml("<script>function1();</script>",scriptHtml);var otherScript=goog.html.SafeScript.fromConstant(goog.string.Const.from("function2();"));scriptHtml=goog.html.SafeHtml.createScript([script,otherScript]);assertSameHtml("<script>function1();function2();</script>",scriptHtml);scriptHtml=goog.html.SafeHtml.createScript(script,{id:"test"});assertContains("id=\"test\"",goog.html.SafeHtml.unwrap(scriptHtml));scriptHtml=goog.html.SafeHtml.createScript(goog.html.SafeScript.EMPTY,{id:null});assertSameHtml("<script></script>",scriptHtml);var exception=assertThrows(function(){goog.html.SafeHtml.createScript(goog.html.SafeScript.EMPTY,{"invalid.":"cantdothis"})});assertContains("Invalid attribute name",exception.message);exception=assertThrows(function(){goog.html.SafeHtml.createScript(goog.html.SafeScript.EMPTY,{Type:"cantdothis"})});assertContains("Cannot set \"type\"",exception.message);exception=assertThrows(function(){goog.html.SafeHtml.createScript(goog.html.SafeScript.EMPTY,{src:"cantdothis"})});assertContains("Cannot set \"src\"",exception.message);assertEquals(goog.i18n.bidi.Dir.NEUTRAL,scriptHtml.getDirection())}function testSafeHtmlCreateScriptSrc(){var url=goog.html.TrustedResourceUrl.fromConstant(goog.string.Const.from("https://google.com/trusted<"));assertSameHtml("<script src=\"https://google.com/trusted&lt;\"></script>",goog.html.SafeHtml.createScriptSrc(url));assertSameHtml("<script src=\"https://google.com/trusted&lt;\" defer=\"defer\"></script>",goog.html.SafeHtml.createScriptSrc(url,{defer:"defer"}));assertThrows(function(){goog.html.SafeHtml.createScriptSrc("http://example.com")});assertThrows(function(){goog.html.SafeHtml.createScriptSrc(url,{onerror:"alert(1)"})});assertThrows(function(){goog.html.SafeHtml.createScriptSrc(url,{Src:url})})}function testSafeHtmlCreateMeta(){var url=goog.html.SafeUrl.fromConstant(goog.string.Const.from("https://google.com/trusted<"));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"0; url=https://google.com/trusted&lt;\">",goog.html.SafeHtml.createMetaRefresh(url));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"0; url=https://google.com/trusted&lt;\">",goog.html.SafeHtml.createMetaRefresh(url,0));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"1337; url=https://google.com/trusted&lt;\">",goog.html.SafeHtml.createMetaRefresh(url,1337));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"-1337; url=https://google.com/trusted&lt;\">",goog.html.SafeHtml.createMetaRefresh(url,-1337));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"0; url=https://google.com/trusted&lt;\">",goog.html.SafeHtml.createMetaRefresh("https://google.com/trusted<"));assertSameHtml("<meta http-equiv=\"refresh\" "+"content=\"0; url=about:invalid#zClosurez\">",goog.html.SafeHtml.createMetaRefresh("javascript:alert(1)"))}function testSafeHtmlCreateStyle(){var styleSheet=goog.html.SafeStyleSheet.fromConstant(goog.string.Const.from("P.special { color:\"red\" ; }")),styleHtml=goog.html.SafeHtml.createStyle(styleSheet);assertSameHtml("<style type=\"text/css\">P.special { color:\"red\" ; }</style>",styleHtml);var otherStyleSheet=goog.html.SafeStyleSheet.fromConstant(goog.string.Const.from("P.regular { color:blue ; }"));styleHtml=goog.html.SafeHtml.createStyle([styleSheet,otherStyleSheet]);assertSameHtml("<style type=\"text/css\">P.special { color:\"red\" ; }"+"P.regular { color:blue ; }</style>",styleHtml);styleHtml=goog.html.SafeHtml.createStyle(styleSheet,{id:"test"});var styleHtmlString=goog.html.SafeHtml.unwrap(styleHtml);assertContains("id=\"test\"",styleHtmlString);assertContains("type=\"text/css\"",styleHtmlString);styleHtml=goog.html.SafeHtml.createStyle(goog.html.SafeStyleSheet.EMPTY,{id:null});assertSameHtml("<style type=\"text/css\"></style>",styleHtml);var exception=assertThrows(function(){goog.html.SafeHtml.createStyle(goog.html.SafeStyleSheet.EMPTY,{"invalid.":"cantdothis"})});assertContains("Invalid attribute name",exception.message);exception=assertThrows(function(){goog.html.SafeHtml.createStyle(goog.html.SafeStyleSheet.EMPTY,{Type:"cantdothis"})});assertContains("Cannot override \"type\"",exception.message);assertEquals(goog.i18n.bidi.Dir.NEUTRAL,styleHtml.getDirection())}function testSafeHtmlCreateWithDir(){var ltr=goog.i18n.bidi.Dir.LTR;assertEquals(ltr,goog.html.SafeHtml.createWithDir(ltr,"br").getDirection())}function testSafeHtmlConcat(){var br=goog.html.testing.newSafeHtmlForTest("<br>"),html=goog.html.SafeHtml.htmlEscape("Hello");assertSameHtml("Hello<br>",goog.html.SafeHtml.concat(html,br));assertSameHtml("",goog.html.SafeHtml.concat());assertSameHtml("",goog.html.SafeHtml.concat([]));assertSameHtml("a<br>c",goog.html.SafeHtml.concat("a",br,"c"));assertSameHtml("a<br>c",goog.html.SafeHtml.concat(["a",br,"c"]));assertSameHtml("a<br>c",goog.html.SafeHtml.concat("a",[br,"c"]));assertSameHtml("a<br>c",goog.html.SafeHtml.concat(["a"],br,["c"]));var ltr=goog.html.testing.newSafeHtmlForTest("",goog.i18n.bidi.Dir.LTR),rtl=goog.html.testing.newSafeHtmlForTest("",goog.i18n.bidi.Dir.RTL),neutral=goog.html.testing.newSafeHtmlForTest("",goog.i18n.bidi.Dir.NEUTRAL),unknown=goog.html.testing.newSafeHtmlForTest("");assertEquals(goog.i18n.bidi.Dir.NEUTRAL,goog.html.SafeHtml.concat().getDirection());assertEquals(goog.i18n.bidi.Dir.LTR,goog.html.SafeHtml.concat(ltr,ltr).getDirection());assertEquals(goog.i18n.bidi.Dir.LTR,goog.html.SafeHtml.concat(ltr,neutral,ltr).getDirection());assertNull(goog.html.SafeHtml.concat(ltr,unknown).getDirection());assertNull(goog.html.SafeHtml.concat(ltr,rtl).getDirection());assertNull(goog.html.SafeHtml.concat(ltr,[rtl]).getDirection())}function testHtmlEscapePreservingNewlines(){var safeHtmlIn=goog.html.SafeHtml.htmlEscapePreservingNewlines("<b>in</b>");assertTrue(safeHtmlIn===goog.html.SafeHtml.htmlEscapePreservingNewlines(safeHtmlIn));assertSameHtml("a<br>c",goog.html.SafeHtml.htmlEscapePreservingNewlines("a\nc"));assertSameHtml("&lt;<br>",goog.html.SafeHtml.htmlEscapePreservingNewlines("<\n"));assertSameHtml("<br>",goog.html.SafeHtml.htmlEscapePreservingNewlines("\r\n"));assertSameHtml("<br>",goog.html.SafeHtml.htmlEscapePreservingNewlines("\r"));assertSameHtml("",goog.html.SafeHtml.htmlEscapePreservingNewlines(""))}function testHtmlEscapePreservingNewlinesAndSpaces(){var safeHtmlIn=goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("<b>in</b>");assertTrue(safeHtmlIn===goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces(safeHtmlIn));assertSameHtml("a<br>c",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("a\nc"));assertSameHtml("&lt;<br>",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("<\n"));assertSameHtml("<br>",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("\r\n"));assertSameHtml("<br>",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("\r"));assertSameHtml("",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces(""));assertSameHtml("a &#160;b",goog.html.SafeHtml.htmlEscapePreservingNewlinesAndSpaces("a  b"))}function testSafeHtmlConcatWithDir(){var ltr=goog.i18n.bidi.Dir.LTR,rtl=goog.i18n.bidi.Dir.RTL,br=goog.html.testing.newSafeHtmlForTest("<br>");assertEquals(ltr,goog.html.SafeHtml.concatWithDir(ltr).getDirection());assertEquals(ltr,goog.html.SafeHtml.concatWithDir(ltr,goog.html.testing.newSafeHtmlForTest("",rtl)).getDirection());assertSameHtml("a<br>c",goog.html.SafeHtml.concatWithDir(ltr,"a",br,"c"))}function assertSameHtml(expected,html){assertEquals(expected,goog.html.SafeHtml.unwrap(html))}