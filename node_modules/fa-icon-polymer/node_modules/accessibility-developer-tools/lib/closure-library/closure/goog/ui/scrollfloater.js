goog.provide("goog.ui.ScrollFloater");goog.provide("goog.ui.ScrollFloater.EventType");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.dom.classlist");goog.require("goog.events.EventType");goog.require("goog.style");goog.require("goog.ui.Component");goog.require("goog.userAgent");goog.ui.ScrollFloater=function(opt_parentElement,opt_domHelper){var domHelper=opt_parentElement?goog.dom.getDomHelper(opt_parentElement):opt_domHelper;goog.ui.ScrollFloater.base(this,"constructor",domHelper);this.parentElement_=opt_parentElement||this.getDomHelper().getDocument().body;this.originalStyles_={};this.viewportTopOffset_=0;this.containerElement_=null;this.containerBounds_=null;this.originalBounds_=null;this.originalTopOffset_=0;this.originalLeftOffset_=0;this.placeholder_=null;this.scrollingEnabled_=!0;this.pinned_=!1;this.floating_=!1};goog.inherits(goog.ui.ScrollFloater,goog.ui.Component);goog.ui.ScrollFloater.EventType={FLOAT:"float",DOCK:"dock",PIN:"pin"};goog.ui.ScrollFloater.FloatMode_={TOP:0,BOTTOM:1};goog.ui.ScrollFloater.STORED_STYLE_PROPS_=["position","top","left","width","cssFloat"];goog.ui.ScrollFloater.PLACEHOLDER_STYLE_PROPS_=["position","top","left","display","cssFloat","marginTop","marginLeft","marginRight","marginBottom"];goog.ui.ScrollFloater.CSS_CLASS_=goog.getCssName("goog-scrollfloater");goog.ui.ScrollFloater.prototype.createDom=function(){goog.ui.ScrollFloater.base(this,"createDom");this.decorateInternal(this.getElement())};goog.ui.ScrollFloater.prototype.decorateInternal=function(element){goog.ui.ScrollFloater.base(this,"decorateInternal",element);goog.asserts.assert(element);goog.dom.classlist.add(element,goog.ui.ScrollFloater.CSS_CLASS_)};goog.ui.ScrollFloater.prototype.enterDocument=function(){goog.ui.ScrollFloater.base(this,"enterDocument");if(!this.placeholder_){this.placeholder_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{style:"visibility:hidden"})}this.update();this.setScrollingEnabled(this.scrollingEnabled_);var win=this.getDomHelper().getWindow();this.getHandler().listen(win,goog.events.EventType.SCROLL,this.handleScroll_).listen(win,goog.events.EventType.RESIZE,this.update)};goog.ui.ScrollFloater.prototype.update=function(){if(!this.isInDocument()){return}this.dock_();if(this.containerElement_){this.containerBounds_=goog.style.getBounds(this.containerElement_)}var pageOffset_=goog.style.getPageOffset(this.getElement());this.originalBounds_=goog.style.getBounds(this.getElement());this.originalTopOffset_=pageOffset_.y;this.originalLeftOffset_=pageOffset_.x;this.handleScroll_()};goog.ui.ScrollFloater.prototype.disposeInternal=function(){goog.ui.ScrollFloater.base(this,"disposeInternal");this.placeholder_=null};goog.ui.ScrollFloater.prototype.setScrollingEnabled=function(enable){this.scrollingEnabled_=enable;if(enable){this.applyIeBgHack_();this.handleScroll_()}else{this.dock_()}};goog.ui.ScrollFloater.prototype.isScrollingEnabled=function(){return this.scrollingEnabled_};goog.ui.ScrollFloater.prototype.isFloating=function(){return this.floating_};goog.ui.ScrollFloater.prototype.isPinned=function(){return this.pinned_};goog.ui.ScrollFloater.prototype.setViewportTopOffset=function(offset){this.viewportTopOffset_=offset;this.update()};goog.ui.ScrollFloater.prototype.setContainerElement=function(container){this.containerElement_=container;this.update()};goog.ui.ScrollFloater.prototype.handleScroll_=function(opt_e){if(this.scrollingEnabled_){var scrollTop=this.getDomHelper().getDocumentScroll().y;if(this.originalBounds_.top-scrollTop>=this.viewportTopOffset_){this.dock_();return}var effectiveElementHeight=this.originalBounds_.height+this.viewportTopOffset_;if(this.containerElement_){var containerBottom=this.containerBounds_.top+this.containerBounds_.height;if(scrollTop>containerBottom-effectiveElementHeight){this.pin_();return}}var windowHeight=this.getDomHelper().getViewportSize().height;if(this.needsIePositionHack_()||effectiveElementHeight<windowHeight){this.float_(goog.ui.ScrollFloater.FloatMode_.TOP);return}if(this.originalBounds_.height+this.originalTopOffset_>windowHeight+scrollTop){this.dock_()}else{this.float_(goog.ui.ScrollFloater.FloatMode_.BOTTOM)}}};goog.ui.ScrollFloater.prototype.pin_=function(){if(this.floating_&&!this.dock_()){return}if(this.pinned_||!this.dispatchEvent(goog.ui.ScrollFloater.EventType.PIN)){return}var elem=this.getElement();this.storeOriginalStyles_();elem.style.position="relative";elem.style.top=this.containerBounds_.height-this.originalBounds_.height-this.originalBounds_.top+this.containerBounds_.top+"px";this.pinned_=!0};goog.ui.ScrollFloater.prototype.float_=function(floatMode){var isTop=floatMode==goog.ui.ScrollFloater.FloatMode_.TOP;if(this.pinned_&&!this.dock_()){return}if(!this.dispatchEvent(goog.ui.ScrollFloater.EventType.FLOAT)){return}var newWindowLeftOffset_=goog.dom.getDocumentScroll().x;if(this.floating_){this.updateFloatingLeftPosition_();return}var elem=this.getElement(),originalLeft_=goog.style.getPageOffsetLeft(elem),originalWidth_=goog.style.getContentBoxSize(elem).width;this.storeOriginalStyles_();goog.style.setSize(this.placeholder_,elem.offsetWidth,elem.offsetHeight);goog.style.setStyle(elem,{left:originalLeft_-newWindowLeftOffset_+"px",width:originalWidth_+"px",cssFloat:"none"});if(elem.parentNode==this.parentElement_){elem.parentNode.insertBefore(this.placeholder_,elem)}else{elem.parentNode.replaceChild(this.placeholder_,elem);this.parentElement_.appendChild(elem)}if(this.needsIePositionHack_()){elem.style.position="absolute";elem.style.setExpression("top","document.compatMode==\"CSS1Compat\"?"+"documentElement.scrollTop:document.body.scrollTop")}else{elem.style.position="fixed";if(isTop){elem.style.top=this.viewportTopOffset_+"px";elem.style.bottom="auto"}else{elem.style.top="auto";elem.style.bottom="0"}}this.floating_=!0};goog.ui.ScrollFloater.prototype.dock_=function(){if(!(this.floating_||this.pinned_)||!this.dispatchEvent(goog.ui.ScrollFloater.EventType.DOCK)){return!1}var elem=this.getElement();if(this.floating_){this.restoreOriginalStyles_();if(this.needsIePositionHack_()){elem.style.removeExpression("top")}if(this.placeholder_.parentNode==this.parentElement_){this.placeholder_.parentNode.removeChild(this.placeholder_)}else{this.placeholder_.parentNode.replaceChild(elem,this.placeholder_)}}if(this.pinned_){this.restoreOriginalStyles_()}this.floating_=this.pinned_=!1;return!0};goog.ui.ScrollFloater.prototype.updateFloatingLeftPosition_=function(){goog.asserts.assert(this.floating_);var newWindowLeftOffset_=goog.dom.getDocumentScroll().x;goog.style.setStyle(this.getElement(),{left:this.originalLeftOffset_-newWindowLeftOffset_+"px"})};goog.ui.ScrollFloater.prototype.storeOriginalStyles_=function(){var elem=this.getElement();this.originalStyles_={};goog.array.forEach(goog.ui.ScrollFloater.STORED_STYLE_PROPS_,function(property){this.originalStyles_[property]=elem.style[property]},this);goog.array.forEach(goog.ui.ScrollFloater.PLACEHOLDER_STYLE_PROPS_,function(property){this.placeholder_.style[property]=elem.style[property]||goog.style.getCascadedStyle(elem,property)||goog.style.getComputedStyle(elem,property)},this)};goog.ui.ScrollFloater.prototype.restoreOriginalStyles_=function(){var elem=this.getElement();for(var prop in this.originalStyles_){elem.style[prop]=this.originalStyles_[prop]}};goog.ui.ScrollFloater.prototype.needsIePositionHack_=function(){return goog.userAgent.IE&&!(goog.userAgent.isVersionOrHigher("7")&&this.getDomHelper().isCss1CompatMode())};goog.ui.ScrollFloater.prototype.applyIeBgHack_=function(){if(this.needsIePositionHack_()){var doc=this.getDomHelper().getDocument(),topLevelElement=goog.style.getClientViewportElement(doc);if("none"==topLevelElement.currentStyle.backgroundImage){topLevelElement.style.backgroundImage="https:"==this.getDomHelper().getWindow().location.protocol?"url(https:///)":"url(about:blank)";topLevelElement.style.backgroundAttachment="fixed"}}};