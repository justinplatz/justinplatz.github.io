goog.provide("goog.db.ObjectStore");goog.require("goog.async.Deferred");goog.require("goog.db.Cursor");goog.require("goog.db.Error");goog.require("goog.db.Index");goog.require("goog.debug");goog.require("goog.events");goog.db.ObjectStore=function(store){this.store_=store};goog.db.ObjectStore.prototype.getName=function(){return this.store_.name};goog.db.ObjectStore.prototype.insert_=function(fn,msg,value,opt_key){var d=new goog.async.Deferred,request;try{if(opt_key){request=this.store_[fn](value,opt_key)}else{request=this.store_[fn](value)}}catch(ex){msg+=goog.debug.deepExpose(value);if(opt_key){msg+=", with key "+goog.debug.deepExpose(opt_key)}d.errback(goog.db.Error.fromException(ex,msg));return d}request.onsuccess=function(ev){d.callback()};request.onerror=function(ev){msg+=goog.debug.deepExpose(value);if(opt_key){msg+=", with key "+goog.debug.deepExpose(opt_key)}d.errback(goog.db.Error.fromRequest(ev.target,msg))};return d};goog.db.ObjectStore.prototype.put=function(value,opt_key){return this.insert_("put","putting into "+this.getName()+" with value",value,opt_key)};goog.db.ObjectStore.prototype.add=function(value,opt_key){return this.insert_("add","adding into "+this.getName()+" with value ",value,opt_key)};goog.db.ObjectStore.prototype.remove=function(key){var d=new goog.async.Deferred,request;try{request=this.store_["delete"](key)}catch(err){var msg="removing from "+this.getName()+" with key "+goog.debug.deepExpose(key);d.errback(goog.db.Error.fromException(err,msg));return d}request.onsuccess=function(ev){d.callback()};var self=this;request.onerror=function(ev){var msg="removing from "+self.getName()+" with key "+goog.debug.deepExpose(key);d.errback(goog.db.Error.fromRequest(ev.target,msg))};return d};goog.db.ObjectStore.prototype.get=function(key){var d=new goog.async.Deferred,request;try{request=this.store_.get(key)}catch(err){var msg="getting from "+this.getName()+" with key "+goog.debug.deepExpose(key);d.errback(goog.db.Error.fromException(err,msg));return d}request.onsuccess=function(ev){d.callback(ev.target.result)};var self=this;request.onerror=function(ev){var msg="getting from "+self.getName()+" with key "+goog.debug.deepExpose(key);d.errback(goog.db.Error.fromRequest(ev.target,msg))};return d};goog.db.ObjectStore.prototype.getAll=function(opt_range,opt_direction){var d=new goog.async.Deferred,cursor;try{cursor=this.openCursor(opt_range,opt_direction)}catch(err){d.errback(err);return d}var result=[],key=goog.events.listen(cursor,goog.db.Cursor.EventType.NEW_DATA,function(){result.push(cursor.getValue());cursor.next()});goog.events.listenOnce(cursor,[goog.db.Cursor.EventType.ERROR,goog.db.Cursor.EventType.COMPLETE],function(evt){cursor.dispose();if(evt.type==goog.db.Cursor.EventType.COMPLETE){d.callback(result)}else{d.errback()}});return d};goog.db.ObjectStore.prototype.openCursor=function(opt_range,opt_direction){return goog.db.Cursor.openCursor(this.store_,opt_range,opt_direction)};goog.db.ObjectStore.prototype.clear=function(){var msg="clearing store "+this.getName(),d=new goog.async.Deferred,request;try{request=this.store_.clear()}catch(err){d.errback(goog.db.Error.fromException(err,msg));return d}request.onsuccess=function(ev){d.callback()};request.onerror=function(ev){d.errback(goog.db.Error.fromRequest(ev.target,msg))};return d};goog.db.ObjectStore.prototype.createIndex=function(name,keyPath,opt_parameters){try{return new goog.db.Index(this.store_.createIndex(name,keyPath,opt_parameters))}catch(ex){var msg="creating new index "+name+" with key path "+keyPath;throw goog.db.Error.fromException(ex,msg)}};goog.db.ObjectStore.prototype.getIndex=function(name){try{return new goog.db.Index(this.store_.index(name))}catch(ex){var msg="getting index "+name;throw goog.db.Error.fromException(ex,msg)}};goog.db.ObjectStore.prototype.deleteIndex=function(name){try{this.store_.deleteIndex(name)}catch(ex){var msg="deleting index "+name;throw goog.db.Error.fromException(ex,msg)}};goog.db.ObjectStore.prototype.count=function(opt_range){var d=new goog.async.Deferred;try{var range=opt_range?opt_range.range():null,request=this.store_.count(range);request.onsuccess=function(ev){d.callback(ev.target.result)};var self=this;request.onerror=function(ev){d.errback(goog.db.Error.fromRequest(ev.target,self.getName()))}}catch(ex){d.errback(goog.db.Error.fromException(ex,this.getName()))}return d};