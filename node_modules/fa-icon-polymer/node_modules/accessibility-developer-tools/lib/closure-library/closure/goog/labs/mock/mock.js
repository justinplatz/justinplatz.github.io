goog.provide("goog.labs.mock");goog.provide("goog.labs.mock.VerificationError");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.debug");goog.require("goog.debug.Error");goog.require("goog.functions");goog.require("goog.labs.mock.verification");goog.require("goog.labs.mock.verification.VerificationMode");goog.require("goog.object");goog.setTestOnly("goog.labs.mock");goog.labs.mock.mock=function(objectOrClass){var mockObjectManager=new goog.labs.mock.MockObjectManager_(objectOrClass),mockedObject=mockObjectManager.getMockedItem();goog.asserts.assertObject(mockedObject);return mockedObject};goog.labs.mock.mockFunction=function(func){var mockFuncManager=new goog.labs.mock.MockFunctionManager_(func),mockedFunction=mockFuncManager.getMockedItem();goog.asserts.assertFunction(mockedFunction);return mockedFunction};goog.labs.mock.mockConstructor=function(ctor){var mockCtor=goog.labs.mock.mockFunction(ctor);for(var property in ctor){if("superClass_"!=property&&"prototype"!=property&&ctor.hasOwnProperty(property)){mockCtor[property]=ctor[property]}}return mockCtor};goog.labs.mock.spy=function(obj){var mockSpyManager=new goog.labs.mock.MockSpyManager_(obj),spyObject=mockSpyManager.getMockedItem();goog.asserts.assert(spyObject);return spyObject};goog.labs.mock.verify=function(obj,opt_verificationMode){var mode=opt_verificationMode||goog.labs.mock.verification.atLeast(1);obj.$verificationModeSetter(mode);return obj.$callVerifier};goog.labs.mock.getFunctionName_=function(func){var funcName=goog.debug.getFunctionName(func);if(""==funcName||"[Anonymous]"==funcName){funcName="#anonymous"+goog.labs.mock.getUid(func)}return funcName};goog.labs.mock.formatMethodCall_=function(methodName,opt_args){opt_args=opt_args||[];opt_args=goog.array.map(opt_args,function(arg){if(goog.isFunction(arg)){var funcName=goog.labs.mock.getFunctionName_(arg);return"<function "+funcName+">"}else{var isObjectWithClass=goog.isObject(arg)&&!goog.isFunction(arg)&&!goog.isArray(arg)&&arg.constructor!=Object;if(isObjectWithClass){return arg.toString()}return goog.labs.mock.formatValue_(arg)}});return methodName+"("+opt_args.join(", ")+")"};goog.labs.mock.uid_=[];goog.labs.mock.getUid=function(obj){var index=goog.array.indexOf(goog.labs.mock.uid_,obj);if(-1==index){index=goog.labs.mock.uid_.length;goog.labs.mock.uid_.push(obj)}return index};goog.labs.mock.formatValue_=function(obj,opt_id){var id=goog.isDef(opt_id)?opt_id:!0,previous=[],output=[],helper=function(obj){var indentMultiline=function(output){return output.replace(/\n/g,"\n")};try{if(!goog.isDef(obj)){output.push("undefined")}else if(goog.isNull(obj)){output.push("NULL")}else if(goog.isString(obj)){output.push("\""+indentMultiline(obj)+"\"")}else if(goog.isFunction(obj)){var funcName=goog.labs.mock.getFunctionName_(obj);output.push("<function "+funcName+">")}else if(goog.isObject(obj)){if(goog.array.contains(previous,obj)){if(id){output.push("<recursive/dupe obj_"+goog.labs.mock.getUid(obj)+">")}else{output.push("<recursive/dupe>")}}else{previous.push(obj);output.push("{");var inner_obj=[];for(var x in obj){output.push(" ");output.push("\""+x+"\""+":");helper(obj[x])}if(id){output.push(" _id:"+goog.labs.mock.getUid(obj))}output.push("}")}}else{output.push(obj)}}catch(e){output.push("*** "+e+" ***")}};helper(obj);return output.join("").replace(/"closure_uid_\d+"/g,"_id").replace(/{ /g,"{")};goog.labs.mock.VerificationError=function(recordedCalls,methodName,verificationMode,args){var msg=goog.labs.mock.VerificationError.getVerificationErrorMsg_(recordedCalls,methodName,verificationMode,args);goog.labs.mock.VerificationError.base(this,"constructor",msg)};goog.inherits(goog.labs.mock.VerificationError,goog.debug.Error);goog.labs.mock.VerificationError.prototype.name="VerificationError";goog.labs.mock.PROTOTYPE_FIELDS_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"];goog.labs.mock.VerificationError.getVerificationErrorMsg_=function(recordedCalls,methodName,verificationMode,args){recordedCalls=goog.array.filter(recordedCalls,function(binding){return binding.getMethodName()==methodName});var expected=goog.labs.mock.formatMethodCall_(methodName,args),msg="\nExpected: "+expected.toString()+" "+verificationMode.describe();msg+="\nRecorded: ";if(0<recordedCalls.length){msg+=recordedCalls.join(",\n          ")}else{msg+="No recorded calls"}return msg};goog.labs.mock.MockManager_=function(){this.mockedItem={};this.mockee=null;this.methodBindings=[];this.$stubBinder=null;this.callRecords_=[];this.verificationMode_=goog.labs.mock.verification.atLeast(1)};goog.labs.mock.MockManager_.prototype.setVerificationMode_=function(verificationMode){this.verificationMode_=verificationMode};goog.labs.mock.MockManager_.prototype.handleMockCall_=function(methodName,var_args){var args=goog.array.slice(arguments,1);return new goog.labs.mock.StubBinderImpl_(this,methodName,args)};goog.labs.mock.MockManager_.prototype.getMockedItem=function(){return this.mockedItem};goog.labs.mock.MockManager_.prototype.addBinding=function(methodName,args,func){var binding=new goog.labs.mock.MethodBinding_(methodName,args,func),sequentialStubsArray=[binding];goog.array.insertAt(this.methodBindings,sequentialStubsArray,0);return sequentialStubsArray};goog.labs.mock.MockManager_.prototype.getNextBinding=function(methodName,args){var bindings=goog.array.find(this.methodBindings,function(bindingArray){return bindingArray[0].matches(methodName,args,!1)});if(null==bindings){return null}if(1<bindings.length){return bindings.shift().getStub()}return bindings[0].getStub()};goog.labs.mock.MockManager_.prototype.getExecutor=function(methodName,args){return this.getNextBinding(methodName,args)};goog.labs.mock.MockManager_.prototype.executeStub=function(methodName,var_args){var args=goog.array.slice(arguments,1);this.recordCall_(methodName,args);var func=this.getExecutor(methodName,args);if(func){return func.apply(null,args)}};goog.labs.mock.MockManager_.prototype.recordCall_=function(methodName,args){var callRecord=new goog.labs.mock.MethodBinding_(methodName,args,goog.nullFunction);this.callRecords_.push(callRecord)};goog.labs.mock.MockManager_.prototype.verifyInvocation=function(methodName,var_args){var args=goog.array.slice(arguments,1),count=goog.array.count(this.callRecords_,function(binding){return binding.matches(methodName,args,!0)});if(!this.verificationMode_.verify(count)){throw new goog.labs.mock.VerificationError(this.callRecords_,methodName,this.verificationMode_,args)}};goog.labs.mock.MockObjectManager_=function(objOrClass){goog.labs.mock.MockObjectManager_.base(this,"constructor");this.objectStubBinder_={};this.mockee=objOrClass;this.objectCallVerifier_={};var obj;if(goog.isFunction(objOrClass)){var tempCtor=function(){};goog.inherits(tempCtor,objOrClass);obj=new tempCtor}else{obj=objOrClass}var mockedItemCtor=function(){};mockedItemCtor.prototype=obj;this.mockedItem=new mockedItemCtor;for(var enumerableProperties=goog.object.getAllPropertyNames(obj),i=0,prop;i<goog.labs.mock.PROTOTYPE_FIELDS_.length;i++){prop=goog.labs.mock.PROTOTYPE_FIELDS_[i];if(!goog.array.contains(enumerableProperties,prop)){enumerableProperties.push(prop)}}for(var i=0,prop;i<enumerableProperties.length;i++){prop=enumerableProperties[i];if(goog.isFunction(obj[prop])){this.mockedItem[prop]=goog.bind(this.executeStub,this,prop);this.objectStubBinder_[prop]=goog.bind(this.handleMockCall_,this,prop);this.objectCallVerifier_[prop]=goog.bind(this.verifyInvocation,this,prop)}}this.mockedItem.$stubBinder=this.objectStubBinder_;this.mockedItem.$callVerifier=this.objectCallVerifier_;this.mockedItem.$verificationModeSetter=goog.bind(this.setVerificationMode_,this)};goog.inherits(goog.labs.mock.MockObjectManager_,goog.labs.mock.MockManager_);goog.labs.mock.MockSpyManager_=function(obj){goog.labs.mock.MockSpyManager_.base(this,"constructor",obj)};goog.inherits(goog.labs.mock.MockSpyManager_,goog.labs.mock.MockObjectManager_);goog.labs.mock.MockSpyManager_.prototype.getNextBinding=function(methodName,args){var stub=goog.labs.mock.MockSpyManager_.base(this,"getNextBinding",methodName,args);if(!stub){stub=goog.bind(this.mockee[methodName],this.mockee)}return stub};goog.labs.mock.MockFunctionManager_=function(func){goog.labs.mock.MockFunctionManager_.base(this,"constructor");this.func_=func;this.functionStubBinder_=this.useMockedFunctionName_(this.handleMockCall_);this.mockedItem=this.useMockedFunctionName_(this.executeStub);this.mockedItem.$stubBinder=this.functionStubBinder_;this.mockedItem.$callVerifier=this.useMockedFunctionName_(this.verifyInvocation);this.mockedItem.$verificationModeSetter=goog.bind(this.setVerificationMode_,this)};goog.inherits(goog.labs.mock.MockFunctionManager_,goog.labs.mock.MockManager_);goog.labs.mock.MockFunctionManager_.prototype.useMockedFunctionName_=function(nextFunc){var mockFunctionManager=this;return function(var_args){var args=goog.array.clone(arguments),name="#mockFor<"+goog.labs.mock.getFunctionName_(mockFunctionManager.func_)+">";goog.array.insertAt(args,name,0);return nextFunc.apply(mockFunctionManager,args)}};goog.labs.mock.StubBinder=function(){};goog.labs.mock.StubBinder.prototype.then=goog.abstractMethod;goog.labs.mock.StubBinder.prototype.thenReturn=goog.abstractMethod;goog.labs.mock.StubBinderImpl_=function(mockManager,name,args){this.mockManager_=mockManager;this.name_=name;this.args_=args;this.sequentialStubsArray_=[]};goog.labs.mock.StubBinderImpl_.prototype.then=function(func){if(this.sequentialStubsArray_.length){this.sequentialStubsArray_.push(new goog.labs.mock.MethodBinding_(this.name_,this.args_,func))}else{this.sequentialStubsArray_=this.mockManager_.addBinding(this.name_,this.args_,func)}return this};goog.labs.mock.StubBinderImpl_.prototype.thenReturn=function(value){return this.then(goog.functions.constant(value))};goog.labs.mock.when=function(mockObject){goog.asserts.assert(mockObject.$stubBinder,"Stub binder cannot be null!");return mockObject.$stubBinder};goog.labs.mock.MethodBinding_=function(methodName,args,stub){this.methodName_=methodName;this.args_=args;this.stub_=stub};goog.labs.mock.MethodBinding_.prototype.getStub=function(){return this.stub_};goog.labs.mock.MethodBinding_.prototype.toString=function(){return goog.labs.mock.formatMethodCall_(this.methodName_||"",this.args_)};goog.labs.mock.MethodBinding_.prototype.getMethodName=function(){return this.methodName_||""};goog.labs.mock.MethodBinding_.prototype.matches=function(methodName,args,isVerification){var specs=isVerification?args:this.args_,calls=isVerification?this.args_:args;return this.methodName_==methodName&&goog.array.equals(calls,specs,function(arg,spec){if(spec&&goog.isFunction(spec.matches)){return spec.matches(arg)}else{return goog.array.defaultCompareEquality(spec,arg)}})};