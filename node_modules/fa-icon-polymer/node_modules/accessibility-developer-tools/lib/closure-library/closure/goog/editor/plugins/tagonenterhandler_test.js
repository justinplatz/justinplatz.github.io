goog.provide("goog.editor.plugins.TagOnEnterHandlerTest");goog.setTestOnly("goog.editor.plugins.TagOnEnterHandlerTest");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.BrowserFeature");goog.require("goog.editor.Field");goog.require("goog.editor.Plugin");goog.require("goog.editor.plugins.TagOnEnterHandler");goog.require("goog.events.KeyCodes");goog.require("goog.string.Unicode");goog.require("goog.testing.dom");goog.require("goog.testing.editor.TestHelper");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var savedHtml,editor,field1;function setUp(){field1=makeField("field1");field1.makeEditable()}function testDeleteBrBeforeBlock(){if(goog.userAgent.GECKO){field1.setHtml(!1,"one<br><br><div>two</div>");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select(field1.getElement(),2);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted exactly one <br>","one<br><div>two</div>",field1.getElement().innerHTML)}}function testDeleteBrNormal(){if(goog.userAgent.GECKO){field1.setHtml(!1,"one<br><br><br>two");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select(field1.getElement(),2);field1.getElement().focus();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted exactly one <br>","one<br><br>two",field1.getElement().innerHTML)}}function testEnterCreatesBlankLine(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<p>one <br></p>");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select("one ",3);field1.getElement().focus();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var range=field1.getRange();assertFalse("Selection should not be in BR tag",range.getStartNode().nodeType==goog.dom.NodeType.ELEMENT&&range.getStartNode().tagName==goog.dom.TagName.BR);assertEquals("Selection should be in text node to avoid creating adjacent"+" text nodes",goog.dom.NodeType.TEXT,range.getStartNode().nodeType);var rangeStartNode=goog.dom.Range.createFromNodeContents(range.getStartNode());assertHTMLEquals("The value of selected text node should be replaced with"+"&nbsp;","&nbsp;",rangeStartNode.getHtmlFragment())}}function testEnterNormalizeNodes(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<p>one<br></p>");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select("one",3);field1.getElement().focus();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var range=field1.getRange();assertTrue("Selection should be in P tag",range.getStartNode().nodeType==goog.dom.NodeType.ELEMENT&&range.getStartNode().tagName==goog.dom.TagName.P);assertTrue("Selection should be at the head and collapsed",0==range.getStartOffset()&&range.isCollapsed())}}function testEnterAtBeginningOfLink(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<a href=\"/\">b<br></a>");var helper=new goog.testing.editor.TestHelper(field1.getElement());field1.focusAndPlaceCursorAtStart();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<p>&nbsp;</p><p><a href=\"/\">b<br></a></p>")}}function testEnterInEmptyListItemInEmptyList(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul><li>&nbsp;</li></ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[0];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<p>&nbsp;</p>")}}function testEnterInEmptyListItemAtBeginningOfList(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul style=\"font-weight: bold\">"+"<li>&nbsp;</li>"+"<li>1</li>"+"<li>2</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[0];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<p>&nbsp;</p><ul style=\"font-weight: bold\"><li>1</li><li>2</li></ul>")}}function testEnterInEmptyListItemAtEndOfList(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul style=\"font-weight: bold\">"+"<li>1</li>"+"<li>2</li>"+"<li>&nbsp;</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[2];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<ul style=\"font-weight: bold\"><li>1</li><li>2</li></ul><p>&nbsp;</p>")}}function testEnterInEmptyListItemInMiddleOfList(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul style=\"font-weight: bold\">"+"<li>1</li>"+"<li>&nbsp;</li>"+"<li>2</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[1];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<ul style=\"font-weight: bold\"><li>1</li></ul>"+"<p>&nbsp;</p>"+"<ul style=\"font-weight: bold\"><li>2</li></ul>")}}function testEnterInEmptyListItemInSublist(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul>"+"<li>A</li>"+"<ul style=\"font-weight: bold\">"+"<li>1</li>"+"<li>&nbsp;</li>"+"<li>2</li>"+"</ul>"+"<li>B</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[2];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<ul>"+"<li>A</li>"+"<ul style=\"font-weight: bold\"><li>1</li></ul>"+"<li>&nbsp;</li>"+"<ul style=\"font-weight: bold\"><li>2</li></ul>"+"<li>B</li>"+"</ul>")}}function testEnterInEmptyListItemAtBeginningOfSublist(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul>"+"<li>A</li>"+"<ul style=\"font-weight: bold\">"+"<li>&nbsp;</li>"+"<li>1</li>"+"<li>2</li>"+"</ul>"+"<li>B</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[1];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<ul>"+"<li>A</li>"+"<li>&nbsp;</li>"+"<ul style=\"font-weight: bold\"><li>1</li><li>2</li></ul>"+"<li>B</li>"+"</ul>")}}function testEnterInEmptyListItemAtEndOfSublist(){if(goog.userAgent.GECKO){field1.setHtml(!1,"<ul>"+"<li>A</li>"+"<ul style=\"font-weight: bold\">"+"<li>1</li>"+"<li>2</li>"+"<li>&nbsp;</li>"+"</ul>"+"<li>B</li>"+"</ul>");var helper=new goog.testing.editor.TestHelper(field1.getElement()),li=goog.dom.getElementsByTagName(goog.dom.TagName.LI,field1.getElement())[3];helper.select(li.firstChild,0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);helper.assertHtmlMatches("<ul>"+"<li>A</li>"+"<ul style=\"font-weight: bold\"><li>1</li><li>2</li></ul>"+"<li>&nbsp;</li>"+"<li>B</li>"+"</ul>")}}function testPrepareContentForPOnEnter(){assertPreparedContents("hi","hi");assertPreparedContents(goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES?"<p>&nbsp;</p>":"","   ")}function testPrepareContentForDivOnEnter(){assertPreparedContents("hi","hi",goog.dom.TagName.DIV);assertPreparedContents(goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES?"<div><br></div>":"","   ",goog.dom.TagName.DIV)}function assertPreparedContents(expected,original,opt_tag){var field=makeField("field1",opt_tag);field.makeEditable();assertEquals(expected,field.reduceOp_(goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML,original))}function selectNodeAndHitEnter(field,id){var cursor=field.getEditableDomHelper().getElement(id);goog.dom.Range.createFromNodeContents(cursor).select();return goog.testing.events.fireKeySequence(cursor,goog.events.KeyCodes.ENTER)}function makeField(id,opt_tag){var field=new goog.editor.Field(id);field.registerPlugin(new goog.editor.plugins.TagOnEnterHandler(opt_tag||goog.dom.TagName.P));return field}function helpTestSplit_(offset,firstHalfString,secondHalfString,isAppend,opt_goToBody){var node=goog.dom.createElement(goog.dom.TagName.DIV);node.innerHTML="<b>begin bold<i>italic</i>end bold</b>";document.body.appendChild(node);var italic=goog.dom.getElementsByTagName(goog.dom.TagName.I,node)[0].firstChild,splitFn=isAppend?goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_:goog.editor.plugins.TagOnEnterHandler.splitDom_,secondHalf=splitFn(italic,offset,opt_goToBody?void 0:node);if(opt_goToBody){secondHalfString="<div>"+secondHalfString+"</div>"}assertEquals("original node should have first half of the html",firstHalfString,node.innerHTML.toLowerCase().replace(goog.string.Unicode.NBSP,"&nbsp;"));assertEquals("new node should have second half of the html",secondHalfString,secondHalf.innerHTML.toLowerCase().replace(goog.string.Unicode.NBSP,"&nbsp;"));if(isAppend){assertTrue("second half of dom should be the original node's next"+"sibling",node.nextSibling==secondHalf);goog.dom.removeNode(secondHalf)}goog.dom.removeNode(node)}function splitDomCases_(testFn){testFn(3,"<b>begin bold<i>ita</i></b>","<b><i>lic</i>end bold</b>");testFn(0,"<b>begin bold<i>&nbsp;</i></b>","<b><i>italic</i>end bold</b>");testFn(6,"<b>begin bold<i>italic</i></b>","<b><i>&nbsp;</i>end bold</b>")}function testSplitDom(){splitDomCases_(function(offset,firstHalfString,secondHalfString){helpTestSplit_(offset,firstHalfString,secondHalfString,!1,!0);helpTestSplit_(offset,firstHalfString,secondHalfString,!1,!1)})}function testSplitDomAndAppend(){splitDomCases_(function(offset,firstHalfString,secondHalfString){helpTestSplit_(offset,firstHalfString,secondHalfString,!0,!1)})}function testSplitDomAtElement(){var node=goog.dom.createElement(goog.dom.TagName.DIV);node.innerHTML="<div>abc<br>def</div>";document.body.appendChild(node);goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(node.firstChild,1,node.firstChild);goog.testing.dom.assertHtmlContentsMatch("<div>abc</div><div><br>def</div>",node);goog.dom.removeNode(node)}function testSplitDomAtElementStart(){var node=goog.dom.createElement(goog.dom.TagName.DIV);node.innerHTML="<div>abc<br>def</div>";document.body.appendChild(node);goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(node.firstChild,0,node.firstChild);goog.testing.dom.assertHtmlContentsMatch("<div></div><div>abc<br>def</div>",node);goog.dom.removeNode(node)}function testSplitDomAtChildlessElement(){var node=goog.dom.createElement(goog.dom.TagName.DIV);node.innerHTML="<div>abc<br>def</div>";document.body.appendChild(node);var br=goog.dom.getElementsByTagName(goog.dom.TagName.BR,node)[0];goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(br,0,node.firstChild);goog.testing.dom.assertHtmlContentsMatch("<div>abc</div><div><br>def</div>",node);goog.dom.removeNode(node)}function testReplaceWhiteSpaceWithNbsp(){var node=goog.dom.createElement(goog.dom.TagName.DIV),textNode=document.createTextNode("");node.appendChild(textNode);textNode.nodeValue=" test ";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!0,!1);assertHTMLEquals("&nbsp;test ",node.innerHTML);textNode.nodeValue="  test ";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!0,!1);assertHTMLEquals("&nbsp;test ",node.innerHTML);textNode.nodeValue=" test ";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!1,!1);assertHTMLEquals(" test&nbsp;",node.innerHTML);textNode.nodeValue=" test  ";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!1,!1);assertHTMLEquals(" test&nbsp;",node.innerHTML);textNode.nodeValue="";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!1,!1);assertHTMLEquals("&nbsp;",node.innerHTML);textNode.nodeValue="";goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(node.firstChild,!1,!0);assertHTMLEquals("",node.innerHTML)}