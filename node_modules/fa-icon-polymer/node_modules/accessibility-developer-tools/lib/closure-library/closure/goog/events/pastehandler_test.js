goog.provide("goog.events.PasteHandlerTest");goog.setTestOnly("goog.events.PasteHandlerTest");goog.require("goog.dom");goog.require("goog.events");goog.require("goog.events.BrowserEvent");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.events.PasteHandler");goog.require("goog.testing.MockClock");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function setUp(){textarea=new goog.events.EventTarget;textarea.value="";clock=new goog.testing.MockClock(!0);handler=new goog.events.PasteHandler(textarea);pasted=!1;goog.events.listen(handler,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0})}function tearDown(){textarea.dispose();handler.dispose();clock.dispose()}function newBrowserEvent(type){if(goog.isString(type)){return new goog.events.BrowserEvent({type:type})}else{return new goog.events.BrowserEvent(type)}}function testDispatchingPasteEventSupportedByAFewBrowsersWork(){if(!goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}var handlerThatSupportsPasteEvents=new goog.events.PasteHandler(textarea);goog.events.listen(handlerThatSupportsPasteEvents,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});textarea.dispatchEvent(newBrowserEvent("paste"));assertTrue(pasted)}function testJustTypingDoesntFirePasteEvent(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));assertFalse(pasted);textarea.dispatchEvent(newBrowserEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.A}));textarea.value="a";assertFalse(pasted);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.B});textarea.value="ab";assertFalse(pasted);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.C});textarea.value="abc";assertFalse(pasted)}function testStartsOnInitialState(){assertTrue(handler.getState()==goog.events.PasteHandler.State.INIT);assertFalse(pasted)}function testBlurOnInit(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.BLUR);assertTrue(handler.getState()==goog.events.PasteHandler.State.INIT);assertFalse(pasted)}function testFocusOnInit(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);assertTrue(handler.getState()==goog.events.PasteHandler.State.FOCUSED);assertFalse(pasted)}function testInputOnFocus(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(handler.getState()==goog.events.PasteHandler.State.FOCUSED);assertTrue(pasted)}function testKeyPressOnFocus(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.FOCUS));textarea.dispatchEvent(newBrowserEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.A}));assertTrue(handler.getState()==goog.events.PasteHandler.State.TYPING);assertFalse(pasted);textarea.dispatchEvent(newBrowserEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.V,ctrlKey:!0}));assertTrue(handler.getState()==goog.events.PasteHandler.State.TYPING);assertTrue(pasted)}function testMouseOverOnInit(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.value="pasted string";textarea.dispatchEvent(newBrowserEvent(goog.events.EventType.MOUSEOVER));assertTrue(handler.getState()==goog.events.PasteHandler.State.INIT);assertTrue(pasted);pasted=!1;textarea.dispatchEvent(goog.events.EventType.MOUSEOVER);assertTrue(handler.getState()==goog.events.PasteHandler.State.INIT);assertFalse(pasted)}function testMouseOverAfterTyping(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);assertFalse(pasted);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.A});assertFalse(pasted);textarea.value="a";textarea.dispatchEvent("input");assertFalse(pasted);assertEquals("a",handler.oldValue_);textarea.dispatchEvent(goog.events.EventType.MOUSEOVER);assertFalse(pasted)}function testTypingAndThenRightClickPaste(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.A});assertFalse(pasted);textarea.value="a";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent("input");assertFalse(pasted);assertEquals("a",handler.oldValue_);textarea.value="ab";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted)}function testTypingReallyFastDispatchesTwoInputEventsBeforeTheKeyDownEvent(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:goog.events.KeyCodes.A});assertFalse(pasted);textarea.value="a";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER-1);textarea.dispatchEvent("input");assertFalse(pasted);textarea.value="ab";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER-1);textarea.dispatchEvent("input");assertFalse(pasted)}function testRightClickRightClickAlsoDispatchesTwoConsecutiveInputEvents(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);textarea.value="a";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted);textarea.value="ab";clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted)}function testMiddleClickWithoutFocusTriggersPasteEvent(){if(goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}textarea.dispatchEvent(goog.events.EventType.FOCUS);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted)}function testMacRightClickPasteRequiresCtrlBecauseItHasOneButton(){if(!goog.userAgent.OPERA||!goog.userAgent.MAC){return}var handler=new goog.events.PasteHandler(textarea);goog.events.listen(handler,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});textarea.dispatchEvent(goog.events.EventType.FOCUS);assertFalse(pasted);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:0});assertFalse(pasted);clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted)}function testOperaMacFiresKeyCode17WhenAppleKeyPressedButDoesNotFireKeyDown(){if(!goog.userAgent.OPERA||!goog.userAgent.MAC){return}var handler=new goog.events.PasteHandler(textarea);goog.events.listen(handler,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});textarea.dispatchEvent(goog.events.EventType.FOCUS);assertFalse(pasted);textarea.dispatchEvent({type:goog.events.EventType.KEYDOWN,keyCode:17});assertFalse(pasted);clock.tick(goog.events.PasteHandler.MANDATORY_MS_BETWEEN_INPUT_EVENTS_TIE_BREAKER+1);textarea.dispatchEvent(newBrowserEvent("input"));assertTrue(pasted)}function testScriptingDoesntTriggerPasteEvents(){var handlerUsedToListenForScriptingChanges=new goog.events.PasteHandler(textarea);pasted=!1;goog.events.listen(handlerUsedToListenForScriptingChanges,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});goog.dom.getElement("foo").value="dear paste handler,";assertFalse(pasted);goog.dom.getElement("foo").value="please dont misunderstand script changes";assertFalse(pasted);goog.dom.getElement("foo").value="with user generated paste events";assertFalse(pasted);goog.dom.getElement("foo").value="thanks!";assertFalse(pasted)}function testAfterPaste(){if(!goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}var handlerThatSupportsPasteEvents=new goog.events.PasteHandler(textarea);pasted=!1;goog.events.listen(handlerThatSupportsPasteEvents,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});var afterPasteFired=!1;goog.events.listen(handlerThatSupportsPasteEvents,goog.events.PasteHandler.EventType.AFTER_PASTE,function(){afterPasteFired=!0});textarea.dispatchEvent(newBrowserEvent("paste"));assertTrue(pasted);assertFalse(afterPasteFired);clock.tick(goog.events.PasteHandler.PASTE_POLLING_PERIOD_MS_);textarea.value="text";clock.tick(goog.events.PasteHandler.PASTE_POLLING_PERIOD_MS_);assertTrue(afterPasteFired)}function testAfterPasteNotFiredIfDelayTooLong(){if(!goog.events.PasteHandler.SUPPORTS_NATIVE_PASTE_EVENT){return}var handlerThatSupportsPasteEvents=new goog.events.PasteHandler(textarea);pasted=!1;goog.events.listen(handlerThatSupportsPasteEvents,goog.events.PasteHandler.EventType.PASTE,function(){pasted=!0});var afterPasteFired=!1;goog.events.listen(handlerThatSupportsPasteEvents,goog.events.PasteHandler.EventType.AFTER_PASTE,function(){afterPasteFired=!0});textarea.dispatchEvent(newBrowserEvent("paste"));assertTrue(pasted);assertFalse(afterPasteFired);clock.tick(goog.events.PasteHandler.PASTE_POLLING_TIMEOUT_MS_);textarea.value="text";clock.tick(goog.events.PasteHandler.PASTE_POLLING_PERIOD_MS_);assertFalse(afterPasteFired)}