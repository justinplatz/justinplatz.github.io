goog.provide("goog.net.FetchXmlHttpFactoryTest");goog.setTestOnly("goog.net.FetchXmlHttpFactoryTest");goog.require("goog.net.FetchXmlHttp");goog.require("goog.net.FetchXmlHttpFactory");goog.require("goog.testing.MockControl");goog.require("goog.testing.jsunit");goog.require("goog.testing.recordFunction");goog.require("goog.userAgent.product");goog.require("goog.userAgent.product.isVersion");var mockControl,fetchMock,factory,worker;function shouldRunTests(){return goog.userAgent.product.CHROME&&goog.userAgent.product.isVersion(43)}function setUp(){mockControl=new goog.testing.MockControl;worker={};fetchMock=mockControl.createFunctionMock("fetch");worker.fetch=fetchMock;factory=new goog.net.FetchXmlHttpFactory(worker)}function tearDown(){mockControl.$tearDown()}function testOpen(){mockControl.$replayAll();var xhr=factory.createInstance();assertEquals(0,xhr.status);assertEquals("",xhr.responseText);assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.UNSENT);var onReadyStateChangeHandler=new goog.testing.recordFunction;xhr.onreadystatechange=onReadyStateChangeHandler;xhr.open("GET","https://www.google.com",!0);assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.OPENED);onReadyStateChangeHandler.assertCallCount(1);mockControl.$verifyAll()}function testOpen_notUnsent(){mockControl.$replayAll();var xhr=factory.createInstance();xhr.open("GET","https://www.google.com",!0);assertThrows(function(){xhr.open("GET","https://www.google.com",!0)});mockControl.$verifyAll()}function testOpen_notAsync(){mockControl.$replayAll();var xhr=factory.createInstance();assertThrows(function(){xhr.open("GET","https://www.google.com",!1)});mockControl.$verifyAll()}function testSend(){fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"GET"})).$returns(Promise.resolve(createSuccessResponse()));mockControl.$replayAll();verifySendSuccess("GET")}function testSendPost(){fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"POST"})).$returns(Promise.resolve(createSuccessResponse()));mockControl.$replayAll();verifySendSuccess("POST")}function testSend_includeCredentials(){factory=new goog.net.FetchXmlHttpFactory(worker);factory.setCredentialsMode("include");fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"POST",credentials:"include"})).$returns(Promise.resolve(createSuccessResponse()));mockControl.$replayAll();verifySendSuccess("POST")}function testSend_setCacheMode(){factory=new goog.net.FetchXmlHttpFactory(worker);factory.setCacheMode("no-cache");fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"POST",cache:"no-cache"})).$returns(Promise.resolve(createSuccessResponse()));mockControl.$replayAll();verifySendSuccess("POST")}function verifySendSuccess(sendMethod){var xhr=factory.createInstance();xhr.open(sendMethod,"https://www.google.com",!0);xhr.onreadystatechange=function(){assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.HEADER_RECEIVED);assertEquals(0,xhr.status);assertEquals("",xhr.responseText);assertEquals(xhr.getResponseHeader("dummyHeader"),"dummyHeaderValue");xhr.onreadystatechange=function(){assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.LOADING);assertEquals(0,xhr.status);assertEquals("",xhr.responseText);xhr.onreadystatechange=function(){assertEquals(200,xhr.status);assertEquals("responseBody",xhr.responseText);assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.DONE)}}};xhr.send();assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.OPENED);mockControl.$verifyAll()}function testSend_error(){fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"GET"})).$returns(Promise.resolve(createFailedResponse()));mockControl.$replayAll();var xhr=factory.createInstance();xhr.open("GET","https://www.google.com",!0);xhr.onreadystatechange=function(){assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.HEADER_RECEIVED);assertEquals(0,xhr.status);assertEquals("",xhr.responseText);assertEquals(xhr.getResponseHeader("dummyHeader"),"dummyHeaderValue");xhr.onreadystatechange=function(){assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.LOADING);assertEquals(0,xhr.status);assertEquals("",xhr.responseText);xhr.onreadystatechange=function(){assertEquals(500,xhr.status);assertEquals("responseBody",xhr.responseText);assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.DONE)}}};xhr.send();assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.OPENED);mockControl.$verifyAll()}function testSend_failToFetch(){var failedPromise=new Promise(function(){throw Error("failed to fetch")});fetchMock(new Request("https://www.google.com",{headers:new Headers,method:"GET"})).$returns(failedPromise);mockControl.$replayAll();var xhr=factory.createInstance();xhr.open("GET","https://www.google.com",!0);xhr.onreadystatechange=function(){assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.DONE);assertEquals(0,xhr.status);assertEquals("",xhr.responseText)};xhr.send();assertEquals(xhr.readyState,goog.net.FetchXmlHttp.RequestState.OPENED);mockControl.$verifyAll()}function createSuccessResponse(){var headers=new Headers;headers.set("dummyHeader","dummyHeaderValue");return new Response("responseBody",{status:200,headers:headers})}function createFailedResponse(){var headers=new Headers;headers.set("dummyHeader","dummyHeaderValue");return new Response("responseBody",{status:500,headers:headers})}