goog.provide("goog.testing.JsTdAsyncWrapper");goog.require("goog.Promise");goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_FN_=goog.global.setTimeout;goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_=function(fn,timeout){var setTimeoutFn=goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_FN_;setTimeoutFn(fn,timeout)};goog.testing.JsTdAsyncWrapper.convertToAsyncTestObj=function(original){var queueWrapperFn=function(fn){return function(){var queue=new goog.testing.JsTdAsyncWrapper.Queue_(this);fn.call(this,queue);return queue.startExecuting()}},newTestObj={};for(var prop in original){if(0==prop.indexOf("test")||"setUp"==prop||"tearDown"==prop){newTestObj[prop]=queueWrapperFn(original[prop])}else{newTestObj[prop]=original[prop]}}return newTestObj};goog.testing.JsTdAsyncWrapper.Queue_=function(testObj){this.steps_=[];this.delegate_=null;this.testObj_=testObj};goog.testing.JsTdAsyncWrapper.Queue_.prototype.defer=function(stepName,opt_fn){var fn=opt_fn;if(!opt_fn&&"function"==typeof stepName){fn=stepName;stepName="(Not named)"}if(this.delegate_){this.delegate_.defer(stepName,fn);return}this.steps_.push(new goog.testing.JsTdAsyncWrapper.Step_(stepName,fn))};goog.testing.JsTdAsyncWrapper.Queue_.prototype.startExecuting=function(){return new goog.Promise(goog.bind(function(resolve,reject){this.executeNextStep_(resolve,reject)},this))};goog.testing.JsTdAsyncWrapper.Queue_.prototype.executeNextStep_=function(callback,errback){if(!this.steps_.length){callback();return}var step=this.steps_.shift();this.delegate_=new goog.testing.JsTdAsyncWrapper.Queue_(this.testObj_);var pool=new goog.testing.JsTdAsyncWrapper.Pool_(this.testObj_,goog.bind(function(){goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_(goog.bind(function(){this.executeDelegate_(callback,errback)},this),0)},this),goog.bind(function(reason){this.handleError_(errback,reason,step.name)},this));try{step.fn.call(this.testObj_,pool)}catch(e){this.handleError_(errback,e,step.name)}pool.maybeComplete()};goog.testing.JsTdAsyncWrapper.Queue_.prototype.executeDelegate_=function(callback,errback){if(!this.delegate_){this.executeNextStep_(callback,errback);return}this.delegate_.executeNextStep_(goog.bind(function(){this.delegate_=null;goog.testing.JsTdAsyncWrapper.REAL_SET_TIMEOUT_(goog.bind(function(){this.executeNextStep_(callback,errback)},this),0)},this),errback)};goog.testing.JsTdAsyncWrapper.Queue_.prototype.handleError_=function(errback,reason,stepName){var error=reason instanceof Error?reason:Error(reason);error.message="In step "+stepName+", error: "+error.message;errback(reason)};goog.testing.JsTdAsyncWrapper.Step_=function(name,fn){this.name=name;this.fn=fn};goog.testing.JsTdAsyncWrapper.Pool_=function(testObj,callback,errback){this.outstandingCallbacks_=0;this.callback_=callback;this.errback_=errback;this.testObj_=testObj};goog.testing.JsTdAsyncWrapper.Pool_.prototype.noop=function(){return this.addCallback(function(){})};goog.testing.JsTdAsyncWrapper.Pool_.prototype.addCallback=function(fn,opt_n,opt_timeout,opt_description){if(opt_timeout||opt_description){throw Error("Setting timeout or description in a pool callback is not supported.")}var numCallbacks=opt_n||1;this.outstandingCallbacks_=this.outstandingCallbacks_+numCallbacks;return goog.bind(function(){try{fn.apply(this.testObj_,arguments)}catch(e){if(opt_description){e.message=opt_description+e.message}this.errback_(e)}this.outstandingCallbacks_=this.outstandingCallbacks_-1;if(0==this.outstandingCallbacks_){this.callback_()}},this)};goog.testing.JsTdAsyncWrapper.Pool_.prototype.add=goog.testing.JsTdAsyncWrapper.Pool_.prototype.addCallback;goog.testing.JsTdAsyncWrapper.Pool_.prototype.addErrback=function(msg){return goog.bind(function(){var errorMsg=msg;if(arguments.length){errorMsg+=" - Error callback called with params: ( ";for(var i=0,arg;i<arguments.length;i++){arg=arguments[i];errorMsg+=arg+" ";if(arg instanceof Error){errorMsg+="\n"+arg.stack+"\n"}}errorMsg+=")"}this.errback_(errorMsg)},this)};goog.testing.JsTdAsyncWrapper.Pool_.prototype.maybeComplete=function(){if(0==this.outstandingCallbacks_){this.callback_()}};