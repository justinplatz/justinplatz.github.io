goog.provide("goog.net.streams.XhrNodeReadableStream");goog.require("goog.array");goog.require("goog.log");goog.require("goog.net.streams.NodeReadableStream");goog.require("goog.net.streams.XhrStreamReader");goog.net.streams.XhrNodeReadableStream=function(xhrReader){this.logger_=goog.log.getLogger("goog.net.streams.XhrNodeReadableStream");this.xhrReader_=xhrReader;this.xhrReader_.setDataHandler(goog.bind(this.onData_,this));this.xhrReader_.setStatusHandler(goog.bind(this.onStatusChange_,this));this.callbackMap_={};this.callbackOnceMap_={}};goog.net.streams.XhrNodeReadableStream.prototype.on=function(eventType,callback){var callbacks=this.callbackMap_[eventType];if(!callbacks){callbacks=[];this.callbackMap_[eventType]=callbacks}callbacks.push(callback);return this};goog.net.streams.XhrNodeReadableStream.prototype.addListener=function(eventType,callback){this.on(eventType,callback);return this};goog.net.streams.XhrNodeReadableStream.prototype.removeListener=function(eventType,callback){var callbacks=this.callbackMap_[eventType];if(callbacks){goog.array.remove(callbacks,callback)}var onceCallbacks=this.callbackOnceMap_[eventType];if(onceCallbacks){goog.array.remove(onceCallbacks,callback)}return this};goog.net.streams.XhrNodeReadableStream.prototype.once=function(eventType,callback){var callbacks=this.callbackOnceMap_[eventType];if(!callbacks){callbacks=[];this.callbackOnceMap_[eventType]=callbacks}callbacks.push(callback);return this};goog.net.streams.XhrNodeReadableStream.prototype.onData_=function(messages){var callbacks=this.callbackMap_[goog.net.streams.NodeReadableStream.EventType.DATA];if(callbacks){this.doMessages_(messages,callbacks)}var onceCallbacks=this.callbackOnceMap_[goog.net.streams.NodeReadableStream.EventType.DATA];if(onceCallbacks){this.doMessages_(messages,onceCallbacks)}this.callbackOnceMap_[goog.net.streams.NodeReadableStream.EventType.DATA]=[]};goog.net.streams.XhrNodeReadableStream.prototype.doMessages_=function(messages,callbacks){for(var self=this,i=0,message;i<messages.length;i++){message=messages[i];goog.array.forEach(callbacks,function(callback){try{callback(message)}catch(ex){self.handleError_("message-callback exception (ignored) "+ex)}})}};goog.net.streams.XhrNodeReadableStream.prototype.onStatusChange_=function(){var currentStatus=this.xhrReader_.getStatus(),Status=goog.net.streams.XhrStreamReader.Status,EventType=goog.net.streams.NodeReadableStream.EventType;switch(currentStatus){case Status.ACTIVE:this.doStatus_(EventType.READABLE);break;case Status.BAD_DATA:case Status.HANDLER_EXCEPTION:case Status.NO_DATA:case Status.TIMEOUT:case Status.XHR_ERROR:this.doStatus_(EventType.ERROR);break;case Status.CANCELLED:this.doStatus_(EventType.CLOSE);break;case Status.SUCCESS:this.doStatus_(EventType.END);break;}};goog.net.streams.XhrNodeReadableStream.prototype.doStatus_=function(eventType){var callbacks=this.callbackMap_[eventType],self=this;if(callbacks){goog.array.forEach(callbacks,function(callback){try{callback()}catch(ex){self.handleError_("status-callback exception (ignored) "+ex)}})}var onceCallbacks=this.callbackOnceMap_[eventType];if(onceCallbacks){goog.array.forEach(onceCallbacks,function(callback){callback()})}this.callbackOnceMap_[eventType]=[]};goog.net.streams.XhrNodeReadableStream.prototype.handleError_=function(message){goog.log.error(this.logger_,message)};