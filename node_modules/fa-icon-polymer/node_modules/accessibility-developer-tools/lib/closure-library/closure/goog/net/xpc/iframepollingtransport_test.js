goog.provide("goog.net.xpc.IframePollingTransportTest");goog.setTestOnly("goog.net.xpc.IframePollingTransportTest");goog.require("goog.Timer");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.functions");goog.require("goog.net.xpc.CfgFields");goog.require("goog.net.xpc.CrossPageChannel");goog.require("goog.net.xpc.CrossPageChannelRole");goog.require("goog.net.xpc.TransportTypes");goog.require("goog.object");goog.require("goog.testing.MockClock");goog.require("goog.testing.jsunit");goog.require("goog.testing.recordFunction");var mockClock=null,outerChannel=null,innerChannel=null;function setUp(){mockClock=new goog.testing.MockClock(!0);var outerPeerHostName="https://www.youtube.com",outerPeerWindow=createMockPeerWindow(outerPeerHostName),innerPeerHostName="https://www.google.com",innerPeerWindow=createMockPeerWindow(innerPeerHostName);outerChannel=createChannel(goog.net.xpc.CrossPageChannelRole.OUTER,"test",outerPeerHostName,outerPeerWindow,innerPeerHostName,innerPeerWindow);innerChannel=createChannel(goog.net.xpc.CrossPageChannelRole.INNER,"test",innerPeerHostName,innerPeerWindow,outerPeerHostName,outerPeerWindow)}function tearDown(){outerChannel.dispose();innerChannel.dispose();mockClock.uninstall()}function testConnect(){var outerConnectCallback=goog.testing.recordFunction(),innerConnectCallback=goog.testing.recordFunction();outerChannel.connect(outerConnectCallback);innerChannel.connect(innerConnectCallback);mockClock.tick(1e3);assertEquals(1,outerConnectCallback.getCallCount());assertEquals(1,innerConnectCallback.getCallCount());assertTrue(outerChannel.isConnected());assertTrue(innerChannel.isConnected())}function testSend_outerToInner(){var serviceCallback=goog.testing.recordFunction();innerChannel.registerService("svc",function(payload){assertEquals("hello",payload);serviceCallback()});outerChannel.connect();innerChannel.connect();mockClock.tick(1e3);outerChannel.send("svc","hello");mockClock.tick(1e3);assertEquals(1,serviceCallback.getCallCount())}function testSend_innerToOuter(){var serviceCallback=goog.testing.recordFunction();outerChannel.registerService("svc",function(payload){assertEquals("hello",payload);serviceCallback()});outerChannel.connect();innerChannel.connect();mockClock.tick(1e3);innerChannel.send("svc","hello");mockClock.tick(1e3);assertEquals(1,serviceCallback.getCallCount())}function testSend_outerPeerClosed(){innerChannel.connect();mockClock.tick(1e3);closeWindow(innerChannel.getPeerWindowObject());mockClock.tick(1e3)}function testSend_innerPeerClosed(){outerChannel.connect();mockClock.tick(1e3);closeWindow(outerChannel.getPeerWindowObject());mockClock.tick(1e3)}function testSend_outerPeerClosing(){innerChannel.connect();mockClock.tick(1e3);closeWindow(innerChannel.getPeerWindowObject());innerChannel.getPeerWindowObject().closed=!1;mockClock.tick(1e3)}function testSend_innerPeerClosing(){outerChannel.connect();mockClock.tick(1e3);closeWindow(outerChannel.getPeerWindowObject());outerChannel.getPeerWindowObject().closed=!1;mockClock.tick(1e3)}function createChannel(role,channelName,fromHostName,fromWindow,toHostName,toWindow){var channelConfig=goog.object.create(goog.net.xpc.CfgFields.ROLE,role,goog.net.xpc.CfgFields.PEER_HOSTNAME,toHostName,goog.net.xpc.CfgFields.CHANNEL_NAME,channelName,goog.net.xpc.CfgFields.LOCAL_POLL_URI,fromHostName+"/robots.txt",goog.net.xpc.CfgFields.PEER_POLL_URI,toHostName+"/robots.txt",goog.net.xpc.CfgFields.TRANSPORT,goog.net.xpc.TransportTypes.IFRAME_POLLING),channel=new goog.net.xpc.CrossPageChannel(channelConfig);channel.setPeerWindowObject(toWindow);channel.createTransport_();channel.transport_.getWindow=goog.functions.constant(fromWindow);return channel}function createMockPeerWindow(url){var mockPeer=createMockWindow(url);mockPeer.document.body.appendChild=function(el){assertEquals(goog.dom.TagName.IFRAME+"",el.tagName);mockPeer.frames[el.name]=createMockWindow(el.src);mockPeer.document.body.element.appendChild(el)};return mockPeer}function createMockWindow(url){var mockWindow={},mockDocument={},mockBody={},mockLocation={};mockBody.element=goog.dom.createDom(goog.dom.TagName.BODY);mockDocument.body=mockBody;mockLocation.href=url;mockLocation.replace=function(value){mockLocation.href=value};mockWindow.document=mockDocument;mockWindow.frames={};mockWindow.location=mockLocation;mockWindow.setTimeout=goog.Timer.callOnce;return mockWindow}function closeWindow(targetWindow){for(var frameName in targetWindow.frames){closeWindow(targetWindow.frames[frameName])}targetWindow.closed=!0;targetWindow.frames=null;targetWindow.document=null;targetWindow.location=null}