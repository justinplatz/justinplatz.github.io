goog.setTestOnly("goog.testing.TestRunner");goog.provide("goog.testing.TestRunner");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.testing.TestCase");goog.testing.TestRunner=function(){this.errors=[];this.testCase=null;this.initialized=!1;this.logEl_=null;this.errorFilter_=null;this.strict_=!0};goog.testing.TestRunner.prototype.initialize=function(testCase){if(this.testCase&&this.testCase.running){throw Error("The test runner is already waiting for a test to complete")}this.testCase=testCase;this.initialized=!0};goog.testing.TestRunner.prototype.setStrict=function(strict){this.strict_=strict};goog.testing.TestRunner.prototype.isStrict=function(){return this.strict_};goog.testing.TestRunner.prototype.isInitialized=function(){return this.initialized};goog.testing.TestRunner.prototype.isFinished=function(){return 0<this.errors.length||this.initialized&&!!this.testCase&&this.testCase.started&&!this.testCase.running};goog.testing.TestRunner.prototype.isSuccess=function(){return!this.hasErrors()&&!!this.testCase&&this.testCase.isSuccess()};goog.testing.TestRunner.prototype.hasErrors=function(){return 0<this.errors.length};goog.testing.TestRunner.prototype.logError=function(msg){if(!this.errorFilter_||this.errorFilter_.call(null,msg)){this.errors.push(msg)}};goog.testing.TestRunner.prototype.logTestFailure=function(ex){var testName=goog.testing.TestCase.currentTestName;if(this.testCase){this.testCase.logError(testName,ex)}else{throw new Error("Test runner not initialized with a test case. Original "+"exception: "+ex.message)}};goog.testing.TestRunner.prototype.setErrorFilter=function(fn){this.errorFilter_=fn};goog.testing.TestRunner.prototype.getReport=function(opt_verbose){var report=[];if(this.testCase){report.push(this.testCase.getReport(opt_verbose))}if(0<this.errors.length){report.push("JavaScript errors detected by test runner:");report.push.apply(report,this.errors);report.push("\n")}return report.join("\n")};goog.testing.TestRunner.prototype.getRunTime=function(){return this.testCase?this.testCase.getRunTime():0};goog.testing.TestRunner.prototype.getNumFilesLoaded=function(){return this.testCase?this.testCase.getNumFilesLoaded():0};goog.testing.TestRunner.prototype.execute=function(){if(!this.testCase){throw Error("The test runner must be initialized with a test case "+"before execute can be called.")}if(this.strict_&&0==this.testCase.getCount()){throw Error("No tests found in given test case: "+this.testCase.getName()+". "+"By default, the test runner fails if a test case has no tests. "+"To modify this behavior, see goog.testing.TestRunner's "+"setStrict() method, or G_testRunner.setStrict()")}this.testCase.setCompletedCallback(goog.bind(this.onComplete_,this));if(goog.testing.TestRunner.shouldUsePromises_(this.testCase)){this.testCase.runTestsReturningPromise()}else{this.testCase.runTests()}};goog.testing.TestRunner.shouldUsePromises_=function(testCase){return testCase.constructor===goog.testing.TestCase};goog.testing.TestRunner.prototype.onComplete_=function(){var log=this.testCase.getReport(!0);if(0<this.errors.length){log+="\n"+this.errors.join("\n")}if(!this.logEl_){var el=document.getElementById("closureTestRunnerLog");if(null==el){el=goog.dom.createElement(goog.dom.TagName.DIV);document.body.appendChild(el)}this.logEl_=el}this.writeLog(log);var runAgainLink=goog.dom.createElement(goog.dom.TagName.A);runAgainLink.style.display="inline-block";runAgainLink.style.fontSize="small";runAgainLink.style.marginBottom="16px";runAgainLink.href="";runAgainLink.onclick=goog.bind(function(){this.execute();return!1},this);runAgainLink.innerHTML="Run again without reloading";this.logEl_.appendChild(runAgainLink)};goog.testing.TestRunner.prototype.writeLog=function(log){for(var lines=log.split("\n"),i=0;i<lines.length;i++){var line=lines[i],color,isFailOrError=/FAILED/.test(line)||/ERROR/.test(line);if(/PASSED/.test(line)){color="darkgreen"}else if(isFailOrError){color="darkred"}else{color="#333"}var div=goog.dom.createElement(goog.dom.TagName.DIV);if("> "==line.substr(0,2)){div.innerHTML=line}else{div.appendChild(document.createTextNode(line))}var testNameMatch=/(\S+) (\[[^\]]*] )?: (FAILED|ERROR|PASSED)/.exec(line);if(testNameMatch){var newSearch="runTests="+testNameMatch[1],search=window.location.search;if(search){var oldTests=/runTests=([^&]*)/.exec(search);if(oldTests){newSearch=search.substr(0,oldTests.index)+newSearch+search.substr(oldTests.index+oldTests[0].length)}else{newSearch=search+"&"+newSearch}}else{newSearch="?"+newSearch}var href=window.location.href,hash=window.location.hash;if(hash&&"#"!=hash.charAt(0)){hash="#"+hash}href=href.split("#")[0].split("?")[0]+newSearch+hash;var a=goog.dom.createElement(goog.dom.TagName.A);a.innerHTML="(run individually)";a.style.fontSize="0.8em";a.style.color="#888";a.href=href;div.appendChild(document.createTextNode(" "));div.appendChild(a)}div.style.color=color;div.style.font="normal 100% monospace";div.style.wordWrap="break-word";if(0==i){div.style.padding="20px";div.style.marginBottom="10px";if(isFailOrError){div.style.border="5px solid "+color;div.style.backgroundColor="#ffeeee"}else{div.style.border="1px solid black";div.style.backgroundColor="#eeffee"}}try{div.style.whiteSpace="pre-wrap"}catch(e){}if(2>i){div.style.fontWeight="bold"}this.logEl_.appendChild(div)}};goog.testing.TestRunner.prototype.log=function(s){if(this.testCase){this.testCase.log(s)}};goog.testing.TestRunner.prototype.getTestResults=function(){if(this.testCase){return this.testCase.getTestResults()}return null};