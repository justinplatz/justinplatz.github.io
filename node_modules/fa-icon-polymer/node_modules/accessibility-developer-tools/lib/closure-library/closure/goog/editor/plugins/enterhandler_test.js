goog.provide("goog.editor.plugins.EnterHandlerTest");goog.setTestOnly("goog.editor.plugins.EnterHandlerTest");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.BrowserFeature");goog.require("goog.editor.Field");goog.require("goog.editor.Plugin");goog.require("goog.editor.plugins.Blockquote");goog.require("goog.editor.plugins.EnterHandler");goog.require("goog.editor.range");goog.require("goog.events");goog.require("goog.events.KeyCodes");goog.require("goog.testing.ExpectedFailures");goog.require("goog.testing.MockClock");goog.require("goog.testing.dom");goog.require("goog.testing.editor.TestHelper");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var savedHtml,field1,field2,firedDelayedChange,firedBeforeChange,clock,container,EXPECTEDFAILURES;function setUpPage(){container=goog.dom.getElement("container")}function setUp(){EXPECTEDFAILURES=new goog.testing.ExpectedFailures;savedHtml=goog.dom.getElement("root").innerHTML;clock=new goog.testing.MockClock(!0)}function setUpFields(classnameRequiredToSplitBlockquote){field1=makeField("field1",classnameRequiredToSplitBlockquote);field2=makeField("field2",classnameRequiredToSplitBlockquote);field1.makeEditable();field2.makeEditable()}function tearDown(){clock.dispose();EXPECTEDFAILURES.handleTearDown();goog.dom.getElement("root").innerHTML=savedHtml}function testEnterInNonSetupBlockquote(){setUpFields(!0);resetChangeFlags();var prevented=!selectNodeAndHitEnter(field1,"field1cursor");waitForChangeEvents();assertChangeFlags();var elem=field1.getElement(),dom=field1.getEditableDomHelper();EXPECTEDFAILURES.expectFailureFor(goog.userAgent.OPERA,"The blockquote is overwritten with DIV due to CORE-22104 -- Opera "+"overwrites the BLOCKQUOTE ancestor with DIV when doing FormatBlock "+"for DIV");try{assertEquals("Blockquote should not be split",1,dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem).length)}catch(e){EXPECTEDFAILURES.handleException(e)}assert("Selection should be deleted",-1==elem.innerHTML.indexOf("selection"));assertEquals("The event should have been prevented only on webkit",prevented,goog.userAgent.WEBKIT)}function testEnterInSetupBlockquote(){setUpFields(!0);resetChangeFlags();var prevented=!selectNodeAndHitEnter(field2,"field2cursor");waitForChangeEvents();assertChangeFlags();var elem=field2.getElement(),dom=field2.getEditableDomHelper();assertEquals("Blockquote should be split",2,dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem).length);assert("Selection should be deleted",-1==elem.innerHTML.indexOf("selection"));assert("should have div with &nbsp;",-1!=elem.innerHTML.indexOf(">"+getNbsp()+"<"));assert("event should have been prevented",prevented)}function testEnterInNonSetupBlockquoteWhenClassnameIsNotRequired(){setUpFields(!1);resetChangeFlags();var prevented=!selectNodeAndHitEnter(field1,"field1cursor");waitForChangeEvents();assertChangeFlags();var elem=field1.getElement(),dom=field1.getEditableDomHelper();assertEquals("Blockquote should be split",2,dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem).length);assert("Selection should be deleted",-1==elem.innerHTML.indexOf("selection"));assert("should have div with &nbsp;",-1!=elem.innerHTML.indexOf(">"+getNbsp()+"<"));assert("event should have been prevented",prevented)}function testEnterInBlockquoteCreatesDivInBrMode(){setUpFields(!0);selectNodeAndHitEnter(field2,"field2cursor");var elem=field2.getElement(),dom=field2.getEditableDomHelper(),firstBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[0],div=dom.getNextElementSibling(firstBlockquote);assertEquals("Element after blockquote should be a div","DIV",div.tagName);assertEquals("Element after div should be second blockquote","BLOCKQUOTE",dom.getNextElementSibling(div).tagName)}function testEnterInBlockquoteRemovesUnnecessaryBrWithCursorAfterBr(){setUpFields(!0);field1.setHtml(!1,"<blockquote id=\"quote\" class=\"tr_bq\">one<br>"+"two<br></blockquote>");var dom=field1.getEditableDomHelper();goog.dom.Range.createCaret(dom.getElement("quote"),2).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var elem=field1.getElement(),secondBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[1];assertHTMLEquals("two<br>",secondBlockquote.innerHTML);field1.setHtml(!1,"<blockquote class=\"tr_bq\">one<br id=\"brcursor\"></blockquote>");selectNodeAndHitEnter(field1,"brcursor");assertEquals(1,dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem).length)}function testEnterInBlockquoteRemovesUnnecessaryBrWithCursorBeforeBr(){setUpFields(!0);field1.setHtml(!1,"<blockquote id=\"quote\" class=\"tr_bq\">one<br>"+"two<br></blockquote>");var dom=field1.getEditableDomHelper(),cursor=dom.getElement("quote").firstChild;goog.dom.Range.createCaret(cursor,3).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var elem=field1.getElement(),secondBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[1];assertHTMLEquals("two<br>",secondBlockquote.innerHTML);field1.setHtml(!1,"<blockquote id=\"quote\" class=\"tr_bq\">one<b>two</b><br>");cursor=dom.getElement("quote").firstChild;goog.dom.Range.createCaret(cursor,3).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);secondBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[1];assertHTMLEquals("<b>two</b><br>",secondBlockquote.innerHTML)}function testEnterInBlockquoteRemovesExtraNodes(){setUpFields(!0);field1.setHtml(!1,"<blockquote class=\"tr_bq\">"+"<div><div>a</div><ol><li id=\"cursor\">one</li></div>"+"<div>b</div>"+"</blockquote>");var dom=field1.getEditableDomHelper();goog.dom.Range.createCaret(dom.getElement("cursor").firstChild,3).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var elem=field1.getElement(),secondBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[1];assertHTMLEquals("<div>b</div>",secondBlockquote.innerHTML);field1.setHtml(!1,"<blockquote class=\"tr_bq\">"+"<div><span>a</span><div id=\"cursor\">one</div><div>two</div></div>"+"<div><span>c</span></div>"+"</blockquote>");goog.dom.Range.createCaret(dom.getElement("cursor").firstChild,3).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);secondBlockquote=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem)[1];var expectedHTML="<div><div>two</div></div>"+"<div><span>c</span></div>";assertHTMLEquals(expectedHTML,secondBlockquote.innerHTML);field1.setHtml(!1,"<blockquote id=\"quote\" class=\"tr_bq\">"+"<div>one</div><div>two</div>"+"</blockquote>");goog.dom.Range.createCaret(dom.getElement("quote").firstChild.firstChild,1).select();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);var blockquotes=dom.getElementsByTagNameAndClass(goog.dom.TagName.BLOCKQUOTE,null,elem);assertEquals(2,blockquotes.length);assertHTMLEquals("<div>o</div>",blockquotes[0].innerHTML);assertHTMLEquals("<div>ne</div><div>two</div>",blockquotes[1].innerHTML)}function testEnterInList(){setUpFields(!0);field1.setHtml(!1,"<ol><li>hi!<span id=\"field1cursor\"></span></li></ol>");if(goog.userAgent.OPERA){var dom=field1.getEditableDomHelper();dom.getElement("field1cursor").appendChild(dom.createTextNode(""))}var prevented=!selectNodeAndHitEnter(field1,"field1cursor");assertFalse("<enter> in a list should not be prevented",prevented)}function testEnterAtEndOfBlockInWebkit(){setUpFields(!0);if(goog.userAgent.WEBKIT){field1.setHtml(!1,"<blockquote>hi!<span id=\"field1cursor\"></span></blockquote>");var cursor=field1.getEditableDomHelper().getElement("field1cursor");goog.editor.range.placeCursorNextTo(cursor,!1);goog.dom.removeNode(cursor);var prevented=!goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);waitForChangeEvents();assertChangeFlags();assert("event should have been prevented",prevented);var elem=field1.getElement();assertEquals("should have inserted two br tags: "+elem.innerHTML,2,goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.BR,null,elem).length)}}function testDeleteBrBeforeBlock(){setUpFields(!0);if(goog.userAgent.GECKO){field1.setHtml(!1,"one<br><br><div>two</div>");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select(field1.getElement(),2);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted exactly one <br>","one<br><div>two</div>",field1.getElement().innerHTML);field1.setHtml(!1,"one<br><ul><li>two</li></ul>");helper.select(field1.getElement(),1);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted the <br>","one<ul><li>two</li></ul>",field1.getElement().innerHTML);var range=field1.getRange(),focusNode=range.getFocusNode();assertTrue("The selected range should be collapsed",range.isCollapsed());assertTrue("The focus node should be the text node \"one\"",focusNode.nodeType==goog.dom.NodeType.TEXT&&"one"==focusNode.data);assertEquals("The focus offset should be at the end of the text node \"one\"",focusNode.length,range.getFocusOffset());assertTrue("The next sibling of the focus node should be the UL",focusNode.nextSibling&&focusNode.nextSibling.tagName==goog.dom.TagName.UL);field1.setHtml(!1,"<div>foo</div><br><div><span>bar</span></div>");helper.select(field1.getElement(),1);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted the <br>","<div>foo</div><div><span>bar</span></div>",field1.getElement().innerHTML);range=field1.getRange();assertEquals("The selected range should be contained within the <span>",goog.dom.TagName.SPAN+"",range.getContainerElement().tagName);assertTrue("The selected range should be collapsed",range.isCollapsed());focusNode=range.getFocusNode();assertTrue("The focus node should be the text node \"bar\"",focusNode.nodeType==goog.dom.NodeType.TEXT&&"bar"==focusNode.data);assertEquals("The focus offset should be at the beginning "+"of the text node \"bar\"",0,range.getFocusOffset());field1.setHtml(!1,"<br><ul><li>one</li></ul>");helper.select(field1.getElement(),0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted the <br>","<ul><li>one</li></ul>",field1.getElement().innerHTML);range=field1.getRange();assertEquals("The selected range should be contained within the <li>",goog.dom.TagName.LI+"",range.getContainerElement().tagName);assertTrue("The selected range should be collapsed",range.isCollapsed());focusNode=range.getFocusNode();assertTrue("The focus node should be the text node \"one\"",focusNode.nodeType==goog.dom.NodeType.TEXT&&"one"==focusNode.data);assertEquals("The focus offset should be at the beginning of "+"the text node \"one\"",0,range.getFocusOffset());field1.setHtml(!1,"<br><br><ul><li>one</li></ul>");helper.select(field1.getElement(),1);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted the <br>","<br><ul><li>one</li></ul>",field1.getElement().innerHTML);range=field1.getRange();assertEquals("The selected range should be contained within the <li>",goog.dom.TagName.LI+"",range.getContainerElement().tagName);assertTrue("The selected range should be collapsed",range.isCollapsed());focusNode=range.getFocusNode();assertTrue("The focus node should be the text node \"one\"",focusNode.nodeType==goog.dom.NodeType.TEXT&&"one"==focusNode.data);assertEquals("The focus offset should be at the beginning of "+"the text node \"one\"",0,range.getFocusOffset())}}function testDeleteBeforeBlockquote(){setUpFields(!0);if(goog.userAgent.GECKO){field1.setHtml(!1,"<br><br><div><br><blockquote>foo</blockquote></div>");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select(field1.getElement(),0);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted all the <br>'s and the blockquote "+"isn't affected","<div><blockquote>foo</blockquote></div>",field1.getElement().innerHTML);var range=field1.getRange();assertEquals("The selected range should be contained within the "+"<blockquote>",goog.dom.TagName.BLOCKQUOTE+"",range.getContainerElement().tagName);assertTrue("The selected range should be collapsed",range.isCollapsed());var focusNode=range.getFocusNode();assertTrue("The focus node should be the text node \"foo\"",focusNode.nodeType==goog.dom.NodeType.TEXT&&"foo"==focusNode.data);assertEquals("The focus offset should be at the "+"beginning of the text node \"foo\"",0,range.getFocusOffset())}}function testDeleteBrNormal(){setUpFields(!0);if(goog.userAgent.GECKO){field1.setHtml(!1,"one<br><br><br>two");var helper=new goog.testing.editor.TestHelper(field1.getElement());helper.select(field1.getElement(),2);field1.getElement().focus();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.DELETE);assertEquals("Should have deleted exactly one <br>","one<br><br>two",field1.getElement().innerHTML)}}function testCollapsedSelectionKeepsBrOpera(){setUpFields(!0);if(goog.userAgent.OPERA){field1.setHtml(!1,"<div><br id=\"pleasedontdeleteme\"></div>");field1.focus();goog.testing.events.fireKeySequence(field1.getElement(),goog.events.KeyCodes.ENTER);assertNotNull("The <br> must not have been deleted",goog.dom.getElement("pleasedontdeleteme"))}}function selectNodeAndHitEnter(field,id){var dom=field.getEditableDomHelper(),cursor=dom.getElement(id);goog.dom.Range.createFromNodeContents(cursor).select();return goog.testing.events.fireKeySequence(cursor,goog.events.KeyCodes.ENTER)}function makeField(id,classnameRequiredToSplitBlockquote){var field=new goog.editor.Field(id);field.registerPlugin(new goog.editor.plugins.EnterHandler);field.registerPlugin(new goog.editor.plugins.Blockquote(classnameRequiredToSplitBlockquote));goog.events.listen(field,goog.editor.Field.EventType.BEFORECHANGE,function(){firedBeforeChange=!0});goog.events.listen(field,goog.editor.Field.EventType.DELAYEDCHANGE,function(){firedDelayedChange=!0});return field}function resetChangeFlags(){waitForChangeEvents();firedBeforeChange=firedDelayedChange=!1}function assertChangeFlags(){assert("Beforechange should have fired",firedBeforeChange);assert("Delayedchange should have fired",firedDelayedChange)}function waitForChangeEvents(){clock.tick(goog.editor.Field.DELAYED_CHANGE_FREQUENCY+goog.editor.Field.CHANGE_FREQUENCY)}function getNbsp(){return goog.userAgent.WEBKIT&&!goog.userAgent.isVersionOrHigher("528")||goog.userAgent.OPERA?"\xA0":"&nbsp;"}function testPrepareContent(){setUpFields(!0);assertPreparedContents("hi","hi");assertPreparedContents(goog.editor.BrowserFeature.COLLAPSES_EMPTY_NODES?"<br>":"","   ")}function assertPreparedContents(expected,original){assertEquals(expected,field1.reduceOp_(goog.editor.Plugin.Op.PREPARE_CONTENTS_HTML,original))}function testDeleteW3CSimple(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="<div>abcd</div>";var range=goog.dom.Range.createFromNodes(container.firstChild.firstChild,1,container.firstChild.firstChild,3);range.select();goog.editor.plugins.EnterHandler.deleteW3cRange_(range);goog.testing.dom.assertHtmlContentsMatch("<div>ad</div>",container)}}function testDeleteW3CAll(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="<div>abcd</div>";var range=goog.dom.Range.createFromNodes(container.firstChild.firstChild,0,container.firstChild.firstChild,4);range.select();goog.editor.plugins.EnterHandler.deleteW3cRange_(range);goog.testing.dom.assertHtmlContentsMatch("<div>&nbsp;</div>",container)}}function testDeleteW3CPartialEnd(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="<div>ab</div><div>cd</div>";var range=goog.dom.Range.createFromNodes(container.firstChild.firstChild,1,container.lastChild.firstChild,1);range.select();goog.editor.plugins.EnterHandler.deleteW3cRange_(range);goog.testing.dom.assertHtmlContentsMatch("<div>ad</div>",container)}}function testDeleteW3CNonPartialEnd(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="<div>ab</div><div>cd</div>";var range=goog.dom.Range.createFromNodes(container.firstChild.firstChild,1,container.lastChild.firstChild,2);range.select();goog.editor.plugins.EnterHandler.deleteW3cRange_(range);goog.testing.dom.assertHtmlContentsMatch("<div>a</div>",container)}}function testIsInOneContainer(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="<div><br></div>";var div=container.firstChild,range=goog.dom.Range.createFromNodes(div,0,div,1);range.select();assertTrue("Selection must be recognized as being in one container",goog.editor.plugins.EnterHandler.isInOneContainerW3c_(range))}}function testDeletingEndNodesWithNoNewLine(){if(goog.editor.BrowserFeature.HAS_W3C_RANGES){container.innerHTML="a<div>b</div><div><br></div><div>c</div><div>d</div>";var range=goog.dom.Range.createFromNodes(container.childNodes[2],0,container.childNodes[4].childNodes[0],1);range.select();var newRange=goog.editor.plugins.EnterHandler.deleteW3cRange_(range);goog.testing.dom.assertHtmlContentsMatch("a<div>b</div>",container);assertTrue(newRange.isCollapsed());assertEquals(container,newRange.getStartNode());assertEquals(2,newRange.getStartOffset())}}