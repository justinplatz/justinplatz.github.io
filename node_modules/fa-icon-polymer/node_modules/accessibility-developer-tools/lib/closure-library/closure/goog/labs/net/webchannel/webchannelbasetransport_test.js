goog.provide("goog.labs.net.webChannel.webChannelBaseTransportTest");goog.require("goog.events");goog.require("goog.functions");goog.require("goog.json");goog.require("goog.labs.net.webChannel.ChannelRequest");goog.require("goog.labs.net.webChannel.WebChannelBase");goog.require("goog.labs.net.webChannel.WebChannelBaseTransport");goog.require("goog.net.WebChannel");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.jsunit");goog.setTestOnly("goog.labs.net.webChannel.webChannelBaseTransportTest");var webChannel,channelUrl="http://127.0.0.1:8080/channel",stubs=new goog.testing.PropertyReplacer;function shouldRunTests(){return goog.labs.net.webChannel.ChannelRequest.supportsXhrStreaming()}function setUp(){}function tearDown(){goog.dispose(webChannel);stubs.reset()}function stubChannelRequest(){stubs.set(goog.labs.net.webChannel.ChannelRequest,"supportsXhrStreaming",goog.functions.FALSE)}function testUnsupportedTransports(){stubChannelRequest();var err=assertThrows(function(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport});assertContains("error",err.message)}function testOpenWithUrl(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport;webChannel=webChannelTransport.createWebChannel(channelUrl);var eventFired=!1;goog.events.listen(webChannel,goog.net.WebChannel.EventType.OPEN,function(e){eventFired=!0});webChannel.open();assertFalse(eventFired);var channel=webChannel.channel_;assertNotNull(channel);simulateOpenEvent(channel);assertTrue(eventFired)}function testOpenWithTestUrl(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={testUrl:channelUrl+"/footest"};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var testPath=webChannel.channel_.connectionTest_.path_;assertNotNullNorUndefined(testPath)}function testOpenWithCustomHeaders(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={messageHeaders:{"foo-key":"foo-value"}};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var extraHeaders_=webChannel.channel_.extraHeaders_;assertNotNullNorUndefined(extraHeaders_);assertEquals("foo-value",extraHeaders_["foo-key"]);assertEquals(void 0,extraHeaders_["X-Client-Protocol"])}function testClientProtocolHeaderRequired(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={clientProtocolHeaderRequired:!0};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var extraHeaders_=webChannel.channel_.extraHeaders_;assertNotNullNorUndefined(extraHeaders_);assertEquals("webchannel",extraHeaders_["X-Client-Protocol"])}function testClientProtocolHeaderNotRequiredByDefault(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport;webChannel=webChannelTransport.createWebChannel(channelUrl);webChannel.open();var extraHeaders_=webChannel.channel_.extraHeaders_;assertNull(extraHeaders_)}function testClientProtocolHeaderRequiredWithCustomHeader(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={clientProtocolHeaderRequired:!0,messageHeaders:{"foo-key":"foo-value"}};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var extraHeaders_=webChannel.channel_.extraHeaders_;assertNotNullNorUndefined(extraHeaders_);assertEquals("foo-value",extraHeaders_["foo-key"]);assertEquals("webchannel",extraHeaders_["X-Client-Protocol"])}function testOpenWithCustomParams(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={messageUrlParams:{"foo-key":"foo-value"}};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var extraParams=webChannel.channel_.extraParams_;assertNotNullNorUndefined(extraParams)}function testOpenWithHttpSessionIdParam(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={httpSessionIdParam:"xsessionid"};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var httpSessionIdParam=webChannel.channel_.getHttpSessionIdParam();assertEquals("xsessionid",httpSessionIdParam)}function testOpenWithDuplicatedHttpSessionIdParam(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={messageUrlParams:{xsessionid:"abcd1234"},httpSessionIdParam:"xsessionid"};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();var httpSessionIdParam=webChannel.channel_.getHttpSessionIdParam();assertEquals("xsessionid",httpSessionIdParam);var extraParams=webChannel.channel_.extraParams_;assertUndefined(extraParams.xsessionid)}function testOpenWithCorsEnabled(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={supportsCrossDomainXhr:!0};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();assertTrue(webChannel.channel_.supportsCrossDomainXhrs_)}function testSendRawJson(){var channelMsg;stubs.set(goog.labs.net.webChannel.WebChannelBase.prototype,"sendMap",function(message){channelMsg=message});var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport,options={sendRawJson:!0};webChannel=webChannelTransport.createWebChannel(channelUrl,options);webChannel.open();webChannel.send({foo:"bar"});var receivedMsg=goog.json.parse(channelMsg.__data__);assertEquals("bar",receivedMsg.foo)}function testOpenThenCloseChannel(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport;webChannel=webChannelTransport.createWebChannel(channelUrl);var eventFired=!1;goog.events.listen(webChannel,goog.net.WebChannel.EventType.CLOSE,function(e){eventFired=!0});webChannel.open();assertFalse(eventFired);var channel=webChannel.channel_;assertNotNull(channel);simulateCloseEvent(channel);assertTrue(eventFired)}function testChannelError(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport;webChannel=webChannelTransport.createWebChannel(channelUrl);var eventFired=!1;goog.events.listen(webChannel,goog.net.WebChannel.EventType.ERROR,function(e){eventFired=!0;assertEquals(goog.net.WebChannel.ErrorStatus.NETWORK_ERROR,e.status)});webChannel.open();assertFalse(eventFired);var channel=webChannel.channel_;assertNotNull(channel);simulateErrorEvent(channel);assertTrue(eventFired)}function testChannelMessage(){var webChannelTransport=new goog.labs.net.webChannel.WebChannelBaseTransport;webChannel=webChannelTransport.createWebChannel(channelUrl);var eventFired=!1,data="foo";goog.events.listen(webChannel,goog.net.WebChannel.EventType.MESSAGE,function(e){eventFired=!0;assertEquals(e.data,data)});webChannel.open();assertFalse(eventFired);var channel=webChannel.channel_;assertNotNull(channel);simulateMessageEvent(channel,data);assertTrue(eventFired)}function simulateOpenEvent(channel){assertNotNull(channel.getHandler());channel.getHandler().channelOpened()}function simulateCloseEvent(channel){assertNotNull(channel.getHandler());channel.getHandler().channelClosed()}function simulateErrorEvent(channel){assertNotNull(channel.getHandler());channel.getHandler().channelError()}function simulateMessageEvent(channel,data){assertNotNull(channel.getHandler());channel.getHandler().channelHandleArray(channel,data)}