goog.provide("goog.labs.net.webChannel.WebChannelBase");goog.require("goog.Uri");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.debug.TextFormatter");goog.require("goog.json");goog.require("goog.labs.net.webChannel.BaseTestChannel");goog.require("goog.labs.net.webChannel.Channel");goog.require("goog.labs.net.webChannel.ChannelRequest");goog.require("goog.labs.net.webChannel.ConnectionState");goog.require("goog.labs.net.webChannel.ForwardChannelRequestPool");goog.require("goog.labs.net.webChannel.WebChannelDebug");goog.require("goog.labs.net.webChannel.Wire");goog.require("goog.labs.net.webChannel.WireV8");goog.require("goog.labs.net.webChannel.netUtils");goog.require("goog.labs.net.webChannel.requestStats");goog.require("goog.labs.net.webChannel.requestStats.Stat");goog.require("goog.log");goog.require("goog.net.XhrIo");goog.require("goog.object");goog.require("goog.string");goog.require("goog.structs");goog.require("goog.structs.CircularBuffer");goog.scope(function(){var _Mathfloor=Math.floor,BaseTestChannel=goog.labs.net.webChannel.BaseTestChannel,ChannelRequest=goog.labs.net.webChannel.ChannelRequest,ConnectionState=goog.labs.net.webChannel.ConnectionState,ForwardChannelRequestPool=goog.labs.net.webChannel.ForwardChannelRequestPool,WebChannelDebug=goog.labs.net.webChannel.WebChannelDebug,Wire=goog.labs.net.webChannel.Wire,WireV8=goog.labs.net.webChannel.WireV8,netUtils=goog.labs.net.webChannel.netUtils,requestStats=goog.labs.net.webChannel.requestStats;goog.labs.net.webChannel.WebChannelBase=function(opt_options,opt_clientVersion,opt_conn){this.clientVersion_=opt_clientVersion||null;this.outgoingMaps_=[];this.pendingMaps_=[];this.channelDebug_=new WebChannelDebug;this.ConnState_=opt_conn||new ConnectionState;this.extraHeaders_=null;this.extraParams_=null;this.httpSessionIdParam_=null;this.httpSessionId_=null;this.backChannelRequest_=null;this.path_=null;this.forwardChannelUri_=null;this.backChannelUri_=null;this.hostPrefix_=null;this.allowHostPrefix_=!0;this.nextRid_=0;this.nextMapId_=0;this.failFast_=!1;this.handler_=null;this.forwardChannelTimerId_=null;this.backChannelTimerId_=null;this.deadBackChannelTimerId_=null;this.connectionTest_=null;this.useChunked_=null;this.allowChunkedMode_=!0;this.lastArrayId_=-1;this.lastPostResponseArrayId_=-1;this.lastStatusCode_=-1;this.forwardChannelRetryCount_=0;this.backChannelRetryCount_=0;this.backChannelAttemptId_=0;this.baseRetryDelayMs_=1e3*5;this.retryDelaySeedMs_=1e3*10;this.forwardChannelMaxRetries_=2;this.forwardChannelRequestTimeoutMs_=1e3*20;this.readyStateChangeThrottleMs_=0;this.supportsCrossDomainXhrs_=opt_options&&opt_options.supportsCrossDomainXhr||!1;this.sid_="";this.forwardChannelRequestPool_=new ForwardChannelRequestPool(opt_options&&opt_options.concurrentRequestLimit);this.wireCodec_=new WireV8};var WebChannelBase=goog.labs.net.webChannel.WebChannelBase;WebChannelBase.prototype.channelVersion_=Wire.LATEST_CHANNEL_VERSION;WebChannelBase.State={CLOSED:0,INIT:1,OPENING:2,OPENED:3};WebChannelBase.prototype.state_=WebChannelBase.State.INIT;WebChannelBase.FORWARD_CHANNEL_RETRY_TIMEOUT=1e3*20;WebChannelBase.BACK_CHANNEL_MAX_RETRIES=3;WebChannelBase.RTT_ESTIMATE=1e3*3;WebChannelBase.INACTIVE_CHANNEL_RETRY_FACTOR=2;WebChannelBase.Error={OK:0,REQUEST_FAILED:2,LOGGED_OUT:4,NO_DATA:5,UNKNOWN_SESSION_ID:6,STOP:7,NETWORK:8,BAD_DATA:10,BAD_RESPONSE:11};WebChannelBase.ChannelType_={FORWARD_CHANNEL:1,BACK_CHANNEL:2};WebChannelBase.MAX_MAPS_PER_REQUEST_=1e3;WebChannelBase.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF=37500;WebChannelBase.prototype.getForwardChannelRequestPool=function(){return this.forwardChannelRequestPool_};WebChannelBase.prototype.getWireCodec=function(){return this.wireCodec_};WebChannelBase.prototype.getChannelDebug=function(){return this.channelDebug_};WebChannelBase.prototype.setChannelDebug=function(channelDebug){this.channelDebug_=channelDebug};WebChannelBase.prototype.connect=function(testPath,channelPath,opt_extraParams,opt_oldSessionId,opt_oldArrayId){this.channelDebug_.debug("connect()");requestStats.notifyStatEvent(requestStats.Stat.CONNECT_ATTEMPT);this.path_=channelPath;this.extraParams_=opt_extraParams||{};if(opt_oldSessionId&&goog.isDef(opt_oldArrayId)){this.extraParams_.OSID=opt_oldSessionId;this.extraParams_.OAID=opt_oldArrayId}this.connectTest_(testPath)};WebChannelBase.prototype.disconnect=function(){this.channelDebug_.debug("disconnect()");this.cancelRequests_();if(this.state_==WebChannelBase.State.OPENED){var rid=this.nextRid_++,uri=this.forwardChannelUri_.clone();uri.setParameterValue("SID",this.sid_);uri.setParameterValue("RID",rid);uri.setParameterValue("TYPE","terminate");this.addAdditionalParams_(uri);var request=ChannelRequest.createChannelRequest(this,this.channelDebug_,this.sid_,rid);request.sendCloseRequest(uri)}this.onClose_()};WebChannelBase.prototype.getSessionId=function(){return this.sid_};WebChannelBase.prototype.connectTest_=function(testPath){this.channelDebug_.debug("connectTest_()");if(!this.okToMakeRequest_()){return}this.connectionTest_=new BaseTestChannel(this,this.channelDebug_);this.connectionTest_.setExtraHeaders(this.extraHeaders_);this.connectionTest_.connect(testPath)};WebChannelBase.prototype.connectChannel_=function(){this.channelDebug_.debug("connectChannel_()");this.ensureInState_(WebChannelBase.State.INIT,WebChannelBase.State.CLOSED);this.forwardChannelUri_=this.getForwardChannelUri(this.path_);this.ensureForwardChannel_()};WebChannelBase.prototype.cancelRequests_=function(){if(this.connectionTest_){this.connectionTest_.abort();this.connectionTest_=null}if(this.backChannelRequest_){this.backChannelRequest_.cancel();this.backChannelRequest_=null}if(this.backChannelTimerId_){goog.global.clearTimeout(this.backChannelTimerId_);this.backChannelTimerId_=null}this.clearDeadBackchannelTimer_();this.forwardChannelRequestPool_.cancel();if(this.forwardChannelTimerId_){goog.global.clearTimeout(this.forwardChannelTimerId_);this.forwardChannelTimerId_=null}};WebChannelBase.prototype.getExtraHeaders=function(){return this.extraHeaders_};WebChannelBase.prototype.setExtraHeaders=function(extraHeaders){this.extraHeaders_=extraHeaders};WebChannelBase.prototype.setHttpSessionIdParam=function(httpSessionIdParam){this.httpSessionIdParam_=httpSessionIdParam};WebChannelBase.prototype.getHttpSessionIdParam=function(){return this.httpSessionIdParam_};WebChannelBase.prototype.setHttpSessionId=function(httpSessionId){this.httpSessionId_=httpSessionId};WebChannelBase.prototype.getHttpSessionId=function(){return this.httpSessionId_};WebChannelBase.prototype.setReadyStateChangeThrottle=function(throttle){this.readyStateChangeThrottleMs_=throttle};WebChannelBase.prototype.setSupportsCrossDomainXhrs=function(supportCrossDomain){this.supportsCrossDomainXhrs_=supportCrossDomain};WebChannelBase.prototype.getHandler=function(){return this.handler_};WebChannelBase.prototype.setHandler=function(handler){this.handler_=handler};WebChannelBase.prototype.getAllowHostPrefix=function(){return this.allowHostPrefix_};WebChannelBase.prototype.setAllowHostPrefix=function(allowHostPrefix){this.allowHostPrefix_=allowHostPrefix};WebChannelBase.prototype.isBuffered=function(){return!this.useChunked_};WebChannelBase.prototype.getAllowChunkedMode=function(){return this.allowChunkedMode_};WebChannelBase.prototype.setAllowChunkedMode=function(allowChunkedMode){this.allowChunkedMode_=allowChunkedMode};WebChannelBase.prototype.sendMap=function(map,opt_context){goog.asserts.assert(this.state_!=WebChannelBase.State.CLOSED,"Invalid operation: sending map when state is closed");if(this.outgoingMaps_.length==WebChannelBase.MAX_MAPS_PER_REQUEST_){this.channelDebug_.severe("Already have "+WebChannelBase.MAX_MAPS_PER_REQUEST_+" queued maps upon queueing "+goog.json.serialize(map))}this.outgoingMaps_.push(new Wire.QueuedMap(this.nextMapId_++,map,opt_context));if(this.state_==WebChannelBase.State.OPENING||this.state_==WebChannelBase.State.OPENED){this.ensureForwardChannel_()}};WebChannelBase.prototype.setFailFast=function(failFast){this.failFast_=failFast;this.channelDebug_.info("setFailFast: "+failFast);if((this.forwardChannelRequestPool_.hasPendingRequest()||this.forwardChannelTimerId_)&&this.forwardChannelRetryCount_>this.getForwardChannelMaxRetries()){this.channelDebug_.info("Retry count "+this.forwardChannelRetryCount_+" > new maxRetries "+this.getForwardChannelMaxRetries()+". Fail immediately!");if(!this.forwardChannelRequestPool_.forceComplete(goog.bind(this.onRequestComplete,this))){goog.global.clearTimeout(this.forwardChannelTimerId_);this.forwardChannelTimerId_=null;this.signalError_(WebChannelBase.Error.REQUEST_FAILED)}}};WebChannelBase.prototype.getForwardChannelMaxRetries=function(){return this.failFast_?0:this.forwardChannelMaxRetries_};WebChannelBase.prototype.setForwardChannelMaxRetries=function(retries){this.forwardChannelMaxRetries_=retries};WebChannelBase.prototype.setForwardChannelRequestTimeout=function(timeoutMs){this.forwardChannelRequestTimeoutMs_=timeoutMs};WebChannelBase.prototype.getBackChannelMaxRetries=function(){return WebChannelBase.BACK_CHANNEL_MAX_RETRIES};WebChannelBase.prototype.isClosed=function(){return this.state_==WebChannelBase.State.CLOSED};WebChannelBase.prototype.getState=function(){return this.state_};WebChannelBase.prototype.getLastStatusCode=function(){return this.lastStatusCode_};WebChannelBase.prototype.getLastArrayId=function(){return this.lastArrayId_};WebChannelBase.prototype.hasOutstandingRequests=function(){return 0!=this.getOutstandingRequests_()};WebChannelBase.prototype.getOutstandingRequests_=function(){var count=0;if(this.backChannelRequest_){count++}count+=this.forwardChannelRequestPool_.getRequestCount();return count};WebChannelBase.prototype.ensureForwardChannel_=function(){if(this.forwardChannelRequestPool_.isFull()){return}if(this.forwardChannelTimerId_){return}this.forwardChannelTimerId_=requestStats.setTimeout(goog.bind(this.onStartForwardChannelTimer_,this),0);this.forwardChannelRetryCount_=0};WebChannelBase.prototype.maybeRetryForwardChannel_=function(request){if(this.forwardChannelRequestPool_.isFull()||this.forwardChannelTimerId_){this.channelDebug_.severe("Request already in progress");return!1}if(this.state_==WebChannelBase.State.INIT||this.forwardChannelRetryCount_>=this.getForwardChannelMaxRetries()){return!1}this.channelDebug_.debug("Going to retry POST");this.forwardChannelTimerId_=requestStats.setTimeout(goog.bind(this.onStartForwardChannelTimer_,this,request),this.getRetryTime_(this.forwardChannelRetryCount_));this.forwardChannelRetryCount_++;return!0};WebChannelBase.prototype.onStartForwardChannelTimer_=function(opt_retryRequest){this.forwardChannelTimerId_=null;this.startForwardChannel_(opt_retryRequest)};WebChannelBase.prototype.startForwardChannel_=function(opt_retryRequest){this.channelDebug_.debug("startForwardChannel_");if(!this.okToMakeRequest_()){return}else if(this.state_==WebChannelBase.State.INIT){if(opt_retryRequest){this.channelDebug_.severe("Not supposed to retry the open");return}this.open_();this.state_=WebChannelBase.State.OPENING}else if(this.state_==WebChannelBase.State.OPENED){if(opt_retryRequest){this.makeForwardChannelRequest_(opt_retryRequest);return}if(0==this.outgoingMaps_.length){this.channelDebug_.debug("startForwardChannel_ returned: "+"nothing to send");return}if(this.forwardChannelRequestPool_.isFull()){this.channelDebug_.severe("startForwardChannel_ returned: "+"connection already in progress");return}this.makeForwardChannelRequest_();this.channelDebug_.debug("startForwardChannel_ finished, sent request")}};WebChannelBase.prototype.open_=function(){this.channelDebug_.debug("open_()");this.nextRid_=_Mathfloor(1e5*Math.random());var rid=this.nextRid_++,request=ChannelRequest.createChannelRequest(this,this.channelDebug_,"",rid);request.setExtraHeaders(this.extraHeaders_);var requestText=this.dequeueOutgoingMaps_(),uri=this.forwardChannelUri_.clone();uri.setParameterValue("RID",rid);if(this.clientVersion_){uri.setParameterValue("CVER",this.clientVersion_)}this.addAdditionalParams_(uri);this.forwardChannelRequestPool_.addRequest(request);request.xmlHttpPost(uri,requestText,!0)};WebChannelBase.prototype.makeForwardChannelRequest_=function(opt_retryRequest){var _Mathround=Math.round,rid,requestText;if(opt_retryRequest){this.requeuePendingMaps_();rid=this.nextRid_-1;requestText=this.dequeueOutgoingMaps_()}else{rid=this.nextRid_++;requestText=this.dequeueOutgoingMaps_()}var uri=this.forwardChannelUri_.clone();uri.setParameterValue("SID",this.sid_);uri.setParameterValue("RID",rid);uri.setParameterValue("AID",this.lastArrayId_);this.addAdditionalParams_(uri);var request=ChannelRequest.createChannelRequest(this,this.channelDebug_,this.sid_,rid,this.forwardChannelRetryCount_+1);request.setExtraHeaders(this.extraHeaders_);request.setTimeout(_Mathround(.5*this.forwardChannelRequestTimeoutMs_)+_Mathround(.5*this.forwardChannelRequestTimeoutMs_*Math.random()));this.forwardChannelRequestPool_.addRequest(request);request.xmlHttpPost(uri,requestText,!0)};WebChannelBase.prototype.addAdditionalParams_=function(uri){if(this.handler_){var params=this.handler_.getAdditionalParams(this);if(params){goog.structs.forEach(params,function(value,key,coll){uri.setParameterValue(key,value)})}}};WebChannelBase.prototype.dequeueOutgoingMaps_=function(){var count=Math.min(this.outgoingMaps_.length,WebChannelBase.MAX_MAPS_PER_REQUEST_),badMapHandler=this.handler_?goog.bind(this.handler_.badMapError,this.handler_,this):null,result=this.wireCodec_.encodeMessageQueue(this.outgoingMaps_,count,badMapHandler);this.pendingMaps_=this.pendingMaps_.concat(this.outgoingMaps_.splice(0,count));return result};WebChannelBase.prototype.requeuePendingMaps_=function(){this.outgoingMaps_=this.pendingMaps_.concat(this.outgoingMaps_);this.pendingMaps_.length=0};WebChannelBase.prototype.ensureBackChannel_=function(){if(this.backChannelRequest_){return}if(this.backChannelTimerId_){return}this.backChannelAttemptId_=1;this.backChannelTimerId_=requestStats.setTimeout(goog.bind(this.onStartBackChannelTimer_,this),0);this.backChannelRetryCount_=0};WebChannelBase.prototype.maybeRetryBackChannel_=function(){if(this.backChannelRequest_||this.backChannelTimerId_){this.channelDebug_.severe("Request already in progress");return!1}if(this.backChannelRetryCount_>=this.getBackChannelMaxRetries()){return!1}this.channelDebug_.debug("Going to retry GET");this.backChannelAttemptId_++;this.backChannelTimerId_=requestStats.setTimeout(goog.bind(this.onStartBackChannelTimer_,this),this.getRetryTime_(this.backChannelRetryCount_));this.backChannelRetryCount_++;return!0};WebChannelBase.prototype.onStartBackChannelTimer_=function(){this.backChannelTimerId_=null;this.startBackChannel_()};WebChannelBase.prototype.startBackChannel_=function(){if(!this.okToMakeRequest_()){return}this.channelDebug_.debug("Creating new HttpRequest");this.backChannelRequest_=ChannelRequest.createChannelRequest(this,this.channelDebug_,this.sid_,"rpc",this.backChannelAttemptId_);this.backChannelRequest_.setExtraHeaders(this.extraHeaders_);this.backChannelRequest_.setReadyStateChangeThrottle(this.readyStateChangeThrottleMs_);var uri=this.backChannelUri_.clone();uri.setParameterValue("RID","rpc");uri.setParameterValue("SID",this.sid_);uri.setParameterValue("CI",this.useChunked_?"0":"1");uri.setParameterValue("AID",this.lastArrayId_);this.addAdditionalParams_(uri);uri.setParameterValue("TYPE","xmlhttp");this.backChannelRequest_.xmlHttpGet(uri,!0,this.hostPrefix_,!1);this.channelDebug_.debug("New Request created")};WebChannelBase.prototype.okToMakeRequest_=function(){if(this.handler_){var result=this.handler_.okToMakeRequest(this);if(result!=WebChannelBase.Error.OK){this.channelDebug_.debug("Handler returned error code from okToMakeRequest");this.signalError_(result);return!1}}return!0};WebChannelBase.prototype.testConnectionFinished=function(testChannel,useChunked){this.channelDebug_.debug("Test Connection Finished");var clientProtocol=testChannel.getClientProtocol();if(clientProtocol){this.forwardChannelRequestPool_.applyClientProtocol(clientProtocol)}this.useChunked_=this.allowChunkedMode_&&useChunked;this.lastStatusCode_=testChannel.getLastStatusCode();this.connectChannel_()};WebChannelBase.prototype.testConnectionFailure=function(testChannel,errorCode){this.channelDebug_.debug("Test Connection Failed");this.lastStatusCode_=testChannel.getLastStatusCode();this.signalError_(WebChannelBase.Error.REQUEST_FAILED)};WebChannelBase.prototype.onRequestData=function(request,responseText){if(this.state_==WebChannelBase.State.CLOSED||this.backChannelRequest_!=request&&!this.forwardChannelRequestPool_.hasRequest(request)){return}this.lastStatusCode_=request.getLastStatusCode();if(this.forwardChannelRequestPool_.hasRequest(request)&&this.state_==WebChannelBase.State.OPENED){var response;try{response=this.wireCodec_.decodeMessage(responseText)}catch(ex){response=null}if(goog.isArray(response)&&3==response.length){this.handlePostResponse_(response,request)}else{this.channelDebug_.debug("Bad POST response data returned");this.signalError_(WebChannelBase.Error.BAD_RESPONSE)}}else{if(this.backChannelRequest_==request){this.clearDeadBackchannelTimer_()}if(!goog.string.isEmptyOrWhitespace(responseText)){var response=this.wireCodec_.decodeMessage(responseText);this.onInput_(response)}}};WebChannelBase.prototype.handlePostResponse_=function(responseValues,forwardReq){if(0==responseValues[0]){this.handleBackchannelMissing_(forwardReq);return}this.lastPostResponseArrayId_=responseValues[1];var outstandingArrays=this.lastPostResponseArrayId_-this.lastArrayId_;if(0<outstandingArrays){var numOutstandingBackchannelBytes=responseValues[2];this.channelDebug_.debug(numOutstandingBackchannelBytes+" bytes (in "+outstandingArrays+" arrays) are outstanding on the BackChannel");if(!this.shouldRetryBackChannel_(numOutstandingBackchannelBytes)){return}if(!this.deadBackChannelTimerId_){this.deadBackChannelTimerId_=requestStats.setTimeout(goog.bind(this.onBackChannelDead_,this),2*WebChannelBase.RTT_ESTIMATE)}}};WebChannelBase.prototype.handleBackchannelMissing_=function(forwardReq){this.channelDebug_.debug("Server claims our backchannel is missing.");if(this.backChannelTimerId_){this.channelDebug_.debug("But we are currently starting the request.");return}else if(!this.backChannelRequest_){this.channelDebug_.warning("We do not have a BackChannel established")}else if(this.backChannelRequest_.getRequestStartTime()+WebChannelBase.RTT_ESTIMATE<forwardReq.getRequestStartTime()){this.clearDeadBackchannelTimer_();this.backChannelRequest_.cancel();this.backChannelRequest_=null}else{return}this.maybeRetryBackChannel_();requestStats.notifyStatEvent(requestStats.Stat.BACKCHANNEL_MISSING)};WebChannelBase.prototype.shouldRetryBackChannel_=function(outstandingBytes){return outstandingBytes<WebChannelBase.OUTSTANDING_DATA_BACKCHANNEL_RETRY_CUTOFF&&!this.isBuffered()&&0==this.backChannelRetryCount_};WebChannelBase.prototype.correctHostPrefix=function(serverHostPrefix){if(this.allowHostPrefix_){if(this.handler_){return this.handler_.correctHostPrefix(serverHostPrefix)}return serverHostPrefix}return null};WebChannelBase.prototype.onBackChannelDead_=function(){if(goog.isDefAndNotNull(this.deadBackChannelTimerId_)){this.deadBackChannelTimerId_=null;this.backChannelRequest_.cancel();this.backChannelRequest_=null;this.maybeRetryBackChannel_();requestStats.notifyStatEvent(requestStats.Stat.BACKCHANNEL_DEAD)}};WebChannelBase.prototype.clearDeadBackchannelTimer_=function(){if(goog.isDefAndNotNull(this.deadBackChannelTimerId_)){goog.global.clearTimeout(this.deadBackChannelTimerId_);this.deadBackChannelTimerId_=null}};WebChannelBase.isFatalError_=function(error,statusCode){return error==ChannelRequest.Error.UNKNOWN_SESSION_ID||error==ChannelRequest.Error.STATUS&&0<statusCode};WebChannelBase.prototype.onRequestComplete=function(request){this.channelDebug_.debug("Request complete");var type;if(this.backChannelRequest_==request){this.clearDeadBackchannelTimer_();this.backChannelRequest_=null;type=WebChannelBase.ChannelType_.BACK_CHANNEL}else if(this.forwardChannelRequestPool_.hasRequest(request)){this.forwardChannelRequestPool_.removeRequest(request);type=WebChannelBase.ChannelType_.FORWARD_CHANNEL}else{return}this.lastStatusCode_=request.getLastStatusCode();if(this.state_==WebChannelBase.State.CLOSED){return}if(request.getSuccess()){if(type==WebChannelBase.ChannelType_.FORWARD_CHANNEL){var size=request.getPostData()?request.getPostData().length:0;requestStats.notifyTimingEvent(size,goog.now()-request.getRequestStartTime(),this.forwardChannelRetryCount_);this.ensureForwardChannel_();this.onSuccess_();this.pendingMaps_.length=0}else{this.ensureBackChannel_()}return}var lastError=request.getLastError();if(!WebChannelBase.isFatalError_(lastError,this.lastStatusCode_)){this.channelDebug_.debug("Maybe retrying, last error: "+ChannelRequest.errorStringFromCode(lastError,this.lastStatusCode_));if(type==WebChannelBase.ChannelType_.FORWARD_CHANNEL){if(this.maybeRetryForwardChannel_(request)){return}}if(type==WebChannelBase.ChannelType_.BACK_CHANNEL){if(this.maybeRetryBackChannel_()){return}}this.channelDebug_.debug("Exceeded max number of retries")}else{this.channelDebug_.debug("Not retrying due to error type")}this.channelDebug_.debug("Error: HTTP request failed");switch(lastError){case ChannelRequest.Error.NO_DATA:this.signalError_(WebChannelBase.Error.NO_DATA);break;case ChannelRequest.Error.BAD_DATA:this.signalError_(WebChannelBase.Error.BAD_DATA);break;case ChannelRequest.Error.UNKNOWN_SESSION_ID:this.signalError_(WebChannelBase.Error.UNKNOWN_SESSION_ID);break;default:this.signalError_(WebChannelBase.Error.REQUEST_FAILED);break;}};WebChannelBase.prototype.getRetryTime_=function(retryCount){var retryTime=this.baseRetryDelayMs_+_Mathfloor(Math.random()*this.retryDelaySeedMs_);if(!this.isActive()){this.channelDebug_.debug("Inactive channel");retryTime=retryTime*WebChannelBase.INACTIVE_CHANNEL_RETRY_FACTOR}retryTime*=retryCount;return retryTime};WebChannelBase.prototype.setRetryDelay=function(baseDelayMs,delaySeedMs){this.baseRetryDelayMs_=baseDelayMs;this.retryDelaySeedMs_=delaySeedMs};WebChannelBase.prototype.onInput_=function(respArray){for(var batch=this.handler_&&this.handler_.channelHandleMultipleArrays?[]:null,i=0,nextArray;i<respArray.length;i++){nextArray=respArray[i];this.lastArrayId_=nextArray[0];nextArray=nextArray[1];if(this.state_==WebChannelBase.State.OPENING){if("c"==nextArray[0]){this.sid_=nextArray[1];this.hostPrefix_=this.correctHostPrefix(nextArray[2]);var negotiatedVersion=nextArray[3];if(goog.isDefAndNotNull(negotiatedVersion)){this.channelVersion_=negotiatedVersion}this.state_=WebChannelBase.State.OPENED;if(this.handler_){this.handler_.channelOpened(this)}this.backChannelUri_=this.getBackChannelUri(this.hostPrefix_,this.path_);this.ensureBackChannel_()}else if("stop"==nextArray[0]||"close"==nextArray[0]){this.signalError_(WebChannelBase.Error.STOP)}}else if(this.state_==WebChannelBase.State.OPENED){if("stop"==nextArray[0]||"close"==nextArray[0]){if(batch&&!goog.array.isEmpty(batch)){this.handler_.channelHandleMultipleArrays(this,batch);batch.length=0}if("stop"==nextArray[0]){this.signalError_(WebChannelBase.Error.STOP)}else{this.disconnect()}}else if("noop"==nextArray[0]){}else{if(batch){batch.push(nextArray)}else if(this.handler_){this.handler_.channelHandleArray(this,nextArray)}}this.backChannelRetryCount_=0}}if(batch&&!goog.array.isEmpty(batch)){this.handler_.channelHandleMultipleArrays(this,batch)}};WebChannelBase.prototype.ensureInState_=function(var_args){goog.asserts.assert(goog.array.contains(arguments,this.state_),"Unexpected channel state: %s",this.state_)};WebChannelBase.prototype.signalError_=function(error){this.channelDebug_.info("Error code "+error);if(error==WebChannelBase.Error.REQUEST_FAILED){var imageUri=null;if(this.handler_){imageUri=this.handler_.getNetworkTestImageUri(this)}netUtils.testNetwork(goog.bind(this.testNetworkCallback_,this),imageUri)}else{requestStats.notifyStatEvent(requestStats.Stat.ERROR_OTHER)}this.onError_(error)};WebChannelBase.prototype.testNetworkCallback_=function(networkUp){if(networkUp){this.channelDebug_.info("Successfully pinged google.com");requestStats.notifyStatEvent(requestStats.Stat.ERROR_OTHER)}else{this.channelDebug_.info("Failed to ping google.com");requestStats.notifyStatEvent(requestStats.Stat.ERROR_NETWORK);this.onError_(WebChannelBase.Error.NETWORK)}};WebChannelBase.prototype.onSuccess_=function(){if(this.handler_){this.handler_.channelSuccess(this,this.pendingMaps_)}};WebChannelBase.prototype.onError_=function(error){this.channelDebug_.debug("HttpChannel: error - "+error);this.state_=WebChannelBase.State.CLOSED;if(this.handler_){this.handler_.channelError(this,error)}this.onClose_();this.cancelRequests_()};WebChannelBase.prototype.onClose_=function(){this.state_=WebChannelBase.State.CLOSED;this.lastStatusCode_=-1;if(this.handler_){if(0==this.pendingMaps_.length&&0==this.outgoingMaps_.length){this.handler_.channelClosed(this)}else{this.channelDebug_.debug("Number of undelivered maps"+", pending: "+this.pendingMaps_.length+", outgoing: "+this.outgoingMaps_.length);var copyOfPendingMaps=goog.array.clone(this.pendingMaps_),copyOfUndeliveredMaps=goog.array.clone(this.outgoingMaps_);this.pendingMaps_.length=0;this.outgoingMaps_.length=0;this.handler_.channelClosed(this,copyOfPendingMaps,copyOfUndeliveredMaps)}}};WebChannelBase.prototype.getForwardChannelUri=function(path){var uri=this.createDataUri(null,path);this.channelDebug_.debug("GetForwardChannelUri: "+uri);return uri};WebChannelBase.prototype.getConnectionState=function(){return this.ConnState_};WebChannelBase.prototype.getBackChannelUri=function(hostPrefix,path){var uri=this.createDataUri(this.shouldUseSecondaryDomains()?hostPrefix:null,path);this.channelDebug_.debug("GetBackChannelUri: "+uri);return uri};WebChannelBase.prototype.createDataUri=function(hostPrefix,path,opt_overridePort){var uri=goog.Uri.parse(path),uriAbsolute=""!=uri.getDomain();if(uriAbsolute){if(hostPrefix){uri.setDomain(hostPrefix+"."+uri.getDomain())}uri.setPort(opt_overridePort||uri.getPort())}else{var locationPage=goog.global.location,hostName;if(hostPrefix){hostName=hostPrefix+"."+locationPage.hostname}else{hostName=locationPage.hostname}var port=opt_overridePort||locationPage.port;uri=goog.Uri.create(locationPage.protocol,null,hostName,port,path)}if(this.extraParams_){goog.object.forEach(this.extraParams_,function(value,key){uri.setParameterValue(key,value)})}var param=this.getHttpSessionIdParam(),value=this.getHttpSessionId();if(param&&value){uri.setParameterValue(param,value)}uri.setParameterValue("VER",this.channelVersion_);this.addAdditionalParams_(uri);return uri};WebChannelBase.prototype.createXhrIo=function(hostPrefix){if(hostPrefix&&!this.supportsCrossDomainXhrs_){throw Error("Can't create secondary domain capable XhrIo object.")}var xhr=new goog.net.XhrIo;xhr.setWithCredentials(this.supportsCrossDomainXhrs_);return xhr};WebChannelBase.prototype.isActive=function(){return!!this.handler_&&this.handler_.isActive(this)};WebChannelBase.prototype.shouldUseSecondaryDomains=function(){return this.supportsCrossDomainXhrs_};WebChannelBase.LogSaver={};WebChannelBase.LogSaver.buffer_=new goog.structs.CircularBuffer(1e3);WebChannelBase.LogSaver.enabled_=!1;WebChannelBase.LogSaver.formatter_=new goog.debug.TextFormatter;WebChannelBase.LogSaver.isEnabled=function(){return WebChannelBase.LogSaver.enabled_};WebChannelBase.LogSaver.setEnabled=function(enable){if(enable==WebChannelBase.LogSaver.enabled_){return}var fn=WebChannelBase.LogSaver.addLogRecord,logger=goog.log.getLogger("goog.net");if(enable){goog.log.addHandler(logger,fn)}else{goog.log.removeHandler(logger,fn)}};WebChannelBase.LogSaver.addLogRecord=function(logRecord){WebChannelBase.LogSaver.buffer_.add(WebChannelBase.LogSaver.formatter_.formatRecord(logRecord))};WebChannelBase.LogSaver.getBuffer=function(){return WebChannelBase.LogSaver.buffer_.getValues().join("")};WebChannelBase.LogSaver.clearBuffer=function(){WebChannelBase.LogSaver.buffer_.clear()};WebChannelBase.Handler=function(){};WebChannelBase.Handler.prototype.channelHandleMultipleArrays=null;WebChannelBase.Handler.prototype.okToMakeRequest=function(channel){return WebChannelBase.Error.OK};WebChannelBase.Handler.prototype.channelOpened=function(channel){};WebChannelBase.Handler.prototype.channelHandleArray=function(channel,array){};WebChannelBase.Handler.prototype.channelSuccess=function(channel,deliveredMaps){};WebChannelBase.Handler.prototype.channelError=function(channel,error){};WebChannelBase.Handler.prototype.channelClosed=function(channel,opt_pendingMaps,opt_undeliveredMaps){};WebChannelBase.Handler.prototype.getAdditionalParams=function(channel){return{}};WebChannelBase.Handler.prototype.getNetworkTestImageUri=function(channel){return null};WebChannelBase.Handler.prototype.isActive=function(channel){return!0};WebChannelBase.Handler.prototype.badMapError=function(channel,map){};WebChannelBase.Handler.prototype.correctHostPrefix=function(serverHostPrefix){return serverHostPrefix}});