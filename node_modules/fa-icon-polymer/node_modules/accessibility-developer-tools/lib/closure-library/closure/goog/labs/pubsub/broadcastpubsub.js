goog.provide("goog.labs.pubsub.BroadcastPubSub");goog.require("goog.Disposable");goog.require("goog.Timer");goog.require("goog.array");goog.require("goog.async.run");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.json");goog.require("goog.log");goog.require("goog.math");goog.require("goog.pubsub.PubSub");goog.require("goog.storage.Storage");goog.require("goog.storage.mechanism.HTML5LocalStorage");goog.require("goog.string");goog.require("goog.userAgent");goog.labs.pubsub.BroadcastPubSub=function(){goog.labs.pubsub.BroadcastPubSub.base(this,"constructor");goog.labs.pubsub.BroadcastPubSub.instances_.push(this);this.pubSub_=new goog.pubsub.PubSub;this.registerDisposable(this.pubSub_);this.handler_=new goog.events.EventHandler(this);this.registerDisposable(this.handler_);this.logger_=goog.log.getLogger("goog.labs.pubsub.BroadcastPubSub");this.mechanism_=new goog.storage.mechanism.HTML5LocalStorage;this.storage_=null;this.ie8LastEventTimes_=null;this.ie8StartupTimestamp_=goog.now()-1;if(this.mechanism_.isAvailable()){this.storage_=new goog.storage.Storage(this.mechanism_);var target=window;if(goog.labs.pubsub.BroadcastPubSub.IS_IE8_){this.ie8LastEventTimes_={};target=document}this.handler_.listen(target,goog.events.EventType.STORAGE,this.handleStorageEvent_)}};goog.inherits(goog.labs.pubsub.BroadcastPubSub,goog.Disposable);goog.labs.pubsub.BroadcastPubSub.instances_=[];goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_="_closure_bps";goog.labs.pubsub.BroadcastPubSub.prototype.handleStorageEvent_=function(e){if(goog.labs.pubsub.BroadcastPubSub.IS_IE8_){goog.async.run(this.handleIe8StorageEvent_,this);return}var browserEvent=e.getBrowserEvent();if(browserEvent.key!=goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_){return}var data=goog.json.parse(browserEvent.newValue),args=goog.isObject(data)&&data.args;if(goog.isArray(args)&&goog.array.every(args,goog.isString)){this.dispatch_(args)}else{goog.log.warning(this.logger_,"storage event contained invalid arguments")}};goog.labs.pubsub.BroadcastPubSub.prototype.dispatch_=function(args){goog.pubsub.PubSub.prototype.publish.apply(this.pubSub_,args)};goog.labs.pubsub.BroadcastPubSub.prototype.publish=function(topic,var_args){var args=goog.array.toArray(arguments);if(this.storage_){var now=goog.now(),data={args:args,timestamp:now};if(!goog.labs.pubsub.BroadcastPubSub.IS_IE8_){this.storage_.set(goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_,data);this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.STORAGE_KEY_)}else{var events=null;try{events=this.storage_.get(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}catch(ex){goog.log.error(this.logger_,"publish encountered invalid event queue at "+goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}if(!goog.isArray(events)){events=[]}var lastEvent=events[events.length-1],lastTimestamp=lastEvent&&lastEvent.timestamp||this.ie8StartupTimestamp_;if(lastTimestamp>=now){now=lastTimestamp+goog.labs.pubsub.BroadcastPubSub.IE8_TIMESTAMP_UNIQUE_OFFSET_MS_;data.timestamp=now}events.push(data);this.storage_.set(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_,events);goog.Timer.callOnce(goog.bind(this.cleanupIe8StorageEvents_,this,now),goog.labs.pubsub.BroadcastPubSub.IE8_EVENT_LIFETIME_MS_)}}if(!goog.userAgent.IE){goog.array.forEach(goog.labs.pubsub.BroadcastPubSub.instances_,function(instance){goog.async.run(goog.bind(instance.dispatch_,instance,args))})}};goog.labs.pubsub.BroadcastPubSub.prototype.unsubscribe=function(topic,fn,opt_context){return this.pubSub_.unsubscribe(topic,fn,opt_context)};goog.labs.pubsub.BroadcastPubSub.prototype.unsubscribeByKey=function(key){return this.pubSub_.unsubscribeByKey(key)};goog.labs.pubsub.BroadcastPubSub.prototype.subscribe=function(topic,fn,opt_context){return this.pubSub_.subscribe(topic,fn,opt_context)};goog.labs.pubsub.BroadcastPubSub.prototype.subscribeOnce=function(topic,fn,opt_context){return this.pubSub_.subscribeOnce(topic,fn,opt_context)};goog.labs.pubsub.BroadcastPubSub.prototype.getCount=function(opt_topic){return this.pubSub_.getCount(opt_topic)};goog.labs.pubsub.BroadcastPubSub.prototype.clear=function(opt_topic){this.pubSub_.clear(opt_topic)};goog.labs.pubsub.BroadcastPubSub.prototype.disposeInternal=function(){goog.array.remove(goog.labs.pubsub.BroadcastPubSub.instances_,this);if(goog.labs.pubsub.BroadcastPubSub.IS_IE8_&&goog.isDefAndNotNull(this.storage_)&&0==goog.labs.pubsub.BroadcastPubSub.instances_.length){this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}goog.labs.pubsub.BroadcastPubSub.base(this,"disposeInternal")};goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_="_closure_bps_ie8evt";goog.labs.pubsub.BroadcastPubSub.IE8_EVENT_LIFETIME_MS_=10*1e3;goog.labs.pubsub.BroadcastPubSub.IE8_QUEUE_LIFETIME_MS_=30*1e3;goog.labs.pubsub.BroadcastPubSub.IE8_TIMESTAMP_UNIQUE_OFFSET_MS_=.01;goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_=goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_+goog.math.randomInt(1e9);goog.labs.pubsub.BroadcastPubSub.Ie8Event_;goog.labs.pubsub.BroadcastPubSub.IS_IE8_=goog.userAgent.IE&&8==goog.userAgent.DOCUMENT_MODE;goog.labs.pubsub.BroadcastPubSub.validateIe8Event_=function(obj){if(goog.isObject(obj)&&goog.isNumber(obj.timestamp)&&goog.array.every(obj.args,goog.isString)){return{timestamp:obj.timestamp,args:obj.args}}return null};goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_=function(events){return goog.array.filter(goog.array.map(events,goog.labs.pubsub.BroadcastPubSub.validateIe8Event_),goog.isDefAndNotNull)};goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_=function(timestamp,events){return goog.array.filter(events,function(event){return event.timestamp>timestamp})};goog.labs.pubsub.BroadcastPubSub.prototype.maybeProcessIe8Events_=function(key,events){if(!events.length){return!1}var validEvents=goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_(events);if(validEvents.length==events.length){var lastTimestamp=goog.array.peek(validEvents).timestamp,previousTime=this.ie8LastEventTimes_[key]||this.ie8StartupTimestamp_;if(lastTimestamp>previousTime-goog.labs.pubsub.BroadcastPubSub.IE8_QUEUE_LIFETIME_MS_){this.ie8LastEventTimes_[key]=lastTimestamp;validEvents=goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_(previousTime,validEvents);for(var i=0,event;event=validEvents[i];i++){this.dispatch_(event.args)}return!0}}else{goog.log.warning(this.logger_,"invalid events found in queue "+key)}return!1};goog.labs.pubsub.BroadcastPubSub.prototype.handleIe8StorageEvent_=function(){for(var numKeys=this.mechanism_.getCount(),idx=0,key;idx<numKeys;idx++){key=this.mechanism_.key(idx);if(!(goog.isString(key)&&goog.string.startsWith(key,goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_PREFIX_))){continue}var events=null;try{events=this.storage_.get(key)}catch(ex){goog.log.warning(this.logger_,"invalid remote event queue "+key)}if(!(goog.isArray(events)&&this.maybeProcessIe8Events_(key,events))){this.storage_.remove(key)}}};goog.labs.pubsub.BroadcastPubSub.prototype.cleanupIe8StorageEvents_=function(timestamp){var events=null;try{events=this.storage_.get(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}catch(ex){goog.log.error(this.logger_,"cleanup encountered invalid event queue key "+goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}if(!goog.isArray(events)){this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_);return}events=goog.labs.pubsub.BroadcastPubSub.filterNewIe8Events_(timestamp,goog.labs.pubsub.BroadcastPubSub.filterValidIe8Events_(events));if(0<events.length){this.storage_.set(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_,events)}else{this.storage_.remove(goog.labs.pubsub.BroadcastPubSub.IE8_EVENTS_KEY_)}};