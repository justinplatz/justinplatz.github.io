goog.provide("goog.i18n.DateTimeParse");goog.require("goog.asserts");goog.require("goog.date");goog.require("goog.i18n.DateTimeFormat");goog.require("goog.i18n.DateTimeSymbols");goog.i18n.DateTimeParse=function(pattern,opt_dateTimeSymbols){goog.asserts.assert(goog.isDef(opt_dateTimeSymbols)||goog.isDef(goog.i18n.DateTimeSymbols),"goog.i18n.DateTimeSymbols or explicit symbols must be defined");this.patternParts_=[];this.dateTimeSymbols_=opt_dateTimeSymbols||goog.i18n.DateTimeSymbols;if("number"==typeof pattern){this.applyStandardPattern_(pattern)}else{this.applyPattern_(pattern)}};goog.i18n.DateTimeParse.ambiguousYearCenturyStart=80;goog.i18n.DateTimeParse.prototype.applyPattern_=function(pattern){for(var inQuote=!1,buf="",i=0,ch;i<pattern.length;i++){ch=pattern.charAt(i);if(" "==ch){if(0<buf.length){this.patternParts_.push({text:buf,count:0,abutStart:!1});buf=""}this.patternParts_.push({text:" ",count:0,abutStart:!1});while(i<pattern.length-1&&" "==pattern.charAt(i+1)){i++}}else if(inQuote){if("'"==ch){if(i+1<pattern.length&&"'"==pattern.charAt(i+1)){buf+="'";i++}else{inQuote=!1}}else{buf+=ch}}else if(0<=goog.i18n.DateTimeParse.PATTERN_CHARS_.indexOf(ch)){if(0<buf.length){this.patternParts_.push({text:buf,count:0,abutStart:!1});buf=""}var count=this.getNextCharCount_(pattern,i);this.patternParts_.push({text:ch,count:count,abutStart:!1});i+=count-1}else if("'"==ch){if(i+1<pattern.length&&"'"==pattern.charAt(i+1)){buf+="'";i++}else{inQuote=!0}}else{buf+=ch}}if(0<buf.length){this.patternParts_.push({text:buf,count:0,abutStart:!1})}this.markAbutStart_()};goog.i18n.DateTimeParse.prototype.applyStandardPattern_=function(formatType){var pattern;if(formatType>goog.i18n.DateTimeFormat.Format.SHORT_DATETIME){formatType=goog.i18n.DateTimeFormat.Format.MEDIUM_DATETIME}if(4>formatType){pattern=this.dateTimeSymbols_.DATEFORMATS[formatType]}else if(8>formatType){pattern=this.dateTimeSymbols_.TIMEFORMATS[formatType-4]}else{pattern=this.dateTimeSymbols_.DATETIMEFORMATS[formatType-8];pattern=pattern.replace("{1}",this.dateTimeSymbols_.DATEFORMATS[formatType-8]);pattern=pattern.replace("{0}",this.dateTimeSymbols_.TIMEFORMATS[formatType-8])}this.applyPattern_(pattern)};goog.i18n.DateTimeParse.prototype.parse=function(text,date,opt_start){var start=opt_start||0;return this.internalParse_(text,date,start,!1)};goog.i18n.DateTimeParse.prototype.strictParse=function(text,date,opt_start){var start=opt_start||0;return this.internalParse_(text,date,start,!0)};goog.i18n.DateTimeParse.prototype.internalParse_=function(text,date,start,validation){for(var cal=new goog.i18n.DateTimeParse.MyDate_,parsePos=[start],abutPat=-1,abutStart=0,abutPass=0,i=0;i<this.patternParts_.length;i++){if(0<this.patternParts_[i].count){if(0>abutPat&&this.patternParts_[i].abutStart){abutPat=i;abutStart=start;abutPass=0}if(0<=abutPat){var count=this.patternParts_[i].count;if(i==abutPat){count-=abutPass;abutPass++;if(0==count){return 0}}if(!this.subParse_(text,parsePos,this.patternParts_[i],count,cal)){i=abutPat-1;parsePos[0]=abutStart;continue}}else{abutPat=-1;if(!this.subParse_(text,parsePos,this.patternParts_[i],0,cal)){return 0}}}else{abutPat=-1;if(" "==this.patternParts_[i].text.charAt(0)){var s=parsePos[0];this.skipSpace_(text,parsePos);if(parsePos[0]>s){continue}}else if(text.indexOf(this.patternParts_[i].text,parsePos[0])==parsePos[0]){parsePos[0]+=this.patternParts_[i].text.length;continue}return 0}}return cal.calcDate_(date,validation)?parsePos[0]-start:0};goog.i18n.DateTimeParse.prototype.getNextCharCount_=function(pattern,start){var ch=pattern.charAt(start),next=start+1;while(next<pattern.length&&pattern.charAt(next)==ch){next++}return next-start};goog.i18n.DateTimeParse.PATTERN_CHARS_="GyMdkHmsSEDahKzZvQL";goog.i18n.DateTimeParse.NUMERIC_FORMAT_CHARS_="MydhHmsSDkK";goog.i18n.DateTimeParse.prototype.isNumericField_=function(part){if(0>=part.count){return!1}var i=goog.i18n.DateTimeParse.NUMERIC_FORMAT_CHARS_.indexOf(part.text.charAt(0));return 0<i||0==i&&3>part.count};goog.i18n.DateTimeParse.prototype.markAbutStart_=function(){for(var abut=!1,i=0;i<this.patternParts_.length;i++){if(this.isNumericField_(this.patternParts_[i])){if(!abut&&i+1<this.patternParts_.length&&this.isNumericField_(this.patternParts_[i+1])){abut=!0;this.patternParts_[i].abutStart=!0}}else{abut=!1}}};goog.i18n.DateTimeParse.prototype.skipSpace_=function(text,pos){var m=text.substring(pos[0]).match(/^\s+/);if(m){pos[0]+=m[0].length}};goog.i18n.DateTimeParse.prototype.subParse_=function(text,pos,part,digitCount,cal){this.skipSpace_(text,pos);var start=pos[0],ch=part.text.charAt(0),value=-1;if(this.isNumericField_(part)){if(0<digitCount){if(start+digitCount>text.length){return!1}value=this.parseInt_(text.substring(0,start+digitCount),pos)}else{value=this.parseInt_(text,pos)}}switch(ch){case"G":value=this.matchString_(text,pos,this.dateTimeSymbols_.ERAS);if(0<=value){cal.era=value}return!0;case"M":case"L":return this.subParseMonth_(text,pos,cal,value);case"E":return this.subParseDayOfWeek_(text,pos,cal);case"a":value=this.matchString_(text,pos,this.dateTimeSymbols_.AMPMS);if(0<=value){cal.ampm=value}return!0;case"y":return this.subParseYear_(text,pos,start,value,part,cal);case"Q":return this.subParseQuarter_(text,pos,cal,value);case"d":if(0<=value){cal.day=value}return!0;case"S":return this.subParseFractionalSeconds_(value,pos,start,cal);case"h":if(12==value){value=0}case"K":case"H":case"k":if(0<=value){cal.hours=value}return!0;case"m":if(0<=value){cal.minutes=value}return!0;case"s":if(0<=value){cal.seconds=value}return!0;case"z":case"Z":case"v":return this.subparseTimeZoneInGMT_(text,pos,cal);default:return!1;}};goog.i18n.DateTimeParse.prototype.subParseYear_=function(text,pos,start,value,part,cal){var ch;if(0>value){ch=text.charAt(pos[0]);if("+"!=ch&&"-"!=ch){return!1}pos[0]++;value=this.parseInt_(text,pos);if(0>value){return!1}if("-"==ch){value=-value}}if(!ch&&2==pos[0]-start&&2==part.count){cal.setTwoDigitYear_(value)}else{cal.year=value}return!0};goog.i18n.DateTimeParse.prototype.subParseMonth_=function(text,pos,cal,value){if(0>value){var months=this.dateTimeSymbols_.MONTHS.concat(this.dateTimeSymbols_.STANDALONEMONTHS).concat(this.dateTimeSymbols_.SHORTMONTHS).concat(this.dateTimeSymbols_.STANDALONESHORTMONTHS);value=this.matchString_(text,pos,months);if(0>value){return!1}cal.month=value%12;return!0}else{cal.month=value-1;return!0}};goog.i18n.DateTimeParse.prototype.subParseQuarter_=function(text,pos,cal,value){if(0>value){value=this.matchString_(text,pos,this.dateTimeSymbols_.QUARTERS);if(0>value){value=this.matchString_(text,pos,this.dateTimeSymbols_.SHORTQUARTERS)}if(0>value){return!1}cal.month=3*value;cal.day=1;return!0}return!1};goog.i18n.DateTimeParse.prototype.subParseDayOfWeek_=function(text,pos,cal){var value=this.matchString_(text,pos,this.dateTimeSymbols_.WEEKDAYS);if(0>value){value=this.matchString_(text,pos,this.dateTimeSymbols_.SHORTWEEKDAYS)}if(0>value){return!1}cal.dayOfWeek=value;return!0};goog.i18n.DateTimeParse.prototype.subParseFractionalSeconds_=function(value,pos,start,cal){var _Mathpow=Math.pow,len=pos[0]-start;cal.milliseconds=3>len?value*_Mathpow(10,3-len):Math.round(value/_Mathpow(10,len-3));return!0};goog.i18n.DateTimeParse.prototype.subparseTimeZoneInGMT_=function(text,pos,cal){if(text.indexOf("GMT",pos[0])==pos[0]){pos[0]+=3;return this.parseTimeZoneOffset_(text,pos,cal)}return this.parseTimeZoneOffset_(text,pos,cal)};goog.i18n.DateTimeParse.prototype.parseTimeZoneOffset_=function(text,pos,cal){if(pos[0]>=text.length){cal.tzOffset=0;return!0}var sign=1;switch(text.charAt(pos[0])){case"-":sign=-1;case"+":pos[0]++;}var st=pos[0],value=this.parseInt_(text,pos);if(0>value){return!1}var offset;if(pos[0]<text.length&&":"==text.charAt(pos[0])){offset=60*value;pos[0]++;value=this.parseInt_(text,pos);if(0>value){return!1}offset+=value}else{offset=value;if(24>offset&&2>=pos[0]-st){offset*=60}else{offset=offset%100+60*(offset/100)}}offset*=sign;cal.tzOffset=-offset;return!0};goog.i18n.DateTimeParse.prototype.parseInt_=function(text,pos){if(this.dateTimeSymbols_.ZERODIGIT){for(var parts=[],i=pos[0],c;i<text.length;i++){c=text.charCodeAt(i)-this.dateTimeSymbols_.ZERODIGIT;parts.push(0<=c&&9>=c?String.fromCharCode(c+48):text.charAt(i))}text=parts.join("")}else{text=text.substring(pos[0])}var m=text.match(/^\d+/);if(!m){return-1}pos[0]+=m[0].length;return parseInt(m[0],10)};goog.i18n.DateTimeParse.prototype.matchString_=function(text,pos,data){for(var bestMatchLength=0,bestMatch=-1,lower_text=text.substring(pos[0]).toLowerCase(),i=0,len;i<data.length;i++){len=data[i].length;if(len>bestMatchLength&&0==lower_text.indexOf(data[i].toLowerCase())){bestMatch=i;bestMatchLength=len}}if(0<=bestMatch){pos[0]+=bestMatchLength}return bestMatch};goog.i18n.DateTimeParse.MyDate_=function(){};goog.i18n.DateTimeParse.MyDate_.prototype.era;goog.i18n.DateTimeParse.MyDate_.prototype.year;goog.i18n.DateTimeParse.MyDate_.prototype.month;goog.i18n.DateTimeParse.MyDate_.prototype.day;goog.i18n.DateTimeParse.MyDate_.prototype.hours;goog.i18n.DateTimeParse.MyDate_.prototype.ampm;goog.i18n.DateTimeParse.MyDate_.prototype.minutes;goog.i18n.DateTimeParse.MyDate_.prototype.seconds;goog.i18n.DateTimeParse.MyDate_.prototype.milliseconds;goog.i18n.DateTimeParse.MyDate_.prototype.tzOffset;goog.i18n.DateTimeParse.MyDate_.prototype.dayOfWeek;goog.i18n.DateTimeParse.MyDate_.prototype.setTwoDigitYear_=function(year){var now=new Date,defaultCenturyStartYear=now.getFullYear()-goog.i18n.DateTimeParse.ambiguousYearCenturyStart,ambiguousTwoDigitYear=defaultCenturyStartYear%100;this.ambiguousYear=year==ambiguousTwoDigitYear;year+=100*Math.floor(defaultCenturyStartYear/100)+(year<ambiguousTwoDigitYear?100:0);return this.year=year};goog.i18n.DateTimeParse.MyDate_.prototype.calcDate_=function(date,validation){if(this.era!=void 0&&this.year!=void 0&&0==this.era&&0<this.year){this.year=-(this.year-1)}if(this.year!=void 0){date.setFullYear(this.year)}var orgDate=date.getDate();date.setDate(1);if(this.month!=void 0){date.setMonth(this.month)}if(this.day!=void 0){date.setDate(this.day)}else{var maxDate=goog.date.getNumberOfDaysInMonth(date.getFullYear(),date.getMonth());date.setDate(orgDate>maxDate?maxDate:orgDate)}if(goog.isFunction(date.setHours)){if(this.hours==void 0){this.hours=date.getHours()}if(this.ampm!=void 0&&0<this.ampm&&12>this.hours){this.hours+=12}date.setHours(this.hours)}if(goog.isFunction(date.setMinutes)&&this.minutes!=void 0){date.setMinutes(this.minutes)}if(goog.isFunction(date.setSeconds)&&this.seconds!=void 0){date.setSeconds(this.seconds)}if(goog.isFunction(date.setMilliseconds)&&this.milliseconds!=void 0){date.setMilliseconds(this.milliseconds)}if(validation&&(this.year!=void 0&&this.year!=date.getFullYear()||this.month!=void 0&&this.month!=date.getMonth()||this.day!=void 0&&this.day!=date.getDate()||24<=this.hours||60<=this.minutes||60<=this.seconds||1e3<=this.milliseconds)){return!1}if(this.tzOffset!=void 0){var offset=date.getTimezoneOffset();date.setTime(date.getTime()+1e3*(60*(this.tzOffset-offset)))}if(this.ambiguousYear){var defaultCenturyStart=new Date;defaultCenturyStart.setFullYear(defaultCenturyStart.getFullYear()-goog.i18n.DateTimeParse.ambiguousYearCenturyStart);if(date.getTime()<defaultCenturyStart.getTime()){date.setFullYear(defaultCenturyStart.getFullYear()+100)}}if(this.dayOfWeek!=void 0){if(this.day==void 0){var adjustment=(7+this.dayOfWeek-date.getDay())%7;if(3<adjustment){adjustment-=7}var orgMonth=date.getMonth();date.setDate(date.getDate()+adjustment);if(date.getMonth()!=orgMonth){date.setDate(date.getDate()+(0<adjustment?-7:7))}}else if(this.dayOfWeek!=date.getDay()){return!1}}return!0};