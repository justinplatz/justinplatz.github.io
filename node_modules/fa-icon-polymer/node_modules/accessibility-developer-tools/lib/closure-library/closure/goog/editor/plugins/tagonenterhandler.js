goog.provide("goog.editor.plugins.TagOnEnterHandler");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.Command");goog.require("goog.editor.node");goog.require("goog.editor.plugins.EnterHandler");goog.require("goog.editor.range");goog.require("goog.editor.style");goog.require("goog.events.KeyCodes");goog.require("goog.functions");goog.require("goog.string.Unicode");goog.require("goog.style");goog.require("goog.userAgent");goog.editor.plugins.TagOnEnterHandler=function(tag){this.tag=tag;goog.editor.plugins.EnterHandler.call(this)};goog.inherits(goog.editor.plugins.TagOnEnterHandler,goog.editor.plugins.EnterHandler);goog.editor.plugins.TagOnEnterHandler.prototype.getTrogClassId=function(){return"TagOnEnterHandler"};goog.editor.plugins.TagOnEnterHandler.prototype.getNonCollapsingBlankHtml=function(){if(this.tag==goog.dom.TagName.P){return"<p>&nbsp;</p>"}else if(this.tag==goog.dom.TagName.DIV){return"<div><br></div>"}return"<br>"};goog.editor.plugins.TagOnEnterHandler.prototype.activeOnUneditableFields=goog.functions.TRUE;goog.editor.plugins.TagOnEnterHandler.prototype.isSupportedCommand=function(command){return command==goog.editor.Command.DEFAULT_TAG};goog.editor.plugins.TagOnEnterHandler.prototype.queryCommandValue=function(command){return command==goog.editor.Command.DEFAULT_TAG?this.tag+"":null};goog.editor.plugins.TagOnEnterHandler.prototype.handleBackspaceInternal=function(e,range){goog.editor.plugins.TagOnEnterHandler.superClass_.handleBackspaceInternal.call(this,e,range);if(goog.userAgent.GECKO){this.markBrToNotBeRemoved_(range,!0)}};goog.editor.plugins.TagOnEnterHandler.prototype.processParagraphTagsInternal=function(e,split){if((goog.userAgent.OPERA||goog.userAgent.IE)&&this.tag!=goog.dom.TagName.P){this.ensureBlockIeOpera(this.tag)}};goog.editor.plugins.TagOnEnterHandler.prototype.handleDeleteGecko=function(e){var range=this.getFieldObject().getRange(),container=goog.editor.style.getContainer(range&&range.getContainerElement());if(this.getFieldObject().getElement().lastChild==container&&goog.editor.plugins.EnterHandler.isBrElem(container)){e.preventDefault();e.stopPropagation()}else{this.markBrToNotBeRemoved_(range,!1);this.deleteBrGecko(e)}};goog.editor.plugins.TagOnEnterHandler.prototype.handleKeyUpInternal=function(e){if(goog.userAgent.GECKO){if(e.keyCode==goog.events.KeyCodes.DELETE){this.removeBrIfNecessary_(!1)}else if(e.keyCode==goog.events.KeyCodes.BACKSPACE){this.removeBrIfNecessary_(!0)}}else if((goog.userAgent.IE||goog.userAgent.OPERA)&&e.keyCode==goog.events.KeyCodes.ENTER){this.ensureBlockIeOpera(this.tag,!0)}};goog.editor.plugins.TagOnEnterHandler.BrOrNbspSurroundedWithWhiteSpace_="[\t\n\r ]*(<br[^>]*/?>|&nbsp;)[\t\n\r ]*";goog.editor.plugins.TagOnEnterHandler.emptyLiRegExp_=new RegExp("^"+goog.editor.plugins.TagOnEnterHandler.BrOrNbspSurroundedWithWhiteSpace_+"$");goog.editor.plugins.TagOnEnterHandler.prototype.ensureNodeIsWrappedW3c_=function(node,container){if(container==this.getFieldObject().getElement()){var isChildOfFn=function(child){return container==child.parentNode},nodeToWrap=goog.dom.getAncestor(node,isChildOfFn,!0);container=goog.editor.plugins.TagOnEnterHandler.wrapInContainerW3c_(this.tag+"",{node:nodeToWrap,offset:0},container)}return container};goog.editor.plugins.TagOnEnterHandler.prototype.handleEnterWebkitInternal=function(e){if(this.tag==goog.dom.TagName.DIV){var range=this.getFieldObject().getRange(),container=goog.editor.style.getContainer(range.getContainerElement()),position=goog.editor.range.getDeepEndPoint(range,!0);container=this.ensureNodeIsWrappedW3c_(position.node,container);goog.dom.Range.createCaret(position.node,position.offset).select()}};goog.editor.plugins.TagOnEnterHandler.prototype.handleEnterAtCursorGeckoInternal=function(e,wasCollapsed,range){var li=null;if(wasCollapsed){li=goog.dom.getAncestorByTagNameAndClass(range&&range.getContainerElement(),goog.dom.TagName.LI)}var isEmptyLi=li&&li.innerHTML.match(goog.editor.plugins.TagOnEnterHandler.emptyLiRegExp_),elementAfterCursor=isEmptyLi?this.breakOutOfEmptyListItemGecko_(li):this.handleRegularEnterGecko_();this.scrollCursorIntoViewGecko_(elementAfterCursor);if(goog.editor.plugins.EnterHandler.isBrElem(elementAfterCursor)){elementAfterCursor.normalize();var br=goog.dom.getElementsByTagName(goog.dom.TagName.BR,elementAfterCursor)[0];if(br.previousSibling&&br.previousSibling.nodeType==goog.dom.NodeType.TEXT){elementAfterCursor=br.previousSibling}}goog.editor.range.selectNodeStart(elementAfterCursor);e.preventDefault();e.stopPropagation()};goog.editor.plugins.TagOnEnterHandler.prototype.breakOutOfEmptyListItemGecko_=function(li){var listNode=li.parentNode,grandparent=listNode.parentNode,inSubList=grandparent.tagName==goog.dom.TagName.OL||grandparent.tagName==goog.dom.TagName.UL,newNode=goog.dom.getDomHelper(li).createElement(inSubList?goog.dom.TagName.LI:this.tag);if(!li.previousSibling){goog.dom.insertSiblingBefore(newNode,listNode)}else{if(li.nextSibling){var listClone=listNode.cloneNode(!1);while(li.nextSibling){listClone.appendChild(li.nextSibling)}goog.dom.insertSiblingAfter(listClone,listNode)}goog.dom.insertSiblingAfter(newNode,listNode)}if(goog.editor.node.isEmpty(listNode)){goog.dom.removeNode(listNode)}goog.dom.removeNode(li);newNode.innerHTML="&nbsp;";return newNode};goog.editor.plugins.TagOnEnterHandler.wrapInContainerW3c_=function(nodeName,position,container){var start=position.node;while(start.previousSibling&&!goog.editor.style.isContainer(start.previousSibling)){start=start.previousSibling}var end=position.node;while(end.nextSibling&&!goog.editor.style.isContainer(end.nextSibling)){end=end.nextSibling}var para=container.ownerDocument.createElement(nodeName);while(start!=end){var newStart=start.nextSibling;goog.dom.appendChild(para,start);start=newStart}var nextSibling=end.nextSibling;goog.dom.appendChild(para,end);container.insertBefore(para,nextSibling);return para};goog.editor.plugins.TagOnEnterHandler.prototype.markBrToNotBeRemoved_=function(range,isBackspace){var focusNode=range.getFocusNode(),focusOffset=range.getFocusOffset(),newEndOffset=isBackspace?focusOffset:focusOffset+1;if(goog.editor.node.getLength(focusNode)==newEndOffset){var sibling=focusNode.nextSibling;if(sibling&&sibling.tagName==goog.dom.TagName.BR){this.brToKeep_=sibling}}};goog.editor.plugins.TagOnEnterHandler.prototype.removeBrIfNecessary_=function(isBackSpace){var range=this.getFieldObject().getRange(),focusNode=range.getFocusNode(),focusOffset=range.getFocusOffset(),sibling;if(isBackSpace&&""==focusNode.data){sibling=focusNode.nextSibling}else if(isBackSpace&&0==focusOffset){var node=focusNode;while(node&&!node.previousSibling&&node.parentNode!=this.getFieldObject().getElement()){node=node.parentNode}sibling=node.previousSibling}else if(focusNode.length==focusOffset){sibling=focusNode.nextSibling}if(!sibling||sibling.tagName!=goog.dom.TagName.BR||this.brToKeep_==sibling){return}goog.dom.removeNode(sibling);if(focusNode.nodeType==goog.dom.NodeType.TEXT){focusNode.data=goog.editor.plugins.TagOnEnterHandler.trimTabsAndLineBreaks_(focusNode.data);goog.dom.Range.createCaret(focusNode,Math.min(focusOffset,focusNode.length)).select()}};goog.editor.plugins.TagOnEnterHandler.trimTabsAndLineBreaks_=function(string){return string.replace(/^[\t\n\r]|[\t\n\r]$/g,"")};goog.editor.plugins.TagOnEnterHandler.prototype.handleRegularEnterGecko_=function(){var range=this.getFieldObject().getRange(),container=goog.editor.style.getContainer(range.getContainerElement()),newNode;if(goog.editor.plugins.EnterHandler.isBrElem(container)){if(container.tagName==goog.dom.TagName.BODY){container=this.ensureNodeIsWrappedW3c_(goog.dom.getElementsByTagName(goog.dom.TagName.BR,container)[0],container)}newNode=container.cloneNode(!0);goog.dom.insertSiblingAfter(newNode,container)}else{if(!container.firstChild){container.innerHTML="&nbsp;"}var position=goog.editor.range.getDeepEndPoint(range,!0);container=this.ensureNodeIsWrappedW3c_(position.node,container);newNode=goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_(position.node,position.offset,container);var leftAnchor=goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_(container),rightAnchor=goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_(newNode,!0);if(leftAnchor&&rightAnchor&&leftAnchor.tagName==goog.dom.TagName.A&&rightAnchor.tagName==goog.dom.TagName.A){var anchorToRemove=goog.editor.node.isEmpty(leftAnchor,!1)?leftAnchor:rightAnchor;goog.dom.flattenElement(anchorToRemove)}}return newNode};goog.editor.plugins.TagOnEnterHandler.prototype.scrollCursorIntoViewGecko_=function(element){if(!this.getFieldObject().isFixedHeight()){return}var field=this.getFieldObject().getElement(),elementY=goog.style.getPageOffsetTop(element),bottomOfNode=elementY+element.offsetHeight,dom=this.getFieldDomHelper(),win=this.getFieldDomHelper().getWindow(),scrollY=dom.getDocumentScroll().y,viewportHeight=goog.dom.getViewportSize(win).height;if(bottomOfNode>viewportHeight+scrollY){if(field.tagName==goog.dom.TagName.BODY&&goog.editor.node.isStandardsMode(field)){field=field.parentNode}field.scrollTop=bottomOfNode-viewportHeight}};goog.editor.plugins.TagOnEnterHandler.splitDom_=function(positionNode,positionOffset,opt_root){if(!opt_root)opt_root=positionNode.ownerDocument.body;var textSplit=positionNode.nodeType==goog.dom.NodeType.TEXT,secondHalfOfSplitNode;if(textSplit){if(goog.userAgent.IE&&positionOffset==positionNode.nodeValue.length){secondHalfOfSplitNode=goog.dom.getDomHelper(positionNode).createTextNode("");goog.dom.insertSiblingAfter(secondHalfOfSplitNode,positionNode)}else{secondHalfOfSplitNode=positionNode.splitText(positionOffset)}}else{if(positionOffset){positionNode=positionNode.childNodes[positionOffset-1]}else{positionNode=secondHalfOfSplitNode=positionNode.firstChild||positionNode}}var secondHalf=goog.editor.node.splitDomTreeAt(positionNode,secondHalfOfSplitNode,opt_root);if(textSplit){secondHalfOfSplitNode=goog.editor.plugins.TagOnEnterHandler.joinTextNodes_(secondHalfOfSplitNode,!0);goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(secondHalfOfSplitNode,!0,!!secondHalfOfSplitNode.nextSibling);var firstHalf=goog.editor.plugins.TagOnEnterHandler.joinTextNodes_(positionNode,!1);goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_(firstHalf,!1,!1)}return secondHalf};goog.editor.plugins.TagOnEnterHandler.splitDomAndAppend_=function(positionNode,positionOffset,node){var newNode=goog.editor.plugins.TagOnEnterHandler.splitDom_(positionNode,positionOffset,node);goog.dom.insertSiblingAfter(newNode,node);return newNode};goog.editor.plugins.TagOnEnterHandler.joinTextNodes_=function(node,moveForward){if(node&&"#text"==node.nodeName){var nextNodeFn=moveForward?"nextSibling":"previousSibling",prevNodeFn=moveForward?"previousSibling":"nextSibling",nodeValues=[node.nodeValue];while(node[nextNodeFn]&&node[nextNodeFn].nodeType==goog.dom.NodeType.TEXT){node=node[nextNodeFn];nodeValues.push(node.nodeValue);goog.dom.removeNode(node[prevNodeFn])}if(!moveForward){nodeValues.reverse()}node.nodeValue=nodeValues.join("")}return node};goog.editor.plugins.TagOnEnterHandler.replaceWhiteSpaceWithNbsp_=function(textNode,fromStart,isLeaveEmpty){var regExp=fromStart?/^[ \t\r\n]+/:/[ \t\r\n]+$/;textNode.nodeValue=textNode.nodeValue.replace(regExp,goog.string.Unicode.NBSP);if(!isLeaveEmpty&&""==textNode.nodeValue){textNode.nodeValue=goog.string.Unicode.NBSP}};goog.editor.plugins.TagOnEnterHandler.findAnchorInTraversal_=function(node,opt_useFirstChild){while((node=opt_useFirstChild?node.firstChild:node.lastChild)&&node.tagName!=goog.dom.TagName.A){}return node};