goog.provide("goog.fx.DraggerTest");goog.setTestOnly("goog.fx.DraggerTest");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.BrowserEvent");goog.require("goog.events.Event");goog.require("goog.events.EventType");goog.require("goog.fx.Dragger");goog.require("goog.math.Rect");goog.require("goog.style.bidi");goog.require("goog.testing.StrictMock");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var HAS_SET_CAPTURE=goog.fx.Dragger.HAS_SET_CAPTURE_,target,targetRtl;function setUp(){var sandbox=goog.dom.getElement("sandbox");target=goog.dom.createDom(goog.dom.TagName.DIV,{id:"target",style:"display:none;position:absolute;top:15px;left:10px"});sandbox.appendChild(target);sandbox.appendChild(goog.dom.createDom(goog.dom.TagName.DIV,{id:"handle"}));var sandboxRtl=goog.dom.getElement("sandbox_rtl");targetRtl=goog.dom.createDom(goog.dom.TagName.DIV,{id:"target_rtl",style:"position:absolute; top:15px; right:10px; width:10px; "+"height: 10px; background: green;"});sandboxRtl.appendChild(targetRtl);sandboxRtl.appendChild(goog.dom.createDom(goog.dom.TagName.DIV,{id:"background_rtl",style:"width: 10000px;height:50px;position:absolute;color:blue;"}));sandboxRtl.appendChild(goog.dom.createDom(goog.dom.TagName.DIV,{id:"handle_rtl"}))}function tearDown(){goog.dom.removeChildren(goog.dom.getElement("sandbox"));goog.dom.removeChildren(goog.dom.getElement("sandbox_rtl"));goog.events.removeAll(document)}function testStartDrag(){runStartDragTest("handle",target)}function testStartDrag_rtl(){runStartDragTest("handle_rtl",targetRtl)}function runStartDragTest(handleId,targetElement){var dragger=new goog.fx.Dragger(targetElement,goog.dom.getElement(handleId));if("handle_rtl"==handleId){dragger.enableRightPositioningForRtl(!0)}var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0);e.preventDefault();e.isMouseActionButton().$returns(!0);e.preventDefault();e.$replay();goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(){targetElement.style.display="block"});dragger.startDrag(e);assertTrue("Start drag with no hysteresis must actually start the drag.",dragger.isDragging());if("handle_rtl"==handleId){assertEquals(10,goog.style.bidi.getOffsetStart(targetElement))}assertEquals("Dragger startX must match event's clientX.",1,dragger.startX);assertEquals("Dragger clientX must match event's clientX",1,dragger.clientX);assertEquals("Dragger startY must match event's clientY.",2,dragger.startY);assertEquals("Dragger clientY must match event's clientY",2,dragger.clientY);assertEquals("Dragger deltaX must match target's offsetLeft",10,dragger.deltaX);assertEquals("Dragger deltaY must match target's offsetTop",15,dragger.deltaY);dragger=new goog.fx.Dragger(targetElement,goog.dom.getElement(handleId));dragger.setHysteresis(1);dragger.startDrag(e);assertFalse("Start drag with a valid non-zero hysteresis should not start "+"the drag.",dragger.isDragging());e.$verify()}function testStartDrag_Cancel(){var dragger=new goog.fx.Dragger(target),e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0);e.$replay();goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){e.preventDefault()});dragger.startDrag(e);assertFalse("Start drag must have been cancelled.",dragger.isDragging());assertFalse("Dragger must not have registered mousemove handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEMOVE,!HAS_SET_CAPTURE));assertFalse("Dragger must not have registered mouseup handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEUP,!HAS_SET_CAPTURE));e.$verify()}function testStartDrag_LeftMouseDownOnly(){var dragger=new goog.fx.Dragger(target),e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!1);e.$replay();goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){fail("No drag START event should have been dispatched")});dragger.startDrag(e);assertFalse("Start drag must have been cancelled.",dragger.isDragging());assertFalse("Dragger must not have registered mousemove handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEMOVE,!0));assertFalse("Dragger must not have registered mouseup handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEUP,!0));e.$verify()}function testStartDrag_MouseMove(){var dragger=new goog.fx.Dragger(target),e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEMOVE;e.clientX=1;e.clientY=2;e.$replay();var startDragFired=!1;goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){startDragFired=!0});dragger.startDrag(e);assertTrue("Dragging should be in progress.",dragger.isDragging());assertTrue("Start drag event should have fired.",startDragFired);assertTrue("Dragger must have registered mousemove handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEMOVE,!HAS_SET_CAPTURE));assertTrue("Dragger must have registered mouseup handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEUP,!HAS_SET_CAPTURE));e.$verify()}function testStartDrag_TouchStart(){var dragger=new goog.fx.Dragger(target),e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.TOUCHSTART;e.$replay();var startDragFired=!1;goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){startDragFired=!0});dragger.startDrag(e);assertTrue("Dragging should be in progress.",dragger.isDragging());assertTrue("Start drag event should have fired.",startDragFired);assertTrue("Dragger must have registered touchstart listener.",goog.events.hasListener(dragger.handle,goog.events.EventType.TOUCHSTART,!1));e.$verify()}function testStartDrag_TouchStart_NonZeroHysteresis(){var dragger=new goog.fx.Dragger(target);dragger.setHysteresis(5);var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.TOUCHSTART;e.$replay();var startDragFired=!1;goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){startDragFired=!0});dragger.startDrag(e);assertFalse("Start drag must not start drag because of hysterisis.",dragger.isDragging());assertTrue("Dragger must have registered touchstart listener.",goog.events.hasListener(dragger.handle,goog.events.EventType.TOUCHSTART,!1));e.$verify()}function testHandleMove_Cancel(){var dragger=new goog.fx.Dragger(target);dragger.setHysteresis(5);goog.events.listen(dragger,goog.fx.Dragger.EventType.START,function(e){e.preventDefault()});var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0).$anyTimes();e.$replay();dragger.startDrag(e);assertFalse("Start drag must not start drag because of hysterisis.",dragger.isDragging());assertTrue("Dragger must have registered mousemove handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEMOVE,!HAS_SET_CAPTURE));assertTrue("Dragger must have registered mouseup handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEUP,!HAS_SET_CAPTURE));e.clientX=10;e.clientY=10;dragger.handleMove_(e);assertFalse("Drag must be cancelled.",dragger.isDragging());assertFalse("Dragger must unregistered mousemove handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEMOVE,!0));assertFalse("Dragger must unregistered mouseup handlers.",goog.events.hasListener(dragger.document_,goog.events.EventType.MOUSEUP,!0));e.$verify()}function testIeDragStartCancelling(){if(!goog.userAgent.IE||goog.userAgent.isVersionOrHigher(9)){return}var dragger=new goog.fx.Dragger(target),e=new goog.events.Event(goog.events.EventType.MOUSEDOWN);e.clientX=1;e.clientY=2;e.button=1;var be=new goog.events.BrowserEvent(e);dragger.startDrag(be);assertTrue("The drag should have started.",dragger.isDragging());e=new goog.events.Event(goog.events.EventType.DRAGSTART);e.target=dragger.document_.documentElement;assertTrue("The event should not be canceled.",goog.testing.events.fireBrowserEvent(e));dragger.dispose();dragger=new goog.fx.Dragger(target);dragger.setCancelIeDragStart(!0);e=new goog.events.Event(goog.events.EventType.MOUSEDOWN);e.clientX=1;e.clientY=2;e.button=1;be=new goog.events.BrowserEvent(e);dragger.startDrag(be);assertTrue("The drag should have started.",dragger.isDragging());e=new goog.events.Event(goog.events.EventType.DRAGSTART);e.target=dragger.document_.documentElement;assertFalse("The event should be canceled.",goog.testing.events.fireBrowserEvent(e));dragger.dispose()}function testPreventMouseDown(){var dragger=new goog.fx.Dragger(target);dragger.setPreventMouseDown(!1);var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0);e.$replay();dragger.startDrag(e);assertTrue("Dragging should be in progess.",dragger.isDragging());e.$verify()}function testLimits(){var dragger=new goog.fx.Dragger(target);assertEquals(100,dragger.limitX(100));assertEquals(100,dragger.limitY(100));dragger.setLimits(new goog.math.Rect(10,20,30,40));assertEquals(10,dragger.limitX(0));assertEquals(40,dragger.limitX(100));assertEquals(20,dragger.limitY(0));assertEquals(60,dragger.limitY(100))}function testWindowBlur(){if(!goog.fx.Dragger.HAS_SET_CAPTURE_){var dragger=new goog.fx.Dragger(target),dragEnded=!1;goog.events.listen(dragger,goog.fx.Dragger.EventType.END,function(e){dragEnded=!0});var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0);e.preventDefault();e.$replay();dragger.startDrag(e);e.$verify();assertTrue(dragger.isDragging());e=new goog.events.BrowserEvent;e.type=goog.events.EventType.BLUR;e.target=window;e.currentTarget=window;goog.testing.events.fireBrowserEvent(e);assertTrue(dragEnded)}}function testBlur(){if(!goog.fx.Dragger.HAS_SET_CAPTURE_){var dragger=new goog.fx.Dragger(target),dragEnded=!1;goog.events.listen(dragger,goog.fx.Dragger.EventType.END,function(e){dragEnded=!0});var e=new goog.testing.StrictMock(goog.events.BrowserEvent);e.type=goog.events.EventType.MOUSEDOWN;e.clientX=1;e.clientY=2;e.isMouseActionButton().$returns(!0);e.preventDefault();e.$replay();dragger.startDrag(e);e.$verify();assertTrue(dragger.isDragging());e=new goog.events.BrowserEvent;e.type=goog.events.EventType.BLUR;e.target=document.body;e.currentTarget=document.body;goog.events.listen(document.body,goog.events.EventType.BLUR,function(e){e.propagationStopped_=!0},!0);goog.testing.events.fireBrowserEvent(e);assertFalse(dragEnded)}}function testCloneNode(){var element=goog.dom.createDom(goog.dom.TagName.DIV);element.innerHTML="<input type=\"hidden\" value=\"v0\">"+"<textarea>v1</textarea>"+"<textarea>v2</textarea>";element.childNodes[0].value="'new'\n\"value\"";element.childNodes[1].value="<"+"/textarea>&lt;3";element.childNodes[2].value="<script>\n\talert(\"oops!\");<"+"/script>";var clone=goog.fx.Dragger.cloneNode(element);assertEquals(element.childNodes[0].value,clone.childNodes[0].value);assertEquals(element.childNodes[1].value,clone.childNodes[1].value);assertEquals(element.childNodes[2].value,clone.childNodes[2].value);clone=goog.fx.Dragger.cloneNode(element.childNodes[2]);assertEquals(element.childNodes[2].value,clone.value)}