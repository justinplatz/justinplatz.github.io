goog.provide("goog.debug.ErrorReporter");goog.provide("goog.debug.ErrorReporter.ExceptionEvent");goog.require("goog.asserts");goog.require("goog.debug");goog.require("goog.debug.Error");goog.require("goog.debug.ErrorHandler");goog.require("goog.debug.entryPointRegistry");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventTarget");goog.require("goog.log");goog.require("goog.net.XhrIo");goog.require("goog.object");goog.require("goog.string");goog.require("goog.uri.utils");goog.require("goog.userAgent");goog.debug.ErrorReporter=function(handlerUrl,opt_contextProvider,opt_noAutoProtect){goog.debug.ErrorReporter.base(this,"constructor");this.contextProvider_=opt_contextProvider||null;this.contextPrefix_="context.";this.truncationLimit_=null;this.additionalArguments_={};this.xhrSender_=goog.debug.ErrorReporter.defaultXhrSender;this.handlerUrl_=handlerUrl;if(goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT){if(!opt_noAutoProtect){this.errorHandler_=null;this.setup_()}}else if(!opt_noAutoProtect){goog.asserts.fail("opt_noAutoProtect cannot be false while "+"goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT is false.  Setting "+"ALLOW_AUTO_PROTECT to false removes the necessary auto-protect code "+"in compiled/optimized mode.")}};goog.inherits(goog.debug.ErrorReporter,goog.events.EventTarget);goog.define("goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT",!0);goog.debug.ErrorReporter.ExceptionEvent=function(error,context){goog.events.Event.call(this,goog.debug.ErrorReporter.ExceptionEvent.TYPE);this.error=error;this.context=context};goog.inherits(goog.debug.ErrorReporter.ExceptionEvent,goog.events.Event);goog.debug.ErrorReporter.ExceptionEvent.TYPE=goog.events.getUniqueId("exception");goog.debug.ErrorReporter.prototype.extraHeaders_;goog.debug.ErrorReporter.logger_=goog.log.getLogger("goog.debug.ErrorReporter");goog.debug.ErrorReporter.install=function(loggingUrl,opt_contextProvider,opt_noAutoProtect){var instance=new goog.debug.ErrorReporter(loggingUrl,opt_contextProvider,opt_noAutoProtect);return instance};goog.debug.ErrorReporter.defaultXhrSender=function(uri,method,content,opt_headers){goog.net.XhrIo.send(uri,null,method,content,opt_headers)};goog.debug.ErrorReporter.prototype.protectAdditionalEntryPoint=goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT?function(fn){if(this.errorHandler_){return this.errorHandler_.protectEntryPoint(fn)}return null}:function(fn){goog.asserts.fail("Cannot call protectAdditionalEntryPoint while ALLOW_AUTO_PROTECT "+"is false.  If ALLOW_AUTO_PROTECT is false, the necessary "+"auto-protect code in compiled/optimized mode is removed.");return null};if(goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT){goog.debug.ErrorReporter.prototype.setup_=function(){if(goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("10")){goog.debug.catchErrors(goog.bind(this.handleException,this),!1,null)}else{this.errorHandler_=new goog.debug.ErrorHandler(goog.bind(this.handleException,this));this.errorHandler_.protectWindowSetTimeout();this.errorHandler_.protectWindowSetInterval();this.errorHandler_.protectWindowRequestAnimationFrame();goog.debug.entryPointRegistry.monitorAll(this.errorHandler_)}}}goog.debug.ErrorReporter.prototype.setLoggingHeaders=function(loggingHeaders){this.extraHeaders_=loggingHeaders};goog.debug.ErrorReporter.prototype.setXhrSender=function(xhrSender){this.xhrSender_=xhrSender};goog.debug.ErrorReporter.prototype.handleException=function(e,opt_context){var error=goog.debug.normalizeErrorObject(e),context=opt_context?goog.object.clone(opt_context):{};if(this.contextProvider_){try{this.contextProvider_(error,context)}catch(err){goog.log.error(goog.debug.ErrorReporter.logger_,"Context provider threw an exception: "+err.message)}}var message=error.message.substring(0,1900);if(!(e instanceof goog.debug.Error)||e.reportErrorToServer){this.sendErrorReport(message,error.fileName,error.lineNumber,error.stack,context)}try{this.dispatchEvent(new goog.debug.ErrorReporter.ExceptionEvent(error,context))}catch(ex){}};goog.debug.ErrorReporter.prototype.sendErrorReport=function(message,fileName,line,opt_trace,opt_context){try{var requestUrl=goog.uri.utils.appendParams(this.handlerUrl_,"script",fileName,"error",message,"line",line);if(!goog.object.isEmpty(this.additionalArguments_)){requestUrl=goog.uri.utils.appendParamsFromMap(requestUrl,this.additionalArguments_)}var queryMap={trace:opt_trace};if(opt_context){for(var entry in opt_context){queryMap[this.contextPrefix_+entry]=opt_context[entry]}}var queryData=goog.uri.utils.buildQueryDataFromMap(queryMap);if(goog.isNumber(this.truncationLimit_)){queryData=queryData.substring(0,this.truncationLimit_)}this.xhrSender_(requestUrl,"POST",queryData,this.extraHeaders_)}catch(e){var logMessage=goog.string.buildString("Error occurred in sending an error report.\n\n","script:",fileName,"\n","line:",line,"\n","error:",message,"\n","trace:",opt_trace);goog.log.info(goog.debug.ErrorReporter.logger_,logMessage)}};goog.debug.ErrorReporter.prototype.setContextPrefix=function(prefix){this.contextPrefix_=prefix};goog.debug.ErrorReporter.prototype.setTruncationLimit=function(limit){goog.asserts.assert(!goog.isNumber(limit)||0<=limit,"Body limit must be valid number >= 0 or null");this.truncationLimit_=limit};goog.debug.ErrorReporter.prototype.setAdditionalArguments=function(urlArgs){this.additionalArguments_=urlArgs};goog.debug.ErrorReporter.prototype.disposeInternal=function(){if(goog.debug.ErrorReporter.ALLOW_AUTO_PROTECT){goog.dispose(this.errorHandler_)}goog.debug.ErrorReporter.base(this,"disposeInternal")};