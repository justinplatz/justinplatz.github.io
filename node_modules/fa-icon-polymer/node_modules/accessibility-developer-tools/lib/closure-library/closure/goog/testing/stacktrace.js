goog.setTestOnly("goog.testing.stacktrace");goog.provide("goog.testing.stacktrace");goog.provide("goog.testing.stacktrace.Frame");goog.testing.stacktrace.Frame=function(context,name,alias,path){this.context_=context;this.name_=name;this.alias_=alias;this.path_=path};goog.testing.stacktrace.Frame.prototype.getName=function(){return this.name_};goog.testing.stacktrace.Frame.prototype.isAnonymous=function(){return!this.name_||"[object Object]"==this.context_};goog.testing.stacktrace.Frame.prototype.toCanonicalString=function(){var htmlEscape=goog.testing.stacktrace.htmlEscape_,deobfuscate=goog.testing.stacktrace.maybeDeobfuscateFunctionName_,canonical=[this.context_?htmlEscape(this.context_)+".":"",this.name_?htmlEscape(deobfuscate(this.name_)):"anonymous",this.alias_?" [as "+htmlEscape(deobfuscate(this.alias_))+"]":""];if(this.path_){canonical.push(" at ");canonical.push(htmlEscape(this.path_))}return canonical.join("")};goog.testing.stacktrace.MAX_DEPTH_=20;goog.testing.stacktrace.MAX_FIREFOX_FRAMESTRING_LENGTH_=5e5;goog.testing.stacktrace.IDENTIFIER_PATTERN_="[a-zA-Z_$][\\w$]*";goog.testing.stacktrace.V8_ALIAS_PATTERN_="(?: \\[as ("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")\\])?";goog.testing.stacktrace.V8_CONTEXT_PATTERN_="(?:((?:new )?(?:\\[object Object\\]|"+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"(?:\\."+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")*))\\.)?";goog.testing.stacktrace.V8_FUNCTION_NAME_PATTERN_="(?:new )?(?:"+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"|<anonymous>)";goog.testing.stacktrace.V8_FUNCTION_CALL_PATTERN_=" "+goog.testing.stacktrace.V8_CONTEXT_PATTERN_+"("+goog.testing.stacktrace.V8_FUNCTION_NAME_PATTERN_+")"+goog.testing.stacktrace.V8_ALIAS_PATTERN_;goog.testing.stacktrace.URL_PATTERN_="((?:http|https|file)://[^\\s)]+|javascript:.*)";goog.testing.stacktrace.CHROME_URL_PATTERN_=" (?:"+"\\(unknown source\\)"+"|"+"\\(native\\)"+"|"+"\\((.+)\\)|(.+))";goog.testing.stacktrace.V8_STACK_FRAME_REGEXP_=new RegExp("^    at"+"(?:"+goog.testing.stacktrace.V8_FUNCTION_CALL_PATTERN_+")?"+goog.testing.stacktrace.CHROME_URL_PATTERN_+"$");goog.testing.stacktrace.FIREFOX_FUNCTION_CALL_PATTERN_="("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"(?:\\."+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")*"+")?"+"(\\(.*\\))?@";goog.testing.stacktrace.FIREFOX_STACK_FRAME_REGEXP_=new RegExp("^"+goog.testing.stacktrace.FIREFOX_FUNCTION_CALL_PATTERN_+"(?::0|"+goog.testing.stacktrace.URL_PATTERN_+")$");goog.testing.stacktrace.OPERA_ANONYMOUS_FUNCTION_NAME_PATTERN_="<anonymous function(?:\\: "+"(?:("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"(?:\\."+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")*)\\.)?"+"("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"))?>";goog.testing.stacktrace.OPERA_FUNCTION_CALL_PATTERN_="(?:(?:("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")|"+goog.testing.stacktrace.OPERA_ANONYMOUS_FUNCTION_NAME_PATTERN_+")(\\(.*\\)))?@";goog.testing.stacktrace.OPERA_STACK_FRAME_REGEXP_=new RegExp("^"+goog.testing.stacktrace.OPERA_FUNCTION_CALL_PATTERN_+goog.testing.stacktrace.URL_PATTERN_+"?$");goog.testing.stacktrace.FUNCTION_SOURCE_REGEXP_=new RegExp("^function ("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")");goog.testing.stacktrace.IE_FUNCTION_CALL_PATTERN_="("+goog.testing.stacktrace.IDENTIFIER_PATTERN_+"(?:\\."+goog.testing.stacktrace.IDENTIFIER_PATTERN_+")*"+"(?:\\s+\\w+)*)";goog.testing.stacktrace.IE_STACK_FRAME_REGEXP_=new RegExp("^   at "+goog.testing.stacktrace.IE_FUNCTION_CALL_PATTERN_+"\\s*\\("+"("+"eval code:[^)]*"+"|"+"Unknown script code:[^)]*"+"|"+goog.testing.stacktrace.URL_PATTERN_+")\\)?$");goog.testing.stacktrace.followCallChain_=function(){var frames=[],fn=arguments.callee.caller,depth=0;while(fn&&depth<goog.testing.stacktrace.MAX_DEPTH_){var fnString=Function.prototype.toString.call(fn),match=fnString.match(goog.testing.stacktrace.FUNCTION_SOURCE_REGEXP_),functionName=match?match[1]:"";frames.push(new goog.testing.stacktrace.Frame("",functionName,"",""));try{fn=fn.caller}catch(e){break}depth++}return frames};goog.testing.stacktrace.parseStackFrame_=function(frameStr){var m=frameStr.match(goog.testing.stacktrace.V8_STACK_FRAME_REGEXP_);if(m){return new goog.testing.stacktrace.Frame(m[1]||"",m[2]||"",m[3]||"",m[4]||m[5]||m[6]||"")}if(frameStr.length>goog.testing.stacktrace.MAX_FIREFOX_FRAMESTRING_LENGTH_){return null}m=frameStr.match(goog.testing.stacktrace.FIREFOX_STACK_FRAME_REGEXP_);if(m){return new goog.testing.stacktrace.Frame("",m[1]||"","",m[3]||"")}m=frameStr.match(goog.testing.stacktrace.OPERA_STACK_FRAME_REGEXP_);if(m){return new goog.testing.stacktrace.Frame(m[2]||"",m[1]||m[3]||"","",m[5]||"")}m=frameStr.match(goog.testing.stacktrace.IE_STACK_FRAME_REGEXP_);if(m){return new goog.testing.stacktrace.Frame("",m[1]||"","",m[2]||"")}return null};goog.testing.stacktrace.deobfuscateFunctionName_;goog.testing.stacktrace.setDeobfuscateFunctionName=function(fn){goog.testing.stacktrace.deobfuscateFunctionName_=fn};goog.testing.stacktrace.maybeDeobfuscateFunctionName_=function(name){return goog.testing.stacktrace.deobfuscateFunctionName_?goog.testing.stacktrace.deobfuscateFunctionName_(name):name};goog.testing.stacktrace.htmlEscape_=function(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};goog.testing.stacktrace.framesToString_=function(frames){var lastIndex=frames.length-1;while(frames[lastIndex]&&frames[lastIndex].isAnonymous()){lastIndex--}for(var privateAssertIndex=-1,i=0;i<frames.length;i++){if(frames[i]&&"_assert"==frames[i].getName()){privateAssertIndex=i;break}}for(var canonical=[],i=privateAssertIndex+1;i<=lastIndex;i++){canonical.push("> ");if(frames[i]){canonical.push(frames[i].toCanonicalString())}else{canonical.push("(unknown)")}canonical.push("\n")}return canonical.join("")};goog.testing.stacktrace.parse_=function(stack){for(var lines=stack.replace(/\s*$/,"").split("\n"),frames=[],i=0;i<lines.length;i++){frames.push(goog.testing.stacktrace.parseStackFrame_(lines[i]))}return frames};goog.testing.stacktrace.canonicalize=function(stack){var frames=goog.testing.stacktrace.parse_(stack);return goog.testing.stacktrace.framesToString_(frames)};goog.testing.stacktrace.getNativeStack_=function(){var tmpError=new Error;if(tmpError.stack){return tmpError.stack}try{null.x()}catch(e){return e.stack}return""};goog.testing.stacktrace.get=function(){var stack=goog.testing.stacktrace.getNativeStack_(),frames;if(!stack){frames=goog.testing.stacktrace.followCallChain_()}else if(goog.isArray(stack)){frames=goog.testing.stacktrace.callSitesToFrames_(stack)}else{frames=goog.testing.stacktrace.parse_(stack)}return goog.testing.stacktrace.framesToString_(frames)};goog.testing.stacktrace.callSitesToFrames_=function(stack){for(var frames=[],i=0;i<stack.length;i++){var callSite=stack[i],functionName=callSite.getFunctionName()||"unknown",fileName=callSite.getFileName(),path=fileName?fileName+":"+callSite.getLineNumber()+":"+callSite.getColumnNumber():"unknown";frames.push(new goog.testing.stacktrace.Frame("",functionName,"",path))}return frames};goog.exportSymbol("setDeobfuscateFunctionName",goog.testing.stacktrace.setDeobfuscateFunctionName);