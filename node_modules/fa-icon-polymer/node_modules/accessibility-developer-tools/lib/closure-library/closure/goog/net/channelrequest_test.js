goog.provide("goog.net.ChannelRequestTest");goog.setTestOnly("goog.net.ChannelRequestTest");goog.require("goog.Uri");goog.require("goog.functions");goog.require("goog.net.BrowserChannel");goog.require("goog.net.ChannelDebug");goog.require("goog.net.ChannelRequest");goog.require("goog.testing.MockClock");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.jsunit");goog.require("goog.testing.net.XhrIo");goog.require("goog.testing.recordFunction");var channelRequest,mockBrowserChannel,mockClock,stubs,xhrIo,WATCHDOG_TIME=2e3,THROTTLE_TIME=500,ALL_DAY_MS=24*(60*(60*1e3));function setUp(){mockClock=new goog.testing.MockClock;mockClock.install();stubs=new goog.testing.PropertyReplacer}function tearDown(){stubs.reset();mockClock.uninstall()}function MockBrowserChannel(){this.reachabilityEvents={};this.isClosed=function(){return!1};this.isActive=function(){return!0};this.shouldUseSecondaryDomains=function(){return!1};this.completedRequests=[];this.notifyServerReachabilityEvent=function(reachabilityType){if(!this.reachabilityEvents[reachabilityType]){this.reachabilityEvents[reachabilityType]=0}this.reachabilityEvents[reachabilityType]++};this.onRequestComplete=function(request){this.completedRequests.push(request)};this.onRequestData=function(request,data){}}function createChannelRequest(){xhrIo=new goog.testing.net.XhrIo;xhrIo.abort=xhrIo.abort||function(){this.active_=!1};mockBrowserChannel=new MockBrowserChannel;channelRequest=new goog.net.ChannelRequest(mockBrowserChannel,new goog.net.ChannelDebug());mockBrowserChannel.createXhrIo=function(){return xhrIo};channelRequest.watchdogTimeoutCallCount=0;channelRequest.originalOnWatchDogTimeout=channelRequest.onWatchDogTimeout_;channelRequest.onWatchDogTimeout_=function(){this.watchdogTimeoutCallCount++;return this.originalOnWatchDogTimeout()};channelRequest.setTimeout(WATCHDOG_TIME)}function testNetworkEvents(){createChannelRequest();channelRequest.xmlHttpPost(new goog.Uri("some_uri"),"some_postdata",!0);checkReachabilityEvents(1,0,0,0);if(goog.net.ChannelRequest.supportsXhrStreaming()){xhrIo.simulatePartialResponse("17\nI am a BC Message");checkReachabilityEvents(1,0,0,1);xhrIo.simulatePartialResponse("23\nI am another BC Message");checkReachabilityEvents(1,0,0,2);xhrIo.simulateResponse(200,"16Final BC Message");checkReachabilityEvents(1,1,0,2)}else{xhrIo.simulateResponse(200,"16Final BC Message");checkReachabilityEvents(1,1,0,0)}}function testNetworkEvents_throttleReadyStateChange(){createChannelRequest();channelRequest.setReadyStateChangeThrottle(THROTTLE_TIME);var recordedHandler=goog.testing.recordFunction(channelRequest.xmlHttpHandler_);stubs.set(channelRequest,"xmlHttpHandler_",recordedHandler);channelRequest.xmlHttpPost(new goog.Uri("some_uri"),"some_postdata",!0);assertEquals(1,recordedHandler.getCallCount());checkReachabilityEvents(1,0,0,0);if(goog.net.ChannelRequest.supportsXhrStreaming()){xhrIo.simulatePartialResponse("17\nI am a BC Message");checkReachabilityEvents(1,0,0,1);assertEquals(3,recordedHandler.getCallCount());xhrIo.simulatePartialResponse("23\nI am another BC Message");assertEquals(3,recordedHandler.getCallCount());xhrIo.simulatePartialResponse("27\nI am yet another BC Message");assertEquals(3,recordedHandler.getCallCount());mockClock.tick(THROTTLE_TIME);checkReachabilityEvents(1,0,0,3);assertEquals(4,recordedHandler.getCallCount());xhrIo.simulateResponse(200,"16Final BC Message");checkReachabilityEvents(1,1,0,3);assertEquals(5,recordedHandler.getCallCount())}else{xhrIo.simulateResponse(200,"16Final BC Message");checkReachabilityEvents(1,1,0,0)}}function testRequestTimeout(){createChannelRequest();channelRequest.xmlHttpPost(new goog.Uri("some_uri"),"some_postdata",!0);assertEquals(0,channelRequest.watchdogTimeoutCallCount);assertEquals(0,channelRequest.channel_.completedRequests.length);mockClock.tick(WATCHDOG_TIME);assertEquals(1,channelRequest.watchdogTimeoutCallCount);assertEquals(1,channelRequest.channel_.completedRequests.length);assertFalse(channelRequest.getSuccess());mockClock.tick(ALL_DAY_MS);assertEquals(1,channelRequest.watchdogTimeoutCallCount);assertEquals(1,channelRequest.channel_.completedRequests.length);checkReachabilityEvents(1,0,1,0)}function testRequestTimeoutWithUnexpectedException(){createChannelRequest();channelRequest.channel_.createXhrIo=goog.functions.error("Weird error");try{channelRequest.xmlHttpGet(new goog.Uri("some_uri"),!0,null);fail("Expected error")}catch(e){assertEquals("Weird error",e.message)}assertEquals(0,channelRequest.watchdogTimeoutCallCount);assertEquals(0,channelRequest.channel_.completedRequests.length);mockClock.tick(WATCHDOG_TIME);assertEquals(1,channelRequest.watchdogTimeoutCallCount);assertEquals(1,channelRequest.channel_.completedRequests.length);assertFalse(channelRequest.getSuccess());mockClock.tick(ALL_DAY_MS);assertEquals(1,channelRequest.watchdogTimeoutCallCount);assertEquals(1,channelRequest.channel_.completedRequests.length);checkReachabilityEvents(0,0,1,0)}function testActiveXBlocked(){createChannelRequest();stubs.set(goog.global,"ActiveXObject",goog.functions.error("Active X blocked"));channelRequest.tridentGet(new goog.Uri("some_uri"),!1);assertFalse(channelRequest.getSuccess());assertEquals(goog.net.ChannelRequest.Error.ACTIVE_X_BLOCKED,channelRequest.getLastError());checkReachabilityEvents(0,0,0,0)}function testEscapeForStringInScript(){var actual=goog.net.ChannelRequest.escapeForStringInScript_("\"'<>");assertEquals("\\\"\\'\\x3c\\x3e",actual)}function checkReachabilityEvents(reqMade,reqSucceeded,reqFail,backChannel){var Reachability=goog.net.BrowserChannel.ServerReachability;assertEquals(reqMade,mockBrowserChannel.reachabilityEvents[Reachability.REQUEST_MADE]||0);assertEquals(reqSucceeded,mockBrowserChannel.reachabilityEvents[Reachability.REQUEST_SUCCEEDED]||0);assertEquals(reqFail,mockBrowserChannel.reachabilityEvents[Reachability.REQUEST_FAILED]||0);assertEquals(backChannel,mockBrowserChannel.reachabilityEvents[Reachability.BACK_CHANNEL_ACTIVITY]||0)}