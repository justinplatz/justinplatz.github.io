goog.provide("goog.ui.tree.BaseNode");goog.provide("goog.ui.tree.BaseNode.EventType");goog.require("goog.Timer");goog.require("goog.a11y.aria");goog.require("goog.asserts");goog.require("goog.dom.safe");goog.require("goog.events.Event");goog.require("goog.events.KeyCodes");goog.require("goog.html.SafeHtml");goog.require("goog.html.SafeStyle");goog.require("goog.string");goog.require("goog.string.StringBuffer");goog.require("goog.style");goog.require("goog.ui.Component");goog.ui.tree.BaseNode=function(content,opt_config,opt_domHelper){goog.ui.Component.call(this,opt_domHelper);this.config_=opt_config||goog.ui.tree.BaseNode.defaultConfig;this.html_=goog.html.SafeHtml.htmlEscapePreservingNewlines(content);this.iconClass_;this.expandedIconClass_;this.tree;this.previousSibling_;this.nextSibling_;this.firstChild_;this.lastChild_;this.selected_=!1;this.expanded_=!1;this.toolTip_=null;this.afterLabelHtml_=goog.html.SafeHtml.EMPTY;this.isUserCollapsible_=!0;this.depth_=-1};goog.inherits(goog.ui.tree.BaseNode,goog.ui.Component);goog.ui.tree.BaseNode.EventType={BEFORE_EXPAND:"beforeexpand",EXPAND:"expand",BEFORE_COLLAPSE:"beforecollapse",COLLAPSE:"collapse"};goog.ui.tree.BaseNode.allNodes={};goog.ui.tree.BaseNode.prototype.disposeInternal=function(){goog.ui.tree.BaseNode.superClass_.disposeInternal.call(this);if(this.tree){this.tree.removeNode(this);this.tree=null}this.setElementInternal(null)};goog.ui.tree.BaseNode.prototype.initAccessibility=function(){var el=this.getElement();if(el){var label=this.getLabelElement();if(label&&!label.id){label.id=this.getId()+".label"}goog.a11y.aria.setRole(el,"treeitem");goog.a11y.aria.setState(el,"selected",!1);goog.a11y.aria.setState(el,"expanded",!1);goog.a11y.aria.setState(el,"level",this.getDepth());if(label){goog.a11y.aria.setState(el,"labelledby",label.id)}var img=this.getIconElement();if(img){goog.a11y.aria.setRole(img,"presentation")}var ei=this.getExpandIconElement();if(ei){goog.a11y.aria.setRole(ei,"presentation")}var ce=this.getChildrenElement();if(ce){goog.a11y.aria.setRole(ce,"group");if(ce.hasChildNodes()){for(var count=this.getChildCount(),i=1,child;i<=count;i++){child=this.getChildAt(i-1).getElement();goog.asserts.assert(child,"The child element cannot be null");goog.a11y.aria.setState(child,"setsize",count);goog.a11y.aria.setState(child,"posinset",i)}}}}};goog.ui.tree.BaseNode.prototype.createDom=function(){var element=this.getDomHelper().safeHtmlToNode(this.toSafeHtml());this.setElementInternal(element)};goog.ui.tree.BaseNode.prototype.enterDocument=function(){goog.ui.tree.BaseNode.superClass_.enterDocument.call(this);goog.ui.tree.BaseNode.allNodes[this.getId()]=this;this.initAccessibility()};goog.ui.tree.BaseNode.prototype.exitDocument=function(){goog.ui.tree.BaseNode.superClass_.exitDocument.call(this);delete goog.ui.tree.BaseNode.allNodes[this.getId()]};goog.ui.tree.BaseNode.prototype.addChildAt=function(child,index,opt_render){goog.asserts.assert(!child.getParent());goog.asserts.assertInstanceof(child,goog.ui.tree.BaseNode);var prevNode=this.getChildAt(index-1),nextNode=this.getChildAt(index);goog.ui.tree.BaseNode.superClass_.addChildAt.call(this,child,index);child.previousSibling_=prevNode;child.nextSibling_=nextNode;if(prevNode){prevNode.nextSibling_=child}else{this.firstChild_=child}if(nextNode){nextNode.previousSibling_=child}else{this.lastChild_=child}var tree=this.getTree();if(tree){child.setTreeInternal(tree)}child.setDepth_(this.getDepth()+1);if(this.getElement()){this.updateExpandIcon();if(this.getExpanded()){var el=this.getChildrenElement();if(!child.getElement()){child.createDom()}var childElement=child.getElement(),nextElement=nextNode&&nextNode.getElement();el.insertBefore(childElement,nextElement);if(this.isInDocument()){child.enterDocument()}if(!nextNode){if(prevNode){prevNode.updateExpandIcon()}else{goog.style.setElementShown(el,!0);this.setExpanded(this.getExpanded())}}}}};goog.ui.tree.BaseNode.prototype.add=function(child,opt_before){goog.asserts.assert(!opt_before||opt_before.getParent()==this,"Can only add nodes before siblings");if(child.getParent()){child.getParent().removeChild(child)}this.addChildAt(child,opt_before?this.indexOfChild(opt_before):this.getChildCount());return child};goog.ui.tree.BaseNode.prototype.removeChild=function(childNode,opt_unrender){var child=childNode,tree=this.getTree(),selectedNode=tree?tree.getSelectedItem():null;if(selectedNode==child||child.contains(selectedNode)){if(tree.hasFocus()){this.select();goog.Timer.callOnce(this.onTimeoutSelect_,10,this)}else{this.select()}}goog.ui.tree.BaseNode.superClass_.removeChild.call(this,child);if(this.lastChild_==child){this.lastChild_=child.previousSibling_}if(this.firstChild_==child){this.firstChild_=child.nextSibling_}if(child.previousSibling_){child.previousSibling_.nextSibling_=child.nextSibling_}if(child.nextSibling_){child.nextSibling_.previousSibling_=child.previousSibling_}var wasLast=child.isLastSibling();child.tree=null;child.depth_=-1;if(tree){tree.removeNode(child);if(this.isInDocument()){var el=this.getChildrenElement();if(child.isInDocument()){var childEl=child.getElement();el.removeChild(childEl);child.exitDocument()}if(wasLast){var newLast=this.getLastChild();if(newLast){newLast.updateExpandIcon()}}if(!this.hasChildren()){el.style.display="none";this.updateExpandIcon();this.updateIcon_()}}}return child};goog.ui.tree.BaseNode.prototype.remove=goog.ui.tree.BaseNode.prototype.removeChild;goog.ui.tree.BaseNode.prototype.onTimeoutSelect_=function(){this.select()};goog.ui.tree.BaseNode.prototype.getTree=goog.abstractMethod;goog.ui.tree.BaseNode.prototype.getDepth=function(){var depth=this.depth_;if(0>depth){depth=this.computeDepth_();this.setDepth_(depth)}return depth};goog.ui.tree.BaseNode.prototype.computeDepth_=function(){var parent=this.getParent();if(parent){return parent.getDepth()+1}else{return 0}};goog.ui.tree.BaseNode.prototype.setDepth_=function(depth){if(depth!=this.depth_){this.depth_=depth;var row=this.getRowElement();if(row){var indent=this.getPixelIndent_()+"px";if(this.isRightToLeft()){row.style.paddingRight=indent}else{row.style.paddingLeft=indent}}this.forEachChild(function(child){child.setDepth_(depth+1)})}};goog.ui.tree.BaseNode.prototype.contains=function(node){var current=node;while(current){if(current==this){return!0}current=current.getParent()}return!1};goog.ui.tree.BaseNode.EMPTY_CHILDREN_=[];goog.ui.tree.BaseNode.prototype.getChildAt;goog.ui.tree.BaseNode.prototype.getChildren=function(){var children=[];this.forEachChild(function(child){children.push(child)});return children};goog.ui.tree.BaseNode.prototype.getFirstChild=function(){return this.getChildAt(0)};goog.ui.tree.BaseNode.prototype.getLastChild=function(){return this.getChildAt(this.getChildCount()-1)};goog.ui.tree.BaseNode.prototype.getPreviousSibling=function(){return this.previousSibling_};goog.ui.tree.BaseNode.prototype.getNextSibling=function(){return this.nextSibling_};goog.ui.tree.BaseNode.prototype.isLastSibling=function(){return!this.nextSibling_};goog.ui.tree.BaseNode.prototype.isSelected=function(){return this.selected_};goog.ui.tree.BaseNode.prototype.select=function(){var tree=this.getTree();if(tree){tree.setSelectedItem(this)}};goog.ui.tree.BaseNode.prototype.deselect=goog.nullFunction;goog.ui.tree.BaseNode.prototype.setSelectedInternal=function(selected){if(this.selected_==selected){return}this.selected_=selected;this.updateRow();var el=this.getElement();if(el){goog.a11y.aria.setState(el,"selected",selected);if(selected){var treeElement=this.getTree().getElement();goog.asserts.assert(treeElement,"The DOM element for the tree cannot be null");goog.a11y.aria.setState(treeElement,"activedescendant",this.getId())}}};goog.ui.tree.BaseNode.prototype.getExpanded=function(){return this.expanded_};goog.ui.tree.BaseNode.prototype.setExpandedInternal=function(expanded){this.expanded_=expanded};goog.ui.tree.BaseNode.prototype.setExpanded=function(expanded){var isStateChange=expanded!=this.expanded_;if(isStateChange){var prevented=!this.dispatchEvent(expanded?goog.ui.tree.BaseNode.EventType.BEFORE_EXPAND:goog.ui.tree.BaseNode.EventType.BEFORE_COLLAPSE);if(prevented)return}var ce;this.expanded_=expanded;var tree=this.getTree(),el=this.getElement();if(this.hasChildren()){if(!expanded&&tree&&this.contains(tree.getSelectedItem())){this.select()}if(el){ce=this.getChildrenElement();if(ce){goog.style.setElementShown(ce,expanded);if(expanded&&this.isInDocument()&&!ce.hasChildNodes()){var children=[];this.forEachChild(function(child){children.push(child.toSafeHtml())});goog.dom.safe.setInnerHtml(ce,goog.html.SafeHtml.concat(children));this.forEachChild(function(child){child.enterDocument()})}}this.updateExpandIcon()}}else{ce=this.getChildrenElement();if(ce){goog.style.setElementShown(ce,!1)}}if(el){this.updateIcon_();goog.a11y.aria.setState(el,"expanded",expanded)}if(isStateChange){this.dispatchEvent(expanded?goog.ui.tree.BaseNode.EventType.EXPAND:goog.ui.tree.BaseNode.EventType.COLLAPSE)}};goog.ui.tree.BaseNode.prototype.toggle=function(){this.setExpanded(!this.getExpanded())};goog.ui.tree.BaseNode.prototype.expand=function(){this.setExpanded(!0)};goog.ui.tree.BaseNode.prototype.collapse=function(){this.setExpanded(!1)};goog.ui.tree.BaseNode.prototype.collapseChildren=function(){this.forEachChild(function(child){child.collapseAll()})};goog.ui.tree.BaseNode.prototype.collapseAll=function(){this.collapseChildren();this.collapse()};goog.ui.tree.BaseNode.prototype.expandChildren=function(){this.forEachChild(function(child){child.expandAll()})};goog.ui.tree.BaseNode.prototype.expandAll=function(){this.expandChildren();this.expand()};goog.ui.tree.BaseNode.prototype.reveal=function(){var parent=this.getParent();if(parent){parent.setExpanded(!0);parent.reveal()}};goog.ui.tree.BaseNode.prototype.setIsUserCollapsible=function(isCollapsible){this.isUserCollapsible_=isCollapsible;if(!this.isUserCollapsible_){this.expand()}if(this.getElement()){this.updateExpandIcon()}};goog.ui.tree.BaseNode.prototype.isUserCollapsible=function(){return this.isUserCollapsible_};goog.ui.tree.BaseNode.prototype.toSafeHtml=function(){var tree=this.getTree(),hideLines=!tree.getShowLines()||tree==this.getParent()&&!tree.getShowRootLines(),childClass=hideLines?this.config_.cssChildrenNoLines:this.config_.cssChildren,nonEmptyAndExpanded=this.getExpanded()&&this.hasChildren(),attributes={class:childClass,style:this.getLineStyle()},content=[];if(nonEmptyAndExpanded){this.forEachChild(function(child){content.push(child.toSafeHtml())})}var children=goog.html.SafeHtml.create("div",attributes,content);return goog.html.SafeHtml.create("div",{class:this.config_.cssItem,id:this.getId()},[this.getRowSafeHtml(),children])};goog.ui.tree.BaseNode.prototype.getPixelIndent_=function(){return Math.max(0,(this.getDepth()-1)*this.config_.indentWidth)};goog.ui.tree.BaseNode.prototype.getRowSafeHtml=function(){var style={};style["padding-"+(this.isRightToLeft()?"right":"left")]=this.getPixelIndent_()+"px";var attributes={class:this.getRowClassName(),style:style},content=[this.getExpandIconSafeHtml(),this.getIconSafeHtml(),this.getLabelSafeHtml()];return goog.html.SafeHtml.create("div",attributes,content)};goog.ui.tree.BaseNode.prototype.getRowClassName=function(){var selectedClass;if(this.isSelected()){selectedClass=" "+this.config_.cssSelectedRow}else{selectedClass=""}return this.config_.cssTreeRow+selectedClass};goog.ui.tree.BaseNode.prototype.getLabelSafeHtml=function(){var html=goog.html.SafeHtml.create("span",{class:this.config_.cssItemLabel,title:this.getToolTip()||null},this.getSafeHtml());return goog.html.SafeHtml.concat(html,goog.html.SafeHtml.create("span",{},this.getAfterLabelSafeHtml()))};goog.ui.tree.BaseNode.prototype.getAfterLabelHtml=function(){return goog.html.SafeHtml.unwrap(this.getAfterLabelSafeHtml())};goog.ui.tree.BaseNode.prototype.getAfterLabelSafeHtml=function(){return this.afterLabelHtml_};goog.ui.tree.BaseNode.prototype.setAfterLabelSafeHtml=function(html){this.afterLabelHtml_=html;var el=this.getAfterLabelElement();if(el){goog.dom.safe.setInnerHtml(el,html)}};goog.ui.tree.BaseNode.prototype.getIconSafeHtml=function(){return goog.html.SafeHtml.create("span",{style:{display:"inline-block"},class:this.getCalculatedIconClass()})};goog.ui.tree.BaseNode.prototype.getCalculatedIconClass=goog.abstractMethod;goog.ui.tree.BaseNode.prototype.getExpandIconSafeHtml=function(){return goog.html.SafeHtml.create("span",{type:"expand",style:{display:"inline-block"},class:this.getExpandIconClass()})};goog.ui.tree.BaseNode.prototype.getExpandIconClass=function(){var tree=this.getTree(),hideLines=!tree.getShowLines()||tree==this.getParent()&&!tree.getShowRootLines(),config=this.config_,sb=new goog.string.StringBuffer;sb.append(config.cssTreeIcon," ",config.cssExpandTreeIcon," ");if(this.hasChildren()){var bits=0;if(tree.getShowExpandIcons()&&this.isUserCollapsible_){if(this.getExpanded()){bits=2}else{bits=1}}if(!hideLines){if(this.isLastSibling()){bits+=4}else{bits+=8}}switch(bits){case 1:sb.append(config.cssExpandTreeIconPlus);break;case 2:sb.append(config.cssExpandTreeIconMinus);break;case 4:sb.append(config.cssExpandTreeIconL);break;case 5:sb.append(config.cssExpandTreeIconLPlus);break;case 6:sb.append(config.cssExpandTreeIconLMinus);break;case 8:sb.append(config.cssExpandTreeIconT);break;case 9:sb.append(config.cssExpandTreeIconTPlus);break;case 10:sb.append(config.cssExpandTreeIconTMinus);break;default:sb.append(config.cssExpandTreeIconBlank);}}else{if(hideLines){sb.append(config.cssExpandTreeIconBlank)}else if(this.isLastSibling()){sb.append(config.cssExpandTreeIconL)}else{sb.append(config.cssExpandTreeIconT)}}return sb.toString()};goog.ui.tree.BaseNode.prototype.getLineStyle=function(){var nonEmptyAndExpanded=this.getExpanded()&&this.hasChildren();return goog.html.SafeStyle.create({"background-position":this.getBackgroundPosition(),display:nonEmptyAndExpanded?null:"none"})};goog.ui.tree.BaseNode.prototype.getBackgroundPosition=function(){return(this.isLastSibling()?"-100":(this.getDepth()-1)*this.config_.indentWidth)+"px 0"};goog.ui.tree.BaseNode.prototype.getElement=function(){var el=goog.ui.tree.BaseNode.superClass_.getElement.call(this);if(!el){el=this.getDomHelper().getElement(this.getId());this.setElementInternal(el)}return el};goog.ui.tree.BaseNode.prototype.getRowElement=function(){var el=this.getElement();return el?el.firstChild:null};goog.ui.tree.BaseNode.prototype.getExpandIconElement=function(){var el=this.getRowElement();return el?el.firstChild:null};goog.ui.tree.BaseNode.prototype.getIconElement=function(){var el=this.getRowElement();return el?el.childNodes[1]:null};goog.ui.tree.BaseNode.prototype.getLabelElement=function(){var el=this.getRowElement();return el&&el.lastChild?el.lastChild.previousSibling:null};goog.ui.tree.BaseNode.prototype.getAfterLabelElement=function(){var el=this.getRowElement();return el?el.lastChild:null};goog.ui.tree.BaseNode.prototype.getChildrenElement=function(){var el=this.getElement();return el?el.lastChild:null};goog.ui.tree.BaseNode.prototype.setIconClass=function(s){this.iconClass_=s;if(this.isInDocument()){this.updateIcon_()}};goog.ui.tree.BaseNode.prototype.getIconClass=function(){return this.iconClass_};goog.ui.tree.BaseNode.prototype.setExpandedIconClass=function(s){this.expandedIconClass_=s;if(this.isInDocument()){this.updateIcon_()}};goog.ui.tree.BaseNode.prototype.getExpandedIconClass=function(){return this.expandedIconClass_};goog.ui.tree.BaseNode.prototype.setText=function(s){this.setSafeHtml(goog.html.SafeHtml.htmlEscape(s))};goog.ui.tree.BaseNode.prototype.getText=function(){return goog.string.unescapeEntities(goog.html.SafeHtml.unwrap(this.html_))};goog.ui.tree.BaseNode.prototype.setSafeHtml=function(html){this.html_=html;var el=this.getLabelElement();if(el){goog.dom.safe.setInnerHtml(el,html)}var tree=this.getTree();if(tree){tree.setNode(this)}};goog.ui.tree.BaseNode.prototype.getHtml=function(){return goog.html.SafeHtml.unwrap(this.getSafeHtml())};goog.ui.tree.BaseNode.prototype.getSafeHtml=function(){return this.html_};goog.ui.tree.BaseNode.prototype.setToolTip=function(s){this.toolTip_=s;var el=this.getLabelElement();if(el){el.title=s}};goog.ui.tree.BaseNode.prototype.getToolTip=function(){return this.toolTip_};goog.ui.tree.BaseNode.prototype.updateRow=function(){var rowEl=this.getRowElement();if(rowEl){rowEl.className=this.getRowClassName()}};goog.ui.tree.BaseNode.prototype.updateExpandIcon=function(){var img=this.getExpandIconElement();if(img){img.className=this.getExpandIconClass()}var cel=this.getChildrenElement();if(cel){cel.style.backgroundPosition=this.getBackgroundPosition()}};goog.ui.tree.BaseNode.prototype.updateIcon_=function(){this.getIconElement().className=this.getCalculatedIconClass()};goog.ui.tree.BaseNode.prototype.onMouseDown=function(e){var el=e.target,type=el.getAttribute("type");if("expand"==type&&this.hasChildren()){if(this.isUserCollapsible_){this.toggle()}return}this.select();this.updateRow()};goog.ui.tree.BaseNode.prototype.onClick_=goog.events.Event.preventDefault;goog.ui.tree.BaseNode.prototype.onDoubleClick_=function(e){var el=e.target,type=el.getAttribute("type");if("expand"==type&&this.hasChildren()){return}if(this.isUserCollapsible_){this.toggle()}};goog.ui.tree.BaseNode.prototype.onKeyDown=function(e){var handled=!0;switch(e.keyCode){case goog.events.KeyCodes.RIGHT:if(e.altKey){break}if(this.hasChildren()){if(!this.getExpanded()){this.setExpanded(!0)}else{this.getFirstChild().select()}}break;case goog.events.KeyCodes.LEFT:if(e.altKey){break}if(this.hasChildren()&&this.getExpanded()&&this.isUserCollapsible_){this.setExpanded(!1)}else{var parent=this.getParent(),tree=this.getTree();if(parent&&(tree.getShowRootNode()||parent!=tree)){parent.select()}}break;case goog.events.KeyCodes.DOWN:var nextNode=this.getNextShownNode();if(nextNode){nextNode.select()}break;case goog.events.KeyCodes.UP:var previousNode=this.getPreviousShownNode();if(previousNode){previousNode.select()}break;default:handled=!1;}if(handled){e.preventDefault();var tree=this.getTree();if(tree){tree.clearTypeAhead()}}return handled};goog.ui.tree.BaseNode.prototype.getLastShownDescendant=function(){if(!this.getExpanded()||!this.hasChildren()){return this}return this.getLastChild().getLastShownDescendant()};goog.ui.tree.BaseNode.prototype.getNextShownNode=function(){if(this.hasChildren()&&this.getExpanded()){return this.getFirstChild()}else{var parent=this,next;while(parent!=this.getTree()){next=parent.getNextSibling();if(null!=next){return next}parent=parent.getParent()}return null}};goog.ui.tree.BaseNode.prototype.getPreviousShownNode=function(){var ps=this.getPreviousSibling();if(null!=ps){return ps.getLastShownDescendant()}var parent=this.getParent(),tree=this.getTree();if(!tree.getShowRootNode()&&parent==tree){return null}if(this==tree){return null}return parent};goog.ui.tree.BaseNode.prototype.getClientData=goog.ui.tree.BaseNode.prototype.getModel;goog.ui.tree.BaseNode.prototype.setClientData=goog.ui.tree.BaseNode.prototype.setModel;goog.ui.tree.BaseNode.prototype.getConfig=function(){return this.config_};goog.ui.tree.BaseNode.prototype.setTreeInternal=function(tree){if(this.tree!=tree){this.tree=tree;tree.setNode(this);this.forEachChild(function(child){child.setTreeInternal(tree)})}};goog.ui.tree.BaseNode.defaultConfig={indentWidth:19,cssRoot:goog.getCssName("goog-tree-root")+" "+goog.getCssName("goog-tree-item"),cssHideRoot:goog.getCssName("goog-tree-hide-root"),cssItem:goog.getCssName("goog-tree-item"),cssChildren:goog.getCssName("goog-tree-children"),cssChildrenNoLines:goog.getCssName("goog-tree-children-nolines"),cssTreeRow:goog.getCssName("goog-tree-row"),cssItemLabel:goog.getCssName("goog-tree-item-label"),cssTreeIcon:goog.getCssName("goog-tree-icon"),cssExpandTreeIcon:goog.getCssName("goog-tree-expand-icon"),cssExpandTreeIconPlus:goog.getCssName("goog-tree-expand-icon-plus"),cssExpandTreeIconMinus:goog.getCssName("goog-tree-expand-icon-minus"),cssExpandTreeIconTPlus:goog.getCssName("goog-tree-expand-icon-tplus"),cssExpandTreeIconTMinus:goog.getCssName("goog-tree-expand-icon-tminus"),cssExpandTreeIconLPlus:goog.getCssName("goog-tree-expand-icon-lplus"),cssExpandTreeIconLMinus:goog.getCssName("goog-tree-expand-icon-lminus"),cssExpandTreeIconT:goog.getCssName("goog-tree-expand-icon-t"),cssExpandTreeIconL:goog.getCssName("goog-tree-expand-icon-l"),cssExpandTreeIconBlank:goog.getCssName("goog-tree-expand-icon-blank"),cssExpandedFolderIcon:goog.getCssName("goog-tree-expanded-folder-icon"),cssCollapsedFolderIcon:goog.getCssName("goog-tree-collapsed-folder-icon"),cssFileIcon:goog.getCssName("goog-tree-file-icon"),cssExpandedRootIcon:goog.getCssName("goog-tree-expanded-folder-icon"),cssCollapsedRootIcon:goog.getCssName("goog-tree-collapsed-folder-icon"),cssSelectedRow:goog.getCssName("selected")};