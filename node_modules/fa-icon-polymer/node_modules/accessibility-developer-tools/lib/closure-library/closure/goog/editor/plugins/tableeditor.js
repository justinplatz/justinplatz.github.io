goog.provide("goog.editor.plugins.TableEditor");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.Plugin");goog.require("goog.editor.Table");goog.require("goog.editor.node");goog.require("goog.editor.range");goog.require("goog.object");goog.require("goog.userAgent");goog.editor.plugins.TableEditor=function(){goog.editor.plugins.TableEditor.base(this,"constructor");this.isTableEditableFunctions_=[];this.isUserEditableTableBound_=goog.bind(this.isUserEditableTable_,this)};goog.inherits(goog.editor.plugins.TableEditor,goog.editor.Plugin);goog.editor.plugins.TableEditor.prototype.getTrogClassId=function(){return goog.getUid(this.constructor)+""};goog.editor.plugins.TableEditor.COMMAND={TABLE:"+table",INSERT_ROW_AFTER:"+insertRowAfter",INSERT_ROW_BEFORE:"+insertRowBefore",INSERT_COLUMN_AFTER:"+insertColumnAfter",INSERT_COLUMN_BEFORE:"+insertColumnBefore",REMOVE_ROWS:"+removeRows",REMOVE_COLUMNS:"+removeColumns",SPLIT_CELL:"+splitCell",MERGE_CELLS:"+mergeCells",REMOVE_TABLE:"+removeTable"};goog.editor.plugins.TableEditor.SUPPORTED_COMMANDS_=goog.object.transpose(goog.editor.plugins.TableEditor.COMMAND);goog.editor.plugins.TableEditor.prototype.isSupportedCommand=function(command){return command in goog.editor.plugins.TableEditor.SUPPORTED_COMMANDS_};goog.editor.plugins.TableEditor.prototype.enable=function(fieldObject){goog.editor.plugins.TableEditor.base(this,"enable",fieldObject);if(goog.userAgent.GECKO){var doc=this.getFieldDomHelper().getDocument();doc.execCommand("enableObjectResizing",!1,"true")}};goog.editor.plugins.TableEditor.prototype.getCurrentTable_=function(){var selectedElement=this.getFieldObject().getRange().getContainer();return this.getAncestorTable_(selectedElement)};goog.editor.plugins.TableEditor.prototype.getAncestorTable_=function(node){var ancestor=goog.dom.getAncestor(node,this.isUserEditableTableBound_,!0);if(goog.editor.node.isEditable(ancestor)){return ancestor}else{return null}};goog.editor.plugins.TableEditor.prototype.queryCommandValue=function(command){if(command==goog.editor.plugins.TableEditor.COMMAND.TABLE){return!!this.getCurrentTable_()}};goog.editor.plugins.TableEditor.prototype.execCommandInternal=function(command,opt_arg){var _Mathmin=Math.min,result=null,cursorCell=null,range=this.getFieldObject().getRange();if(command==goog.editor.plugins.TableEditor.COMMAND.TABLE){if(!goog.editor.range.isEditable(range)){return null}var tableProps=opt_arg||{width:4,height:2},doc=this.getFieldDomHelper().getDocument(),table=goog.editor.Table.createDomTable(doc,tableProps.width,tableProps.height);range.replaceContentsWithNode(table);if(!goog.userAgent.IE){cursorCell=goog.dom.getElementsByTagName(goog.dom.TagName.TD,table)[0]}}else{var cellSelection=new goog.editor.plugins.TableEditor.CellSelection_(range,goog.bind(this.getAncestorTable_,this)),table=cellSelection.getTable();if(!table){return null}switch(command){case goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_BEFORE:table.insertRow(cellSelection.getFirstRowIndex());break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_ROW_AFTER:table.insertRow(cellSelection.getLastRowIndex()+1);break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_BEFORE:table.insertColumn(cellSelection.getFirstColumnIndex());break;case goog.editor.plugins.TableEditor.COMMAND.INSERT_COLUMN_AFTER:table.insertColumn(cellSelection.getLastColumnIndex()+1);break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_ROWS:var startRow=cellSelection.getFirstRowIndex(),endRow=cellSelection.getLastRowIndex();if(0==startRow&&endRow==table.rows.length-1){return this.execCommandInternal(goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE)}for(var startColumn=cellSelection.getFirstColumnIndex(),rowCount=endRow-startRow+1,i=0;i<rowCount;i++){table.removeRow(startRow)}if(0<table.rows.length){var closestRow=_Mathmin(startRow,table.rows.length-1);cursorCell=table.rows[closestRow].columns[startColumn].element}break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_COLUMNS:var startCol=cellSelection.getFirstColumnIndex(),endCol=cellSelection.getLastColumnIndex();if(0==startCol&&endCol==table.rows[0].columns.length-1){return this.execCommandInternal(goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE)}for(var startRow=cellSelection.getFirstRowIndex(),removeCount=endCol-startCol+1,i=0;i<removeCount;i++){table.removeColumn(startCol)}var currentRow=table.rows[startRow];if(currentRow){var closestCol=_Mathmin(startCol,currentRow.columns.length-1);cursorCell=currentRow.columns[closestCol].element}break;case goog.editor.plugins.TableEditor.COMMAND.MERGE_CELLS:if(cellSelection.isRectangle()){table.mergeCells(cellSelection.getFirstRowIndex(),cellSelection.getFirstColumnIndex(),cellSelection.getLastRowIndex(),cellSelection.getLastColumnIndex())}break;case goog.editor.plugins.TableEditor.COMMAND.SPLIT_CELL:if(cellSelection.containsSingleCell()){table.splitCell(cellSelection.getFirstRowIndex(),cellSelection.getFirstColumnIndex())}break;case goog.editor.plugins.TableEditor.COMMAND.REMOVE_TABLE:table.element.parentNode.removeChild(table.element);break;default:}}if(cursorCell){range=goog.dom.Range.createFromNodeContents(cursorCell);range.collapse(!1);range.select()}return result};goog.editor.plugins.TableEditor.prototype.isUserEditableTable_=function(element){if(element.tagName!=goog.dom.TagName.TABLE){return!1}return goog.array.every(this.isTableEditableFunctions_,function(func){return func(element)})};goog.editor.plugins.TableEditor.prototype.addIsTableEditableFunction=function(func){goog.array.insert(this.isTableEditableFunctions_,func)};goog.editor.plugins.TableEditor.CellSelection_=function(range,getParentTableFunction){var _Mathmax=Math.max,_Mathmin2=Math.min;this.cells_=[];var selectionContainer=range.getContainerElement(),elementInSelection=function(node){return selectionContainer==node||selectionContainer.parentNode==node||range.containsNode(node,!1)},parentTableElement=selectionContainer&&getParentTableFunction(selectionContainer);if(!parentTableElement){return}var parentTable=new goog.editor.Table(parentTableElement);if(!parentTable.rows.length||!parentTable.rows[0].columns.length){return}for(var i=0,row;row=parentTable.rows[i];i++){for(var j=0,cell;cell=row.columns[j];j++){if(elementInSelection(cell.element)){if(!this.cells_.length){this.firstRowIndex_=cell.startRow;this.lastRowIndex_=cell.endRow;this.firstColIndex_=cell.startCol;this.lastColIndex_=cell.endCol}else{this.firstRowIndex_=_Mathmin2(this.firstRowIndex_,cell.startRow);this.lastRowIndex_=_Mathmax(this.lastRowIndex_,cell.endRow);this.firstColIndex_=_Mathmin2(this.firstColIndex_,cell.startCol);this.lastColIndex_=_Mathmax(this.lastColIndex_,cell.endCol)}this.cells_.push(cell)}}}this.parentTable_=parentTable};goog.editor.plugins.TableEditor.CellSelection_.prototype.getTable=function(){return this.parentTable_};goog.editor.plugins.TableEditor.CellSelection_.prototype.getFirstRowIndex=function(){return this.firstRowIndex_};goog.editor.plugins.TableEditor.CellSelection_.prototype.getLastRowIndex=function(){return this.lastRowIndex_};goog.editor.plugins.TableEditor.CellSelection_.prototype.getFirstColumnIndex=function(){return this.firstColIndex_};goog.editor.plugins.TableEditor.CellSelection_.prototype.getLastColumnIndex=function(){return this.lastColIndex_};goog.editor.plugins.TableEditor.CellSelection_.prototype.getCells=function(){return this.cells_};goog.editor.plugins.TableEditor.CellSelection_.prototype.isRectangle=function(){if(!this.cells_.length){return!1}var firstCell=this.cells_[0],lastCell=this.cells_[this.cells_.length-1];return!(this.firstRowIndex_<firstCell.startRow||this.lastRowIndex_>lastCell.endRow||this.firstColIndex_<firstCell.startCol||this.lastColIndex_>lastCell.endCol)};goog.editor.plugins.TableEditor.CellSelection_.prototype.containsSingleCell=function(){var cellCount=this.cells_.length;return 0<cellCount&&this.cells_[0]==this.cells_[cellCount-1]};