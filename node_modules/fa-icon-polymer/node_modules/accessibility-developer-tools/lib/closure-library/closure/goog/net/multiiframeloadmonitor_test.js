goog.module("goog.net.MultiIframeLoadMonitorTest");goog.setTestOnly("goog.net.MultiIframeLoadMonitorTest");var Promise=goog.require("goog.Promise"),Timer=goog.require("goog.Timer"),dom=goog.require("goog.dom"),TagName=goog.require("goog.dom.TagName"),IframeLoadMonitor=goog.require("goog.net.IframeLoadMonitor"),MultiIframeLoadMonitor=goog.require("goog.net.MultiIframeLoadMonitor"),PropertyReplacer=goog.require("goog.testing.PropertyReplacer"),jsunit=goog.require("goog.testing.jsunit"),testSuite=goog.require("goog.testing.testSuite"),stubs=new PropertyReplacer,TEST_FRAME_SRCS=["iframeloadmonitor_test_frame.html","iframeloadmonitor_test_frame2.html"],frameParent;testSuite({setUpPage:function(){frameParent=dom.getElement("frame_parent")},tearDown:function(){dom.removeChildren(frameParent);stubs.reset()},testMultiIframeLoadMonitor:function(){var frames=[dom.createDom(TagName.IFRAME),dom.createDom(TagName.IFRAME)],loaded=!1,monitorPromise=new Promise(function(resolve,reject){new MultiIframeLoadMonitor(frames,function(){loaded=!0;resolve()})});assertFalse(loaded);frameParent.appendChild(frames[0]);frameParent.appendChild(frames[1]);return monitorPromise.then(function(){assertTrue(loaded)})},testMultiIframeLoadMonitor_withContentCheck:function(){var frames=[dom.createDom(TagName.IFRAME),dom.createDom(TagName.IFRAME)],loaded=!1,monitorPromise=new Promise(function(resolve,reject){new MultiIframeLoadMonitor(frames,function(){loaded=!0;resolve()},!0)});frameParent.appendChild(frames[0]);frameParent.appendChild(frames[1]);return Timer.promise(10).then(function(){assertFalse("Monitor should not fire until all iframes have content.",loaded);frames[0].src=TEST_FRAME_SRCS[0];return Timer.promise(10)}).then(function(){assertFalse("Monitor should not fire until all iframes have content.",loaded);frames[1].src=TEST_FRAME_SRCS[1];return monitorPromise}).then(function(){assertTrue(loaded)})},testStopMonitoring:function(){var iframeLoadMonitorsCreated=0,disposeCalls=0;stubs.replace(goog.net,"IframeLoadMonitor",function(){iframeLoadMonitorsCreated++;return{attachEvent:function(){},dispose:function(){disposeCalls++},isLoaded:function(){return!1}}});goog.net.IframeLoadMonitor.LOAD_EVENT="ifload";var frames=[dom.createDom(TagName.IFRAME),dom.createDom(TagName.IFRAME)],monitor=new MultiIframeLoadMonitor(frames,function(){fail("should not invoke callback for unloaded frames")},!0);assertEquals(frames.length,iframeLoadMonitorsCreated);assertEquals(0,disposeCalls);monitor.stopMonitoring();assertEquals(frames.length,disposeCalls)}});