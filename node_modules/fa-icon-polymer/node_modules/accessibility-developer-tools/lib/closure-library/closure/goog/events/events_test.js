goog.provide("goog.eventsTest");goog.setTestOnly("goog.eventsTest");goog.require("goog.asserts.AssertionError");goog.require("goog.debug.EntryPointMonitor");goog.require("goog.debug.ErrorHandler");goog.require("goog.debug.entryPointRegistry");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.BrowserFeature");goog.require("goog.events.CaptureSimulationMode");goog.require("goog.events.Event");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.events.Listener");goog.require("goog.functions");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.jsunit");goog.require("goog.testing.recordFunction");var originalHandleBrowserEvent=goog.events.handleBrowserEvent_,propertyReplacer,et1,et2,et3;function setUp(){et1=new goog.events.EventTarget;et2=new goog.events.EventTarget;et3=new goog.events.EventTarget;propertyReplacer=new goog.testing.PropertyReplacer}function tearDown(){goog.events.CAPTURE_SIMULATION_MODE=goog.events.CaptureSimulationMode.ON;goog.events.handleBrowserEvent_=originalHandleBrowserEvent;goog.disposeAll(et1,et2,et3);goog.events.removeAll(document.body);propertyReplacer.reset()}function testProtectBrowserEventEntryPoint(){var errorHandlerFn=goog.testing.recordFunction(),errorHandler=new goog.debug.ErrorHandler(errorHandlerFn);goog.events.protectBrowserEventEntryPoint(errorHandler);var browserEventHandler=goog.testing.recordFunction(goog.events.handleBrowserEvent_);goog.events.handleBrowserEvent_=function(){try{browserEventHandler.apply(this,arguments)}catch(e){}};var err=Error("test"),body=document.body;goog.events.listen(body,goog.events.EventType.CLICK,function(){throw err});dispatchClick(body);assertEquals("Error handler callback should be called.",1,errorHandlerFn.getCallCount());assertEquals(err,errorHandlerFn.getLastCall().getArgument(0));assertEquals(1,browserEventHandler.getCallCount());var err2=browserEventHandler.getLastCall().getError();assertNotNull(err2);assertTrue(err2 instanceof goog.debug.ErrorHandler.ProtectedFunctionError)}function testSelfRemove(){var callback=function(){goog.events.removeAll(et1,"click");assertNull(goog.events.getListener(et1,"click",callback))},key=goog.events.listen(et1,"click",callback);goog.events.dispatchEvent(et1,"click")}function testHasListener(){var div=goog.dom.createElement(goog.dom.TagName.DIV);assertFalse(goog.events.hasListener(div));var key=goog.events.listen(div,"click",function(){});assertTrue(goog.events.hasListener(div));assertTrue(goog.events.hasListener(div,"click"));assertTrue(goog.events.hasListener(div,"click",!1));assertTrue(goog.events.hasListener(div,void 0,!1));assertFalse(goog.events.hasListener(div,"click",!0));assertFalse(goog.events.hasListener(div,void 0,!0));assertFalse(goog.events.hasListener(div,"mouseup"));goog.events.unlistenByKey(key);assertFalse(goog.events.hasListener(div))}function testHasListenerWithEventTarget(){assertFalse(goog.events.hasListener(et1));function callback(){};goog.events.listen(et1,"test",callback,!0);assertTrue(goog.events.hasListener(et1));assertTrue(goog.events.hasListener(et1,"test"));assertTrue(goog.events.hasListener(et1,"test",!0));assertTrue(goog.events.hasListener(et1,void 0,!0));assertFalse(goog.events.hasListener(et1,"click"));assertFalse(goog.events.hasListener(et1,"test",!1));goog.events.unlisten(et1,"test",callback,!0);assertFalse(goog.events.hasListener(et1))}function testHasListenerWithMultipleTargets(){function callback(){};goog.events.listen(et1,"test1",callback,!0);goog.events.listen(et2,"test2",callback,!0);assertTrue(goog.events.hasListener(et1));assertTrue(goog.events.hasListener(et2));assertTrue(goog.events.hasListener(et1,"test1"));assertTrue(goog.events.hasListener(et2,"test2"));assertFalse(goog.events.hasListener(et1,"et2"));assertFalse(goog.events.hasListener(et2,"et1"));goog.events.removeAll(et1);goog.events.removeAll(et2)}function testBubbleSingle(){et1.setParentEventTarget(et2);et2.setParentEventTarget(et3);var count=0;function callback(){count++}goog.events.listen(et3,"test",callback,!1);et1.dispatchEvent("test");assertEquals(1,count);goog.events.removeAll(et1);goog.events.removeAll(et2);goog.events.removeAll(et3)}function testCaptureSingle(){et1.setParentEventTarget(et2);et2.setParentEventTarget(et3);var count=0;function callback(){count++}goog.events.listen(et3,"test",callback,!0);et1.dispatchEvent("test");assertEquals(1,count);goog.events.removeAll(et1);goog.events.removeAll(et2);goog.events.removeAll(et3)}function testCaptureAndBubble(){et1.setParentEventTarget(et2);et2.setParentEventTarget(et3);var count=0;function callbackCapture1(){count++;assertEquals(3,count)}function callbackBubble1(){count++;assertEquals(4,count)}function callbackCapture2(){count++;assertEquals(2,count)}function callbackBubble2(){count++;assertEquals(5,count)}function callbackCapture3(){count++;assertEquals(1,count)}function callbackBubble3(){count++;assertEquals(6,count)}goog.events.listen(et1,"test",callbackCapture1,!0);goog.events.listen(et1,"test",callbackBubble1,!1);goog.events.listen(et2,"test",callbackCapture2,!0);goog.events.listen(et2,"test",callbackBubble2,!1);goog.events.listen(et3,"test",callbackCapture3,!0);goog.events.listen(et3,"test",callbackBubble3,!1);et1.dispatchEvent("test");assertEquals(6,count);goog.events.removeAll(et1);goog.events.removeAll(et2);goog.events.removeAll(et3)}function testCapturingRemovesBubblingListener(){var bubbleCount=0;function callbackBubble(){bubbleCount++}var captureCount=0;function callbackCapture(){captureCount++;goog.events.removeAll(et1)}goog.events.listen(et1,"test",callbackCapture,!0);goog.events.listen(et1,"test",callbackBubble,!1);et1.dispatchEvent("test");assertEquals(1,captureCount);assertEquals(0,bubbleCount)}function dispatchClick(target){if(target.click){target.click()}else{var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);target.dispatchEvent(e)}}function testHandleBrowserEventBubblingListener(){var count=0,body=document.body;goog.events.listen(body,"click",function(){count++});dispatchClick(body);assertEquals(1,count)}function testHandleBrowserEventCapturingListener(){var count=0,body=document.body;goog.events.listen(body,"click",function(){count++},!0);dispatchClick(body);assertEquals(1,count)}function testHandleBrowserEventCapturingAndBubblingListener(){var count=1,body=document.body;goog.events.listen(body,"click",function(){count+=3},!0);goog.events.listen(body,"click",function(){count*=5},!1);dispatchClick(body);assertEquals(20,count)}function testHandleBrowserEventCapturingRemovesBubblingListener(){var body=document.body,bubbleCount=0;function callbackBubble(){bubbleCount++}var captureCount=0;function callbackCapture(){captureCount++;goog.events.removeAll(body)}goog.events.listen(body,"click",callbackCapture,!0);goog.events.listen(body,"click",callbackBubble,!1);dispatchClick(body);assertEquals(1,captureCount);assertEquals(0,bubbleCount)}function testHandleEventPropagationOnParentElement(){var count=1;goog.events.listen(document.documentElement,"click",function(){count+=3},!0);goog.events.listen(document.documentElement,"click",function(){count*=5},!1);dispatchClick(document.body);assertEquals(20,count)}function testEntryPointRegistry(){var monitor=new goog.debug.EntryPointMonitor,replacement=function(){};monitor.wrap=goog.testing.recordFunction(goog.functions.constant(replacement));goog.debug.entryPointRegistry.monitorAll(monitor);assertTrue(1<=monitor.wrap.getCallCount());assertEquals(replacement,goog.events.handleBrowserEvent_)}function testListenOnceHandlerDispatchCausingInfiniteLoop(){var handleFoo=goog.testing.recordFunction(function(){et1.dispatchEvent("foo")});goog.events.listenOnce(et1,"foo",handleFoo);et1.dispatchEvent("foo");assertEquals("Handler should be called only once.",1,handleFoo.getCallCount())}function testCreationStack(){if(!new Error().stack)return;propertyReplacer.replace(goog.events.Listener,"ENABLE_MONITORING",!0);var div=goog.dom.createElement(goog.dom.TagName.DIV),key=goog.events.listen(div,goog.events.EventType.CLICK,goog.nullFunction),listenerStack=key.creationStack;assertContains("testCreationStack",listenerStack);goog.events.unlistenByKey(key)}function testListenOnceAfterListenDoesNotChangeExistingListener(){var listener=goog.testing.recordFunction();goog.events.listen(document.body,"click",listener);goog.events.listenOnce(document.body,"click",listener);dispatchClick(document.body);dispatchClick(document.body);dispatchClick(document.body);assertEquals(3,listener.getCallCount())}function testListenOnceAfterListenOnceDoesNotChangeExistingListener(){var listener=goog.testing.recordFunction();goog.events.listenOnce(document.body,"click",listener);goog.events.listenOnce(document.body,"click",listener);dispatchClick(document.body);dispatchClick(document.body);dispatchClick(document.body);assertEquals(1,listener.getCallCount())}function testListenAfterListenOnceRemoveOnceness(){var listener=goog.testing.recordFunction();goog.events.listenOnce(document.body,"click",listener);goog.events.listen(document.body,"click",listener);dispatchClick(document.body);dispatchClick(document.body);dispatchClick(document.body);assertEquals(3,listener.getCallCount())}function testUnlistenAfterListenOnce(){var listener=goog.testing.recordFunction();goog.events.listenOnce(document.body,"click",listener);goog.events.unlisten(document.body,"click",listener);dispatchClick(document.body);goog.events.listenOnce(document.body,"click",listener);goog.events.listen(document.body,"click",listener);goog.events.unlisten(document.body,"click",listener);dispatchClick(document.body);goog.events.listen(document.body,"click",listener);goog.events.listenOnce(document.body,"click",listener);goog.events.unlisten(document.body,"click",listener);dispatchClick(document.body);goog.events.listenOnce(document.body,"click",listener);goog.events.listenOnce(document.body,"click",listener);goog.events.unlisten(document.body,"click",listener);dispatchClick(document.body);assertEquals(0,listener.getCallCount())}function testEventBubblingWithReentrantDispatch_bubbling(){runEventPropagationWithReentrantDispatch(!1)}function testEventBubblingWithReentrantDispatch_capture(){runEventPropagationWithReentrantDispatch(!0)}function runEventPropagationWithReentrantDispatch(useCapture){var eventType="test-event-type",child=et1,parent=et2;child.setParentEventTarget(parent);var firstTarget=useCapture?parent:child,secondTarget=useCapture?child:parent,firstListener=function(evt){if(evt.isFirstEvent){child.dispatchEvent(new goog.events.Event(eventType))}};goog.events.listen(firstTarget,eventType,firstListener,useCapture);var secondListener=goog.testing.recordFunction();goog.events.listen(secondTarget,eventType,secondListener,useCapture);var firstEvent=new goog.events.Event(eventType);firstEvent.isFirstEvent=!0;child.dispatchEvent(firstEvent);assertEquals(2,secondListener.getCallCount())}function testEventPropagationWhenListenerRemoved_bubbling(){runEventPropagationWhenListenerRemoved(!1)}function testEventPropagationWhenListenerRemoved_capture(){runEventPropagationWhenListenerRemoved(!0)}function runEventPropagationWhenListenerRemoved(useCapture){var eventType="test-event-type",child=et1,parent=et2;child.setParentEventTarget(parent);var firstTarget=useCapture?parent:child,secondTarget=useCapture?child:parent,firstListener=goog.testing.recordFunction(),secondListener=goog.testing.recordFunction();goog.events.listenOnce(firstTarget,eventType,firstListener,useCapture);goog.events.listen(secondTarget,eventType,secondListener,useCapture);child.dispatchEvent(new goog.events.Event(eventType));assertEquals(1,secondListener.getCallCount())}function testEventPropagationWhenListenerAdded_bubbling(){runEventPropagationWhenListenerAdded(!1)}function testEventPropagationWhenListenerAdded_capture(){runEventPropagationWhenListenerAdded(!0)}function runEventPropagationWhenListenerAdded(useCapture){var eventType="test-event-type",child=et1,parent=et2;child.setParentEventTarget(parent);var firstTarget=useCapture?parent:child,secondTarget=useCapture?child:parent,firstListener=function(){goog.events.listen(secondTarget,eventType,secondListener,useCapture)},secondListener=goog.testing.recordFunction();goog.events.listen(firstTarget,eventType,firstListener,useCapture);child.dispatchEvent(new goog.events.Event(eventType));assertEquals(1,secondListener.getCallCount())}function testEventPropagationWhenListenerAddedAndRemoved_bubbling(){runEventPropagationWhenListenerAddedAndRemoved(!1)}function testEventPropagationWhenListenerAddedAndRemoved_capture(){runEventPropagationWhenListenerAddedAndRemoved(!0)}function runEventPropagationWhenListenerAddedAndRemoved(useCapture){var eventType="test-event-type",child=et1,parent=et2;child.setParentEventTarget(parent);var firstTarget=useCapture?parent:child,secondTarget=useCapture?child:parent,firstListener=function(){goog.events.listen(secondTarget,eventType,secondListener,useCapture)},secondListener=goog.testing.recordFunction();goog.events.listenOnce(firstTarget,eventType,firstListener,useCapture);child.dispatchEvent(new goog.events.Event(eventType));assertEquals(1,secondListener.getCallCount())}function testAssertWhenUsedWithUninitializedCustomEventTarget(){var SubClass=function(){};goog.inherits(SubClass,goog.events.EventTarget);var instance=new SubClass,e;e=assertThrows(function(){goog.events.listen(instance,"test1",function(){})});assertTrue(e instanceof goog.asserts.AssertionError);e=assertThrows(function(){goog.events.dispatchEvent(instance,"test1")});assertTrue(e instanceof goog.asserts.AssertionError);e=assertThrows(function(){instance.dispatchEvent("test1")});assertTrue(e instanceof goog.asserts.AssertionError)}function testAssertWhenDispatchEventIsUsedWithNonCustomEventTarget(){var obj={};e=assertThrows(function(){goog.events.dispatchEvent(obj,"test1")});assertTrue(e instanceof goog.asserts.AssertionError)}function testPropagationStoppedDuringCapture(){var captureHandler=goog.testing.recordFunction(function(e){e.stopPropagation()}),bubbleHandler=goog.testing.recordFunction(),body=document.body,div=goog.dom.createElement(goog.dom.TagName.DIV);body.appendChild(div);try{goog.events.listen(body,"click",captureHandler,!0);goog.events.listen(div,"click",bubbleHandler,!1);goog.events.listen(body,"click",bubbleHandler,!1);dispatchClick(div);assertEquals(1,captureHandler.getCallCount());assertEquals(0,bubbleHandler.getCallCount());goog.events.unlisten(body,"click",captureHandler,!0);dispatchClick(div);assertEquals(2,bubbleHandler.getCallCount())}finally{goog.dom.removeNode(div);goog.events.removeAll(body);goog.events.removeAll(div)}}function testPropagationStoppedDuringBubble(){var captureHandler=goog.testing.recordFunction(),bubbleHandler1=goog.testing.recordFunction(function(e){e.stopPropagation()}),bubbleHandler2=goog.testing.recordFunction(),body=document.body,div=goog.dom.createElement(goog.dom.TagName.DIV);body.appendChild(div);try{goog.events.listen(body,"click",captureHandler,!0);goog.events.listen(div,"click",bubbleHandler1,!1);goog.events.listen(body,"click",bubbleHandler2,!1);dispatchClick(div);assertEquals(1,captureHandler.getCallCount());assertEquals(1,bubbleHandler1.getCallCount());assertEquals(0,bubbleHandler2.getCallCount())}finally{goog.dom.removeNode(div);goog.events.removeAll(body);goog.events.removeAll(div)}}function testAddingCaptureListenerDuringBubbleShouldNotFireTheListener(){var body=document.body,div=goog.dom.createElement(goog.dom.TagName.DIV);body.appendChild(div);var captureHandler1=goog.testing.recordFunction(),captureHandler2=goog.testing.recordFunction(),bubbleHandler=goog.testing.recordFunction(function(e){goog.events.listen(body,"click",captureHandler1,!0);goog.events.listen(div,"click",captureHandler2,!0)});try{goog.events.listen(div,"click",bubbleHandler,!1);dispatchClick(div);assertEquals(0,captureHandler1.getCallCount());assertEquals(0,captureHandler2.getCallCount());assertEquals(1,bubbleHandler.getCallCount())}finally{goog.dom.removeNode(div);goog.events.removeAll(body);goog.events.removeAll(div)}}function testRemovingCaptureListenerDuringBubbleWouldNotFireListenerTwice(){var body=document.body,div=goog.dom.createElement(goog.dom.TagName.DIV);body.appendChild(div);var captureHandler=goog.testing.recordFunction(),bubbleHandler1=goog.testing.recordFunction(function(e){goog.events.unlisten(body,"click",captureHandler,!0)}),bubbleHandler2=goog.testing.recordFunction();try{goog.events.listen(body,"click",captureHandler,!0);goog.events.listen(div,"click",bubbleHandler1,!1);goog.events.listen(body,"click",bubbleHandler2,!1);dispatchClick(div);assertEquals(1,captureHandler.getCallCount());assertEquals(1,bubbleHandler1.getCallCount());assertEquals(1,bubbleHandler2.getCallCount())}finally{goog.dom.removeNode(div);goog.events.removeAll(body);goog.events.removeAll(div)}}function testCaptureSimulationModeOffAndFail(){goog.events.CAPTURE_SIMULATION_MODE=goog.events.CaptureSimulationMode.OFF_AND_FAIL;var captureHandler=goog.testing.recordFunction();if(!goog.events.BrowserFeature.HAS_W3C_EVENT_SUPPORT){var err=assertThrows(function(){goog.events.listen(document.body,"click",captureHandler,!0)});assertTrue(err instanceof goog.asserts.AssertionError);dispatchClick(document.body);assertEquals(0,captureHandler.getCallCount())}else{goog.events.listen(document.body,"click",captureHandler,!0);dispatchClick(document.body);assertEquals(1,captureHandler.getCallCount())}}function testCaptureSimulationModeOffAndSilent(){goog.events.CAPTURE_SIMULATION_MODE=goog.events.CaptureSimulationMode.OFF_AND_SILENT;var captureHandler=goog.testing.recordFunction();goog.events.listen(document.body,"click",captureHandler,!0);if(!goog.events.BrowserFeature.HAS_W3C_EVENT_SUPPORT){dispatchClick(document.body);assertEquals(0,captureHandler.getCallCount())}else{dispatchClick(document.body);assertEquals(1,captureHandler.getCallCount())}}