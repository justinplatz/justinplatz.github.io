goog.setTestOnly("goog.testing.net.XhrIo");goog.provide("goog.testing.net.XhrIo");goog.require("goog.array");goog.require("goog.dom.xml");goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.json");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.net.HttpStatus");goog.require("goog.net.XhrIo");goog.require("goog.net.XmlHttp");goog.require("goog.object");goog.require("goog.structs");goog.require("goog.structs.Map");goog.require("goog.uri.utils");goog.testing.net.XhrIo=function(opt_testQueue){goog.events.EventTarget.call(this);this.headers=new goog.structs.Map;this.testQueue_=opt_testQueue||null};goog.inherits(goog.testing.net.XhrIo,goog.events.EventTarget);goog.testing.net.XhrIo.ResponseType=goog.net.XhrIo.ResponseType;goog.testing.net.XhrIo.HTTP_SCHEME_PATTERN_=/^https?$/i;goog.testing.net.XhrIo.sendInstances_=[];goog.testing.net.XhrIo.getSendInstances=function(){return goog.testing.net.XhrIo.sendInstances_};goog.testing.net.XhrIo.cleanup=function(){var instances=goog.testing.net.XhrIo.sendInstances_;while(instances.length){instances.pop().dispose()}};goog.testing.net.XhrIo.send=function(url,opt_callback,opt_method,opt_content,opt_headers,opt_timeoutInterval,opt_withCredentials){var x=new goog.testing.net.XhrIo;goog.testing.net.XhrIo.sendInstances_.push(x);if(opt_callback){goog.events.listen(x,goog.net.EventType.COMPLETE,opt_callback)}goog.events.listen(x,goog.net.EventType.READY,goog.partial(goog.testing.net.XhrIo.cleanupSend_,x));if(opt_timeoutInterval){x.setTimeoutInterval(opt_timeoutInterval)}x.setWithCredentials(!!opt_withCredentials);x.send(url,opt_method,opt_content,opt_headers);return x};goog.testing.net.XhrIo.cleanupSend_=function(XhrIo){XhrIo.dispose();goog.array.remove(goog.testing.net.XhrIo.sendInstances_,XhrIo)};goog.testing.net.XhrIo.prototype.responseHeaders_;goog.testing.net.XhrIo.prototype.active_=!1;goog.testing.net.XhrIo.prototype.lastUri_="";goog.testing.net.XhrIo.prototype.lastMethod_;goog.testing.net.XhrIo.prototype.lastContent_;goog.testing.net.XhrIo.prototype.lastHeaders_;goog.testing.net.XhrIo.prototype.lastErrorCode_=goog.net.ErrorCode.NO_ERROR;goog.testing.net.XhrIo.prototype.lastError_="";goog.testing.net.XhrIo.prototype.response_="";goog.testing.net.XhrIo.prototype.statusCode_=0;goog.testing.net.XhrIo.prototype.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED;goog.testing.net.XhrIo.prototype.timeoutInterval_=0;goog.testing.net.XhrIo.prototype.responseType_=goog.net.XhrIo.ResponseType.DEFAULT;goog.testing.net.XhrIo.prototype.withCredentials_=!1;goog.testing.net.XhrIo.prototype.progressEventsEnabled_=!1;goog.testing.net.XhrIo.prototype.xhr_=!1;goog.testing.net.XhrIo.prototype.getTimeoutInterval=function(){return this.timeoutInterval_};goog.testing.net.XhrIo.prototype.setTimeoutInterval=function(ms){this.timeoutInterval_=Math.max(0,ms)};goog.testing.net.XhrIo.prototype.simulateTimeout=function(){this.lastErrorCode_=goog.net.ErrorCode.TIMEOUT;this.dispatchEvent(goog.net.EventType.TIMEOUT);this.abort(goog.net.ErrorCode.TIMEOUT)};goog.testing.net.XhrIo.prototype.setResponseType=function(type){this.responseType_=type};goog.testing.net.XhrIo.prototype.getResponseType=function(){return this.responseType_};goog.testing.net.XhrIo.prototype.setWithCredentials=function(withCredentials){this.withCredentials_=withCredentials};goog.testing.net.XhrIo.prototype.getWithCredentials=function(){return this.withCredentials_};goog.testing.net.XhrIo.prototype.setProgressEventsEnabled=function(enabled){this.progressEventsEnabled_=enabled};goog.testing.net.XhrIo.prototype.getProgressEventsEnabled=function(){return this.progressEventsEnabled_};goog.testing.net.XhrIo.prototype.abort=function(opt_failureCode){if(this.active_){try{this.active_=!1;this.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED;this.statusCode_=-1;this.lastErrorCode_=opt_failureCode||goog.net.ErrorCode.ABORT;this.dispatchEvent(goog.net.EventType.COMPLETE);this.dispatchEvent(goog.net.EventType.ABORT)}finally{this.simulateReady()}}};goog.testing.net.XhrIo.prototype.send=function(url,opt_method,opt_content,opt_headers){if(this.xhr_){throw Error("[goog.net.XhrIo] Object is active with another request")}this.lastUri_=url;this.lastMethod_=opt_method||"GET";this.lastContent_=opt_content;if(!this.headers.isEmpty()){this.lastHeaders_=this.headers.toObject();if(opt_headers){goog.structs.forEach(opt_headers,goog.bind(function(value,key){this.lastHeaders_[key]=value},this))}}else{this.lastHeaders_=opt_headers}if(this.testQueue_){this.testQueue_.enqueue(["s",url,opt_method,opt_content,opt_headers])}this.xhr_=!0;this.active_=!0;this.readyState_=goog.net.XmlHttp.ReadyState.UNINITIALIZED;this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.LOADING)};goog.testing.net.XhrIo.prototype.createXhr=function(){return goog.net.XmlHttp()};goog.testing.net.XhrIo.prototype.simulateReadyStateChange=function(readyState){if(readyState<this.readyState_){throw Error("Readystate cannot go backwards")}if(readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE&&readyState==this.readyState_){this.dispatchEvent(goog.net.EventType.READY_STATE_CHANGE);return}while(this.readyState_<readyState){this.readyState_++;this.dispatchEvent(goog.net.EventType.READY_STATE_CHANGE);if(this.readyState_==goog.net.XmlHttp.ReadyState.COMPLETE){this.active_=!1;this.dispatchEvent(goog.net.EventType.COMPLETE)}}};goog.testing.net.XhrIo.prototype.simulatePartialResponse=function(partialResponse,opt_headers){this.response_+=partialResponse;this.responseHeaders_=opt_headers||{};this.statusCode_=200;this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.INTERACTIVE)};goog.testing.net.XhrIo.prototype.simulateResponse=function(statusCode,response,opt_headers){this.statusCode_=statusCode;this.response_=response||"";this.responseHeaders_=opt_headers||{};try{if(this.isSuccess()){this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.COMPLETE);this.dispatchEvent(goog.net.EventType.SUCCESS)}else{this.lastErrorCode_=goog.net.ErrorCode.HTTP_ERROR;this.lastError_=this.getStatusText()+" ["+this.getStatus()+"]";this.simulateReadyStateChange(goog.net.XmlHttp.ReadyState.COMPLETE);this.dispatchEvent(goog.net.EventType.ERROR)}}finally{this.simulateReady()}};goog.testing.net.XhrIo.prototype.simulateReady=function(){this.active_=!1;this.xhr_=!1;this.dispatchEvent(goog.net.EventType.READY)};goog.testing.net.XhrIo.prototype.simulateProgress=function(lengthComputable,loaded,total,opt_isDownload){var progressEvent={type:goog.net.EventType.PROGRESS,lengthComputable:lengthComputable,loaded:loaded,total:total};this.dispatchEvent(progressEvent);var specificProgress=goog.object.clone(progressEvent);specificProgress.type=opt_isDownload?goog.net.EventType.DOWNLOAD_PROGRESS:goog.net.EventType.UPLOAD_PROGRESS;this.dispatchEvent(specificProgress)};goog.testing.net.XhrIo.prototype.isActive=function(){return!!this.xhr_};goog.testing.net.XhrIo.prototype.isComplete=function(){return this.readyState_==goog.net.XmlHttp.ReadyState.COMPLETE};goog.testing.net.XhrIo.prototype.isSuccess=function(){var status=this.getStatus();return goog.net.HttpStatus.isSuccess(status)||0===status&&!this.isLastUriEffectiveSchemeHttp_()};goog.testing.net.XhrIo.prototype.isLastUriEffectiveSchemeHttp_=function(){var scheme=goog.uri.utils.getEffectiveScheme(this.lastUri_+"");return goog.testing.net.XhrIo.HTTP_SCHEME_PATTERN_.test(scheme)};goog.testing.net.XhrIo.prototype.getReadyState=function(){return this.readyState_};goog.testing.net.XhrIo.prototype.getStatus=function(){return this.statusCode_};goog.testing.net.XhrIo.prototype.getStatusText=function(){return""};goog.testing.net.XhrIo.prototype.getLastErrorCode=function(){return this.lastErrorCode_};goog.testing.net.XhrIo.prototype.getLastError=function(){return this.lastError_};goog.testing.net.XhrIo.prototype.getLastUri=function(){return this.lastUri_};goog.testing.net.XhrIo.prototype.getLastMethod=function(){return this.lastMethod_};goog.testing.net.XhrIo.prototype.getLastContent=function(){return this.lastContent_};goog.testing.net.XhrIo.prototype.getLastRequestHeaders=function(){return this.lastHeaders_};goog.testing.net.XhrIo.prototype.getResponseText=function(){if(goog.isString(this.response_)){return this.response_}else if(goog.global.ArrayBuffer&&this.response_ instanceof ArrayBuffer){return""}else{return goog.dom.xml.serialize(this.response_)}};goog.testing.net.XhrIo.prototype.getResponseBody=function(){return null};goog.testing.net.XhrIo.prototype.getResponseJson=function(opt_xssiPrefix){var responseText=this.getResponseText();if(opt_xssiPrefix&&0==responseText.indexOf(opt_xssiPrefix)){responseText=responseText.substring(opt_xssiPrefix.length)}return goog.json.parse(responseText)};goog.testing.net.XhrIo.prototype.getResponseXml=function(){return goog.isString(this.response_)||goog.global.ArrayBuffer&&this.response_ instanceof ArrayBuffer?null:this.response_};goog.testing.net.XhrIo.prototype.getResponse=function(){return this.response_};goog.testing.net.XhrIo.prototype.getResponseHeader=function(key){return this.isComplete()?this.responseHeaders_[key]:void 0};goog.testing.net.XhrIo.prototype.getAllResponseHeaders=function(){if(!this.isComplete()){return""}return this.getAllStreamingResponseHeaders()};goog.testing.net.XhrIo.prototype.getResponseHeaders=function(){var headersObject={};goog.object.forEach(this.responseHeaders_,function(value,key){if(headersObject[key]){headersObject[key]+=", "+value}else{headersObject[key]=value}});return headersObject};goog.testing.net.XhrIo.prototype.getStreamingResponseHeader=function(key){return key in this.responseHeaders_?this.responseHeaders_[key]:null};goog.testing.net.XhrIo.prototype.getAllStreamingResponseHeaders=function(){var headers=[];goog.object.forEach(this.responseHeaders_,function(value,name){headers.push(name+": "+value)});return headers.join("\r\n")};