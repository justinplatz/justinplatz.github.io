goog.provide("goog.net.BulkLoaderTest");goog.setTestOnly("goog.net.BulkLoaderTest");goog.require("goog.events.Event");goog.require("goog.events.EventHandler");goog.require("goog.net.BulkLoader");goog.require("goog.net.EventType");goog.require("goog.testing.MockClock");goog.require("goog.testing.jsunit");var DELAY_INTERVAL_BETWEEN_URI_REQUESTS=5,DELAY_INTERVAL_FOR_URI_LOAD=15,clock,loadSuccess,loadError,successResponseTexts;function setUpPage(){clock=new goog.testing.MockClock(!0)}function tearDownPage(){clock.dispose()}function setUp(){loadSuccess=!1;loadError=!1;successResponseTexts=[]}function getSuccessfulBulkLoader(uris){var bulkLoader=new goog.net.BulkLoader(uris);bulkLoader.load=function(){for(var uris=this.helper_.getUris(),i=0;i<uris.length;i++){clock.tick(DELAY_INTERVAL_BETWEEN_URI_REQUESTS);setTimeout(goog.bind(this.onSuccess,this,i,uris[i]),DELAY_INTERVAL_FOR_URI_LOAD)}};bulkLoader.onSuccess=function(id,uri){var xhrIo={getResponseText:function(){return uri},isSuccess:function(){return!0},dispose:function(){}};this.handleEvent_(id,new goog.events.Event(goog.net.EventType.COMPLETE,xhrIo))};var eventHandler=new goog.events.EventHandler;eventHandler.listen(bulkLoader,goog.net.EventType.SUCCESS,handleSuccess);eventHandler.listen(bulkLoader,goog.net.EventType.ERROR,handleError);return bulkLoader}function getNonSuccessfulBulkLoader(uris){var bulkLoader=new goog.net.BulkLoader(uris);bulkLoader.load=function(){for(var uris=this.helper_.getUris(),i=0;i<uris.length;i++){clock.tick(DELAY_INTERVAL_BETWEEN_URI_REQUESTS);if(2!=i){setTimeout(goog.bind(this.onSuccess,this,i,uris[i]),DELAY_INTERVAL_FOR_URI_LOAD)}else{setTimeout(goog.bind(this.onError,this,i,uris[i]),DELAY_INTERVAL_FOR_URI_LOAD)}}};bulkLoader.onSuccess=function(id,uri){var xhrIo={getResponseText:function(){return uri},isSuccess:function(){return!0},dispose:function(){}};this.handleEvent_(id,new goog.events.Event(goog.net.EventType.COMPLETE,xhrIo))};bulkLoader.onError=function(id){var xhrIo={getResponseText:function(){return null},isSuccess:function(){return!1},dispose:function(){}};this.handleEvent_(id,new goog.events.Event(goog.net.EventType.ERROR,xhrIo))};var eventHandler=new goog.events.EventHandler;eventHandler.listen(bulkLoader,goog.net.EventType.SUCCESS,handleSuccess);eventHandler.listen(bulkLoader,goog.net.EventType.ERROR,handleError);return bulkLoader}function handleSuccess(e){loadSuccess=!0;successResponseTexts=e.target.getResponseTexts()}function handleError(e){loadError=!0}function testBulkLoaderLoadSuccess(){var uris=["a","b","c"],bulkLoader=getSuccessfulBulkLoader(uris);assertArrayEquals(uris,bulkLoader.getRequestUris());bulkLoader.load();clock.tick(2);assertFalse("The bulk loader is not yet loaded (after 2 ticks)",loadSuccess);clock.tick(3);assertFalse("The bulk loader is not yet loaded (after 5 ticks)",loadSuccess);clock.tick(5);assertFalse("The bulk loader is not yet loaded (after 10 ticks)",loadSuccess);clock.tick(5);assertTrue("The bulk loader is loaded (after 15 ticks)",loadSuccess);assertArrayEquals("Ensure that the response texts are present",successResponseTexts,uris)}function testBulkLoaderLoadError(){var uris=["a","b","c"],bulkLoader=getNonSuccessfulBulkLoader(uris);bulkLoader.load();clock.tick(2);assertFalse("The bulk loader is not yet loaded (after 2 ticks)",loadError);clock.tick(3);assertFalse("The bulk loader is not yet loaded (after 5 ticks)",loadError);clock.tick(5);assertFalse("The bulk loader is not yet loaded (after 10 ticks)",loadError);clock.tick(5);assertFalse("The bulk loader is not loaded successfully (after 15 ticks)",loadSuccess);assertTrue("The bulk loader is loaded in error (after 15 ticks)",loadError)}