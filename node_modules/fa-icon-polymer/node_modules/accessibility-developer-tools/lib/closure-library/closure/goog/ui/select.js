goog.provide("goog.ui.Select");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.Role");goog.require("goog.a11y.aria.State");goog.require("goog.array");goog.require("goog.events.EventType");goog.require("goog.ui.Component");goog.require("goog.ui.IdGenerator");goog.require("goog.ui.MenuButton");goog.require("goog.ui.MenuItem");goog.require("goog.ui.MenuRenderer");goog.require("goog.ui.SelectionModel");goog.require("goog.ui.registry");goog.ui.Select=function(opt_caption,opt_menu,opt_renderer,opt_domHelper,opt_menuRenderer){goog.ui.Select.base(this,"constructor",opt_caption,opt_menu,opt_renderer,opt_domHelper,opt_menuRenderer||new goog.ui.MenuRenderer(goog.a11y.aria.Role.LISTBOX));this.defaultCaption_=this.getContent();this.initialAriaLabel_=null;this.setPreferredAriaRole(goog.a11y.aria.Role.LISTBOX)};goog.inherits(goog.ui.Select,goog.ui.MenuButton);goog.tagUnsealableClass(goog.ui.Select);goog.ui.Select.prototype.selectionModel_=null;goog.ui.Select.prototype.enterDocument=function(){goog.ui.Select.superClass_.enterDocument.call(this);this.updateCaption();this.listenToSelectionModelEvents_()};goog.ui.Select.prototype.decorateInternal=function(element){goog.ui.Select.superClass_.decorateInternal.call(this,element);var caption=this.getCaption();if(caption){this.setDefaultCaption(caption)}else if(!this.getSelectedItem()){this.setSelectedIndex(0)}};goog.ui.Select.prototype.disposeInternal=function(){goog.ui.Select.superClass_.disposeInternal.call(this);if(this.selectionModel_){this.selectionModel_.dispose();this.selectionModel_=null}this.defaultCaption_=null};goog.ui.Select.prototype.handleMenuAction=function(e){this.setSelectedItem(e.target);goog.ui.Select.base(this,"handleMenuAction",e);e.stopPropagation();this.dispatchEvent(goog.ui.Component.EventType.ACTION)};goog.ui.Select.prototype.handleSelectionChange=function(e){var item=this.getSelectedItem();goog.ui.Select.superClass_.setValue.call(this,item&&item.getValue());this.updateCaption()};goog.ui.Select.prototype.setMenu=function(menu){var oldMenu=goog.ui.Select.superClass_.setMenu.call(this,menu);if(menu!=oldMenu){if(this.selectionModel_){this.selectionModel_.clear()}if(menu){if(this.selectionModel_){menu.forEachChild(function(child,index){this.setCorrectAriaRole_(child);this.selectionModel_.addItem(child)},this)}else{this.createSelectionModel_(menu)}}}return oldMenu};goog.ui.Select.prototype.getDefaultCaption=function(){return this.defaultCaption_};goog.ui.Select.prototype.setDefaultCaption=function(caption){this.defaultCaption_=caption;this.updateCaption()};goog.ui.Select.prototype.addItem=function(item){this.setCorrectAriaRole_(item);goog.ui.Select.superClass_.addItem.call(this,item);if(this.selectionModel_){this.selectionModel_.addItem(item)}else{this.createSelectionModel_(this.getMenu())}this.updateAriaActiveDescendant_()};goog.ui.Select.prototype.addItemAt=function(item,index){this.setCorrectAriaRole_(item);goog.ui.Select.superClass_.addItemAt.call(this,item,index);if(this.selectionModel_){this.selectionModel_.addItemAt(item,index)}else{this.createSelectionModel_(this.getMenu())}};goog.ui.Select.prototype.removeItem=function(item){goog.ui.Select.superClass_.removeItem.call(this,item);if(this.selectionModel_){this.selectionModel_.removeItem(item)}};goog.ui.Select.prototype.removeItemAt=function(index){goog.ui.Select.superClass_.removeItemAt.call(this,index);if(this.selectionModel_){this.selectionModel_.removeItemAt(index)}};goog.ui.Select.prototype.setSelectedItem=function(item){if(this.selectionModel_){var prevItem=this.getSelectedItem();this.selectionModel_.setSelectedItem(item);if(item!=prevItem){this.dispatchEvent(goog.ui.Component.EventType.CHANGE)}}};goog.ui.Select.prototype.setSelectedIndex=function(index){if(this.selectionModel_){this.setSelectedItem(this.selectionModel_.getItemAt(index))}};goog.ui.Select.prototype.setValue=function(value){if(goog.isDefAndNotNull(value)&&this.selectionModel_){for(var i=0,item;item=this.selectionModel_.getItemAt(i);i++){if(item&&"function"==typeof item.getValue&&item.getValue()==value){this.setSelectedItem(item);return}}}this.setSelectedItem(null)};goog.ui.Select.prototype.getValue=function(){var selectedItem=this.getSelectedItem();return selectedItem?selectedItem.getValue():null};goog.ui.Select.prototype.getSelectedItem=function(){return this.selectionModel_?this.selectionModel_.getSelectedItem():null};goog.ui.Select.prototype.getSelectedIndex=function(){return this.selectionModel_?this.selectionModel_.getSelectedIndex():-1};goog.ui.Select.prototype.getSelectionModel=function(){return this.selectionModel_};goog.ui.Select.prototype.createSelectionModel_=function(opt_component){this.selectionModel_=new goog.ui.SelectionModel;if(opt_component){opt_component.forEachChild(function(child,index){this.setCorrectAriaRole_(child);this.selectionModel_.addItem(child)},this)}this.listenToSelectionModelEvents_()};goog.ui.Select.prototype.listenToSelectionModelEvents_=function(){if(this.selectionModel_){this.getHandler().listen(this.selectionModel_,goog.events.EventType.SELECT,this.handleSelectionChange)}};goog.ui.Select.prototype.updateCaption=function(){var item=this.getSelectedItem();this.setContent(item?item.getCaption():this.defaultCaption_);var contentElement=this.getRenderer().getContentElement(this.getElement());if(contentElement&&this.getDomHelper().isElement(contentElement)){if(null==this.initialAriaLabel_){this.initialAriaLabel_=goog.a11y.aria.getLabel(contentElement)}var itemElement=item?item.getElement():null;goog.a11y.aria.setLabel(contentElement,itemElement?goog.a11y.aria.getLabel(itemElement):this.initialAriaLabel_);this.updateAriaActiveDescendant_()}};goog.ui.Select.prototype.updateAriaActiveDescendant_=function(){var renderer=this.getRenderer();if(renderer){var contentElement=renderer.getContentElement(this.getElement());if(contentElement){var buttonElement=this.getElementStrict();if(!contentElement.id){contentElement.id=goog.ui.IdGenerator.getInstance().getNextUniqueId()}goog.a11y.aria.setRole(contentElement,goog.a11y.aria.Role.OPTION);goog.a11y.aria.setState(buttonElement,goog.a11y.aria.State.ACTIVEDESCENDANT,contentElement.id);if(this.selectionModel_){var items=this.selectionModel_.getItems();goog.a11y.aria.setState(contentElement,goog.a11y.aria.State.SETSIZE,this.getNumMenuItems_(items));var index=this.selectionModel_.getSelectedIndex();goog.a11y.aria.setState(contentElement,goog.a11y.aria.State.POSINSET,0<=index?this.getNumMenuItems_(goog.array.slice(items,0,index+1)):0)}}}};goog.ui.Select.prototype.getNumMenuItems_=function(items){return goog.array.count(items,function(item){return item instanceof goog.ui.MenuItem})};goog.ui.Select.prototype.setCorrectAriaRole_=function(item){item.setPreferredAriaRole(item instanceof goog.ui.MenuItem?goog.a11y.aria.Role.OPTION:goog.a11y.aria.Role.SEPARATOR)};goog.ui.Select.prototype.setOpen=function(open,opt_e){goog.ui.Select.superClass_.setOpen.call(this,open,opt_e);if(this.isOpen()){this.getMenu().setHighlightedIndex(this.getSelectedIndex())}else{this.updateAriaActiveDescendant_()}};goog.ui.registry.setDecoratorByClassName(goog.getCssName("goog-select"),function(){return new goog.ui.Select(null)});