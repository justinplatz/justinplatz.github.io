goog.provide("goog.net.streams.JsonStreamParser");goog.require("goog.asserts");goog.require("goog.json");goog.require("goog.net.streams.StreamParser");goog.scope(function(){goog.net.streams.JsonStreamParser=function(){this.errorMessage_=null;this.result_=[];this.buffer_="";this.stack_=[];this.depth_=0;this.pos_=0;this.slashed_=!1;this.unicodeCount_=0;this.stringInputPattern_=/[\\"]/g;this.streamState_=Parser.StreamState_.INIT;this.state_=Parser.State_.INIT};var Parser=goog.net.streams.JsonStreamParser;Parser.StreamState_={INIT:0,ARRAY_OPEN:1,ARRAY_END:2,INVALID:3};Parser.State_={INIT:0,VALUE:1,OBJECT_OPEN:2,OBJECT_END:3,ARRAY_OPEN:4,ARRAY_END:5,STRING:6,KEY_START:7,KEY_END:8,TRUE1:9,TRUE2:10,TRUE3:11,FALSE1:12,FALSE2:13,FALSE3:14,FALSE4:15,NULL1:16,NULL2:17,NULL3:18,NUM_DECIMAL_POINT:19,NUM_DIGIT:20};Parser.prototype.isInputValid=function(){return this.streamState_!=Parser.StreamState_.INVALID};Parser.prototype.getErrorMessage=function(){return this.errorMessage_};Parser.prototype.error_=function(input,pos){this.streamState_=Parser.StreamState_.INVALID;this.errorMessage_="The stream is broken @"+this.pos_+"/"+pos+". With input:\n"+input;throw Error(this.errorMessage_)};Parser.prototype.parse=function(input){goog.asserts.assertString(input);var parser=this,stack=parser.stack_,result=parser.result_,pattern=parser.stringInputPattern_,State=Parser.State_,num=input.length,streamStart=0,msgStart=-1,i=0;while(i<num){switch(parser.streamState_){case Parser.StreamState_.INVALID:parser.error_(input,i);return null;case Parser.StreamState_.ARRAY_END:if(readMore()){parser.error_(input,i)}return null;case Parser.StreamState_.INIT:if(readMore()){var current=input[i++];parser.pos_++;if("["===current){parser.streamState_=Parser.StreamState_.ARRAY_OPEN;streamStart=i;parser.state_=State.ARRAY_OPEN;continue}else{parser.error_(input,i)}}return null;case Parser.StreamState_.ARRAY_OPEN:parseData();if(0===parser.depth_&&parser.state_==State.ARRAY_END){parser.streamState_=Parser.StreamState_.ARRAY_END;parser.buffer_=""}else{if(-1===msgStart){parser.buffer_+=input.substring(streamStart)}else{parser.buffer_=input.substring(msgStart)}}if(0<parser.result_.length){var msgs=parser.result_;parser.result_=[];return msgs}return null;}}function readMore(){skipWhitespace();return i<num}function skipWhitespace(){while(i<input.length){if(isWhitespace(input[i])){i++;parser.pos_++;continue}break}}function isWhitespace(c){return"\r"==c||"\n"==c||" "==c||"\t"==c}function parseData(){var current;while(!0){current=input[i++];if(!current){break}parser.pos_++;switch(parser.state_){case State.INIT:if("{"===current){parser.state_=State.OBJECT_OPEN}else if("["===current){parser.state_=State.ARRAY_OPEN}else if(!isWhitespace(current)){parser.error_(input,i)}continue;case State.KEY_START:case State.OBJECT_OPEN:if(isWhitespace(current)){continue}if(parser.state_===State.KEY_START){stack.push(State.KEY_END)}else{if("}"===current){addMessage({});parser.state_=nextState();continue}else{stack.push(State.OBJECT_END)}}if("\""===current){parser.state_=State.STRING}else{parser.error_(input,i)}continue;case State.KEY_END:case State.OBJECT_END:if(isWhitespace(current)){continue}if(":"===current){if(parser.state_===State.OBJECT_END){stack.push(State.OBJECT_END);parser.depth_++}parser.state_=State.VALUE}else if("}"===current){parser.depth_--;addMessage();parser.state_=nextState()}else if(","===current){if(parser.state_===State.OBJECT_END){stack.push(State.OBJECT_END)}parser.state_=State.KEY_START}else{parser.error_(input,i)}continue;case State.ARRAY_OPEN:case State.VALUE:if(isWhitespace(current)){continue}if(parser.state_===State.ARRAY_OPEN){parser.depth_++;parser.state_=State.VALUE;if("]"===current){parser.depth_--;if(0===parser.depth_){parser.state_=State.ARRAY_END;break}addMessage([]);parser.state_=nextState();continue}else{stack.push(State.ARRAY_END)}}if("\""===current)parser.state_=State.STRING;else if("{"===current)parser.state_=State.OBJECT_OPEN;else if("["===current)parser.state_=State.ARRAY_OPEN;else if("t"===current)parser.state_=State.TRUE1;else if("f"===current)parser.state_=State.FALSE1;else if("n"===current)parser.state_=State.NULL1;else if("-"===current){}else if(-1!=="0123456789".indexOf(current)){parser.state_=State.NUM_DIGIT}else{parser.error_(input,i)}continue;case State.ARRAY_END:if(","===current){stack.push(State.ARRAY_END);parser.state_=State.VALUE;if(1===parser.depth_){msgStart=i}}else if("]"===current){parser.depth_--;if(0===parser.depth_)break;addMessage();parser.state_=nextState()}else if(isWhitespace(current)){continue}else{parser.error_(input,i)}continue;case State.STRING:var start=i-1,old=i;STRING_LOOP:while(!0){while(0<parser.unicodeCount_){current=input[i++];if(4===parser.unicodeCount_){parser.unicodeCount_=0;start=i-1}else{parser.unicodeCount_++}if(!current){break STRING_LOOP}}if("\""===current&&!parser.slashed_){parser.state_=nextState();break}if("\\"===current&&!parser.slashed_){parser.slashed_=!0;current=input[i++];if(!current){break}}if(parser.slashed_){parser.slashed_=!1;if("u"===current){parser.unicodeCount_=1}current=input[i++];start=i-1;if(!current){break}else{continue}}pattern.lastIndex=i;var patternResult=pattern.exec(input);if(!patternResult){i=input.length+1;break}i=patternResult.index+1;current=input[patternResult.index];if(!current){break}}parser.pos_+=i-old;continue;case State.TRUE1:if(!current){continue}if("r"===current){parser.state_=State.TRUE2}else{parser.error_(input,i)}continue;case State.TRUE2:if(!current){continue}if("u"===current){parser.state_=State.TRUE3}else{parser.error_(input,i)}continue;case State.TRUE3:if(!current){continue}if("e"===current){parser.state_=nextState()}else{parser.error_(input,i)}continue;case State.FALSE1:if(!current){continue}if("a"===current){parser.state_=State.FALSE2}else{parser.error_(input,i)}continue;case State.FALSE2:if(!current){continue}if("l"===current){parser.state_=State.FALSE3}else{parser.error_(input,i)}continue;case State.FALSE3:if(!current){continue}if("s"===current){parser.state_=State.FALSE4}else{parser.error_(input,i)}continue;case State.FALSE4:if(!current){continue}if("e"===current){parser.state_=nextState()}else{parser.error_(input,i)}continue;case State.NULL1:if(!current){continue}if("u"===current){parser.state_=State.NULL2}else{parser.error_(input,i)}continue;case State.NULL2:if(!current){continue}if("l"===current){parser.state_=State.NULL3}else{parser.error_(input,i)}continue;case State.NULL3:if(!current){continue}if("l"===current){parser.state_=nextState()}else{parser.error_(input,i)}continue;case State.NUM_DECIMAL_POINT:if("."===current){parser.state_=State.NUM_DIGIT}else{parser.error_(input,i)}continue;case State.NUM_DIGIT:if(-1!=="0123456789.eE+-".indexOf(current)){continue}else{i--;parser.pos_--;parser.state_=nextState()}continue;default:parser.error_(input,i);}}}function nextState(){var state=stack.pop();if(null!=state){return state}else{return State.VALUE}}function addMessage(opt_data){if(1<parser.depth_){return}if(!opt_data){if(-1===msgStart){opt_data=parser.buffer_+input.substring(streamStart,i)}else{opt_data=input.substring(msgStart,i)}}if(goog.isString(opt_data)){result.push(goog.asserts.assertInstanceof(goog.json.parse(opt_data),Object))}else{result.push(opt_data)}msgStart=i}return null}});