goog.provide("goog.ui.ac.AutoComplete");goog.provide("goog.ui.ac.AutoComplete.EventType");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.object");goog.forwardDeclare("goog.ui.ac.RenderOptions");goog.ui.ac.AutoComplete=function(matcher,renderer,selectionHandler){goog.events.EventTarget.call(this);this.matcher_=matcher;this.selectionHandler_=selectionHandler;this.renderer_=renderer;goog.events.listen(renderer,[goog.ui.ac.AutoComplete.EventType.HILITE,goog.ui.ac.AutoComplete.EventType.SELECT,goog.ui.ac.AutoComplete.EventType.CANCEL_DISMISS,goog.ui.ac.AutoComplete.EventType.DISMISS],this.handleEvent,!1,this);this.token_=null;this.rows_=[];this.hiliteId_=-1;this.firstRowId_=0;this.target_=null;this.dismissTimer_=null;this.inputToAnchorMap_={}};goog.inherits(goog.ui.ac.AutoComplete,goog.events.EventTarget);goog.ui.ac.AutoComplete.prototype.maxMatches_=10;goog.ui.ac.AutoComplete.prototype.autoHilite_=!0;goog.ui.ac.AutoComplete.prototype.allowFreeSelect_=!1;goog.ui.ac.AutoComplete.prototype.wrap_=!1;goog.ui.ac.AutoComplete.prototype.triggerSuggestionsOnUpdate_=!1;goog.ui.ac.AutoComplete.EventType={ROW_HILITE:"rowhilite",HILITE:"hilite",SELECT:"select",DISMISS:"dismiss",CANCEL_DISMISS:"canceldismiss",UPDATE:"update",SUGGESTIONS_UPDATE:"suggestionsupdate"};goog.ui.ac.AutoComplete.Matcher;goog.ui.ac.AutoComplete.prototype.getMatcher=function(){return goog.asserts.assert(this.matcher_)};goog.ui.ac.AutoComplete.prototype.setMatcher=function(matcher){this.matcher_=matcher};goog.ui.ac.AutoComplete.prototype.getSelectionHandler=function(){return goog.asserts.assert(this.selectionHandler_)};goog.ui.ac.AutoComplete.prototype.getRenderer=function(){return this.renderer_};goog.ui.ac.AutoComplete.prototype.setRenderer=function(renderer){this.renderer_=renderer};goog.ui.ac.AutoComplete.prototype.getToken=function(){return this.token_};goog.ui.ac.AutoComplete.prototype.setTokenInternal=function(token){this.token_=token};goog.ui.ac.AutoComplete.prototype.getSuggestion=function(index){return this.rows_[index]};goog.ui.ac.AutoComplete.prototype.getAllSuggestions=function(){return goog.asserts.assert(this.rows_)};goog.ui.ac.AutoComplete.prototype.getSuggestionCount=function(){return this.rows_.length};goog.ui.ac.AutoComplete.prototype.getHighlightedId=function(){return this.hiliteId_};goog.ui.ac.AutoComplete.prototype.handleEvent=function(e){var matcher=this.matcher_;if(e.target==this.renderer_){switch(e.type){case goog.ui.ac.AutoComplete.EventType.HILITE:this.hiliteId(e.row);break;case goog.ui.ac.AutoComplete.EventType.SELECT:var rowDisabled=!1;if(goog.isNumber(e.row)){var rowId=e.row,index=this.getIndexOfId(rowId),row=this.rows_[index];rowDisabled=!!row&&matcher.isRowDisabled&&matcher.isRowDisabled(row);if(row&&!rowDisabled&&this.hiliteId_!=rowId){this.hiliteId(rowId)}}if(!rowDisabled){this.selectHilited()}break;case goog.ui.ac.AutoComplete.EventType.CANCEL_DISMISS:this.cancelDelayedDismiss();break;case goog.ui.ac.AutoComplete.EventType.DISMISS:this.dismissOnDelay();break;}}};goog.ui.ac.AutoComplete.prototype.setMaxMatches=function(max){this.maxMatches_=max};goog.ui.ac.AutoComplete.prototype.setAutoHilite=function(autoHilite){this.autoHilite_=autoHilite};goog.ui.ac.AutoComplete.prototype.setAllowFreeSelect=function(allowFreeSelect){this.allowFreeSelect_=allowFreeSelect};goog.ui.ac.AutoComplete.prototype.setWrap=function(wrap){this.wrap_=wrap};goog.ui.ac.AutoComplete.prototype.setTriggerSuggestionsOnUpdate=function(triggerSuggestionsOnUpdate){this.triggerSuggestionsOnUpdate_=triggerSuggestionsOnUpdate};goog.ui.ac.AutoComplete.prototype.setToken=function(token,opt_fullString){if(this.token_==token){return}this.token_=token;this.matcher_.requestMatchingRows(this.token_,this.maxMatches_,goog.bind(this.matchListener_,this),opt_fullString);this.cancelDelayedDismiss()};goog.ui.ac.AutoComplete.prototype.getTarget=function(){return this.target_};goog.ui.ac.AutoComplete.prototype.setTarget=function(target){this.target_=target};goog.ui.ac.AutoComplete.prototype.isOpen=function(){return this.renderer_.isVisible()};goog.ui.ac.AutoComplete.prototype.getRowCount=function(){return this.getSuggestionCount()};goog.ui.ac.AutoComplete.prototype.hiliteNext=function(){for(var lastId=this.firstRowId_+this.rows_.length-1,toHilite=this.hiliteId_,i=0;i<this.rows_.length;i++){if(toHilite>=this.firstRowId_&&toHilite<lastId){toHilite++}else if(-1==toHilite){toHilite=this.firstRowId_}else if(this.allowFreeSelect_&&toHilite==lastId){this.hiliteId(-1);return!1}else if(this.wrap_&&toHilite==lastId){toHilite=this.firstRowId_}else{return!1}if(this.hiliteId(toHilite)){return!0}}return!1};goog.ui.ac.AutoComplete.prototype.hilitePrev=function(){for(var lastId=this.firstRowId_+this.rows_.length-1,toHilite=this.hiliteId_,i=0;i<this.rows_.length;i++){if(toHilite>this.firstRowId_){toHilite--}else if(this.allowFreeSelect_&&toHilite==this.firstRowId_){this.hiliteId(-1);return!1}else if(this.wrap_&&(-1==toHilite||toHilite==this.firstRowId_)){toHilite=lastId}else{return!1}if(this.hiliteId(toHilite)){return!0}}return!1};goog.ui.ac.AutoComplete.prototype.hiliteId=function(id){var index=this.getIndexOfId(id),row=this.rows_[index],rowDisabled=!!row&&this.matcher_.isRowDisabled&&this.matcher_.isRowDisabled(row);if(!rowDisabled){this.hiliteId_=id;this.renderer_.hiliteId(id);return-1!=index}return!1};goog.ui.ac.AutoComplete.prototype.hiliteIndex=function(index){return this.hiliteId(this.getIdOfIndex_(index))};goog.ui.ac.AutoComplete.prototype.selectHilited=function(){var index=this.getIndexOfId(this.hiliteId_);if(-1!=index){var selectedRow=this.rows_[index],suppressUpdate=this.selectionHandler_.selectRow(selectedRow);if(this.triggerSuggestionsOnUpdate_){this.token_=null;this.dismissOnDelay()}else{this.dismiss()}if(!suppressUpdate){this.dispatchEvent({type:goog.ui.ac.AutoComplete.EventType.UPDATE,row:selectedRow,index:index});if(this.triggerSuggestionsOnUpdate_){this.selectionHandler_.update(!0)}}return!0}else{this.dismiss();this.dispatchEvent({type:goog.ui.ac.AutoComplete.EventType.UPDATE,row:null,index:null});return!1}};goog.ui.ac.AutoComplete.prototype.hasHighlight=function(){return this.isOpen()&&-1!=this.getIndexOfId(this.hiliteId_)};goog.ui.ac.AutoComplete.prototype.dismiss=function(){this.hiliteId_=-1;this.token_=null;this.firstRowId_+=this.rows_.length;this.rows_=[];window.clearTimeout(this.dismissTimer_);this.dismissTimer_=null;this.renderer_.dismiss();this.dispatchEvent(goog.ui.ac.AutoComplete.EventType.SUGGESTIONS_UPDATE);this.dispatchEvent(goog.ui.ac.AutoComplete.EventType.DISMISS)};goog.ui.ac.AutoComplete.prototype.dismissOnDelay=function(){if(!this.dismissTimer_){this.dismissTimer_=window.setTimeout(goog.bind(this.dismiss,this),100)}};goog.ui.ac.AutoComplete.prototype.immediatelyCancelDelayedDismiss_=function(){if(this.dismissTimer_){window.clearTimeout(this.dismissTimer_);this.dismissTimer_=null;return!0}return!1};goog.ui.ac.AutoComplete.prototype.cancelDelayedDismiss=function(){if(!this.immediatelyCancelDelayedDismiss_()){window.setTimeout(goog.bind(this.immediatelyCancelDelayedDismiss_,this),10)}};goog.ui.ac.AutoComplete.prototype.disposeInternal=function(){goog.ui.ac.AutoComplete.superClass_.disposeInternal.call(this);delete this.inputToAnchorMap_;this.renderer_.dispose();this.selectionHandler_.dispose();this.matcher_=null};goog.ui.ac.AutoComplete.prototype.matchListener_=function(matchedToken,rows,opt_options){if(this.token_!=matchedToken){return}this.renderRows(rows,opt_options)};goog.ui.ac.AutoComplete.prototype.renderRows=function(rows,opt_options){var optionsObj="object"==goog.typeOf(opt_options)&&opt_options,preserveHilited=optionsObj?optionsObj.getPreserveHilited():opt_options,indexToHilite=preserveHilited?this.getIndexOfId(this.hiliteId_):-1;this.firstRowId_+=this.rows_.length;this.rows_=rows;for(var rendRows=[],i=0;i<rows.length;++i){rendRows.push({id:this.getIdOfIndex_(i),data:rows[i]})}var anchor=null;if(this.target_){anchor=this.inputToAnchorMap_[goog.getUid(this.target_)]||this.target_}this.renderer_.setAnchorElement(anchor);this.renderer_.renderRows(rendRows,this.token_,this.target_);var autoHilite=this.autoHilite_;if(optionsObj&&optionsObj.getAutoHilite()!==void 0){autoHilite=optionsObj.getAutoHilite()}this.hiliteId_=-1;if((autoHilite||0<=indexToHilite)&&0!=rendRows.length&&this.token_){if(0<=indexToHilite){this.hiliteId(this.getIdOfIndex_(indexToHilite))}else{this.hiliteNext()}}this.dispatchEvent(goog.ui.ac.AutoComplete.EventType.SUGGESTIONS_UPDATE)};goog.ui.ac.AutoComplete.prototype.getIndexOfId=function(id){var index=id-this.firstRowId_;if(0>index||index>=this.rows_.length){return-1}return index};goog.ui.ac.AutoComplete.prototype.getIdOfIndex_=function(index){return this.firstRowId_+index};goog.ui.ac.AutoComplete.prototype.attachInputs=function(var_args){var inputHandler=this.selectionHandler_;inputHandler.attachInputs.apply(inputHandler,arguments)};goog.ui.ac.AutoComplete.prototype.detachInputs=function(var_args){var inputHandler=this.selectionHandler_;inputHandler.detachInputs.apply(inputHandler,arguments);goog.array.forEach(arguments,function(input){goog.object.remove(this.inputToAnchorMap_,goog.getUid(input))},this)};goog.ui.ac.AutoComplete.prototype.attachInputWithAnchor=function(inputElement,anchorElement){this.inputToAnchorMap_[goog.getUid(inputElement)]=anchorElement;this.attachInputs(inputElement)};goog.ui.ac.AutoComplete.prototype.update=function(opt_force){var inputHandler=this.selectionHandler_;inputHandler.update(opt_force)};