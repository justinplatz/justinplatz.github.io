goog.provide("goog.ui.ac.CachingMatcher");goog.require("goog.array");goog.require("goog.async.Throttle");goog.require("goog.ui.ac.ArrayMatcher");goog.require("goog.ui.ac.RenderOptions");goog.ui.ac.CachingMatcher=function(baseMatcher){this.rows_=[];this.rowStrings_={};this.maxCacheSize_=1e3;this.baseMatcher_=baseMatcher;this.getMatchesForRows_=goog.ui.ac.ArrayMatcher.getMatchesForRows;this.baseMatcherMaxMatches_=100;this.throttledTriggerBaseMatch_=new goog.async.Throttle(this.triggerBaseMatch_,150,this);this.mostRecentToken_="";this.mostRecentMatchHandler_=null;this.mostRecentMaxMatches_=10;this.mostRecentMatches_=[]};goog.ui.ac.CachingMatcher.prototype.setThrottleTime=function(throttleTime){this.throttledTriggerBaseMatch_=new goog.async.Throttle(this.triggerBaseMatch_,throttleTime,this)};goog.ui.ac.CachingMatcher.prototype.setBaseMatcherMaxMatches=function(maxMatches){this.baseMatcherMaxMatches_=maxMatches};goog.ui.ac.CachingMatcher.prototype.setMaxCacheSize=function(maxCacheSize){this.maxCacheSize_=maxCacheSize};goog.ui.ac.CachingMatcher.prototype.setLocalMatcher=function(localMatcher){this.getMatchesForRows_=localMatcher};goog.ui.ac.CachingMatcher.prototype.requestMatchingRows=function(token,maxMatches,matchHandler){this.mostRecentMaxMatches_=maxMatches;this.mostRecentToken_=token;this.mostRecentMatchHandler_=matchHandler;this.throttledTriggerBaseMatch_.fire();var matches=this.getMatchesForRows_(token,maxMatches,this.rows_);matchHandler(token,matches);this.mostRecentMatches_=matches};goog.ui.ac.CachingMatcher.prototype.clearCache=function(){this.rows_=[];this.rowStrings_={}};goog.ui.ac.CachingMatcher.prototype.addRows_=function(rows){goog.array.forEach(rows,function(row){if(!this.rowStrings_[" "+row]){this.rows_.push(row);this.rowStrings_[" "+row]=!0}},this)};goog.ui.ac.CachingMatcher.prototype.clearCacheIfTooLarge_=function(){if(this.rows_.length>this.maxCacheSize_){this.clearCache()}};goog.ui.ac.CachingMatcher.prototype.triggerBaseMatch_=function(){this.baseMatcher_.requestMatchingRows(this.mostRecentToken_,this.baseMatcherMaxMatches_,goog.bind(this.onBaseMatch_,this))};goog.ui.ac.CachingMatcher.prototype.onBaseMatch_=function(token,matches){this.addRows_(matches);var oldMatchesSet={};goog.array.forEach(this.mostRecentMatches_,function(match){oldMatchesSet[" "+match]=!0});var newMatches=this.getMatchesForRows_(this.mostRecentToken_,this.mostRecentMaxMatches_,this.rows_);newMatches=goog.array.filter(newMatches,function(match){return!oldMatchesSet[" "+match]});newMatches=this.mostRecentMatches_.concat(newMatches).slice(0,this.mostRecentMaxMatches_);this.mostRecentMatches_=newMatches;var options=new goog.ui.ac.RenderOptions;options.setPreserveHilited(!0);this.mostRecentMatchHandler_(this.mostRecentToken_,newMatches,options);this.clearCacheIfTooLarge_()};