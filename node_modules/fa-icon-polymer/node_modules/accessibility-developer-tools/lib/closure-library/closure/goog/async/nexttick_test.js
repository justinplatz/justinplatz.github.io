goog.provide("goog.async.nextTickTest");goog.setTestOnly("goog.async.nextTickTest");goog.require("goog.Promise");goog.require("goog.Timer");goog.require("goog.async.nextTick");goog.require("goog.debug.ErrorHandler");goog.require("goog.debug.entryPointRegistry");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.labs.userAgent.browser");goog.require("goog.testing.MockClock");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.jsunit");var clock,propertyReplacer=new goog.testing.PropertyReplacer;function setUp(){clock=null}function tearDown(){if(clock){clock.uninstall()}goog.async.nextTick.setImmediate_=void 0;propertyReplacer.reset()}function testNextTick(){return new goog.Promise(function(resolve,reject){for(var c=0,max=100,async=!0,counterStep=function(i){async=!1;assertEquals("Order correct",i,c);c++;if(c===max){resolve()}},i=0;i<max;i++){goog.async.nextTick(goog.partial(counterStep,i))}assertTrue(async)})}function testNextTickSetImmediate(){return new goog.Promise(function(resolve,reject){for(var c=0,max=100,async=!0,counterStep=function(i){async=!1;assertEquals("Order correct",i,c);c++;if(c===max){resolve()}},i=0;i<max;i++){goog.async.nextTick(goog.partial(counterStep,i),void 0,!0)}assertTrue(async)})}function testNextTickContext(){return new goog.Promise(function(resolve,reject){for(var context={},c=0,max=10,async=!0,counterStep=function(i){async=!1;assertEquals("Order correct",i,c);assertEquals(context,this);c++;if(c===max){resolve()}},i=0;i<max;i++){goog.async.nextTick(goog.partial(counterStep,i),context)}assertTrue(async)})}function testNextTickMockClock(){clock=new goog.testing.MockClock(!0);var result="";goog.async.nextTick(function(){result+="a"});goog.async.nextTick(function(){result+="b"});goog.async.nextTick(function(){result+="c"});assertEquals("",result);clock.tick(0);assertEquals("abc",result)}function testNextTickDoesntSwallowError(){return new goog.Promise(function(resolve,reject){var sentinel="sentinel";propertyReplacer.replace(window,"onerror",function(e){e=""+e;if(-1==e.indexOf("Exception thrown and not caught")){assertContains(sentinel,e)}resolve();return!1});goog.async.nextTick(function(){throw sentinel})})}function testNextTickProtectEntryPoint(){return new goog.Promise(function(resolve,reject){var errorHandlerCallbackCalled=!1,errorHandler=new goog.debug.ErrorHandler(function(){errorHandlerCallbackCalled=!0});propertyReplacer.set(goog.async.nextTick,"useSetImmediate_",function(){return!1});propertyReplacer.set(goog.async.nextTick,"setImmediate_",function(cb){try{cb();fail("The callback should have thrown an error.")}catch(e){assertTrue(errorHandlerCallbackCalled);assertTrue(e instanceof goog.debug.ErrorHandler.ProtectedFunctionError)}finally{propertyReplacer.reset()}resolve()});goog.debug.entryPointRegistry.monitorAll(errorHandler);goog.async.nextTick(function(){throw Error("This should be caught by the protected function.")})})}function testNextTick_notStarvedBySetTimeout(){var timeout;function busy(){timeout=setTimeout(function(){busy()},0)}busy();return new goog.Promise(function(resolve,reject){goog.async.nextTick(function(){if(timeout){clearTimeout(timeout)}resolve()})})}function testPostMessagePolyfillDoesNotPumpCallbackQueueIfMessageIsIncorrect(){if(goog.labs.userAgent.browser.isIE()||goog.labs.userAgent.browser.isEdge()){return}propertyReplacer.set(window,"setImmediate",void 0);propertyReplacer.set(window,"MessageChannel",void 0);var callbackCalled=!1;goog.async.nextTick(function(){callbackCalled=!0});var frame=goog.dom.getElementsByTagName(goog.dom.TagName.IFRAME)[0];frame.contentWindow.postMessage("bogus message",window.location.protocol+"//"+window.location.host);var error=null;frame.contentWindow.onerror=function(e){error=e};return goog.Timer.promise(3).then(function(){assert("Callback should have been called.",callbackCalled);assertNull("An unexpected error was thrown.",error)}).thenAlways(function(){goog.dom.removeNode(frame)})}function testBehaviorOnPagesWithOverriddenWindowConstructor(){propertyReplacer.set(goog.global,"Window",{});testNextTick();testNextTickSetImmediate();testNextTickMockClock()}