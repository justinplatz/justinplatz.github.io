goog.provide("goog.net.IframeIo");goog.provide("goog.net.IframeIo.IncrementalDataEvent");goog.require("goog.Timer");goog.require("goog.Uri");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.debug");goog.require("goog.dom");goog.require("goog.dom.InputType");goog.require("goog.dom.TagName");goog.require("goog.dom.safe");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.html.uncheckedconversions");goog.require("goog.json");goog.require("goog.log");goog.require("goog.log.Level");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.reflect");goog.require("goog.string");goog.require("goog.string.Const");goog.require("goog.structs");goog.require("goog.userAgent");goog.net.IframeIo=function(){goog.net.IframeIo.base(this,"constructor");this.name_=goog.net.IframeIo.getNextName_();this.iframesForDisposal_=[];goog.net.IframeIo.instances_[this.name_]=this};goog.inherits(goog.net.IframeIo,goog.events.EventTarget);goog.net.IframeIo.instances_={};goog.net.IframeIo.FRAME_NAME_PREFIX="closure_frame";goog.net.IframeIo.INNER_FRAME_SUFFIX="_inner";goog.net.IframeIo.IFRAME_DISPOSE_DELAY_MS=2e3;goog.net.IframeIo.counter_=0;goog.net.IframeIo.form_;goog.net.IframeIo.send=function(uri,opt_callback,opt_method,opt_noCache,opt_data){var io=new goog.net.IframeIo;goog.events.listen(io,goog.net.EventType.READY,io.dispose,!1,io);if(opt_callback){goog.events.listen(io,goog.net.EventType.COMPLETE,opt_callback)}io.send(uri,opt_method,opt_noCache,opt_data)};goog.net.IframeIo.getIframeByName=function(fname){return window.frames[fname]};goog.net.IframeIo.getInstanceByName=function(fname){return goog.net.IframeIo.instances_[fname]};goog.net.IframeIo.handleIncrementalData=function(win,data){var iframeName=goog.string.endsWith(win.name,goog.net.IframeIo.INNER_FRAME_SUFFIX)?win.parent.name:win.name,iframeIoName=iframeName.substring(0,iframeName.lastIndexOf("_")),iframeIo=goog.net.IframeIo.getInstanceByName(iframeIoName);if(iframeIo&&iframeName==iframeIo.iframeName_){iframeIo.handleIncrementalData_(data)}else{var logger=goog.log.getLogger("goog.net.IframeIo");goog.log.info(logger,"Incremental iframe data routed for unknown iframe")}};goog.net.IframeIo.getNextName_=function(){return goog.net.IframeIo.FRAME_NAME_PREFIX+goog.net.IframeIo.counter_++};goog.net.IframeIo.getForm_=function(){if(!goog.net.IframeIo.form_){goog.net.IframeIo.form_=goog.dom.createDom(goog.dom.TagName.FORM);goog.net.IframeIo.form_.acceptCharset="utf-8";var s=goog.net.IframeIo.form_.style;s.position="absolute";s.visibility="hidden";s.top=s.left="-10px";s.width=s.height="10px";s.overflow="hidden";goog.dom.getDocument().body.appendChild(goog.net.IframeIo.form_)}return goog.net.IframeIo.form_};goog.net.IframeIo.addFormInputs_=function(form,data){var helper=goog.dom.getDomHelper(form);goog.structs.forEach(data,function(value,key){if(!goog.isArray(value)){value=[value]}goog.array.forEach(value,function(value){var inp=helper.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.HIDDEN,name:key,value:value});form.appendChild(inp)})})};goog.net.IframeIo.useIeReadyStateCodePath_=function(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("11")};goog.net.IframeIo.prototype.logger_=goog.log.getLogger("goog.net.IframeIo");goog.net.IframeIo.prototype.form_=null;goog.net.IframeIo.prototype.iframe_=null;goog.net.IframeIo.prototype.iframeName_=null;goog.net.IframeIo.prototype.nextIframeId_=0;goog.net.IframeIo.prototype.active_=!1;goog.net.IframeIo.prototype.complete_=!1;goog.net.IframeIo.prototype.success_=!1;goog.net.IframeIo.prototype.lastUri_=null;goog.net.IframeIo.prototype.lastContent_=null;goog.net.IframeIo.prototype.lastErrorCode_=goog.net.ErrorCode.NO_ERROR;goog.net.IframeIo.prototype.firefoxSilentErrorTimeout_=null;goog.net.IframeIo.prototype.iframeDisposalTimer_=null;goog.net.IframeIo.prototype.errorHandled_;goog.net.IframeIo.prototype.ignoreResponse_=!1;goog.net.IframeIo.prototype.errorChecker_;goog.net.IframeIo.prototype.lastCustomError_;goog.net.IframeIo.prototype.lastContentHtml_;goog.net.IframeIo.prototype.send=function(uri,opt_method,opt_noCache,opt_data){if(this.active_){throw Error("[goog.net.IframeIo] Unable to send, already active.")}var uriObj=new goog.Uri(uri);this.lastUri_=uriObj;var method=opt_method?opt_method.toUpperCase():"GET";if(opt_noCache){uriObj.makeUnique()}goog.log.info(this.logger_,"Sending iframe request: "+uriObj+" ["+method+"]");this.form_=goog.net.IframeIo.getForm_();if("GET"==method){goog.net.IframeIo.addFormInputs_(this.form_,uriObj.getQueryData())}if(opt_data){goog.net.IframeIo.addFormInputs_(this.form_,opt_data)}this.form_.action=uriObj.toString();this.form_.method=method;this.sendFormInternal_();this.clearForm_()};goog.net.IframeIo.prototype.sendFromForm=function(form,opt_uri,opt_noCache){if(this.active_){throw Error("[goog.net.IframeIo] Unable to send, already active.")}var uri=new goog.Uri(opt_uri||form.action);if(opt_noCache){uri.makeUnique()}goog.log.info(this.logger_,"Sending iframe request from form: "+uri);this.lastUri_=uri;this.form_=form;this.form_.action=uri.toString();this.sendFormInternal_()};goog.net.IframeIo.prototype.abort=function(opt_failureCode){if(this.active_){goog.log.info(this.logger_,"Request aborted");var requestIframe=this.getRequestIframe();goog.asserts.assert(requestIframe);goog.events.removeAll(requestIframe);this.complete_=!1;this.active_=!1;this.success_=!1;this.lastErrorCode_=opt_failureCode||goog.net.ErrorCode.ABORT;this.dispatchEvent(goog.net.EventType.ABORT);this.makeReady_()}};goog.net.IframeIo.prototype.disposeInternal=function(){goog.log.fine(this.logger_,"Disposing iframeIo instance");if(this.active_){goog.log.fine(this.logger_,"Aborting active request");this.abort()}goog.net.IframeIo.superClass_.disposeInternal.call(this);if(this.iframe_){this.scheduleIframeDisposal_()}this.disposeForm_();delete this.errorChecker_;this.form_=null;this.lastCustomError_=this.lastContent_=this.lastContentHtml_=null;this.lastUri_=null;this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR;delete goog.net.IframeIo.instances_[this.name_]};goog.net.IframeIo.prototype.isComplete=function(){return this.complete_};goog.net.IframeIo.prototype.isSuccess=function(){return this.success_};goog.net.IframeIo.prototype.isActive=function(){return this.active_};goog.net.IframeIo.prototype.getResponseText=function(){return this.lastContent_};goog.net.IframeIo.prototype.getResponseHtml=function(){return this.lastContentHtml_};goog.net.IframeIo.prototype.getResponseJson=function(){return goog.json.parse(this.lastContent_)};goog.net.IframeIo.prototype.getResponseXml=function(){if(!this.iframe_)return null;return this.getContentDocument_()};goog.net.IframeIo.prototype.getLastUri=function(){return this.lastUri_};goog.net.IframeIo.prototype.getLastErrorCode=function(){return this.lastErrorCode_};goog.net.IframeIo.prototype.getLastError=function(){return goog.net.ErrorCode.getDebugMessage(this.lastErrorCode_)};goog.net.IframeIo.prototype.getLastCustomError=function(){return this.lastCustomError_};goog.net.IframeIo.prototype.setErrorChecker=function(fn){this.errorChecker_=fn};goog.net.IframeIo.prototype.getErrorChecker=function(){return this.errorChecker_};goog.net.IframeIo.prototype.isIgnoringResponse=function(){return this.ignoreResponse_};goog.net.IframeIo.prototype.setIgnoreResponse=function(ignore){this.ignoreResponse_=ignore};goog.net.IframeIo.prototype.sendFormInternal_=function(){this.active_=!0;this.complete_=!1;this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR;this.createIframe_();if(goog.net.IframeIo.useIeReadyStateCodePath_()){this.form_.target=this.iframeName_||"";this.appendIframe_();if(!this.ignoreResponse_){goog.events.listen(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this)}try{this.errorHandled_=!1;this.form_.submit()}catch(e){if(!this.ignoreResponse_){goog.events.unlisten(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this)}this.handleError_(goog.net.ErrorCode.ACCESS_DENIED)}}else{goog.log.fine(this.logger_,"Setting up iframes and cloning form");this.appendIframe_();var innerFrameName=this.iframeName_+goog.net.IframeIo.INNER_FRAME_SUFFIX,doc=goog.dom.getFrameContentDocument(this.iframe_),html;if(document.baseURI){html=goog.net.IframeIo.createIframeHtmlWithBaseUri_(innerFrameName)}else{html=goog.net.IframeIo.createIframeHtml_(innerFrameName)}if(goog.userAgent.OPERA&&!goog.userAgent.WEBKIT){goog.dom.safe.setInnerHtml(doc.documentElement,html)}else{goog.dom.safe.documentWrite(doc,html)}if(!this.ignoreResponse_){goog.events.listen(doc.getElementById(innerFrameName),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this)}for(var textareas=goog.dom.getElementsByTagName(goog.dom.TagName.TEXTAREA,goog.asserts.assert(this.form_)),i=0,n=textareas.length,value;i<n;i++){value=textareas[i].value;if(goog.dom.getRawTextContent(textareas[i])!=value){goog.dom.setTextContent(textareas[i],value);textareas[i].value=value}}var clone=doc.importNode(this.form_,!0);clone.target=innerFrameName;clone.action=this.form_.action;doc.body.appendChild(clone);for(var selects=goog.dom.getElementsByTagName(goog.dom.TagName.SELECT,goog.asserts.assert(this.form_)),clones=goog.dom.getElementsByTagName(goog.dom.TagName.SELECT,clone),i=0,n=selects.length;i<n;i++){for(var selectsOptions=goog.dom.getElementsByTagName(goog.dom.TagName.OPTION,selects[i]),clonesOptions=goog.dom.getElementsByTagName(goog.dom.TagName.OPTION,clones[i]),j=0,m=selectsOptions.length;j<m;j++){clonesOptions[j].selected=selectsOptions[j].selected}}for(var inputs=goog.dom.getElementsByTagName(goog.dom.TagName.INPUT,goog.asserts.assert(this.form_)),inputClones=goog.dom.getElementsByTagName(goog.dom.TagName.INPUT,clone),i=0,n=inputs.length;i<n;i++){if(inputs[i].type==goog.dom.InputType.FILE){if(inputs[i].value!=inputClones[i].value){goog.log.fine(this.logger_,"File input value not cloned properly.  Will "+"submit using original form.");this.form_.target=innerFrameName;clone=this.form_;break}}}goog.log.fine(this.logger_,"Submitting form");try{this.errorHandled_=!1;clone.submit();doc.close();if(goog.userAgent.GECKO){this.firefoxSilentErrorTimeout_=goog.Timer.callOnce(this.testForFirefoxSilentError_,250,this)}}catch(e){goog.log.error(this.logger_,"Error when submitting form: "+goog.debug.exposeException(e));if(!this.ignoreResponse_){goog.events.unlisten(doc.getElementById(innerFrameName),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this)}doc.close();this.handleError_(goog.net.ErrorCode.FILE_NOT_FOUND)}}};goog.net.IframeIo.createIframeHtml_=function(innerFrameName){var innerFrameNameEscaped=goog.string.htmlEscape(innerFrameName);return goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("Short HTML snippet, input escaped, for performance"),"<body><iframe id=\""+innerFrameNameEscaped+"\" name=\""+innerFrameNameEscaped+"\"></iframe>")};goog.net.IframeIo.createIframeHtmlWithBaseUri_=function(innerFrameName){var innerFrameNameEscaped=goog.string.htmlEscape(innerFrameName);return goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("Short HTML snippet, input escaped, safe URL, for performance"),"<head><base href=\""+goog.string.htmlEscape(document.baseURI)+"\"></head>"+"<body><iframe id=\""+innerFrameNameEscaped+"\" name=\""+innerFrameNameEscaped+"\"></iframe>")};goog.net.IframeIo.prototype.onIeReadyStateChange_=function(e){if("complete"==this.iframe_.readyState){goog.events.unlisten(this.iframe_,goog.events.EventType.READYSTATECHANGE,this.onIeReadyStateChange_,!1,this);var doc;try{doc=goog.dom.getFrameContentDocument(this.iframe_);if(goog.userAgent.IE&&"about:blank"==doc.location&&!navigator.onLine){this.handleError_(goog.net.ErrorCode.OFFLINE);return}}catch(ex){this.handleError_(goog.net.ErrorCode.ACCESS_DENIED);return}this.handleLoad_(doc)}};goog.net.IframeIo.prototype.onIframeLoaded_=function(e){if(goog.userAgent.OPERA&&!goog.userAgent.WEBKIT&&"about:blank"==this.getContentDocument_().location){return}goog.events.unlisten(this.getRequestIframe(),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this);try{this.handleLoad_(this.getContentDocument_())}catch(ex){this.handleError_(goog.net.ErrorCode.ACCESS_DENIED)}};goog.net.IframeIo.prototype.handleLoad_=function(contentDocument){goog.log.fine(this.logger_,"Iframe loaded");this.complete_=!0;this.active_=!1;var errorCode;try{var body=contentDocument.body;this.lastContent_=body.textContent||body.innerText;this.lastContentHtml_=body.innerHTML}catch(ex){errorCode=goog.net.ErrorCode.ACCESS_DENIED}var customError;if(!errorCode&&"function"==typeof this.errorChecker_){customError=this.errorChecker_(contentDocument);if(customError){errorCode=goog.net.ErrorCode.CUSTOM_ERROR}}goog.log.log(this.logger_,goog.log.Level.FINER,"Last content: "+this.lastContent_);goog.log.log(this.logger_,goog.log.Level.FINER,"Last uri: "+this.lastUri_);if(errorCode){goog.log.fine(this.logger_,"Load event occurred but failed");this.handleError_(errorCode,customError)}else{goog.log.fine(this.logger_,"Load succeeded");this.success_=!0;this.lastErrorCode_=goog.net.ErrorCode.NO_ERROR;this.dispatchEvent(goog.net.EventType.COMPLETE);this.dispatchEvent(goog.net.EventType.SUCCESS);this.makeReady_()}};goog.net.IframeIo.prototype.handleError_=function(errorCode,opt_customError){if(!this.errorHandled_){this.success_=!1;this.active_=!1;this.complete_=!0;this.lastErrorCode_=errorCode;if(errorCode==goog.net.ErrorCode.CUSTOM_ERROR){goog.asserts.assert(goog.isDef(opt_customError));this.lastCustomError_=opt_customError}this.dispatchEvent(goog.net.EventType.COMPLETE);this.dispatchEvent(goog.net.EventType.ERROR);this.makeReady_();this.errorHandled_=!0}};goog.net.IframeIo.prototype.handleIncrementalData_=function(data){this.dispatchEvent(new goog.net.IframeIo.IncrementalDataEvent(data))};goog.net.IframeIo.prototype.makeReady_=function(){goog.log.info(this.logger_,"Ready for new requests");this.scheduleIframeDisposal_();this.disposeForm_();this.dispatchEvent(goog.net.EventType.READY)};goog.net.IframeIo.prototype.createIframe_=function(){goog.log.fine(this.logger_,"Creating iframe");this.iframeName_=this.name_+"_"+(this.nextIframeId_++).toString(36);var iframeAttributes={name:this.iframeName_,id:this.iframeName_};if(goog.userAgent.IE&&7>+goog.userAgent.VERSION){iframeAttributes.src="javascript:\"\""}this.iframe_=goog.dom.getDomHelper(this.form_).createDom(goog.dom.TagName.IFRAME,iframeAttributes);var s=this.iframe_.style;s.visibility="hidden";s.width=s.height="10px";s.display="none";if(!goog.userAgent.WEBKIT){s.position="absolute";s.top=s.left="-10px"}else{s.marginTop=s.marginLeft="-10px"}};goog.net.IframeIo.prototype.appendIframe_=function(){goog.dom.getDomHelper(this.form_).getDocument().body.appendChild(this.iframe_)};goog.net.IframeIo.prototype.scheduleIframeDisposal_=function(){var iframe=this.iframe_;if(iframe){iframe.onreadystatechange=null;iframe.onload=null;iframe.onerror=null;this.iframesForDisposal_.push(iframe)}if(this.iframeDisposalTimer_){goog.Timer.clear(this.iframeDisposalTimer_);this.iframeDisposalTimer_=null}if(goog.userAgent.GECKO||goog.userAgent.OPERA&&!goog.userAgent.WEBKIT){this.iframeDisposalTimer_=goog.Timer.callOnce(this.disposeIframes_,goog.net.IframeIo.IFRAME_DISPOSE_DELAY_MS,this)}else{this.disposeIframes_()}this.iframe_=null;this.iframeName_=null};goog.net.IframeIo.prototype.disposeIframes_=function(){if(this.iframeDisposalTimer_){goog.Timer.clear(this.iframeDisposalTimer_);this.iframeDisposalTimer_=null}while(0!=this.iframesForDisposal_.length){var iframe=this.iframesForDisposal_.pop();goog.log.info(this.logger_,"Disposing iframe");goog.dom.removeNode(iframe)}};goog.net.IframeIo.prototype.clearForm_=function(){if(this.form_&&this.form_==goog.net.IframeIo.form_){goog.dom.removeChildren(this.form_)}};goog.net.IframeIo.prototype.disposeForm_=function(){this.clearForm_();this.form_=null};goog.net.IframeIo.prototype.getContentDocument_=function(){if(this.iframe_){return goog.dom.getFrameContentDocument(this.getRequestIframe())}return null};goog.net.IframeIo.prototype.getRequestIframe=function(){if(this.iframe_){return goog.net.IframeIo.useIeReadyStateCodePath_()?this.iframe_:goog.dom.getFrameContentDocument(this.iframe_).getElementById(this.iframeName_+goog.net.IframeIo.INNER_FRAME_SUFFIX)}return null};goog.net.IframeIo.prototype.testForFirefoxSilentError_=function(){if(this.active_){var doc=this.getContentDocument_();if(doc&&!goog.reflect.canAccessProperty(doc,"documentUri")){if(!this.ignoreResponse_){goog.events.unlisten(this.getRequestIframe(),goog.events.EventType.LOAD,this.onIframeLoaded_,!1,this)}if(navigator.onLine){goog.log.warning(this.logger_,"Silent Firefox error detected");this.handleError_(goog.net.ErrorCode.FF_SILENT_ERROR)}else{goog.log.warning(this.logger_,"Firefox is offline so report offline error "+"instead of silent error");this.handleError_(goog.net.ErrorCode.OFFLINE)}return}this.firefoxSilentErrorTimeout_=goog.Timer.callOnce(this.testForFirefoxSilentError_,250,this)}};goog.net.IframeIo.IncrementalDataEvent=function(data){goog.events.Event.call(this,goog.net.EventType.INCREMENTAL_DATA);this.data=data};goog.inherits(goog.net.IframeIo.IncrementalDataEvent,goog.events.Event);