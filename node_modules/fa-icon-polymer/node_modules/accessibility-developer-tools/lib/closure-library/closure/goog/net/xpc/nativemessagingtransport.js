goog.provide("goog.net.xpc.NativeMessagingTransport");goog.require("goog.Timer");goog.require("goog.asserts");goog.require("goog.async.Deferred");goog.require("goog.events");goog.require("goog.events.EventHandler");goog.require("goog.log");goog.require("goog.net.xpc");goog.require("goog.net.xpc.CrossPageChannelRole");goog.require("goog.net.xpc.Transport");goog.require("goog.net.xpc.TransportTypes");goog.net.xpc.NativeMessagingTransport=function(channel,peerHostname,opt_domHelper,opt_oneSidedHandshake,opt_protocolVersion){goog.net.xpc.NativeMessagingTransport.base(this,"constructor",opt_domHelper);this.channel_=channel;this.protocolVersion_=opt_protocolVersion||2;goog.asserts.assert(1<=this.protocolVersion_);goog.asserts.assert(2>=this.protocolVersion_);this.peerHostname_=peerHostname||"*";this.eventHandler_=new goog.events.EventHandler(this);this.maybeAttemptToConnectTimer_=new goog.Timer(100,this.getWindow());this.oneSidedHandshake_=!!opt_oneSidedHandshake;this.setupAckReceived_=new goog.async.Deferred;this.setupAckSent_=new goog.async.Deferred;this.connected_=new goog.async.Deferred;this.endpointId_=goog.net.xpc.getRandomString(10);this.peerEndpointId_=null;if(this.oneSidedHandshake_){if(this.channel_.getRole()==goog.net.xpc.CrossPageChannelRole.INNER){this.connected_.awaitDeferred(this.setupAckReceived_)}else{this.connected_.awaitDeferred(this.setupAckSent_)}}else{this.connected_.awaitDeferred(this.setupAckReceived_);if(2==this.protocolVersion_){this.connected_.awaitDeferred(this.setupAckSent_)}}this.connected_.addCallback(this.notifyConnected_,this);this.connected_.callback(!0);this.eventHandler_.listen(this.maybeAttemptToConnectTimer_,goog.Timer.TICK,this.maybeAttemptToConnect_);goog.log.info(goog.net.xpc.logger,"NativeMessagingTransport created.  "+"protocolVersion="+this.protocolVersion_+", oneSidedHandshake="+this.oneSidedHandshake_+", role="+this.channel_.getRole())};goog.inherits(goog.net.xpc.NativeMessagingTransport,goog.net.xpc.Transport);goog.net.xpc.NativeMessagingTransport.CONNECTION_DELAY_MS_=200;goog.net.xpc.NativeMessagingTransport.prototype.peerProtocolVersion_=null;goog.net.xpc.NativeMessagingTransport.prototype.initialized_=!1;goog.net.xpc.NativeMessagingTransport.prototype.transportType=goog.net.xpc.TransportTypes.NATIVE_MESSAGING;goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_=",";goog.net.xpc.NativeMessagingTransport.activeCount_={};goog.net.xpc.NativeMessagingTransport.prototype.sendTimerId_=0;goog.net.xpc.NativeMessagingTransport.prototype.couldPeerVersionBe_=function(version){return null==this.peerProtocolVersion_||this.peerProtocolVersion_==version};goog.net.xpc.NativeMessagingTransport.initialize_=function(listenWindow){var uid=goog.getUid(listenWindow),value=goog.net.xpc.NativeMessagingTransport.activeCount_[uid];if(!goog.isNumber(value)){value=0}if(0==value){goog.events.listen(listenWindow.postMessage?listenWindow:listenWindow.document,"message",goog.net.xpc.NativeMessagingTransport.messageReceived_,!1,goog.net.xpc.NativeMessagingTransport)}goog.net.xpc.NativeMessagingTransport.activeCount_[uid]=value+1};goog.net.xpc.NativeMessagingTransport.messageReceived_=function(msgEvt){var data=msgEvt.getBrowserEvent().data;if(!goog.isString(data)){return!1}var headDelim=data.indexOf("|"),serviceDelim=data.indexOf(":");if(-1==headDelim||-1==serviceDelim){return!1}var channelName=data.substring(0,headDelim),service=data.substring(headDelim+1,serviceDelim),payload=data.substring(serviceDelim+1);goog.log.fine(goog.net.xpc.logger,"messageReceived: channel="+channelName+", service="+service+", payload="+payload);var channel=goog.net.xpc.channels[channelName];if(channel){channel.xpcDeliver(service,payload,msgEvt.getBrowserEvent().origin);return!0}var transportMessageType=goog.net.xpc.NativeMessagingTransport.parseTransportPayload_(payload)[0];for(var staleChannelName in goog.net.xpc.channels){var staleChannel=goog.net.xpc.channels[staleChannelName];if(staleChannel.getRole()==goog.net.xpc.CrossPageChannelRole.INNER&&!staleChannel.isConnected()&&service==goog.net.xpc.TRANSPORT_SERVICE_&&(transportMessageType==goog.net.xpc.SETUP||transportMessageType==goog.net.xpc.SETUP_NTPV2)){staleChannel.updateChannelNameAndCatalog(channelName);staleChannel.xpcDeliver(service,payload);return!0}}goog.log.info(goog.net.xpc.logger,"channel name mismatch; message ignored\"");return!1};goog.net.xpc.NativeMessagingTransport.prototype.transportServiceHandler=function(payload){var transportParts=goog.net.xpc.NativeMessagingTransport.parseTransportPayload_(payload),transportMessageType=transportParts[0],peerEndpointId=transportParts[1];switch(transportMessageType){case goog.net.xpc.SETUP_ACK_:this.setPeerProtocolVersion_(1);if(!this.setupAckReceived_.hasFired()){this.setupAckReceived_.callback(!0)}break;case goog.net.xpc.SETUP_ACK_NTPV2:if(2==this.protocolVersion_){this.setPeerProtocolVersion_(2);if(!this.setupAckReceived_.hasFired()){this.setupAckReceived_.callback(!0)}}break;case goog.net.xpc.SETUP:this.setPeerProtocolVersion_(1);this.sendSetupAckMessage_(1);break;case goog.net.xpc.SETUP_NTPV2:if(2==this.protocolVersion_){var prevPeerProtocolVersion=this.peerProtocolVersion_;this.setPeerProtocolVersion_(2);this.sendSetupAckMessage_(2);if((1==prevPeerProtocolVersion||null!=this.peerEndpointId_)&&this.peerEndpointId_!=peerEndpointId){goog.log.info(goog.net.xpc.logger,"Sending SETUP and changing peer ID to: "+peerEndpointId);this.sendSetupMessage_()}this.peerEndpointId_=peerEndpointId}break;}};goog.net.xpc.NativeMessagingTransport.prototype.sendSetupMessage_=function(){goog.asserts.assert(!(1==this.protocolVersion_&&2==this.peerProtocolVersion_));if(2==this.protocolVersion_&&this.couldPeerVersionBe_(2)){var payload=goog.net.xpc.SETUP_NTPV2;payload+=goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_;payload+=this.endpointId_;this.send(goog.net.xpc.TRANSPORT_SERVICE_,payload)}if(this.couldPeerVersionBe_(1)){this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP)}};goog.net.xpc.NativeMessagingTransport.prototype.sendSetupAckMessage_=function(protocolVersion){goog.asserts.assert(1!=this.protocolVersion_||2!=protocolVersion,"Shouldn't try to send a v2 setup ack in v1 mode.");if(2==this.protocolVersion_&&this.couldPeerVersionBe_(2)&&2==protocolVersion){this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP_ACK_NTPV2)}else if(this.couldPeerVersionBe_(1)&&1==protocolVersion){this.send(goog.net.xpc.TRANSPORT_SERVICE_,goog.net.xpc.SETUP_ACK_)}else{return}if(!this.setupAckSent_.hasFired()){this.setupAckSent_.callback(!0)}};goog.net.xpc.NativeMessagingTransport.prototype.setPeerProtocolVersion_=function(version){if(version>this.peerProtocolVersion_){this.peerProtocolVersion_=version}if(1==this.peerProtocolVersion_){if(!this.setupAckSent_.hasFired()&&!this.oneSidedHandshake_){this.setupAckSent_.callback(!0)}this.peerEndpointId_=null}};goog.net.xpc.NativeMessagingTransport.prototype.connect=function(){goog.net.xpc.NativeMessagingTransport.initialize_(this.getWindow());this.initialized_=!0;this.maybeAttemptToConnect_()};goog.net.xpc.NativeMessagingTransport.prototype.maybeAttemptToConnect_=function(){var outerFrame=this.channel_.getRole()==goog.net.xpc.CrossPageChannelRole.OUTER;if(this.oneSidedHandshake_&&outerFrame||this.channel_.isConnected()||this.isDisposed()){this.maybeAttemptToConnectTimer_.stop();return}this.maybeAttemptToConnectTimer_.start();this.sendSetupMessage_()};goog.net.xpc.NativeMessagingTransport.prototype.send=function(service,payload){var win=this.channel_.getPeerWindowObject();if(!win){goog.log.fine(goog.net.xpc.logger,"send(): window not ready");return}this.send=function(service,payload){var transport=this,channelName=this.channel_.name,sendFunctor=function(){transport.sendTimerId_=0;try{var obj=win.postMessage?win:win.document;if(!obj.postMessage){goog.log.warning(goog.net.xpc.logger,"Peer window had no postMessage function.");return}obj.postMessage(channelName+"|"+service+":"+payload,transport.peerHostname_);goog.log.fine(goog.net.xpc.logger,"send(): service="+service+" payload="+payload+" to hostname="+transport.peerHostname_)}catch(error){goog.log.warning(goog.net.xpc.logger,"Error performing postMessage, ignoring.",error)}};this.sendTimerId_=goog.Timer.callOnce(sendFunctor,0)};this.send(service,payload)};goog.net.xpc.NativeMessagingTransport.prototype.notifyConnected_=function(){var delay=1==this.protocolVersion_||1==this.peerProtocolVersion_?goog.net.xpc.NativeMessagingTransport.CONNECTION_DELAY_MS_:void 0;this.channel_.notifyConnected(delay)};goog.net.xpc.NativeMessagingTransport.prototype.disposeInternal=function(){if(this.initialized_){var listenWindow=this.getWindow(),uid=goog.getUid(listenWindow),value=goog.net.xpc.NativeMessagingTransport.activeCount_[uid];goog.net.xpc.NativeMessagingTransport.activeCount_[uid]=value-1;if(1==value){goog.events.unlisten(listenWindow.postMessage?listenWindow:listenWindow.document,"message",goog.net.xpc.NativeMessagingTransport.messageReceived_,!1,goog.net.xpc.NativeMessagingTransport)}}if(this.sendTimerId_){goog.Timer.clear(this.sendTimerId_);this.sendTimerId_=0}goog.dispose(this.eventHandler_);delete this.eventHandler_;goog.dispose(this.maybeAttemptToConnectTimer_);delete this.maybeAttemptToConnectTimer_;this.setupAckReceived_.cancel();delete this.setupAckReceived_;this.setupAckSent_.cancel();delete this.setupAckSent_;this.connected_.cancel();delete this.connected_;delete this.send;goog.net.xpc.NativeMessagingTransport.base(this,"disposeInternal")};goog.net.xpc.NativeMessagingTransport.parseTransportPayload_=function(payload){var transportParts=payload.split(goog.net.xpc.NativeMessagingTransport.MESSAGE_DELIMITER_);transportParts[1]=transportParts[1]||null;return transportParts};