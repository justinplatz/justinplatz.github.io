goog.setTestOnly("goog.testing.PerformanceTimer");goog.provide("goog.testing.PerformanceTimer");goog.provide("goog.testing.PerformanceTimer.Task");goog.require("goog.array");goog.require("goog.async.Deferred");goog.require("goog.math");goog.testing.PerformanceTimer=function(opt_numSamples,opt_timeoutInterval){this.numSamples_=opt_numSamples||10;this.timeoutInterval_=opt_timeoutInterval||5e3;this.discardOutliers_=!1};goog.testing.PerformanceTimer.now_=function(){return!goog.DEBUG&&window.performance&&window.performance.now?window.performance.now():goog.now()};goog.testing.PerformanceTimer.prototype.getNumSamples=function(){return this.numSamples_};goog.testing.PerformanceTimer.prototype.setNumSamples=function(numSamples){this.numSamples_=numSamples};goog.testing.PerformanceTimer.prototype.getTimeoutInterval=function(){return this.timeoutInterval_};goog.testing.PerformanceTimer.prototype.setTimeoutInterval=function(timeoutInterval){this.timeoutInterval_=timeoutInterval};goog.testing.PerformanceTimer.prototype.setDiscardOutliers=function(discard){this.discardOutliers_=discard};goog.testing.PerformanceTimer.prototype.isDiscardOutliers=function(){return this.discardOutliers_};goog.testing.PerformanceTimer.prototype.run=function(testFn){return this.runTask(new goog.testing.PerformanceTimer.Task(testFn))};goog.testing.PerformanceTimer.prototype.runTask=function(task){for(var samples=[],testStart=goog.testing.PerformanceTimer.now_(),totalRunTime=0,testFn=task.getTest(),setUpFn=task.getSetUp(),tearDownFn=task.getTearDown(),i=0;i<this.numSamples_&&totalRunTime<=this.timeoutInterval_;i++){setUpFn();var sampleStart=goog.testing.PerformanceTimer.now_();testFn();var sampleEnd=goog.testing.PerformanceTimer.now_();tearDownFn();samples[i]=sampleEnd-sampleStart;totalRunTime=sampleEnd-testStart}return this.finishTask_(samples)};goog.testing.PerformanceTimer.prototype.finishTask_=function(samples){if(this.discardOutliers_&&2<samples.length){goog.array.remove(samples,Math.min.apply(null,samples));goog.array.remove(samples,Math.max.apply(null,samples))}return goog.testing.PerformanceTimer.createResults(samples)};goog.testing.PerformanceTimer.prototype.runAsyncTask=function(task){var samples=[],testStart=goog.testing.PerformanceTimer.now_(),testFn=task.getTest(),setUpFn=task.getSetUp(),tearDownFn=task.getTearDown(),result=new goog.async.Deferred;this.runAsyncTaskSample_(testFn,setUpFn,tearDownFn,result,samples,testStart);return result};goog.testing.PerformanceTimer.prototype.runAsyncTaskSample_=function(testFn,setUpFn,tearDownFn,result,samples,testStart){var timer=this;timer.handleOptionalDeferred_(setUpFn,function(){var sampleStart=goog.testing.PerformanceTimer.now_();timer.handleOptionalDeferred_(testFn,function(){var sampleEnd=goog.testing.PerformanceTimer.now_();timer.handleOptionalDeferred_(tearDownFn,function(){samples.push(sampleEnd-sampleStart);var totalRunTime=sampleEnd-testStart;if(samples.length<timer.numSamples_&&totalRunTime<=timer.timeoutInterval_){timer.runAsyncTaskSample_(testFn,setUpFn,tearDownFn,result,samples,testStart)}else{result.callback(timer.finishTask_(samples))}})})})};goog.testing.PerformanceTimer.prototype.handleOptionalDeferred_=function(deferredFactory,continuationFunction){var deferred=deferredFactory();if(deferred){deferred.addCallback(continuationFunction)}else{continuationFunction()}};goog.testing.PerformanceTimer.createResults=function(samples){return{average:goog.math.average.apply(null,samples),count:samples.length,maximum:Math.max.apply(null,samples),minimum:Math.min.apply(null,samples),standardDeviation:goog.math.standardDeviation.apply(null,samples),total:goog.math.sum.apply(null,samples)}};goog.testing.PerformanceTimer.TestFunction;goog.testing.PerformanceTimer.Task=function(test){this.test_=test};goog.testing.PerformanceTimer.Task.prototype.setUp_=goog.nullFunction;goog.testing.PerformanceTimer.Task.prototype.tearDown_=goog.nullFunction;goog.testing.PerformanceTimer.Task.prototype.getTest=function(){return this.test_};goog.testing.PerformanceTimer.Task.prototype.withSetUp=function(setUp){this.setUp_=setUp;return this};goog.testing.PerformanceTimer.Task.prototype.getSetUp=function(){return this.setUp_};goog.testing.PerformanceTimer.Task.prototype.withTearDown=function(tearDown){this.tearDown_=tearDown;return this};goog.testing.PerformanceTimer.Task.prototype.getTearDown=function(){return this.tearDown_};