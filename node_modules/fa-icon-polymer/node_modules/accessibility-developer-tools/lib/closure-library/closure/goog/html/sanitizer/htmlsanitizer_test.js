goog.setTestOnly();goog.require("goog.array");goog.require("goog.dom");goog.require("goog.html.SafeHtml");goog.require("goog.html.SafeUrl");goog.require("goog.html.sanitizer.HtmlSanitizer");goog.require("goog.html.sanitizer.TagWhitelist");goog.require("goog.html.sanitizer.unsafe");goog.require("goog.html.testing");goog.require("goog.object");goog.require("goog.string.Const");goog.require("goog.testing.dom");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function isIE8(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(9)}function isIE9(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(10)&&!isIE8()}function assertSanitizedHtml(originalHtml,expectedHtml,opt_sanitizer){var sanitizer=opt_sanitizer||new goog.html.sanitizer.HtmlSanitizer.Builder().build();try{var sanitized=sanitizer.sanitize(originalHtml);if(isIE9()){assertEquals("",goog.html.SafeHtml.unwrap(sanitized));return}goog.testing.dom.assertHtmlMatches(expectedHtml,goog.html.SafeHtml.unwrap(sanitized),!0)}catch(err){if(!isIE8()){throw err}}}function getStyle(safeHtml){var tmpElement=goog.dom.safeHtmlToNode(safeHtml);return tmpElement.style?tmpElement.style.cssText:""}function testHtmlSanitizeSafeHtml(){var html;html="hello world";assertSanitizedHtml(html,html);html="<b>hello world</b>";assertSanitizedHtml(html,html);html="<i>hello world</i>";assertSanitizedHtml(html,html);html="<u>hello world</u>";assertSanitizedHtml(html,html);html="<table><tbody><tr><td>hello world</td></tr></tbody></table>";assertSanitizedHtml(html,html);html="<h1>hello world</h1>";assertSanitizedHtml(html,html);html="<div>hello world</div>";assertSanitizedHtml(html,html);html="<a>hello world</a>";assertSanitizedHtml(html,html);html="<div><span>hello world</span></div>";assertSanitizedHtml(html,html);html="<div><a target='_blank'>hello world</a></div>";assertSanitizedHtml(html,html)}function testDefaultCssSanitizeImage(){var html="<div></div>";assertSanitizedHtml(html,html)}function testAllowedCssSanitizeImage(){var testUrl="http://www.example.com/image3.jpg",html="<div style=\"background: url("+testUrl+");\"></div>",sanitizer=new goog.html.sanitizer.HtmlSanitizer.Builder().allowCssStyles().withCustomNetworkRequestUrlPolicy(goog.html.SafeUrl.sanitize).build();try{var sanitizedHtml=sanitizer.sanitize(html);if(isIE9()){assertEquals("",goog.html.SafeHtml.unwrap(sanitizedHtml));return}assertRegExp(/background(?:-image)?:.*url\(.?http:\/\/www.example.com\/image3.jpg.?\)/,getStyle(sanitizedHtml))}catch(err){if(!isIE8()){throw err}}}function testHtmlSanitizeXSS(){var safeHtml,xssHtml;safeHtml="";xssHtml="<SCRIPT SRC=xss.js></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"javascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<div><a>hello world</a></div>";xssHtml="<div><a target='_xss'>hello world</a></div>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<IFRAME SRC=\"javascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<iframe src=\" javascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=javascript:alert(\"XSS\")>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=JaVaScRiPt:alert(\"XSS\")>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=javascript:alert(&quot;XSS&quot;)>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=`javascript:alert(\"foo 'bar'\")`>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG data-xxx=`yyy`>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />\"&gt;";xssHtml="<IMG \"\"\"><SCRIPT defer>exploited = true;</SCRIPT>\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;"+"&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;"+"&#41;>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099"+"&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108"+"&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083"+"&#0000083&#0000039&#0000041>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A"+"&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"jav\tascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"jav&#x09;ascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"jav&#x0A;ascript:xss=true;\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG\nSRC\n=\n\"\nj\na\nv\na\ns\nc\nr\ni\np\nt\n:\na\nl\ne\nr\nt"+"\n(\n\"\nX\nS\nS\n\"\n)\n\"\n>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=java\0script:alert(\"hey\");>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"":"<span>alert(\"XSS\")</span>";xssHtml="<SCR\0IPT>alert(\"XSS\")</SCR\0IPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\" &#14;  javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT/XSS SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<BODY onload!#$%&()*~+-_.,:;?@[/|]^`=alert(\"XSS\")>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT/SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="&lt;";xssHtml="<<SCRIPT>xss=true;//<</SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT SRC=http://ha.ckers.org/xss.js?<B>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT SRC=//ha.ckers.org/.j>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"<img>":"";xssHtml="<IMG SRC=\"javascript:alert(this)\"";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<iframe src=http://ha.ckers.org/scriptlet.html <";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="</TITLE><SCRIPT>alert(window);</SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<input type=\"IMAGE\" />";xssHtml="<INPUT TYPE=\"IMAGE\" SRC=\"javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<BODY BACKGROUND=\"javascript:alert(window)\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<BODY ONLOAD=alert(window)>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG DYNSRC=\"javascript:alert(window)\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG LOWSRC=\"javascript:alert(window)\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<BGSOUND SRC=\"javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<br size=\"&amp;{alert(window)}\" />";xssHtml="<BR SIZE=\"&{alert(window)}\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<LAYER SRC=\"http://ha.ckers.org/scriptlet.html\"></LAYER>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<LINK REL=\"stylesheet\" HREF=\"javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<ul><li>XSS</li></ul>";xssHtml="<STYLE>li {list-style-image: url(\"javascript:alert(window)\");}"+"</STYLE><UL><LI>XSS";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC='vbscript:msgbox(\"XSS\")'>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"mocha:[code]\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"livescript:[code]\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<META HTTP-EQUIV=\"refresh\" CONTENT=\"0;url="+"javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<META HTTP-EQUIV=\"refresh\" CONTENT=\"0;url=data:text/html;base64,"+"PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<META HTTP-EQUIV=\"refresh\" CONTENT=\"0; URL=http://;URL="+"javascript:alert(window);\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<IFRAME SRC=\"javascript:alert(window);\"></IFRAME>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<FRAMESET><FRAME SRC=\"javascript:alert(window);\"></FRAMESET>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"<table><div></div></table>":"<table></table>";xssHtml="<TABLE BACKGROUND=\"javascript:alert(window)\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<table><tbody><tr><td></td></tr></tbody></table>";xssHtml="<TABLE><TD BACKGROUND=\"javascript:alert(window)\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<div></div>";xssHtml="<DIV STYLE=\"background-image: url(javascript:alert(window))\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<div></div>";xssHtml="<DIV STYLE=\"background-image: url(&#1;javascript:alert(window))\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<div></div>";xssHtml="<DIV STYLE=\"width: expression(alert(window));\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<STYLE>@import'ja\x0Basc\ript:alert(window)';</STYLE>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG STYLE=\"xss:expr/*XSS*/ession(alert(window))\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<span></span>";xssHtml="<XSS STYLE=\"xss:expression(alert(window))\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"undefined":"exp/*<a></a>";xssHtml="exp/*<A STYLE=\"no\\xss:noxss(\"*//*\");xss:&#101;x&#x2F;*XSS*//*"+"/*/pression(alert(window))\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<STYLE TYPE=\"text/javascript\">xss=true;</STYLE>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"undefined":"<a></a>";xssHtml="<STYLE>.XSS{background-image:url(\"javascript:alert(\"XSS\")\");}"+"</STYLE><A CLASS=XSS></A>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<BASE HREF=\"javascript:xss=true;//\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<OBJECT TYPE=\"text/x-scriptlet\" "+"DATA=\"http://ha.ckers.org/scriptlet.html\"></OBJECT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<EMBED SRC=\"http://ha.ckers.org/xss.swf\" "+"AllowScriptAccess=\"always\"></EMBED>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<EMBED SRC=\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH"+" A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv Mj"+"AwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB"+"2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBp"+"ZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpO"+"zwvc2NyaXB0Pjwvc3ZnPg==\" type=\"image/svg+xml\" "+"AllowScriptAccess=\"always\"></EMBED>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<span>XSS</span>";xssHtml="<HTML xmlns:xss>"+"<?import namespace=\"xss\" implementation=\"http://ha.ckers.org/xss.htc\">"+"<xss:xss>XSS</xss:xss>"+"</HTML>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml=isIE9()?"<span><span></span></span>":"<span><span><span>]]&gt;</span></span></span>"+"<span></span>";xssHtml="<XML ID=I><X><C><![CDATA[<IMG SRC=\"javas]]>"+"<![CDATA[cript:xss=true;\">]]>"+"</C></X></xml><SPAN DATASRC=#I DATAFLD=C DATAFORMATAS=HTML></SPAN>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<span></span>";xssHtml="<HTML><BODY>"+"<?xml:namespace prefix=\"t\" ns=\"urn:schemas-microsoft-com:time\">"+"<?import namespace=\"t\" implementation=\"#default#time2\">"+"<t:set attributeName=\"innerHTML\" to=\"XSS&lt;SCRIPT DEFER&gt;"+"alert(&quot;XSS&quot;)&lt;/SCRIPT&gt;\">"+"</BODY></HTML>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="<img />";xssHtml="<IMG SRC=\"http://www.thesiteyouareon.com/somecommand.php?"+"somevariables=maliciouscode\">";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT a=\">\" SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="";xssHtml="<SCRIPT =\">\" SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml);safeHtml="PT SRC=\"http://ha.ckers.org/xss.js\"&gt;";xssHtml="<SCRIPT>document.write(\"<SCRI\");</SCRIPT>PT "+"SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>";assertSanitizedHtml(xssHtml,safeHtml)}function testDataAttributes(){var html="<div data-xyz=\"test\">Testing</div>",safeHtml="<div>Testing</div>";assertSanitizedHtml(html,safeHtml);html="<div data-goomoji=\"test\" data-other=\"xyz\">Testing</div>";var expectedHtml="<div data-goomoji=\"test\">Testing</div>";assertSanitizedHtml(html,expectedHtml,new goog.html.sanitizer.HtmlSanitizer.Builder().allowCssStyles().allowDataAttributes(["data-goomoji"]).build())}function testDisallowedDataWhitelistingAttributes(){assertThrows(function(){new goog.html.sanitizer.HtmlSanitizer.Builder().allowDataAttributes(["datai"]).build()});assertThrows(function(){new goog.html.sanitizer.HtmlSanitizer.Builder().allowDataAttributes(["data-i","data-sanitizer-safe"]).build()})}function testFormBody(){var safeHtml="<form>stuff</form>",formHtml="<form name=\"body\">stuff</form>";assertSanitizedHtml(formHtml,safeHtml,new goog.html.sanitizer.HtmlSanitizer.Builder().allowFormTag().build())}function testStyleTag(){var safeHtml="",xssHtml="<STYLE>P.special {color : green;border: solid red;}</STYLE>";assertSanitizedHtml(xssHtml,safeHtml)}function testOnlyAllowTags(){var result="<div><span></span>"+"<a href=\"http://www.google.com\">hi</a>"+"<br>Test.<span></span><div align=\"right\">Test</div></div>";assertSanitizedHtml("<div><img id=\"bar\" name=foo class=\"c d\" "+"src=\"http://wherever.com\">"+"<a href=\" http://www.google.com\">hi</a>"+"<br>Test.<hr><div align=\"right\">Test</div></div>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowTags(["bR","a","DIV"]).build())}function testDisallowNonWhitelistedTags(){assertThrows("Should error on elements not whitelisted",function(){new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowTags(["x"])})}function testDefaultPoliciesAreApplied(){var result="<img /><a href=\"http://www.google.com\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" "+"src=\"http://wherever.com\">"+"<a href=\" http://www.google.com\">hi</a>"+"<a href=ftp://whatever.com>another</a>",result)}function testCustomNamePolicyIsApplied(){var result="<img name=\"myOwnPrefix-foo\" />"+"<a href=\"http://www.google.com\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" "+"src=\"http://wherever.com\"><a href=\" http://www.google.com\">hi</a>"+"<a href=ftp://whatever.com>another</a>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomNamePolicy(function(name){return"myOwnPrefix-"+name}).build())}function testCustomTokenPolicyIsApplied(){var result="<img id=\"myOwnPrefix-bar\" "+"class=\"myOwnPrefix-c myOwnPrefix-d\" />"+"<a href=\"http://www.google.com\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" "+"src=\"http://wherever.com\"><a href=\" http://www.google.com\">hi</a>"+"<a href=ftp://whatever.com>another</a>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomTokenPolicy(function(name){return"myOwnPrefix-"+name}).build())}function testMultipleCustomPoliciesAreApplied(){var result="<img id=\"plarpalarp-bar\" name=\"larlarlar-foo\" "+"class=\"plarpalarp-c plarpalarp-d\" />"+"<a href=\"http://www.google.com\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" "+"src=\"http://wherever.com\"><a href=\" http://www.google.com\">hi</a>"+"<a href=ftp://whatever.com>another</a>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomTokenPolicy(function(token){return"plarpalarp-"+token}).withCustomNamePolicy(function(name){return"larlarlar-"+name}).build())}function testNonTrivialCustomPolicy(){var result="<img /><a href=\"http://www.google.com\" name=\"Alacrity\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" src=\"http://wherever.com\">"+"<a href=\" http://www.google.com\" name=Alacrity>hi</a>"+"<a href=ftp://whatever.com>another</a>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomNamePolicy(function testNamesMustBeginWithTheLetterA(name){return"A"!=name.charAt(0)?null:name}).build())}function testNetworkRequestUrlsAllowed(){var result="<img src=\"http://wherever.com\" />"+"<img src=\"https://secure.wherever.com\" />"+"<img alt=\"test\" src=\"//wherever.com\" />"+"<a href=\"http://www.google.com\">hi</a>"+"<a href=\"ftp://whatever.com\">another</a>";assertSanitizedHtml("<img id=\"bar\" name=foo class=\"c d\" src=\"http://wherever.com\">"+"<img src=\"https://secure.wherever.com\">"+"<img alt=\"test\" src=\"//wherever.com\">"+"<a href=\" http://www.google.com\">hi</a>"+"<a href=ftp://whatever.com>another</a>",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomNetworkRequestUrlPolicy(goog.html.SafeUrl.sanitize).build())}function testCustomNRUrlPolicyMustNotContainParameters(){var result="<img src=\"http://wherever.com\" /><img />";assertSanitizedHtml("<img id=\"bar\" class=\"c d\" src=\"http://wherever.com\">"+"<img src=\"https://www.bank.com/withdraw?amount=onebeeeelion\">",result,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomNetworkRequestUrlPolicy(function(url){return url.match(/\?/)?null:goog.html.testing.newSafeUrlForTest(url)}).build())}function testPolicyHints(){var sanitizer=new goog.html.sanitizer.HtmlSanitizer.Builder().allowFormTag().withCustomNetworkRequestUrlPolicy(function(url,policyHints){if("img"==policyHints.tagName&&"src"==policyHints.attributeName||"input"==policyHints.tagName&&"src"==policyHints.attributeName){return goog.html.testing.newSafeUrlForTest("https://imageproxy/?"+url)}else{return null}}).withCustomUrlPolicy(function(url,policyHints){if("a"==policyHints.tagName&&"href"==policyHints.attributeName){return goog.html.testing.newSafeUrlForTest("https://linkproxy/?"+url)}return goog.html.SafeUrl.sanitize(url)}).build(),result="<img src=\"https://imageproxy/?http://image\" /> "+"<input type=\"image\" src=\"https://imageproxy/?http://another\" />"+"<a href=\"https://linkproxy/?http://link\">a link</a>"+"<form action=\"http://formaction\"></form>";assertSanitizedHtml("<img src=\"http://image\"> <input type=\"image\" "+"src=\"http://another\"><a href=\"http://link\">a link</a>"+"<form action=\"http://formaction\"></form>",result,sanitizer)}function testNRUrlPolicyAffectsCssSanitization(){var sanitizer=new goog.html.sanitizer.HtmlSanitizer.Builder().allowCssStyles().withCustomNetworkRequestUrlPolicy(function(url,policyHints){if(!/^https:\/\//i.test(url)){return null}if("background-image"===policyHints.cssProperty){if(!/^https:\/\/www\.google\.com\//i.test(url)){return null}}return goog.html.SafeUrl.sanitize(url)}).build(),sanitizedHtml;try{sanitizedHtml=sanitizer.sanitize("<div style=\"background: url('https://www.google.com/i.png')\"></div>");if(isIE9()){assertEquals("",goog.html.SafeHtml.unwrap(sanitizedHtml));return}assertRegExp(/background(?:-image)?:.*url\(.?https:\/\/www.google.com\/i.png.?\)/,getStyle(sanitizedHtml))}catch(err){if(!isIE8()){throw err}}try{sanitizedHtml=sanitizer.sanitize("<div style=\"background: url('https://wherever/')\"></div>");assertNotContains("https://wherever/",goog.html.SafeHtml.unwrap(sanitizedHtml))}catch(err){if(!isIE8()){throw err}}sanitizedHtml="<img src=\"https://www.google.com/i.png\">";assertSanitizedHtml(sanitizedHtml,sanitizedHtml,sanitizer);sanitizedHtml="<img src=\"https://wherever/\">";assertSanitizedHtml(sanitizedHtml,sanitizedHtml,sanitizer)}function testAllowOnlyHttpAndHttpsAndFtpForNRUP(){var input="<img src=\"http://whatever\">"+"<img src=\"https://whatever\">"+"<img src=\"ftp://nope\">"+"<img src=\"garbage:nope\">"+"<img src=\"data:yep\">",expected="<img src=\"http://whatever\" />"+"<img src=\"https://whatever\" />"+"<img src=\"ftp://nope\">"+"<img />"+"<img />";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomNetworkRequestUrlPolicy(goog.html.SafeUrl.sanitize).build())}function testUriSchemesOnNonNetworkRequestUrls(){var input="<a href=\"ftp://yep\">something</a>"+"<a href=\"gopher://yep\">something</a>"+"<a href=\"gopher:nope\">something</a>"+"<a href=\"http://yep\">something</a>"+"<a href=\"https://yep\">something</a>"+"<a href=\"garbage://nope\">something</a>"+"<a href=\"relative/yup\">something</a>"+"<a href=\"nope\">something</a>"+"<a>lol</a>",expected="<a href=\"ftp://yep\">something</a>"+"<a>something</a>"+"<a>something</a>"+"<a href=\"http://yep\">something</a>"+"<a href=\"https://yep\">something</a>"+"<a>something</a>"+"<a href=\"relative/yup\">something</a>"+"<a href=\"nope\">something</a>"+"<a>lol</a>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomUrlPolicy(goog.html.SafeUrl.sanitize).build())}function testOverridingGetOrSetAttribute(){var input="<form>"+"<input name=setAttribute />"+"<input name=getAttribute />"+"</form>",expected="<form><input><input></form>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().allowFormTag().build())}function testOverridingBookkeepingAttribute(){var input="<div data-sanitizer-foo=\"1\" alt=\"b\">Hello</div>",expected="<div alt=\"b\">Hello</div>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().withCustomTokenPolicy(function(token){return token}).build())}function testTemplateRemoved(){var input="<div><template><h1>boo</h1></template></div>",expected="<div></div>";assertSanitizedHtml(input,expected)}function otag(tag){return"data-sanitizer-original-tag=\""+tag+"\""}function testOriginalTag(){var input="<p>Line1<magic></magic></p>",expected="<p>Line1<span "+otag("magic")+"></span></p>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().addOriginalTagNames().build())}function testOriginalTagOverwrite(){var input="<div id=\"qqq\">hello"+"<a:b id=\"hi\" class=\"hnn a\" boo=\"3\">qqq</a:b></div>",expected="<div>hello<span "+otag("a:b")+" id=\"HI\" class=\"hnn a\">"+"qqq</span></div>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().addOriginalTagNames().withCustomTokenPolicy(function(token,hints){var an=hints.attributeName;if("id"===an&&"hi"===token){return"HI"}else if("class"===an){return token}return null}).build())}function testOriginalTagClobber(){var input="<a:b data-sanitizer-original-tag=\"xss\"></a:b>",expected="<span "+otag("a:b")+"></span>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().addOriginalTagNames().build())}function assertAfterInsertionEquals(expected,input){var sanitizer=new goog.html.sanitizer.HtmlSanitizer.Builder().allowFormTag().build();input=goog.html.SafeHtml.unwrap(sanitizer.sanitize(input));var div=document.createElement("div");document.body.appendChild(div);div.innerHTML=input;goog.testing.dom.assertHtmlMatches(expected,div.innerHTML,!0);div.parentNode.removeChild(div)}function testSpanNotCorrectedByBrowsersOuter(){if(isIE8()||isIE9()){return}goog.array.forEach(goog.object.getKeys(goog.html.sanitizer.TagWhitelist),function(tag){if(goog.array.contains(["BR","IMG","AREA","COL","COLGROUP","HR","INPUT","SOURCE","WBR"],tag)){return}if(goog.array.contains(["CAPTION"],tag)){return}if(goog.array.contains(["NOSCRIPT"],tag)){return}if(goog.array.contains(["SELECT","TABLE","TBODY","TD","TR","TEXTAREA","TFOOT","THEAD","TH"],tag)){return}var input="<"+tag.toLowerCase()+">a<span></span>a</"+tag.toLowerCase()+">";assertAfterInsertionEquals(input,input)})}function testSpanNotCorrectedByBrowsersInner(){if(isIE8()||isIE9()){return}goog.array.forEach(goog.object.getKeys(goog.html.sanitizer.TagWhitelist),function(tag){if(goog.array.contains(["CAPTION","TABLE","TBODY","TD","TR","TEXTAREA","TFOOT","THEAD","TH"],tag)){return}if(goog.array.contains(["COL","COLGROUP"],tag)){return}if("FORM"==tag&&goog.userAgent.WEBKIT){return}var input;if(goog.array.contains(["BR","IMG","AREA","COL","COLGROUP","HR","INPUT","SOURCE","WBR"],tag)){input="<span>a<"+tag.toLowerCase()+">a</span>"}else{input="<span>a<"+tag.toLowerCase()+">a</"+tag.toLowerCase()+">a</span>"}assertAfterInsertionEquals(input,input)})}function testTemplateTagToSpan(){var input="<template alt=\"yes\"><p>q</p></template>",expected="<span alt=\"yes\"><p>q</p></span>";delete goog.html.sanitizer.TagBlacklist.TEMPLATE;assertSanitizedHtml(input,expected);goog.html.sanitizer.TagBlacklist.TEMPLATE=!0}var just=goog.string.Const.from("test");function testTemplateTagWhitelisted(){var input="<div><template alt=\"yes\"><p>q</p></template></div>";delete goog.html.sanitizer.TagBlacklist.TEMPLATE;var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;goog.html.sanitizer.unsafe.alsoAllowTags(just,builder,["TEMPLATE"]);assertSanitizedHtml(input,input,builder.build());goog.html.sanitizer.TagBlacklist.TEMPLATE=!0}function testTemplateTagFake(){var input="<template data-sanitizer-original-tag=\"template\">a</template>",expected="";assertSanitizedHtml(input,expected)}function testTemplateNested(){var input="<template><p>a</p><zzz alt=\"a\"/><script>z</script><template>"+"<p>a</p><zzz alt=\"a\"/><script>z</script></template></template>",expected="<template><p>a</p><span alt=\"a\"></span><template>"+"<p>a</p><span alt=\"a\"></span></template></template>";delete goog.html.sanitizer.TagBlacklist.TEMPLATE;var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;goog.html.sanitizer.unsafe.alsoAllowTags(just,builder,["TEMPLATE"]);assertSanitizedHtml(input,expected,builder.build());goog.html.sanitizer.TagBlacklist.TEMPLATE=!0}function testOnlyAllowEmptyAttrList(){var input="<p alt=\"nope\" aria-checked=\"true\" zzz=\"1\">b</p>"+"<a target=\"_blank\">c</a>",expected="<p>b</p><a>c</a>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([]).build())}function testOnlyAllowUnWhitelistedAttr(){assertThrows(function(){new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes(["alt","zzz"])})}function testOnlyAllowAttributeWildCard(){var input="<div alt=\"yes\" aria-checked=\"true\"><img alt=\"yep\" avbb=\"no\" /></div>",expected="<div alt=\"yes\"><img alt=\"yep\" /></div>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"*",attributeName:"alt"}]).build())}function testOnlyAllowAttributeLabelForA(){var input="<a label=\"3\" aria-checked=\"4\">fff</a><img label=\"3\" />",expected="<a label=\"3\">fff</a><img />";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"*",attributeName:"label",policy:function(value,hints){if("a"!==hints.tagName){return null}return value}}]).build())}function testOnlyAllowAttributePolicy(){var input="<img alt=\"yes\" /><img alt=\"no\" />",expected="<img alt=\"yes\" /><img />";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"*",attributeName:"alt",policy:function(value,hints){assertEquals(hints.attributeName,"alt");return"yes"===value?value:null}}]).build())}function testOnlyAllowAttributePolicyPipe1(){var input="<a target=\"hello\">b</a>",expected="<a target=\"_blank\">b</a>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"a",attributeName:"target",policy:function(value,hints){assertEquals(hints.attributeName,"target");return"_blank"}}]).build())}function testOnlyAllowAttributePolicyPipe2(){var input="<a target=\"hello\">b</a>",expected="<a>b</a>";assertSanitizedHtml(input,expected,new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"a",attributeName:"target",policy:function(value,hints){assertEquals(hints.attributeName,"target");return"nope"}}]).build())}function testOnlyAllowAttributeSpecificPolicyThrows(){assertThrows(function(){new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"img",attributeName:"src",policy:goog.functions.identity}])})}function testOnlyAllowAttributeGenericPolicyThrows(){assertThrows(function(){new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes([{tagName:"*",attributeName:"target",policy:goog.functions.identity}])})}function testOnlyAllowAttributeRefineThrows(){var builder=new goog.html.sanitizer.HtmlSanitizer.Builder().onlyAllowAttributes(["aria-checked",{tagName:"LINK",attributeName:"HREF"}]).onlyAllowAttributes(["aria-checked"]);assertThrows(function(){builder.onlyAllowAttributes(["alt"])})}