goog.provide("goog.labs.net.webChannel.ChannelRequest");goog.require("goog.Timer");goog.require("goog.async.Throttle");goog.require("goog.events.EventHandler");goog.require("goog.labs.net.webChannel.Channel");goog.require("goog.labs.net.webChannel.WebChannelDebug");goog.require("goog.labs.net.webChannel.requestStats");goog.require("goog.labs.net.webChannel.requestStats.ServerReachability");goog.require("goog.labs.net.webChannel.requestStats.Stat");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.net.XmlHttp");goog.require("goog.object");goog.require("goog.userAgent");goog.labs.net.webChannel.ChannelRequest=function(channel,channelDebug,opt_sessionId,opt_requestId,opt_retryId){this.channel_=channel;this.channelDebug_=channelDebug;this.sid_=opt_sessionId;this.rid_=opt_requestId;this.retryId_=opt_retryId||1;this.eventHandler_=new goog.events.EventHandler(this);this.timeout_=goog.labs.net.webChannel.ChannelRequest.TIMEOUT_MS_;this.pollingTimer_=new goog.Timer;this.pollingTimer_.setInterval(goog.labs.net.webChannel.ChannelRequest.POLLING_INTERVAL_MS_);this.extraHeaders_=null;this.successful_=!1;this.watchDogTimerId_=null;this.watchDogTimeoutTime_=null;this.requestStartTime_=null;this.type_=null;this.baseUri_=null;this.requestUri_=null;this.postData_=null;this.xmlHttp_=null;this.xmlHttpChunkStart_=0;this.verb_=null;this.lastError_=null;this.lastStatusCode_=-1;this.sendClose_=!0;this.cancelled_=!1;this.readyStateChangeThrottleMs_=0;this.readyStateChangeThrottle_=null;this.decodeChunks_=!1};goog.scope(function(){var Channel=goog.labs.net.webChannel.Channel,ChannelRequest=goog.labs.net.webChannel.ChannelRequest,requestStats=goog.labs.net.webChannel.requestStats,WebChannelDebug=goog.labs.net.webChannel.WebChannelDebug;ChannelRequest.TIMEOUT_MS_=1e3*45;ChannelRequest.POLLING_INTERVAL_MS_=250;ChannelRequest.Type_={XML_HTTP:1,CLOSE_REQUEST:2};ChannelRequest.Error={STATUS:0,NO_DATA:1,TIMEOUT:2,UNKNOWN_SESSION_ID:3,BAD_DATA:4,HANDLER_EXCEPTION:5,BROWSER_OFFLINE:6};ChannelRequest.errorStringFromCode=function(errorCode,statusCode){switch(errorCode){case ChannelRequest.Error.STATUS:return"Non-200 return code ("+statusCode+")";case ChannelRequest.Error.NO_DATA:return"XMLHTTP failure (no data)";case ChannelRequest.Error.TIMEOUT:return"HttpConnection timeout";default:return"Unknown error";}};ChannelRequest.INVALID_CHUNK_={};ChannelRequest.INCOMPLETE_CHUNK_={};ChannelRequest.supportsXhrStreaming=function(){return!goog.userAgent.IE||goog.userAgent.isDocumentModeOrHigher(10)};ChannelRequest.prototype.setExtraHeaders=function(extraHeaders){this.extraHeaders_=extraHeaders};ChannelRequest.prototype.setTimeout=function(timeout){this.timeout_=timeout};ChannelRequest.prototype.setReadyStateChangeThrottle=function(throttle){this.readyStateChangeThrottleMs_=throttle};ChannelRequest.prototype.xmlHttpPost=function(uri,postData,decodeChunks){this.type_=ChannelRequest.Type_.XML_HTTP;this.baseUri_=uri.clone().makeUnique();this.postData_=postData;this.decodeChunks_=decodeChunks;this.sendXmlHttp_(null)};ChannelRequest.prototype.xmlHttpGet=function(uri,decodeChunks,hostPrefix,opt_noClose){this.type_=ChannelRequest.Type_.XML_HTTP;this.baseUri_=uri.clone().makeUnique();this.postData_=null;this.decodeChunks_=decodeChunks;if(opt_noClose){this.sendClose_=!1}this.sendXmlHttp_(hostPrefix)};ChannelRequest.prototype.sendXmlHttp_=function(hostPrefix){this.requestStartTime_=goog.now();this.ensureWatchDogTimer_();this.requestUri_=this.baseUri_.clone();this.requestUri_.setParameterValues("t",this.retryId_);this.xmlHttpChunkStart_=0;var useSecondaryDomains=this.channel_.shouldUseSecondaryDomains();this.xmlHttp_=this.channel_.createXhrIo(useSecondaryDomains?hostPrefix:null);if(0<this.readyStateChangeThrottleMs_){this.readyStateChangeThrottle_=new goog.async.Throttle(goog.bind(this.xmlHttpHandler_,this,this.xmlHttp_),this.readyStateChangeThrottleMs_)}this.eventHandler_.listen(this.xmlHttp_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_);var headers=this.extraHeaders_?goog.object.clone(this.extraHeaders_):{};if(this.postData_){this.verb_="POST";headers["Content-Type"]="application/x-www-form-urlencoded";this.xmlHttp_.send(this.requestUri_,this.verb_,this.postData_,headers)}else{this.verb_="GET";if(this.sendClose_&&!goog.userAgent.WEBKIT){headers.Connection="close"}this.xmlHttp_.send(this.requestUri_,this.verb_,null,headers)}requestStats.notifyServerReachabilityEvent(requestStats.ServerReachability.REQUEST_MADE);this.channelDebug_.xmlHttpChannelRequest(this.verb_,this.requestUri_,this.rid_,this.retryId_,this.postData_)};ChannelRequest.prototype.readyStateChangeHandler_=function(evt){var xhr=evt.target,throttle=this.readyStateChangeThrottle_;if(throttle&&xhr.getReadyState()==goog.net.XmlHttp.ReadyState.INTERACTIVE){this.channelDebug_.debug("Throttling readystatechange.");throttle.fire()}else{this.xmlHttpHandler_(xhr)}};ChannelRequest.prototype.xmlHttpHandler_=function(xmlhttp){requestStats.onStartExecution();try{if(xmlhttp==this.xmlHttp_){this.onXmlHttpReadyStateChanged_()}else{this.channelDebug_.warning("Called back with an "+"unexpected xmlhttp")}}catch(ex){this.channelDebug_.debug("Failed call to OnXmlHttpReadyStateChanged_");if(this.xmlHttp_&&this.xmlHttp_.getResponseText()){this.channelDebug_.dumpException(ex,"ResponseText: "+this.xmlHttp_.getResponseText())}else{this.channelDebug_.dumpException(ex,"No response text")}}finally{requestStats.onEndExecution()}};ChannelRequest.prototype.onXmlHttpReadyStateChanged_=function(){var readyState=this.xmlHttp_.getReadyState(),errorCode=this.xmlHttp_.getLastErrorCode(),statusCode=this.xmlHttp_.getStatus();if(readyState<goog.net.XmlHttp.ReadyState.INTERACTIVE||readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!goog.userAgent.OPERA&&!this.xmlHttp_.getResponseText()){return}if(!this.cancelled_&&readyState==goog.net.XmlHttp.ReadyState.COMPLETE&&errorCode!=goog.net.ErrorCode.ABORT){if(errorCode==goog.net.ErrorCode.TIMEOUT||0>=statusCode){requestStats.notifyServerReachabilityEvent(requestStats.ServerReachability.REQUEST_FAILED)}else{requestStats.notifyServerReachabilityEvent(requestStats.ServerReachability.REQUEST_SUCCEEDED)}}this.cancelWatchDogTimer_();var status=this.xmlHttp_.getStatus();this.lastStatusCode_=status;var responseText=this.xmlHttp_.getResponseText();if(!responseText){this.channelDebug_.debug("No response text for uri "+this.requestUri_+" status "+status)}this.successful_=200==status;this.channelDebug_.xmlHttpChannelResponseMetaData(this.verb_,this.requestUri_,this.rid_,this.retryId_,readyState,status);if(!this.successful_){if(400==status&&0<responseText.indexOf("Unknown SID")){this.lastError_=ChannelRequest.Error.UNKNOWN_SESSION_ID;requestStats.notifyStatEvent(requestStats.Stat.REQUEST_UNKNOWN_SESSION_ID);this.channelDebug_.warning("XMLHTTP Unknown SID ("+this.rid_+")")}else{this.lastError_=ChannelRequest.Error.STATUS;requestStats.notifyStatEvent(requestStats.Stat.REQUEST_BAD_STATUS);this.channelDebug_.warning("XMLHTTP Bad status "+status+" ("+this.rid_+")")}this.cleanup_();this.dispatchFailure_();return}if(this.decodeChunks_){this.decodeNextChunks_(readyState,responseText);if(goog.userAgent.OPERA&&this.successful_&&readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE){this.startPolling_()}}else{this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,null);this.safeOnRequestData_(responseText)}if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.cleanup_()}if(!this.successful_){return}if(!this.cancelled_){if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.channel_.onRequestComplete(this)}else{this.successful_=!1;this.ensureWatchDogTimer_()}}};ChannelRequest.prototype.decodeNextChunks_=function(readyState,responseText){var decodeNextChunksSuccessful=!0;while(!this.cancelled_&&this.xmlHttpChunkStart_<responseText.length){var chunkText=this.getNextChunk_(responseText);if(chunkText==ChannelRequest.INCOMPLETE_CHUNK_){if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.lastError_=ChannelRequest.Error.BAD_DATA;requestStats.notifyStatEvent(requestStats.Stat.REQUEST_INCOMPLETE_DATA);decodeNextChunksSuccessful=!1}this.channelDebug_.xmlHttpChannelResponseText(this.rid_,null,"[Incomplete Response]");break}else if(chunkText==ChannelRequest.INVALID_CHUNK_){this.lastError_=ChannelRequest.Error.BAD_DATA;requestStats.notifyStatEvent(requestStats.Stat.REQUEST_BAD_DATA);this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,"[Invalid Chunk]");decodeNextChunksSuccessful=!1;break}else{this.channelDebug_.xmlHttpChannelResponseText(this.rid_,chunkText,null);this.safeOnRequestData_(chunkText)}}if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE&&0==responseText.length){this.lastError_=ChannelRequest.Error.NO_DATA;requestStats.notifyStatEvent(requestStats.Stat.REQUEST_NO_DATA);decodeNextChunksSuccessful=!1}this.successful_=this.successful_&&decodeNextChunksSuccessful;if(!decodeNextChunksSuccessful){this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,"[Invalid Chunked Response]");this.cleanup_();this.dispatchFailure_()}};ChannelRequest.prototype.pollResponse_=function(){var readyState=this.xmlHttp_.getReadyState(),responseText=this.xmlHttp_.getResponseText();if(this.xmlHttpChunkStart_<responseText.length){this.cancelWatchDogTimer_();this.decodeNextChunks_(readyState,responseText);if(this.successful_&&readyState!=goog.net.XmlHttp.ReadyState.COMPLETE){this.ensureWatchDogTimer_()}}};ChannelRequest.prototype.startPolling_=function(){this.eventHandler_.listen(this.pollingTimer_,goog.Timer.TICK,this.pollResponse_);this.pollingTimer_.start()};ChannelRequest.prototype.getNextChunk_=function(responseText){var sizeStartIndex=this.xmlHttpChunkStart_,sizeEndIndex=responseText.indexOf("\n",sizeStartIndex);if(-1==sizeEndIndex){return ChannelRequest.INCOMPLETE_CHUNK_}var sizeAsString=responseText.substring(sizeStartIndex,sizeEndIndex),size=+sizeAsString;if(isNaN(size)){return ChannelRequest.INVALID_CHUNK_}var chunkStartIndex=sizeEndIndex+1;if(chunkStartIndex+size>responseText.length){return ChannelRequest.INCOMPLETE_CHUNK_}var chunkText=responseText.substr(chunkStartIndex,size);this.xmlHttpChunkStart_=chunkStartIndex+size;return chunkText};ChannelRequest.prototype.sendCloseRequest=function(uri){this.type_=ChannelRequest.Type_.CLOSE_REQUEST;this.baseUri_=uri.clone().makeUnique();var requestSent=!1;if(goog.global.navigator&&goog.global.navigator.sendBeacon){requestSent=goog.global.navigator.sendBeacon(this.baseUri_.toString(),"")}if(!requestSent){var eltImg=new Image;eltImg.src=this.baseUri_}this.requestStartTime_=goog.now();this.ensureWatchDogTimer_()};ChannelRequest.prototype.cancel=function(){this.cancelled_=!0;this.cleanup_()};ChannelRequest.prototype.ensureWatchDogTimer_=function(){this.watchDogTimeoutTime_=goog.now()+this.timeout_;this.startWatchDogTimer_(this.timeout_)};ChannelRequest.prototype.startWatchDogTimer_=function(time){if(null!=this.watchDogTimerId_){throw Error("WatchDog timer not null")}this.watchDogTimerId_=requestStats.setTimeout(goog.bind(this.onWatchDogTimeout_,this),time)};ChannelRequest.prototype.cancelWatchDogTimer_=function(){if(this.watchDogTimerId_){goog.global.clearTimeout(this.watchDogTimerId_);this.watchDogTimerId_=null}};ChannelRequest.prototype.onWatchDogTimeout_=function(){this.watchDogTimerId_=null;var now=goog.now();if(0<=now-this.watchDogTimeoutTime_){this.handleTimeout_()}else{this.channelDebug_.warning("WatchDog timer called too early");this.startWatchDogTimer_(this.watchDogTimeoutTime_-now)}};ChannelRequest.prototype.handleTimeout_=function(){if(this.successful_){this.channelDebug_.severe("Received watchdog timeout even though request loaded successfully")}this.channelDebug_.timeoutResponse(this.requestUri_);if(this.type_!=ChannelRequest.Type_.CLOSE_REQUEST){requestStats.notifyServerReachabilityEvent(requestStats.ServerReachability.REQUEST_FAILED);requestStats.notifyStatEvent(requestStats.Stat.REQUEST_TIMEOUT)}this.cleanup_();this.lastError_=ChannelRequest.Error.TIMEOUT;this.dispatchFailure_()};ChannelRequest.prototype.dispatchFailure_=function(){if(this.channel_.isClosed()||this.cancelled_){return}this.channel_.onRequestComplete(this)};ChannelRequest.prototype.cleanup_=function(){this.cancelWatchDogTimer_();goog.dispose(this.readyStateChangeThrottle_);this.readyStateChangeThrottle_=null;this.pollingTimer_.stop();this.eventHandler_.removeAll();if(this.xmlHttp_){var xmlhttp=this.xmlHttp_;this.xmlHttp_=null;xmlhttp.abort();xmlhttp.dispose()}};ChannelRequest.prototype.getSuccess=function(){return this.successful_};ChannelRequest.prototype.getLastError=function(){return this.lastError_};ChannelRequest.prototype.getLastStatusCode=function(){return this.lastStatusCode_};ChannelRequest.prototype.getSessionId=function(){return this.sid_};ChannelRequest.prototype.getRequestId=function(){return this.rid_};ChannelRequest.prototype.getPostData=function(){return this.postData_};ChannelRequest.prototype.getXhr=function(){return this.xmlHttp_};ChannelRequest.prototype.getRequestStartTime=function(){return this.requestStartTime_};ChannelRequest.prototype.safeOnRequestData_=function(data){try{this.channel_.onRequestData(this,data);var stats=requestStats.ServerReachability;requestStats.notifyServerReachabilityEvent(stats.BACK_CHANNEL_ACTIVITY)}catch(e){this.channelDebug_.dumpException(e,"Error in httprequest callback")}};ChannelRequest.createChannelRequest=function(channel,channelDebug,opt_sessionId,opt_requestId,opt_retryId){return new ChannelRequest(channel,channelDebug,opt_sessionId,opt_requestId,opt_retryId)}});