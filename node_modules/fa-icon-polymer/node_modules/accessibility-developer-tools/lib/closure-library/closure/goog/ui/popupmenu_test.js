goog.provide("goog.ui.PopupMenuTest");goog.setTestOnly("goog.ui.PopupMenuTest");goog.require("goog.dom");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.math.Box");goog.require("goog.math.Coordinate");goog.require("goog.positioning.Corner");goog.require("goog.style");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.ui.Menu");goog.require("goog.ui.MenuItem");goog.require("goog.ui.PopupMenu");var anchor,menu,menuitem,handler,showPopup,beforeShowPopupCalled,popup;function setUp(){anchor=goog.dom.getElement("popup-anchor");menu=goog.dom.getElement("menu");menuitem1=goog.dom.getElement("menuitem_1");menuitem3=goog.dom.getElement("menuitem_3");handler=new goog.events.EventHandler;popup=new goog.ui.PopupMenu}function tearDown(){handler.dispose();popup.dispose()}function assertTarget(target,expectedElement,expectedTargetCorner,expectedMenuCorner,expectedEventType,expectedMargin){var expectedTarget={element_:expectedElement,targetCorner_:expectedTargetCorner,menuCorner_:expectedMenuCorner,eventType_:expectedEventType,margin_:expectedMargin};assertObjectEquals("Target does not match.",expectedTarget,target)}function testBeforeShowEvent(){popup.render();var target=popup.createAttachTarget(anchor);popup.attach(anchor);function beforeShowPopup(e){assertFalse("The element should not be shown when BEFORE_SHOW event is "+"being handled",goog.style.isElementShown(popup.getElement()));assertNotNullNorUndefined(popup.getAttachedElement());assertEquals("The attached anchor element is incorrect",target.element_,popup.getAttachedElement());beforeShowPopupCalled=!0;return showPopup};function onShowPopup(e){assertEquals("The attached anchor element is incorrect",target.element_,popup.getAttachedElement())};handler.listen(popup,goog.ui.Menu.EventType.BEFORE_SHOW,beforeShowPopup);handler.listen(popup,goog.ui.Menu.EventType.SHOW,onShowPopup);beforeShowPopupCalled=!1;showPopup=!1;popup.showMenu(target,0,0);assertTrue("BEFORE_SHOW event handler should be called on #showMenu",beforeShowPopupCalled);assertFalse("The element should not be shown when BEFORE_SHOW handler "+"returned false",goog.style.isElementShown(popup.getElement()));beforeShowPopupCalled=!1;showPopup=!0;popup.showMenu(target,0,0);assertTrue("The element should be shown when BEFORE_SHOW handler "+"returned true",goog.style.isElementShown(popup.getElement()))}function testIsAttachTarget(){popup.render();assertFalse("Menu should not be attached to the element",popup.isAttachTarget(anchor));popup.attach(anchor);assertTrue("Menu should be attached to the anchor",popup.isAttachTarget(anchor));popup.detach(anchor);assertFalse("Menu is expected to be detached from the element",popup.isAttachTarget(anchor))}function testCreateAttachTarget(){var targetCorner=goog.positioning.Corner.TOP_END,menuCorner=goog.positioning.Corner.BOTTOM_LEFT,contextMenu=!1,margin=new goog.math.Box(0,10,5,25),target=popup.createAttachTarget(anchor);assertTrue(popup.isAttachTarget(anchor));assertTarget(target,anchor,void 0,void 0,goog.events.EventType.MOUSEDOWN,void 0);target=popup.createAttachTarget(anchor,targetCorner,menuCorner,contextMenu,margin);assertTrue(popup.isAttachTarget(anchor));assertTarget(target,anchor,targetCorner,menuCorner,goog.events.EventType.MOUSEDOWN,margin);target=popup.createAttachTarget(anchor,void 0,void 0,!0,void 0);assertTarget(target,anchor,void 0,void 0,goog.events.EventType.CONTEXTMENU,void 0)}function testGetAttachTarget(){popup.render();var target=popup.getAttachTarget(anchor);assertTrue("Not expecting a target before the element is attach to the menu",null==target);var targetCorner=goog.positioning.Corner.TOP_END,menuCorner=goog.positioning.Corner.BOTTOM_LEFT,contextMenu=!1,margin=new goog.math.Box(0,10,5,25);popup.attach(anchor,targetCorner,menuCorner,contextMenu,margin);target=popup.getAttachTarget(anchor);assertTrue("Failed to get target after attaching element to menu",null!=target);assertTarget(target,anchor,targetCorner,menuCorner,goog.events.EventType.MOUSEDOWN,margin)}function testSmallViewportSliding(){var _Mathfloor=Math.floor;popup.render();popup.getElement().style.position="absolute";popup.getElement().style.outline="1px solid blue";var item=new goog.ui.MenuItem("Test Item");popup.addChild(item,!0);item.getElement().style.overflow="hidden";var viewport=goog.style.getClientViewportElement(),viewportRect=goog.style.getVisibleRectForElement(viewport),middlePos=_Mathfloor((viewportRect.right-viewportRect.left)/2),leftwardPos=_Mathfloor((viewportRect.right-viewportRect.left)/3),rightwardPos=_Mathfloor(2*((viewportRect.right-viewportRect.left)/3)),smallWidth=leftwardPos,mediumWidth=middlePos,largeWidth=rightwardPos;popup.getElement().style.width=smallWidth+"px";var target=popup.createAttachTarget(anchor);popup.attach(anchor);popup.showMenu(target,leftwardPos,0);assertObjectEquals("Popup in wrong position: small size, leftward pos",new goog.math.Coordinate(leftwardPos,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,middlePos,0);assertObjectEquals("Popup in wrong position: small size, middle pos",new goog.math.Coordinate(middlePos,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,rightwardPos,0);assertObjectEquals("Popup in wrong position: small size, rightward pos",new goog.math.Coordinate(rightwardPos,0),goog.style.getPosition(popup.getElement()));popup.getElement().style.width=mediumWidth+"px";popup.showMenu(target,leftwardPos,0);assertObjectEquals("Popup in wrong position: medium size, leftward pos",new goog.math.Coordinate(leftwardPos,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,middlePos,0);assertObjectEquals("Popup in wrong position: medium size, middle pos",new goog.math.Coordinate(middlePos,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,rightwardPos,0);assertObjectEquals("Popup in wrong position: medium size, rightward pos",new goog.math.Coordinate(rightwardPos-mediumWidth,0),goog.style.getPosition(popup.getElement()));popup.getElement().style.width=largeWidth+"px";popup.showMenu(target,leftwardPos,0);assertObjectEquals("Popup in wrong position: large size, leftward pos",new goog.math.Coordinate(leftwardPos,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,middlePos,0);assertObjectEquals("Popup in wrong position: large size, middle pos",new goog.math.Coordinate(viewportRect.right-viewportRect.left-largeWidth,0),goog.style.getPosition(popup.getElement()));popup.showMenu(target,rightwardPos,0);assertObjectEquals("Popup in wrong position: large size, rightward pos",new goog.math.Coordinate(rightwardPos-largeWidth,0),goog.style.getPosition(popup.getElement()));popup.detach(anchor);anchor.style.position="absolute";anchor.style.left="24px";anchor.style.top="24px";var targetCorner=goog.positioning.Corner.TOP_END;target=popup.createAttachTarget(anchor,targetCorner);popup.attach(anchor,targetCorner);popup.getElement().style.width=smallWidth+"px";popup.showMenu(target,leftwardPos,0);assertObjectEquals("Popup in wrong position: small size, leftward pos, with target corner",new goog.math.Coordinate(24,24),goog.style.getPosition(popup.getElement()))}function testKeyboardEventsShowMenu(){popup.decorate(menu);popup.attach(anchor);popup.hide();assertFalse(popup.isVisible());goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.SPACE);assertTrue(popup.isVisible());assertEquals(-1,popup.getHighlightedIndex());popup.hide();assertFalse(popup.isVisible());goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.ENTER);assertTrue(popup.isVisible());assertEquals(-1,popup.getHighlightedIndex())}function testDownKey(){popup.decorate(menu);popup.attach(anchor);popup.hide();assertFalse(popup.isVisible());goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);assertTrue(popup.isVisible());assertEquals(0,popup.getHighlightedIndex())}function testMenuItemKeyboardActivation(){popup.decorate(menu);popup.attach(anchor);goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.ESC);assertEquals(anchor,document.activeElement);var menuitemListenerFired=!1;function onMenuitemAction(event){if(event.keyCode==goog.events.KeyCodes.SPACE||event.keyCode==goog.events.KeyCodes.ENTER){menuitemListenerFired=!0}};handler.listen(menuitem1,goog.events.EventType.KEYDOWN,onMenuitemAction);goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.SPACE);assertTrue(menuitemListenerFired);menuitemListenerFired=!1;goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.ENTER);assertTrue(menuitemListenerFired);menuitemListenerFired=!1;goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.SHIFT);assertFalse(menuitemListenerFired);menuitemListenerFired=!1;handler.listen(menuitem3,goog.events.EventType.KEYDOWN,onMenuitemAction);goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.DOWN);goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.SPACE);assertTrue(menuitemListenerFired)}function testContextMenuKeyboard(){popup.attach(anchor,null,null,!0);popup.hide();assertFalse(popup.isVisible());goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.SPACE);assertFalse(popup.isVisible());goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.ENTER);assertFalse(popup.isVisible())}function testKeyPressWithNoHighlightedItem(){popup.decorate(menu);popup.attach(anchor);goog.testing.events.fireKeySequence(anchor,goog.events.KeyCodes.SPACE);assertTrue(popup.isVisible());try{goog.testing.events.fireKeySequence(menu,goog.events.KeyCodes.SPACE)}catch(e){fail("Crash attempting to reference null selected menu item after "+"keyboard event.")}}