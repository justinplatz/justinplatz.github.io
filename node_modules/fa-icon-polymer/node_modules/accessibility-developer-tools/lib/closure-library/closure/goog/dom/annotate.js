goog.provide("goog.dom.annotate");goog.provide("goog.dom.annotate.AnnotateFn");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.TagName");goog.require("goog.dom.safe");goog.require("goog.html.SafeHtml");goog.require("goog.object");goog.dom.annotate.AnnotateFn;goog.dom.annotate.annotateTerms=function(node,terms,annotateFn,opt_ignoreCase,opt_classesToSkip,opt_maxMs){if(opt_ignoreCase){terms=goog.dom.annotate.lowercaseTerms_(terms)}var stopTime=0<opt_maxMs?goog.now()+opt_maxMs:0;return goog.dom.annotate.annotateTermsInNode_(node,terms,annotateFn,opt_ignoreCase,opt_classesToSkip||[],stopTime,0)};goog.dom.annotate.MAX_RECURSION_=200;goog.dom.annotate.NODES_TO_SKIP_=goog.object.createSet(goog.dom.TagName.SCRIPT,goog.dom.TagName.STYLE,goog.dom.TagName.TEXTAREA);goog.dom.annotate.annotateTermsInNode_=function(node,terms,annotateFn,ignoreCase,classesToSkip,stopTime,recursionLevel){if(0<stopTime&&goog.now()>=stopTime||recursionLevel>goog.dom.annotate.MAX_RECURSION_){return!1}var annotated=!1;if(node.nodeType==goog.dom.NodeType.TEXT){var html=goog.dom.annotate.helpAnnotateText_(node.nodeValue,terms,annotateFn,ignoreCase);if(null!=html){var tempNode=goog.dom.getDomHelper(node).createElement(goog.dom.TagName.SPAN);goog.dom.safe.setInnerHtml(tempNode,html);var parentNode=node.parentNode,nodeToInsert;while(null!=(nodeToInsert=tempNode.firstChild)){parentNode.insertBefore(nodeToInsert,node)}parentNode.removeChild(node);annotated=!0}}else if(node.hasChildNodes()&&!goog.dom.annotate.NODES_TO_SKIP_[node.tagName]){var classes=node.className.split(/\s+/),skip=goog.array.some(classes,function(className){return goog.array.contains(classesToSkip,className)});if(!skip){++recursionLevel;var curNode=node.firstChild;while(curNode){var nextNode=curNode.nextSibling,curNodeAnnotated=goog.dom.annotate.annotateTermsInNode_(curNode,terms,annotateFn,ignoreCase,classesToSkip,stopTime,recursionLevel);annotated=annotated||curNodeAnnotated;curNode=nextNode}}}return annotated};goog.dom.annotate.NONWORD_RE_=/\W/;goog.dom.annotate.annotateText=function(text,terms,annotateFn,opt_ignoreCase){if(opt_ignoreCase){terms=goog.dom.annotate.lowercaseTerms_(terms)}return goog.dom.annotate.helpAnnotateText_(text,terms,annotateFn,opt_ignoreCase)};goog.dom.annotate.helpAnnotateText_=function(text,terms,annotateFn,ignoreCase){for(var hit=!1,textToSearch=ignoreCase?text.toLowerCase():text,textLen=textToSearch.length,numTerms=terms.length,termHits=Array(numTerms),i=0;i<numTerms;i++){var term=terms[i],hits=[],termText=term[0];if(""!=termText){var matchWholeWordOnly=term[1],termLen=termText.length,pos=0;while(pos<textLen){var hitPos=textToSearch.indexOf(termText,pos);if(-1==hitPos){break}else{var prevCharPos=hitPos-1,nextCharPos=hitPos+termLen;if(!matchWholeWordOnly||(0>prevCharPos||goog.dom.annotate.NONWORD_RE_.test(textToSearch.charAt(prevCharPos)))&&(nextCharPos>=textLen||goog.dom.annotate.NONWORD_RE_.test(textToSearch.charAt(nextCharPos)))){hits.push(hitPos);hit=!0}pos=hitPos+termLen}}}termHits[i]=hits}if(hit){var html=[],pos=0;while(!0){for(var termIndexOfNextHit,posOfNextHit=-1,i=0,hits;i<numTerms;i++){hits=termHits[i];if(!goog.array.isEmpty(hits)){var hitPos=hits[0];while(0<=hitPos&&hitPos<pos){hits.shift();hitPos=goog.array.isEmpty(hits)?-1:hits[0]}if(0<=hitPos&&(0>posOfNextHit||hitPos<posOfNextHit)){termIndexOfNextHit=i;posOfNextHit=hitPos}}}if(0>posOfNextHit)break;goog.asserts.assertNumber(termIndexOfNextHit);termHits[termIndexOfNextHit].shift();html.push(text.substr(pos,posOfNextHit-pos));var termLen=terms[termIndexOfNextHit][0].length,termHtml=goog.html.SafeHtml.htmlEscape(text.substr(posOfNextHit,termLen));html.push(annotateFn(goog.asserts.assertNumber(termIndexOfNextHit),termHtml));pos=posOfNextHit+termLen}html.push(text.substr(pos));return goog.html.SafeHtml.concat(html)}else{return null}};goog.dom.annotate.lowercaseTerms_=function(terms){for(var lowercaseTerms=[],i=0,term;i<terms.length;++i){term=terms[i];lowercaseTerms[i]=[term[0].toLowerCase(),term[1]]}return lowercaseTerms};