goog.provide("goog.dom.SavedCaretRangeTest");goog.setTestOnly("goog.dom.SavedCaretRangeTest");goog.require("goog.dom");goog.require("goog.dom.Range");goog.require("goog.dom.SavedCaretRange");goog.require("goog.testing.dom");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function setUp(){document.body.normalize()}function testSavedCaretRangeDoesntChangeSelection(){var div=goog.dom.getElement("bug1480638"),range=goog.dom.Range.createFromNodes(div.firstChild,0,div.lastChild,1);range.select();var saved=range.saveUsingCarets()}function testSavedCaretRange(){if(goog.userAgent.IE&&!goog.userAgent.isDocumentModeOrHigher(8)){return}var parent=goog.dom.getElement("caretRangeTest"),def=goog.dom.getElement("def"),jkl=goog.dom.getElement("jkl"),range=goog.dom.Range.createFromNodes(def.firstChild,1,jkl.firstChild,2);assertFalse(range.isReversed());range.select();var saved=range.saveUsingCarets();assertHTMLEquals("d<span id=\""+saved.startCaretId_+"\"></span>ef",def.innerHTML);assertHTMLEquals("jk<span id=\""+saved.endCaretId_+"\"></span>l",jkl.innerHTML);goog.testing.dom.assertRangeEquals(def.childNodes[1],0,jkl.childNodes[1],0,saved.toAbstractRange());def=goog.dom.getElement("def");jkl=goog.dom.getElement("jkl");var restoredRange=clearSelectionAndRestoreSaved(parent,saved);assertFalse(restoredRange.isReversed());goog.testing.dom.assertRangeEquals(def,1,jkl,1,restoredRange);var selection=goog.dom.Range.createFromWindow(window);assertHTMLEquals("def",def.innerHTML);assertHTMLEquals("jkl",jkl.innerHTML);if(goog.userAgent.WEBKIT||goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("9")){goog.testing.dom.assertRangeEquals(def.childNodes[1],0,jkl.childNodes[0],2,selection)}else if(goog.userAgent.OPERA){goog.testing.dom.assertRangeEquals(def.childNodes[1],0,jkl.childNodes[1],0,selection)}else{goog.testing.dom.assertRangeEquals(def,1,jkl,1,selection)}}function testReversedSavedCaretRange(){var parent=goog.dom.getElement("caretRangeTest"),def=goog.dom.getElement("def-5"),jkl=goog.dom.getElement("jkl-5"),range=goog.dom.Range.createFromNodes(jkl.firstChild,1,def.firstChild,2);assertTrue(range.isReversed());range.select();var saved=range.saveUsingCarets(),restoredRange=clearSelectionAndRestoreSaved(parent,saved);assertTrue(restoredRange.isReversed());goog.testing.dom.assertRangeEquals(def,1,jkl,1,restoredRange)}function testRemoveContents(){var def=goog.dom.getElement("def-4"),jkl=goog.dom.getElement("jkl-4"),container=goog.dom.getElement("removeContentsTest");assertEquals(7,container.childNodes.length);assertEquals("def",def.innerHTML);assertEquals("jkl",jkl.innerHTML);var range=goog.dom.Range.createFromNodes(def.firstChild,1,jkl.firstChild,2);range.select();var saved=range.saveUsingCarets(),restored=saved.restore();restored.removeContents();assertEquals(6,container.childNodes.length);assertEquals("d",def.innerHTML);assertEquals("l",jkl.innerHTML)}function testHtmlEqual(){var parent=goog.dom.getElement("caretRangeTest-2"),def=goog.dom.getElement("def-2"),jkl=goog.dom.getElement("jkl-2"),range=goog.dom.Range.createFromNodes(def.firstChild,1,jkl.firstChild,2);range.select();var saved=range.saveUsingCarets(),html1=parent.innerHTML;saved.removeCarets();var saved2=range.saveUsingCarets(),html2=parent.innerHTML;saved2.removeCarets();assertNotEquals("Same selection with different saved caret range carets "+"must have different html.",html1,html2);assertTrue("Same selection with different saved caret range carets must "+"be considered equal by htmlEqual",goog.dom.SavedCaretRange.htmlEqual(html1,html2));saved.dispose();saved2.dispose()}function testStartCaretIsAtEndOfParent(){var parent=goog.dom.getElement("caretRangeTest-3"),def=goog.dom.getElement("def-3"),jkl=goog.dom.getElement("jkl-3"),range=goog.dom.Range.createFromNodes(def,1,jkl,1);range.select();var saved=range.saveUsingCarets();clearSelectionAndRestoreSaved(parent,saved);range=goog.dom.Range.createFromWindow();assertEquals("ghijkl",range.getText().replace(/\s/g,""))}function clearSelectionAndRestoreSaved(parent,saved){goog.dom.Range.clearSelection();assertFalse(goog.dom.Range.hasSelection(window));var range=saved.restore();assertTrue(goog.dom.Range.hasSelection(window));return range}