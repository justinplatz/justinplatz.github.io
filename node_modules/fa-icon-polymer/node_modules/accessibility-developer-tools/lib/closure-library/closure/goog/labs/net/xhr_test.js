goog.provide("goog.labs.net.xhrTest");goog.setTestOnly("goog.labs.net.xhrTest");goog.require("goog.Promise");goog.require("goog.events");goog.require("goog.events.EventType");goog.require("goog.labs.net.xhr");goog.require("goog.net.WrapperXmlHttpFactory");goog.require("goog.net.XmlHttp");goog.require("goog.testing.MockClock");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var TEST_IMAGE="testdata/cleardot.gif",TEST_IMAGE_BYTES=[71,73,70,56,57,97,1,0,1,0,128,255,0,192,192,192,0,0,0,33,249,4,1,0,0,0,0,44,0,0,0,0,1,0,1,0,0,2,2,68,1,0,59];function setUpPage(){goog.testing.TestCase.getActiveTestCase().promiseTimeout=1e4}function stubXhrToReturn(status,opt_responseText,opt_latency){if(goog.isDefAndNotNull(opt_latency)){mockClock=new goog.testing.MockClock(!0)}var stubXhr={sent:!1,aborted:!1,status:0,headers:{},open:function(method,url,async){this.method=method;this.url=url;this.async=async},setRequestHeader:function(key,value){this.headers[key]=value},overrideMimeType:function(mimeType){this.mimeType=mimeType},abort:function(){this.aborted=!0;this.load(0)},send:function(data){this.data=data;this.sent=!0;window.setTimeout(goog.bind(this.load,this,status),opt_latency||0);if(mockClock){mockClock.tick(opt_latency)}},load:function(status){this.status=status;if(goog.isDefAndNotNull(opt_responseText)){this.responseText=opt_responseText}this.readyState=4;if(this.onreadystatechange)this.onreadystatechange()}};stubXmlHttpWith(stubXhr)}function stubXhrToThrow(err){stubXmlHttpWith(buildThrowingStubXhr(err))}function buildThrowingStubXhr(err){return{sent:!1,aborted:!1,status:0,headers:{},open:function(method,url,async){this.method=method;this.url=url;this.async=async},setRequestHeader:function(key,value){this.headers[key]=value},overrideMimeType:function(mimeType){this.mimeType=mimeType},send:function(data){throw err}}}function stubXmlHttpWith(stubXhr){goog.net.XmlHttp=function(){return stubXhr};for(var x in originalXmlHttp){goog.net.XmlHttp[x]=originalXmlHttp[x]}}var xhr=goog.labs.net.xhr,originalXmlHttp=goog.net.XmlHttp,mockClock;function tearDown(){if(mockClock){mockClock.dispose();mockClock=null}goog.net.XmlHttp=originalXmlHttp}function isRunningLocally(){if("file:"==window.location.protocol){var testCase=goog.global.G_testRunner.testCase;testCase.saveMessage("Test skipped while running on local file system.");return!0}return!1}function testSimpleRequest(){if(isRunningLocally())return;return xhr.send("GET","testdata/xhr_test_text.data").then(function(xhr){assertEquals("Just some data.",xhr.responseText);assertEquals(200,xhr.status)})}function testGetText(){if(isRunningLocally())return;return xhr.get("testdata/xhr_test_text.data").then(function(responseText){assertEquals("Just some data.",responseText)})}function testGetTextWithJson(){if(isRunningLocally())return;return xhr.get("testdata/xhr_test_json.data").then(function(responseText){assertEquals("while(1);\n{\"stat\":\"ok\",\"count\":12345}\n",responseText)})}function testPostText(){if(isRunningLocally())return;return xhr.post("testdata/xhr_test_text.data","post-data").then(function(responseText){assertEquals("Just some data.",responseText)})}function testGetJson(){if(isRunningLocally())return;return xhr.getJson("testdata/xhr_test_json.data",{xssiPrefix:"while(1);\n"}).then(function(responseObj){assertEquals("ok",responseObj.stat);assertEquals(12345,responseObj.count)})}function testGetBlob(){if(isRunningLocally())return;if(!("Blob"in goog.global)){var err=assertThrows(function(){xhr.getBlob(TEST_IMAGE)});assertEquals("Assertion failed: getBlob is not supported in this browser.",err.message);return}var options={withCredentials:!0};return xhr.getBlob(TEST_IMAGE,options).then(function(blob){var reader=new FileReader;return new goog.Promise(function(resolve,reject){goog.events.listenOnce(reader,goog.events.EventType.LOAD,resolve);reader.readAsArrayBuffer(blob)})}).then(function(e){assertElementsEquals(TEST_IMAGE_BYTES,new Uint8Array(e.target.result));assertObjectEquals("input options should not have mutated.",{withCredentials:!0},options)})}function testGetBytes(){if(isRunningLocally())return;if(goog.userAgent.IE&&!goog.userAgent.isDocumentMode(9)){var err=assertThrows(function(){xhr.getBytes(TEST_IMAGE)});assertEquals("Assertion failed: getBytes is not supported in this browser.",err.message);return}var options={withCredentials:!0};return xhr.getBytes(TEST_IMAGE).then(function(bytes){assertElementsEquals(TEST_IMAGE_BYTES,bytes);assertObjectEquals("input options should not have mutated.",{withCredentials:!0},options)})}function testSerialRequests(){if(isRunningLocally())return;return xhr.get("testdata/xhr_test_text.data").then(function(response){return xhr.getJson("testdata/xhr_test_json.data",{xssiPrefix:"while(1);\n"})}).then(function(responseObj){assertEquals("ok",responseObj.stat);assertEquals(12345,responseObj.count)})}function testBadUrlDetectedAsError(){if(isRunningLocally())return;return xhr.getJson("unknown-file.dat").then(fail,function(err){assertTrue("Error should be an HTTP error",err instanceof xhr.HttpError);assertEquals(404,err.status);assertNotNull(err.xhr)})}function testBadOriginTriggersOnErrorHandler(){return xhr.get("http://www.google.com").then(function(){fail("XHR to http://www.google.com should've failed due to "+"same-origin policy.")},function(err){assertTrue("Error should be an xhr error",err instanceof xhr.Error);assertNotNull(err.xhr)})}function testSendNoOptions(){var called=!1;stubXhrToReturn(200);assertFalse("Callback should not yet have been called",called);return xhr.send("GET","test-url",null).then(function(stubXhr){called=!0;assertEquals("GET",stubXhr.method);assertEquals("test-url",stubXhr.url)})}function testSendPostSetsDefaultHeader(){stubXhrToReturn(200);return xhr.send("POST","test-url",null).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals("application/x-www-form-urlencoded;charset=utf-8",stubXhr.headers["Content-Type"])})}function testSendPostDoesntSetHeaderWithFormData(){if(!goog.global.FormData){return}var formData=new goog.global.FormData;formData.append("name","value");stubXhrToReturn(200);return xhr.send("POST","test-url",formData).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals(void 0,stubXhr.headers["Content-Type"])})}function testSendPostHeaders(){stubXhrToReturn(200);return xhr.send("POST","test-url",null,{headers:{"Content-Type":"text/plain","X-Made-Up":"FooBar"}}).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals("text/plain",stubXhr.headers["Content-Type"]);assertEquals("FooBar",stubXhr.headers["X-Made-Up"])})}function testSendPostHeadersWithFormData(){if(!goog.global.FormData){return}var formData=new goog.global.FormData;formData.append("name","value");stubXhrToReturn(200);return xhr.send("POST","test-url",formData,{headers:{"Content-Type":"text/plain","X-Made-Up":"FooBar"}}).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals("text/plain",stubXhr.headers["Content-Type"]);assertEquals("FooBar",stubXhr.headers["X-Made-Up"])})}function testSendNullPostHeaders(){stubXhrToReturn(200);return xhr.send("POST","test-url",null,{headers:{"Content-Type":null,"X-Made-Up":"FooBar","Y-Made-Up":null}}).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals(void 0,stubXhr.headers["Content-Type"]);assertEquals("FooBar",stubXhr.headers["X-Made-Up"]);assertEquals(void 0,stubXhr.headers["Y-Made-Up"])})}function testSendNullPostHeadersWithFormData(){if(!goog.global.FormData){return}var formData=new goog.global.FormData;formData.append("name","value");stubXhrToReturn(200);return xhr.send("POST","test-url",formData,{headers:{"Content-Type":null,"X-Made-Up":"FooBar","Y-Made-Up":null}}).then(function(stubXhr){assertEquals("POST",stubXhr.method);assertEquals("test-url",stubXhr.url);assertEquals(void 0,stubXhr.headers["Content-Type"]);assertEquals("FooBar",stubXhr.headers["X-Made-Up"]);assertEquals(void 0,stubXhr.headers["Y-Made-Up"])})}function testSendWithCredentials(){stubXhrToReturn(200);return xhr.send("POST","test-url",null,{withCredentials:!0}).then(function(stubXhr){assertTrue("XHR should have been sent",stubXhr.sent);assertTrue(stubXhr.withCredentials)})}function testSendWithMimeType(){stubXhrToReturn(200);return xhr.send("POST","test-url",null,{mimeType:"text/plain"}).then(function(stubXhr){assertTrue("XHR should have been sent",stubXhr.sent);assertEquals("text/plain",stubXhr.mimeType)})}function testSendWithHttpError(){stubXhrToReturn(500);return xhr.send("POST","test-url",null).then(fail,function(err){assertTrue(err instanceof xhr.HttpError);assertTrue(err.xhr.sent);assertEquals(500,err.status)})}function testSendWithTimeoutNotHit(){stubXhrToReturn(200,null,1400);return xhr.send("POST","test-url",null,{timeoutMs:1500}).then(function(stubXhr){assertTrue(0<mockClock.getTimeoutsMade());assertTrue("XHR should have been sent",stubXhr.sent);assertFalse("XHR should not have been aborted",stubXhr.aborted)})}function testSendWithTimeoutHit(){stubXhrToReturn(200,null,50);return xhr.send("POST","test-url",null,{timeoutMs:50}).then(fail,function(err){assertTrue("XHR should have been sent",err.xhr.sent);assertTrue("XHR should have been aborted",err.xhr.aborted);assertTrue(err instanceof xhr.TimeoutError)})}function testCancelRequest(){stubXhrToReturn(200);var promise=xhr.send("GET","test-url").then(fail,function(error){assertTrue(error instanceof goog.Promise.CancellationError);return null});promise.cancel();return promise}function testGetJson(){var stubXhr=stubXhrToReturn(200,"{\"a\": 1, \"b\": 2}");xhr.getJson("test-url").then(function(responseObj){assertObjectEquals({a:1,b:2},responseObj)})}function testGetJsonWithXssiPrefix(){stubXhrToReturn(200,"while(1);\n{\"a\": 1, \"b\": 2}");return xhr.getJson("test-url",{xssiPrefix:"while(1);\n"}).then(function(responseObj){assertObjectEquals({a:1,b:2},responseObj)})}function testSendWithClientException(){stubXhrToThrow(new Error("CORS XHR with file:// schemas not allowed."));return xhr.send("POST","file://test-url",null).then(fail,function(err){assertFalse("XHR should not have been sent",err.xhr.sent);assertTrue(err instanceof Error);assertTrue(/CORS XHR with file:\/\/ schemas not allowed./.test(err.message))})}function testSendWithFactory(){stubXhrToReturn(200);var options={xmlHttpFactory:new goog.net.WrapperXmlHttpFactory(goog.partial(buildThrowingStubXhr,new Error("Bad factory")),goog.net.XmlHttp.getOptions)};return xhr.send("POST","file://test-url",null,options).then(fail,function(err){assertTrue(err instanceof Error)})}