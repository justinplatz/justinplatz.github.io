goog.provide("goog.windowTest");goog.setTestOnly("goog.windowTest");goog.require("goog.Promise");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.functions");goog.require("goog.html.SafeUrl");goog.require("goog.labs.userAgent.browser");goog.require("goog.labs.userAgent.engine");goog.require("goog.labs.userAgent.platform");goog.require("goog.string");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");goog.require("goog.window");var newWin,REDIRECT_URL_PREFIX="window_test.html?runTests=",WIN_LOAD_TRY_TIMEOUT=100,MAX_WIN_LOAD_TRIES=50,stubs=new goog.testing.PropertyReplacer;function shouldRunTests(){return!goog.labs.userAgent.browser.isEdge()}function setUpPage(){for(var anchors=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.DIV,"goog-like-link"),i=0;i<anchors.length;i++){goog.events.listen(anchors[i],"click",function(e){goog.window.open(goog.dom.getTextContent(e.target),{noreferrer:!0})})}goog.testing.TestCase.getActiveTestCase().promiseTimeout=6e4}var newWinLoaded=!0;function setUp(){newWin=void 0}function tearDown(){if(newWin){newWin.close()}stubs.reset()}function waitForTestWindow(win){return new goog.Promise(function(resolve,reject){var checkWindow=function(numTries){if(!win){fail("Could not open new window. Check if popup blocker is enabled.")}if(numTries>MAX_WIN_LOAD_TRIES){fail("Window did not load after maximum number of checks.")}if(win.newWinLoaded){resolve(win)}else{window.setTimeout(checkWindow,WIN_LOAD_TRY_TIMEOUT)}};checkWindow(0)})}function doTestOpenWindow(noreferrer,urlParam,encodeUrlParam_opt){if(encodeUrlParam_opt){urlParam=encodeURIComponent(urlParam)}newWin=goog.window.open(REDIRECT_URL_PREFIX+urlParam,{noreferrer:noreferrer,target:"_blank"});return waitForTestWindow(newWin).then(function(win){verifyWindow(win,noreferrer,urlParam)})}function verifyWindow(win,noreferrer,urlParam){if(noreferrer){assertEquals("Referrer should have been stripped","",win.document.referrer)}var winUrl=decodeURI(win.location),expectedUrlSuffix=decodeURI(urlParam);assertTrue("New window href should have ended with <"+expectedUrlSuffix+"> but was <"+winUrl+">",goog.string.endsWith(winUrl,expectedUrlSuffix))}function testOpenNotEncoded(){return doTestOpenWindow(!1,"bogus~")}function testOpenEncoded(){return doTestOpenWindow(!1,"bogus%7E")}function testOpenEncodedPercent(){return doTestOpenWindow(!1,"bogus%257E")}function testOpenNotEncodedHidingReferrer(){return doTestOpenWindow(!0,"bogus~")}function testOpenEncodedHidingReferrer(){return doTestOpenWindow(!0,"bogus%7E")}function testOpenEncodedPercentHidingReferrer(){return doTestOpenWindow(!0,"bogus%257E")}function testOpenSemicolon(){return doTestOpenWindow(!0,"beforesemi;aftersemi")}function testTwoSemicolons(){return doTestOpenWindow(!0,"a;b;c")}function testOpenAmpersand(){return doTestOpenWindow(!0,"this&that")}function testOpenSingleQuote(){return doTestOpenWindow(!0,"'")}function testOpenDoubleQuote(){return doTestOpenWindow(!0,"\"",goog.labs.userAgent.browser.isIE())}function testOpenTag(){return doTestOpenWindow(!0,"<",goog.labs.userAgent.browser.isIE())}function testOpenWindowSanitization(){var navigatedUrl,mockWin={open:function(url){navigatedUrl=url}};goog.window.open("javascript:evil();",{},mockWin);assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,navigatedUrl);goog.window.open({href:"javascript:evil();"},{},mockWin);assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,navigatedUrl);goog.window.open("javascript:''",{},mockWin);assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,navigatedUrl);goog.window.open("about:blank",{},mockWin);assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,navigatedUrl)}function testOpenWindowNoSanitization(){var navigatedUrl,mockWin={open:function(url){navigatedUrl=url}};goog.window.open("",{},mockWin);assertEquals("",navigatedUrl);goog.window.open(goog.html.SafeUrl.ABOUT_BLANK,{},mockWin);assertEquals("about:blank",navigatedUrl)}function testOpenBlank(){newWin=goog.window.openBlank("Loading...");var urlParam="bogus~";newWin.location.href=REDIRECT_URL_PREFIX+urlParam;return waitForTestWindow(newWin).then(function(){verifyWindow(newWin,!1,urlParam)})}function testOpenBlankReturnsNullPopupBlocker(){var mockWin={open:function(){return null}},win=goog.window.openBlank("",{noreferrer:!0},mockWin);assertNull(win)}function testOpenBlankEscapesSafely(){var navigatedUrl,mockWin={open:function(url){navigatedUrl=url}},win=goog.window.openBlank("\"\\",{},mockWin);assertEquals("javascript:\"&quot;%5C%5C\"",navigatedUrl)}function testOpenIosBlank(){if(!goog.labs.userAgent.engine.isWebKit()||!window.navigator){return}var attrs={},dispatchedEvent=null,element={setAttribute:function(name,value){attrs[name]=value},dispatchEvent:function(event){dispatchedEvent=event}};stubs.replace(window.document,"createElement",function(name){if(name==goog.dom.TagName.A){return element}return null});stubs.set(window.navigator,"standalone",!0);stubs.replace(goog.labs.userAgent.platform,"isIos",goog.functions.TRUE);var newWin=goog.window.open("http://google.com",{target:"_blank"});assertNotNull(newWin);assertUndefined(newWin.document);assertEquals("http://google.com",element.href);assertEquals("_blank",attrs.target);assertEquals("",attrs.rel||"");assertNotNull(dispatchedEvent);assertEquals("click",dispatchedEvent.type)}function testOpenIosBlankNoreferrer(){if(!goog.labs.userAgent.engine.isWebKit()||!window.navigator){return}var attrs={},dispatchedEvent=null,element={setAttribute:function(name,value){attrs[name]=value},dispatchEvent:function(event){dispatchedEvent=event}};stubs.replace(window.document,"createElement",function(name){if(name==goog.dom.TagName.A){return element}return null});stubs.set(window.navigator,"standalone",!0);stubs.replace(goog.labs.userAgent.platform,"isIos",goog.functions.TRUE);var newWin=goog.window.open("http://google.com",{target:"_blank",noreferrer:!0});assertNotNull(newWin);assertUndefined(newWin.document);assertEquals("http://google.com",element.href);assertEquals("_blank",attrs.target);assertEquals("noreferrer",attrs.rel);assertNotNull(dispatchedEvent);assertEquals("click",dispatchedEvent.type)}function testOpenNoReferrerEscapesUrl(){var documentWriteHtml,mockNewWin={};mockNewWin.document={write:function(html){documentWriteHtml=html},close:function(){}};var mockWin={open:function(){return mockNewWin}};goog.window.open("https://hello&world",{noreferrer:!0},mockWin);assertRegExp("Does not contain expected HTML-escaped string: "+documentWriteHtml,/hello&amp;world/,documentWriteHtml)}