goog.provide("goog.cssom.iframe.styleTest");goog.setTestOnly("goog.cssom.iframe.styleTest");goog.require("goog.cssom");goog.require("goog.cssom.iframe.style");goog.require("goog.dom");goog.require("goog.dom.DomHelper");goog.require("goog.dom.TagName");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var propertiesToTest=["color","font-family","font-style","font-size","font-variant","border-top-style","border-top-width","border-top-color","background-color","margin-bottom"];function crawlDom(startNode,func){if(1!=startNode.nodeType){return}func(startNode);for(var i=0;i<startNode.childNodes.length;i++){crawlDom(startNode.childNodes[i],func)}}function getCurrentCssProperties(node,propList){var props={};if(1!=node.nodeType){return}for(var i=0,prop;i<propList.length;i++){prop=propList[i];if(node.currentStyle){for(var propCamelCase="",propParts=prop.split("-"),j=0;j<propParts.length;j++){propCamelCase+=propParts[j].charAt(0).toUpperCase()+propParts[j].substring(1,propParts[j].length)}props[prop]=node.currentStyle[propCamelCase]}else{props[prop]=node.ownerDocument.defaultView.getComputedStyle(node,"").getPropertyValue(prop)}}return props}function CssPropertyCollector(){var propsList=[];this.propsList=propsList;this.collectProps=function(node){var nodeProps=getCurrentCssProperties(node,propertiesToTest);if(nodeProps){propsList.push([nodeProps,node])}}}function recursivelyListCssProperties(el){var collector=new CssPropertyCollector;crawlDom(el,collector.collectProps);return collector.propsList}function testMatchCssSelector(){var container=goog.dom.createElement(goog.dom.TagName.DIV);container.className="container";var el=goog.dom.createElement(goog.dom.TagName.DIV);x=el;el.id="mydiv";el.className="colorful foo";el.innerHTML="<div><ul><li>One</li><li>Two</li></ul></div>";container.appendChild(el);document.body.appendChild(container);var elementAncestry=new goog.cssom.iframe.style.NodeAncestry_(el);assertEquals(5,elementAncestry.nodes.length);for(var expectedResults=[["body div",[4,1]],["h1",null],["body div h1",[4,1]],["body div.colorful h1",[4,1]],["body div div",[4,2]],["body div div div",[4,2]],["body div div.somethingelse div",[4,1]],["body div.somethingelse div",[2,0]],["div.container",[3,0]],["div.container div",[4,1]],["#mydiv",[4,0]],["div#mydiv",[4,0]],["div.colorful",[4,0]],["div#mydiv .colorful",[4,0]],[".colorful",[4,0]],["body * div",[4,2]],["body * *",[4,2]]],i=0;i<expectedResults.length;i++){var input=expectedResults[i][0],expectedResult=expectedResults[i][1],selector=new goog.cssom.iframe.style.CssSelector_(input),result=selector.matchElementAncestry(elementAncestry);if(null==expectedResult){assertEquals("Expected null result",expectedResult,result)}else{assertEquals("Expected element index for "+input,expectedResult[0],result.elementIndex);assertEquals("Expected selector part index for "+input,expectedResult[1],result.selectorPartIndex)}}document.body.removeChild(container)}function makeIframeDocument(iframe){var doc=goog.dom.getFrameContentDocument(iframe);doc.open();doc.write("<html><head>");doc.write("<style>html,body { background-color: transparent; }</style>");doc.write("</head><body></body></html>");doc.close();return doc}function testCopyCss(){for(var i=1;4>=i;i++){var sourceElement=document.getElementById("source"+i),newFrame=goog.dom.createElement(goog.dom.TagName.IFRAME);newFrame.allowTransparency=!0;sourceElement.parentNode.insertBefore(newFrame,sourceElement.nextSibling);var doc=makeIframeDocument(newFrame);goog.cssom.addCssText(goog.cssom.iframe.style.getElementContext(sourceElement),new goog.dom.DomHelper(doc));doc.body.innerHTML=sourceElement.innerHTML;var oldProps=recursivelyListCssProperties(sourceElement),newProps=recursivelyListCssProperties(doc.body);assertEquals(oldProps.length,newProps.length);for(var j=0;j<oldProps.length;j++){for(var k=0;k<propertiesToTest.length;k++){assertEquals("testing property "+propertiesToTest[k],oldProps[j][0][propertiesToTest[k]],newProps[j][0][propertiesToTest[k]])}}}}function normalizeCssText(cssText){return cssText.replace(/\s/g,"").toLowerCase()}function testAImportantInFF2(){var testDiv=document.getElementById("source1"),cssText=normalizeCssText(goog.cssom.iframe.style.getElementContext(testDiv)),color=standardizeCSSValue("color","red"),NORMAL_RULE="a{color:"+color,FF_2_RULE="a{color:"+color+"!important";if(goog.userAgent.GECKO&&!goog.userAgent.isVersionOrHigher("1.9a")){assertContains(FF_2_RULE,cssText)}else{assertContains(NORMAL_RULE,cssText);assertNotContains(FF_2_RULE,cssText)}}function testCopyBackgroundContext(){var testDiv=document.getElementById("backgroundTest"),cssText=goog.cssom.iframe.style.getElementContext(testDiv,null,!0),iframe=goog.dom.createElement(goog.dom.TagName.IFRAME),ancestor=document.getElementById("backgroundTest-ancestor-1");ancestor.parentNode.insertBefore(iframe,ancestor.nextSibling);iframe.style.width="100%";iframe.style.height="100px";iframe.style.borderWidth="0px";var doc=makeIframeDocument(iframe);goog.cssom.addCssText(cssText,new goog.dom.DomHelper(doc));doc.body.innerHTML=testDiv.innerHTML;var normalizedCssText=normalizeCssText(cssText);assertTrue("Background color should be copied from parent element",/body{[^{]*background-color:(?:rgb\(128,0,128\)|#800080)/.test(normalizedCssText));assertTrue("Background image should be copied from ancestor element",/body{[^{]*background-image:url\(/.test(normalizedCssText));if(!(goog.userAgent.GECKO&&!goog.userAgent.isVersionOrHigher("1.9"))){assertTrue("Background image position should be adjusted correctly",/body{[^{]*background-position:31px54px/.test(normalizedCssText))}}function testCopyBackgroundContextFromIframe(){var testDiv=document.getElementById("backgroundTest"),iframe=goog.dom.createElement(goog.dom.TagName.IFRAME);iframe.allowTransparency=!0;iframe.style.position="absolute";iframe.style.top="5px";iframe.style.left="5px";iframe.style.borderWidth="2px";iframe.style.borderStyle="solid";testDiv.appendChild(iframe);var doc=makeIframeDocument(iframe);doc.body.backgroundColor="transparent";doc.body.style.margin="0";doc.body.style.padding="0";doc.body.innerHTML="<p style=\"margin: 0\">I am transparent!</p>";var normalizedCssText=normalizeCssText(goog.cssom.iframe.style.getElementContext(doc.body.firstChild,null,!0));assertTrue("Background color should be copied from parent element",/body{[^{]*background-color:(?:rgb\(128,0,128\)|#800080)/.test(normalizedCssText));assertTrue("Background image should be copied from ancestor element",/body{[^{]*background-image:url\(/.test(normalizedCssText));if(!(goog.userAgent.GECKO&&!goog.userAgent.isVersionOrHigher("1.9"))){assertTrue("Background image position should be adjusted correctly",!!/body{[^{]*background-position:24px47px/.exec(normalizedCssText))}iframe.parentNode.removeChild(iframe)}function testCopyFontFaceRules(){var isFontFaceCssomSupported=goog.userAgent.WEBKIT||goog.userAgent.OPERA||goog.userAgent.GECKO&&goog.userAgent.isVersionOrHigher("1.9.1");if(isFontFaceCssomSupported){var cssText=goog.cssom.iframe.style.getElementContext(document.getElementById("cavalier"));assertTrue("The font face rule should have been copied correctly",/@font-face/.test(cssText))}}