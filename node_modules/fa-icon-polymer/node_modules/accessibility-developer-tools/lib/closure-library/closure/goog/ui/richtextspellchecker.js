goog.provide("goog.ui.RichTextSpellChecker");goog.require("goog.Timer");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.Range");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyHandler");goog.require("goog.math.Coordinate");goog.require("goog.spell.SpellCheck");goog.require("goog.string.StringBuffer");goog.require("goog.style");goog.require("goog.ui.AbstractSpellChecker");goog.require("goog.ui.Component");goog.require("goog.ui.PopupMenu");goog.ui.RichTextSpellChecker=function(handler,opt_domHelper){goog.ui.AbstractSpellChecker.call(this,handler,opt_domHelper);this.workBuffer_=new goog.string.StringBuffer;this.boundContinueAsyncFn_=goog.bind(this.continueAsync_,this);this.eventHandler_=new goog.events.EventHandler(this);this.registerDisposable(this.eventHandler_);this.keyHandler_=new goog.events.KeyHandler;this.registerDisposable(this.keyHandler_)};goog.inherits(goog.ui.RichTextSpellChecker,goog.ui.AbstractSpellChecker);goog.tagUnsealableClass(goog.ui.RichTextSpellChecker);goog.ui.RichTextSpellChecker.prototype.rootNode_;goog.ui.RichTextSpellChecker.prototype.rootNodeIframe_=!1;goog.ui.RichTextSpellChecker.prototype.currentNode_;goog.ui.RichTextSpellChecker.prototype.elementsInserted_=0;goog.ui.RichTextSpellChecker.prototype.dictionaryPreScanSize_=1e3;goog.ui.RichTextSpellChecker.prototype.wordClassName=goog.getCssName("goog-spellcheck-word");goog.ui.RichTextSpellChecker.prototype.editorDom_;goog.ui.RichTextSpellChecker.prototype.excludeTags;goog.ui.RichTextSpellChecker.prototype.invalidWordCssText="background: yellow;";goog.ui.RichTextSpellChecker.prototype.createDom=function(){throw Error("Render not supported for goog.ui.RichTextSpellChecker.")};goog.ui.RichTextSpellChecker.prototype.decorateInternal=function(element){this.setElementInternal(element);this.rootNodeIframe_=element.contentDocument||element.contentWindow;if(this.rootNodeIframe_){var doc=element.contentDocument||element.contentWindow.document;this.rootNode_=doc.body;this.editorDom_=goog.dom.getDomHelper(doc)}else{this.rootNode_=element;this.editorDom_=goog.dom.getDomHelper(element)}};goog.ui.RichTextSpellChecker.prototype.enterDocument=function(){goog.ui.RichTextSpellChecker.superClass_.enterDocument.call(this);var rootElement=goog.asserts.assertElement(this.rootNode_,"The rootNode_ of a richtextspellchecker must be an Element.");this.keyHandler_.attach(rootElement);this.initSuggestionsMenu()};goog.ui.RichTextSpellChecker.prototype.initSuggestionsMenu=function(){goog.ui.RichTextSpellChecker.base(this,"initSuggestionsMenu");var menu=goog.asserts.assertInstanceof(this.getMenu(),goog.ui.PopupMenu,"The menu of a richtextspellchecker must be a PopupMenu.");this.eventHandler_.listen(menu,goog.ui.Component.EventType.HIDE,this.onCorrectionHide_)};goog.ui.RichTextSpellChecker.prototype.check=function(){this.blockReadyEvents();this.preChargeDictionary_(this.rootNode_,this.dictionaryPreScanSize_);this.unblockReadyEvents();this.eventHandler_.listen(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0);this.spellCheck.processPending()};goog.ui.RichTextSpellChecker.prototype.preChargeDictionary_=function(node,words){while(node){var next=this.nextNode_(node);if(this.isExcluded_(node)){node=next;continue}if(node.nodeType==goog.dom.NodeType.TEXT){if(node.nodeValue){words-=this.populateDictionary(node.nodeValue,words);if(0>=words){return}}}else if(node.nodeType==goog.dom.NodeType.ELEMENT){if(node.firstChild){next=node.firstChild}}node=next}};goog.ui.RichTextSpellChecker.prototype.onDictionaryCharged_=function(e){e.stopPropagation();this.eventHandler_.unlisten(this.spellCheck,goog.spell.SpellCheck.EventType.READY,this.onDictionaryCharged_,!0);this.clearWordElements();this.initializeAsyncMode();this.elementsInserted_=0;var result=this.processNode_(this.rootNode_);if(result==goog.ui.AbstractSpellChecker.AsyncResult.PENDING){goog.Timer.callOnce(this.boundContinueAsyncFn_);return}this.finishAsyncProcessing();this.finishCheck_()};goog.ui.RichTextSpellChecker.prototype.continueAsync_=function(){var result=this.continueAsyncProcessing();if(result==goog.ui.AbstractSpellChecker.AsyncResult.PENDING){goog.Timer.callOnce(this.boundContinueAsyncFn_);return}result=this.processNode_(this.currentNode_);if(result==goog.ui.AbstractSpellChecker.AsyncResult.PENDING){goog.Timer.callOnce(this.boundContinueAsyncFn_);return}this.finishAsyncProcessing();this.finishCheck_()};goog.ui.RichTextSpellChecker.prototype.finishCheck_=function(){delete this.currentNode_;this.spellCheck.processPending();if(!this.isVisible()){this.eventHandler_.listen(this.rootNode_,goog.events.EventType.CLICK,this.onWordClick_).listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleRootNodeKeyEvent)}goog.ui.RichTextSpellChecker.superClass_.check.call(this)};goog.ui.RichTextSpellChecker.prototype.nextNode_=function(node){while(node!=this.rootNode_){if(node.nextSibling){return node.nextSibling}node=node.parentNode}return null};goog.ui.RichTextSpellChecker.prototype.isTextLeaf_=function(node){return null!=node&&node.nodeType==goog.dom.NodeType.TEXT&&!node.firstChild};goog.ui.RichTextSpellChecker.prototype.setExcludeMarker=function(marker){if(marker){if("string"==typeof marker){marker=[marker]}this.excludeTags=[];this.excludeMarker=[];for(var i=0,parts;i<marker.length;i++){parts=marker[i].split(".");if(2==parts.length){this.excludeTags.push(parts[0]);this.excludeMarker.push(parts[1])}else{this.excludeMarker.push(parts[0]);this.excludeTags.push(void 0)}}}};goog.ui.RichTextSpellChecker.prototype.isExcluded_=function(node){if(this.excludeMarker&&node.className){for(var i=0;i<this.excludeMarker.length;i++){var excludeTag=this.excludeTags[i],excludeClass=this.excludeMarker[i],isExcluded=!!(excludeClass&&-1!=node.className.indexOf(excludeClass)&&(!excludeTag||node.tagName==excludeTag));if(isExcluded){return!0}}}return!1};goog.ui.RichTextSpellChecker.prototype.processNode_=function(node){delete this.currentNode_;while(node){var next=this.nextNode_(node);if(this.isExcluded_(node)){node=next;continue}if(node.nodeType==goog.dom.NodeType.TEXT){var deleteNode=!0;if(node.nodeValue){var currentElements=this.elementsInserted_,result=this.processTextAsync(node,node.nodeValue);if(result==goog.ui.AbstractSpellChecker.AsyncResult.PENDING){node.nodeValue="";this.currentNode_=node;return result}if(currentElements==this.elementsInserted_){deleteNode=!1}}if(deleteNode){goog.dom.removeNode(node)}}else if(node.nodeType==goog.dom.NodeType.ELEMENT){if(node.className==this.wordClassName){var runner=node.firstChild;while(runner){if(this.isTextLeaf_(runner)){while(this.isTextLeaf_(runner.nextSibling)){runner.nodeValue+=runner.nextSibling.nodeValue;goog.dom.removeNode(runner.nextSibling)}}runner=runner.nextSibling}if(node.firstChild){next=node.firstChild;while(node.firstChild){node.parentNode.insertBefore(node.firstChild,node)}}goog.dom.removeNode(node)}else{if(node.firstChild){next=node.firstChild}}}node=next}};goog.ui.RichTextSpellChecker.prototype.processWord=function(node,word,status){node.parentNode.insertBefore(this.createWordElement(word,status),node);this.elementsInserted_++};goog.ui.RichTextSpellChecker.prototype.processRange=function(node,text){if(node.nodeType==goog.dom.NodeType.TEXT&&node.nodeValue.length==text.length){return}node.parentNode.insertBefore(this.editorDom_.createTextNode(text),node);this.elementsInserted_++};goog.ui.RichTextSpellChecker.prototype.getElementByIndex=function(id){return this.editorDom_.getElement(this.makeElementId(id))};goog.ui.RichTextSpellChecker.prototype.updateElement=function(el,word,status){if(status==goog.spell.SpellCheck.WordStatus.VALID&&el!=this.currentNode_&&el.nextSibling!=this.currentNode_){this.removeMarkup(el)}else{goog.dom.setProperties(el,this.getElementProperties(status))}};goog.ui.RichTextSpellChecker.prototype.resume=function(){goog.ui.RichTextSpellChecker.superClass_.resume.call(this);this.restoreNode_(this.rootNode_);this.eventHandler_.unlisten(this.rootNode_,goog.events.EventType.CLICK,this.onWordClick_).unlisten(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleRootNodeKeyEvent)};goog.ui.RichTextSpellChecker.prototype.restoreNode_=function(node){while(node){if(this.isExcluded_(node)){node=node.nextSibling;continue}if(node.nodeType==goog.dom.NodeType.ELEMENT&&node.className==this.wordClassName){for(var firstElement=node.firstChild,next,child=firstElement;child;child=next){next=child.nextSibling;node.parentNode.insertBefore(child,node)}next=firstElement||node.nextSibling;goog.dom.removeNode(node);node=next;continue}var textLeaf=this.isTextLeaf_(node);if(textLeaf){var textNodes=1,next=node.nextSibling;while(this.isTextLeaf_(node.previousSibling)){node=node.previousSibling;++textNodes}while(this.isTextLeaf_(next)){next=next.nextSibling;++textNodes}if(1<textNodes){this.workBuffer_.append(node.nodeValue);while(this.isTextLeaf_(node.nextSibling)){this.workBuffer_.append(node.nextSibling.nodeValue);goog.dom.removeNode(node.nextSibling)}node.nodeValue=this.workBuffer_.toString();this.workBuffer_.clear()}}if(node.firstChild){this.restoreNode_(node.firstChild)}node=node.nextSibling}};goog.ui.RichTextSpellChecker.prototype.getElementProperties=function(status){return{class:this.wordClassName,style:status==goog.spell.SpellCheck.WordStatus.INVALID?this.invalidWordCssText:""}};goog.ui.RichTextSpellChecker.prototype.onWordClick_=function(event){var target=event.target;if(event.target.className==this.wordClassName&&this.spellCheck.checkWord(goog.dom.getTextContent(target))==goog.spell.SpellCheck.WordStatus.INVALID){this.showSuggestionsMenu(target,event);event.stopPropagation()}};goog.ui.RichTextSpellChecker.prototype.disposeInternal=function(){goog.ui.RichTextSpellChecker.superClass_.disposeInternal.call(this);this.rootNode_=null;this.editorDom_=null};goog.ui.RichTextSpellChecker.prototype.isEditorIframe=function(){return this.rootNodeIframe_};goog.ui.RichTextSpellChecker.prototype.handleRootNodeKeyEvent=function(e){var handled=!1;switch(e.keyCode){case goog.events.KeyCodes.RIGHT:if(e.ctrlKey){handled=this.navigate(goog.ui.AbstractSpellChecker.Direction.NEXT)}break;case goog.events.KeyCodes.LEFT:if(e.ctrlKey){handled=this.navigate(goog.ui.AbstractSpellChecker.Direction.PREVIOUS)}break;case goog.events.KeyCodes.DOWN:if(this.getFocusedElementIndex()){var el=this.editorDom_.getElement(this.makeElementId(this.getFocusedElementIndex()));if(el){var position=goog.style.getClientPosition(el);if(this.isEditorIframe()){var iframePosition=goog.style.getClientPosition(this.getElementStrict());position=goog.math.Coordinate.sum(iframePosition,position)}var size=goog.style.getSize(el);position.x+=size.width/2;position.y+=size.height/2;this.showSuggestionsMenu(el,position);handled=!0}}break;}if(handled){e.preventDefault()}return handled};goog.ui.RichTextSpellChecker.prototype.onCorrectionAction=function(event){goog.ui.RichTextSpellChecker.base(this,"onCorrectionAction",event);if(event.target!=this.getMenuEdit()){this.reFocus_()}};goog.ui.RichTextSpellChecker.prototype.onCorrectionHide_=function(event){this.reFocus_()};goog.ui.RichTextSpellChecker.prototype.reFocus_=function(){this.getElementStrict().focus();var el=this.getElementByIndex(this.getFocusedElementIndex());if(el){this.focusOnElement(el)}};goog.ui.RichTextSpellChecker.prototype.focusOnElement=function(element){goog.dom.Range.createCaret(element,0).select()};