goog.provide("goog.testing.net.XhrIoTest");goog.setTestOnly("goog.testing.net.XhrIoTest");goog.require("goog.dom.xml");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.net.XmlHttp");goog.require("goog.object");goog.require("goog.testing.MockControl");goog.require("goog.testing.asserts");goog.require("goog.testing.jsunit");goog.require("goog.testing.mockmatchers.InstanceOf");goog.require("goog.testing.net.XhrIo");var mockControl;function setUp(){mockControl=new goog.testing.MockControl}function testStaticSend(){sendInstances=goog.testing.net.XhrIo.getSendInstances();var returnedXhr=goog.testing.net.XhrIo.send("url");assertEquals("sendInstances_ after send",1,sendInstances.length);xhr=sendInstances[sendInstances.length-1];assertTrue("isActive after request",xhr.isActive());assertEquals(returnedXhr,xhr);assertEquals("readyState after request",goog.net.XmlHttp.ReadyState.LOADING,xhr.getReadyState());xhr.simulateResponse(200,"");assertFalse("isActive after response",xhr.isActive());assertEquals("readyState after response",goog.net.XmlHttp.ReadyState.COMPLETE,xhr.getReadyState());xhr.simulateReady();assertEquals("sendInstances_ after READY",0,sendInstances.length)}function testStaticSendWithException(){goog.testing.net.XhrIo.send("url",function(){if(!this.isSuccess()){throw Error("The xhr did not complete successfully!")}});var sendInstances=goog.testing.net.XhrIo.getSendInstances(),xhr=sendInstances[sendInstances.length-1];try{xhr.simulateResponse(400,"")}catch(e){}assertEquals("Send instance array not cleaned up properly!",0,sendInstances.length)}function testMultipleSend(){var xhr=new goog.testing.net.XhrIo;assertFalse("isActive before first request",xhr.isActive());assertEquals("readyState before first request",goog.net.XmlHttp.ReadyState.UNINITIALIZED,xhr.getReadyState());xhr.send("url");assertTrue("isActive after first request",xhr.isActive());assertEquals("readyState after first request",goog.net.XmlHttp.ReadyState.LOADING,xhr.getReadyState());xhr.simulateResponse(200,"");assertFalse("isActive after first response",xhr.isActive());assertEquals("readyState after first response",goog.net.XmlHttp.ReadyState.COMPLETE,xhr.getReadyState());xhr.send("url");assertTrue("isActive after second request",xhr.isActive());assertEquals("readyState after second request",goog.net.XmlHttp.ReadyState.LOADING,xhr.getReadyState())}function testGetLastUri(){var xhr=new goog.testing.net.XhrIo;assertEquals("nothing sent yet, empty URI","",xhr.getLastUri());var requestUrl="http://www.example.com/";xhr.send(requestUrl);assertEquals("message sent, URI saved",requestUrl,xhr.getLastUri())}function testGetLastMethod(){var xhr=new goog.testing.net.XhrIo;assertUndefined("nothing sent yet, empty method",xhr.getLastMethod());var method="POKE";xhr.send("http://www.example.com/",method);assertEquals("message sent, method saved",method,xhr.getLastMethod());xhr.simulateResponse(200,"");xhr.send("http://www.example.com/");assertEquals("message sent, method saved","GET",xhr.getLastMethod())}function testGetLastContent(){var xhr=new goog.testing.net.XhrIo;assertUndefined("nothing sent yet, empty content",xhr.getLastContent());var postContent="var=value&var2=value2";xhr.send("http://www.example.com/",void 0,postContent);assertEquals("POST message sent, content saved",postContent,xhr.getLastContent());xhr.simulateResponse(200,"");xhr.send("http://www.example.com/");assertUndefined("GET message sent, content cleaned",xhr.getLastContent())}function testGetLastRequestHeaders(){var xhr=new goog.testing.net.XhrIo;assertUndefined("nothing sent yet, empty headers",xhr.getLastRequestHeaders());xhr.send("http://www.example.com/",void 0,void 0,{From:"page@google.com"});assertObjectEquals("Request sent with extra headers, headers saved",{From:"page@google.com"},xhr.getLastRequestHeaders());xhr.simulateResponse(200,"");xhr.send("http://www.example.com");assertUndefined("New request sent without extra headers",xhr.getLastRequestHeaders());xhr.simulateResponse(200,"");xhr.headers.set("X","A");xhr.headers.set("Y","B");xhr.send("http://www.example.com/",void 0,void 0,{Y:"P",Z:"Q"});assertObjectEquals("Default headers combined with call headers",{X:"A",Y:"P",Z:"Q"},xhr.getLastRequestHeaders());xhr.simulateResponse(200,"")}function testGetResponseText(){var called=!1,xhr=new goog.testing.net.XhrIo;goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertEquals("text",e.target.getResponseText())});xhr.simulateResponse(200,"text");assertTrue(called);var called=!1,xhr=new goog.testing.net.XhrIo,xml=goog.dom.xml.createDocument();xml.appendChild(xml.createElement("root"));goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;var text=e.target.getResponseText();assertTrue(/<root ?\/>/.test(text))});xhr.simulateResponse(200,xml);assertTrue(called)}function testGetResponseJson(){var called=!1,xhr=new goog.testing.net.XhrIo;goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertArrayEquals([0,1],e.target.getResponseJson())});xhr.simulateResponse(200,"[0, 1]");assertTrue(called);var called=!1,xhr=new goog.testing.net.XhrIo;goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertArrayEquals([0,1],e.target.getResponseJson(")]}', \n"))});xhr.simulateResponse(200,")]}', \n[0, 1]");assertTrue(called);var called=!1,xhr=new goog.testing.net.XhrIo;goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertThrows(e.target.getResponseJson)});xhr.simulateResponse(200,"[0, 1");assertTrue(called);var called=!1,xhr=new goog.testing.net.XhrIo,xml=goog.dom.xml.createDocument();xml.appendChild(xml.createElement("root"));goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertThrows(e.target.getResponseJson)});xhr.simulateResponse(200,xml);assertTrue(called)}function testGetResponseXml(){var called=!1,xhr=new goog.testing.net.XhrIo;goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertNull(e.target.getResponseXml())});xhr.simulateResponse(200,"text");assertTrue(called);var called=!1,xhr=new goog.testing.net.XhrIo,xml=goog.dom.xml.createDocument();xml.appendChild(xml.createElement("root"));goog.events.listen(xhr,goog.net.EventType.SUCCESS,function(e){called=!0;assertEquals(xml,e.target.getResponseXml())});xhr.simulateResponse(200,xml);assertTrue(called)}function testGetResponseHeaders_noHeadersPresent(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock();mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertTrue(e.type==goog.net.EventType.SUCCESS);assertUndefined(e.target.getResponseHeader("XHR"))});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);xhr.simulateResponse(200,"");mockControl.$verifyAll();mockControl.$resetAll()}function testGetResponseHeaders_headersPresent(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock();mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertTrue(e.type==goog.net.EventType.SUCCESS);assertUndefined(e.target.getResponseHeader("XHR"));assertEquals(e.target.getResponseHeader("Pragma"),"no-cache")});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);xhr.simulateResponse(200,"",{Pragma:"no-cache"});mockControl.$verifyAll();mockControl.$resetAll()}function testAbort_WhenNoPendingSentRequests(){var xhr=new goog.testing.net.XhrIo,eventListener=mockControl.createFunctionMock();mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.COMPLETE,eventListener);goog.events.listen(xhr,goog.net.EventType.SUCCESS,eventListener);goog.events.listen(xhr,goog.net.EventType.ABORT,eventListener);goog.events.listen(xhr,goog.net.EventType.ERROR,eventListener);goog.events.listen(xhr,goog.net.EventType.READY,eventListener);xhr.abort();mockControl.$verifyAll();mockControl.$resetAll()}function testAbort_PendingSentRequest(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock();mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertTrue(e.type==goog.net.EventType.COMPLETE);assertObjectEquals(e.target,xhr);assertEquals(e.target.getStatus(),-1);assertEquals(e.target.getLastErrorCode(),goog.net.ErrorCode.ABORT);assertTrue(e.target.isActive())});mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertTrue(e.type==goog.net.EventType.ABORT);assertObjectEquals(e.target,xhr);assertTrue(e.target.isActive())});mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertTrue(e.type==goog.net.EventType.READY);assertObjectEquals(e.target,xhr);assertFalse(e.target.isActive())});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.COMPLETE,mockListener);goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);goog.events.listen(xhr,goog.net.EventType.ABORT,mockListener);goog.events.listen(xhr,goog.net.EventType.ERROR,mockListener);goog.events.listen(xhr,goog.net.EventType.READY,mockListener);xhr.send("dummyurl");xhr.abort();mockControl.$verifyAll();mockControl.$resetAll()}function testEvents_Success(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock(),readyState=goog.net.XmlHttp.ReadyState.UNINITIALIZED;function readyStateListener(e){assertEquals(e.type,goog.net.EventType.READY_STATE_CHANGE);assertObjectEquals(e.target,xhr);readyState++;assertEquals(e.target.getReadyState(),readyState);assertTrue(e.target.isActive())}mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertEquals(e.type,goog.net.EventType.COMPLETE);assertObjectEquals(e.target,xhr);assertEquals(e.target.getLastErrorCode(),goog.net.ErrorCode.NO_ERROR);assertTrue(e.target.isActive())});mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertEquals(e.type,goog.net.EventType.SUCCESS);assertObjectEquals(e.target,xhr);assertTrue(e.target.isActive())});mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){assertEquals(e.type,goog.net.EventType.READY);assertObjectEquals(e.target,xhr);assertFalse(e.target.isActive())});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.READY_STATE_CHANGE,readyStateListener);goog.events.listen(xhr,goog.net.EventType.COMPLETE,mockListener);goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);goog.events.listen(xhr,goog.net.EventType.ABORT,mockListener);goog.events.listen(xhr,goog.net.EventType.ERROR,mockListener);goog.events.listen(xhr,goog.net.EventType.READY,mockListener);xhr.send("dummyurl");xhr.simulateResponse(200,null);mockControl.$verifyAll();mockControl.$resetAll()}function testGetResponseHeaders(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock();mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){var headers=e.target.getResponseHeaders();assertEquals(2,goog.object.getCount(headers));assertEquals("foo",headers.test1);assertEquals("bar",headers.test2)});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);xhr.simulateResponse(200,"",{test1:"foo",test2:"bar"});mockControl.$verifyAll();mockControl.$resetAll()}function testGetResponseHeadersWithColonInValue(){var xhr=new goog.testing.net.XhrIo,mockListener=mockControl.createFunctionMock();mockListener(new goog.testing.mockmatchers.InstanceOf(goog.events.Event)).$does(function(e){var headers=e.target.getResponseHeaders();assertEquals(1,goog.object.getCount(headers));assertEquals("f:o:o",headers.test1)});mockControl.$replayAll();goog.events.listen(xhr,goog.net.EventType.SUCCESS,mockListener);xhr.simulateResponse(200,"",{test1:"f:o:o"});mockControl.$verifyAll();mockControl.$resetAll()}