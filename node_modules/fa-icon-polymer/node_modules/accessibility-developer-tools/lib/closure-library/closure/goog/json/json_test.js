goog.provide("goog.jsonTest");goog.setTestOnly("goog.jsonTest");goog.require("goog.functions");goog.require("goog.json");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function allChars(start,end){for(var sb=[],i=start;i<end;i++){sb.push(String.fromCharCode(i))}return sb.join("")}function testStringSerialize(){assertSerialize("\"\"","");assertSerialize("\"true\"","true");assertSerialize("\"false\"","false");assertSerialize("\"null\"","null");assertSerialize("\"0\"","0");assertSerialize("\"\\n\"","\n");assertSerialize("\"\\u001f\"","\x1F");assertSerialize("\"\\u20ac\"","\u20AC");assertSerialize("\"\\ud83d\\ud83d\"","\uD83D\uD83D");var str=allChars(0,1e4);assertEquals(str,eval(goog.json.serialize(str)))}function testNullSerialize(){assertSerialize("null",null);assertSerialize("null",void 0);assertSerialize("null",NaN);assertSerialize("0",0);assertSerialize("\"\"","");assertSerialize("false",!1)}function testNullPropertySerialize(){assertSerialize("{\"a\":null}",{a:null});assertSerialize("{\"a\":null}",{a:void 0})}function testNumberSerialize(){assertSerialize("0",0);assertSerialize("12345",12345);assertSerialize("-12345",-12345);assertSerialize("0.1",.1);assertSerialize("0.1",.1);assertSerialize("1",+1);var s=goog.json.serialize(1e50);assertTrue("1e50","1e50"==s||"1E50"==s||"1e+50"==s||"1E+50"==s);s=goog.json.serialize(1e-50);assertTrue("1e50","1e-50"==s||"1E-50"==s);assertSerialize("null",NaN);assertSerialize("null",1/0);assertSerialize("null",-Infinity)}function testBooleanSerialize(){assertSerialize("true",!0);assertSerialize("\"true\"","true");assertSerialize("false",!1);assertSerialize("\"false\"","false")}function testArraySerialize(){assertSerialize("[]",[]);assertSerialize("[1]",[1]);assertSerialize("[1,2]",[1,2]);assertSerialize("[1,2,3]",[1,2,3]);assertSerialize("[[]]",[[]]);assertSerialize("[null,null]",[function(){},function(){}]);assertNotEquals("{length:0}",goog.json.serialize({length:0}),"[]")}function testFunctionSerialize(){assertSerialize("null",function(){})}function testObjectSerialize_emptyObject(){assertSerialize("{}",{})}function testObjectSerialize_oneItem(){assertSerialize("{\"a\":\"b\"}",{a:"b"})}function testObjectSerialize_twoItems(){assertEquals("{\"a\":\"b\",\"c\":\"d\"}",goog.json.serialize({a:"b",c:"d"}),"{\"a\":\"b\",\"c\":\"d\"}")}function testObjectSerialize_whitespace(){assertSerialize("{\" \":\" \"}",{" ":" "})}function testSerializeSkipFunction(){var object={s:"string value",b:!0,i:100,f:function(){var x="x"}};assertSerialize("null",object.f);assertSerialize("{\"s\":\"string value\",\"b\":true,\"i\":100}",object)}function testObjectSerialize_array(){assertNotEquals("[0,1]",goog.json.serialize([0,1]),"{\"0\":\"0\",\"1\":\"1\"}")}function testObjectSerialize_recursion(){if(goog.userAgent.WEBKIT){return}var anObject={};anObject.thisObject=anObject;assertThrows("expected recursion exception",function(){goog.json.serialize(anObject)})}function testObjectSerializeWithHasOwnProperty(){var object={hasOwnProperty:null};if(goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("9")){assertEquals("{}",goog.json.serialize(object))}else{assertEquals("{\"hasOwnProperty\":null}",goog.json.serialize(object))}}function testWrappedObjects(){assertSerialize("\"foo\"",new String("foo"));assertSerialize("42",new Number(42));assertSerialize("null",new Number("a NaN"));assertSerialize("true",new Boolean(!0))}function testStringParse(){assertEquals("Empty string",goog.json.parse("\"\""),"");assertEquals("whitespace string",goog.json.parse("\" \"")," ");var str=allChars(32,1e3),jsonString=goog.json.serialize(str),a=eval(jsonString);assertEquals("unicode string",goog.json.parse(jsonString),a);assertEquals("true as a string",goog.json.parse("\"true\""),"true");assertEquals("false as a string",goog.json.parse("\"false\""),"false");assertEquals("null as a string",goog.json.parse("\"null\""),"null");assertEquals("number as a string",goog.json.parse("\"0\""),"0")}function testStringUnsafeParse(){assertEquals("Empty string",goog.json.unsafeParse("\"\""),"");assertEquals("whitespace string",goog.json.unsafeParse("\" \"")," ");var str=allChars(32,1e3),jsonString=goog.json.serialize(str),a=eval(jsonString);assertEquals("unicode string",goog.json.unsafeParse(jsonString),a);assertEquals("true as a string",goog.json.unsafeParse("\"true\""),"true");assertEquals("false as a string",goog.json.unsafeParse("\"false\""),"false");assertEquals("null as a string",goog.json.unsafeParse("\"null\""),"null");assertEquals("number as a string",goog.json.unsafeParse("\"0\""),"0")}function testNullParse(){assertEquals("null",goog.json.parse(null),null);assertEquals("null",goog.json.parse("null"),null);assertNotEquals("0",goog.json.parse("0"),null);assertNotEquals("\"\"",goog.json.parse("\"\""),null);assertNotEquals("false",goog.json.parse("false"),null)}function testNullUnsafeParse(){assertEquals("null",goog.json.unsafeParse(null),null);assertEquals("null",goog.json.unsafeParse("null"),null);assertNotEquals("0",goog.json.unsafeParse("0"),null);assertNotEquals("\"\"",goog.json.unsafeParse("\"\""),null);assertNotEquals("false",goog.json.unsafeParse("false"),null)}function testNumberParse(){assertEquals("0",goog.json.parse("0"),0);assertEquals("12345",goog.json.parse("12345"),12345);assertEquals("-12345",goog.json.parse("-12345"),-12345);assertEquals("0.1",goog.json.parse("0.1"),.1);assertEquals(1e50,goog.json.parse("1e50"));assertEquals(1e50,goog.json.parse("1E50"));assertEquals(1e50,goog.json.parse("1e+50"));assertEquals(1e50,goog.json.parse("1E+50"));assertEquals(1e-50,goog.json.parse("1e-50"));assertEquals(1e-50,goog.json.parse("1E-50"))}function testNumberUnsafeParse(){assertEquals("0",goog.json.unsafeParse("0"),0);assertEquals("12345",goog.json.unsafeParse("12345"),12345);assertEquals("-12345",goog.json.unsafeParse("-12345"),-12345);assertEquals("0.1",goog.json.unsafeParse("0.1"),.1);assertEquals(1e50,goog.json.unsafeParse("1e50"));assertEquals(1e50,goog.json.unsafeParse("1E50"));assertEquals(1e50,goog.json.unsafeParse("1e+50"));assertEquals(1e50,goog.json.unsafeParse("1E+50"));assertEquals(1e-50,goog.json.unsafeParse("1e-50"));assertEquals(1e-50,goog.json.unsafeParse("1E-50"))}function testBooleanParse(){assertEquals("true",goog.json.parse("true"),!0);assertEquals("false",goog.json.parse("false"),!1);assertNotEquals("0",goog.json.parse("0"),!1);assertNotEquals("\"false\"",goog.json.parse("\"false\""),!1);assertNotEquals("null",goog.json.parse("null"),!1);assertNotEquals("1",goog.json.parse("1"),!0);assertNotEquals("\"true\"",goog.json.parse("\"true\""),!0);assertNotEquals("{}",goog.json.parse("{}"),!0);assertNotEquals("[]",goog.json.parse("[]"),!0)}function testBooleanUnsafeParse(){assertEquals("true",goog.json.unsafeParse("true"),!0);assertEquals("false",goog.json.unsafeParse("false"),!1);assertNotEquals("0",goog.json.unsafeParse("0"),!1);assertNotEquals("\"false\"",goog.json.unsafeParse("\"false\""),!1);assertNotEquals("null",goog.json.unsafeParse("null"),!1);assertNotEquals("1",goog.json.unsafeParse("1"),!0);assertNotEquals("\"true\"",goog.json.unsafeParse("\"true\""),!0);assertNotEquals("{}",goog.json.unsafeParse("{}"),!0);assertNotEquals("[]",goog.json.unsafeParse("[]"),!0)}function testArrayParse(){assertArrayEquals([],goog.json.parse("[]"));assertArrayEquals([1],goog.json.parse("[1]"));assertArrayEquals([1,2],goog.json.parse("[1,2]"));assertArrayEquals([1,2,3],goog.json.parse("[1,2,3]"));assertArrayEquals([[]],goog.json.parse("[[]]"));assertArrayEquals([1,,3],goog.json.parse("[1,,3]"));assertFalse("{length:0}","push"in goog.json.parse("{\"length\":0}"))}function testArrayUnsafeParse(){function arrayEquals(a1,a2){if(a1.length!=a2.length){return!1}for(var i=0;i<a1.length;i++){if(a1[i]!=a2[i]){return!1}}return!0}assertTrue("[]",arrayEquals(goog.json.unsafeParse("[]"),[]));assertTrue("[1]",arrayEquals(goog.json.unsafeParse("[1]"),[1]));assertTrue("[1,2]",arrayEquals(goog.json.unsafeParse("[1,2]"),[1,2]));assertTrue("[1,2,3]",arrayEquals(goog.json.unsafeParse("[1,2,3]"),[1,2,3]));assertTrue("[[]]",arrayEquals(goog.json.unsafeParse("[[]]")[0],[]));assertFalse("{length:0}","push"in goog.json.unsafeParse("{\"length\":0}"))}function testObjectParse(){function objectEquals(a1,a2){for(var key in a1){if(a1[key]!=a2[key]){return!1}}return!0}assertTrue("{}",objectEquals(goog.json.parse("{}"),{}));assertTrue("{\"a\":\"b\"}",objectEquals(goog.json.parse("{\"a\":\"b\"}"),{a:"b"}));assertTrue("{\"a\":\"b\",\"c\":\"d\"}",objectEquals(goog.json.parse("{\"a\":\"b\",\"c\":\"d\"}"),{a:"b",c:"d"}));assertTrue("{\" \":\" \"}",objectEquals(goog.json.parse("{\" \":\" \"}"),{" ":" "}));assertTrue("[0,1]","length"in goog.json.parse("[0,1]"))}function testObjectUnsafeParse(){function objectEquals(a1,a2){for(var key in a1){if(a1[key]!=a2[key]){return!1}}return!0}assertTrue("{}",objectEquals(goog.json.unsafeParse("{}"),{}));assertTrue("{\"a\":\"b\"}",objectEquals(goog.json.unsafeParse("{\"a\":\"b\"}"),{a:"b"}));assertTrue("{\"a\":\"b\",\"c\":\"d\"}",objectEquals(goog.json.unsafeParse("{\"a\":\"b\",\"c\":\"d\"}"),{a:"b",c:"d"}));assertTrue("{\" \":\" \"}",objectEquals(goog.json.unsafeParse("{\" \":\" \"}"),{" ":" "}));assertTrue("[0,1]","length"in goog.json.unsafeParse("[0,1]"))}function testForValidJson(){function error_(msg,s){assertThrows(msg+", Should have raised an exception: "+s,goog.partial(goog.json.parse,s))}error_("Non closed string","\"dasdas");error_("undefined is not valid json","undefined");error_("NaN cannot be presented in JSON","NaN");error_("Infinity cannot be presented in JSON","Infinity");error_("-Infinity cannot be presented in JSON","-Infinity")}function testIsNotValid(){assertFalse(goog.json.isValid("t"));assertFalse(goog.json.isValid("r"));assertFalse(goog.json.isValid("u"));assertFalse(goog.json.isValid("e"));assertFalse(goog.json.isValid("f"));assertFalse(goog.json.isValid("a"));assertFalse(goog.json.isValid("l"));assertFalse(goog.json.isValid("s"));assertFalse(goog.json.isValid("n"));assertFalse(goog.json.isValid("E"));assertFalse(goog.json.isValid("+"));assertFalse(goog.json.isValid("-"));assertFalse(goog.json.isValid("t++"));assertFalse(goog.json.isValid("++t"));assertFalse(goog.json.isValid("t--"));assertFalse(goog.json.isValid("--t"));assertFalse(goog.json.isValid("-t"));assertFalse(goog.json.isValid("+t"));assertFalse(goog.json.isValid("\"\\\""));assertFalse(goog.json.isValid("\"\\"));assertFalse(goog.json.isValid("\"a\\\nb\""));assertFalse(goog.json.isValid("\"\n\""));assertFalse(goog.json.isValid("\"\r\""));assertFalse(goog.json.isValid("\"\r\n\""));assertFalse(goog.json.isValid("\"\u2028\""));assertFalse(goog.json.isValid("\"\u2029\""));assertFalse(goog.json.isValid(" "));assertFalse(goog.json.isValid("\n"));assertFalse(goog.json.isValid("\r"));assertFalse(goog.json.isValid("\r\n"));assertFalse(goog.json.isValid("t.r"));assertFalse(goog.json.isValid("1e"));assertFalse(goog.json.isValid("1e-"));assertFalse(goog.json.isValid("1e+"));assertFalse(goog.json.isValid("1e-"));assertFalse(goog.json.isValid("\"\\\u200D\\\""));assertFalse(goog.json.isValid("\"\\\0\\\""));assertFalse(goog.json.isValid("\"\\\0\""));assertFalse(goog.json.isValid("\"\\0\""));assertFalse(goog.json.isValid("\"\f\""));assertFalse(goog.json.isValid("\"\\\u200D\\\", alert('foo') //\"\n"));assertFalse(goog.json.isValid("truefalse"));assertFalse(goog.json.isValid("null0"));assertFalse(goog.json.isValid("null0.null0"));assertFalse(goog.json.isValid("[truefalse]"));assertFalse(goog.json.isValid("{\"a\": null0}"));assertFalse(goog.json.isValid("{\"a\": null0, \"b\": 1}"))}function testIsValid(){assertTrue(goog.json.isValid("\n\"\"\n"));assertTrue(goog.json.isValid("[1\n,2\r,3\u2028\n,4\u2029]"));assertTrue(goog.json.isValid("\"\x7F\""));assertTrue(goog.json.isValid("\"\t\""));assertTrue(goog.json.isValid("{\"\t\":\"\t\"}"))}function testDoNotSerializeProto(){function F(){};F.prototype={c:3};var obj=new F;obj.a=1;obj.b=2;assertEquals("Should not follow the prototype chain","{\"a\":1,\"b\":2}",goog.json.serialize(obj))}function testEscape(){var unescaped="1a*/]";assertEquals("Should not escape","\""+unescaped+"\"",goog.json.serialize(unescaped));var escaped="\n\x7F\u1049";assertEquals("Should escape","",findCommonChar(escaped,goog.json.serialize(escaped)));assertEquals("Should eval to the same string after escaping",escaped,goog.json.parse(goog.json.serialize(escaped)))}function testReplacer(){assertSerialize("[null,null,0]",[,,0]);assertSerialize("[0,0,{\"x\":0}]",[,,{x:0}],function(k,v){if(v===void 0&&goog.isArray(this)){return 0}return v});assertSerialize("[0,1,2,3]",[0,0,0,0],function(k,v){var kNum=+k;if(k&&!isNaN(kNum)){return kNum}return v});var f=function(k,v){return"number"==typeof v?v+1:v};assertSerialize("{\"a\":1,\"b\":{\"c\":2}}",{a:0,b:{c:1}},f)}function testDateSerialize(){assertSerialize("{}",new Date(0))}function testToJSONSerialize(){assertSerialize("{}",{toJSON:goog.functions.constant("serialized")});assertSerialize("{\"toJSON\":\"normal\"}",{toJSON:"normal"})}function assertSerialize(expected,obj,opt_replacer){assertEquals(expected,goog.json.serialize(obj,opt_replacer));if("string"==typeof obj&&127<obj.charCodeAt(0))return;if(obj===void 0)return;if(goog.isObject(obj)&&"a"in obj&&obj.a===void 0)return;if(opt_replacer&&!goog.userAgent.WEBKIT)return;if(obj instanceof Date)return;if(obj instanceof Function)return;if(goog.isObject(obj)&&goog.isFunction(obj.toJSON))return;if("undefined"!=typeof JSON){assertEquals("goog.json.serialize does not match JSON.stringify",expected,JSON.stringify(obj,opt_replacer))}}function findCommonChar(a,b){for(var i=0;i<b.length;i++){if(0<=a.indexOf(b.charAt(i))){return b.charAt(i)}}return""}