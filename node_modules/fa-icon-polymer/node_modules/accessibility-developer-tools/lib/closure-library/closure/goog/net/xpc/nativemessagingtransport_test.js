goog.provide("goog.net.xpc.NativeMessagingTransportTest");goog.setTestOnly("goog.net.xpc.NativeMessagingTransportTest");goog.require("goog.dom");goog.require("goog.events");goog.require("goog.net.xpc");goog.require("goog.net.xpc.CfgFields");goog.require("goog.net.xpc.CrossPageChannel");goog.require("goog.net.xpc.CrossPageChannelRole");goog.require("goog.net.xpc.NativeMessagingTransport");goog.require("goog.testing.jsunit");function tearDown(){goog.net.xpc.NativeMessagingTransport.activeCount_={};goog.events.removeAll(window.postMessage?window:document,"message")}function testConstructor(){var xpc=getTestChannel(),t=new goog.net.xpc.NativeMessagingTransport(xpc,"http://g.com:80",void 0,!1,2);assertEquals("http://g.com:80",t.peerHostname_);var t=new goog.net.xpc.NativeMessagingTransport(xpc,null,void 0,!1,2);assertEquals("*",t.peerHostname_);t.dispose()}function testConstructorDom(){var xpc=getTestChannel(),t=new goog.net.xpc.NativeMessagingTransport(xpc,"http://g.com:80",goog.dom.getDomHelper(),!1,2);assertEquals("http://g.com:80",t.peerHostname_);var t=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);assertEquals("*",t.peerHostname_);t.dispose()}function testDispose(){var xpc=getTestChannel(),listenedObj=window.postMessage?window:document,t0=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);assertEquals(0,goog.events.removeAll(listenedObj,"message"));t0.dispose();assertEquals(0,goog.events.removeAll(listenedObj,"message"));var t1=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);t1.connect();t1.dispose();assertEquals(0,goog.events.removeAll(listenedObj,"message"));var t2=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2),t3=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);t2.connect();t3.connect();t2.dispose();assertEquals(1,goog.events.removeAll(listenedObj,"message"))}function testDisposeWithDom(){var xpc=getTestChannel(goog.dom.getDomHelper()),listenedObj=window.postMessage?window:document,t0=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);assertEquals(0,goog.events.removeAll(listenedObj,"message"));t0.dispose();assertEquals(0,goog.events.removeAll(listenedObj,"message"));var t1=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);t1.connect();t1.dispose();assertEquals(0,goog.events.removeAll(listenedObj,"message"));var t2=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2),t3=new goog.net.xpc.NativeMessagingTransport(xpc,null,!1,2);t2.connect();t3.connect();t2.dispose();assertEquals(1,goog.events.removeAll(listenedObj,"message"))}function testBogusMessages(){var e=createMockEvent("bogus_message");assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));e=createMockEvent("bogus|message");assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));e=createMockEvent("bogus|message:data");assertFalse(goog.net.xpc.NativeMessagingTransport.messageReceived_(e))}function testSendingMessagesToUnconnectedInnerPeer(){var xpc=getTestChannel(),serviceResult,payloadResult;xpc.xpcDeliver=function(service,payload){serviceResult=service;payloadResult=payload};xpc.getRole=function(){return goog.net.xpc.CrossPageChannelRole.INNER};xpc.isConnected=function(){return!1};var t=new goog.net.xpc.NativeMessagingTransport(xpc,"http://g.com",!1,2),e=createMockEvent("test_channel|test_service:test_payload");assertTrue(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));assertEquals("test_service",serviceResult);assertEquals("test_payload",payloadResult);assertEquals("Ensure channel name has not been changed.","test_channel",t.channel_.name);var e=createMockEvent("new_channel|tp:SETUP");assertTrue(goog.net.xpc.NativeMessagingTransport.messageReceived_(e));assertEquals("tp",serviceResult);assertEquals("SETUP",payloadResult);assertEquals("Ensure channel name has been updated.","new_channel",t.channel_.name);t.dispose()}function testSignalConnected_innerFrame(){checkSignalConnected(!1,!0)}function testSignalConnected_outerFrame(){checkSignalConnected(!1,!1)}function testSignalConnected_singleSided_innerFrame(){checkSignalConnected(!0,!0)}function testSignalConnected_singleSided_outerFrame(){checkSignalConnected(!0,!1)}function checkSignalConnected(oneSidedHandshake,innerFrame,peerProtocolVersion,protocolVersion){var xpc=getTestChannel(),connected=!1;xpc.notifyConnected=function(){if(connected){fail()}else{connected=!0}};xpc.getRole=function(){return innerFrame?goog.net.xpc.CrossPageChannelRole.INNER:goog.net.xpc.CrossPageChannelRole.OUTER};xpc.isConnected=function(){return!1};var transport=new goog.net.xpc.NativeMessagingTransport(xpc,"http://g.com",void 0,oneSidedHandshake,2),sentPayloads=[];transport.send=function(service,payload){assertEquals(goog.net.xpc.TRANSPORT_SERVICE_,service);sentPayloads.push(payload)};function assertSent(payloads){assertArrayEquals(payloads,sentPayloads);sentPayloads=[]}var endpointId=transport.endpointId_,peerEndpointId1="abc123",peerEndpointId2="def234";assertFalse(connected);if(!oneSidedHandshake||innerFrame){transport.transportServiceHandler(goog.net.xpc.SETUP_NTPV2+","+peerEndpointId1);transport.transportServiceHandler(goog.net.xpc.SETUP);assertSent([goog.net.xpc.SETUP_ACK_NTPV2]);assertFalse(connected);transport.transportServiceHandler(goog.net.xpc.SETUP_ACK_NTPV2);assertSent([]);assertTrue(connected)}else{transport.transportServiceHandler(goog.net.xpc.SETUP_ACK_NTPV2);assertSent([]);assertFalse(connected);transport.transportServiceHandler(goog.net.xpc.SETUP_NTPV2+","+peerEndpointId1);transport.transportServiceHandler(goog.net.xpc.SETUP);assertSent([goog.net.xpc.SETUP_ACK_NTPV2]);assertTrue(connected)}transport.transportServiceHandler(goog.net.xpc.SETUP_NTPV2+","+peerEndpointId1);transport.transportServiceHandler(goog.net.xpc.SETUP);assertSent([goog.net.xpc.SETUP_ACK_NTPV2]);transport.transportServiceHandler(goog.net.xpc.SETUP_ACK_NTPV2);assertSent([]);transport.transportServiceHandler(goog.net.xpc.SETUP_NTPV2+","+peerEndpointId2);transport.transportServiceHandler(goog.net.xpc.SETUP);assertSent([goog.net.xpc.SETUP_ACK_NTPV2,goog.net.xpc.SETUP_NTPV2+","+endpointId]);transport.transportServiceHandler(goog.net.xpc.SETUP_ACK_NTPV2);assertSent([])}function createMockEvent(data){var event={getBrowserEvent:function(){return{data:data}}};return event}function getTestChannel(opt_domHelper){var cfg={};cfg[goog.net.xpc.CfgFields.CHANNEL_NAME]="test_channel";return new goog.net.xpc.CrossPageChannel(cfg,opt_domHelper,void 0,!1,2)}