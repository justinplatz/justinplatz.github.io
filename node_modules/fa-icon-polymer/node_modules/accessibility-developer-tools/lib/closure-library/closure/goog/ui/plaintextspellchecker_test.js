goog.provide("goog.ui.PlainTextSpellCheckerTest");goog.setTestOnly("goog.ui.PlainTextSpellCheckerTest");goog.require("goog.Timer");goog.require("goog.dom");goog.require("goog.events.KeyCodes");goog.require("goog.spell.SpellCheck");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.ui.PlainTextSpellChecker");var missspelling="missspelling",iggnore="iggnore",vocabulary=["test","words","a","few",missspelling,iggnore],rseed=1;function random(range){rseed=4294967295&1103515245*rseed+12345;return(32767&rseed>>16)%range}function localSpellCheckingFunction(words,spellChecker,callback){for(var len=words.length,results=[],i=0;i<len;i++){for(var word=words[i],found=!1,j=0;j<vocabulary.length-2;++j){if(vocabulary[j]==word){found=!0;break}}if(found){results.push([word,goog.spell.SpellCheck.WordStatus.VALID])}else{results.push([word,goog.spell.SpellCheck.WordStatus.INVALID,["foo","bar"]])}}callback.call(spellChecker,results)}function generateRandomSpace(){for(var string="",nSpace=1+random(4),i=0;i<nSpace;++i){string+=" "}return string}function generateRandomString(maxWords,doQuotes){var x=random(10),string="";if(doQuotes){if(0==x){string="On xxxxx yyyy wrote:\n> "}else if(3>x){string="> "}}for(var nWords=1+random(maxWords),i=0;i<nWords;++i){string+=vocabulary[random(vocabulary.length)];string+=generateRandomSpace()}return string}var timerQueue=[];function processTimerQueue(){while(0<timerQueue.length){var fn=timerQueue.shift();fn()}}function localTimer(fn,delay,obj){if(obj){fn=goog.bind(fn,obj)}timerQueue.push(fn);return timerQueue.length}function testPlainTextSpellCheckerNoQuotes(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler);s.asyncWordsPerBatch_=100;var el=document.getElementById("test1");s.decorate(el);for(var text="",i=0;10>i;++i){text+=generateRandomString(10,!1)+"\n"}el.value=text;text=el.value;var timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();s.ignoreWord(iggnore);processTimerQueue();s.check();processTimerQueue();s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;assertEquals("Spell checker run should not change the underlying element.",text,el.value);s.dispose()}function testPlainTextSpellCheckerWithQuotes(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler);s.asyncWordsPerBatch_=100;var el=document.getElementById("test2");s.decorate(el);for(var text="",i=0;10>i;++i){text+=generateRandomString(10,!0)+"\n"}el.value=text;text=el.value;var timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.setExcludeMarker(/\nOn .* wrote:\n(> .*\n)+|\n(> .*\n)/g);s.check();processTimerQueue();s.ignoreWord(iggnore);processTimerQueue();s.check();processTimerQueue();s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;assertEquals("Spell checker run should not change the underlying element.",text,el.value);s.dispose()}function testPlainTextSpellCheckerWordReplacement(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler);s.asyncWordsPerBatch_=100;var el=document.getElementById("test3");s.decorate(el);for(var text="",i=0;10>i;++i){text+=generateRandomString(10,!1)+"\n"}el.value=text;var timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_,wordEl=container.firstChild;while(wordEl){if(goog.dom.getTextContent(wordEl)==missspelling){break}wordEl=wordEl.nextSibling}if(!wordEl){assertTrue("Cannot find the world that should have been here."+"Please revise the test",!1);return}s.activeWord_=missspelling;s.activeElement_=wordEl;var suggestions=s.getSuggestions_();s.replaceWord(wordEl,missspelling,"foo");assertEquals("Should have set the original word attribute!",wordEl.getAttribute(goog.ui.AbstractSpellChecker.ORIGINAL_),missspelling);s.activeWord_=goog.dom.getTextContent(wordEl);s.activeElement_=wordEl;var newSuggestions=s.getSuggestions_();assertEquals("Suggestion list should still be present even if the word "+"is now correct!",suggestions,newSuggestions);s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}function testPlainTextSpellCheckerKeyboardNavigateNext(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler),el=document.getElementById("test4");s.decorate(el);var text="a unit test for keyboard test";el.value=text;var keyEventProperties={ctrlKey:!0,shiftKey:!1},timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_;goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);var defaultExecuted=goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);assertFalse("The default action should be prevented for the key event",defaultExecuted);assertEquals("The second misspelled word should have focus.",document.activeElement,container.children[1]);s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}function testPlainTextSpellCheckerKeyboardNavigateNextOnLastWord(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler),el=document.getElementById("test5");s.decorate(el);var text="a unit test for keyboard test";el.value=text;var keyEventProperties={ctrlKey:!0,shiftKey:!1},timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_;goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);var defaultExecuted=goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);assertFalse("The default action should be prevented for the key event",defaultExecuted);assertEquals("The third/last misspelled word should have focus.",document.activeElement,container.children[2]);s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}function testPlainTextSpellCheckerKeyboardNavigateOpenSuggestions(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler),el=document.getElementById("test6");s.decorate(el);var text="unit";el.value=text;var keyEventProperties={ctrlKey:!0,shiftKey:!1},timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_,suggestionMenu=s.getMenu();goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);assertFalse("The suggestion menu should not be visible yet.",suggestionMenu.isVisible());keyEventProperties.ctrlKey=!1;var defaultExecuted=goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.DOWN,keyEventProperties);assertFalse("The default action should be prevented for the key event",defaultExecuted);assertTrue("The suggestion menu should be visible after the key event.",suggestionMenu.isVisible());s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}function testPlainTextSpellCheckerKeyboardNavigatePrevious(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler),el=document.getElementById("test7");s.decorate(el);var text="a unit test for keyboard test";el.value=text;var keyEventProperties={ctrlKey:!0,shiftKey:!1},timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_;goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);var defaultExecuted=goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.LEFT,keyEventProperties);assertFalse("The default action should be prevented for the key event",defaultExecuted);assertEquals("The second misspelled word should have focus.",document.activeElement,container.children[1]);s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}function testPlainTextSpellCheckerKeyboardNavigatePreviousOnFirstWord(){var handler=new goog.spell.SpellCheck(localSpellCheckingFunction),s=new goog.ui.PlainTextSpellChecker(handler),el=document.getElementById("test8");s.decorate(el);var text="a unit test for keyboard test";el.value=text;var keyEventProperties={ctrlKey:!0,shiftKey:!1},timerSav=goog.Timer.callOnce;goog.Timer.callOnce=localTimer;s.check();processTimerQueue();var container=s.overlay_;goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.RIGHT,keyEventProperties);var defaultExecuted=goog.testing.events.fireKeySequence(container,goog.events.KeyCodes.LEFT,keyEventProperties);assertFalse("The default action should be prevented for the key event",defaultExecuted);assertEquals("The first misspelled word should have focus.",document.activeElement,container.children[0]);s.resume();processTimerQueue();goog.Timer.callOnce=timerSav;s.dispose()}