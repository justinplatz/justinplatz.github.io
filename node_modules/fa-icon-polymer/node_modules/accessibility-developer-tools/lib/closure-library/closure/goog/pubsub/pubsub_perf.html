<!DOCTYPE html><html><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Closure Performance Tests - goog.pubsub.PubSub</title><link rel="stylesheet" href="../testing/performancetable.css"><script src="../base.js"></script><script>goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.pubsub.PubSub");goog.require("goog.testing.PerformanceTable");goog.require("goog.testing.PerformanceTimer");goog.require("goog.testing.jsunit");</script></head><body><h1>goog.pubsub.PubSub Performance Tests</h1><p><b>User-agent:</b><script>document.write(navigator.userAgent);</script></p><p>Compares the performance of the event system (<code>goog.events.*</code>) with the <code>goog.pubsub.PubSub</code> class.</p><p>The baseline test creates 1000 event targets and 1000 objects that handle events dispatched by the event targets, and has each event target dispatch 2 events 5 times each.</p><p>The single-<code>PubSub</code> test creates 1000 publishers, 1000 subscribers, and a single pubsub channel. Each subscriber subscribes to topics on the same pubsub channel. Each publisher publishes 5 messages to 2 topics each via the pubsub channel.</p><p>The multi-<code>PubSub</code> test creates 1000 publishers that are subclasses of <code>goog.pubsub.PubSub</code> and 1000 subscribers. Each subscriber subscribes to its own publisher. Each publisher publishes 5 messages to 2 topics each via its own pubsub channel.</p><div id="perfTable"></div><hr><script>var targets,publishers,pubsubs,handlers,SAMPLES_PER_RUN=1e3,table,timer,ACTION="action",CHANGE="change",actionCount=0,changeCount=0;function Handler(){}Handler.prototype.handleAction=function(){actionCount++};Handler.prototype.handleChange=function(){changeCount++};function Publisher(pubsub,id){this.pubsub=pubsub;this.id=id}Publisher.prototype.publish=function(topic){this.pubsub.publish(this.id+"."+topic)};function PubSub(){goog.pubsub.PubSub.call(this)}goog.inherits(PubSub,goog.pubsub.PubSub);function Target(){goog.events.EventTarget.call(this)}goog.inherits(Target,goog.events.EventTarget);Target.prototype.fireEvent=function(type){this.dispatchEvent(type)};function initHandlers(count){for(var i=0;i<count;i++){handlers[i]=new Handler}}function initPublishers(pubsub,count){for(var i=0;i<count;i++){publishers[i]=new Publisher(pubsub,i)}}function initPubSubs(count){for(var i=0;i<count;i++){pubsubs[i]=new PubSub}}function initTargets(count){for(var i=0;i<count;i++){targets[i]=new Target}}function createEventListeners(count){initHandlers(count);initTargets(count);for(var i=0;i<count;i++){goog.events.listen(targets[i],ACTION,Handler.prototype.handleAction,!1,handlers[i]);goog.events.listen(targets[i],CHANGE,Handler.prototype.handleChange,!1,handlers[i])}}function createGlobalSubscriptions(pubsub,count){initHandlers(count);initPublishers(pubsub,count);for(var i=0;i<count;i++){pubsub.subscribe(i+"."+ACTION,Handler.prototype.handleAction,handlers[i]);pubsub.subscribe(i+"."+CHANGE,Handler.prototype.handleChange,handlers[i])}}function createSubscriptions(count){initHandlers(count);initPubSubs(count);for(var i=0;i<count;i++){pubsubs[i].subscribe(ACTION,Handler.prototype.handleAction,handlers[i]);pubsubs[i].subscribe(CHANGE,Handler.prototype.handleChange,handlers[i])}}function dispatchEvents(count){for(var i=0;i<count;i++){for(var j=0;5>j;j++){targets[i].fireEvent(ACTION);targets[i].fireEvent(CHANGE)}}}function publishGlobalMessages(count){for(var i=0;i<count;i++){for(var j=0;5>j;j++){publishers[i].publish(ACTION);publishers[i].publish(CHANGE)}}}function publishMessages(count){for(var i=0;i<count;i++){for(var j=0;5>j;j++){pubsubs[i].publish(ACTION);pubsubs[i].publish(CHANGE)}}}function setUpPage(){timer=new goog.testing.PerformanceTimer;timer.setNumSamples(10);timer.setTimeoutInterval(9e3);timer.setDiscardOutliers(!0);table=new goog.testing.PerformanceTable(goog.dom.getElement("perfTable"),timer)}function setUp(){actionCount=0;changeCount=0;handlers=[];publishers=[];pubsubs=[];targets=[]}function testCreateEventListeners(){table.run(goog.partial(createEventListeners,SAMPLES_PER_RUN),"1A: Create event listeners");assertEquals(0,actionCount);assertEquals(0,changeCount)}function testCreateGlobalSubscriptions(){var pubsub=new goog.pubsub.PubSub;table.run(goog.partial(createGlobalSubscriptions,pubsub,SAMPLES_PER_RUN),"1B: Create global subscriptions");assertEquals(2*(SAMPLES_PER_RUN*timer.getNumSamples()),pubsub.getCount());assertEquals(0,actionCount);assertEquals(0,changeCount);pubsub.dispose()}function testCreateSubscripions(){table.run(goog.partial(createSubscriptions,SAMPLES_PER_RUN),"1C: Create subscriptions");assertEquals(0,actionCount);assertEquals(0,changeCount)}function testDispatchEvents(){createEventListeners(SAMPLES_PER_RUN);table.run(goog.partial(dispatchEvents,SAMPLES_PER_RUN),"2A: Dispatch events");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount)}function testPublishGlobalMessages(){var pubsub=new goog.pubsub.PubSub;createGlobalSubscriptions(pubsub,SAMPLES_PER_RUN);table.run(goog.partial(publishGlobalMessages,SAMPLES_PER_RUN),"2B: Publish global messages");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount);pubsub.dispose()}function testPublishMessages(){createSubscriptions(SAMPLES_PER_RUN);table.run(goog.partial(publishMessages,SAMPLES_PER_RUN),"2C: Publish messages");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount)}function testEvents(){table.run(function(){createEventListeners(SAMPLES_PER_RUN);dispatchEvents(SAMPLES_PER_RUN)},"3A: Events");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount)}function testSinglePubSub(){table.run(function(){var pubsub=new goog.pubsub.PubSub;createGlobalSubscriptions(pubsub,SAMPLES_PER_RUN);publishGlobalMessages(SAMPLES_PER_RUN);pubsub.dispose()},"3B: Single PubSub");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount)}function testMultiPubSub(){table.run(function(){createSubscriptions(SAMPLES_PER_RUN);publishMessages(SAMPLES_PER_RUN)},"3C: Multi PubSub");assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),actionCount);assertEquals(5*(SAMPLES_PER_RUN*timer.getNumSamples()),changeCount)}</script></body></html>