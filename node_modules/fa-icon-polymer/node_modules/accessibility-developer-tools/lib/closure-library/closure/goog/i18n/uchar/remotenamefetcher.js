goog.provide("goog.i18n.uChar.RemoteNameFetcher");goog.require("goog.Disposable");goog.require("goog.Uri");goog.require("goog.events");goog.require("goog.i18n.uChar");goog.require("goog.i18n.uChar.NameFetcher");goog.require("goog.log");goog.require("goog.net.EventType");goog.require("goog.net.XhrIo");goog.require("goog.structs.Map");goog.i18n.uChar.RemoteNameFetcher=function(dataSourceUri){goog.i18n.uChar.RemoteNameFetcher.base(this,"constructor");this.prefetchXhrIo_=new goog.net.XhrIo;this.getNameXhrIo_=new goog.net.XhrIo;this.dataSourceUri_=dataSourceUri;this.charNames_=new goog.structs.Map};goog.inherits(goog.i18n.uChar.RemoteNameFetcher,goog.Disposable);goog.i18n.uChar.RemoteNameFetcher.prototype.prefetchLastListenerKey_;goog.i18n.uChar.RemoteNameFetcher.prototype.getNameLastListenerKey_;goog.i18n.uChar.RemoteNameFetcher.logger_=goog.log.getLogger("goog.i18n.uChar.RemoteNameFetcher");goog.i18n.uChar.RemoteNameFetcher.prototype.disposeInternal=function(){goog.i18n.uChar.RemoteNameFetcher.base(this,"disposeInternal");this.prefetchXhrIo_.dispose();this.getNameXhrIo_.dispose()};goog.i18n.uChar.RemoteNameFetcher.prototype.prefetch=function(characters){if(this.prefetchXhrIo_.isActive()){goog.log.info(goog.i18n.uChar.RemoteNameFetcher.logger_,"Aborted previous prefetch() call for new incoming request");this.prefetchXhrIo_.abort()}if(this.prefetchLastListenerKey_){goog.events.unlistenByKey(this.prefetchLastListenerKey_)}var preFetchCallback=goog.bind(this.prefetchCallback_,this);this.prefetchLastListenerKey_=goog.events.listenOnce(this.prefetchXhrIo_,goog.net.EventType.COMPLETE,preFetchCallback);this.fetch_(goog.i18n.uChar.RemoteNameFetcher.RequestType_.BASE_88,characters,this.prefetchXhrIo_)};goog.i18n.uChar.RemoteNameFetcher.prototype.prefetchCallback_=function(){this.processResponse_(this.prefetchXhrIo_)};goog.i18n.uChar.RemoteNameFetcher.prototype.getName=function(character,callback){var codepoint=goog.i18n.uChar.toCharCode(character).toString(16);if(this.charNames_.containsKey(codepoint)){var name=this.charNames_.get(codepoint);callback(name);return}if(this.getNameXhrIo_.isActive()){goog.log.info(goog.i18n.uChar.RemoteNameFetcher.logger_,"Aborted previous getName() call for new incoming request");this.getNameXhrIo_.abort()}if(this.getNameLastListenerKey_){goog.events.unlistenByKey(this.getNameLastListenerKey_)}var getNameCallback=goog.bind(this.getNameCallback_,this,codepoint,callback);this.getNameLastListenerKey_=goog.events.listenOnce(this.getNameXhrIo_,goog.net.EventType.COMPLETE,getNameCallback);this.fetch_(goog.i18n.uChar.RemoteNameFetcher.RequestType_.CODEPOINT,codepoint,this.getNameXhrIo_)};goog.i18n.uChar.RemoteNameFetcher.prototype.getNameCallback_=function(codepoint,callback){this.processResponse_(this.getNameXhrIo_);var name=this.charNames_.get(codepoint,null);callback(name)};goog.i18n.uChar.RemoteNameFetcher.prototype.processResponse_=function(xhrIo){if(!xhrIo.isSuccess()){goog.log.error(goog.i18n.uChar.RemoteNameFetcher.logger_,"Problem with data source: "+xhrIo.getLastError());return}var result=xhrIo.getResponseJson();for(var codepoint in result){if(result[codepoint].hasOwnProperty("name")){this.charNames_.set(codepoint,result[codepoint].name)}}};goog.i18n.uChar.RemoteNameFetcher.RequestType_={BASE_88:"b88",CODEPOINT:"c"};goog.i18n.uChar.RemoteNameFetcher.prototype.fetch_=function(requestType,requestInput,xhrIo){var url=new goog.Uri(this.dataSourceUri_);url.setParameterValue(requestType,requestInput);url.setParameterValue("p","name");goog.log.info(goog.i18n.uChar.RemoteNameFetcher.logger_,"Request: "+url.toString());xhrIo.send(url)};goog.i18n.uChar.RemoteNameFetcher.prototype.isNameAvailable=function(character){return!0};