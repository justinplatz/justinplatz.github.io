goog.provide("goog.ui.ac.InputHandler");goog.require("goog.Disposable");goog.require("goog.Timer");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.Role");goog.require("goog.a11y.aria.State");goog.require("goog.dom");goog.require("goog.dom.selection");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyHandler");goog.require("goog.string");goog.require("goog.userAgent");goog.require("goog.userAgent.product");goog.ui.ac.InputHandler=function(opt_separators,opt_literals,opt_multi,opt_throttleTime){goog.Disposable.call(this);var throttleTime=opt_throttleTime||150;this.multi_=null!=opt_multi?opt_multi:!0;this.setSeparators(opt_separators||goog.ui.ac.InputHandler.STANDARD_LIST_SEPARATORS);this.literals_=opt_literals||"";this.preventSelectionOnTab_=!1;this.preventDefaultOnTab_=this.multi_;this.timer_=0<throttleTime?new goog.Timer(throttleTime):null;this.eh_=new goog.events.EventHandler(this);this.activateHandler_=new goog.events.EventHandler(this);this.keyHandler_=new goog.events.KeyHandler;this.lastKeyCode_=-1};goog.inherits(goog.ui.ac.InputHandler,goog.Disposable);goog.tagUnsealableClass(goog.ui.ac.InputHandler);goog.ui.ac.InputHandler.REQUIRES_ASYNC_BLUR_=(goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD)&&!goog.userAgent.isVersionOrHigher("533.17.9");goog.ui.ac.InputHandler.STANDARD_LIST_SEPARATORS=",;";goog.ui.ac.InputHandler.QUOTE_LITERALS="\"";goog.ui.ac.InputHandler.prototype.ac_;goog.ui.ac.InputHandler.prototype.separators_;goog.ui.ac.InputHandler.prototype.defaultSeparator_;goog.ui.ac.InputHandler.prototype.trimmer_;goog.ui.ac.InputHandler.prototype.separatorCheck_;goog.ui.ac.InputHandler.prototype.whitespaceWrapEntries_=!0;goog.ui.ac.InputHandler.prototype.generateNewTokenOnLiteral_=!0;goog.ui.ac.InputHandler.prototype.upsideDown_=!1;goog.ui.ac.InputHandler.prototype.separatorUpdates_=!0;goog.ui.ac.InputHandler.prototype.separatorSelects_=!0;goog.ui.ac.InputHandler.prototype.activeTimeoutId_=null;goog.ui.ac.InputHandler.prototype.activeElement_=null;goog.ui.ac.InputHandler.prototype.lastValue_="";goog.ui.ac.InputHandler.prototype.waitingForIme_=!1;goog.ui.ac.InputHandler.prototype.rowJustSelected_=!1;goog.ui.ac.InputHandler.prototype.updateDuringTyping_=!0;goog.ui.ac.InputHandler.prototype.attachAutoComplete=function(ac){this.ac_=ac};goog.ui.ac.InputHandler.prototype.getAutoComplete=function(){return this.ac_};goog.ui.ac.InputHandler.prototype.getActiveElement=function(){return this.activeElement_};goog.ui.ac.InputHandler.prototype.getValue=function(){return this.activeElement_.value};goog.ui.ac.InputHandler.prototype.setValue=function(value){this.activeElement_.value=value};goog.ui.ac.InputHandler.prototype.getCursorPosition=function(){return goog.dom.selection.getStart(this.activeElement_)};goog.ui.ac.InputHandler.prototype.setCursorPosition=function(pos){goog.dom.selection.setStart(this.activeElement_,pos);goog.dom.selection.setEnd(this.activeElement_,pos)};goog.ui.ac.InputHandler.prototype.attachInput=function(target){if(goog.dom.isElement(target)){var el=target;goog.a11y.aria.setRole(el,goog.a11y.aria.Role.COMBOBOX);goog.a11y.aria.setState(el,goog.a11y.aria.State.AUTOCOMPLETE,"list")}this.eh_.listen(target,goog.events.EventType.FOCUS,this.handleFocus);this.eh_.listen(target,goog.events.EventType.BLUR,this.handleBlur);if(!this.activeElement_){this.activateHandler_.listen(target,goog.events.EventType.KEYDOWN,this.onKeyDownOnInactiveElement_);if(goog.dom.isElement(target)){var ownerDocument=goog.dom.getOwnerDocument(target);if(goog.dom.getActiveElement(ownerDocument)==target){this.processFocus(target)}}}};goog.ui.ac.InputHandler.prototype.detachInput=function(target){if(goog.dom.isElement(target)){var el=target;goog.a11y.aria.removeRole(el);goog.a11y.aria.removeState(el,goog.a11y.aria.State.AUTOCOMPLETE)}if(target==this.activeElement_){this.handleBlur()}this.eh_.unlisten(target,goog.events.EventType.FOCUS,this.handleFocus);this.eh_.unlisten(target,goog.events.EventType.BLUR,this.handleBlur);if(!this.activeElement_){this.activateHandler_.unlisten(target,goog.events.EventType.KEYDOWN,this.onKeyDownOnInactiveElement_)}};goog.ui.ac.InputHandler.prototype.attachInputs=function(var_args){for(var i=0;i<arguments.length;i++){this.attachInput(arguments[i])}};goog.ui.ac.InputHandler.prototype.detachInputs=function(var_args){for(var i=0;i<arguments.length;i++){this.detachInput(arguments[i])}};goog.ui.ac.InputHandler.prototype.selectRow=function(row,opt_multi){if(this.activeElement_){this.setTokenText(row.toString(),opt_multi)}return!1};goog.ui.ac.InputHandler.prototype.setTokenText=function(tokenText,opt_multi){if(goog.isDef(opt_multi)?opt_multi:this.multi_){var index=this.getTokenIndex_(this.getValue(),this.getCursorPosition()),entries=this.splitInput_(this.getValue()),replaceValue=tokenText;if(!this.separatorCheck_.test(replaceValue)){replaceValue=goog.string.trimRight(replaceValue)+this.defaultSeparator_}if(this.whitespaceWrapEntries_){if(0!=index&&!goog.string.isEmptyOrWhitespace(entries[index-1])){replaceValue=" "+replaceValue}if(index==entries.length-1){replaceValue=replaceValue+" "}}if(replaceValue!=entries[index]){entries[index]=replaceValue;var el=this.activeElement_;if(goog.userAgent.GECKO||goog.userAgent.IE&&goog.userAgent.isVersionOrHigher("9")){el.blur()}el.value=entries.join("");for(var pos=0,i=0;i<=index;i++){pos+=entries[i].length}el.focus();this.setCursorPosition(pos)}}else{this.setValue(tokenText)}this.rowJustSelected_=!0};goog.ui.ac.InputHandler.prototype.disposeInternal=function(){goog.ui.ac.InputHandler.superClass_.disposeInternal.call(this);if(null!=this.activeTimeoutId_){window.clearTimeout(this.activeTimeoutId_)}this.eh_.dispose();delete this.eh_;this.activateHandler_.dispose();this.keyHandler_.dispose();goog.dispose(this.timer_)};goog.ui.ac.InputHandler.prototype.setSeparators=function(separators,opt_defaultSeparators){this.separators_=separators;this.defaultSeparator_=goog.isDefAndNotNull(opt_defaultSeparators)?opt_defaultSeparators:this.separators_.substring(0,1);var wspaceExp=this.multi_?"[\\s"+this.separators_+"]+":"[\\s]+";this.trimmer_=new RegExp("^"+wspaceExp+"|"+wspaceExp+"$","g");this.separatorCheck_=new RegExp("\\s*["+this.separators_+"]$")};goog.ui.ac.InputHandler.prototype.setUpsideDown=function(upsideDown){this.upsideDown_=upsideDown};goog.ui.ac.InputHandler.prototype.setWhitespaceWrapEntries=function(newValue){this.whitespaceWrapEntries_=newValue};goog.ui.ac.InputHandler.prototype.setGenerateNewTokenOnLiteral=function(newValue){this.generateNewTokenOnLiteral_=newValue};goog.ui.ac.InputHandler.prototype.setTrimmingRegExp=function(trimmer){this.trimmer_=trimmer};goog.ui.ac.InputHandler.prototype.setPreventDefaultOnTab=function(newValue){this.preventDefaultOnTab_=newValue};goog.ui.ac.InputHandler.prototype.setPreventSelectionOnTab=function(newValue){this.preventSelectionOnTab_=newValue};goog.ui.ac.InputHandler.prototype.setSeparatorCompletes=function(newValue){this.separatorUpdates_=newValue;this.separatorSelects_=newValue};goog.ui.ac.InputHandler.prototype.setSeparatorSelects=function(newValue){this.separatorSelects_=newValue};goog.ui.ac.InputHandler.prototype.getThrottleTime=function(){return this.timer_?this.timer_.getInterval():-1};goog.ui.ac.InputHandler.prototype.setRowJustSelected=function(justSelected){this.rowJustSelected_=justSelected};goog.ui.ac.InputHandler.prototype.setThrottleTime=function(time){if(0>time){this.timer_.dispose();this.timer_=null;return}if(this.timer_){this.timer_.setInterval(time)}else{this.timer_=new goog.Timer(time)}};goog.ui.ac.InputHandler.prototype.getUpdateDuringTyping=function(){return this.updateDuringTyping_};goog.ui.ac.InputHandler.prototype.setUpdateDuringTyping=function(value){this.updateDuringTyping_=value};goog.ui.ac.InputHandler.prototype.handleKeyEvent=function(e){switch(e.keyCode){case goog.events.KeyCodes.DOWN:if(this.ac_.isOpen()){this.moveDown_();e.preventDefault();return!0}else if(!this.multi_){this.update(!0);e.preventDefault();return!0}break;case goog.events.KeyCodes.UP:if(this.ac_.isOpen()){this.moveUp_();e.preventDefault();return!0}break;case goog.events.KeyCodes.TAB:if(this.ac_.isOpen()&&!e.shiftKey&&!this.preventSelectionOnTab_){this.update();if(this.ac_.selectHilited()&&this.preventDefaultOnTab_){e.preventDefault();return!0}}else{this.ac_.dismiss()}break;case goog.events.KeyCodes.ENTER:if(this.ac_.isOpen()){this.update();if(this.ac_.selectHilited()){e.preventDefault();e.stopPropagation();return!0}}else{this.ac_.dismiss()}break;case goog.events.KeyCodes.ESC:if(this.ac_.isOpen()){this.ac_.dismiss();e.preventDefault();e.stopPropagation();return!0}break;case goog.events.KeyCodes.WIN_IME:if(!this.waitingForIme_){this.startWaitingForIme_();return!0}break;default:if(this.timer_&&!this.updateDuringTyping_){this.timer_.stop();this.timer_.start()}}return this.handleSeparator_(e)};goog.ui.ac.InputHandler.prototype.handleSeparator_=function(e){var isSeparatorKey=this.multi_&&e.charCode&&-1!=this.separators_.indexOf(String.fromCharCode(e.charCode));if(this.separatorUpdates_&&isSeparatorKey){this.update()}if(this.separatorSelects_&&isSeparatorKey){if(this.ac_.selectHilited()){e.preventDefault();return!0}}return!1};goog.ui.ac.InputHandler.prototype.needKeyUpListener=function(){return!1};goog.ui.ac.InputHandler.prototype.handleKeyUp=function(e){return!1};goog.ui.ac.InputHandler.prototype.addEventHandlers_=function(){this.keyHandler_.attach(this.activeElement_);this.eh_.listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.onKey_);if(this.needKeyUpListener()){this.eh_.listen(this.activeElement_,goog.events.EventType.KEYUP,this.handleKeyUp)}this.eh_.listen(this.activeElement_,goog.events.EventType.MOUSEDOWN,this.onMouseDown_);if(goog.userAgent.IE){this.eh_.listen(this.activeElement_,goog.events.EventType.KEYPRESS,this.onIeKeyPress_)}};goog.ui.ac.InputHandler.prototype.removeEventHandlers_=function(){this.eh_.unlisten(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.onKey_);this.keyHandler_.detach();this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYUP,this.handleKeyUp);this.eh_.unlisten(this.activeElement_,goog.events.EventType.MOUSEDOWN,this.onMouseDown_);if(goog.userAgent.IE){this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYPRESS,this.onIeKeyPress_)}if(this.waitingForIme_){this.stopWaitingForIme_()}};goog.ui.ac.InputHandler.prototype.handleFocus=function(e){this.processFocus(e.target||null)};goog.ui.ac.InputHandler.prototype.processFocus=function(target){this.activateHandler_.removeAll();if(this.ac_){this.ac_.cancelDelayedDismiss()}if(target!=this.activeElement_){this.activeElement_=target;if(this.timer_){this.timer_.start();this.eh_.listen(this.timer_,goog.Timer.TICK,this.onTick_)}this.lastValue_=this.getValue();this.addEventHandlers_()}};goog.ui.ac.InputHandler.prototype.handleBlur=function(opt_e){if(goog.ui.ac.InputHandler.REQUIRES_ASYNC_BLUR_){this.activeTimeoutId_=window.setTimeout(goog.bind(this.processBlur,this),0);return}else{this.processBlur()}};goog.ui.ac.InputHandler.prototype.processBlur=function(){if(this.activeElement_){this.removeEventHandlers_();this.activeElement_=null;if(this.timer_){this.timer_.stop();this.eh_.unlisten(this.timer_,goog.Timer.TICK,this.onTick_)}if(this.ac_){this.ac_.dismissOnDelay()}}};goog.ui.ac.InputHandler.prototype.onTick_=function(e){this.update()};goog.ui.ac.InputHandler.prototype.onKeyDownOnInactiveElement_=function(e){this.handleFocus(e)};goog.ui.ac.InputHandler.prototype.onKey_=function(e){this.lastKeyCode_=e.keyCode;if(this.ac_){this.handleKeyEvent(e)}};goog.ui.ac.InputHandler.prototype.onKeyPress_=function(e){if(this.waitingForIme_&&this.lastKeyCode_!=goog.events.KeyCodes.WIN_IME){this.stopWaitingForIme_()}};goog.ui.ac.InputHandler.prototype.onKeyUp_=function(e){if(this.waitingForIme_&&(e.keyCode==goog.events.KeyCodes.ENTER||e.keyCode==goog.events.KeyCodes.M&&e.ctrlKey)){this.stopWaitingForIme_()}};goog.ui.ac.InputHandler.prototype.onMouseDown_=function(e){if(this.ac_){this.handleMouseDown(e)}};goog.ui.ac.InputHandler.prototype.handleMouseDown=function(e){};goog.ui.ac.InputHandler.prototype.startWaitingForIme_=function(){if(this.waitingForIme_){return}this.eh_.listen(this.activeElement_,goog.events.EventType.KEYUP,this.onKeyUp_);this.eh_.listen(this.activeElement_,goog.events.EventType.KEYPRESS,this.onKeyPress_);this.waitingForIme_=!0};goog.ui.ac.InputHandler.prototype.stopWaitingForIme_=function(){if(!this.waitingForIme_){return}this.waitingForIme_=!1;this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYPRESS,this.onKeyPress_);this.eh_.unlisten(this.activeElement_,goog.events.EventType.KEYUP,this.onKeyUp_)};goog.ui.ac.InputHandler.prototype.onIeKeyPress_=function(e){this.handleSeparator_(e)};goog.ui.ac.InputHandler.prototype.update=function(opt_force){if(this.activeElement_&&(opt_force||this.getValue()!=this.lastValue_)){if(opt_force||!this.rowJustSelected_){var token=this.parseToken();if(this.ac_){this.ac_.setTarget(this.activeElement_);this.ac_.setToken(token,this.getValue())}}this.lastValue_=this.getValue()}this.rowJustSelected_=!1};goog.ui.ac.InputHandler.prototype.parseToken=function(){return this.parseToken_()};goog.ui.ac.InputHandler.prototype.moveUp_=function(){return this.upsideDown_?this.ac_.hiliteNext():this.ac_.hilitePrev()};goog.ui.ac.InputHandler.prototype.moveDown_=function(){return this.upsideDown_?this.ac_.hilitePrev():this.ac_.hiliteNext()};goog.ui.ac.InputHandler.prototype.parseToken_=function(){var caret=this.getCursorPosition(),text=this.getValue();return this.trim_(this.splitInput_(text)[this.getTokenIndex_(text,caret)])};goog.ui.ac.InputHandler.prototype.trim_=function(text){return this.trimmer_?(text+"").replace(this.trimmer_,""):text};goog.ui.ac.InputHandler.prototype.getTokenIndex_=function(text,caret){var entries=this.splitInput_(text);if(caret==text.length)return entries.length-1;for(var current=0,i=0,pos=0;i<entries.length&&pos<=caret;i++){pos+=entries[i].length;current=i}return current};goog.ui.ac.InputHandler.prototype.splitInput_=function(text){if(!this.multi_){return[text]}for(var arr=(text+"").split(""),parts=[],cache=[],i=0,inLiteral=!1;i<arr.length;i++){if(this.literals_&&-1!=this.literals_.indexOf(arr[i])){if(this.generateNewTokenOnLiteral_&&!inLiteral){parts.push(cache.join(""));cache.length=0}cache.push(arr[i]);inLiteral=!inLiteral}else if(!inLiteral&&-1!=this.separators_.indexOf(arr[i])){cache.push(arr[i]);parts.push(cache.join(""));cache.length=0}else{cache.push(arr[i])}}parts.push(cache.join(""));return parts};