goog.provide("goog.net.ImageLoader");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events.EventHandler");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.net.EventType");goog.require("goog.object");goog.require("goog.userAgent");goog.net.ImageLoader=function(opt_parent){goog.events.EventTarget.call(this);this.imageIdToRequestMap_={};this.imageIdToImageMap_={};this.handler_=new goog.events.EventHandler(this);this.parent_=opt_parent};goog.inherits(goog.net.ImageLoader,goog.events.EventTarget);goog.net.ImageLoader.CorsRequestType={ANONYMOUS:"anonymous",USE_CREDENTIALS:"use-credentials"};goog.net.ImageLoader.ImageRequest_;goog.net.ImageLoader.IMAGE_LOAD_EVENTS_=[goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("11")?goog.net.EventType.READY_STATE_CHANGE:goog.events.EventType.LOAD,goog.net.EventType.ABORT,goog.net.EventType.ERROR];goog.net.ImageLoader.prototype.addImage=function(id,image,opt_corsRequestType){var src=goog.isString(image)?image:image.src;if(src){this.imageIdToRequestMap_[id]={src:src,corsRequestType:goog.isDef(opt_corsRequestType)?opt_corsRequestType:null}}};goog.net.ImageLoader.prototype.removeImage=function(id){delete this.imageIdToRequestMap_[id];var image=this.imageIdToImageMap_[id];if(image){delete this.imageIdToImageMap_[id];this.handler_.unlisten(image,goog.net.ImageLoader.IMAGE_LOAD_EVENTS_,this.onNetworkEvent_);if(goog.object.isEmpty(this.imageIdToImageMap_)&&goog.object.isEmpty(this.imageIdToRequestMap_)){this.dispatchEvent(goog.net.EventType.COMPLETE)}}};goog.net.ImageLoader.prototype.start=function(){var imageIdToRequestMap=this.imageIdToRequestMap_;goog.array.forEach(goog.object.getKeys(imageIdToRequestMap),function(id){var imageRequest=imageIdToRequestMap[id];if(imageRequest){delete imageIdToRequestMap[id];this.loadImage_(imageRequest,id)}},this)};goog.net.ImageLoader.prototype.loadImage_=function(imageRequest,id){if(this.isDisposed()){return}var image;if(this.parent_){var dom=goog.dom.getDomHelper(this.parent_);image=dom.createDom(goog.dom.TagName.IMG)}else{image=new Image}if(imageRequest.corsRequestType){image.crossOrigin=imageRequest.corsRequestType}this.handler_.listen(image,goog.net.ImageLoader.IMAGE_LOAD_EVENTS_,this.onNetworkEvent_);this.imageIdToImageMap_[id]=image;image.id=id;image.src=imageRequest.src};goog.net.ImageLoader.prototype.onNetworkEvent_=function(evt){var image=evt.currentTarget;if(!image){return}if(evt.type==goog.net.EventType.READY_STATE_CHANGE){if(image.readyState==goog.net.EventType.COMPLETE){evt.type=goog.events.EventType.LOAD}else{return}}if("undefined"==typeof image.naturalWidth){if(evt.type==goog.events.EventType.LOAD){image.naturalWidth=image.width;image.naturalHeight=image.height}else{image.naturalWidth=0;image.naturalHeight=0}}this.dispatchEvent({type:evt.type,target:image});if(this.isDisposed()){return}this.removeImage(image.id)};goog.net.ImageLoader.prototype.disposeInternal=function(){delete this.imageIdToRequestMap_;delete this.imageIdToImageMap_;goog.dispose(this.handler_);goog.net.ImageLoader.superClass_.disposeInternal.call(this)};