goog.provide("goog.net.JsonpTest");goog.setTestOnly("goog.net.JsonpTest");goog.require("goog.net.Jsonp");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.jsunit");goog.require("goog.testing.recordFunction");goog.require("goog.userAgent");var timeoutWasCalled,timeoutHandler,fakeUrl="http://fake-site.eek/",originalTimeout;function setUp(){timeoutWasCalled=!1;timeoutHandler=null;originalTimeout=window.setTimeout;window.setTimeout=function(handler,time){timeoutWasCalled=!0;timeoutHandler=handler}}var originalOnError=window.onerror;window.onerror=function(msg,url,line){if(goog.userAgent.WEBKIT||"Error loading script"==msg&&-1!=url.indexOf("fake-site")){return!0}else{return originalOnError&&originalOnError(msg,url,line)}};function tearDown(){window.setTimeout=originalTimeout}function newCleanupGuard(){var bodyChildCount=document.body.childNodes.length;return function(){window.setTimeout(function(){var propCounter=0;for(var key in goog.global){if(0==key.indexOf(goog.net.Jsonp.CALLBACKS)){var callbackId=goog.net.Jsonp.getCallbackId_(key);if(goog.global[callbackId]&&goog.global[callbackId]!=goog.nullFunction){propCounter++}}}assertEquals("script cleanup",bodyChildCount,document.body.childNodes.length);assertEquals("window jsonp array empty",0,propCounter)},0)}}function getScriptElement(result){return result.deferred_.defaultScope_.script_}function testSend(){var replyReceived,jsonp=new goog.net.Jsonp(fakeUrl),checkCleanup=newCleanupGuard(),userCallback=function(data){replyReceived=data},payload={atisket:"atasket",basket:"yellow"},result=jsonp.send(payload,userCallback),script=getScriptElement(result);assertNotNull("script created",script);assertEquals("encoding is utf-8","UTF-8",script.charset);assertTrue("payload in url",-1<script.src.indexOf("basket=yellow"));assertTrue("server url",0==script.src.indexOf(fakeUrl));var callbackName=/callback=([^&]+)/.exec(script.src)[1],callbackFunc=eval(callbackName);callbackFunc({some:"data",another:["data","right","here"]},"unexpected");assertEquals("input was received","right",replyReceived.another[1]);timeoutHandler();checkCleanup();timeoutHandler()}function testSendWhenCallbackHasTwoParameters(){var replyReceived,replyReceived2,jsonp=new goog.net.Jsonp(fakeUrl),checkCleanup=newCleanupGuard(),userCallback=function(data,opt_data2){replyReceived=data;replyReceived2=opt_data2},payload={atisket:"atasket",basket:"yellow"},result=jsonp.send(payload,userCallback),script=getScriptElement(result),callbackName=/callback=([^&]+)/.exec(script.src)[1],callbackFunc=eval(callbackName);callbackFunc("param1",{some:"data",another:["data","right","here"]});assertEquals("input was received","param1",replyReceived);assertEquals("second input was received","right",replyReceived2.another[1]);timeoutHandler();checkCleanup();timeoutHandler()}function testSendWithCallbackParamValue(){var replyReceived,jsonp=new goog.net.Jsonp(fakeUrl),checkCleanup=newCleanupGuard(),userCallback=function(data){replyReceived=data},payload={atisket:"atasket",basket:"yellow"},result=jsonp.send(payload,userCallback,void 0,"dummyId"),script=getScriptElement(result);assertNotNull("script created",script);assertEquals("encoding is utf-8","UTF-8",script.charset);assertTrue("payload in url",-1<script.src.indexOf("basket=yellow"));assertTrue("dummyId in url",-1<script.src.indexOf("callback="+goog.net.Jsonp.getCallbackId_("dummyId")));assertTrue("server url",0==script.src.indexOf(fakeUrl));var callbackFunc=eval("callback="+goog.net.Jsonp.getCallbackId_("dummyId"));callbackFunc({some:"data",another:["data","right","here"]});assertEquals("input was received","right",replyReceived.another[1]);timeoutHandler();checkCleanup();timeoutHandler()}function testSendFailure(){var replyReceived=!1,errorReplyReceived=!1,jsonp=new goog.net.Jsonp(fakeUrl),checkCleanup=newCleanupGuard(),userCallback=function(data){replyReceived=data},userErrorCallback=function(data){errorReplyReceived=data},payload={justa:"test"};jsonp.send(payload,userCallback,userErrorCallback);assertTrue("timeout called",timeoutWasCalled);timeoutHandler();timeoutHandler();assertFalse("standard callback not called",replyReceived);assertEquals("error handler called","test",errorReplyReceived.justa);checkCleanup();timeoutHandler()}function testCancel(){var checkCleanup=newCleanupGuard(),successCalled=!1,successCallback=function(){successCalled=!0},jsonp=new goog.net.Jsonp(fakeUrl),requestObject=jsonp.send({test:"foo"},successCallback);jsonp.cancel(requestObject);for(var key in goog.global[goog.net.Jsonp.CALLBACKS]){if(0==key.indexOf("goog.net.Jsonp.CALLBACKS")){var callbackId=goog.net.Jsonp.getCallbackId_(key);assertNotEquals("The success callback should have been removed",goog.global[callbackId],successCallback)}}checkCleanup();timeoutHandler()}function testPayloadParameters(){var checkCleanup=newCleanupGuard(),jsonp=new goog.net.Jsonp(fakeUrl),result=jsonp.send({foo:3,bar:"baz"}),script=getScriptElement(result);assertEquals("Payload parameters should have been added to url.",fakeUrl+"?foo=3&bar=baz",script.src);checkCleanup();timeoutHandler()}function testNonce(){var checkCleanup=newCleanupGuard(),jsonp=new goog.net.Jsonp(fakeUrl);jsonp.setNonce("foo");var result=jsonp.send(),script=getScriptElement(result);assertEquals("Nonce attribute should have been added to script element.","foo",script.getAttribute("nonce"));checkCleanup();timeoutHandler()}function testOptionalPayload(){var checkCleanup=newCleanupGuard(),errorCallback=goog.testing.recordFunction(),stubs=new goog.testing.PropertyReplacer;stubs.set(goog.global,"setTimeout",function(errorHandler){errorHandler()});var jsonp=new goog.net.Jsonp(fakeUrl),result=jsonp.send(null,null,errorCallback),script=getScriptElement(result);assertEquals("Parameters should not have been added to url.",fakeUrl,script.src);script.onload=goog.nullFunction;script.onerror=goog.nullFunction;script.onreadystatechange=goog.nullFunction;var errorCallbackArguments=errorCallback.getLastCall().getArguments();assertEquals(1,errorCallbackArguments.length);assertNull(errorCallbackArguments[0]);checkCleanup();stubs.reset()}