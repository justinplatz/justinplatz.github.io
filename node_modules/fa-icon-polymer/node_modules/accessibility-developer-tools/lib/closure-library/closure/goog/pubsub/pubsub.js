goog.provide("goog.pubsub.PubSub");goog.require("goog.Disposable");goog.require("goog.array");goog.require("goog.async.run");goog.pubsub.PubSub=function(opt_async){goog.pubsub.PubSub.base(this,"constructor");this.key_=1;this.pendingKeys_=[];this.publishDepth_=0;this.subscriptions_=[];this.topics_={};this.async_=!!opt_async};goog.inherits(goog.pubsub.PubSub,goog.Disposable);goog.pubsub.PubSub.prototype.subscribe=function(topic,fn,opt_context){var keys=this.topics_[topic];if(!keys){keys=this.topics_[topic]=[]}var key=this.key_;this.subscriptions_[key]=topic;this.subscriptions_[key+1]=fn;this.subscriptions_[key+2]=opt_context;this.key_=key+3;keys.push(key);return key};goog.pubsub.PubSub.prototype.subscribeOnce=function(topic,fn,opt_context){var called=!1,key=this.subscribe(topic,function(var_args){if(!called){called=!0;this.unsubscribeByKey(key);fn.apply(opt_context,arguments)}},this);return key};goog.pubsub.PubSub.prototype.unsubscribe=function(topic,fn,opt_context){var keys=this.topics_[topic];if(keys){var subscriptions=this.subscriptions_,key=goog.array.find(keys,function(k){return subscriptions[k+1]==fn&&subscriptions[k+2]==opt_context});if(key){return this.unsubscribeByKey(key)}}return!1};goog.pubsub.PubSub.prototype.unsubscribeByKey=function(key){var topic=this.subscriptions_[key];if(topic){var keys=this.topics_[topic];if(0!=this.publishDepth_){this.pendingKeys_.push(key);this.subscriptions_[key+1]=goog.nullFunction}else{if(keys){goog.array.remove(keys,key)}delete this.subscriptions_[key];delete this.subscriptions_[key+1];delete this.subscriptions_[key+2]}}return!!topic};goog.pubsub.PubSub.prototype.publish=function(topic,var_args){var keys=this.topics_[topic];if(keys){for(var args=Array(arguments.length-1),i=1,len=arguments.length;i<len;i++){args[i-1]=arguments[i]}if(this.async_){for(i=0;i<keys.length;i++){var key=keys[i];goog.pubsub.PubSub.runAsync_(this.subscriptions_[key+1],this.subscriptions_[key+2],args)}}else{this.publishDepth_++;try{for(i=0,len=keys.length;i<len;i++){var key=keys[i];this.subscriptions_[key+1].apply(this.subscriptions_[key+2],args)}}finally{this.publishDepth_--;if(0<this.pendingKeys_.length&&0==this.publishDepth_){var pendingKey;while(pendingKey=this.pendingKeys_.pop()){this.unsubscribeByKey(pendingKey)}}}}return 0!=i}return!1};goog.pubsub.PubSub.runAsync_=function(func,context,args){goog.async.run(function(){func.apply(context,args)})};goog.pubsub.PubSub.prototype.clear=function(opt_topic){if(opt_topic){var keys=this.topics_[opt_topic];if(keys){goog.array.forEach(keys,this.unsubscribeByKey,this);delete this.topics_[opt_topic]}}else{this.subscriptions_.length=0;this.topics_={}}};goog.pubsub.PubSub.prototype.getCount=function(opt_topic){if(opt_topic){var keys=this.topics_[opt_topic];return keys?keys.length:0}var count=0;for(var topic in this.topics_){count+=this.getCount(topic)}return count};goog.pubsub.PubSub.prototype.disposeInternal=function(){goog.pubsub.PubSub.base(this,"disposeInternal");this.clear();this.pendingKeys_.length=0};