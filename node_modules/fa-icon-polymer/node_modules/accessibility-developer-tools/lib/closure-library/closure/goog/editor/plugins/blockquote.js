goog.provide("goog.editor.plugins.Blockquote");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.TagName");goog.require("goog.dom.classlist");goog.require("goog.editor.BrowserFeature");goog.require("goog.editor.Command");goog.require("goog.editor.Plugin");goog.require("goog.editor.node");goog.require("goog.functions");goog.require("goog.log");goog.editor.plugins.Blockquote=function(requiresClassNameToSplit,opt_className){goog.editor.Plugin.call(this);this.requiresClassNameToSplit_=requiresClassNameToSplit;this.className_=opt_className||goog.getCssName("tr_bq")};goog.inherits(goog.editor.plugins.Blockquote,goog.editor.Plugin);goog.editor.plugins.Blockquote.SPLIT_COMMAND="+splitBlockquote";goog.editor.plugins.Blockquote.CLASS_ID="Blockquote";goog.editor.plugins.Blockquote.prototype.logger=goog.log.getLogger("goog.editor.plugins.Blockquote");goog.editor.plugins.Blockquote.prototype.getTrogClassId=function(){return goog.editor.plugins.Blockquote.CLASS_ID};goog.editor.plugins.Blockquote.prototype.isSilentCommand=goog.functions.TRUE;goog.editor.plugins.Blockquote.prototype.isSplittableBlockquote=function(node){if(node.tagName!=goog.dom.TagName.BLOCKQUOTE){return!1}if(!this.requiresClassNameToSplit_){return!0}return goog.dom.classlist.contains(node,this.className_)};goog.editor.plugins.Blockquote.prototype.isSetupBlockquote=function(node){return node.tagName==goog.dom.TagName.BLOCKQUOTE&&goog.dom.classlist.contains(node,this.className_)};goog.editor.plugins.Blockquote.prototype.isUnsetupBlockquote=function(node){return node.tagName==goog.dom.TagName.BLOCKQUOTE&&!this.isSetupBlockquote(node)};goog.editor.plugins.Blockquote.prototype.getBlockquoteClassName=function(){return this.className_};goog.editor.plugins.Blockquote.findAndRemoveSingleChildAncestor_=function(node,root){var predicateFunc=function(parentNode){return parentNode!=root&&1==parentNode.childNodes.length},ancestor=goog.editor.node.findHighestMatchingAncestor(node,predicateFunc);if(!ancestor){ancestor=node}goog.dom.removeNode(ancestor)};goog.editor.plugins.Blockquote.removeAllWhiteSpaceNodes_=function(nodes){for(var i=0;i<nodes.length;++i){if(goog.editor.node.isEmpty(nodes[i],!0)){goog.dom.removeNode(nodes[i])}}};goog.editor.plugins.Blockquote.prototype.isSupportedCommand=function(command){return command==goog.editor.plugins.Blockquote.SPLIT_COMMAND};goog.editor.plugins.Blockquote.prototype.execCommandInternal=function(command,var_args){var pos=arguments[1];if(command==goog.editor.plugins.Blockquote.SPLIT_COMMAND&&pos&&(this.className_||!this.requiresClassNameToSplit_)){return goog.editor.BrowserFeature.HAS_W3C_RANGES?this.splitQuotedBlockW3C_(pos):this.splitQuotedBlockIE_(pos)}};goog.editor.plugins.Blockquote.prototype.splitQuotedBlockW3C_=function(anchorPos){var cursorNode=anchorPos.node,quoteNode=goog.editor.node.findTopMostEditableAncestor(cursorNode.parentNode,goog.bind(this.isSplittableBlockquote,this)),secondHalf,textNodeToRemove,insertTextNode=!1;if(quoteNode){if(cursorNode.nodeType==goog.dom.NodeType.TEXT){if(anchorPos.offset==cursorNode.length){var siblingNode=cursorNode.nextSibling;if(siblingNode&&siblingNode.tagName==goog.dom.TagName.BR){cursorNode=siblingNode;secondHalf=siblingNode.nextSibling}else{textNodeToRemove=cursorNode.splitText(anchorPos.offset);secondHalf=textNodeToRemove}}else{secondHalf=cursorNode.splitText(anchorPos.offset)}}else if(cursorNode.tagName==goog.dom.TagName.BR){secondHalf=cursorNode.nextSibling}else{insertTextNode=!0}}else{if(this.isSetupBlockquote(cursorNode)){quoteNode=cursorNode;insertTextNode=!0}}if(insertTextNode){cursorNode=this.insertEmptyTextNodeBeforeRange_();secondHalf=this.insertEmptyTextNodeBeforeRange_()}if(!quoteNode){return!1}secondHalf=goog.editor.node.splitDomTreeAt(cursorNode,secondHalf,quoteNode);goog.dom.insertSiblingAfter(secondHalf,quoteNode);var dh=this.getFieldDomHelper(),tagToInsert=this.getFieldObject().queryCommandValue(goog.editor.Command.DEFAULT_TAG)||goog.dom.TagName.DIV,container=dh.createElement(tagToInsert);container.innerHTML="&nbsp;";quoteNode.parentNode.insertBefore(container,secondHalf);dh.getWindow().getSelection().collapse(container,0);if(textNodeToRemove){goog.editor.plugins.Blockquote.findAndRemoveSingleChildAncestor_(textNodeToRemove,secondHalf)}goog.editor.plugins.Blockquote.removeAllWhiteSpaceNodes_([quoteNode,secondHalf]);return!0};goog.editor.plugins.Blockquote.prototype.insertEmptyTextNodeBeforeRange_=function(){var range=this.getFieldObject().getRange(),node=this.getFieldDomHelper().createTextNode("");range.insertNode(node,!0);return node};goog.editor.plugins.Blockquote.prototype.splitQuotedBlockIE_=function(splitNode){var dh=this.getFieldDomHelper(),quoteNode=goog.editor.node.findTopMostEditableAncestor(splitNode.parentNode,goog.bind(this.isSplittableBlockquote,this));if(!quoteNode){return!1}var clone=splitNode.cloneNode(!1);if(splitNode.nextSibling&&splitNode.nextSibling.tagName==goog.dom.TagName.BR){splitNode=splitNode.nextSibling}var secondHalf=goog.editor.node.splitDomTreeAt(splitNode,clone,quoteNode);goog.dom.insertSiblingAfter(secondHalf,quoteNode);var tagToInsert=this.getFieldObject().queryCommandValue(goog.editor.Command.DEFAULT_TAG)||goog.dom.TagName.DIV,div=dh.createElement(tagToInsert);quoteNode.parentNode.insertBefore(div,secondHalf);div.innerHTML="&nbsp;";var range=dh.getDocument().selection.createRange();range.moveToElementText(splitNode);range.move("character",2);range.select();goog.dom.removeChildren(div);range.pasteHTML("");goog.editor.plugins.Blockquote.findAndRemoveSingleChildAncestor_(clone,secondHalf);goog.editor.plugins.Blockquote.removeAllWhiteSpaceNodes_([quoteNode,secondHalf]);return!0};