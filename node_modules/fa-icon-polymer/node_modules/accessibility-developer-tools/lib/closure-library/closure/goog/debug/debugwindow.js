goog.provide("goog.debug.DebugWindow");goog.require("goog.debug.HtmlFormatter");goog.require("goog.debug.LogManager");goog.require("goog.debug.Logger");goog.require("goog.dom.safe");goog.require("goog.html.SafeHtml");goog.require("goog.html.SafeStyleSheet");goog.require("goog.string.Const");goog.require("goog.structs.CircularBuffer");goog.require("goog.userAgent");goog.debug.DebugWindow=function(opt_identifier,opt_prefix){this.identifier=opt_identifier||"";this.outputBuffer=[];this.prefix_=opt_prefix||"";this.savedMessages_=new goog.structs.CircularBuffer(goog.debug.DebugWindow.MAX_SAVED);this.publishHandler_=goog.bind(this.addLogRecord,this);this.formatter_=new goog.debug.HtmlFormatter(this.prefix_);this.filteredLoggers_={};this.setCapturing(!0);this.enabled_=goog.debug.DebugWindow.isEnabled(this.identifier);goog.global.setInterval(goog.bind(this.saveWindowPositionSize_,this),7500)};goog.debug.DebugWindow.MAX_SAVED=500;goog.debug.DebugWindow.COOKIE_TIME=1e3*(60*(60*(24*30)));goog.debug.DebugWindow.prototype.welcomeMessage="LOGGING";goog.debug.DebugWindow.prototype.enableOnSevere_=!1;goog.debug.DebugWindow.prototype.win=null;goog.debug.DebugWindow.prototype.winOpening_=!1;goog.debug.DebugWindow.prototype.isCapturing_=!1;goog.debug.DebugWindow.showedBlockedAlert_=!1;goog.debug.DebugWindow.prototype.bufferTimeout_=null;goog.debug.DebugWindow.prototype.lastCall=goog.now();goog.debug.DebugWindow.prototype.setWelcomeMessage=function(msg){this.welcomeMessage=msg};goog.debug.DebugWindow.prototype.init=function(){if(this.enabled_){this.openWindow_()}};goog.debug.DebugWindow.prototype.isEnabled=function(){return this.enabled_};goog.debug.DebugWindow.prototype.setEnabled=function(enable){this.enabled_=enable;if(this.enabled_){this.openWindow_()}this.setCookie_("enabled",enable?"1":"0")};goog.debug.DebugWindow.prototype.setForceEnableOnSevere=function(enableOnSevere){this.enableOnSevere_=enableOnSevere};goog.debug.DebugWindow.prototype.isCapturing=function(){return this.isCapturing_};goog.debug.DebugWindow.prototype.setCapturing=function(capturing){if(capturing==this.isCapturing_){return}this.isCapturing_=capturing;var rootLogger=goog.debug.LogManager.getRoot();if(capturing){rootLogger.addHandler(this.publishHandler_)}else{rootLogger.removeHandler(this.publishHandler_)}};goog.debug.DebugWindow.prototype.getFormatter=function(){return this.formatter_};goog.debug.DebugWindow.prototype.setFormatter=function(formatter){this.formatter_=formatter};goog.debug.DebugWindow.prototype.addSeparator=function(){this.write_(goog.html.SafeHtml.create("hr"))};goog.debug.DebugWindow.prototype.hasActiveWindow=function(){return!!this.win&&!this.win.closed};goog.debug.DebugWindow.prototype.clear=function(){this.savedMessages_.clear();if(this.hasActiveWindow()){this.writeInitialDocument()}};goog.debug.DebugWindow.prototype.addLogRecord=function(logRecord){if(this.filteredLoggers_[logRecord.getLoggerName()]){return}var html=this.formatter_.formatRecordAsHtml(logRecord);this.write_(html);if(this.enableOnSevere_&&logRecord.getLevel().value>=goog.debug.Logger.Level.SEVERE.value){this.setEnabled(!0)}};goog.debug.DebugWindow.prototype.write_=function(html){if(this.enabled_){this.openWindow_();this.savedMessages_.add(html);this.writeToLog_(html)}else{this.savedMessages_.add(html)}};goog.debug.DebugWindow.prototype.writeToLog_=function(html){this.outputBuffer.push(html);goog.global.clearTimeout(this.bufferTimeout_);if(750<goog.now()-this.lastCall){this.writeBufferToLog()}else{this.bufferTimeout_=goog.global.setTimeout(goog.bind(this.writeBufferToLog,this),250)}};goog.debug.DebugWindow.prototype.writeBufferToLog=function(){this.lastCall=goog.now();if(this.hasActiveWindow()){var body=this.win.document.body,scroll=body&&100>=body.scrollHeight-(body.scrollTop+body.clientHeight);goog.dom.safe.documentWrite(this.win.document,goog.html.SafeHtml.concat(this.outputBuffer));this.outputBuffer.length=0;if(scroll){this.win.scrollTo(0,1e6)}}};goog.debug.DebugWindow.prototype.writeSavedMessages=function(){for(var messages=this.savedMessages_.getValues(),i=0;i<messages.length;i++){this.writeToLog_(messages[i])}};goog.debug.DebugWindow.prototype.openWindow_=function(){if(this.hasActiveWindow()||this.winOpening_){return}var winpos=this.getCookie_("dbg","0,0,800,500").split(","),x=+winpos[0],y=+winpos[1],w=+winpos[2],h=+winpos[3];this.winOpening_=!0;this.win=window.open("",this.getWindowName_(),"width="+w+",height="+h+",toolbar=no,resizable=yes,"+"scrollbars=yes,left="+x+",top="+y+",status=no,screenx="+x+",screeny="+y);if(!this.win){if(!goog.debug.DebugWindow.showedBlockedAlert_){alert("Logger popup was blocked");goog.debug.DebugWindow.showedBlockedAlert_=!0}}this.winOpening_=!1;if(this.win){this.writeInitialDocument()}};goog.debug.DebugWindow.prototype.getWindowName_=function(){return goog.userAgent.IE?this.identifier.replace(/[\s\-\.\,]/g,"_"):this.identifier};goog.debug.DebugWindow.prototype.getStyleRules=function(){return goog.html.SafeStyleSheet.fromConstant(goog.string.Const.from("*{font:normal 14px monospace;}"+".dbg-sev{color:#F00}"+".dbg-w{color:#E92}"+".dbg-sh{background-color:#fd4;font-weight:bold;color:#000}"+".dbg-i{color:#666}"+".dbg-f{color:#999}"+".dbg-ev{color:#0A0}"+".dbg-m{color:#990}"))};goog.debug.DebugWindow.prototype.writeInitialDocument=function(){if(!this.hasActiveWindow()){return}this.win.document.open();var div=goog.html.SafeHtml.create("div",{class:"dbg-ev",style:goog.string.Const.from("text-align:center;")},goog.html.SafeHtml.concat(this.welcomeMessage,goog.html.SafeHtml.BR,goog.html.SafeHtml.create("small",{},"Logger: "+this.identifier))),html=goog.html.SafeHtml.concat(goog.html.SafeHtml.createStyle(this.getStyleRules()),goog.html.SafeHtml.create("hr"),div,goog.html.SafeHtml.create("hr"));this.writeToLog_(html);this.writeSavedMessages()};goog.debug.DebugWindow.prototype.setCookie_=function(key,value){var fullKey=goog.debug.DebugWindow.getCookieKey_(this.identifier,key);document.cookie=fullKey+"="+encodeURIComponent(value)+";path=/;expires="+new Date(goog.now()+goog.debug.DebugWindow.COOKIE_TIME).toUTCString()};goog.debug.DebugWindow.prototype.getCookie_=function(key,opt_default){return goog.debug.DebugWindow.getCookieValue_(this.identifier,key,opt_default)};goog.debug.DebugWindow.getCookieKey_=function(identifier,key){var fullKey=key+identifier;return fullKey.replace(/[;=\s]/g,"_")};goog.debug.DebugWindow.getCookieValue_=function(identifier,key,opt_default){var fullKey=goog.debug.DebugWindow.getCookieKey_(identifier,key),cookie=document.cookie+"",start=cookie.indexOf(fullKey+"=");if(-1!=start){var end=cookie.indexOf(";",start);return decodeURIComponent(cookie.substring(start+fullKey.length+1,-1==end?cookie.length:end))}else{return opt_default||""}};goog.debug.DebugWindow.isEnabled=function(identifier){return"1"==goog.debug.DebugWindow.getCookieValue_(identifier,"enabled")};goog.debug.DebugWindow.prototype.saveWindowPositionSize_=function(){if(!this.hasActiveWindow()){return}var x=this.win.screenX||this.win.screenLeft||0,y=this.win.screenY||this.win.screenTop||0,w=this.win.outerWidth||800,h=this.win.outerHeight||500;this.setCookie_("dbg",x+","+y+","+w+","+h)};goog.debug.DebugWindow.prototype.addFilter=function(loggerName){this.filteredLoggers_[loggerName]=1};goog.debug.DebugWindow.prototype.removeFilter=function(loggerName){delete this.filteredLoggers_[loggerName]};goog.debug.DebugWindow.prototype.resetBufferWithNewSize=function(size){if(0<size&&5e4>size){this.clear();this.savedMessages_=new goog.structs.CircularBuffer(size)}};