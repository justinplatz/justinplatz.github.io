goog.provide("goog.proto2.TextFormatSerializer");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.json");goog.require("goog.math");goog.require("goog.object");goog.require("goog.proto2.FieldDescriptor");goog.require("goog.proto2.Message");goog.require("goog.proto2.Serializer");goog.require("goog.string");goog.proto2.TextFormatSerializer=function(opt_ignoreMissingFields,opt_useEnumValues){this.ignoreMissingFields_=!!opt_ignoreMissingFields;this.useEnumValues_=!!opt_useEnumValues};goog.inherits(goog.proto2.TextFormatSerializer,goog.proto2.Serializer);goog.proto2.TextFormatSerializer.prototype.deserializeTo=function(message,data){var descriptor=message.getDescriptor(),textData=data.toString(),parser=new goog.proto2.TextFormatSerializer.Parser;if(!parser.parse(message,textData,this.ignoreMissingFields_)){return parser.getError()}return null};goog.proto2.TextFormatSerializer.prototype.serialize=function(message){var printer=new goog.proto2.TextFormatSerializer.Printer_;this.serializeMessage_(message,printer);return printer.toString()};goog.proto2.TextFormatSerializer.prototype.serializeMessage_=function(message,printer){var descriptor=message.getDescriptor(),fields=descriptor.getFields();goog.array.forEach(fields,function(field){this.printField_(message,field,printer)},this);message.forEachUnknown(function(tag,value){this.serializeUnknown_(tag,value,goog.asserts.assert(printer))},this)};goog.proto2.TextFormatSerializer.prototype.serializeUnknown_=function(tag,value,printer){if(!goog.isDefAndNotNull(value)){return}if(goog.isArray(value)){goog.array.forEach(value,function(val){this.serializeUnknown_(tag,val,printer)},this);return}if(goog.isObject(value)){printer.append(tag);printer.append(" {");printer.appendLine();printer.indent();if(value instanceof goog.proto2.Message){this.serializeMessage_(value,printer)}else{for(var key in value){var keyAsNumber=goog.string.parseInt(key);goog.asserts.assert(goog.math.isInt(keyAsNumber));this.serializeUnknown_(keyAsNumber,value[key],printer)}}printer.dedent();printer.append("}");printer.appendLine();return}if(goog.isString(value)){value=goog.string.quote(value)}printer.append(tag);printer.append(": ");printer.append(value.toString());printer.appendLine()};goog.proto2.TextFormatSerializer.prototype.printFieldValue_=function(value,field,printer){switch(field.getFieldType()){case goog.proto2.FieldDescriptor.FieldType.DOUBLE:case goog.proto2.FieldDescriptor.FieldType.FLOAT:case goog.proto2.FieldDescriptor.FieldType.INT64:case goog.proto2.FieldDescriptor.FieldType.UINT64:case goog.proto2.FieldDescriptor.FieldType.INT32:case goog.proto2.FieldDescriptor.FieldType.UINT32:case goog.proto2.FieldDescriptor.FieldType.FIXED64:case goog.proto2.FieldDescriptor.FieldType.FIXED32:case goog.proto2.FieldDescriptor.FieldType.BOOL:case goog.proto2.FieldDescriptor.FieldType.SFIXED32:case goog.proto2.FieldDescriptor.FieldType.SFIXED64:case goog.proto2.FieldDescriptor.FieldType.SINT32:case goog.proto2.FieldDescriptor.FieldType.SINT64:printer.append(value);break;case goog.proto2.FieldDescriptor.FieldType.BYTES:case goog.proto2.FieldDescriptor.FieldType.STRING:value=goog.string.quote(value.toString());printer.append(value);break;case goog.proto2.FieldDescriptor.FieldType.ENUM:if(!this.useEnumValues_){var found=!1;goog.object.forEach(field.getNativeType(),function(eValue,key){if(!found&&eValue==value){printer.append(key);found=!0}})}if(!found||this.useEnumValues_){printer.append(value.toString())}break;case goog.proto2.FieldDescriptor.FieldType.GROUP:case goog.proto2.FieldDescriptor.FieldType.MESSAGE:this.serializeMessage_(value,printer);break;}};goog.proto2.TextFormatSerializer.prototype.printField_=function(message,field,printer){if(!message.has(field)){return}for(var count=message.countOf(field),i=0;i<count;++i){printer.append(field.getName());if(field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP){printer.append(" {");printer.appendLine();printer.indent()}else{printer.append(": ")}this.printFieldValue_(message.get(field,i),field,printer);if(field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP){printer.dedent();printer.append("}");printer.appendLine()}else{printer.appendLine()}}};goog.proto2.TextFormatSerializer.Printer_=function(){this.indentation_=0;this.buffer_=[];this.requiresIndentation_=!0};goog.proto2.TextFormatSerializer.Printer_.prototype.toString=function(){return this.buffer_.join("")};goog.proto2.TextFormatSerializer.Printer_.prototype.indent=function(){this.indentation_+=2};goog.proto2.TextFormatSerializer.Printer_.prototype.dedent=function(){this.indentation_-=2;goog.asserts.assert(0<=this.indentation_)};goog.proto2.TextFormatSerializer.Printer_.prototype.append=function(value){if(this.requiresIndentation_){for(var i=0;i<this.indentation_;++i){this.buffer_.push(" ")}this.requiresIndentation_=!1}this.buffer_.push(value.toString())};goog.proto2.TextFormatSerializer.Printer_.prototype.appendLine=function(){this.buffer_.push("\n");this.requiresIndentation_=!0};goog.proto2.TextFormatSerializer.Tokenizer_=function(data,opt_ignoreWhitespace,opt_ignoreComments){this.ignoreWhitespace_=!!opt_ignoreWhitespace;this.ignoreComments_=!!opt_ignoreComments;this.data_=data;this.index_=0;this.currentData_=data;this.current_={type:goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes.END,value:null}};goog.proto2.TextFormatSerializer.Tokenizer_.Token;goog.proto2.TextFormatSerializer.Tokenizer_.prototype.getCurrent=function(){return this.current_};goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes={END:/---end---/,IDENTIFIER:/^-?[a-zA-Z][a-zA-Z0-9_]*/,NUMBER:/^(0x[0-9a-f]+)|(([-])?[0-9][0-9]*(\.?[0-9]+)?(e[+-]?[0-9]+|[f])?)/,COMMENT:/^#.*/,OPEN_BRACE:/^{/,CLOSE_BRACE:/^}/,OPEN_TAG:/^</,CLOSE_TAG:/^>/,OPEN_LIST:/^\[/,CLOSE_LIST:/^\]/,STRING:/^"([^"\\]|\\.)*"/,COLON:/^:/,COMMA:/^,/,SEMI:/^;/,WHITESPACE:/^\s/};goog.proto2.TextFormatSerializer.Tokenizer_.prototype.next=function(){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;while(this.nextInternal_()){var type=this.getCurrent().type;if(type!=types.WHITESPACE&&type!=types.COMMENT||type==types.WHITESPACE&&!this.ignoreWhitespace_||type==types.COMMENT&&!this.ignoreComments_){return!0}}this.current_={type:goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes.END,value:null};return!1};goog.proto2.TextFormatSerializer.Tokenizer_.prototype.nextInternal_=function(){if(this.index_>=this.data_.length){return!1}var data=this.currentData_,types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes,next=null;goog.object.some(types,function(type,id){if(next||type==types.END){return!1}var info=type.exec(data);if(info&&0==info.index){next={type:type,value:info[0]}}return!!next});if(next){this.current_=next;this.index_+=next.value.length;this.currentData_=this.currentData_.substring(next.value.length)}return!!next};goog.proto2.TextFormatSerializer.Parser=function(){this.error_=null;this.tokenizer_=null;this.ignoreMissingFields_=!1};goog.proto2.TextFormatSerializer.Parser.prototype.parse=function(message,data,opt_ignoreMissingFields){this.error_=null;this.ignoreMissingFields_=!!opt_ignoreMissingFields;this.tokenizer_=new goog.proto2.TextFormatSerializer.Tokenizer_(data,!0,!0);this.tokenizer_.next();return this.consumeMessage_(message,"")};goog.proto2.TextFormatSerializer.Parser.prototype.getError=function(){return this.error_};goog.proto2.TextFormatSerializer.Parser.prototype.reportError_=function(msg){this.error_=msg};goog.proto2.TextFormatSerializer.Parser.prototype.consumeMessage_=function(message,delimiter){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;while(!this.lookingAt_(">")&&!this.lookingAt_("}")&&!this.lookingAtType_(types.END)){if(!this.consumeField_(message)){return!1}}if(delimiter){if(!this.consume_(delimiter)){return!1}}else{if(!this.lookingAtType_(types.END)){this.reportError_("Expected END token")}}return!0};goog.proto2.TextFormatSerializer.Parser.prototype.consumeFieldValue_=function(message,field){var value=this.getFieldValue_(field);if(goog.isNull(value)){return!1}if(field.isRepeated()){message.add(field,value)}else{message.set(field,value)}return!0};goog.proto2.TextFormatSerializer.Parser.getNumberFromString_=function(num){var returnValue=goog.string.contains(num,".")?parseFloat(num):goog.string.parseInt(num);goog.asserts.assert(!isNaN(returnValue));goog.asserts.assert(isFinite(returnValue));return returnValue};goog.proto2.TextFormatSerializer.Parser.parseNumericalConstant_=function(identifier){if(/^-?inf(?:inity)?f?$/i.test(identifier)){return 1/0*(goog.string.startsWith(identifier,"-")?-1:1)}if(/^nanf?$/i.test(identifier)){return NaN}return null};goog.proto2.TextFormatSerializer.Parser.prototype.getFieldValue_=function(field){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;switch(field.getFieldType()){case goog.proto2.FieldDescriptor.FieldType.DOUBLE:case goog.proto2.FieldDescriptor.FieldType.FLOAT:var identifier=this.consumeIdentifier_();if(identifier){var numericalIdentifier=goog.proto2.TextFormatSerializer.Parser.parseNumericalConstant_(identifier);if(goog.isDefAndNotNull(numericalIdentifier)){return numericalIdentifier}}case goog.proto2.FieldDescriptor.FieldType.INT32:case goog.proto2.FieldDescriptor.FieldType.UINT32:case goog.proto2.FieldDescriptor.FieldType.FIXED32:case goog.proto2.FieldDescriptor.FieldType.SFIXED32:case goog.proto2.FieldDescriptor.FieldType.SINT32:var num=this.consumeNumber_();if(!num){return null}return goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(num);case goog.proto2.FieldDescriptor.FieldType.INT64:case goog.proto2.FieldDescriptor.FieldType.UINT64:case goog.proto2.FieldDescriptor.FieldType.FIXED64:case goog.proto2.FieldDescriptor.FieldType.SFIXED64:case goog.proto2.FieldDescriptor.FieldType.SINT64:var num=this.consumeNumber_();if(!num){return null}if(field.getNativeType()==Number){return goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(num)}return num;case goog.proto2.FieldDescriptor.FieldType.BOOL:var ident=this.consumeIdentifier_();if(!ident){return null}switch(ident){case"true":return!0;case"false":return!1;default:this.reportError_("Unknown type for bool: "+ident);return null;}case goog.proto2.FieldDescriptor.FieldType.ENUM:if(this.lookingAtType_(types.NUMBER)){var num=this.consumeNumber_();if(!num){return null}return goog.proto2.TextFormatSerializer.Parser.getNumberFromString_(num)}else{var name=this.consumeIdentifier_();if(!name){return null}var enumValue=field.getNativeType()[name];if(null==enumValue){this.reportError_("Unknown enum value: "+name);return null}return enumValue}case goog.proto2.FieldDescriptor.FieldType.BYTES:case goog.proto2.FieldDescriptor.FieldType.STRING:return this.consumeString_();}};goog.proto2.TextFormatSerializer.Parser.prototype.consumeNestedMessage_=function(message,field){var delimiter="";if(this.tryConsume_("<")){delimiter=">"}else{if(!this.consume_("{")){return!1}delimiter="}"}var msg=field.getFieldMessageType().createMessageInstance(),result=this.consumeMessage_(msg,delimiter);if(!result){return!1}if(field.isRepeated()){message.add(field,msg)}else{message.set(field,msg)}return!0};goog.proto2.TextFormatSerializer.Parser.prototype.consumeUnknownFieldValue_=function(){this.tryConsume_(":");if(this.tryConsume_("[")){while(!0){this.tokenizer_.next();if(this.tryConsume_("]")){break}if(!this.consume_(",")){return!1}}return!0}if(this.tryConsume_("<")){return this.consumeMessage_(null,">")}else if(this.tryConsume_("{")){return this.consumeMessage_(null,"}")}else{this.tokenizer_.next()}return!0};goog.proto2.TextFormatSerializer.Parser.prototype.consumeField_=function(message){var fieldName=this.consumeIdentifier_();if(!fieldName){this.reportError_("Missing field name");return!1}var field=null;if(message){field=message.getDescriptor().findFieldByName(fieldName.toString())}if(null==field){if(this.ignoreMissingFields_){return this.consumeUnknownFieldValue_()}else{this.reportError_("Unknown field: "+fieldName);return!1}}if(field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.MESSAGE||field.getFieldType()==goog.proto2.FieldDescriptor.FieldType.GROUP){this.tryConsume_(":");if(!this.consumeNestedMessage_(message,field)){return!1}}else{if(!this.consume_(":")){return!1}if(field.isRepeated()&&this.tryConsume_("[")){while(!0){if(!this.consumeFieldValue_(message,field)){return!1}if(this.tryConsume_("]")){break}if(!this.consume_(",")){return!1}}}else{if(!this.consumeFieldValue_(message,field)){return!1}}}this.tryConsume_(",")||this.tryConsume_(";");return!0};goog.proto2.TextFormatSerializer.Parser.prototype.tryConsume_=function(value){if(this.lookingAt_(value)){this.tokenizer_.next();return!0}return!1};goog.proto2.TextFormatSerializer.Parser.prototype.consumeToken_=function(type){if(!this.lookingAtType_(type)){this.reportError_("Expected token type: "+type);return null}var value=this.tokenizer_.getCurrent().value;this.tokenizer_.next();return value};goog.proto2.TextFormatSerializer.Parser.prototype.consumeIdentifier_=function(){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;return this.consumeToken_(types.IDENTIFIER)};goog.proto2.TextFormatSerializer.Parser.prototype.consumeNumber_=function(){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes;return this.consumeToken_(types.NUMBER)};goog.proto2.TextFormatSerializer.Parser.prototype.consumeString_=function(){var types=goog.proto2.TextFormatSerializer.Tokenizer_.TokenTypes,value=this.consumeToken_(types.STRING);if(!value){return null}var stringValue=goog.json.parse(value).toString();while(this.lookingAtType_(types.STRING)){value=this.consumeToken_(types.STRING);stringValue+=goog.json.parse(value).toString()}return stringValue};goog.proto2.TextFormatSerializer.Parser.prototype.consume_=function(value){if(!this.tryConsume_(value)){this.reportError_("Expected token \""+value+"\"");return!1}return!0};goog.proto2.TextFormatSerializer.Parser.prototype.lookingAt_=function(value){return this.tokenizer_.getCurrent().value==value};goog.proto2.TextFormatSerializer.Parser.prototype.lookingAtType_=function(type){return this.tokenizer_.getCurrent().type==type};