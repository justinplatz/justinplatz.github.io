goog.provide("goog.fx.AbstractDragDrop");goog.provide("goog.fx.AbstractDragDrop.EventType");goog.provide("goog.fx.DragDropEvent");goog.provide("goog.fx.DragDropItem");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.classlist");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventHandler");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.fx.Dragger");goog.require("goog.math.Box");goog.require("goog.math.Coordinate");goog.require("goog.style");goog.fx.AbstractDragDrop=function(){goog.fx.AbstractDragDrop.base(this,"constructor");this.items_=[];this.targets_=[];this.scrollableContainers_=[];this.isSource_=!1;this.isTarget_=!1;this.subtargetFunction_;this.activeSubtarget_;this.dragClass_;this.sourceClass_;this.targetClass_;this.scrollTarget_;this.dummyTarget_;this.initialized_=!1;this.dragEl_;this.targetList_;this.targetBox_;this.activeTarget_;this.dragItem_;this.dragger_};goog.inherits(goog.fx.AbstractDragDrop,goog.events.EventTarget);goog.fx.AbstractDragDrop.DUMMY_TARGET_MIN_SIZE_=10;goog.fx.AbstractDragDrop.EventType={DRAGOVER:"dragover",DRAGOUT:"dragout",DRAG:"drag",DROP:"drop",DRAGSTART:"dragstart",DRAGEND:"dragend"};goog.fx.AbstractDragDrop.initDragDistanceThreshold=5;goog.fx.AbstractDragDrop.prototype.setDragClass=function(className){this.dragClass_=className};goog.fx.AbstractDragDrop.prototype.setSourceClass=function(className){this.sourceClass_=className};goog.fx.AbstractDragDrop.prototype.setTargetClass=function(className){this.targetClass_=className};goog.fx.AbstractDragDrop.prototype.isInitialized=function(){return this.initialized_};goog.fx.AbstractDragDrop.prototype.addItem=goog.abstractMethod;goog.fx.AbstractDragDrop.prototype.addTarget=function(target){this.targets_.push(target);target.isTarget_=!0;this.isSource_=!0};goog.fx.AbstractDragDrop.prototype.removeTarget=function(target){goog.array.remove(this.targets_,target);if(this.activeTarget_&&this.activeTarget_.target_==target){this.activeTarget_=null}this.recalculateDragTargets()};goog.fx.AbstractDragDrop.prototype.setScrollTarget=function(scrollTarget){this.scrollTarget_=scrollTarget};goog.fx.AbstractDragDrop.prototype.init=function(){if(this.initialized_){return}for(var item,i=0;item=this.items_[i];i++){this.initItem(item)}this.initialized_=!0};goog.fx.AbstractDragDrop.prototype.initItem=function(item){if(this.isSource_){goog.events.listen(item.element,goog.events.EventType.MOUSEDOWN,item.mouseDown_,!1,item);if(this.sourceClass_){goog.dom.classlist.add(goog.asserts.assert(item.element),this.sourceClass_)}}if(this.isTarget_&&this.targetClass_){goog.dom.classlist.add(goog.asserts.assert(item.element),this.targetClass_)}};goog.fx.AbstractDragDrop.prototype.disposeItem=function(item){if(this.isSource_){goog.events.unlisten(item.element,goog.events.EventType.MOUSEDOWN,item.mouseDown_,!1,item);if(this.sourceClass_){goog.dom.classlist.remove(goog.asserts.assert(item.element),this.sourceClass_)}}if(this.isTarget_&&this.targetClass_){goog.dom.classlist.remove(goog.asserts.assert(item.element),this.targetClass_)}item.dispose()};goog.fx.AbstractDragDrop.prototype.removeItems=function(){for(var item,i=0;item=this.items_[i];i++){this.disposeItem(item)}this.items_.length=0};goog.fx.AbstractDragDrop.prototype.maybeStartDrag=function(event,item){item.maybeStartDrag_(event,item.element)};goog.fx.AbstractDragDrop.prototype.startDrag=function(event,item){if(this.dragItem_){return}this.dragItem_=item;var dragStartEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGSTART,this,this.dragItem_);if(!1==this.dispatchEvent(dragStartEvent)){this.dragItem_=null;return}var el=item.getCurrentDragElement();this.dragEl_=this.createDragElement(el);var doc=goog.dom.getOwnerDocument(el);doc.body.appendChild(this.dragEl_);this.dragger_=this.createDraggerFor(el,this.dragEl_,event);this.dragger_.setScrollTarget(this.scrollTarget_);goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.DRAG,this.moveDrag_,!1,this);goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.END,this.endDrag,!1,this);goog.events.listen(doc.body,goog.events.EventType.SELECTSTART,this.suppressSelect_);this.recalculateDragTargets();this.recalculateScrollableContainers();this.activeTarget_=null;this.initScrollableContainerListeners_();this.dragger_.startDrag(event);event.preventDefault()};goog.fx.AbstractDragDrop.prototype.recalculateDragTargets=function(){this.targetList_=[];for(var target,i=0;target=this.targets_[i];i++){for(var itm,j=0;itm=target.items_[j];j++){this.addDragTarget_(target,itm)}}if(!this.targetBox_){this.targetBox_=new goog.math.Box(0,0,0,0)}};goog.fx.AbstractDragDrop.prototype.recalculateScrollableContainers=function(){var container,i,j,target;for(i=0;container=this.scrollableContainers_[i];i++){container.containedTargets_=[];container.savedScrollLeft_=container.element_.scrollLeft;container.savedScrollTop_=container.element_.scrollTop;var pos=goog.style.getPageOffset(container.element_),size=goog.style.getSize(container.element_);container.box_=new goog.math.Box(pos.y,pos.x+size.width,pos.y+size.height,pos.x)}for(i=0;target=this.targetList_[i];i++){for(j=0;container=this.scrollableContainers_[j];j++){if(goog.dom.contains(container.element_,target.element_)){container.containedTargets_.push(target);target.scrollableContainer_=container}}}};goog.fx.AbstractDragDrop.prototype.createDraggerFor=function(sourceEl,el,event){var pos=this.getDragElementPosition(sourceEl,el,event);el.style.position="absolute";el.style.left=pos.x+"px";el.style.top=pos.y+"px";return new goog.fx.Dragger(el)};goog.fx.AbstractDragDrop.prototype.endDrag=function(event){var activeTarget=event.dragCanceled?null:this.activeTarget_;if(activeTarget&&activeTarget.target_){var clientX=event.clientX,clientY=event.clientY,scroll=this.getScrollPos(),x=clientX+scroll.x,y=clientY+scroll.y,subtarget;if(this.subtargetFunction_){subtarget=this.subtargetFunction_(activeTarget.item_,activeTarget.box_,x,y)}var dragEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAG,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_,clientX,clientY,x,y);this.dispatchEvent(dragEvent);var dropEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DROP,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_,clientX,clientY,x,y,subtarget);activeTarget.target_.dispatchEvent(dropEvent)}var dragEndEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGEND,this,this.dragItem_,activeTarget?activeTarget.target_:void 0,activeTarget?activeTarget.item_:void 0,activeTarget?activeTarget.element_:void 0);this.dispatchEvent(dragEndEvent);goog.events.unlisten(this.dragger_,goog.fx.Dragger.EventType.DRAG,this.moveDrag_,!1,this);goog.events.unlisten(this.dragger_,goog.fx.Dragger.EventType.END,this.endDrag,!1,this);var doc=goog.dom.getOwnerDocument(this.dragItem_.getCurrentDragElement());goog.events.unlisten(doc.body,goog.events.EventType.SELECTSTART,this.suppressSelect_);this.afterEndDrag(this.activeTarget_?this.activeTarget_.item_:null)};goog.fx.AbstractDragDrop.prototype.afterEndDrag=function(opt_dropTarget){this.disposeDrag()};goog.fx.AbstractDragDrop.prototype.disposeDrag=function(){this.disposeScrollableContainerListeners_();this.dragger_.dispose();goog.dom.removeNode(this.dragEl_);delete this.dragItem_;delete this.dragEl_;delete this.dragger_;delete this.targetList_;delete this.activeTarget_};goog.fx.AbstractDragDrop.prototype.moveDrag_=function(event){var position=this.getEventPosition(event),x=position.x,y=position.y,activeTarget=this.activeTarget_;this.dispatchEvent(new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAG,this,this.dragItem_,activeTarget?activeTarget.target_:void 0,activeTarget?activeTarget.item_:void 0,activeTarget?activeTarget.element_:void 0,event.clientX,event.clientY,x,y));var subtarget;if(activeTarget){if(this.subtargetFunction_&&activeTarget.target_){subtarget=this.subtargetFunction_(activeTarget.item_,activeTarget.box_,x,y)}if(activeTarget.box_.contains(position)&&subtarget==this.activeSubtarget_){return}if(activeTarget.target_){var sourceDragOutEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGOUT,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_);this.dispatchEvent(sourceDragOutEvent);var targetDragOutEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGOUT,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_,void 0,void 0,void 0,void 0,this.activeSubtarget_);activeTarget.target_.dispatchEvent(targetDragOutEvent)}this.activeSubtarget_=subtarget;this.activeTarget_=null}if(this.targetBox_.contains(position)){activeTarget=this.activeTarget_=this.getTargetFromPosition_(position);if(activeTarget&&activeTarget.target_){if(this.subtargetFunction_){subtarget=this.subtargetFunction_(activeTarget.item_,activeTarget.box_,x,y)}var sourceDragOverEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGOVER,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_);sourceDragOverEvent.subtarget=subtarget;this.dispatchEvent(sourceDragOverEvent);var targetDragOverEvent=new goog.fx.DragDropEvent(goog.fx.AbstractDragDrop.EventType.DRAGOVER,this,this.dragItem_,activeTarget.target_,activeTarget.item_,activeTarget.element_,event.clientX,event.clientY,void 0,void 0,subtarget);activeTarget.target_.dispatchEvent(targetDragOverEvent)}else if(!activeTarget){this.activeTarget_=this.maybeCreateDummyTargetForPosition_(x,y)}}};goog.fx.AbstractDragDrop.prototype.suppressSelect_=function(event){return!1};goog.fx.AbstractDragDrop.prototype.initScrollableContainerListeners_=function(){var container,i;for(i=0;container=this.scrollableContainers_[i];i++){goog.events.listen(container.element_,goog.events.EventType.SCROLL,this.containerScrollHandler_,!1,this)}};goog.fx.AbstractDragDrop.prototype.disposeScrollableContainerListeners_=function(){for(var i=0,container;container=this.scrollableContainers_[i];i++){goog.events.unlisten(container.element_,"scroll",this.containerScrollHandler_,!1,this);container.containedTargets_=[]}};goog.fx.AbstractDragDrop.prototype.addScrollableContainer=function(element){this.scrollableContainers_.push(new goog.fx.ScrollableContainer_(element))};goog.fx.AbstractDragDrop.prototype.removeAllScrollableContainers=function(){this.disposeScrollableContainerListeners_();this.scrollableContainers_=[]};goog.fx.AbstractDragDrop.prototype.containerScrollHandler_=function(e){for(var i=0,container;container=this.scrollableContainers_[i];i++){if(e.target==container.element_){var deltaTop=container.savedScrollTop_-container.element_.scrollTop,deltaLeft=container.savedScrollLeft_-container.element_.scrollLeft;container.savedScrollTop_=container.element_.scrollTop;container.savedScrollLeft_=container.element_.scrollLeft;if(this.dummyTarget_&&this.activeTarget_==this.dummyTarget_){if(0<deltaTop){this.dummyTarget_.box_.top+=deltaTop}else{this.dummyTarget_.box_.bottom+=deltaTop}if(0<deltaLeft){this.dummyTarget_.box_.left+=deltaLeft}else{this.dummyTarget_.box_.right+=deltaLeft}}for(var j=0,target,box;target=container.containedTargets_[j];j++){box=target.box_;box.top+=deltaTop;box.left+=deltaLeft;box.bottom+=deltaTop;box.right+=deltaLeft;this.calculateTargetBox_(box)}}}this.dragger_.onScroll_(e)};goog.fx.AbstractDragDrop.prototype.setSubtargetFunction=function(f){this.subtargetFunction_=f};goog.fx.AbstractDragDrop.prototype.createDragElement=function(sourceEl){var dragEl=this.createDragElementInternal(sourceEl);goog.asserts.assert(dragEl);if(this.dragClass_){goog.dom.classlist.add(dragEl,this.dragClass_)}return dragEl};goog.fx.AbstractDragDrop.prototype.getDragElementPosition=function(el,dragEl,event){var pos=goog.style.getPageOffset(el),marginBox=goog.style.getMarginBox(el);pos.x-=2*(marginBox.left||0);pos.y-=2*(marginBox.top||0);return pos};goog.fx.AbstractDragDrop.prototype.getDragger=function(){return this.dragger_};goog.fx.AbstractDragDrop.prototype.cloneNode_=function(sourceEl){return goog.fx.Dragger.cloneNode(sourceEl)};goog.fx.AbstractDragDrop.prototype.createDragElementInternal=function(sourceEl){return this.cloneNode_(sourceEl)};goog.fx.AbstractDragDrop.prototype.addDragTarget_=function(target,item){for(var draggableElements=item.getDraggableElements(),i=0;i<draggableElements.length;i++){var draggableElement=draggableElements[i],box=this.getElementBox(item,draggableElement);this.targetList_.push(new goog.fx.ActiveDropTarget_(box,target,item,draggableElement));this.calculateTargetBox_(box)}};goog.fx.AbstractDragDrop.prototype.getElementBox=function(item,element){var pos=goog.style.getPageOffset(element),size=goog.style.getSize(element);return new goog.math.Box(pos.y,pos.x+size.width,pos.y+size.height,pos.x)};goog.fx.AbstractDragDrop.prototype.calculateTargetBox_=function(box){var _Mathmax=Math.max,_Mathmin=Math.min;if(1==this.targetList_.length){this.targetBox_=new goog.math.Box(box.top,box.right,box.bottom,box.left)}else{var tb=this.targetBox_;tb.left=_Mathmin(box.left,tb.left);tb.right=_Mathmax(box.right,tb.right);tb.top=_Mathmin(box.top,tb.top);tb.bottom=_Mathmax(box.bottom,tb.bottom)}};goog.fx.AbstractDragDrop.prototype.maybeCreateDummyTargetForPosition_=function(x,y){var _Mathabs=Math.abs,_Mathmax2=Math.max,_Mathmin2=Math.min;if(!this.dummyTarget_){this.dummyTarget_=new goog.fx.ActiveDropTarget_(this.targetBox_.clone())}var fakeTargetBox=this.dummyTarget_.box_;fakeTargetBox.top=this.targetBox_.top;fakeTargetBox.right=this.targetBox_.right;fakeTargetBox.bottom=this.targetBox_.bottom;fakeTargetBox.left=this.targetBox_.left;for(var i=0,target,box;target=this.targetList_[i];i++){box=target.box_;if(target.scrollableContainer_){var scrollBox=target.scrollableContainer_.box_;box=new goog.math.Box(_Mathmax2(box.top,scrollBox.top),_Mathmin2(box.right,scrollBox.right),_Mathmin2(box.bottom,scrollBox.bottom),_Mathmax2(box.left,scrollBox.left))}var horizontalClip=null;if(x>=box.right){horizontalClip=box.right>fakeTargetBox.left?box.right:fakeTargetBox.left}else if(x<box.left){horizontalClip=box.left<fakeTargetBox.right?box.left:fakeTargetBox.right}var verticalClip=null;if(y>=box.bottom){verticalClip=box.bottom>fakeTargetBox.top?box.bottom:fakeTargetBox.top}else if(y<box.top){verticalClip=box.top<fakeTargetBox.bottom?box.top:fakeTargetBox.bottom}if(!goog.isNull(horizontalClip)&&!goog.isNull(verticalClip)){if(_Mathabs(horizontalClip-x)>_Mathabs(verticalClip-y)){verticalClip=null}else{horizontalClip=null}}if(!goog.isNull(horizontalClip)){if(horizontalClip<=x){fakeTargetBox.left=horizontalClip}else{fakeTargetBox.right=horizontalClip}}else if(!goog.isNull(verticalClip)){if(verticalClip<=y){fakeTargetBox.top=verticalClip}else{fakeTargetBox.bottom=verticalClip}}}return(fakeTargetBox.right-fakeTargetBox.left)*(fakeTargetBox.bottom-fakeTargetBox.top)>=goog.fx.AbstractDragDrop.DUMMY_TARGET_MIN_SIZE_?this.dummyTarget_:null};goog.fx.AbstractDragDrop.prototype.getTargetFromPosition_=function(position){for(var target,i=0;target=this.targetList_[i];i++){if(target.box_.contains(position)){if(target.scrollableContainer_){var box=target.scrollableContainer_.box_;if(box.contains(position)){return target}}else{return target}}}return null};goog.fx.AbstractDragDrop.prototype.isInside=function(x,y,box){return x>=box.left&&x<box.right&&y>=box.top&&y<box.bottom};goog.fx.AbstractDragDrop.prototype.getScrollPos=function(){return goog.dom.getDomHelper(this.dragEl_).getDocumentScroll()};goog.fx.AbstractDragDrop.prototype.getEventPosition=function(event){var scroll=this.getScrollPos();return new goog.math.Coordinate(event.clientX+scroll.x,event.clientY+scroll.y)};goog.fx.AbstractDragDrop.prototype.disposeInternal=function(){goog.fx.AbstractDragDrop.base(this,"disposeInternal");this.removeItems()};goog.fx.DragDropEvent=function(type,source,sourceItem,opt_target,opt_targetItem,opt_targetElement,opt_clientX,opt_clientY,opt_x,opt_y,opt_subtarget){goog.fx.DragDropEvent.base(this,"constructor",type);this.dragSource=source;this.dragSourceItem=sourceItem;this.dropTarget=opt_target;this.dropTargetItem=opt_targetItem;this.dropTargetElement=opt_targetElement;this.clientX=opt_clientX;this.clientY=opt_clientY;this.viewportX=opt_x;this.viewportY=opt_y;this.subtarget=opt_subtarget};goog.inherits(goog.fx.DragDropEvent,goog.events.Event);goog.fx.DragDropItem=function(element,opt_data){goog.fx.DragDropItem.base(this,"constructor");this.element=goog.dom.getElement(element);this.data=opt_data;this.parent_=null;this.eventHandler_=new goog.events.EventHandler(this);this.registerDisposable(this.eventHandler_);this.currentDragElement_=null;this.startPosition_;if(!this.element){throw Error("Invalid argument")}};goog.inherits(goog.fx.DragDropItem,goog.events.EventTarget);goog.fx.DragDropItem.prototype.getData=function(){return this.data};goog.fx.DragDropItem.prototype.getDraggableElement=function(target){return target};goog.fx.DragDropItem.prototype.getCurrentDragElement=function(){return this.currentDragElement_};goog.fx.DragDropItem.prototype.getDraggableElements=function(){return[this.element]};goog.fx.DragDropItem.prototype.mouseDown_=function(event){if(!event.isMouseActionButton()){return}var element=this.getDraggableElement(event.target);if(element){this.maybeStartDrag_(event,element)}};goog.fx.DragDropItem.prototype.setParent=function(parent){this.parent_=parent};goog.fx.DragDropItem.prototype.maybeStartDrag_=function(event,element){var eventType=goog.events.EventType;this.eventHandler_.listen(element,eventType.MOUSEMOVE,this.mouseMove_,!1).listen(element,eventType.MOUSEOUT,this.mouseMove_,!1);var doc=goog.dom.getOwnerDocument(element);this.eventHandler_.listen(doc,eventType.MOUSEUP,this.mouseUp_,!0);this.currentDragElement_=element;this.startPosition_=new goog.math.Coordinate(event.clientX,event.clientY)};goog.fx.DragDropItem.prototype.mouseMove_=function(event){var _Mathabs2=Math.abs,distance=_Mathabs2(event.clientX-this.startPosition_.x)+_Mathabs2(event.clientY-this.startPosition_.y),currentDragElement=this.currentDragElement_,distanceAboveThreshold=distance>goog.fx.AbstractDragDrop.initDragDistanceThreshold,mouseOutOnDragElement=event.type==goog.events.EventType.MOUSEOUT&&event.target==currentDragElement;if(distanceAboveThreshold||mouseOutOnDragElement){this.eventHandler_.removeAll();this.parent_.startDrag(event,this)}event.preventDefault()};goog.fx.DragDropItem.prototype.mouseUp_=function(event){this.eventHandler_.removeAll();delete this.startPosition_;this.currentDragElement_=null};goog.fx.ActiveDropTarget_=function(box,opt_target,opt_item,opt_element){this.box_=box;this.target_=opt_target;this.item_=opt_item;this.element_=opt_element||null;this.scrollableContainer_=null};goog.fx.ScrollableContainer_=function(element){this.containedTargets_=[];this.element_=element;this.savedScrollLeft_=0;this.savedScrollTop_=0;this.box_=null};