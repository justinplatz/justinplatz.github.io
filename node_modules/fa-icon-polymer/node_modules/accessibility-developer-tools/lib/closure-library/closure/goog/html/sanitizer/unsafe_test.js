goog.setTestOnly();goog.require("goog.html.SafeHtml");goog.require("goog.html.sanitizer.HtmlSanitizer");goog.require("goog.html.sanitizer.TagBlacklist");goog.require("goog.html.sanitizer.unsafe");goog.require("goog.string.Const");goog.require("goog.testing.dom");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function isIE8(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(9)}function isIE9(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(10)&&!isIE8()}var just=goog.string.Const.from("test");function assertSanitizedHtml(originalHtml,expectedHtml,opt_tags,opt_attrs,opt_builder){var builder=opt_builder||new goog.html.sanitizer.HtmlSanitizer.Builder;if(opt_tags)builder=goog.html.sanitizer.unsafe.alsoAllowTags(just,builder,opt_tags);if(opt_attrs)builder=goog.html.sanitizer.unsafe.alsoAllowAttributes(just,builder,opt_attrs);var sanitizer=builder.build();try{var sanitized=sanitizer.sanitize(originalHtml);if(isIE9()){assertEquals("",goog.html.SafeHtml.unwrap(sanitized));return}goog.testing.dom.assertHtmlMatches(expectedHtml,goog.html.SafeHtml.unwrap(sanitized),!0)}catch(err){if(!isIE8()){throw err}}}function testAllowEmptyTagList(){var input="<sdf><aaa></aaa></sdf><b></b>",expected="<span><span></span></span><b></b>";assertSanitizedHtml(input,expected,[])}function testAllowBlacklistedTag(){var input="<div><script>aaa</script></div>",expected="<div></div>";assertSanitizedHtml(input,expected,["SCriPT"])}function testAllowUnknownTags(){var input="<hello><bye>aaa</bye></hello><zzz></zzz>",expected="<hello><span>aaa</span></hello><zzz></zzz>";assertSanitizedHtml(input,expected,["HElLO","zZZ"])}function testAllowAlreadyWhiteListedTag(){var input="<hello><p><zzz></zzz></p></hello>",expected="<span><p><zzz></zzz></p></span>";assertSanitizedHtml(input,expected,["p","ZZZ"])}function testAllowEmptyAttrList(){var input="<a href=\"#\" qwe=\"nope\">b</a>",expected="<a href=\"#\">b</a>";assertSanitizedHtml(input,expected,null,[])}function testAllowUnknownAttributeSimple(){var input="<qqq zzz=\"3\" nnn=\"no\"></qqq>",expected="<span zzz=\"3\"></span>";assertSanitizedHtml(input,expected,null,["Zzz"])}function testAllowUnknownAttributeWildCard(){var input="<div ab=\"yes\" bb=\"no\"><img ab=\"yep\" bb=\"no\" /></div>",expected="<div ab=\"yes\"><img ab=\"yep\" /></div>";assertSanitizedHtml(input,expected,null,[{tagName:"*",attributeName:"aB"}])}function testAllowUnknownAttributeOnSpecificTag(){var input="<a www=\"3\" zzz=\"4\">fff</a><img www=\"3\" />",expected="<a www=\"3\">fff</a><img />";assertSanitizedHtml(input,expected,null,[{tagName:"a",attributeName:"WwW"}])}function testAllowUnknownAttributePolicy(){var input="<img ab=\"yes\" /><img ab=\"no\" />",expected="<img ab=\"yes\" /><img />";assertSanitizedHtml(input,expected,null,[{tagName:"*",attributeName:"aB",policy:function(value,hints){assertEquals(hints.attributeName,"ab");return"yes"===value?value:null}}])}function testAllowOverwriteAttrPolicy(){var input="<a href=\"yes\"></a><a href=\"no\"></a>",expected="<a href=\"yes\"></a><a></a>";assertSanitizedHtml(input,expected,null,[{tagName:"a",attributeName:"href",policy:function(value){return"yes"===value?value:null}}])}function testWhitelistAliasing(){var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;goog.html.sanitizer.unsafe.alsoAllowTags(just,builder,["QqQ"]);goog.html.sanitizer.unsafe.alsoAllowAttributes(just,builder,["QqQ"]);builder.build();assertUndefined(goog.html.sanitizer.TagWhitelist.QQQ);assertUndefined(goog.html.sanitizer.TagWhitelist.QqQ);assertUndefined(goog.html.sanitizer.TagWhitelist.qqq);assertUndefined(goog.html.sanitizer.AttributeWhitelist["* QQQ"]);assertUndefined(goog.html.sanitizer.AttributeWhitelist["* QqQ"]);assertUndefined(goog.html.sanitizer.AttributeWhitelist["* qqq"])}function testTemplateUnsanitized(){if(!goog.html.sanitizer.HTML_SANITIZER_TEMPLATE_SUPPORTED){return}var input="<template><div>a</div><script>qqq</script>"+"<template>a</template></template>";delete goog.html.sanitizer.TagBlacklist.TEMPLATE;var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;goog.html.sanitizer.unsafe.keepUnsanitizedTemplateContents(just,builder);assertSanitizedHtml(input,input,["TEMPLATE"],null,builder);goog.html.sanitizer.TagBlacklist.TEMPLATE=!0}function testTemplateSanitizedUnsanitizedXSS(){if(!goog.html.sanitizer.HTML_SANITIZER_TEMPLATE_SUPPORTED){return}var input="<template><p>a</p><script>aaaa;</script></template>",expected="<span><p>a</p></span>";delete goog.html.sanitizer.TagBlacklist.TEMPLATE;var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;goog.html.sanitizer.unsafe.keepUnsanitizedTemplateContents(just,builder);assertSanitizedHtml(input,expected,null,null,builder);goog.html.sanitizer.TagBlacklist.TEMPLATE=!0}function testTemplateUnsanitizedThrowsIE(){if(goog.html.sanitizer.HTML_SANITIZER_TEMPLATE_SUPPORTED){return}var builder=new goog.html.sanitizer.HtmlSanitizer.Builder;assertThrows(function(){goog.html.sanitizer.unsafe.keepUnsanitizedTemplateContents(just,builder)})}function testAllowRelaxExistingAttributePolicyWildcard(){var input="<a href=\"javascript:alert(1)\"></a>";assertSanitizedHtml(input,input,null,[{tagName:"a",attributeName:"href",policy:goog.functions.identity}]);assertSanitizedHtml(input,input,null,[{tagName:"*",attributeName:"href",policy:goog.functions.identity}])}function testAllowRelaxExistingAttributePolicySpecific(){var input="<a target=\"foo\"></a>",expected="<a></a>";assertSanitizedHtml(input,expected,null,[{tagName:"*",attributeName:"target",policy:goog.functions.identity}]);assertSanitizedHtml(input,input,null,[{tagName:"a",attributeName:"target",policy:goog.functions.identity}])}