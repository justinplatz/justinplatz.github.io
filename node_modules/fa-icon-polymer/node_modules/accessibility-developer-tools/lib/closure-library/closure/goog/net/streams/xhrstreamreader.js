goog.provide("goog.net.streams.XhrStreamReader");goog.require("goog.events.EventHandler");goog.require("goog.log");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.net.HttpStatus");goog.require("goog.net.XhrIo");goog.require("goog.net.XmlHttp");goog.require("goog.net.streams.Base64PbStreamParser");goog.require("goog.net.streams.JsonStreamParser");goog.require("goog.net.streams.PbStreamParser");goog.require("goog.string");goog.require("goog.userAgent");goog.scope(function(){var Base64PbStreamParser=goog.module.get("goog.net.streams.Base64PbStreamParser");goog.net.streams.XhrStreamReader=function(xhr){this.logger_=goog.log.getLogger("goog.net.streams.XhrStreamReader");this.xhr_=xhr;this.parser_=null;this.pos_=0;this.status_=goog.net.streams.XhrStreamReader.Status.INIT;this.statusHandler_=null;this.dataHandler_=null;this.eventHandler_=new goog.events.EventHandler(this);this.eventHandler_.listen(this.xhr_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_)};goog.net.streams.XhrStreamReader.Status={INIT:0,ACTIVE:1,SUCCESS:2,XHR_ERROR:3,NO_DATA:4,BAD_DATA:5,HANDLER_EXCEPTION:6,TIMEOUT:7,CANCELLED:8};goog.net.streams.XhrStreamReader.isStreamingSupported=function(){if(goog.userAgent.IE&&!goog.userAgent.isDocumentModeOrHigher(10)){return!1}if(goog.userAgent.WEBKIT&&!goog.userAgent.isVersionOrHigher("420+")){return!1}if(goog.userAgent.OPERA&&!goog.userAgent.WEBKIT){return!1}return!0};goog.net.streams.XhrStreamReader.prototype.getParserByResponseHeader_=function(){var contentType=this.xhr_.getStreamingResponseHeader(goog.net.XhrIo.CONTENT_TYPE_HEADER);if(!contentType){goog.log.warning(this.logger_,"Content-Type unavailable: "+contentType);return null}contentType=contentType.toLowerCase();if(goog.string.startsWith(contentType,"application/json")){return new goog.net.streams.JsonStreamParser}if(goog.string.startsWith(contentType,"application/x-protobuf")){var encoding=this.xhr_.getStreamingResponseHeader(goog.net.XhrIo.CONTENT_TRANSFER_ENCODING);if(!encoding){return new goog.net.streams.PbStreamParser}if("base64"==encoding.toLowerCase()){return new Base64PbStreamParser}goog.log.warning(this.logger_,"Unsupported Content-Transfer-Encoding: "+encoding+"\nFor Content-Type: "+contentType);return null}goog.log.warning(this.logger_,"Unsupported Content-Type: "+contentType);return null};goog.net.streams.XhrStreamReader.prototype.getXhr=function(){return this.xhr_};goog.net.streams.XhrStreamReader.prototype.getStatus=function(){return this.status_};goog.net.streams.XhrStreamReader.prototype.setStatusHandler=function(handler){this.statusHandler_=handler};goog.net.streams.XhrStreamReader.prototype.setDataHandler=function(handler){this.dataHandler_=handler};goog.net.streams.XhrStreamReader.prototype.readyStateChangeHandler_=function(event){var xhr=event.target;try{if(xhr==this.xhr_){this.onReadyStateChanged_()}else{goog.log.warning(this.logger_,"Called back with an unexpected xhr.")}}catch(ex){goog.log.error(this.logger_,"readyStateChangeHandler_ thrown exception"+" "+ex);this.updateStatus_(goog.net.streams.XhrStreamReader.Status.HANDLER_EXCEPTION);this.clear_()}};goog.net.streams.XhrStreamReader.prototype.onReadyStateChanged_=function(){var readyState=this.xhr_.getReadyState(),errorCode=this.xhr_.getLastErrorCode(),statusCode=this.xhr_.getStatus(),responseText=this.xhr_.getResponseText();if(readyState<goog.net.XmlHttp.ReadyState.INTERACTIVE||readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!responseText){return}var successful=statusCode==goog.net.HttpStatus.OK||statusCode==goog.net.HttpStatus.PARTIAL_CONTENT;if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){if(errorCode==goog.net.ErrorCode.TIMEOUT){this.updateStatus_(goog.net.streams.XhrStreamReader.Status.TIMEOUT)}else if(errorCode==goog.net.ErrorCode.ABORT){this.updateStatus_(goog.net.streams.XhrStreamReader.Status.CANCELLED)}else if(!successful){this.updateStatus_(goog.net.streams.XhrStreamReader.Status.XHR_ERROR)}}if(successful&&!responseText){goog.log.warning(this.logger_,"No response text for xhr "+this.xhr_.getLastUri()+" status "+statusCode)}if(!this.parser_){this.parser_=this.getParserByResponseHeader_();if(null==this.parser_){this.updateStatus_(goog.net.streams.XhrStreamReader.Status.BAD_DATA)}}if(this.status_>goog.net.streams.XhrStreamReader.Status.SUCCESS){this.clear_();return}if(responseText.length>this.pos_){var newData=responseText.substr(this.pos_);this.pos_=responseText.length;try{var messages=this.parser_.parse(newData);if(null!=messages){if(this.dataHandler_){this.dataHandler_(messages)}}}catch(ex){goog.log.error(this.logger_,"Invalid response "+ex+"\n"+responseText);this.updateStatus_(goog.net.streams.XhrStreamReader.Status.BAD_DATA);this.clear_();return}}if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){if(0==responseText.length){this.updateStatus_(goog.net.streams.XhrStreamReader.Status.NO_DATA)}else{this.updateStatus_(goog.net.streams.XhrStreamReader.Status.SUCCESS)}this.clear_();return}this.updateStatus_(goog.net.streams.XhrStreamReader.Status.ACTIVE)};goog.net.streams.XhrStreamReader.prototype.updateStatus_=function(status){var current=this.status_;if(current!=status){this.status_=status;if(this.statusHandler_){this.statusHandler_()}}};goog.net.streams.XhrStreamReader.prototype.clear_=function(){this.eventHandler_.removeAll();if(this.xhr_){var xhr=this.xhr_;this.xhr_=null;xhr.abort();xhr.dispose()}}});