goog.provide("goog.ui.ModalPopup");goog.require("goog.Timer");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.dom.animationFrame");goog.require("goog.dom.classlist");goog.require("goog.dom.iframe");goog.require("goog.events");goog.require("goog.events.EventType");goog.require("goog.events.FocusHandler");goog.require("goog.fx.Transition");goog.require("goog.string");goog.require("goog.style");goog.require("goog.ui.Component");goog.require("goog.ui.ModalAriaVisibilityHelper");goog.require("goog.ui.PopupBase");goog.require("goog.userAgent");goog.ui.ModalPopup=function(opt_useIframeMask,opt_domHelper){goog.ui.ModalPopup.base(this,"constructor",opt_domHelper);this.useIframeMask_=!!opt_useIframeMask;this.lastFocus_=null;this.resizeBackgroundTask_=goog.dom.animationFrame.createTask({mutate:this.resizeBackground_},this)};goog.inherits(goog.ui.ModalPopup,goog.ui.Component);goog.tagUnsealableClass(goog.ui.ModalPopup);goog.ui.ModalPopup.prototype.focusHandler_=null;goog.ui.ModalPopup.prototype.visible_=!1;goog.ui.ModalPopup.prototype.bgEl_=null;goog.ui.ModalPopup.prototype.bgIframeEl_=null;goog.ui.ModalPopup.prototype.tabCatcherElement_=null;goog.ui.ModalPopup.prototype.backwardTabWrapInProgress_=!1;goog.ui.ModalPopup.prototype.popupShowTransition_;goog.ui.ModalPopup.prototype.popupHideTransition_;goog.ui.ModalPopup.prototype.bgShowTransition_;goog.ui.ModalPopup.prototype.bgHideTransition_;goog.ui.ModalPopup.prototype.modalAriaVisibilityHelper_;goog.ui.ModalPopup.prototype.getCssClass=function(){return goog.getCssName("goog-modalpopup")};goog.ui.ModalPopup.prototype.getBackgroundIframe=function(){return this.bgIframeEl_};goog.ui.ModalPopup.prototype.getBackgroundElement=function(){return this.bgEl_};goog.ui.ModalPopup.prototype.createDom=function(){goog.ui.ModalPopup.base(this,"createDom");var element=this.getElement();goog.asserts.assert(element);var allClasses=goog.string.trim(this.getCssClass()).split(" ");goog.dom.classlist.addAll(element,allClasses);goog.dom.setFocusableTabIndex(element,!0);goog.style.setElementShown(element,!1);this.manageBackgroundDom_();this.createTabCatcher_()};goog.ui.ModalPopup.prototype.manageBackgroundDom_=function(){if(this.useIframeMask_&&!this.bgIframeEl_){this.bgIframeEl_=goog.dom.iframe.createBlank(this.getDomHelper());this.bgIframeEl_.className=goog.getCssName(this.getCssClass(),"bg");goog.style.setElementShown(this.bgIframeEl_,!1);goog.style.setOpacity(this.bgIframeEl_,0)}if(!this.bgEl_){this.bgEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,goog.getCssName(this.getCssClass(),"bg"));goog.style.setElementShown(this.bgEl_,!1)}};goog.ui.ModalPopup.prototype.createTabCatcher_=function(){if(!this.tabCatcherElement_){this.tabCatcherElement_=this.getDomHelper().createElement(goog.dom.TagName.SPAN);goog.style.setElementShown(this.tabCatcherElement_,!1);goog.dom.setFocusableTabIndex(this.tabCatcherElement_,!0);this.tabCatcherElement_.style.position="absolute"}};goog.ui.ModalPopup.prototype.setupBackwardTabWrap=function(){this.backwardTabWrapInProgress_=!0;try{this.tabCatcherElement_.focus()}catch(e){}goog.Timer.callOnce(this.resetBackwardTabWrap_,0,this)};goog.ui.ModalPopup.prototype.resetBackwardTabWrap_=function(){this.backwardTabWrapInProgress_=!1};goog.ui.ModalPopup.prototype.renderBackground_=function(){goog.asserts.assert(!!this.bgEl_,"Background element must not be null.");if(this.bgIframeEl_){goog.dom.insertSiblingBefore(this.bgIframeEl_,this.getElement())}goog.dom.insertSiblingBefore(this.bgEl_,this.getElement())};goog.ui.ModalPopup.prototype.canDecorate=function(element){return!!element&&element.tagName==goog.dom.TagName.DIV};goog.ui.ModalPopup.prototype.decorateInternal=function(element){goog.ui.ModalPopup.base(this,"decorateInternal",element);var allClasses=goog.string.trim(this.getCssClass()).split(" ");goog.dom.classlist.addAll(goog.asserts.assert(this.getElement()),allClasses);this.manageBackgroundDom_();this.createTabCatcher_();goog.dom.setFocusableTabIndex(this.getElement(),!0);goog.style.setElementShown(this.getElement(),!1)};goog.ui.ModalPopup.prototype.enterDocument=function(){this.renderBackground_();goog.ui.ModalPopup.base(this,"enterDocument");goog.dom.insertSiblingAfter(this.tabCatcherElement_,this.getElement());this.focusHandler_=new goog.events.FocusHandler(this.getDomHelper().getDocument());this.getHandler().listen(this.focusHandler_,goog.events.FocusHandler.EventType.FOCUSIN,this.onFocus);this.setA11YDetectBackground(!1)};goog.ui.ModalPopup.prototype.exitDocument=function(){if(this.isVisible()){this.setVisible(!1)}goog.dispose(this.focusHandler_);goog.ui.ModalPopup.base(this,"exitDocument");goog.dom.removeNode(this.bgIframeEl_);goog.dom.removeNode(this.bgEl_);goog.dom.removeNode(this.tabCatcherElement_)};goog.ui.ModalPopup.prototype.setVisible=function(visible){goog.asserts.assert(this.isInDocument(),"ModalPopup must be rendered first.");if(visible==this.visible_){return}if(this.popupShowTransition_)this.popupShowTransition_.stop();if(this.bgShowTransition_)this.bgShowTransition_.stop();if(this.popupHideTransition_)this.popupHideTransition_.stop();if(this.bgHideTransition_)this.bgHideTransition_.stop();if(this.isInDocument()){this.setA11YDetectBackground(visible)}if(visible){this.show_()}else{this.hide_()}};goog.ui.ModalPopup.prototype.setA11YDetectBackground=function(hide){if(!this.modalAriaVisibilityHelper_){this.modalAriaVisibilityHelper_=new goog.ui.ModalAriaVisibilityHelper(this.getElementStrict(),this.dom_)}this.modalAriaVisibilityHelper_.setBackgroundVisibility(hide)};goog.ui.ModalPopup.prototype.setTransition=function(popupShowTransition,popupHideTransition,bgShowTransition,bgHideTransition){this.popupShowTransition_=popupShowTransition;this.popupHideTransition_=popupHideTransition;this.bgShowTransition_=bgShowTransition;this.bgHideTransition_=bgHideTransition};goog.ui.ModalPopup.prototype.show_=function(){if(!this.dispatchEvent(goog.ui.PopupBase.EventType.BEFORE_SHOW)){return}try{this.lastFocus_=this.getDomHelper().getDocument().activeElement}catch(e){}this.resizeBackground_();this.reposition();this.getHandler().listen(this.getDomHelper().getWindow(),goog.events.EventType.RESIZE,this.resizeBackground_).listen(this.getDomHelper().getWindow(),goog.events.EventType.ORIENTATIONCHANGE,this.resizeBackgroundTask_);this.showPopupElement_(!0);this.focus();this.visible_=!0;if(this.popupShowTransition_&&this.bgShowTransition_){goog.events.listenOnce(this.popupShowTransition_,goog.fx.Transition.EventType.END,this.onShow,!1,this);this.bgShowTransition_.play();this.popupShowTransition_.play()}else{this.onShow()}};goog.ui.ModalPopup.prototype.hide_=function(){if(!this.dispatchEvent(goog.ui.PopupBase.EventType.BEFORE_HIDE)){return}this.getHandler().unlisten(this.getDomHelper().getWindow(),goog.events.EventType.RESIZE,this.resizeBackground_).unlisten(this.getDomHelper().getWindow(),goog.events.EventType.ORIENTATIONCHANGE,this.resizeBackgroundTask_);this.visible_=!1;if(this.popupHideTransition_&&this.bgHideTransition_){goog.events.listenOnce(this.popupHideTransition_,goog.fx.Transition.EventType.END,this.onHide,!1,this);this.bgHideTransition_.play();this.popupHideTransition_.play()}else{this.onHide()}this.returnFocus_()};goog.ui.ModalPopup.prototype.returnFocus_=function(){try{var dom=this.getDomHelper(),body=dom.getDocument().body,active=dom.getDocument().activeElement||body;if(!this.lastFocus_||this.lastFocus_==body){this.lastFocus_=null;return}if(active==body||dom.contains(this.getElement(),active)){this.lastFocus_.focus()}}catch(e){}this.lastFocus_=null};goog.ui.ModalPopup.prototype.showPopupElement_=function(visible){if(this.bgIframeEl_){goog.style.setElementShown(this.bgIframeEl_,visible)}if(this.bgEl_){goog.style.setElementShown(this.bgEl_,visible)}goog.style.setElementShown(this.getElement(),visible);goog.style.setElementShown(this.tabCatcherElement_,visible)};goog.ui.ModalPopup.prototype.onShow=function(){this.dispatchEvent(goog.ui.PopupBase.EventType.SHOW)};goog.ui.ModalPopup.prototype.onHide=function(){this.showPopupElement_(!1);this.dispatchEvent(goog.ui.PopupBase.EventType.HIDE)};goog.ui.ModalPopup.prototype.isVisible=function(){return this.visible_};goog.ui.ModalPopup.prototype.focus=function(){this.focusElement_()};goog.ui.ModalPopup.prototype.resizeBackground_=function(){var _Mathmax=Math.max;if(this.bgIframeEl_){goog.style.setElementShown(this.bgIframeEl_,!1)}if(this.bgEl_){goog.style.setElementShown(this.bgEl_,!1)}var doc=this.getDomHelper().getDocument(),win=goog.dom.getWindow(doc)||window,viewSize=goog.dom.getViewportSize(win),w=_Mathmax(viewSize.width,_Mathmax(doc.body.scrollWidth,doc.documentElement.scrollWidth)),h=_Mathmax(viewSize.height,_Mathmax(doc.body.scrollHeight,doc.documentElement.scrollHeight));if(this.bgIframeEl_){goog.style.setElementShown(this.bgIframeEl_,!0);goog.style.setSize(this.bgIframeEl_,w,h)}if(this.bgEl_){goog.style.setElementShown(this.bgEl_,!0);goog.style.setSize(this.bgEl_,w,h)}};goog.ui.ModalPopup.prototype.reposition=function(){var _Mathmax2=Math.max,doc=this.getDomHelper().getDocument(),win=goog.dom.getWindow(doc)||window;if("fixed"==goog.style.getComputedPosition(this.getElement())){var x=0,y=0}else{var scroll=this.getDomHelper().getDocumentScroll(),x=scroll.x,y=scroll.y}var popupSize=goog.style.getSize(this.getElement()),viewSize=goog.dom.getViewportSize(win),left=_Mathmax2(x+viewSize.width/2-popupSize.width/2,0),top=_Mathmax2(y+viewSize.height/2-popupSize.height/2,0);goog.style.setPosition(this.getElement(),left,top);goog.style.setPosition(this.tabCatcherElement_,left,top)};goog.ui.ModalPopup.prototype.onFocus=function(e){if(this.backwardTabWrapInProgress_){this.resetBackwardTabWrap_()}else if(e.target==this.tabCatcherElement_){goog.Timer.callOnce(this.focusElement_,0,this)}};goog.ui.ModalPopup.prototype.getTabCatcherElement=function(){return this.tabCatcherElement_};goog.ui.ModalPopup.prototype.focusElement_=function(){try{if(goog.userAgent.IE){this.getDomHelper().getDocument().body.focus()}this.getElement().focus()}catch(e){}};goog.ui.ModalPopup.prototype.disposeInternal=function(){goog.dispose(this.popupShowTransition_);this.popupShowTransition_=null;goog.dispose(this.popupHideTransition_);this.popupHideTransition_=null;goog.dispose(this.bgShowTransition_);this.bgShowTransition_=null;goog.dispose(this.bgHideTransition_);this.bgHideTransition_=null;goog.ui.ModalPopup.base(this,"disposeInternal")};