goog.provide("goog.module.ModuleLoaderTest");goog.require("goog.Promise");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.functions");goog.require("goog.module.ModuleLoader");goog.require("goog.module.ModuleManager");goog.require("goog.net.BulkLoader");goog.require("goog.net.XmlHttp");goog.require("goog.object");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.events.EventObserver");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");goog.setTestOnly("goog.module.ModuleLoaderTest");var modA1Loaded=!1,modA2Loaded=!1,modB1Loaded=!1,moduleLoader=null,moduleManager=null,stubs=new goog.testing.PropertyReplacer,EventType=goog.module.ModuleLoader.EventType,observer;function setUpPage(){goog.testing.TestCase.getActiveTestCase().promiseTimeout=1e4}function setUp(){modA1Loaded=!1;modA2Loaded=!1;modB1Loaded=!1;goog.provide=goog.nullFunction;moduleManager=goog.module.ModuleManager.getInstance();stubs.replace(moduleManager,"getBackOff_",goog.functions.constant(0));moduleLoader=new goog.module.ModuleLoader;observer=new goog.testing.events.EventObserver;goog.events.listen(moduleLoader,goog.object.getValues(EventType),observer);moduleManager.setLoader(moduleLoader);moduleManager.setAllModuleInfo({modA:[],modB:["modA"]});moduleManager.setModuleUris({modA:["testdata/modA_1.js","testdata/modA_2.js"],modB:["testdata/modB_1.js"]});assertNotLoaded("modA");assertNotLoaded("modB");assertFalse(modA1Loaded)}function tearDown(){stubs.reset();goog.dispose(moduleLoader);assertNotNull(goog.module.ModuleManager.getInstance());moduleManager=goog.module.ModuleManager.instance_=null;modA1Loaded=!1;for(var scripts=goog.array.clone(goog.dom.getElementsByTagName(goog.dom.TagName.SCRIPT)),i=0;i<scripts.length;i++){if(-1!=scripts[i].src.indexOf("testdata")){goog.dom.removeNode(scripts[i])}}}function testLoadModuleA(){return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modA",function(){assertLoaded("modA");assertNotLoaded("modB");assertTrue(modA1Loaded);assertEquals("EVALUATE_CODE",0,observer.getEvents(EventType.EVALUATE_CODE).length);assertEquals("REQUEST_SUCCESS",1,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertArrayEquals(["modA"],observer.getEvents(EventType.REQUEST_SUCCESS)[0].moduleIds);assertEquals("REQUEST_ERROR",0,observer.getEvents(EventType.REQUEST_ERROR).length);resolve()})}).then(function(){assertEquals("EVALUATE_CODE after tick",1,observer.getEvents(EventType.EVALUATE_CODE).length);assertEquals("REQUEST_SUCCESS after tick",1,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertEquals("REQUEST_ERROR after tick",0,observer.getEvents(EventType.REQUEST_ERROR).length)})}function testLoadModuleB(){return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");assertTrue(modA1Loaded)})}function testLoadDebugModuleA(){moduleLoader.setDebugMode(!0);return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modA",resolve)}).then(function(){assertLoaded("modA");assertNotLoaded("modB");assertTrue(modA1Loaded)})}function testLoadDebugModuleB(){moduleLoader.setDebugMode(!0);return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");assertTrue(modA1Loaded)})}function testLoadDebugModuleAThenB(){moduleManager.setModuleUris({modA:["testdata/modA_2.js","testdata/modA_1.js"],modB:["testdata/modB_1.js"]});moduleLoader.setDebugMode(!0);return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");for(var scripts=goog.array.clone(goog.dom.getElementsByTagName(goog.dom.TagName.SCRIPT)),seenLastScriptOfModuleA=!1,i=0,uri;i<scripts.length;i++){uri=scripts[i].src;if(0<=uri.indexOf("modA_1.js")){seenLastScriptOfModuleA=!0}else if(0<=uri.indexOf("modB")){assertTrue(seenLastScriptOfModuleA)}}})}function testSourceInjection(){moduleLoader.setSourceUrlInjection(!0);return assertSourceInjection()}function testSourceInjectionViaDebugMode(){moduleLoader.setDebugMode(!0);return assertSourceInjection()}function assertSourceInjection(){return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertTrue(!!throwErrorInModuleB);var ex=assertThrows(function(){throwErrorInModuleB()});if(!ex.stack){return}var stackTrace=ex.stack.toString(),expectedString="testdata/modB_1.js";if(goog.module.ModuleLoader.supportsSourceUrlStackTraces()){assertContains(expectedString,stackTrace)}else if(moduleLoader.getDebugMode()){assertContains(expectedString,stackTrace)}else{assertNotContains(expectedString,stackTrace)}})}function testModuleLoaderRecursesTooDeep(opt_numModules){for(var numModules=opt_numModules||1,uris={},deps={},mods=[],num=0,modName;num<numModules;num++){modName="mod"+num;mods.unshift(modName);uris[modName]=[];deps[modName]=num?["mod"+(num-1)]:[];for(var i=0;5>i;i++){uris[modName].push("http://www.google.com/crossdomain"+num+"x"+i+".js")}}moduleManager.setAllModuleInfo(deps);moduleManager.setModuleUris(uris);var oldXmlHttp=goog.net.XmlHttp;stubs.set(goog.net,"XmlHttp",function(){return{open:goog.functions.error("mock error"),abort:goog.nullFunction}});goog.object.extend(goog.net.XmlHttp,oldXmlHttp);var errorCount=0,errorIds=[],errorHandler=function(ignored,modId){errorCount++;errorIds.push(modId)};moduleManager.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,errorHandler);moduleManager.execOnLoad(mods[0],function(){fail("modB should not load successfully")});assertEquals(mods.length,errorCount);goog.array.sort(mods);goog.array.sort(errorIds);assertArrayEquals(mods,errorIds);assertArrayEquals([],moduleManager.requestedModuleIdsQueue_);assertArrayEquals([],moduleManager.userInitiatedLoadingModuleIds_)}function testModuleLoaderRecursesTooDeep2modules(){testModuleLoaderRecursesTooDeep(2)}function testModuleLoaderRecursesTooDeep3modules(){testModuleLoaderRecursesTooDeep(3)}function testModuleLoaderRecursesTooDeep4modules(){testModuleLoaderRecursesTooDeep(3)}function testErrback(){if(goog.userAgent.IE)return;modA1Loaded=!0;return new goog.Promise(function(resolve,reject){var errorHandler=function(){assertNotLoaded("modA");resolve()};moduleManager.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,errorHandler);moduleManager.execOnLoad("modA",function(){fail("modA should not load successfully")})})}function testEventError(){if(goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(11)){return}modA1Loaded=!0;return new goog.Promise(function(resolve,reject){var errorHandler=function(){assertNotLoaded("modA");resolve()};moduleManager.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,errorHandler);moduleManager.execOnLoad("modA",function(){fail("modA should not load successfully")})}).then(function(){assertEquals("EVALUATE_CODE",3,observer.getEvents(EventType.EVALUATE_CODE).length);assertUndefined(observer.getEvents(EventType.EVALUATE_CODE)[0].error);assertEquals("REQUEST_SUCCESS",3,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertUndefined(observer.getEvents(EventType.REQUEST_SUCCESS)[0].error);var requestErrors=observer.getEvents(EventType.REQUEST_ERROR);assertEquals("REQUEST_ERROR",3,requestErrors.length);assertNotNull(requestErrors[0].error);var expectedString="loaded twice",messageAndStack=requestErrors[0].error.message+requestErrors[0].error.stack;assertContains(expectedString,messageAndStack)})}function testPrefetchThenLoadModuleA(){moduleManager.prefetchModule("modA");stubs.set(goog.net.BulkLoader.prototype,"load",function(){fail("modA should not be reloaded")});return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modA",resolve)}).then(function(){assertLoaded("modA");assertEquals("REQUEST_SUCCESS",1,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertArrayEquals(["modA"],observer.getEvents(EventType.REQUEST_SUCCESS)[0].moduleIds);assertEquals("REQUEST_ERROR",0,observer.getEvents(EventType.REQUEST_ERROR).length)})}function testPrefetchThenLoadModuleB(){moduleManager.prefetchModule("modB");stubs.set(goog.net.BulkLoader.prototype,"load",function(){fail("modA and modB should not be reloaded")});return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");assertEquals("REQUEST_SUCCESS",2,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertArrayEquals(["modA"],observer.getEvents(EventType.REQUEST_SUCCESS)[0].moduleIds);assertArrayEquals(["modB"],observer.getEvents(EventType.REQUEST_SUCCESS)[1].moduleIds);assertEquals("REQUEST_ERROR",0,observer.getEvents(EventType.REQUEST_ERROR).length)})}function testPrefetchModuleAThenLoadModuleB(){moduleManager.prefetchModule("modA");return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");assertEquals("REQUEST_SUCCESS",2,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertArrayEquals(["modA"],observer.getEvents(EventType.REQUEST_SUCCESS)[0].moduleIds);assertArrayEquals(["modB"],observer.getEvents(EventType.REQUEST_SUCCESS)[1].moduleIds);assertEquals("REQUEST_ERROR",0,observer.getEvents(EventType.REQUEST_ERROR).length)})}function testLoadModuleBThenPrefetchModuleA(){return new goog.Promise(function(resolve,reject){moduleManager.execOnLoad("modB",resolve)}).then(function(){assertLoaded("modA");assertLoaded("modB");assertEquals("REQUEST_SUCCESS",2,observer.getEvents(EventType.REQUEST_SUCCESS).length);assertArrayEquals(["modA"],observer.getEvents(EventType.REQUEST_SUCCESS)[0].moduleIds);assertArrayEquals(["modB"],observer.getEvents(EventType.REQUEST_SUCCESS)[1].moduleIds);assertEquals("REQUEST_ERROR",0,observer.getEvents(EventType.REQUEST_ERROR).length);assertThrows("Module load already requested: modB",function(){moduleManager.prefetchModule("modA")})})}function testPrefetchModuleWithBatchModeEnabled(){moduleManager.setBatchModeEnabled(!0);assertThrows("Modules prefetching is not supported in batch mode",function(){moduleManager.prefetchModule("modA")})}function testLoadErrorCallbackExecutedWhenPrefetchFails(){var oldXmlHttp=goog.net.XmlHttp;stubs.set(goog.net,"XmlHttp",function(){return{open:goog.functions.error("mock error"),abort:goog.nullFunction}});goog.object.extend(goog.net.XmlHttp,oldXmlHttp);var errorCount=0,errorHandler=function(){errorCount++};moduleManager.registerCallback(goog.module.ModuleManager.CallbackType.ERROR,errorHandler);moduleLoader.prefetchModule("modA",moduleManager.moduleInfoMap_.modA);moduleLoader.loadModules(["modA"],moduleManager.moduleInfoMap_,function(){fail("modA should not load successfully")},errorHandler);assertEquals(1,errorCount)}function assertLoaded(id){assertTrue(moduleManager.getModuleInfo(id).isLoaded())}function assertNotLoaded(id){assertFalse(moduleManager.getModuleInfo(id).isLoaded())}