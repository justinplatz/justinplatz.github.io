goog.provide("goog.ui.ac.Renderer");goog.provide("goog.ui.ac.Renderer.CustomRenderer");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.Role");goog.require("goog.a11y.aria.State");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dispose");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.TagName");goog.require("goog.dom.classlist");goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.fx.dom.FadeInAndShow");goog.require("goog.fx.dom.FadeOutAndHide");goog.require("goog.positioning");goog.require("goog.positioning.Corner");goog.require("goog.positioning.Overflow");goog.require("goog.string");goog.require("goog.style");goog.require("goog.ui.IdGenerator");goog.require("goog.ui.ac.AutoComplete");goog.ui.ac.Renderer=function(opt_parentNode,opt_customRenderer,opt_rightAlign,opt_useStandardHighlighting){goog.ui.ac.Renderer.base(this,"constructor");this.parent_=opt_parentNode||goog.dom.getDocument().body;this.dom_=goog.dom.getDomHelper(this.parent_);this.reposition_=!opt_parentNode;this.element_=null;this.token_="";this.rows_=[];this.rowDivs_=[];this.hilitedRow_=-1;this.startRenderingRows_=-1;this.visible_=!1;this.className=goog.getCssName("ac-renderer");this.rowClassName=goog.getCssName("ac-row");this.legacyActiveClassName_=goog.getCssName("active");this.activeClassName=goog.getCssName("ac-active");this.highlightedClassName=goog.getCssName("ac-highlighted");this.customRenderer_=opt_customRenderer||null;this.useStandardHighlighting_=null!=opt_useStandardHighlighting?opt_useStandardHighlighting:!0;this.matchWordBoundary_=!0;this.highlightAllTokens_=!1;this.rightAlign_=!!opt_rightAlign;this.topAlign_=!1;this.menuFadeDuration_=0;this.showScrollbarsIfTooLarge_=!1;this.animation_};goog.inherits(goog.ui.ac.Renderer,goog.events.EventTarget);goog.ui.ac.Renderer.prototype.anchorElement_;goog.ui.ac.Renderer.prototype.target_;goog.ui.ac.Renderer.prototype.widthProvider_;goog.ui.ac.Renderer.prototype.borderWidth_=0;goog.ui.ac.Renderer.prototype.wasHighlightedAtLeastOnce_;goog.ui.ac.Renderer.DELAY_BEFORE_MOUSEOVER=300;goog.ui.ac.Renderer.prototype.getElement=function(){return this.element_};goog.ui.ac.Renderer.prototype.setWidthProvider=function(widthProvider,opt_borderWidth){this.widthProvider_=widthProvider;if(opt_borderWidth){this.borderWidth_=opt_borderWidth}};goog.ui.ac.Renderer.prototype.setTopAlign=function(align){this.topAlign_=align};goog.ui.ac.Renderer.prototype.getTopAlign=function(){return this.topAlign_};goog.ui.ac.Renderer.prototype.setRightAlign=function(align){this.rightAlign_=align};goog.ui.ac.Renderer.prototype.getRightAlign=function(){return this.rightAlign_};goog.ui.ac.Renderer.prototype.setShowScrollbarsIfTooLarge=function(show){this.showScrollbarsIfTooLarge_=show};goog.ui.ac.Renderer.prototype.setUseStandardHighlighting=function(useStandardHighlighting){this.useStandardHighlighting_=useStandardHighlighting};goog.ui.ac.Renderer.prototype.setMatchWordBoundary=function(matchWordBoundary){this.matchWordBoundary_=matchWordBoundary};goog.ui.ac.Renderer.prototype.setHighlightAllTokens=function(highlightAllTokens){this.highlightAllTokens_=highlightAllTokens};goog.ui.ac.Renderer.prototype.setMenuFadeDuration=function(duration){this.menuFadeDuration_=duration};goog.ui.ac.Renderer.prototype.setAnchorElement=function(anchor){this.anchorElement_=anchor};goog.ui.ac.Renderer.prototype.getAnchorElement=function(){return this.anchorElement_};goog.ui.ac.Renderer.prototype.renderRows=function(rows,token,opt_target){this.token_=token;this.rows_=rows;this.hilitedRow_=-1;this.startRenderingRows_=goog.now();this.target_=opt_target;this.rowDivs_=[];this.redraw()};goog.ui.ac.Renderer.prototype.dismiss=function(){if(this.visible_){this.visible_=!1;this.toggleAriaMarkup_(!1);if(0<this.menuFadeDuration_){goog.dispose(this.animation_);this.animation_=new goog.fx.dom.FadeOutAndHide(this.element_,this.menuFadeDuration_);this.animation_.play()}else{goog.style.setElementShown(this.element_,!1)}}};goog.ui.ac.Renderer.prototype.show=function(){if(!this.visible_){this.visible_=!0;this.toggleAriaMarkup_(!0);if(0<this.menuFadeDuration_){goog.dispose(this.animation_);this.animation_=new goog.fx.dom.FadeInAndShow(this.element_,this.menuFadeDuration_);this.animation_.play()}else{goog.style.setElementShown(this.element_,!0)}}};goog.ui.ac.Renderer.prototype.toggleAriaMarkup_=function(isShown){if(!this.target_){return}goog.a11y.aria.setState(this.target_,goog.a11y.aria.State.HASPOPUP,isShown);goog.a11y.aria.setState(goog.asserts.assert(this.element_),goog.a11y.aria.State.EXPANDED,isShown);goog.a11y.aria.setState(this.target_,goog.a11y.aria.State.EXPANDED,isShown);if(isShown){goog.a11y.aria.setState(this.target_,goog.a11y.aria.State.OWNS,this.element_.id)}else{goog.a11y.aria.removeState(this.target_,goog.a11y.aria.State.OWNS);goog.a11y.aria.setActiveDescendant(this.target_,null)}};goog.ui.ac.Renderer.prototype.isVisible=function(){return this.visible_};goog.ui.ac.Renderer.prototype.hiliteRow=function(index){var row=0<=index&&index<this.rows_.length?this.rows_[index]:void 0,rowDiv=0<=index&&index<this.rowDivs_.length?this.rowDivs_[index]:void 0,evtObj={type:goog.ui.ac.AutoComplete.EventType.ROW_HILITE,rowNode:rowDiv,row:row?row.data:null};if(this.dispatchEvent(evtObj)){this.hiliteNone();this.hilitedRow_=index;if(rowDiv){goog.dom.classlist.addAll(rowDiv,[this.activeClassName,this.legacyActiveClassName_]);if(this.target_){goog.a11y.aria.setActiveDescendant(this.target_,rowDiv)}goog.style.scrollIntoContainerView(rowDiv,this.element_)}}};goog.ui.ac.Renderer.prototype.hiliteNone=function(){if(0<=this.hilitedRow_){goog.dom.classlist.removeAll(goog.asserts.assert(this.rowDivs_[this.hilitedRow_]),[this.activeClassName,this.legacyActiveClassName_])}};goog.ui.ac.Renderer.prototype.hiliteId=function(id){if(-1==id){this.hiliteRow(-1)}else{for(var i=0;i<this.rows_.length;i++){if(this.rows_[i].id==id){this.hiliteRow(i);return}}}};goog.ui.ac.Renderer.prototype.setMenuClasses_=function(elem){goog.asserts.assert(elem);goog.dom.classlist.addAll(elem,goog.string.trim(this.className).split(" "))};goog.ui.ac.Renderer.prototype.maybeCreateElement_=function(){if(!this.element_){var el=this.dom_.createDom(goog.dom.TagName.DIV,{style:"display:none"});if(this.showScrollbarsIfTooLarge_){el.style.overflowY="auto"}this.element_=el;this.setMenuClasses_(el);goog.a11y.aria.setRole(el,goog.a11y.aria.Role.LISTBOX);el.id=goog.ui.IdGenerator.getInstance().getNextUniqueId();this.dom_.appendChild(this.parent_,el);goog.events.listen(el,goog.events.EventType.CLICK,this.handleClick_,!1,this);goog.events.listen(el,goog.events.EventType.MOUSEDOWN,this.handleMouseDown_,!1,this);goog.events.listen(el,goog.events.EventType.MOUSEOVER,this.handleMouseOver_,!1,this)}};goog.ui.ac.Renderer.prototype.redraw=function(){this.maybeCreateElement_();if(this.topAlign_){this.element_.style.visibility="hidden"}if(this.widthProvider_){var width=this.widthProvider_.clientWidth-this.borderWidth_+"px";this.element_.style.minWidth=width}this.rowDivs_.length=0;this.dom_.removeChildren(this.element_);if(this.customRenderer_&&this.customRenderer_.render){this.customRenderer_.render(this,this.element_,this.rows_,this.token_)}else{var curRow=null;goog.array.forEach(this.rows_,function(row){row=this.renderRowHtml(row,this.token_);if(this.topAlign_){this.element_.insertBefore(row,curRow)}else{this.dom_.appendChild(this.element_,row)}curRow=row},this)}if(0==this.rows_.length){this.dismiss();return}else{this.show()}this.reposition();goog.style.setUnselectable(this.element_,!0)};goog.ui.ac.Renderer.prototype.getAnchorCorner=function(){var anchorCorner=this.rightAlign_?goog.positioning.Corner.BOTTOM_RIGHT:goog.positioning.Corner.BOTTOM_LEFT;if(this.topAlign_){anchorCorner=goog.positioning.flipCornerVertical(anchorCorner)}return anchorCorner};goog.ui.ac.Renderer.prototype.reposition=function(){if(this.target_&&this.reposition_){var anchorElement=this.anchorElement_||this.target_,anchorCorner=this.getAnchorCorner(),overflowMode=goog.positioning.Overflow.ADJUST_X_EXCEPT_OFFSCREEN;if(this.showScrollbarsIfTooLarge_){this.element_.style.height="";overflowMode|=goog.positioning.Overflow.RESIZE_HEIGHT}goog.positioning.positionAtAnchor(anchorElement,anchorCorner,this.element_,goog.positioning.flipCornerVertical(anchorCorner),null,null,overflowMode);if(this.topAlign_){this.element_.style.visibility="visible"}}};goog.ui.ac.Renderer.prototype.setAutoPosition=function(auto){this.reposition_=auto};goog.ui.ac.Renderer.prototype.getAutoPosition=function(){return this.reposition_};goog.ui.ac.Renderer.prototype.getTarget=function(){return this.target_||null};goog.ui.ac.Renderer.prototype.disposeInternal=function(){if(this.element_){goog.events.unlisten(this.element_,goog.events.EventType.CLICK,this.handleClick_,!1,this);goog.events.unlisten(this.element_,goog.events.EventType.MOUSEDOWN,this.handleMouseDown_,!1,this);goog.events.unlisten(this.element_,goog.events.EventType.MOUSEOVER,this.handleMouseOver_,!1,this);this.dom_.removeNode(this.element_);this.element_=null;this.visible_=!1}goog.dispose(this.animation_);this.parent_=null;goog.ui.ac.Renderer.base(this,"disposeInternal")};goog.ui.ac.Renderer.prototype.renderRowContents_=function(row,token,node){goog.dom.setTextContent(node,row.data.toString())};goog.ui.ac.Renderer.prototype.startHiliteMatchingText_=function(node,tokenOrArray){this.wasHighlightedAtLeastOnce_=!1;this.hiliteMatchingText_(node,tokenOrArray)};goog.ui.ac.Renderer.prototype.hiliteMatchingText_=function(node,tokenOrArray){if(!this.highlightAllTokens_&&this.wasHighlightedAtLeastOnce_){return}if(node.nodeType==goog.dom.NodeType.TEXT){var rest=null;if(goog.isArray(tokenOrArray)&&1<tokenOrArray.length&&!this.highlightAllTokens_){rest=goog.array.slice(tokenOrArray,1)}var token=this.getTokenRegExp_(tokenOrArray);if(0==token.length)return;var text=node.nodeValue,re=this.matchWordBoundary_?new RegExp("\\b(?:"+token+")","gi"):new RegExp(token,"gi"),textNodes=[],lastIndex=0,match=re.exec(text),numMatches=0;while(match){numMatches++;textNodes.push(text.substring(lastIndex,match.index));textNodes.push(text.substring(match.index,re.lastIndex));lastIndex=re.lastIndex;match=re.exec(text)}textNodes.push(text.substring(lastIndex));if(1<textNodes.length){for(var maxNumToBold=!this.highlightAllTokens_?1:numMatches,i=0,idx;i<maxNumToBold;i++){idx=2*i;node.nodeValue=textNodes[idx];var boldTag=this.dom_.createElement(goog.dom.TagName.B);boldTag.className=this.highlightedClassName;this.dom_.appendChild(boldTag,this.dom_.createTextNode(textNodes[idx+1]));boldTag=node.parentNode.insertBefore(boldTag,node.nextSibling);node.parentNode.insertBefore(this.dom_.createTextNode(""),boldTag.nextSibling);node=boldTag.nextSibling}var remainingTextNodes=goog.array.slice(textNodes,2*maxNumToBold);node.nodeValue=remainingTextNodes.join("");this.wasHighlightedAtLeastOnce_=!0}else if(rest){this.hiliteMatchingText_(node,rest)}}else{var child=node.firstChild;while(child){var nextChild=child.nextSibling;this.hiliteMatchingText_(child,tokenOrArray);child=nextChild}}};goog.ui.ac.Renderer.prototype.getTokenRegExp_=function(tokenOrArray){var token="";if(!tokenOrArray){return token}if(goog.isArray(tokenOrArray)){tokenOrArray=goog.array.filter(tokenOrArray,function(str){return!goog.string.isEmptyOrWhitespace(goog.string.makeSafe(str))})}if(this.highlightAllTokens_){if(goog.isArray(tokenOrArray)){var tokenArray=goog.array.map(tokenOrArray,goog.string.regExpEscape);token=tokenArray.join("|")}else{token=goog.string.collapseWhitespace(tokenOrArray);token=goog.string.regExpEscape(token);token=token.replace(/ /g,"|")}}else{if(goog.isArray(tokenOrArray)){token=0<tokenOrArray.length?goog.string.regExpEscape(tokenOrArray[0]):""}else{if(!/^\W/.test(tokenOrArray)){token=goog.string.regExpEscape(tokenOrArray)}}}return token};goog.ui.ac.Renderer.prototype.renderRowHtml=function(row,token){var elem=this.dom_.createDom(goog.dom.TagName.DIV,{className:this.rowClassName,id:goog.ui.IdGenerator.getInstance().getNextUniqueId()});goog.a11y.aria.setRole(elem,goog.a11y.aria.Role.OPTION);if(this.customRenderer_&&this.customRenderer_.renderRow){this.customRenderer_.renderRow(row,token,elem)}else{this.renderRowContents_(row,token,elem)}if(token&&this.useStandardHighlighting_){this.startHiliteMatchingText_(elem,token)}goog.dom.classlist.add(elem,this.rowClassName);this.rowDivs_.push(elem);return elem};goog.ui.ac.Renderer.prototype.getRowFromEventTarget_=function(et){while(et&&et!=this.element_&&!goog.dom.classlist.contains(et,this.rowClassName)){et=et.parentNode}return et?goog.array.indexOf(this.rowDivs_,et):-1};goog.ui.ac.Renderer.prototype.handleClick_=function(e){var index=this.getRowFromEventTarget_(e.target);if(0<=index){this.dispatchEvent({type:goog.ui.ac.AutoComplete.EventType.SELECT,row:this.rows_[index].id})}e.stopPropagation()};goog.ui.ac.Renderer.prototype.handleMouseDown_=function(e){e.stopPropagation();e.preventDefault()};goog.ui.ac.Renderer.prototype.handleMouseOver_=function(e){var index=this.getRowFromEventTarget_(e.target);if(0<=index){if(goog.now()-this.startRenderingRows_<goog.ui.ac.Renderer.DELAY_BEFORE_MOUSEOVER){return}this.dispatchEvent({type:goog.ui.ac.AutoComplete.EventType.HILITE,row:this.rows_[index].id})}};goog.ui.ac.Renderer.CustomRenderer=function(){};goog.ui.ac.Renderer.CustomRenderer.prototype.render=function(renderer,element,rows,token){};goog.ui.ac.Renderer.CustomRenderer.prototype.renderRow=function(row,token,node){};