goog.provide("goog.net.CrossDomainRpc");goog.require("goog.Uri");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.dom.safe");goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.html.SafeHtml");goog.require("goog.json");goog.require("goog.log");goog.require("goog.net.EventType");goog.require("goog.net.HttpStatus");goog.require("goog.string");goog.require("goog.userAgent");goog.net.CrossDomainRpc=function(){goog.events.EventTarget.call(this)};goog.inherits(goog.net.CrossDomainRpc,goog.events.EventTarget);goog.net.CrossDomainRpc.RESPONSE_MARKER_="xdrp";goog.net.CrossDomainRpc.useFallBackDummyResource_=!0;goog.net.CrossDomainRpc.prototype.responseHeaders;goog.net.CrossDomainRpc.prototype.responseText;goog.net.CrossDomainRpc.prototype.status;goog.net.CrossDomainRpc.prototype.timeWaitedAfterResponseReady_;goog.net.CrossDomainRpc.prototype.responseTextIsJson_;goog.net.CrossDomainRpc.prototype.responseReady_;goog.net.CrossDomainRpc.prototype.requestFrame_;goog.net.CrossDomainRpc.prototype.loadListenerKey_;goog.net.CrossDomainRpc.isInResponseIframe_=function(){return window.location&&(1==window.location.hash.indexOf(goog.net.CrossDomainRpc.RESPONSE_MARKER_)||1==window.location.search.indexOf(goog.net.CrossDomainRpc.RESPONSE_MARKER_))};if(goog.net.CrossDomainRpc.isInResponseIframe_()){if(goog.userAgent.EDGE_OR_IE){document.execCommand("Stop")}else if(goog.userAgent.GECKO){window.stop()}else{throw Error("stopped")}}goog.net.CrossDomainRpc.setDummyResourceUri=function(dummyResourceUri){goog.net.CrossDomainRpc.dummyResourceUri_=dummyResourceUri};goog.net.CrossDomainRpc.setUseFallBackDummyResource=function(useFallBack){goog.net.CrossDomainRpc.useFallBackDummyResource_=useFallBack};goog.net.CrossDomainRpc.send=function(uri,opt_continuation,opt_method,opt_params,opt_headers){var xdrpc=new goog.net.CrossDomainRpc;if(opt_continuation){goog.events.listen(xdrpc,goog.net.EventType.COMPLETE,opt_continuation)}goog.events.listen(xdrpc,goog.net.EventType.READY,xdrpc.reset);xdrpc.sendRequest(uri,opt_method,opt_params,opt_headers)};goog.net.CrossDomainRpc.setDebugMode=function(flag){goog.net.CrossDomainRpc.debugMode_=flag};goog.net.CrossDomainRpc.logger_=goog.log.getLogger("goog.net.CrossDomainRpc");goog.net.CrossDomainRpc.createInputHtml_=function(name,value){return goog.html.SafeHtml.create("textarea",{name:name},value+"")};goog.net.CrossDomainRpc.getDummyResourceUri_=function(){if(goog.net.CrossDomainRpc.dummyResourceUri_){return goog.net.CrossDomainRpc.dummyResourceUri_}if(goog.userAgent.GECKO){for(var links=goog.dom.getElementsByTagName(goog.dom.TagName.LINK),i=0,link;i<links.length;i++){link=links[i];if("stylesheet"==link.rel&&goog.Uri.haveSameDomain(link.href,window.location.href)&&0>link.href.indexOf("?")){return goog.net.CrossDomainRpc.removeHash_(link.href)}}}for(var images=goog.dom.getElementsByTagName(goog.dom.TagName.IMG),i=0,image;i<images.length;i++){image=images[i];if(goog.Uri.haveSameDomain(image.src,window.location.href)&&0>image.src.indexOf("?")){return goog.net.CrossDomainRpc.removeHash_(image.src)}}if(!goog.net.CrossDomainRpc.useFallBackDummyResource_){throw Error("No suitable dummy resource specified or detected for this page")}if(goog.userAgent.EDGE_OR_IE){return goog.net.CrossDomainRpc.removeHash_(window.location.href)}else{var locationHref=window.location.href,rootSlash=locationHref.indexOf("/",locationHref.indexOf("//")+2),rootHref=locationHref.substring(0,rootSlash);return rootHref+"/robots.txt"}};goog.net.CrossDomainRpc.removeHash_=function(uri){return uri.split("#")[0]};goog.net.CrossDomainRpc.nextRequestId_=0;goog.net.CrossDomainRpc.HEADER="xdh:";goog.net.CrossDomainRpc.PARAM="xdp:";goog.net.CrossDomainRpc.PARAM_ECHO="xdpe:";goog.net.CrossDomainRpc.PARAM_ECHO_REQUEST_ID=goog.net.CrossDomainRpc.PARAM_ECHO+"request-id";goog.net.CrossDomainRpc.PARAM_ECHO_DUMMY_URI=goog.net.CrossDomainRpc.PARAM_ECHO+"dummy-uri";goog.net.CrossDomainRpc.REQUEST_MARKER_="xdrq";goog.net.CrossDomainRpc.prototype.sendRequest=function(uri,opt_method,opt_params,opt_headers){var requestFrame=this.requestFrame_=goog.dom.createElement(goog.dom.TagName.IFRAME),requestId=goog.net.CrossDomainRpc.nextRequestId_++;requestFrame.id=goog.net.CrossDomainRpc.REQUEST_MARKER_+"-"+requestId;if(!goog.net.CrossDomainRpc.debugMode_){requestFrame.style.position="absolute";requestFrame.style.top="-5000px";requestFrame.style.left="-5000px"}document.body.appendChild(requestFrame);var inputs=[goog.net.CrossDomainRpc.createInputHtml_(goog.net.CrossDomainRpc.PARAM_ECHO_REQUEST_ID,requestId)],dummyUri=goog.net.CrossDomainRpc.getDummyResourceUri_();goog.log.fine(goog.net.CrossDomainRpc.logger_,"dummyUri: "+dummyUri);inputs.push(goog.net.CrossDomainRpc.createInputHtml_(goog.net.CrossDomainRpc.PARAM_ECHO_DUMMY_URI,dummyUri));if(opt_params){for(var name in opt_params){var value=opt_params[name];inputs.push(goog.net.CrossDomainRpc.createInputHtml_(goog.net.CrossDomainRpc.PARAM+name,value))}}if(opt_headers){for(var name in opt_headers){var value=opt_headers[name];inputs.push(goog.net.CrossDomainRpc.createInputHtml_(goog.net.CrossDomainRpc.HEADER+name,value))}}var requestFrameContentHtml=goog.html.SafeHtml.create("body",{},goog.html.SafeHtml.create("form",{method:"GET"==opt_method?"GET":"POST",action:uri},inputs)),requestFrameDoc=goog.dom.getFrameContentDocument(requestFrame);requestFrameDoc.open();goog.dom.safe.documentWrite(requestFrameDoc,requestFrameContentHtml);requestFrameDoc.close();requestFrameDoc.forms[0].submit();requestFrameDoc=null;this.loadListenerKey_=goog.events.listen(requestFrame,goog.events.EventType.LOAD,function(){goog.log.fine(goog.net.CrossDomainRpc.logger_,"response ready");this.responseReady_=!0},!1,this);this.receiveResponse_()};goog.net.CrossDomainRpc.RESPONSE_POLLING_PERIOD_=50;goog.net.CrossDomainRpc.SEND_RESPONSE_TIME_OUT_=500;goog.net.CrossDomainRpc.prototype.receiveResponse_=function(){this.timeWaitedAfterResponseReady_=0;var responseDetectorHandle=window.setInterval(goog.bind(function(){this.detectResponse_(responseDetectorHandle)},this),goog.net.CrossDomainRpc.RESPONSE_POLLING_PERIOD_)};goog.net.CrossDomainRpc.prototype.detectResponse_=function(responseDetectorHandle){var requestFrameWindow=this.requestFrame_.contentWindow,grandChildrenLength=requestFrameWindow.frames.length,responseInfoFrame=null;if(0<grandChildrenLength&&goog.net.CrossDomainRpc.isResponseInfoFrame_(responseInfoFrame=requestFrameWindow.frames[grandChildrenLength-1])){goog.log.fine(goog.net.CrossDomainRpc.logger_,"xd response ready");var responseInfoPayload=goog.net.CrossDomainRpc.getFramePayload_(responseInfoFrame).substring(1),params=new goog.Uri.QueryData(responseInfoPayload),chunks=[],numChunks=+params.get("n");goog.log.fine(goog.net.CrossDomainRpc.logger_,"xd response number of chunks: "+numChunks);for(var i=0,responseFrame;i<numChunks;i++){responseFrame=requestFrameWindow.frames[i];if(!responseFrame||!responseFrame.location||!responseFrame.location.href){goog.log.fine(goog.net.CrossDomainRpc.logger_,"xd response iframe not ready");return}var responseChunkPayload=goog.net.CrossDomainRpc.getFramePayload_(responseFrame),chunkIndex=responseChunkPayload.indexOf(goog.net.CrossDomainRpc.PARAM_CHUNK_)+goog.net.CrossDomainRpc.PARAM_CHUNK_.length+1,chunk=responseChunkPayload.substring(chunkIndex);chunks.push(chunk)}window.clearInterval(responseDetectorHandle);var responseData=chunks.join("");if(!goog.userAgent.EDGE_OR_IE){responseData=decodeURIComponent(responseData)}this.status=+params.get("status");this.responseText=responseData;this.responseTextIsJson_="true"==params.get("isDataJson");this.responseHeaders=goog.json.unsafeParse(params.get("headers"));this.dispatchEvent(goog.net.EventType.READY);this.dispatchEvent(goog.net.EventType.COMPLETE)}else{if(this.responseReady_){this.timeWaitedAfterResponseReady_+=goog.net.CrossDomainRpc.RESPONSE_POLLING_PERIOD_;if(this.timeWaitedAfterResponseReady_>goog.net.CrossDomainRpc.SEND_RESPONSE_TIME_OUT_){goog.log.fine(goog.net.CrossDomainRpc.logger_,"xd response timed out");window.clearInterval(responseDetectorHandle);this.status=goog.net.HttpStatus.INTERNAL_SERVER_ERROR;this.responseText="response timed out";this.dispatchEvent(goog.net.EventType.READY);this.dispatchEvent(goog.net.EventType.ERROR);this.dispatchEvent(goog.net.EventType.COMPLETE)}}}};goog.net.CrossDomainRpc.isResponseInfoFrame_=function(frame){try{return 1==goog.net.CrossDomainRpc.getFramePayload_(frame).indexOf(goog.net.CrossDomainRpc.RESPONSE_INFO_MARKER_)}catch(e){return!1}};goog.net.CrossDomainRpc.getFramePayload_=function(frame){var href=frame.location.href,question=href.indexOf("?"),hash=href.indexOf("#"),delimiter=0>question?hash:0>hash?question:Math.min(question,hash);return href.substring(delimiter)};goog.net.CrossDomainRpc.prototype.getResponseJson=function(){return this.responseTextIsJson_?goog.json.unsafeParse(this.responseText):void 0};goog.net.CrossDomainRpc.prototype.isSuccess=function(){switch(this.status){case goog.net.HttpStatus.OK:case goog.net.HttpStatus.NOT_MODIFIED:return!0;default:return!1;}};goog.net.CrossDomainRpc.prototype.reset=function(){if(!goog.net.CrossDomainRpc.debugMode_){goog.log.fine(goog.net.CrossDomainRpc.logger_,"request frame removed: "+this.requestFrame_.id);goog.events.unlistenByKey(this.loadListenerKey_);this.requestFrame_.parentNode.removeChild(this.requestFrame_)}delete this.requestFrame_};goog.net.CrossDomainRpc.RESPONSE_INFO_MARKER_=goog.net.CrossDomainRpc.RESPONSE_MARKER_+"-info";goog.net.CrossDomainRpc.MAX_CHUNK_SIZE_=goog.userAgent.EDGE_OR_IE?4095:1024*1024;goog.net.CrossDomainRpc.PARAM_CHUNK_="chunk";goog.net.CrossDomainRpc.CHUNK_PREFIX_=goog.net.CrossDomainRpc.RESPONSE_MARKER_+"=1&"+goog.net.CrossDomainRpc.PARAM_CHUNK_+"=";goog.net.CrossDomainRpc.sendResponse=function(data,isDataJson,echo,status,headers){var dummyUri=echo[goog.net.CrossDomainRpc.PARAM_ECHO_DUMMY_URI];if(!goog.string.caseInsensitiveStartsWith(dummyUri,"http://")&&!goog.string.caseInsensitiveStartsWith(dummyUri,"https://")){dummyUri="http://"+dummyUri}var chunkSize=goog.net.CrossDomainRpc.MAX_CHUNK_SIZE_-dummyUri.length-1-goog.net.CrossDomainRpc.CHUNK_PREFIX_.length-1;if(!goog.userAgent.EDGE_OR_IE){data=encodeURIComponent(data)}var numChunksToSend=Math.ceil(data.length/chunkSize);if(0==numChunksToSend){goog.net.CrossDomainRpc.createResponseInfo_(dummyUri,numChunksToSend,isDataJson,status,headers)}else{for(var numChunksSent=0,checkToCreateResponseInfo_=function(){if(++numChunksSent==numChunksToSend){goog.net.CrossDomainRpc.createResponseInfo_(dummyUri,numChunksToSend,isDataJson,status,headers)}},i=0;i<numChunksToSend;i++){var chunkStart=i*chunkSize,chunkEnd=chunkStart+chunkSize,chunk=chunkEnd>data.length?data.substring(chunkStart):data.substring(chunkStart,chunkEnd),responseFrame=goog.dom.createElement(goog.dom.TagName.IFRAME);responseFrame.src=dummyUri+goog.net.CrossDomainRpc.getPayloadDelimiter_(dummyUri)+goog.net.CrossDomainRpc.CHUNK_PREFIX_+chunk;document.body.appendChild(responseFrame);checkToCreateResponseInfo_()}}};goog.net.CrossDomainRpc.createResponseInfo_=function(dummyUri,numChunks,isDataJson,status,headers){var responseInfoFrame=goog.dom.createElement(goog.dom.TagName.IFRAME);document.body.appendChild(responseInfoFrame);responseInfoFrame.src=dummyUri+goog.net.CrossDomainRpc.getPayloadDelimiter_(dummyUri)+goog.net.CrossDomainRpc.RESPONSE_INFO_MARKER_+"=1&n="+numChunks+"&isDataJson="+isDataJson+"&status="+status+"&headers="+encodeURIComponent(headers)};goog.net.CrossDomainRpc.getPayloadDelimiter_=function(dummyUri){return goog.net.CrossDomainRpc.REFERRER_==dummyUri?"?":"#"};goog.net.CrossDomainRpc.removeUriParams_=function(uri){var question=uri.indexOf("?");if(0<question){uri=uri.substring(0,question)}var hash=uri.indexOf("#");if(0<hash){uri=uri.substring(0,hash)}return uri};goog.net.CrossDomainRpc.prototype.getResponseHeader=function(name){return goog.isObject(this.responseHeaders)?this.responseHeaders[name]:void 0};goog.net.CrossDomainRpc.REFERRER_=goog.net.CrossDomainRpc.removeUriParams_(document.referrer);