goog.provide("goog.net.ChannelRequest");goog.provide("goog.net.ChannelRequest.Error");goog.require("goog.Timer");goog.require("goog.async.Throttle");goog.require("goog.dom.TagName");goog.require("goog.dom.safe");goog.require("goog.events.EventHandler");goog.require("goog.html.SafeUrl");goog.require("goog.html.uncheckedconversions");goog.require("goog.net.ErrorCode");goog.require("goog.net.EventType");goog.require("goog.net.XmlHttp");goog.require("goog.object");goog.require("goog.string");goog.require("goog.string.Const");goog.require("goog.userAgent");goog.net.ChannelRequest=function(channel,channelDebug,opt_sessionId,opt_requestId,opt_retryId){this.channel_=channel;this.channelDebug_=channelDebug;this.sid_=opt_sessionId;this.rid_=opt_requestId;this.retryId_=opt_retryId||1;this.timeout_=goog.net.ChannelRequest.TIMEOUT_MS;this.eventHandler_=new goog.events.EventHandler(this);this.pollingTimer_=new goog.Timer;this.pollingTimer_.setInterval(goog.net.ChannelRequest.POLLING_INTERVAL_MS)};goog.net.ChannelRequest.prototype.extraHeaders_=null;goog.net.ChannelRequest.prototype.successful_=!1;goog.net.ChannelRequest.prototype.watchDogTimerId_=null;goog.net.ChannelRequest.prototype.watchDogTimeoutTime_=null;goog.net.ChannelRequest.prototype.requestStartTime_=null;goog.net.ChannelRequest.prototype.type_=null;goog.net.ChannelRequest.prototype.baseUri_=null;goog.net.ChannelRequest.prototype.requestUri_=null;goog.net.ChannelRequest.prototype.postData_=null;goog.net.ChannelRequest.prototype.xmlHttp_=null;goog.net.ChannelRequest.prototype.xmlHttpChunkStart_=0;goog.net.ChannelRequest.prototype.trident_=null;goog.net.ChannelRequest.prototype.verb_=null;goog.net.ChannelRequest.prototype.lastError_=null;goog.net.ChannelRequest.prototype.lastStatusCode_=-1;goog.net.ChannelRequest.prototype.sendClose_=!0;goog.net.ChannelRequest.prototype.cancelled_=!1;goog.net.ChannelRequest.prototype.readyStateChangeThrottleMs_=0;goog.net.ChannelRequest.prototype.readyStateChangeThrottle_=null;goog.net.ChannelRequest.TIMEOUT_MS=1e3*45;goog.net.ChannelRequest.POLLING_INTERVAL_MS=250;goog.net.ChannelRequest.MIN_WEBKIT_FOR_INTERACTIVE_="420+";goog.net.ChannelRequest.Type_={XML_HTTP:1,IMG:2,TRIDENT:3};goog.net.ChannelRequest.Error={STATUS:0,NO_DATA:1,TIMEOUT:2,UNKNOWN_SESSION_ID:3,BAD_DATA:4,HANDLER_EXCEPTION:5,BROWSER_OFFLINE:6,ACTIVE_X_BLOCKED:7};goog.net.ChannelRequest.errorStringFromCode=function(errorCode,statusCode){switch(errorCode){case goog.net.ChannelRequest.Error.STATUS:return"Non-200 return code ("+statusCode+")";case goog.net.ChannelRequest.Error.NO_DATA:return"XMLHTTP failure (no data)";case goog.net.ChannelRequest.Error.TIMEOUT:return"HttpConnection timeout";default:return"Unknown error";}};goog.net.ChannelRequest.INVALID_CHUNK_={};goog.net.ChannelRequest.INCOMPLETE_CHUNK_={};goog.net.ChannelRequest.supportsXhrStreaming=function(){return!goog.userAgent.IE||goog.userAgent.isDocumentModeOrHigher(10)};goog.net.ChannelRequest.prototype.setExtraHeaders=function(extraHeaders){this.extraHeaders_=extraHeaders};goog.net.ChannelRequest.prototype.setTimeout=function(timeout){this.timeout_=timeout};goog.net.ChannelRequest.prototype.setReadyStateChangeThrottle=function(throttle){this.readyStateChangeThrottleMs_=throttle};goog.net.ChannelRequest.prototype.xmlHttpPost=function(uri,postData,decodeChunks){this.type_=goog.net.ChannelRequest.Type_.XML_HTTP;this.baseUri_=uri.clone().makeUnique();this.postData_=postData;this.decodeChunks_=decodeChunks;this.sendXmlHttp_(null)};goog.net.ChannelRequest.prototype.xmlHttpGet=function(uri,decodeChunks,hostPrefix,opt_noClose){this.type_=goog.net.ChannelRequest.Type_.XML_HTTP;this.baseUri_=uri.clone().makeUnique();this.postData_=null;this.decodeChunks_=decodeChunks;if(opt_noClose){this.sendClose_=!1}this.sendXmlHttp_(hostPrefix)};goog.net.ChannelRequest.prototype.sendXmlHttp_=function(hostPrefix){this.requestStartTime_=goog.now();this.ensureWatchDogTimer_();this.requestUri_=this.baseUri_.clone();this.requestUri_.setParameterValues("t",this.retryId_);this.xmlHttpChunkStart_=0;var useSecondaryDomains=this.channel_.shouldUseSecondaryDomains();this.xmlHttp_=this.channel_.createXhrIo(useSecondaryDomains?hostPrefix:null);if(0<this.readyStateChangeThrottleMs_){this.readyStateChangeThrottle_=new goog.async.Throttle(goog.bind(this.xmlHttpHandler_,this,this.xmlHttp_),this.readyStateChangeThrottleMs_)}this.eventHandler_.listen(this.xmlHttp_,goog.net.EventType.READY_STATE_CHANGE,this.readyStateChangeHandler_);var headers=this.extraHeaders_?goog.object.clone(this.extraHeaders_):{};if(this.postData_){this.verb_="POST";headers["Content-Type"]="application/x-www-form-urlencoded";this.xmlHttp_.send(this.requestUri_,this.verb_,this.postData_,headers)}else{this.verb_="GET";if(this.sendClose_&&!goog.userAgent.WEBKIT){headers.Connection="close"}this.xmlHttp_.send(this.requestUri_,this.verb_,null,headers)}this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_MADE);this.channelDebug_.xmlHttpChannelRequest(this.verb_,this.requestUri_,this.rid_,this.retryId_,this.postData_)};goog.net.ChannelRequest.prototype.readyStateChangeHandler_=function(evt){var xhr=evt.target,throttle=this.readyStateChangeThrottle_;if(throttle&&xhr.getReadyState()==goog.net.XmlHttp.ReadyState.INTERACTIVE){this.channelDebug_.debug("Throttling readystatechange.");throttle.fire()}else{this.xmlHttpHandler_(xhr)}};goog.net.ChannelRequest.prototype.xmlHttpHandler_=function(xmlhttp){goog.net.BrowserChannel.onStartExecution();try{if(xmlhttp==this.xmlHttp_){this.onXmlHttpReadyStateChanged_()}else{this.channelDebug_.warning("Called back with an "+"unexpected xmlhttp")}}catch(ex){this.channelDebug_.debug("Failed call to OnXmlHttpReadyStateChanged_");if(this.xmlHttp_&&this.xmlHttp_.getResponseText()){this.channelDebug_.dumpException(ex,"ResponseText: "+this.xmlHttp_.getResponseText())}else{this.channelDebug_.dumpException(ex,"No response text")}}finally{goog.net.BrowserChannel.onEndExecution()}};goog.net.ChannelRequest.prototype.onXmlHttpReadyStateChanged_=function(){var readyState=this.xmlHttp_.getReadyState(),errorCode=this.xmlHttp_.getLastErrorCode(),statusCode=this.xmlHttp_.getStatus();if(!goog.net.ChannelRequest.supportsXhrStreaming()||goog.userAgent.WEBKIT&&!goog.userAgent.isVersionOrHigher(goog.net.ChannelRequest.MIN_WEBKIT_FOR_INTERACTIVE_)){if(readyState<goog.net.XmlHttp.ReadyState.COMPLETE){return}}else{if(readyState<goog.net.XmlHttp.ReadyState.INTERACTIVE||readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE&&!goog.userAgent.OPERA&&!this.xmlHttp_.getResponseText()){return}}if(!this.cancelled_&&readyState==goog.net.XmlHttp.ReadyState.COMPLETE&&errorCode!=goog.net.ErrorCode.ABORT){if(errorCode==goog.net.ErrorCode.TIMEOUT||0>=statusCode){this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_FAILED)}else{this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_SUCCEEDED)}}this.cancelWatchDogTimer_();var status=this.xmlHttp_.getStatus();this.lastStatusCode_=status;var responseText=this.xmlHttp_.getResponseText();if(!responseText){this.channelDebug_.debug("No response text for uri "+this.requestUri_+" status "+status)}this.successful_=200==status;this.channelDebug_.xmlHttpChannelResponseMetaData(this.verb_,this.requestUri_,this.rid_,this.retryId_,readyState,status);if(!this.successful_){if(400==status&&0<responseText.indexOf("Unknown SID")){this.lastError_=goog.net.ChannelRequest.Error.UNKNOWN_SESSION_ID;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_UNKNOWN_SESSION_ID);this.channelDebug_.warning("XMLHTTP Unknown SID ("+this.rid_+")")}else{this.lastError_=goog.net.ChannelRequest.Error.STATUS;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_BAD_STATUS);this.channelDebug_.warning("XMLHTTP Bad status "+status+" ("+this.rid_+")")}this.cleanup_();this.dispatchFailure_();return}if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.cleanup_()}if(this.decodeChunks_){this.decodeNextChunks_(readyState,responseText);if(goog.userAgent.OPERA&&this.successful_&&readyState==goog.net.XmlHttp.ReadyState.INTERACTIVE){this.startPolling_()}}else{this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,null);this.safeOnRequestData_(responseText)}if(!this.successful_){return}if(!this.cancelled_){if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.channel_.onRequestComplete(this)}else{this.successful_=!1;this.ensureWatchDogTimer_()}}};goog.net.ChannelRequest.prototype.decodeNextChunks_=function(readyState,responseText){var decodeNextChunksSuccessful=!0;while(!this.cancelled_&&this.xmlHttpChunkStart_<responseText.length){var chunkText=this.getNextChunk_(responseText);if(chunkText==goog.net.ChannelRequest.INCOMPLETE_CHUNK_){if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE){this.lastError_=goog.net.ChannelRequest.Error.BAD_DATA;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_INCOMPLETE_DATA);decodeNextChunksSuccessful=!1}this.channelDebug_.xmlHttpChannelResponseText(this.rid_,null,"[Incomplete Response]");break}else if(chunkText==goog.net.ChannelRequest.INVALID_CHUNK_){this.lastError_=goog.net.ChannelRequest.Error.BAD_DATA;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_BAD_DATA);this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,"[Invalid Chunk]");decodeNextChunksSuccessful=!1;break}else{this.channelDebug_.xmlHttpChannelResponseText(this.rid_,chunkText,null);this.safeOnRequestData_(chunkText)}}if(readyState==goog.net.XmlHttp.ReadyState.COMPLETE&&0==responseText.length){this.lastError_=goog.net.ChannelRequest.Error.NO_DATA;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_NO_DATA);decodeNextChunksSuccessful=!1}this.successful_=this.successful_&&decodeNextChunksSuccessful;if(!decodeNextChunksSuccessful){this.channelDebug_.xmlHttpChannelResponseText(this.rid_,responseText,"[Invalid Chunked Response]");this.cleanup_();this.dispatchFailure_()}};goog.net.ChannelRequest.prototype.pollResponse_=function(){var readyState=this.xmlHttp_.getReadyState(),responseText=this.xmlHttp_.getResponseText();if(this.xmlHttpChunkStart_<responseText.length){this.cancelWatchDogTimer_();this.decodeNextChunks_(readyState,responseText);if(this.successful_&&readyState!=goog.net.XmlHttp.ReadyState.COMPLETE){this.ensureWatchDogTimer_()}}};goog.net.ChannelRequest.prototype.startPolling_=function(){this.eventHandler_.listen(this.pollingTimer_,goog.Timer.TICK,this.pollResponse_);this.pollingTimer_.start()};goog.net.ChannelRequest.prototype.getNextChunk_=function(responseText){var sizeStartIndex=this.xmlHttpChunkStart_,sizeEndIndex=responseText.indexOf("\n",sizeStartIndex);if(-1==sizeEndIndex){return goog.net.ChannelRequest.INCOMPLETE_CHUNK_}var sizeAsString=responseText.substring(sizeStartIndex,sizeEndIndex),size=+sizeAsString;if(isNaN(size)){return goog.net.ChannelRequest.INVALID_CHUNK_}var chunkStartIndex=sizeEndIndex+1;if(chunkStartIndex+size>responseText.length){return goog.net.ChannelRequest.INCOMPLETE_CHUNK_}var chunkText=responseText.substr(chunkStartIndex,size);this.xmlHttpChunkStart_=chunkStartIndex+size;return chunkText};goog.net.ChannelRequest.prototype.tridentGet=function(uri,usingSecondaryDomain){this.type_=goog.net.ChannelRequest.Type_.TRIDENT;this.baseUri_=uri.clone().makeUnique();this.tridentGet_(usingSecondaryDomain)};goog.net.ChannelRequest.prototype.tridentGet_=function(usingSecondaryDomain){this.requestStartTime_=goog.now();this.ensureWatchDogTimer_();var hostname=usingSecondaryDomain?window.location.hostname:"";this.requestUri_=this.baseUri_.clone();this.requestUri_.setParameterValue("DOMAIN",hostname);this.requestUri_.setParameterValue("t",this.retryId_);try{this.trident_=new ActiveXObject("htmlfile")}catch(e){this.channelDebug_.severe("ActiveX blocked");this.cleanup_();this.lastError_=goog.net.ChannelRequest.Error.ACTIVE_X_BLOCKED;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.ACTIVE_X_BLOCKED);this.dispatchFailure_();return}var body="<html><body>";if(usingSecondaryDomain){var escapedHostname=goog.net.ChannelRequest.escapeForStringInScript_(hostname);body+="<script>document.domain=\""+escapedHostname+"\"</scr"+"ipt>"}body+="</body></html>";var bodyHtml=goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("b/12014412"),body);this.trident_.open();goog.dom.safe.documentWrite(this.trident_,bodyHtml);this.trident_.close();this.trident_.parentWindow.m=goog.bind(this.onTridentRpcMessage_,this);this.trident_.parentWindow.d=goog.bind(this.onTridentDone_,this,!0);this.trident_.parentWindow.rpcClose=goog.bind(this.onTridentDone_,this,!1);var div=this.trident_.createElement(goog.dom.TagName.DIV+"");this.trident_.parentWindow.document.body.appendChild(div);var safeUrl=goog.html.SafeUrl.sanitize(this.requestUri_.toString()),sanitizedEscapedUrl=goog.string.htmlEscape(goog.html.SafeUrl.unwrap(safeUrl)),iframeHtml=goog.html.uncheckedconversions.safeHtmlFromStringKnownToSatisfyTypeContract(goog.string.Const.from("b/12014412"),"<iframe src=\""+sanitizedEscapedUrl+"\"></iframe>");goog.dom.safe.setInnerHtml(div,iframeHtml);this.channelDebug_.tridentChannelRequest("GET",this.requestUri_,this.rid_,this.retryId_);this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_MADE)};goog.net.ChannelRequest.escapeForStringInScript_=function(string){for(var escaped="",i=0,c;i<string.length;i++){c=string.charAt(i);if("<"==c){escaped+="\\x3c"}else if(">"==c){escaped+="\\x3e"}else{escaped+=goog.string.escapeChar(c)}}return escaped};goog.net.ChannelRequest.prototype.onTridentRpcMessage_=function(msg){goog.net.BrowserChannel.setTimeout(goog.bind(this.onTridentRpcMessageAsync_,this,msg),0)};goog.net.ChannelRequest.prototype.onTridentRpcMessageAsync_=function(msg){if(this.cancelled_){return}this.channelDebug_.tridentChannelResponseText(this.rid_,msg);this.cancelWatchDogTimer_();this.safeOnRequestData_(msg);this.ensureWatchDogTimer_()};goog.net.ChannelRequest.prototype.onTridentDone_=function(successful){goog.net.BrowserChannel.setTimeout(goog.bind(this.onTridentDoneAsync_,this,successful),0)};goog.net.ChannelRequest.prototype.onTridentDoneAsync_=function(successful){if(this.cancelled_){return}this.channelDebug_.tridentChannelResponseDone(this.rid_,successful);this.cleanup_();this.successful_=successful;this.channel_.onRequestComplete(this);this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.BACK_CHANNEL_ACTIVITY)};goog.net.ChannelRequest.prototype.sendUsingImgTag=function(uri){this.type_=goog.net.ChannelRequest.Type_.IMG;this.baseUri_=uri.clone().makeUnique();this.imgTagGet_()};goog.net.ChannelRequest.prototype.imgTagGet_=function(){var eltImg=new Image;eltImg.src=this.baseUri_;this.requestStartTime_=goog.now();this.ensureWatchDogTimer_()};goog.net.ChannelRequest.prototype.cancel=function(){this.cancelled_=!0;this.cleanup_()};goog.net.ChannelRequest.prototype.ensureWatchDogTimer_=function(){this.watchDogTimeoutTime_=goog.now()+this.timeout_;this.startWatchDogTimer_(this.timeout_)};goog.net.ChannelRequest.prototype.startWatchDogTimer_=function(time){if(null!=this.watchDogTimerId_){throw Error("WatchDog timer not null")}this.watchDogTimerId_=goog.net.BrowserChannel.setTimeout(goog.bind(this.onWatchDogTimeout_,this),time)};goog.net.ChannelRequest.prototype.cancelWatchDogTimer_=function(){if(this.watchDogTimerId_){goog.global.clearTimeout(this.watchDogTimerId_);this.watchDogTimerId_=null}};goog.net.ChannelRequest.prototype.onWatchDogTimeout_=function(){this.watchDogTimerId_=null;var now=goog.now();if(0<=now-this.watchDogTimeoutTime_){this.handleTimeout_()}else{this.channelDebug_.warning("WatchDog timer called too early");this.startWatchDogTimer_(this.watchDogTimeoutTime_-now)}};goog.net.ChannelRequest.prototype.handleTimeout_=function(){if(this.successful_){this.channelDebug_.severe("Received watchdog timeout even though request loaded successfully")}this.channelDebug_.timeoutResponse(this.requestUri_);if(this.type_!=goog.net.ChannelRequest.Type_.IMG){this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.REQUEST_FAILED)}this.cleanup_();this.lastError_=goog.net.ChannelRequest.Error.TIMEOUT;goog.net.BrowserChannel.notifyStatEvent(goog.net.BrowserChannel.Stat.REQUEST_TIMEOUT);this.dispatchFailure_()};goog.net.ChannelRequest.prototype.dispatchFailure_=function(){if(this.channel_.isClosed()||this.cancelled_){return}this.channel_.onRequestComplete(this)};goog.net.ChannelRequest.prototype.cleanup_=function(){this.cancelWatchDogTimer_();goog.dispose(this.readyStateChangeThrottle_);this.readyStateChangeThrottle_=null;this.pollingTimer_.stop();this.eventHandler_.removeAll();if(this.xmlHttp_){var xmlhttp=this.xmlHttp_;this.xmlHttp_=null;xmlhttp.abort();xmlhttp.dispose()}if(this.trident_){this.trident_=null}};goog.net.ChannelRequest.prototype.getSuccess=function(){return this.successful_};goog.net.ChannelRequest.prototype.getLastError=function(){return this.lastError_};goog.net.ChannelRequest.prototype.getLastStatusCode=function(){return this.lastStatusCode_};goog.net.ChannelRequest.prototype.getSessionId=function(){return this.sid_};goog.net.ChannelRequest.prototype.getRequestId=function(){return this.rid_};goog.net.ChannelRequest.prototype.getPostData=function(){return this.postData_};goog.net.ChannelRequest.prototype.getRequestStartTime=function(){return this.requestStartTime_};goog.net.ChannelRequest.prototype.safeOnRequestData_=function(data){try{this.channel_.onRequestData(this,data);this.channel_.notifyServerReachabilityEvent(goog.net.BrowserChannel.ServerReachability.BACK_CHANNEL_ACTIVITY)}catch(e){this.channelDebug_.dumpException(e,"Error in httprequest callback")}};