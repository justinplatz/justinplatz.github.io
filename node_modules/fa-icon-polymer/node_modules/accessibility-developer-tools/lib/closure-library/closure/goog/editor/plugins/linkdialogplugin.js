goog.provide("goog.editor.plugins.LinkDialogPlugin");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.editor.Command");goog.require("goog.editor.plugins.AbstractDialogPlugin");goog.require("goog.events.EventHandler");goog.require("goog.functions");goog.require("goog.ui.editor.AbstractDialog");goog.require("goog.ui.editor.LinkDialog");goog.require("goog.uri.utils");goog.editor.plugins.LinkDialogPlugin=function(){goog.editor.plugins.LinkDialogPlugin.base(this,"constructor",goog.editor.Command.MODAL_LINK_EDITOR);this.eventHandler_=new goog.events.EventHandler(this);this.safeToOpenSchemes_=["http","https","ftp"]};goog.inherits(goog.editor.plugins.LinkDialogPlugin,goog.editor.plugins.AbstractDialogPlugin);goog.editor.plugins.LinkDialogPlugin.prototype.currentLink_;goog.editor.plugins.LinkDialogPlugin.prototype.emailWarning_;goog.editor.plugins.LinkDialogPlugin.prototype.showOpenLinkInNewWindow_=!1;goog.editor.plugins.LinkDialogPlugin.prototype.isOpenLinkInNewWindowChecked_=!1;goog.editor.plugins.LinkDialogPlugin.prototype.showRelNoFollow_=!1;goog.editor.plugins.LinkDialogPlugin.prototype.stopReferrerLeaks_=!1;goog.editor.plugins.LinkDialogPlugin.prototype.blockOpeningUnsafeSchemes_=!0;goog.editor.plugins.LinkDialogPlugin.prototype.getTrogClassId=goog.functions.constant("LinkDialogPlugin");goog.editor.plugins.LinkDialogPlugin.prototype.setBlockOpeningUnsafeSchemes=function(blockOpeningUnsafeSchemes){this.blockOpeningUnsafeSchemes_=blockOpeningUnsafeSchemes};goog.editor.plugins.LinkDialogPlugin.prototype.setSafeToOpenSchemes=function(schemes){this.safeToOpenSchemes_=schemes};goog.editor.plugins.LinkDialogPlugin.prototype.showOpenLinkInNewWindow=function(startChecked){this.showOpenLinkInNewWindow_=!0;this.isOpenLinkInNewWindowChecked_=startChecked};goog.editor.plugins.LinkDialogPlugin.prototype.showRelNoFollow=function(){this.showRelNoFollow_=!0};goog.editor.plugins.LinkDialogPlugin.prototype.getOpenLinkInNewWindowCheckedState=function(){return this.isOpenLinkInNewWindowChecked_};goog.editor.plugins.LinkDialogPlugin.prototype.stopReferrerLeaks=function(){this.stopReferrerLeaks_=!0};goog.editor.plugins.LinkDialogPlugin.prototype.setEmailWarning=function(emailWarning){this.emailWarning_=emailWarning};goog.editor.plugins.LinkDialogPlugin.prototype.execCommandInternal=function(command,opt_arg){this.currentLink_=opt_arg;return goog.editor.plugins.LinkDialogPlugin.base(this,"execCommandInternal",command,opt_arg)};goog.editor.plugins.LinkDialogPlugin.prototype.handleAfterHide=function(e){goog.editor.plugins.LinkDialogPlugin.base(this,"handleAfterHide",e);this.currentLink_=null};goog.editor.plugins.LinkDialogPlugin.prototype.getEventHandler=function(){return this.eventHandler_};goog.editor.plugins.LinkDialogPlugin.prototype.getCurrentLink=function(){return this.currentLink_};goog.editor.plugins.LinkDialogPlugin.prototype.createDialog=function(dialogDomHelper,opt_link){var dialog=new goog.ui.editor.LinkDialog(dialogDomHelper,opt_link);if(this.emailWarning_){dialog.setEmailWarning(this.emailWarning_)}if(this.showOpenLinkInNewWindow_){dialog.showOpenLinkInNewWindow(this.isOpenLinkInNewWindowChecked_)}if(this.showRelNoFollow_){dialog.showRelNoFollow()}dialog.setStopReferrerLeaks(this.stopReferrerLeaks_);this.eventHandler_.listen(dialog,goog.ui.editor.AbstractDialog.EventType.OK,this.handleOk).listen(dialog,goog.ui.editor.AbstractDialog.EventType.CANCEL,this.handleCancel_).listen(dialog,goog.ui.editor.LinkDialog.EventType.BEFORE_TEST_LINK,this.handleBeforeTestLink);return dialog};goog.editor.plugins.LinkDialogPlugin.prototype.disposeInternal=function(){goog.editor.plugins.LinkDialogPlugin.base(this,"disposeInternal");this.eventHandler_.dispose()};goog.editor.plugins.LinkDialogPlugin.prototype.handleOk=function(e){this.disposeOriginalSelection();this.currentLink_.setTextAndUrl(e.linkText,e.linkUrl);if(this.showOpenLinkInNewWindow_){this.isOpenLinkInNewWindowChecked_=e.openInNewWindow}var anchor=this.currentLink_.getAnchor();this.touchUpAnchorOnOk_(anchor,e);for(var extraAnchors=this.currentLink_.getExtraAnchors(),i=0;i<extraAnchors.length;++i){extraAnchors[i].href=anchor.href;this.touchUpAnchorOnOk_(extraAnchors[i],e)}this.currentLink_.placeCursorRightOf();this.getFieldObject().focus();this.getFieldObject().dispatchSelectionChangeEvent();this.getFieldObject().dispatchChange();this.eventHandler_.removeAll()};goog.editor.plugins.LinkDialogPlugin.prototype.touchUpAnchorOnOk_=function(anchor,e){if(this.showOpenLinkInNewWindow_){if(e.openInNewWindow){anchor.target="_blank"}else{if("_blank"==anchor.target){anchor.target=""}}}if(this.showRelNoFollow_){var alreadyPresent=goog.ui.editor.LinkDialog.hasNoFollow(anchor.rel);if(alreadyPresent&&!e.noFollow){anchor.rel=goog.ui.editor.LinkDialog.removeNoFollow(anchor.rel)}else if(!alreadyPresent&&e.noFollow){anchor.rel=anchor.rel?anchor.rel+" nofollow":"nofollow"}}};goog.editor.plugins.LinkDialogPlugin.prototype.handleCancel_=function(e){if(this.currentLink_.isNew()){goog.dom.flattenElement(this.currentLink_.getAnchor());for(var extraAnchors=this.currentLink_.getExtraAnchors(),i=0;i<extraAnchors.length;++i){goog.dom.flattenElement(extraAnchors[i])}this.getFieldObject().dispatchChange()}this.eventHandler_.removeAll()};goog.editor.plugins.LinkDialogPlugin.prototype.handleBeforeTestLink=function(e){if(!this.shouldOpenUrl(e.url)){var MSG_UNSAFE_LINK=goog.getMsg("This link cannot be tested.");alert(MSG_UNSAFE_LINK);e.preventDefault()}};goog.editor.plugins.LinkDialogPlugin.prototype.shouldOpenUrl=function(url){return!this.blockOpeningUnsafeSchemes_||this.isSafeSchemeToOpen_(url)};goog.editor.plugins.LinkDialogPlugin.prototype.isSafeSchemeToOpen_=function(url){var scheme=goog.uri.utils.getScheme(url)||"http";return goog.array.contains(this.safeToOpenSchemes_,scheme.toLowerCase())};