goog.provide("goog.ui.FilteredMenu");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.AutoCompleteValues");goog.require("goog.a11y.aria.State");goog.require("goog.dom");goog.require("goog.dom.InputType");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.EventType");goog.require("goog.events.InputHandler");goog.require("goog.events.KeyCodes");goog.require("goog.object");goog.require("goog.string");goog.require("goog.style");goog.require("goog.ui.Component");goog.require("goog.ui.FilterObservingMenuItem");goog.require("goog.ui.Menu");goog.require("goog.ui.MenuItem");goog.require("goog.userAgent");goog.ui.FilteredMenu=function(opt_renderer,opt_domHelper){goog.ui.Menu.call(this,opt_domHelper,opt_renderer)};goog.inherits(goog.ui.FilteredMenu,goog.ui.Menu);goog.tagUnsealableClass(goog.ui.FilteredMenu);goog.ui.FilteredMenu.EventType={FILTER_CHANGED:"filterchange"};goog.ui.FilteredMenu.Id_={CONTENT_ELEMENT:"content-el"};goog.ui.FilteredMenu.prototype.filterInput_;goog.ui.FilteredMenu.prototype.inputHandler_;goog.ui.FilteredMenu.prototype.maxLength_=0;goog.ui.FilteredMenu.prototype.label_="";goog.ui.FilteredMenu.prototype.labelEl_;goog.ui.FilteredMenu.prototype.allowMultiple_=!1;goog.ui.FilteredMenu.prototype.enteredItems_;goog.ui.FilteredMenu.prototype.filterFromIndex_=0;goog.ui.FilteredMenu.prototype.filterStr_;goog.ui.FilteredMenu.prototype.contentElement_;goog.ui.FilteredMenu.prototype.persistentChildren_;goog.ui.FilteredMenu.prototype.createDom=function(){goog.ui.FilteredMenu.superClass_.createDom.call(this);var dom=this.getDomHelper(),el=dom.createDom(goog.dom.TagName.DIV,goog.getCssName(this.getRenderer().getCssClass(),"filter"),this.labelEl_=dom.createDom(goog.dom.TagName.DIV,null,this.label_),this.filterInput_=dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT})),element=this.getElement();dom.appendChild(element,el);var contentElementId=this.makeId(goog.ui.FilteredMenu.Id_.CONTENT_ELEMENT);this.contentElement_=dom.createDom(goog.dom.TagName.DIV,goog.object.create("class",goog.getCssName(this.getRenderer().getCssClass(),"content"),"id",contentElementId));dom.appendChild(element,this.contentElement_);this.initFilterInput_();goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.AUTOCOMPLETE,goog.a11y.aria.AutoCompleteValues.LIST);goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.OWNS,contentElementId);goog.a11y.aria.setState(this.filterInput_,goog.a11y.aria.State.EXPANDED,!0)};goog.ui.FilteredMenu.prototype.initFilterInput_=function(){this.setFocusable(!0);this.setKeyEventTarget(this.filterInput_);if(goog.userAgent.GECKO){this.filterInput_.setAttribute("autocomplete","off")}if(this.maxLength_){this.filterInput_.maxLength=this.maxLength_}};goog.ui.FilteredMenu.prototype.setUpFilterListeners_=function(){if(!this.inputHandler_&&this.filterInput_){this.inputHandler_=new goog.events.InputHandler(this.filterInput_);goog.style.setUnselectable(this.filterInput_,!1);goog.events.listen(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.handleFilterEvent,!1,this);goog.events.listen(this.filterInput_.parentNode,goog.events.EventType.CLICK,this.onFilterLabelClick_,!1,this);if(this.allowMultiple_){this.enteredItems_=[]}}};goog.ui.FilteredMenu.prototype.tearDownFilterListeners_=function(){if(this.inputHandler_){goog.events.unlisten(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.handleFilterEvent,!1,this);goog.events.unlisten(this.filterInput_.parentNode,goog.events.EventType.CLICK,this.onFilterLabelClick_,!1,this);this.inputHandler_.dispose();this.inputHandler_=void 0;this.enteredItems_=void 0}};goog.ui.FilteredMenu.prototype.setVisible=function(show,opt_force,opt_e){var visibilityChanged=goog.ui.FilteredMenu.superClass_.setVisible.call(this,show,opt_force,opt_e);if(visibilityChanged&&show&&this.isInDocument()){this.setFilter("");this.setUpFilterListeners_()}else if(visibilityChanged&&!show){this.tearDownFilterListeners_()}return visibilityChanged};goog.ui.FilteredMenu.prototype.disposeInternal=function(){this.tearDownFilterListeners_();this.filterInput_=void 0;this.labelEl_=void 0;goog.ui.FilteredMenu.superClass_.disposeInternal.call(this)};goog.ui.FilteredMenu.prototype.setFilterLabel=function(label){this.label_=label||"";if(this.labelEl_){goog.dom.setTextContent(this.labelEl_,this.label_)}};goog.ui.FilteredMenu.prototype.getFilterLabel=function(){return this.label_};goog.ui.FilteredMenu.prototype.setFilter=function(str){if(this.filterInput_){this.filterInput_.value=str;this.filterItems_(str)}};goog.ui.FilteredMenu.prototype.getFilter=function(){return this.filterInput_&&goog.isString(this.filterInput_.value)?this.filterInput_.value:""};goog.ui.FilteredMenu.prototype.setFilterFromIndex=function(index){this.filterFromIndex_=index};goog.ui.FilteredMenu.prototype.getFilterFromIndex=function(){return this.filterFromIndex_};goog.ui.FilteredMenu.prototype.getEnteredItems=function(){return this.enteredItems_||[]};goog.ui.FilteredMenu.prototype.setAllowMultiple=function(b){this.allowMultiple_=b};goog.ui.FilteredMenu.prototype.getAllowMultiple=function(){return this.allowMultiple_};goog.ui.FilteredMenu.prototype.setPersistentVisibility=function(child,persistent){if(!this.persistentChildren_){this.persistentChildren_={}}this.persistentChildren_[child.getId()]=persistent};goog.ui.FilteredMenu.prototype.hasPersistentVisibility=function(child){return!!(this.persistentChildren_&&this.persistentChildren_[child.getId()])};goog.ui.FilteredMenu.prototype.handleFilterEvent=function(e){this.filterItems_(this.filterInput_.value);var highlighted=this.getHighlighted();if(!highlighted||!highlighted.isVisible()){this.highlightFirst()}this.dispatchEvent(goog.ui.FilteredMenu.EventType.FILTER_CHANGED)};goog.ui.FilteredMenu.prototype.filterItems_=function(str){if(this.filterStr_==str){return}if(this.labelEl_){this.labelEl_.style.visibility=""==str?"visible":"hidden"}if(this.allowMultiple_&&this.enteredItems_){var lastWordRegExp=/^(.+),[ ]*([^,]*)$/,matches=str.match(lastWordRegExp),items=matches&&matches[1]?matches[1].split(","):[];if(","==str.substr(str.length-1,1)||items.length!=this.enteredItems_.length){var lastItem=items[items.length-1]||"";if(this.getHighlighted()&&""!=lastItem){var caption=this.getHighlighted().getCaption();if(0==caption.toLowerCase().indexOf(lastItem.toLowerCase())){items[items.length-1]=caption;this.filterInput_.value=items.join(",")+","}}this.enteredItems_=items;this.dispatchEvent(goog.ui.Component.EventType.CHANGE);this.setHighlightedIndex(-1)}if(matches){str=2<matches.length?goog.string.trim(matches[2]):""}}for(var matcher=new RegExp("(^|[- ,_/.:])"+goog.string.regExpEscape(str),"i"),child,i=this.filterFromIndex_;child=this.getChildAt(i);i++){if(child instanceof goog.ui.FilterObservingMenuItem){child.callObserver(str)}else if(!this.hasPersistentVisibility(child)){var caption=child.getCaption();if(caption){var matchArray=caption.match(matcher);if(""==str||matchArray){child.setVisible(!0);var pos=caption.indexOf(matchArray[0]);if(pos){pos++}this.boldContent_(child,pos,str.length)}else{child.setVisible(!1)}}else{child.setVisible(""==str)}}}this.filterStr_=str};goog.ui.FilteredMenu.prototype.boldContent_=function(child,start,len){var caption=child.getCaption(),boldedCaption;if(0==len){boldedCaption=this.getDomHelper().createTextNode(caption)}else{var preMatch=caption.substr(0,start),match=caption.substr(start,len),postMatch=caption.substr(start+len);boldedCaption=this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,preMatch,this.getDomHelper().createDom(goog.dom.TagName.B,null,match),postMatch)}var accelerator=child.getAccelerator&&child.getAccelerator();if(accelerator){child.setContent([boldedCaption,this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.ui.MenuItem.ACCELERATOR_CLASS,accelerator)])}else{child.setContent(boldedCaption)}};goog.ui.FilteredMenu.prototype.handleKeyEventInternal=function(e){if(e.shiftKey||e.ctrlKey||e.altKey||e.keyCode==goog.events.KeyCodes.HOME||e.keyCode==goog.events.KeyCodes.END){return!1}if(e.keyCode==goog.events.KeyCodes.ESC){this.dispatchEvent(goog.ui.Component.EventType.BLUR);return!0}return goog.ui.FilteredMenu.superClass_.handleKeyEventInternal.call(this,e)};goog.ui.FilteredMenu.prototype.setHighlightedIndex=function(index){var _Mathmax=Math.max;goog.ui.FilteredMenu.superClass_.setHighlightedIndex.call(this,index);var contentEl=this.getContentElement(),el=this.getHighlighted()?this.getHighlighted().getElement():null;if(this.filterInput_){goog.a11y.aria.setActiveDescendant(this.filterInput_,el)}if(el&&goog.dom.contains(contentEl,el)){var contentTop=goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher(8)?0:contentEl.offsetTop,diff=el.offsetTop+el.offsetHeight-contentTop-(contentEl.clientHeight+contentEl.scrollTop)+1;contentEl.scrollTop+=_Mathmax(diff,0);diff=contentEl.scrollTop-(el.offsetTop-contentTop)+1;contentEl.scrollTop-=_Mathmax(diff,0)}};goog.ui.FilteredMenu.prototype.onFilterLabelClick_=function(e){this.filterInput_.focus()};goog.ui.FilteredMenu.prototype.getContentElement=function(){return this.contentElement_||this.getElement()};goog.ui.FilteredMenu.prototype.getFilterInputElement=function(){return this.filterInput_||null};goog.ui.FilteredMenu.prototype.decorateInternal=function(element){this.setElementInternal(element);this.decorateContent(element);var el=this.getDomHelper().getElementsByTagNameAndClass(goog.dom.TagName.DIV,goog.getCssName(this.getRenderer().getCssClass(),"filter"),element)[0];this.labelEl_=goog.dom.getFirstElementChild(el);this.filterInput_=goog.dom.getNextElementSibling(this.labelEl_);this.contentElement_=goog.dom.getNextElementSibling(el);this.getRenderer().decorateChildren(this,el.parentNode,this.contentElement_);this.initFilterInput_()};