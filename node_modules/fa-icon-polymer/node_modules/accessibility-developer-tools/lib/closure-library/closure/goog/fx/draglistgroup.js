goog.provide("goog.fx.DragListDirection");goog.provide("goog.fx.DragListGroup");goog.provide("goog.fx.DragListGroup.EventType");goog.provide("goog.fx.DragListGroupEvent");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.classlist");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventHandler");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.fx.Dragger");goog.require("goog.math.Coordinate");goog.require("goog.string");goog.require("goog.style");goog.fx.DragListGroup=function(){goog.fx.DragListGroup.base(this,"constructor");this.dragItemHoverClasses_;this.dragItemHandleHoverClasses_;this.currDragItemClasses_;this.draggerElClasses_;this.currDragItem_;this.currHoverList_;this.origList_;this.origNextItem_;this.currHoverItem_;this.draggerEl_;this.dragger_;this.hysteresisDistance_=0;this.dragLists_=[];this.dragItems_=[];this.dragItemForHandle_={};this.eventHandler_=new goog.events.EventHandler(this);this.isInitialized_=!1;this.isCurrDragItemAlwaysDisplayed_=!1;this.updateWhileDragging_=!0};goog.inherits(goog.fx.DragListGroup,goog.events.EventTarget);goog.fx.DragListDirection={DOWN:0,RIGHT:2,LEFT:3,RIGHT_2D:4,LEFT_2D:5};goog.fx.DragListGroup.EventType={BEFOREDRAGSTART:"beforedragstart",DRAGSTART:"dragstart",BEFOREDRAGMOVE:"beforedragmove",DRAGMOVE:"dragmove",BEFOREDRAGEND:"beforedragend",DRAGEND:"dragend"};goog.fx.DragListGroup.prototype.setIsCurrDragItemAlwaysDisplayed=function(){this.isCurrDragItemAlwaysDisplayed_=!0};goog.fx.DragListGroup.prototype.setNoUpdateWhileDragging=function(){this.updateWhileDragging_=!1};goog.fx.DragListGroup.prototype.setHysteresis=function(distance){this.hysteresisDistance_=distance};goog.fx.DragListGroup.prototype.getHysteresis=function(){return this.hysteresisDistance_};goog.fx.DragListGroup.prototype.addDragList=function(dragListElement,growthDirection,opt_unused,opt_dragHoverClass){goog.asserts.assert(!this.isInitialized_);dragListElement.dlgGrowthDirection_=growthDirection;dragListElement.dlgDragHoverClass_=opt_dragHoverClass;this.dragLists_.push(dragListElement)};goog.fx.DragListGroup.prototype.setFunctionToGetHandleForDragItem=function(getHandleForDragItemFn){goog.asserts.assert(!this.isInitialized_);this.getHandleForDragItem_=getHandleForDragItemFn};goog.fx.DragListGroup.prototype.setDragItemHoverClass=function(var_args){goog.asserts.assert(!this.isInitialized_);this.dragItemHoverClasses_=goog.array.slice(arguments,0)};goog.fx.DragListGroup.prototype.setDragItemHandleHoverClass=function(var_args){goog.asserts.assert(!this.isInitialized_);this.dragItemHandleHoverClasses_=goog.array.slice(arguments,0)};goog.fx.DragListGroup.prototype.setCurrDragItemClass=function(var_args){goog.asserts.assert(!this.isInitialized_);this.currDragItemClasses_=goog.array.slice(arguments,0)};goog.fx.DragListGroup.prototype.setDraggerElClass=function(draggerElClass){goog.asserts.assert(!this.isInitialized_);this.draggerElClasses_=goog.string.trim(draggerElClass).split(" ")};goog.fx.DragListGroup.prototype.init=function(){if(this.isInitialized_){return}for(var i=0,numLists=this.dragLists_.length;i<numLists;i++){for(var dragList=this.dragLists_[i],dragItems=goog.dom.getChildren(dragList),j=0,numItems=dragItems.length;j<numItems;++j){this.listenForDragEvents(dragItems[j])}}this.isInitialized_=!0};goog.fx.DragListGroup.prototype.addItemToDragList=function(list,item,opt_index){if(goog.isDef(opt_index)){goog.dom.insertChildAt(list,item,opt_index)}else{goog.dom.appendChild(list,item)}this.listenForDragEvents(item)};goog.fx.DragListGroup.prototype.disposeInternal=function(){this.eventHandler_.dispose();for(var i=0,n=this.dragLists_.length,dragList;i<n;i++){dragList=this.dragLists_[i];dragList.dlgGrowthDirection_=void 0;dragList.dlgDragHoverClass_=void 0}this.dragLists_.length=0;this.dragItems_.length=0;this.dragItemForHandle_=null;this.cleanupDragDom_();goog.fx.DragListGroup.superClass_.disposeInternal.call(this)};goog.fx.DragListGroup.prototype.recacheListAndItemBounds=function(){this.recacheListAndItemBounds_(this.currDragItem_)};goog.fx.DragListGroup.prototype.recacheListAndItemBounds_=function(currDragItem){for(var i=0,n=this.dragLists_.length,dragList;i<n;i++){dragList=this.dragLists_[i];dragList.dlgBounds_=goog.style.getBounds(dragList)}for(var i=0,n=this.dragItems_.length,dragItem;i<n;i++){dragItem=this.dragItems_[i];if(dragItem!=currDragItem){dragItem.dlgBounds_=goog.style.getBounds(dragItem)}}};goog.fx.DragListGroup.prototype.listenForDragEvents=function(dragItem){var dragItemHandle=this.getHandleForDragItem_(dragItem),uid=goog.getUid(dragItemHandle);this.dragItemForHandle_[uid]=dragItem;if(this.dragItemHoverClasses_){this.eventHandler_.listen(dragItem,goog.events.EventType.MOUSEOVER,this.handleDragItemMouseover_);this.eventHandler_.listen(dragItem,goog.events.EventType.MOUSEOUT,this.handleDragItemMouseout_)}if(this.dragItemHandleHoverClasses_){this.eventHandler_.listen(dragItemHandle,goog.events.EventType.MOUSEOVER,this.handleDragItemHandleMouseover_);this.eventHandler_.listen(dragItemHandle,goog.events.EventType.MOUSEOUT,this.handleDragItemHandleMouseout_)}this.dragItems_.push(dragItem);this.eventHandler_.listen(dragItemHandle,[goog.events.EventType.MOUSEDOWN,goog.events.EventType.TOUCHSTART],this.handlePotentialDragStart_)};goog.fx.DragListGroup.prototype.handlePotentialDragStart_=function(e){var uid=goog.getUid(e.currentTarget);this.currDragItem_=this.dragItemForHandle_[uid];this.draggerEl_=this.createDragElementInternal(this.currDragItem_);if(this.draggerElClasses_){goog.dom.classlist.addAll(goog.asserts.assert(this.draggerEl_),this.draggerElClasses_||[])}this.draggerEl_.style.margin="0";this.draggerEl_.style.position="absolute";this.draggerEl_.style.visibility="hidden";var doc=goog.dom.getOwnerDocument(this.currDragItem_);doc.body.appendChild(this.draggerEl_);var currDragItemPos=goog.style.getPageOffset(this.currDragItem_);goog.style.setPageOffset(this.draggerEl_,currDragItemPos);this.dragger_=new goog.fx.Dragger(this.draggerEl_);this.dragger_.setHysteresis(this.hysteresisDistance_);goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.START,this.handleDragStart_,!1,this);goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.END,this.handleDragEnd_,!1,this);goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.EARLY_CANCEL,this.cleanup_,!1,this);this.dragger_.startDrag(e)};goog.fx.DragListGroup.prototype.cloneNode_=function(sourceEl){return goog.fx.Dragger.cloneNode(sourceEl)};goog.fx.DragListGroup.prototype.createDragElementInternal=function(sourceEl){return this.cloneNode_(sourceEl)};goog.fx.DragListGroup.prototype.handleDragStart_=function(e){if(!this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.BEFOREDRAGSTART,this,e.browserEvent,this.currDragItem_,null,null))){e.preventDefault();this.cleanup_();return}this.origList_=this.currDragItem_.parentNode;this.origNextItem_=goog.dom.getNextElementSibling(this.currDragItem_);this.currHoverItem_=this.origNextItem_;this.currHoverList_=this.origList_;if(this.currDragItemClasses_){goog.dom.classlist.addAll(goog.asserts.assert(this.currDragItem_),this.currDragItemClasses_||[])}else{this.currDragItem_.style.visibility="hidden"}var draggerElSize=goog.style.getSize(this.draggerEl_);this.draggerEl_.halfWidth=draggerElSize.width/2;this.draggerEl_.halfHeight=draggerElSize.height/2;this.draggerEl_.style.visibility="";if(this.updateWhileDragging_){this.currDragItem_.style.display="none"}this.recacheListAndItemBounds_(this.currDragItem_);this.currDragItem_.style.display="";goog.events.listen(this.dragger_,goog.fx.Dragger.EventType.DRAG,this.handleDragMove_,!1,this);this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.DRAGSTART,this,e.browserEvent,this.currDragItem_,this.draggerEl_,this.dragger_))};goog.fx.DragListGroup.prototype.handleDragMove_=function(dragEvent){var draggerElPos=goog.style.getPageOffset(this.draggerEl_),draggerElCenter=new goog.math.Coordinate(draggerElPos.x+this.draggerEl_.halfWidth,draggerElPos.y+this.draggerEl_.halfHeight),hoverList=this.getHoverDragList_(draggerElCenter),hoverNextItem=hoverList?this.getHoverNextItem_(hoverList,draggerElCenter):null,rv=this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.BEFOREDRAGMOVE,this,dragEvent,this.currDragItem_,this.draggerEl_,this.dragger_,draggerElCenter,hoverList,hoverNextItem));if(!rv){return!1}if(hoverList){if(this.updateWhileDragging_){this.insertCurrDragItem_(hoverList,hoverNextItem)}else{this.updateCurrHoverItem(hoverNextItem,draggerElCenter)}this.currDragItem_.style.display="";if(hoverList.dlgDragHoverClass_){goog.dom.classlist.add(goog.asserts.assert(hoverList),hoverList.dlgDragHoverClass_)}}else{if(!this.isCurrDragItemAlwaysDisplayed_){this.currDragItem_.style.display="none"}for(var i=0,n=this.dragLists_.length,dragList;i<n;i++){dragList=this.dragLists_[i];if(dragList.dlgDragHoverClass_){goog.dom.classlist.remove(goog.asserts.assert(dragList),dragList.dlgDragHoverClass_)}}}if(hoverList!=this.currHoverList_){this.currHoverList_=hoverList;this.recacheListAndItemBounds_(this.currDragItem_)}this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.DRAGMOVE,this,dragEvent,this.currDragItem_,this.draggerEl_,this.dragger_,draggerElCenter,hoverList,hoverNextItem));return!1};goog.fx.DragListGroup.prototype.cleanup_=function(opt_e){this.cleanupDragDom_();this.currDragItem_=null;this.currHoverList_=null;this.origList_=null;this.origNextItem_=null;this.draggerEl_=null;this.dragger_=null;for(var i=0,n=this.dragLists_.length;i<n;i++){this.dragLists_[i].dlgBounds_=null}for(var i=0,n=this.dragItems_.length;i<n;i++){this.dragItems_[i].dlgBounds_=null}};goog.fx.DragListGroup.prototype.handleDragEnd_=function(dragEvent){var rv=this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.BEFOREDRAGEND,this,dragEvent,this.currDragItem_,this.draggerEl_,this.dragger_));if(!rv){return!1}if(!this.updateWhileDragging_){this.insertCurrHoverItem()}this.cleanupDragDom_();this.dispatchEvent(new goog.fx.DragListGroupEvent(goog.fx.DragListGroup.EventType.DRAGEND,this,dragEvent,this.currDragItem_,this.draggerEl_,this.dragger_));this.cleanup_();return!0};goog.fx.DragListGroup.prototype.cleanupDragDom_=function(){goog.dispose(this.dragger_);if(this.draggerEl_){goog.dom.removeNode(this.draggerEl_)}if(this.currDragItem_&&"none"==this.currDragItem_.style.display){this.origList_.insertBefore(this.currDragItem_,this.origNextItem_);this.currDragItem_.style.display=""}if(this.currDragItemClasses_&&this.currDragItem_){goog.dom.classlist.removeAll(goog.asserts.assert(this.currDragItem_),this.currDragItemClasses_||[])}else if(this.currDragItem_){this.currDragItem_.style.visibility=""}for(var i=0,n=this.dragLists_.length,dragList;i<n;i++){dragList=this.dragLists_[i];if(dragList.dlgDragHoverClass_){goog.dom.classlist.remove(goog.asserts.assert(dragList),dragList.dlgDragHoverClass_)}}};goog.fx.DragListGroup.prototype.getHandleForDragItem_=function(dragItem){return dragItem};goog.fx.DragListGroup.prototype.handleDragItemMouseover_=function(e){var targetEl=goog.asserts.assertElement(e.currentTarget);goog.dom.classlist.addAll(targetEl,this.dragItemHoverClasses_||[])};goog.fx.DragListGroup.prototype.handleDragItemMouseout_=function(e){var targetEl=goog.asserts.assertElement(e.currentTarget);goog.dom.classlist.removeAll(targetEl,this.dragItemHoverClasses_||[])};goog.fx.DragListGroup.prototype.handleDragItemHandleMouseover_=function(e){var targetEl=goog.asserts.assertElement(e.currentTarget);goog.dom.classlist.addAll(targetEl,this.dragItemHandleHoverClasses_||[])};goog.fx.DragListGroup.prototype.handleDragItemHandleMouseout_=function(e){var targetEl=goog.asserts.assertElement(e.currentTarget);goog.dom.classlist.removeAll(targetEl,this.dragItemHandleHoverClasses_||[])};goog.fx.DragListGroup.prototype.getHoverDragList_=function(draggerElCenter){var prevHoverList=null;if("none"!=this.currDragItem_.style.display){prevHoverList=this.currDragItem_.parentNode;var prevHoverListBounds=goog.style.getBounds(prevHoverList);if(this.isInRect_(draggerElCenter,prevHoverListBounds)){return prevHoverList}}for(var i=0,n=this.dragLists_.length,dragList;i<n;i++){dragList=this.dragLists_[i];if(dragList==prevHoverList){continue}if(this.isInRect_(draggerElCenter,dragList.dlgBounds_)){return dragList}}return null};goog.fx.DragListGroup.prototype.isInRect_=function(pos,rect){return pos.x>rect.left&&pos.x<rect.left+rect.width&&pos.y>rect.top&&pos.y<rect.top+rect.height};goog.fx.DragListGroup.prototype.updateCurrHoverItem=function(hoverNextItem,opt_draggerElCenter){if(hoverNextItem){this.currHoverItem_=hoverNextItem}};goog.fx.DragListGroup.prototype.insertCurrHoverItem=function(){this.origList_.insertBefore(this.currDragItem_,this.currHoverItem_)};goog.fx.DragListGroup.prototype.getHoverNextItem_=function(hoverList,draggerElCenter){if(null==hoverList){throw Error("getHoverNextItem_ called with null hoverList.")}var relevantCoord,getRelevantBoundFn,isBeforeFn,pickClosestRow=!1,distanceToClosestRow=void 0;switch(hoverList.dlgGrowthDirection_){case goog.fx.DragListDirection.DOWN:relevantCoord=draggerElCenter.y;getRelevantBoundFn=goog.fx.DragListGroup.getBottomBound_;isBeforeFn=goog.fx.DragListGroup.isLessThan_;break;case goog.fx.DragListDirection.RIGHT_2D:pickClosestRow=!0;case goog.fx.DragListDirection.RIGHT:relevantCoord=draggerElCenter.x;getRelevantBoundFn=goog.fx.DragListGroup.getRightBound_;isBeforeFn=goog.fx.DragListGroup.isLessThan_;break;case goog.fx.DragListDirection.LEFT_2D:pickClosestRow=!0;case goog.fx.DragListDirection.LEFT:relevantCoord=draggerElCenter.x;getRelevantBoundFn=goog.fx.DragListGroup.getLeftBound_;isBeforeFn=goog.fx.DragListGroup.isGreaterThan_;break;}for(var earliestAfterItem=null,earliestAfterItemRelevantBound,hoverListItems=goog.dom.getChildren(hoverList),i=0,n=hoverListItems.length,item;i<n;i++){item=hoverListItems[i];if(item==this.currDragItem_){continue}var relevantBound=getRelevantBoundFn(item.dlgBounds_);if(pickClosestRow){var distanceToRow=goog.fx.DragListGroup.verticalDistanceFromItem_(item,draggerElCenter);if(!goog.isDef(distanceToClosestRow)){distanceToClosestRow=distanceToRow}if(isBeforeFn(relevantCoord,relevantBound)&&(earliestAfterItemRelevantBound==void 0||distanceToRow<distanceToClosestRow||distanceToRow==distanceToClosestRow&&(isBeforeFn(relevantBound,earliestAfterItemRelevantBound)||relevantBound==earliestAfterItemRelevantBound))){earliestAfterItem=item;earliestAfterItemRelevantBound=relevantBound}if(distanceToRow<distanceToClosestRow){distanceToClosestRow=distanceToRow}}else if(isBeforeFn(relevantCoord,relevantBound)&&(earliestAfterItemRelevantBound==void 0||isBeforeFn(relevantBound,earliestAfterItemRelevantBound))){earliestAfterItem=item;earliestAfterItemRelevantBound=relevantBound}}if(!goog.isNull(earliestAfterItem)&&goog.fx.DragListGroup.verticalDistanceFromItem_(earliestAfterItem,draggerElCenter)>distanceToClosestRow){return null}else{return earliestAfterItem}};goog.fx.DragListGroup.verticalDistanceFromItem_=function(item,target){var itemBounds=item.dlgBounds_,itemCenterY=itemBounds.top+(itemBounds.height-1)/2;return Math.abs(target.y-itemCenterY)};goog.fx.DragListGroup.getBottomBound_=function(itemBounds){return itemBounds.top+itemBounds.height-1};goog.fx.DragListGroup.getRightBound_=function(itemBounds){return itemBounds.left+itemBounds.width-1};goog.fx.DragListGroup.getLeftBound_=function(itemBounds){return itemBounds.left||0};goog.fx.DragListGroup.isLessThan_=function(a,b){return a<b};goog.fx.DragListGroup.isGreaterThan_=function(a,b){return a>b};goog.fx.DragListGroup.prototype.insertCurrDragItem_=function(hoverList,hoverNextItem){if(this.currDragItem_.parentNode!=hoverList||goog.dom.getNextElementSibling(this.currDragItem_)!=hoverNextItem){hoverList.insertBefore(this.currDragItem_,hoverNextItem)}};goog.fx.DragListGroupEvent=function(type,dragListGroup,event,currDragItem,draggerEl,dragger,opt_draggerElCenter,opt_hoverList,opt_hoverNextItem){goog.events.Event.call(this,type);this.dragListGroup=dragListGroup;this.event=event;this.currDragItem=currDragItem;this.draggerEl=draggerEl;this.dragger=dragger;this.draggerElCenter=opt_draggerElCenter;this.hoverList=opt_hoverList;this.hoverNextItem=opt_hoverNextItem};goog.inherits(goog.fx.DragListGroupEvent,goog.events.Event);