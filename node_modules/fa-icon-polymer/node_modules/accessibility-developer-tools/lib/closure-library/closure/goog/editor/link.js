goog.provide("goog.editor.Link");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.NodeType");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.BrowserFeature");goog.require("goog.editor.Command");goog.require("goog.editor.node");goog.require("goog.editor.range");goog.require("goog.string");goog.require("goog.string.Unicode");goog.require("goog.uri.utils");goog.require("goog.uri.utils.ComponentIndex");goog.editor.Link=function(anchor,isNew){this.anchor_=anchor;this.isNew_=isNew;this.extraAnchors_=[]};goog.editor.Link.prototype.getAnchor=function(){return this.anchor_};goog.editor.Link.prototype.getExtraAnchors=function(){return this.extraAnchors_};goog.editor.Link.prototype.getCurrentText=function(){if(!this.currentText_){var anchor=this.getAnchor(),leaf=goog.editor.node.getLeftMostLeaf(anchor);if(leaf.tagName&&leaf.tagName==goog.dom.TagName.IMG){this.currentText_=leaf.getAttribute("alt")}else{this.currentText_=goog.dom.getRawTextContent(this.getAnchor())}}return this.currentText_};goog.editor.Link.prototype.isNew=function(){return this.isNew_};goog.editor.Link.prototype.initializeUrl=function(url){this.getAnchor().href=url};goog.editor.Link.prototype.removeLink=function(){goog.dom.flattenElement(this.anchor_);this.anchor_=null;while(this.extraAnchors_.length){goog.dom.flattenElement(this.extraAnchors_.pop())}};goog.editor.Link.prototype.setTextAndUrl=function(newText,newUrl){var anchor=this.getAnchor();anchor.href=newUrl;var currentText=this.getCurrentText();if(newText!=currentText){var leaf=goog.editor.node.getLeftMostLeaf(anchor);if(leaf.tagName&&leaf.tagName==goog.dom.TagName.IMG){leaf.setAttribute("alt",newText?newText:"")}else{if(leaf.nodeType==goog.dom.NodeType.TEXT){leaf=leaf.parentNode}if(goog.dom.getRawTextContent(leaf)!=currentText){leaf=anchor}goog.dom.removeChildren(leaf);var domHelper=goog.dom.getDomHelper(leaf);goog.dom.appendChild(leaf,domHelper.createTextNode(newText))}this.currentText_=null}this.isNew_=!1};goog.editor.Link.prototype.placeCursorRightOf=function(){var anchor=this.getAnchor();if(goog.editor.BrowserFeature.GETS_STUCK_IN_LINKS){var spaceNode,nextSibling=anchor.nextSibling;if(nextSibling&&nextSibling.nodeType==goog.dom.NodeType.TEXT&&(goog.string.startsWith(nextSibling.data,goog.string.Unicode.NBSP)||goog.string.startsWith(nextSibling.data," "))){spaceNode=nextSibling}else{var dh=goog.dom.getDomHelper(anchor);spaceNode=dh.createTextNode(goog.string.Unicode.NBSP);goog.dom.insertSiblingAfter(spaceNode,anchor)}var range=goog.dom.Range.createCaret(spaceNode,1);range.select()}else{goog.editor.range.placeCursorNextTo(anchor,!1)}};goog.editor.Link.prototype.updateLinkDisplay_=function(field,url){this.initializeUrl(url);this.placeCursorRightOf();field.execCommand(goog.editor.Command.UPDATE_LINK_BUBBLE)};goog.editor.Link.prototype.getValidLinkFromText=function(){var text=goog.string.trim(this.getCurrentText());if(goog.editor.Link.isLikelyUrl(text)){if(0>text.search(/:/)){return"http://"+goog.string.trimLeft(text)}return text}else if(goog.editor.Link.isLikelyEmailAddress(text)){return"mailto:"+text}return null};goog.editor.Link.prototype.finishLinkCreation=function(field){var linkFromText=this.getValidLinkFromText();if(linkFromText){this.updateLinkDisplay_(field,linkFromText)}else{field.execCommand(goog.editor.Command.MODAL_LINK_EDITOR,this)}};goog.editor.Link.createNewLink=function(anchor,url,opt_target,opt_extraAnchors){var link=new goog.editor.Link(anchor,!0);link.initializeUrl(url);if(opt_target){anchor.target=opt_target}if(opt_extraAnchors){link.extraAnchors_=opt_extraAnchors}return link};goog.editor.Link.createNewLinkFromText=function(anchor,opt_target){var link=new goog.editor.Link(anchor,!0),text=link.getValidLinkFromText();link.initializeUrl(text?text:"");if(opt_target){anchor.target=opt_target}return link};goog.editor.Link.isLikelyUrl=function(str){if(/\s/.test(str)){return!1}if(goog.editor.Link.isLikelyEmailAddress(str)){return!1}var addedScheme=!1;if(!/^[^:\/?#.]+:/.test(str)){str="http://"+str;addedScheme=!0}var parts=goog.uri.utils.split(str),scheme=parts[goog.uri.utils.ComponentIndex.SCHEME];if(-1!=goog.array.indexOf(["mailto","aim"],scheme)){return!0}var domain=parts[goog.uri.utils.ComponentIndex.DOMAIN];if(!domain||addedScheme&&-1==domain.indexOf(".")||/[^\w\d\-\u0100-\uffff.%]/.test(domain)){return!1}var path=parts[goog.uri.utils.ComponentIndex.PATH];return!path||0==path.indexOf("/")};goog.editor.Link.LIKELY_EMAIL_ADDRESS_=/^[\w-]+(\.[\w-]+)*\@([\w-]+\.)+(\d+|\w\w+)$/i;goog.editor.Link.isLikelyEmailAddress=function(str){return goog.editor.Link.LIKELY_EMAIL_ADDRESS_.test(str)};goog.editor.Link.isMailto=function(url){return!!url&&goog.string.startsWith(url,"mailto:")};