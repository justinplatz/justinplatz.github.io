goog.provide("goog.stats.BasicStatTest");goog.setTestOnly("goog.stats.BasicStatTest");goog.require("goog.array");goog.require("goog.stats.BasicStat");goog.require("goog.string.format");goog.require("goog.testing.PseudoRandom");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");function testGetSlotBoundary(){var stat=new goog.stats.BasicStat(1654);assertEquals("Checking interval",33,stat.slotInterval_);assertEquals(132,stat.getSlotBoundary_(125));assertEquals(165,stat.getSlotBoundary_(132));assertEquals(132,stat.getSlotBoundary_(99));assertEquals(99,stat.getSlotBoundary_(98))}function testCheckForTimeTravel(){var stat=new goog.stats.BasicStat(1e3);stat.checkForTimeTravel_(100);stat.checkForTimeTravel_(-1);stat.incBy(1,125);stat.checkForTimeTravel_(141);stat.checkForTimeTravel_(140);stat.checkForTimeTravel_(139);stat.checkForTimeTravel_(125);stat.checkForTimeTravel_(124);stat.checkForTimeTravel_(120);assertEquals("State unchanged when called with good times",1,stat.get(125));stat.checkForTimeTravel_(119);assertEquals("Reset after called with a bad time",0,stat.get(125))}function testConstantIncrementPerSlot(){for(var stat=new goog.stats.BasicStat(1e3),now=1e3,i=0;50>i;++i){var newMax=1e3+i,newMin=1e3-i;stat.incBy(newMin,now);stat.incBy(newMax,now);var msg=goog.string.format("now=%d i=%d newMin=%d newMax=%d",now,i,newMin,newMax);assertEquals(msg,2e3*(i+1),stat.get(now));assertEquals(msg,newMax,stat.getMax(now));assertEquals(msg,newMin,stat.getMin(now));now+=20}stat.incBy(1,now);assertEquals(49*2e3+1,stat.get(now));assertEquals(1,stat.getMin(now));assertEquals(1049,stat.getMax(now));now+=20;stat.incBy(1,now);assertEquals(48*2e3+2,stat.get(now));assertEquals(1,stat.getMin(now));assertEquals(1049,stat.getMax(now))}function testSparseBuckets(){var stat=new goog.stats.BasicStat(1e3),now=1e3;stat.incBy(10,now);assertEquals(10,stat.get(now));now+=5e3;stat.incBy(1,now);assertEquals(1,stat.get(now))}function testFuzzy(){for(var _Mathfloor=Math.floor,stat=new goog.stats.BasicStat(1e3),test=new PerfectlySlowStat(1e3),rand=new goog.testing.PseudoRandom(58849020),eventCount=0,simulationDuration=goog.userAgent.IE?2e3:5e3,now=1e3;now<simulationDuration;){for(var count=_Mathfloor(2147483648*rand.random()),delay=_Mathfloor(25*rand.random()),i=0;i<=delay;++i){var time=now+i,msg=goog.string.format("now=%d eventCount=%d",time,eventCount),expected=test.getStats(now+i);assertEquals(expected.count,stat.get(time));assertEquals(expected.min,stat.getMin(time));assertEquals(expected.max,stat.getMax(time))}now+=delay;stat.incBy(count,now);test.incBy(count,now);eventCount++}}var PerfectlySlowStat=function(interval){this.interval_=interval;this.slotSize_=Math.floor(interval/goog.stats.BasicStat.NUM_SLOTS_);this.events_=[]};PerfectlySlowStat.prototype.incBy=function(amt,now){this.events_.push({time:now,count:amt})};PerfectlySlowStat.prototype.getStats=function(now){var end=Math.floor(now/this.slotSize_)*this.slotSize_+this.slotSize_,start=end-this.interval_,events=goog.array.filter(this.events_,function(e){return e.time>=start});return{count:goog.array.reduce(events,function(sum,e){return sum+e.count},0),min:goog.array.reduce(events,function(min,e){return Math.min(min,e.count)},Number.MAX_VALUE),max:goog.array.reduce(events,function(max,e){return Math.max(max,e.count)},Number.MIN_VALUE)}};