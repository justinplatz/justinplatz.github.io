goog.provide("goog.storage.EncryptedStorage");goog.require("goog.crypt");goog.require("goog.crypt.Arc4");goog.require("goog.crypt.Sha1");goog.require("goog.crypt.base64");goog.require("goog.json");goog.require("goog.json.Serializer");goog.require("goog.storage.CollectableStorage");goog.require("goog.storage.ErrorCode");goog.require("goog.storage.RichStorage");goog.storage.EncryptedStorage=function(mechanism,secret){goog.storage.EncryptedStorage.base(this,"constructor",mechanism);this.secret_=goog.crypt.stringToByteArray(secret);this.cleartextSerializer_=new goog.json.Serializer};goog.inherits(goog.storage.EncryptedStorage,goog.storage.CollectableStorage);goog.storage.EncryptedStorage.SALT_KEY="salt";goog.storage.EncryptedStorage.prototype.hashKeyWithSecret_=function(key){var sha1=new goog.crypt.Sha1;sha1.update(goog.crypt.stringToByteArray(key));sha1.update(this.secret_);return goog.crypt.base64.encodeByteArray(sha1.digest(),!0)};goog.storage.EncryptedStorage.prototype.encryptValue_=function(salt,key,value){if(!(0<salt.length)){throw Error("Non-empty salt must be provided")}var sha1=new goog.crypt.Sha1;sha1.update(goog.crypt.stringToByteArray(key));sha1.update(salt);sha1.update(this.secret_);var arc4=new goog.crypt.Arc4;arc4.setKey(sha1.digest());arc4.discard(1536);var bytes=goog.crypt.stringToByteArray(value);arc4.crypt(bytes);return goog.crypt.byteArrayToString(bytes)};goog.storage.EncryptedStorage.prototype.decryptValue_=function(salt,key,value){return this.encryptValue_(salt,key,value)};goog.storage.EncryptedStorage.prototype.set=function(key,value,opt_expiration){if(!goog.isDef(value)){goog.storage.EncryptedStorage.prototype.remove.call(this,key);return}for(var salt=[],i=0;8>i;++i){salt[i]=Math.floor(256*Math.random())}var wrapper=new goog.storage.RichStorage.Wrapper(this.encryptValue_(salt,key,this.cleartextSerializer_.serialize(value)));wrapper[goog.storage.EncryptedStorage.SALT_KEY]=salt;goog.storage.EncryptedStorage.base(this,"set",this.hashKeyWithSecret_(key),wrapper,opt_expiration)};goog.storage.EncryptedStorage.prototype.getWrapper=function(key,opt_expired){var wrapper=goog.storage.EncryptedStorage.base(this,"getWrapper",this.hashKeyWithSecret_(key),opt_expired);if(!wrapper){return}var value=goog.storage.RichStorage.Wrapper.unwrap(wrapper),salt=wrapper[goog.storage.EncryptedStorage.SALT_KEY];if(!goog.isString(value)||!goog.isArray(salt)||!salt.length){throw goog.storage.ErrorCode.INVALID_VALUE}var json=this.decryptValue_(salt,key,value);try{wrapper[goog.storage.RichStorage.DATA_KEY]=goog.json.parse(json)}catch(e){throw goog.storage.ErrorCode.DECRYPTION_ERROR}return wrapper};goog.storage.EncryptedStorage.prototype.remove=function(key){goog.storage.EncryptedStorage.base(this,"remove",this.hashKeyWithSecret_(key))};