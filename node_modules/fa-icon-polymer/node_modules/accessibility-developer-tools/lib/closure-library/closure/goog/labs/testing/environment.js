goog.provide("goog.labs.testing.Environment");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.debug.Console");goog.require("goog.testing.MockClock");goog.require("goog.testing.MockControl");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");goog.labs.testing.Environment=goog.defineClass(null,{constructor:function(){var testcase=goog.labs.testing.EnvironmentTestCase_.getInstance();testcase.registerEnvironment_(this);goog.labs.testing.Environment.activeTestCase_=testcase;this.mockControl=null;this.mockClock=null;this.shouldMakeMockControl_=!1;this.shouldMakeMockClock_=!1;this.console=goog.labs.testing.Environment.console_;this.replacer=new goog.testing.PropertyReplacer},setUpPage:function(){if(this.mockClock&&this.mockClock.isDisposed()){this.mockClock=new goog.testing.MockClock(!0)}},tearDownPage:function(){if(this.shouldMakeMockClock_){this.mockClock.dispose()}},setUp:goog.nullFunction,tearDown:function(){if(this.mockClock){for(var i=0;100>i;i++){this.mockClock.tick(1e3)}if(this.shouldMakeMockClock_){this.mockClock.reset()}}this.replacer.reset();if(this.mockControl){try{this.mockControl.$verifyAll();this.mockControl.$replayAll();this.mockControl.$verifyAll()}finally{this.mockControl.$resetAll();if(this.shouldMakeMockControl_){this.mockControl.$tearDown()}}}},withMockControl:function(){if(!this.shouldMakeMockControl_){this.shouldMakeMockControl_=!0;this.mockControl=new goog.testing.MockControl}return this},withMockClock:function(){if(!this.shouldMakeMockClock_){this.shouldMakeMockClock_=!0;this.mockClock=new goog.testing.MockClock(!0)}return this},mock:function(toMock){if(!this.shouldMakeMockControl_){throw new Error("MockControl not available on this environment. "+"Call withMockControl if this environment is expected "+"to contain a MockControl.")}return this.mockControl.createStrictMock(toMock)}});goog.labs.testing.Environment.activeTestCase_=null;goog.labs.testing.Environment.getTestCaseIfActive=function(){return goog.labs.testing.Environment.activeTestCase_};goog.labs.testing.Environment.console_=new goog.debug.Console;goog.labs.testing.Environment.console_.setCapturing(!0);goog.labs.testing.EnvironmentTestCase_=function(){goog.labs.testing.EnvironmentTestCase_.base(this,"constructor");this.environments_=[];this.testobj_=goog.global;goog.testing.TestCase.initializeTestRunner(this)};goog.inherits(goog.labs.testing.EnvironmentTestCase_,goog.testing.TestCase);goog.addSingletonGetter(goog.labs.testing.EnvironmentTestCase_);goog.labs.testing.EnvironmentTestCase_.prototype.setTestObj=function(obj){goog.asserts.assert(this.testobj_==goog.global,"A test method object has already been provided "+"and only one is supported.");this.testobj_=obj;goog.labs.testing.EnvironmentTestCase_.base(this,"setTestObj",obj)};goog.labs.testing.EnvironmentTestCase_.prototype.autoDiscoverLifecycle=function(){if(this.testobj_.runTests){this.runTests=goog.bind(this.testobj_.runTests,this.testobj_)}if(this.testobj_.shouldRunTests){this.shouldRunTests=goog.bind(this.testobj_.shouldRunTests,this.testobj_)}};goog.labs.testing.EnvironmentTestCase_.prototype.registerEnvironment_=function(env){this.environments_.push(env)};goog.labs.testing.EnvironmentTestCase_.prototype.setUpPage=function(){goog.array.forEach(this.environments_,function(env){env.setUpPage()});if(this.testobj_.setUpPage){this.testobj_.setUpPage()}};goog.labs.testing.EnvironmentTestCase_.prototype.setUp=function(){if(this.testobj_.configureEnvironment){this.testobj_.configureEnvironment()}goog.array.forEach(this.environments_,function(env){env.setUp()},this);if(this.testobj_.setUp){return this.testobj_.setUp()}};goog.labs.testing.EnvironmentTestCase_.prototype.tearDown=function(){var firstException;if(this.testobj_.tearDown){try{this.testobj_.tearDown()}catch(e){if(!firstException){firstException=e||new Error("Exception thrown: "+(e+""))}}}goog.array.forEachRight(this.environments_,function(env){try{env.tearDown()}catch(e){if(!firstException){firstException=e||new Error("Exception thrown: "+(e+""))}}});if(firstException){throw firstException}};goog.labs.testing.EnvironmentTestCase_.prototype.tearDownPage=function(){if(this.testobj_.tearDownPage){this.testobj_.tearDownPage()}goog.array.forEachRight(this.environments_,function(env){env.tearDownPage()})};