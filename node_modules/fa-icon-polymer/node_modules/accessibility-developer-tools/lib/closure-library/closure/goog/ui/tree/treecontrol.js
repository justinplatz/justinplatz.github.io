goog.provide("goog.ui.tree.TreeControl");goog.require("goog.a11y.aria");goog.require("goog.asserts");goog.require("goog.dom.classlist");goog.require("goog.events.EventType");goog.require("goog.events.FocusHandler");goog.require("goog.events.KeyHandler");goog.require("goog.html.SafeHtml");goog.require("goog.log");goog.require("goog.ui.tree.BaseNode");goog.require("goog.ui.tree.TreeNode");goog.require("goog.ui.tree.TypeAhead");goog.require("goog.userAgent");goog.ui.tree.TreeControl=function(content,opt_config,opt_domHelper){goog.ui.tree.BaseNode.call(this,content,opt_config,opt_domHelper);this.setExpandedInternal(!0);this.setSelectedInternal(!0);this.selectedItem_=this;this.typeAhead_=new goog.ui.tree.TypeAhead;this.keyHandler_=null;this.focusHandler_=null;this.logger_=goog.log.getLogger("this");this.focused_=!1;this.focusedNode_=null;this.showLines_=!0;this.showExpandIcons_=!0;this.showRootNode_=!0;this.showRootLines_=!0;if(goog.userAgent.IE){try{document.execCommand("BackgroundImageCache",!1,!0)}catch(e){goog.log.warning(this.logger_,"Failed to enable background image cache")}}};goog.inherits(goog.ui.tree.TreeControl,goog.ui.tree.BaseNode);goog.ui.tree.TreeControl.prototype.getTree=function(){return this};goog.ui.tree.TreeControl.prototype.getDepth=function(){return 0};goog.ui.tree.TreeControl.prototype.reveal=function(){};goog.ui.tree.TreeControl.prototype.handleFocus_=function(e){this.focused_=!0;goog.dom.classlist.add(goog.asserts.assert(this.getElement()),goog.getCssName("focused"));if(this.selectedItem_){this.selectedItem_.select()}};goog.ui.tree.TreeControl.prototype.handleBlur_=function(e){this.focused_=!1;goog.dom.classlist.remove(goog.asserts.assert(this.getElement()),goog.getCssName("focused"))};goog.ui.tree.TreeControl.prototype.hasFocus=function(){return this.focused_};goog.ui.tree.TreeControl.prototype.getExpanded=function(){return!this.showRootNode_||goog.ui.tree.TreeControl.superClass_.getExpanded.call(this)};goog.ui.tree.TreeControl.prototype.setExpanded=function(expanded){if(!this.showRootNode_){this.setExpandedInternal(expanded)}else{goog.ui.tree.TreeControl.superClass_.setExpanded.call(this,expanded)}};goog.ui.tree.TreeControl.prototype.getExpandIconSafeHtml=function(){return goog.html.SafeHtml.EMPTY};goog.ui.tree.TreeControl.prototype.getIconElement=function(){var el=this.getRowElement();return el?el.firstChild:null};goog.ui.tree.TreeControl.prototype.getExpandIconElement=function(){return null};goog.ui.tree.TreeControl.prototype.updateExpandIcon=function(){};goog.ui.tree.TreeControl.prototype.getRowClassName=function(){return goog.ui.tree.TreeControl.superClass_.getRowClassName.call(this)+(this.showRootNode_?"":" "+this.getConfig().cssHideRoot)};goog.ui.tree.TreeControl.prototype.getCalculatedIconClass=function(){var expanded=this.getExpanded(),expandedIconClass=this.getExpandedIconClass();if(expanded&&expandedIconClass){return expandedIconClass}var iconClass=this.getIconClass();if(!expanded&&iconClass){return iconClass}var config=this.getConfig();if(expanded&&config.cssExpandedRootIcon){return config.cssTreeIcon+" "+config.cssExpandedRootIcon}else if(!expanded&&config.cssCollapsedRootIcon){return config.cssTreeIcon+" "+config.cssCollapsedRootIcon}return""};goog.ui.tree.TreeControl.prototype.setSelectedItem=function(node){if(this.selectedItem_==node){return}var hadFocus=!1;if(this.selectedItem_){hadFocus=this.selectedItem_==this.focusedNode_;this.selectedItem_.setSelectedInternal(!1)}this.selectedItem_=node;if(node){node.setSelectedInternal(!0);if(hadFocus){node.select()}}this.dispatchEvent(goog.events.EventType.CHANGE)};goog.ui.tree.TreeControl.prototype.getSelectedItem=function(){return this.selectedItem_};goog.ui.tree.TreeControl.prototype.setShowLines=function(b){if(this.showLines_!=b){this.showLines_=b;if(this.isInDocument()){this.updateLinesAndExpandIcons_()}}};goog.ui.tree.TreeControl.prototype.getShowLines=function(){return this.showLines_};goog.ui.tree.TreeControl.prototype.updateLinesAndExpandIcons_=function(){var tree=this,showLines=tree.getShowLines(),showRootLines=tree.getShowRootLines();function updateShowLines(node){var childrenEl=node.getChildrenElement();if(childrenEl){var hideLines=!showLines||tree==node.getParent()&&!showRootLines,childClass=hideLines?node.getConfig().cssChildrenNoLines:node.getConfig().cssChildren;childrenEl.className=childClass;var expandIconEl=node.getExpandIconElement();if(expandIconEl){expandIconEl.className=node.getExpandIconClass()}}node.forEachChild(updateShowLines)}updateShowLines(this)};goog.ui.tree.TreeControl.prototype.setShowRootLines=function(b){if(this.showRootLines_!=b){this.showRootLines_=b;if(this.isInDocument()){this.updateLinesAndExpandIcons_()}}};goog.ui.tree.TreeControl.prototype.getShowRootLines=function(){return this.showRootLines_};goog.ui.tree.TreeControl.prototype.setShowExpandIcons=function(b){if(this.showExpandIcons_!=b){this.showExpandIcons_=b;if(this.isInDocument()){this.updateLinesAndExpandIcons_()}}};goog.ui.tree.TreeControl.prototype.getShowExpandIcons=function(){return this.showExpandIcons_};goog.ui.tree.TreeControl.prototype.setShowRootNode=function(b){if(this.showRootNode_!=b){this.showRootNode_=b;if(this.isInDocument()){var el=this.getRowElement();if(el){el.className=this.getRowClassName()}}if(!b&&this.getSelectedItem()==this&&this.getFirstChild()){this.setSelectedItem(this.getFirstChild())}}};goog.ui.tree.TreeControl.prototype.getShowRootNode=function(){return this.showRootNode_};goog.ui.tree.TreeControl.prototype.initAccessibility=function(){goog.ui.tree.TreeControl.superClass_.initAccessibility.call(this);var elt=this.getElement();goog.asserts.assert(elt,"The DOM element for the tree cannot be null.");goog.a11y.aria.setRole(elt,"tree");goog.a11y.aria.setState(elt,"labelledby",this.getLabelElement().id)};goog.ui.tree.TreeControl.prototype.enterDocument=function(){goog.ui.tree.TreeControl.superClass_.enterDocument.call(this);var el=this.getElement();el.className=this.getConfig().cssRoot;el.setAttribute("hideFocus","true");this.attachEvents_();this.initAccessibility()};goog.ui.tree.TreeControl.prototype.exitDocument=function(){goog.ui.tree.TreeControl.superClass_.exitDocument.call(this);this.detachEvents_()};goog.ui.tree.TreeControl.prototype.attachEvents_=function(){var el=this.getElement();el.tabIndex=0;var kh=this.keyHandler_=new goog.events.KeyHandler(el),fh=this.focusHandler_=new goog.events.FocusHandler(el);this.getHandler().listen(fh,goog.events.FocusHandler.EventType.FOCUSOUT,this.handleBlur_).listen(fh,goog.events.FocusHandler.EventType.FOCUSIN,this.handleFocus_).listen(kh,goog.events.KeyHandler.EventType.KEY,this.handleKeyEvent).listen(el,goog.events.EventType.MOUSEDOWN,this.handleMouseEvent_).listen(el,goog.events.EventType.CLICK,this.handleMouseEvent_).listen(el,goog.events.EventType.DBLCLICK,this.handleMouseEvent_)};goog.ui.tree.TreeControl.prototype.detachEvents_=function(){this.keyHandler_.dispose();this.keyHandler_=null;this.focusHandler_.dispose();this.focusHandler_=null};goog.ui.tree.TreeControl.prototype.handleMouseEvent_=function(e){goog.log.fine(this.logger_,"Received event "+e.type);var node=this.getNodeFromEvent_(e);if(node){switch(e.type){case goog.events.EventType.MOUSEDOWN:node.onMouseDown(e);break;case goog.events.EventType.CLICK:node.onClick_(e);break;case goog.events.EventType.DBLCLICK:node.onDoubleClick_(e);break;}}};goog.ui.tree.TreeControl.prototype.handleKeyEvent=function(e){var handled=!1;handled=this.typeAhead_.handleNavigation(e)||this.selectedItem_&&this.selectedItem_.onKeyDown(e)||this.typeAhead_.handleTypeAheadChar(e);if(handled){e.preventDefault()}return handled};goog.ui.tree.TreeControl.prototype.getNodeFromEvent_=function(e){var node=null,target=e.target;while(null!=target){var id=target.id;node=goog.ui.tree.BaseNode.allNodes[id];if(node){return node}if(target==this.getElement()){break}target=target.parentNode}return null};goog.ui.tree.TreeControl.prototype.createNode=function(opt_content){return new goog.ui.tree.TreeNode(opt_content||goog.html.SafeHtml.EMPTY,this.getConfig(),this.getDomHelper())};goog.ui.tree.TreeControl.prototype.setNode=function(node){this.typeAhead_.setNodeInMap(node)};goog.ui.tree.TreeControl.prototype.removeNode=function(node){this.typeAhead_.removeNodeFromMap(node)};goog.ui.tree.TreeControl.prototype.clearTypeAhead=function(){this.typeAhead_.clear()};goog.ui.tree.TreeControl.defaultConfig=goog.ui.tree.BaseNode.defaultConfig;