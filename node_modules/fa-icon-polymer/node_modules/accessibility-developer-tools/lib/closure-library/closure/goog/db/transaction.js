goog.provide("goog.db.Transaction");goog.provide("goog.db.Transaction.TransactionMode");goog.require("goog.async.Deferred");goog.require("goog.db.Error");goog.require("goog.db.ObjectStore");goog.require("goog.events");goog.require("goog.events.EventHandler");goog.require("goog.events.EventTarget");goog.db.Transaction=function(tx,db){goog.db.Transaction.base(this,"constructor");this.tx_=tx;this.db_=db;this.eventHandler_=new goog.events.EventHandler(this);this.eventHandler_.listen(this.tx_,"complete",goog.bind(this.dispatchEvent,this,goog.db.Transaction.EventTypes.COMPLETE));this.eventHandler_.listen(this.tx_,"abort",goog.bind(this.dispatchEvent,this,goog.db.Transaction.EventTypes.ABORT));this.eventHandler_.listen(this.tx_,"error",this.dispatchError_)};goog.inherits(goog.db.Transaction,goog.events.EventTarget);goog.db.Transaction.prototype.dispatchError_=function(ev){if(ev.target instanceof goog.db.Error){this.dispatchEvent({type:goog.db.Transaction.EventTypes.ERROR,target:ev.target})}else{this.dispatchEvent({type:goog.db.Transaction.EventTypes.ERROR,target:goog.db.Error.fromRequest(ev.target,"in transaction")})}};goog.db.Transaction.EventTypes={COMPLETE:"complete",ABORT:"abort",ERROR:"error"};goog.db.Transaction.prototype.getMode=function(){return this.tx_.mode};goog.db.Transaction.prototype.getDatabase=function(){return this.db_};goog.db.Transaction.prototype.objectStore=function(name){try{return new goog.db.ObjectStore(this.tx_.objectStore(name))}catch(ex){throw goog.db.Error.fromException(ex,"getting object store "+name)}};goog.db.Transaction.prototype.wait=function(){var d=new goog.async.Deferred;goog.events.listenOnce(this,goog.db.Transaction.EventTypes.COMPLETE,goog.bind(d.callback,d));var errorKey,abortKey=goog.events.listenOnce(this,goog.db.Transaction.EventTypes.ABORT,function(){goog.events.unlistenByKey(errorKey);d.errback(new goog.db.Error(goog.db.Error.ErrorCode.ABORT_ERR,"waiting for transaction to complete"))});errorKey=goog.events.listenOnce(this,goog.db.Transaction.EventTypes.ERROR,function(e){goog.events.unlistenByKey(abortKey);d.errback(e.target)});var db=this.getDatabase();return d.addCallback(function(){return db})};goog.db.Transaction.prototype.abort=function(){this.tx_.abort()};goog.db.Transaction.prototype.disposeInternal=function(){goog.db.Transaction.base(this,"disposeInternal");this.eventHandler_.dispose()};goog.db.Transaction.TransactionMode={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange"};