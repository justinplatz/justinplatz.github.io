goog.provide("goog.ui.ComboBox");goog.provide("goog.ui.ComboBoxItem");goog.require("goog.Timer");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.InputType");goog.require("goog.dom.TagName");goog.require("goog.dom.classlist");goog.require("goog.events.EventType");goog.require("goog.events.InputHandler");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyHandler");goog.require("goog.log");goog.require("goog.positioning.Corner");goog.require("goog.positioning.MenuAnchoredPosition");goog.require("goog.string");goog.require("goog.style");goog.require("goog.ui.Component");goog.require("goog.ui.ItemEvent");goog.require("goog.ui.LabelInput");goog.require("goog.ui.Menu");goog.require("goog.ui.MenuItem");goog.require("goog.ui.MenuSeparator");goog.require("goog.ui.registry");goog.require("goog.userAgent");goog.ui.ComboBox=function(opt_domHelper,opt_menu,opt_labelInput){goog.ui.Component.call(this,opt_domHelper);this.labelInput_=opt_labelInput||new goog.ui.LabelInput;this.enabled_=!0;this.menu_=opt_menu||new goog.ui.Menu(this.getDomHelper());this.setupMenu_()};goog.inherits(goog.ui.ComboBox,goog.ui.Component);goog.tagUnsealableClass(goog.ui.ComboBox);goog.ui.ComboBox.BLUR_DISMISS_TIMER_MS=250;goog.ui.ComboBox.prototype.logger_=goog.log.getLogger("goog.ui.ComboBox");goog.ui.ComboBox.prototype.enabled_;goog.ui.ComboBox.prototype.keyHandler_;goog.ui.ComboBox.prototype.inputHandler_=null;goog.ui.ComboBox.prototype.lastToken_=null;goog.ui.ComboBox.prototype.labelInput_=null;goog.ui.ComboBox.prototype.menu_=null;goog.ui.ComboBox.prototype.visibleCount_=-1;goog.ui.ComboBox.prototype.input_=null;goog.ui.ComboBox.prototype.matchFunction_=goog.string.startsWith;goog.ui.ComboBox.prototype.button_=null;goog.ui.ComboBox.prototype.defaultText_="";goog.ui.ComboBox.prototype.fieldName_="";goog.ui.ComboBox.prototype.dismissTimer_=null;goog.ui.ComboBox.prototype.useDropdownArrow_=!1;goog.ui.ComboBox.prototype.createDom=function(){this.input_=this.getDomHelper().createDom(goog.dom.TagName.INPUT,{name:this.fieldName_,type:goog.dom.InputType.TEXT,autocomplete:"off"});this.button_=this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.getCssName("goog-combobox-button"));this.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,goog.getCssName("goog-combobox"),this.input_,this.button_));if(this.useDropdownArrow_){goog.dom.setTextContent(this.button_,"\u25BC");goog.style.setUnselectable(this.button_,!0)}this.input_.setAttribute("label",this.defaultText_);this.labelInput_.decorate(this.input_);this.menu_.setFocusable(!1);if(!this.menu_.isInDocument()){this.addChild(this.menu_,!0)}};goog.ui.ComboBox.prototype.setEnabled=function(enabled){this.enabled_=enabled;this.labelInput_.setEnabled(enabled);goog.dom.classlist.enable(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-disabled"),!enabled)};goog.ui.ComboBox.prototype.isEnabled=function(){return this.enabled_};goog.ui.ComboBox.prototype.enterDocument=function(){goog.ui.ComboBox.superClass_.enterDocument.call(this);var handler=this.getHandler();handler.listen(this.getElement(),goog.events.EventType.MOUSEDOWN,this.onComboMouseDown_);handler.listen(this.getDomHelper().getDocument(),goog.events.EventType.MOUSEDOWN,this.onDocClicked_);handler.listen(this.input_,goog.events.EventType.BLUR,this.onInputBlur_);this.keyHandler_=new goog.events.KeyHandler(this.input_);handler.listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleKeyEvent);this.inputHandler_=new goog.events.InputHandler(this.input_);handler.listen(this.inputHandler_,goog.events.InputHandler.EventType.INPUT,this.onInputEvent_);handler.listen(this.menu_,goog.ui.Component.EventType.ACTION,this.onMenuSelected_)};goog.ui.ComboBox.prototype.exitDocument=function(){this.keyHandler_.dispose();delete this.keyHandler_;this.inputHandler_.dispose();this.inputHandler_=null;goog.ui.ComboBox.superClass_.exitDocument.call(this)};goog.ui.ComboBox.prototype.canDecorate=function(){return!1};goog.ui.ComboBox.prototype.disposeInternal=function(){goog.ui.ComboBox.superClass_.disposeInternal.call(this);this.clearDismissTimer_();this.labelInput_.dispose();this.menu_.dispose();this.labelInput_=null;this.menu_=null;this.input_=null;this.button_=null};goog.ui.ComboBox.prototype.dismiss=function(){this.clearDismissTimer_();this.hideMenu_();this.menu_.setHighlightedIndex(-1)};goog.ui.ComboBox.prototype.addItem=function(item){this.menu_.addChild(item,!0);this.visibleCount_=-1};goog.ui.ComboBox.prototype.addItemAt=function(item,n){this.menu_.addChildAt(item,n,!0);this.visibleCount_=-1};goog.ui.ComboBox.prototype.removeItem=function(item){var child=this.menu_.removeChild(item,!0);if(child){child.dispose();this.visibleCount_=-1}};goog.ui.ComboBox.prototype.removeAllItems=function(){for(var i=this.getItemCount()-1;0<=i;--i){this.removeItem(this.getItemAt(i))}};goog.ui.ComboBox.prototype.removeItemAt=function(n){var child=this.menu_.removeChildAt(n,!0);if(child){child.dispose();this.visibleCount_=-1}};goog.ui.ComboBox.prototype.getItemAt=function(n){return this.menu_.getChildAt(n)};goog.ui.ComboBox.prototype.getItemCount=function(){return this.menu_.getChildCount()};goog.ui.ComboBox.prototype.getMenu=function(){return this.menu_};goog.ui.ComboBox.prototype.getInputElement=function(){return this.input_};goog.ui.ComboBox.prototype.getLabelInput=function(){return this.labelInput_};goog.ui.ComboBox.prototype.getNumberOfVisibleItems_=function(){if(-1==this.visibleCount_){for(var count=0,i=0,n=this.menu_.getChildCount(),item;i<n;i++){item=this.menu_.getChildAt(i);if(!(item instanceof goog.ui.MenuSeparator)&&item.isVisible()){count++}}this.visibleCount_=count}goog.log.info(this.logger_,"getNumberOfVisibleItems() - "+this.visibleCount_);return this.visibleCount_};goog.ui.ComboBox.prototype.setMatchFunction=function(matchFunction){this.matchFunction_=matchFunction};goog.ui.ComboBox.prototype.getMatchFunction=function(){return this.matchFunction_};goog.ui.ComboBox.prototype.setDefaultText=function(text){this.defaultText_=text;if(this.labelInput_){this.labelInput_.setLabel(this.defaultText_)}};goog.ui.ComboBox.prototype.getDefaultText=function(){return this.defaultText_};goog.ui.ComboBox.prototype.setFieldName=function(fieldName){this.fieldName_=fieldName};goog.ui.ComboBox.prototype.getFieldName=function(){return this.fieldName_};goog.ui.ComboBox.prototype.setUseDropdownArrow=function(useDropdownArrow){this.useDropdownArrow_=!!useDropdownArrow};goog.ui.ComboBox.prototype.setValue=function(value){goog.log.info(this.logger_,"setValue() - "+value);if(this.labelInput_.getValue()!=value){this.labelInput_.setValue(value);this.handleInputChange_()}};goog.ui.ComboBox.prototype.getValue=function(){return this.labelInput_.getValue()};goog.ui.ComboBox.prototype.getToken=function(){return goog.string.htmlEscape(this.getTokenText_())};goog.ui.ComboBox.prototype.getTokenText_=function(){return goog.string.trim(this.labelInput_.getValue().toLowerCase())};goog.ui.ComboBox.prototype.setupMenu_=function(){var sm=this.menu_;sm.setVisible(!1);sm.setAllowAutoFocus(!1);sm.setAllowHighlightDisabled(!0)};goog.ui.ComboBox.prototype.maybeShowMenu_=function(showAll){var isVisible=this.menu_.isVisible(),numVisibleItems=this.getNumberOfVisibleItems_();if(isVisible&&0==numVisibleItems){goog.log.fine(this.logger_,"no matching items, hiding");this.hideMenu_()}else if(!isVisible&&0<numVisibleItems){if(showAll){goog.log.fine(this.logger_,"showing menu");this.setItemVisibilityFromToken_("");this.setItemHighlightFromToken_(this.getTokenText_())}goog.Timer.callOnce(this.clearDismissTimer_,1,this);this.showMenu_()}this.positionMenu()};goog.ui.ComboBox.prototype.positionMenu=function(){if(this.menu_&&this.menu_.isVisible()){var position=new goog.positioning.MenuAnchoredPosition(this.getElement(),goog.positioning.Corner.BOTTOM_START,!0);position.reposition(this.menu_.getElement(),goog.positioning.Corner.TOP_START)}};goog.ui.ComboBox.prototype.showMenu_=function(){this.menu_.setVisible(!0);goog.dom.classlist.add(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-active"))};goog.ui.ComboBox.prototype.hideMenu_=function(){this.menu_.setVisible(!1);goog.dom.classlist.remove(goog.asserts.assert(this.getElement()),goog.getCssName("goog-combobox-active"))};goog.ui.ComboBox.prototype.clearDismissTimer_=function(){if(this.dismissTimer_){goog.Timer.clear(this.dismissTimer_);this.dismissTimer_=null}};goog.ui.ComboBox.prototype.onComboMouseDown_=function(e){if(this.enabled_&&(e.target==this.getElement()||e.target==this.input_||goog.dom.contains(this.button_,e.target))){if(this.menu_.isVisible()){goog.log.fine(this.logger_,"Menu is visible, dismissing");this.dismiss()}else{goog.log.fine(this.logger_,"Opening dropdown");this.maybeShowMenu_(!0);if(goog.userAgent.OPERA){this.input_.focus()}this.input_.select();this.menu_.setMouseButtonPressed(!0);e.preventDefault()}}e.stopPropagation()};goog.ui.ComboBox.prototype.onDocClicked_=function(e){if(!goog.dom.contains(this.menu_.getElement(),e.target)){this.dismiss()}};goog.ui.ComboBox.prototype.onMenuSelected_=function(e){goog.log.info(this.logger_,"onMenuSelected_()");var item=e.target;if(this.dispatchEvent(new goog.ui.ItemEvent(goog.ui.Component.EventType.ACTION,this,item))){var caption=item.getCaption();goog.log.fine(this.logger_,"Menu selection: "+caption+". Dismissing menu");if(this.labelInput_.getValue()!=caption){this.labelInput_.setValue(caption);this.dispatchEvent(goog.ui.Component.EventType.CHANGE)}this.dismiss()}e.stopPropagation()};goog.ui.ComboBox.prototype.onInputBlur_=function(e){goog.log.info(this.logger_,"onInputBlur_() - delayed dismiss");this.clearDismissTimer_();this.dismissTimer_=goog.Timer.callOnce(this.dismiss,goog.ui.ComboBox.BLUR_DISMISS_TIMER_MS,this)};goog.ui.ComboBox.prototype.handleKeyEvent=function(e){var isMenuVisible=this.menu_.isVisible();if(isMenuVisible&&this.menu_.handleKeyEvent(e)){return!0}var handled=!1;switch(e.keyCode){case goog.events.KeyCodes.ESC:if(isMenuVisible){goog.log.fine(this.logger_,"Dismiss on Esc: "+this.labelInput_.getValue());this.dismiss();handled=!0}break;case goog.events.KeyCodes.TAB:if(isMenuVisible){var highlighted=this.menu_.getHighlighted();if(highlighted){goog.log.fine(this.logger_,"Select on Tab: "+this.labelInput_.getValue());highlighted.performActionInternal(e);handled=!0}}break;case goog.events.KeyCodes.UP:case goog.events.KeyCodes.DOWN:if(!isMenuVisible){goog.log.fine(this.logger_,"Up/Down - maybe show menu");this.maybeShowMenu_(!0);handled=!0}break;}if(handled){e.preventDefault()}return handled};goog.ui.ComboBox.prototype.onInputEvent_=function(e){goog.log.fine(this.logger_,"Key is modifying: "+this.labelInput_.getValue());this.handleInputChange_()};goog.ui.ComboBox.prototype.handleInputChange_=function(){var token=this.getTokenText_();this.setItemVisibilityFromToken_(token);if(goog.dom.getActiveElement(this.getDomHelper().getDocument())==this.input_){this.maybeShowMenu_(!1)}var highlighted=this.menu_.getHighlighted();if(""==token||!highlighted||!highlighted.isVisible()){this.setItemHighlightFromToken_(token)}this.lastToken_=token;this.dispatchEvent(goog.ui.Component.EventType.CHANGE)};goog.ui.ComboBox.prototype.setItemVisibilityFromToken_=function(token){goog.log.info(this.logger_,"setItemVisibilityFromToken_() - "+token);for(var isVisibleItem=!1,count=0,recheckHidden=!this.matchFunction_(token,this.lastToken_),i=0,n=this.menu_.getChildCount(),item;i<n;i++){item=this.menu_.getChildAt(i);if(item instanceof goog.ui.MenuSeparator){item.setVisible(isVisibleItem);isVisibleItem=!1}else if(item instanceof goog.ui.MenuItem){if(!item.isVisible()&&!recheckHidden)continue;var caption=item.getCaption(),visible=this.isItemSticky_(item)||caption&&this.matchFunction_(caption.toLowerCase(),token);if("function"==typeof item.setFormatFromToken){item.setFormatFromToken(token)}item.setVisible(!!visible);isVisibleItem=visible||isVisibleItem}else{isVisibleItem=item.isVisible()||isVisibleItem}if(!(item instanceof goog.ui.MenuSeparator)&&item.isVisible()){count++}}this.visibleCount_=count};goog.ui.ComboBox.prototype.setItemHighlightFromToken_=function(token){goog.log.info(this.logger_,"setItemHighlightFromToken_() - "+token);if(""==token){this.menu_.setHighlightedIndex(-1);return}for(var i=0,n=this.menu_.getChildCount();i<n;i++){var item=this.menu_.getChildAt(i),caption=item.getCaption();if(caption&&this.matchFunction_(caption.toLowerCase(),token)){this.menu_.setHighlightedIndex(i);if(item.setFormatFromToken){item.setFormatFromToken(token)}return}}this.menu_.setHighlightedIndex(-1)};goog.ui.ComboBox.prototype.isItemSticky_=function(item){return"function"==typeof item.isSticky&&item.isSticky()};goog.ui.ComboBoxItem=function(content,opt_data,opt_domHelper,opt_renderer){goog.ui.ComboBoxItem.base(this,"constructor",content,opt_data,opt_domHelper,opt_renderer)};goog.inherits(goog.ui.ComboBoxItem,goog.ui.MenuItem);goog.tagUnsealableClass(goog.ui.ComboBoxItem);goog.ui.registry.setDecoratorByClassName(goog.getCssName("goog-combobox-item"),function(){return new goog.ui.ComboBoxItem(null)});goog.ui.ComboBoxItem.prototype.isSticky_=!1;goog.ui.ComboBoxItem.prototype.setSticky=function(sticky){this.isSticky_=sticky};goog.ui.ComboBoxItem.prototype.isSticky=function(){return this.isSticky_};goog.ui.ComboBoxItem.prototype.setFormatFromToken=function(token){if(this.isEnabled()){var caption=this.getCaption(),index=caption.toLowerCase().indexOf(token);if(0<=index){var domHelper=this.getDomHelper();this.setContent([domHelper.createTextNode(caption.substr(0,index)),domHelper.createDom(goog.dom.TagName.B,null,caption.substr(index,token.length)),domHelper.createTextNode(caption.substr(index+token.length))])}}};