goog.provide("goog.debug.ErrorHandlerAsyncTest");goog.setTestOnly("goog.debug.ErrorHandlerAsyncTest");goog.require("goog.Promise");goog.require("goog.debug.ErrorHandler");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var resolver,testCase=new goog.testing.TestCase(document.title);testCase.setUpPage=function(){resolver=goog.Promise.withResolver();this.oldTimeout=window.setTimeout;this.oldInterval=window.setInterval;this.oldRequestAnimationFrame=window.requestAnimationFrame;this.testingReqAnimFrame=!!window.requestAnimationFrame;this.handler=new goog.debug.ErrorHandler(goog.bind(this.onException,this));this.handler.protectWindowSetTimeout();this.handler.protectWindowSetInterval();this.handler.protectWindowRequestAnimationFrame();this.exceptions=[];this.errors=0;this.oldWindowOnError=window.onerror;window.onerror=goog.bind(this.onError,this);window.setTimeout(goog.bind(this.timeOut,this),10);this.intervalId=window.setInterval(goog.bind(this.interval,this),20);if(this.testingReqAnimFrame){window.requestAnimationFrame(goog.bind(this.animFrame,this))}this.promiseTimeout=1e4};testCase.tearDownPage=function(){window.setTimeout=this.oldTimeout;window.setInterval=this.oldInterval;window.requestAnimationFrame=this.oldRequestAnimationFrame};testCase.onException=function(e){this.exceptions.push(e);if(this.timeoutHit&&this.intervalHit&&(!this.testingReqAnimFrame||this.animFrameHit)){resolver.resolve()}};testCase.onError=function(msg,url,line){this.errors++;return!0};testCase.timeOut=function(){this.timeoutHit=!0;throw arguments.callee};testCase.interval=function(){this.intervalHit=!0;window.clearTimeout(this.intervalId);throw arguments.callee};testCase.animFrame=function(){this.animFrameHit=!0;throw arguments.callee};testCase.addNewTest("testResults",function(){return resolver.promise.then(function(){for(var timeoutHit,intervalHit,animFrameHit,i=0;i<this.exceptions.length;++i){switch(this.exceptions[i]){case this.timeOut:timeoutHit=!0;break;case this.interval:intervalHit=!0;break;case this.animFrame:animFrameHit=!0;break;}}assertTrue("timeout exception not received",timeoutHit);assertTrue("timeout not called",this.timeoutHit);assertTrue("interval exception not received",intervalHit);assertTrue("interval not called",this.intervalHit);if(this.testingReqAnimFrame){assertTrue("anim frame exception not received",animFrameHit);assertTrue("animFrame not called",this.animFrameHit)}if(!goog.userAgent.WEBKIT){var expectedRethrownCount=this.testingReqAnimFrame?3:2;assertEquals(expectedRethrownCount+" exceptions should have been rethrown",expectedRethrownCount,this.errors)}},null,this)});G_testRunner.initialize(testCase);