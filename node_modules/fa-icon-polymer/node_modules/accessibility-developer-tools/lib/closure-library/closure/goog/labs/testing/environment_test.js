goog.provide("goog.labs.testing.environmentTest");goog.setTestOnly("goog.labs.testing.environmentTest");goog.require("goog.labs.testing.Environment");goog.require("goog.testing.MockControl");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");goog.require("goog.testing.testSuite");var testCase=null,mockControl=null,replacer=null,testing=!1;function setUp(){if(testing){return"hello"}var initFn=goog.testing.TestCase.initializeTestRunner;goog.testing.TestCase.initializeTestRunner=function(){};testCase=new goog.labs.testing.EnvironmentTestCase_;goog.labs.testing.EnvironmentTestCase_.getInstance=function(){return testCase};goog.testing.TestCase.initializeTestRunner=initFn;mockControl=new goog.testing.MockControl;replacer=new goog.testing.PropertyReplacer}function tearDown(){if(testing){return}replacer.reset();mockControl.$resetAll();mockControl.$tearDown()}function testLifecycle(){testing=!0;var envOne=mockControl.createStrictMock(goog.labs.testing.Environment),envTwo=mockControl.createStrictMock(goog.labs.testing.Environment),envThree=mockControl.createStrictMock(goog.labs.testing.Environment),testMethod=mockControl.createFunctionMock("testMethod");testCase.addNewTest("testFake",testMethod);testCase.registerEnvironment_(envOne);testCase.registerEnvironment_(envTwo);testCase.registerEnvironment_(envThree);envOne.setUpPage();envTwo.setUpPage();envThree.setUpPage();envOne.setUp();envTwo.setUp();envThree.setUp();testMethod();envThree.tearDown();envTwo.tearDown();envOne.tearDown();envThree.tearDownPage();envTwo.tearDownPage();envOne.tearDownPage();mockControl.$replayAll();testCase.runTests();mockControl.$verifyAll();testing=!1}function testTearDownWithMockControl(){testing=!0;var envWith=new goog.labs.testing.Environment,envWithout=new goog.labs.testing.Environment,mockControlMock=mockControl.createStrictMock(goog.testing.MockControl),mockControlCtorMock=mockControl.createMethodMock(goog.testing,"MockControl");mockControlCtorMock().$times(1).$returns(mockControlMock);mockControlMock.$verifyAll();mockControlMock.$replayAll();mockControlMock.$verifyAll();mockControlMock.$resetAll();mockControlMock.$tearDown().$times(1);mockControlMock.$verifyAll();mockControlMock.$replayAll();mockControlMock.$verifyAll();mockControlMock.$resetAll();mockControl.$replayAll();envWith.withMockControl();envWithout.mockControl=mockControlMock;envWith.tearDown();envWithout.tearDown();mockControl.$verifyAll();mockControl.$resetAll();testing=!1}function testAutoDiscoverTests(){testing=!0;var setUpPageFn=testCase.setUpPage,setUpFn=testCase.setUp,tearDownFn=testCase.tearDownFn,tearDownPageFn=testCase.tearDownPageFn;testCase.autoDiscoverTests();assertEquals(setUpPageFn,testCase.setUpPage);assertEquals(setUpFn,testCase.setUp);assertEquals(tearDownFn,testCase.tearDownFn);assertEquals(tearDownPageFn,testCase.tearDownPageFn);assertEquals(8,testCase.tests_.length);testing=!1}function testTestSuiteTests(){testing=!0;replacer.set(goog.testing.TestCase,"initializeTestRunner",function(){});var envOne=new goog.labs.testing.Environment,setUpPageFn=testCase.setUpPage,setUpFn=testCase.setUp,tearDownFn=testCase.tearDownFn,tearDownPageFn=testCase.tearDownPageFn;goog.testing.testSuite({setUp:function(){},tearDown:function(){},setUpPage:function(){},tearDownPage:function(){},testMe:function(){}});assertEquals(setUpPageFn,testCase.setUpPage);assertEquals(setUpFn,testCase.setUp);assertEquals(tearDownFn,testCase.tearDownFn);assertEquals(tearDownPageFn,testCase.tearDownPageFn);assertEquals(1,testCase.tests_.length);testing=!1}function testSetupReturnsValue(){testing=!0;var env=new goog.labs.testing.Environment;assertEquals("hello",testCase.setUp());testCase.tearDown();testing=!1}function testMockClock(){testing=!0;var env=new goog.labs.testing.Environment().withMockClock();testCase.addNewTest("testThatThrowsEventually",function(){setTimeout(function(){throw new Error("LateErrorMessage")},200)});testCase.runTests();assertTestFailure(testCase,"testThatThrowsEventually","LateErrorMessage");testing=!1}function testMockControl(){testing=!0;var env=new goog.labs.testing.Environment().withMockControl(),test=env.mockControl.createFunctionMock("test");testCase.addNewTest("testWithoutVerify",function(){test();env.mockControl.$replayAll();test()});testCase.runTests();assertNull(env.mockClock);testing=!1}function testMock(){testing=!0;var env=new goog.labs.testing.Environment().withMockControl(),mock=env.mock({test:function(){}});testCase.addNewTest("testMockCalled",function(){mock.test().$times(2);env.mockControl.$replayAll();mock.test();mock.test();env.mockControl.verifyAll()});testCase.runTests();testing=!1}function assertTestFailure(testCase,name,message){assertContains(message,testCase.result_.resultsByName[name][0])}