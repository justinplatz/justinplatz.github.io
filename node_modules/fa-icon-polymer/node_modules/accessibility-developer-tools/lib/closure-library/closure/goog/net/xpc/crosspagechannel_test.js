goog.provide("goog.net.xpc.CrossPageChannelTest");goog.setTestOnly("goog.net.xpc.CrossPageChannelTest");goog.require("goog.Disposable");goog.require("goog.Promise");goog.require("goog.Timer");goog.require("goog.Uri");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.labs.userAgent.browser");goog.require("goog.log");goog.require("goog.log.Level");goog.require("goog.net.xpc");goog.require("goog.net.xpc.CfgFields");goog.require("goog.net.xpc.CrossPageChannel");goog.require("goog.net.xpc.CrossPageChannelRole");goog.require("goog.net.xpc.TransportTypes");goog.require("goog.object");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");var CLEAN_UP_IFRAMES=!0,IFRAME_LOAD_WAIT_MS=1e3,stubs=new goog.testing.PropertyReplacer,uniqueId=0,driver,canAccessSameDomainIframe=!0,accessCheckPromise=null;function setUpPage(){goog.testing.TestCase.getActiveTestCase().promiseTimeout=1e3*20;var debugDiv=goog.dom.getElement("debugDiv"),logger=goog.log.getLogger("goog.net.xpc");logger.setLevel(goog.log.Level.ALL);goog.log.addHandler(logger,function(logRecord){var msgElm=goog.dom.createDom(goog.dom.TagName.DIV);msgElm.innerHTML=logRecord.getMessage();goog.dom.appendChild(debugDiv,msgElm)});accessCheckPromise=new goog.Promise(function(resolve,reject){var accessCheckIframes=[create1x1Iframe("nonexistent","testdata/i_am_non_existent.html")];window.setTimeout(function(){accessCheckIframes.push(create1x1Iframe("existent","testdata/access_checker.html"))},10);window.sameDomainIframeAccessComplete=function(canAccess){canAccessSameDomainIframe=canAccess;for(var i=0;i<accessCheckIframes.length;i++){document.body.removeChild(accessCheckIframes[i])}resolve()}})}function setUp(){driver=new Driver;return accessCheckPromise}function tearDown(){stubs.reset();driver.dispose()}function create1x1Iframe(iframeId,src){var iframeAccessChecker=goog.dom.createElement(goog.dom.TagName.IFRAME);iframeAccessChecker.id=iframeAccessChecker.name=iframeId;iframeAccessChecker.style.width=iframeAccessChecker.style.height="1px";iframeAccessChecker.src=src;document.body.insertBefore(iframeAccessChecker,document.body.firstChild);return iframeAccessChecker}function testCreateIframeSpecifyId(){driver.createPeerIframe("new_iframe");return goog.Timer.promise(IFRAME_LOAD_WAIT_MS).then(function(){driver.checkPeerIframe()})}function testCreateIframeRandomId(){driver.createPeerIframe();return goog.Timer.promise(IFRAME_LOAD_WAIT_MS).then(function(){driver.checkPeerIframe()})}function testGetRole(){var cfg={};cfg[goog.net.xpc.CfgFields.ROLE]=goog.net.xpc.CrossPageChannelRole.OUTER;var channel=new goog.net.xpc.CrossPageChannel(cfg);channel.peerWindowObject_=window.parent;assertEquals("Channel should use role from the config.",goog.net.xpc.CrossPageChannelRole.OUTER,channel.getRole());channel.dispose()}function testLifeCycle_v1_v1(){return checkLifeCycle(!1,1,1,!0,!0,!1)}function testLifeCycle_v1_v1_rev(){return checkLifeCycle(!1,1,1,!0,!0,!0)}function testLifeCycle_v1_v1_onesided(){return checkLifeCycle(!0,1,1,!1,!0,!1)}function testLifeCycle_v1_v1_onesided_rev(){return checkLifeCycle(!0,1,1,!1,!0,!0)}function testLifeCycle_v1_v2(){return checkLifeCycle(!1,1,2,!0,!0,!1)}function testLifeCycle_v1_v2_rev(){return checkLifeCycle(!1,1,2,!0,!0,!0)}function testLifeCycle_v1_v2_onesided(){return checkLifeCycle(!0,1,2,!1,!0,!1)}function testLifeCycle_v1_v2_onesided_rev(){return checkLifeCycle(!0,1,2,!1,!0,!0)}function testLifeCycle_v2_v1(){return checkLifeCycle(!1,2,1,!0,!0,!1)}function testLifeCycle_v2_v1_rev(){return checkLifeCycle(!1,2,1,!0,!0,!0)}function testLifeCycle_v2_v1_onesided(){return checkLifeCycle(!0,2,1,!1,!0,!1)}function testLifeCycle_v2_v1_onesided_rev(){return checkLifeCycle(!0,2,1,!1,!0,!0)}function testLifeCycle_v2_v2(){if(goog.labs.userAgent.browser.isIE()&&goog.labs.userAgent.browser.isVersionOrHigher(10)||goog.labs.userAgent.browser.isChrome()){return}return checkLifeCycle(!1,2,2,!0,!1,!1)}function testLifeCycle_v2_v2_rev(){return checkLifeCycle(!1,2,2,!0,!1,!0)}function testLifeCycle_v2_v2_onesided(){return checkLifeCycle(!0,2,2,!1,!1,!1)}function testLifeCycle_v2_v2_onesided_rev(){return checkLifeCycle(!0,2,2,!1,!1,!0)}function checkLifeCycle(oneSidedHandshake,innerProtocolVersion,outerProtocolVersion,outerFrameReconnectSupported,innerFrameMigrationSupported,reverse){driver.createPeerIframe("new_iframe",oneSidedHandshake,innerProtocolVersion,outerProtocolVersion);return driver.connect(!0,outerFrameReconnectSupported,innerFrameMigrationSupported,reverse)}function testConnectMismatchedNames_v1_v1(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(1,1,!1)}function testConnectMismatchedNames_v1_v1_rev(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(1,1,!0)}function testConnectMismatchedNames_v1_v2(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(1,2,!1)}function testConnectMismatchedNames_v1_v2_rev(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(1,2,!0)}function testConnectMismatchedNames_v2_v1(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(2,1,!1)}function testConnectMismatchedNames_v2_v1_rev(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(2,1,!0)}function testConnectMismatchedNames_v2_v2(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(2,2,!1)}function testConnectMismatchedNames_v2_v2_rev(){if(goog.labs.userAgent.browser.isIE()){return}return checkConnectMismatchedNames(2,2,!0)}function checkConnectMismatchedNames(innerProtocolVersion,outerProtocolVersion,reverse){driver.createPeerIframe("new_iframe",!1,innerProtocolVersion,outerProtocolVersion,!0);return driver.connect(!1,!1,!1,reverse)}function testEscapeServiceName(){var escape=goog.net.xpc.CrossPageChannel.prototype.escapeServiceName_;assertEquals("Shouldn't escape alphanumeric name","fooBar123",escape("fooBar123"));assertEquals("Shouldn't escape most non-alphanumeric characters","`~!@#$^&*()_-=+ []{}'\";,<.>/?\\",escape("`~!@#$^&*()_-=+ []{}'\";,<.>/?\\"));assertEquals("Should escape %, |, and :","foo%3ABar%7C123%25",escape("foo:Bar|123%"));assertEquals("Should escape tp","%25tp",escape("tp"));assertEquals("Should escape %tp","%25%25tp",escape("%tp"));assertEquals("Should not escape stp","stp",escape("stp"));assertEquals("Should not escape s%tp","s%25tp",escape("s%tp"))}function testSameDomainCheck_noMessageOrigin(){var channel=new goog.net.xpc.CrossPageChannel(goog.object.create(goog.net.xpc.CfgFields.PEER_HOSTNAME,"http://foo.com"));assertTrue(channel.isMessageOriginAcceptable_(void 0))}function testSameDomainCheck_noPeerHostname(){var channel=new goog.net.xpc.CrossPageChannel({});assertTrue(channel.isMessageOriginAcceptable_("http://foo.com"))}function testSameDomainCheck_unconfigured(){var channel=new goog.net.xpc.CrossPageChannel({});assertTrue(channel.isMessageOriginAcceptable_(void 0))}function testSameDomainCheck_originsMatch(){var channel=new goog.net.xpc.CrossPageChannel(goog.object.create(goog.net.xpc.CfgFields.PEER_HOSTNAME,"http://foo.com"));assertTrue(channel.isMessageOriginAcceptable_("http://foo.com"))}function testSameDomainCheck_originsMismatch(){var channel=new goog.net.xpc.CrossPageChannel(goog.object.create(goog.net.xpc.CfgFields.PEER_HOSTNAME,"http://foo.com"));assertFalse(channel.isMessageOriginAcceptable_("http://nasty.com"))}function testUnescapeServiceName(){var unescape=goog.net.xpc.CrossPageChannel.prototype.unescapeServiceName_;assertEquals("Shouldn't modify alphanumeric name","fooBar123",unescape("fooBar123"));assertEquals("Shouldn't modify most non-alphanumeric characters","`~!@#$^&*()_-=+ []{}'\";,<.>/?\\",unescape("`~!@#$^&*()_-=+ []{}'\";,<.>/?\\"));assertEquals("Should unescape URL-escapes","foo:Bar|123%",unescape("foo%3ABar%7C123%25"));assertEquals("Should unescape tp","tp",unescape("%25tp"));assertEquals("Should unescape %tp","%tp",unescape("%25%25tp"));assertEquals("Should not escape stp","stp",unescape("stp"));assertEquals("Should not escape s%tp","s%tp",unescape("s%25tp"))}function testDisposeBeforeConnect(){if(goog.labs.userAgent.browser.isIE()&&goog.labs.userAgent.browser.isVersionOrHigher(9)){return}driver.createPeerIframe("new_iframe",!1,2,2,!0);return driver.connectOuterAndDispose()}Driver=function(){goog.Disposable.call(this);this.iframe_=null;this.channel_=null;this.outerFrameCfg_=null;this.initialOuterChannelName_=null;this.innerFrameCfg_=null;this.innerFrameEchoPayload_=null;this.outerFrameEchoPayload_=null;this.innerFrameResponseReceived_=goog.Promise.withResolver();this.outerFrameResponseReceived_=goog.Promise.withResolver()};goog.inherits(Driver,goog.Disposable);Driver.prototype.disposeInternal=function(){if(CLEAN_UP_IFRAMES){goog.dom.removeNode(this.iframe_);delete this.iframe_}goog.dispose(this.channel_);this.innerFrameResponseReceived_.promise.cancel();this.outerFrameResponseReceived_.promise.cancel();Driver.base(this,"disposeInternal")};Driver.prototype.getInnerPeer_=function(){return this.iframe_.contentWindow};Driver.prototype.setConfiguration_=function(opt_iframeId,opt_oneSidedHandshake,opt_channelName,opt_innerProtocolVersion,opt_outerProtocolVersion,opt_randomChannelNames){var cfg={};if(opt_iframeId){cfg[goog.net.xpc.CfgFields.IFRAME_ID]=opt_iframeId}cfg[goog.net.xpc.CfgFields.PEER_URI]="testdata/inner_peer.html";if(!opt_randomChannelNames){var channelName=opt_channelName||"test_channel"+uniqueId++;cfg[goog.net.xpc.CfgFields.CHANNEL_NAME]=channelName}cfg[goog.net.xpc.CfgFields.LOCAL_POLL_URI]="does-not-exist.html";cfg[goog.net.xpc.CfgFields.PEER_POLL_URI]="does-not-exist.html";cfg[goog.net.xpc.CfgFields.ONE_SIDED_HANDSHAKE]=!!opt_oneSidedHandshake;cfg[goog.net.xpc.CfgFields.NATIVE_TRANSPORT_PROTOCOL_VERSION]=opt_outerProtocolVersion;function resolveUri(fieldName){cfg[fieldName]=goog.Uri.resolve(window.location.href,cfg[fieldName]).toString()}resolveUri(goog.net.xpc.CfgFields.PEER_URI);resolveUri(goog.net.xpc.CfgFields.LOCAL_POLL_URI);resolveUri(goog.net.xpc.CfgFields.PEER_POLL_URI);this.outerFrameCfg_=cfg;this.innerFrameCfg_=goog.object.clone(cfg);this.innerFrameCfg_[goog.net.xpc.CfgFields.NATIVE_TRANSPORT_PROTOCOL_VERSION]=opt_innerProtocolVersion};Driver.prototype.createChannel_=function(){if(this.channel_){this.channel_.dispose()}this.channel_=new goog.net.xpc.CrossPageChannel(this.outerFrameCfg_);this.channel_.registerService("echo",goog.bind(this.echoHandler_,this));this.channel_.registerService("response",goog.bind(this.responseHandler_,this));return this.channel_.name};Driver.prototype.checkChannelNames_=function(){var outerName=this.channel_.name,innerName=this.getInnerPeer_().channel.name,configName=this.innerFrameCfg_[goog.net.xpc.CfgFields.CHANNEL_NAME]||null;assertEquals(this.initialOuterChannelName_,outerName);if(configName){assertEquals(configName,innerName)}assertEquals(innerName,outerName);G_testRunner.log("Channel name: "+innerName)};Driver.prototype.getInnerFrameConfiguration=function(){return this.innerFrameCfg_};Driver.prototype.createPeerIframe=function(opt_iframeId,opt_oneSidedHandshake,opt_innerProtocolVersion,opt_outerProtocolVersion,opt_randomChannelNames){var expectedIframeId;if(opt_iframeId){expectedIframeId=opt_iframeId=opt_iframeId+uniqueId++}else{stubs.set(goog.net.xpc,"getRandomString",function(length){return""+length});expectedIframeId="xpcpeer4"}assertNull("element[id="+expectedIframeId+"] exists",goog.dom.getElement(expectedIframeId));this.setConfiguration_(opt_iframeId,opt_oneSidedHandshake,void 0,opt_innerProtocolVersion,opt_outerProtocolVersion,opt_randomChannelNames);var channelName=this.createChannel_();this.initialOuterChannelName_=channelName;this.iframe_=this.channel_.createPeerIframe(document.body);assertEquals(expectedIframeId,this.iframe_.id)};Driver.prototype.checkPeerIframe=function(){assertNotNull(this.iframe_);var peer=this.getInnerPeer_();assertNotNull(peer);assertNotNull(peer.document)};Driver.prototype.connect=function(fullLifeCycleTest,outerFrameReconnectSupported,innerFrameMigrationSupported,reverse){if(!this.isTransportTestable_()){return}this.reinitializePromises_();this.innerFrameResponseReceived_.promise.then(this.checkChannelNames_,null,this);if(fullLifeCycleTest){this.innerFrameResponseReceived_.promise.then(goog.bind(this.testReconnects_,this,outerFrameReconnectSupported,innerFrameMigrationSupported))}this.continueConnect_(reverse);return this.innerFrameResponseReceived_.promise};Driver.prototype.continueConnect_=function(reverse){if(!this.getInnerPeer_()||!this.getInnerPeer_().instantiateChannel){window.setTimeout(goog.bind(this.continueConnect_,this,reverse),100);return}var connectFromOuterFrame=goog.bind(this.channel_.connect,this.channel_,goog.bind(this.outerFrameConnected_,this)),innerConfig=this.innerFrameCfg_,connectFromInnerFrame=goog.bind(this.getInnerPeer_().instantiateChannel,this.getInnerPeer_(),innerConfig);window.setTimeout(connectFromOuterFrame,reverse?1:10);window.setTimeout(connectFromInnerFrame,reverse?10:1)};Driver.prototype.outerFrameConnected_=function(){var payload=this.outerFrameEchoPayload_=goog.net.xpc.getRandomString(10);this.channel_.send("echo",payload)};Driver.prototype.innerFrameConnected=function(){var payload=this.innerFrameEchoPayload_=goog.net.xpc.getRandomString(10);this.getInnerPeer_().sendEcho(payload)};Driver.prototype.echoHandler_=function(payload){assertTrue("outer frame should be connected",this.channel_.isConnected());var peer=this.getInnerPeer_();assertTrue("child should be connected",peer.isConnected());this.channel_.send("response",payload)};Driver.prototype.responseHandler_=function(payload){assertTrue("outer frame should be connected",this.channel_.isConnected());var peer=this.getInnerPeer_();assertTrue("child should be connected",peer.isConnected());assertEquals(this.outerFrameEchoPayload_,payload);this.outerFrameResponseReceived_.resolve(!0)};Driver.prototype.innerFrameGotResponse=function(payload){assertTrue("outer frame should be connected",this.channel_.isConnected());var peer=this.getInnerPeer_();assertTrue("child should be connected",peer.isConnected());assertEquals(this.innerFrameEchoPayload_,payload);this.innerFrameResponseReceived_.resolve(!0)};Driver.prototype.testReconnects_=function(outerFrameReconnectSupported,innerFrameMigrationSupported){G_testRunner.log("Performing inner frame reconnect");this.reinitializePromises_();this.innerFrameResponseReceived_.promise.then(this.checkChannelNames_,null,this);if(outerFrameReconnectSupported){this.innerFrameResponseReceived_.promise.then(goog.bind(this.performOuterFrameReconnect_,this,innerFrameMigrationSupported))}else if(innerFrameMigrationSupported){this.innerFrameResponseReceived_.promise.then(this.migrateInnerFrame_,null,this)}this.performInnerFrameReconnect_()};Driver.prototype.reinitializePromises_=function(){this.innerFrameEchoPayload_=null;this.outerFrameEchoPayload_=null;this.innerFrameResponseReceived_.promise.cancel();this.innerFrameResponseReceived_=goog.Promise.withResolver();this.outerFrameResponseReceived_.promise.cancel();this.outerFrameResponseReceived_=goog.Promise.withResolver()};Driver.prototype.performInnerFrameReconnect_=function(){var peer=this.getInnerPeer_();peer.instantiateChannel(this.innerFrameCfg_)};Driver.prototype.performOuterFrameReconnect_=function(innerFrameMigrationSupported){G_testRunner.log("Closing channel");this.channel_.close();try{this.channel_.xpcDeliver(goog.net.xpc.TRANSPORT_SERVICE_,"payload")}catch(e){fail("Should not throw exception")}G_testRunner.log("Reconnecting outer frame");this.reinitializePromises_();this.innerFrameResponseReceived_.promise.then(this.checkChannelNames_,null,this);if(innerFrameMigrationSupported){this.outerFrameResponseReceived_.promise.then(this.migrateInnerFrame_,null,this)}this.channel_.connect(goog.bind(this.outerFrameConnected_,this))};Driver.prototype.migrateInnerFrame_=function(){G_testRunner.log("Migrating inner frame");this.reinitializePromises_();var innerFrameProtoVersion=this.innerFrameCfg_[goog.net.xpc.CfgFields.NATIVE_TRANSPORT_PROTOCOL_VERSION];this.innerFrameResponseReceived_.promise.then(this.checkChannelNames_,null,this);this.innerFrameCfg_[goog.net.xpc.CfgFields.NATIVE_TRANSPORT_PROTOCOL_VERSION]=1==innerFrameProtoVersion?2:1;this.performInnerFrameReconnect_()};Driver.prototype.isTransportTestable_=function(){var testable=!1,transportType=this.channel_.determineTransportType_();switch(transportType){case goog.net.xpc.TransportTypes.IFRAME_RELAY:case goog.net.xpc.TransportTypes.IFRAME_POLLING:testable=canAccessSameDomainIframe;break;case goog.net.xpc.TransportTypes.NATIVE_MESSAGING:case goog.net.xpc.TransportTypes.FLASH:case goog.net.xpc.TransportTypes.DIRECT:case goog.net.xpc.TransportTypes.NIX:testable=!0;break;}return testable};Driver.prototype.connectOuterAndDispose=function(){this.channel_.connect();return goog.Timer.promise(2e3).then(this.disposeAndCheck_,null,this)};Driver.prototype.disposeAndCheck_=function(){assertFalse(this.channel_.isConnected());var transport=this.channel_.transport_;this.channel_.dispose();assertNull(this.channel_.transport_);assertTrue(this.channel_.isDisposed());assertTrue(transport.isDisposed());return goog.Timer.promise(2e3)};