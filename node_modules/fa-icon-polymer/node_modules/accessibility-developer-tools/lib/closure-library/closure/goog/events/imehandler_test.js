goog.provide("goog.events.ImeHandlerTest");goog.setTestOnly("goog.events.ImeHandlerTest");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.events");goog.require("goog.events.ImeHandler");goog.require("goog.events.KeyCodes");goog.require("goog.object");goog.require("goog.string");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.events");goog.require("goog.testing.events.Event");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");var sandbox,imeHandler,eventsFired,stubs=new goog.testing.PropertyReplacer,eventTypes=goog.events.ImeHandler.EventType;function setUp(){sandbox=goog.dom.getElement("sandbox")}function initImeHandler(){goog.events.ImeHandler.USES_COMPOSITION_EVENTS=goog.userAgent.GECKO||goog.userAgent.WEBKIT&&goog.userAgent.isVersionOrHigher(532);imeHandler=new goog.events.ImeHandler(sandbox);eventsFired=[];goog.events.listen(imeHandler,goog.object.getValues(goog.events.ImeHandler.EventType),function(e){eventsFired.push(e.type)})}function tearDown(){imeHandler.dispose();imeHandler=null;stubs.reset()}function tearDownPage(){sandbox.innerHTML="<div contentEditable=\"true\">hello world</div>";initImeHandler();function unshiftEvent(e){last10Events.unshift(e.type+":"+e.keyCode+":"+goog.string.htmlEscape(goog.dom.getTextContent(sandbox)));last10Events.length=Math.min(last10Events.length,10);goog.dom.getElement("logger").innerHTML=last10Events.join("<br>")}var last10Events=[];goog.events.listen(imeHandler,goog.object.getValues(goog.events.ImeHandler.EventType),unshiftEvent);goog.events.listen(sandbox,["keydown","textInput"],unshiftEvent)}function assertEventsFired(var_args){assertArrayEquals(goog.array.clone(arguments),eventsFired)}function fireInputEvent(type){return goog.testing.events.fireBrowserEvent(new goog.testing.events.Event(type,sandbox))}function fireImeKeySequence(){return fireKeySequence(goog.events.KeyCodes.WIN_IME)}function fireKeySequence(keyCode){return goog.testing.events.fireBrowserEvent(new goog.testing.events.Event("textInput",sandbox))&goog.testing.events.fireKeySequence(sandbox,keyCode)}function testHandleKeyDown_GeckoCompositionEvents(){setUserAgent("GECKO");stubs.set(goog.userAgent,"MAC",!1);initImeHandler();fireInputEvent("compositionstart");assertImeMode();fireInputEvent("compositionupdate");fireInputEvent("compositionupdate");fireInputEvent("compositionend");assertEventsFired(eventTypes.START,eventTypes.UPDATE,eventTypes.UPDATE,eventTypes.END);assertNotImeMode()}function testChromeCompositionEventsLinux(){runChromeCompositionEvents("LINUX")}function testChromeCompositionEventsMac(){runChromeCompositionEvents("MAC")}function testChromeCompositionEventsWindows(){runChromeCompositionEvents("WINDOWS")}function runChromeCompositionEvents(platform){setUserAgent("WEBKIT");setVersion(532);stubs.set(goog.userAgent,platform,!0);initImeHandler();fireImeKeySequence();fireInputEvent("compositionstart");assertImeMode();fireInputEvent("compositionupdate");fireInputEvent("compositionupdate");fireInputEvent("compositionend");assertEventsFired(eventTypes.START,eventTypes.UPDATE,eventTypes.UPDATE,eventTypes.END);assertNotImeMode()}function testHandlerKeyDownForIme_imeOnOff(){setUserAgent("IE");initImeHandler();fireImeKeySequence();assertImeMode();fireKeySequence(goog.events.KeyCodes.SHIFT);assertImeMode();fireKeySequence(goog.events.KeyCodes.CTRL);assertImeMode();fireKeySequence(goog.events.KeyCodes.ENTER);assertNotImeMode();assertEventsFired(eventTypes.START,eventTypes.END)}function testHandleKeyUpForSafari(){setUserAgent("WEBKIT");setVersion(531);initImeHandler();fireImeKeySequence();assertImeMode();fireKeySequence(goog.events.KeyCodes.ENTER);assertNotImeMode()}function testScimFiresWinImeKeycodesGeckoLinux(){setUserAgent("GECKO");assertScimInputIgnored()}function testScimFiresWinImeKeycodesChromeLinux(){setUserAgent("WEBKIT");setVersion(532);assertScimInputIgnored()}function assertScimInputIgnored(){initImeHandler();fireImeKeySequence();assertNotImeMode();fireInputEvent("compositionstart");assertImeMode();fireImeKeySequence();assertImeMode();fireInputEvent("compositionend");assertNotImeMode()}var userAgents=["IE","GECKO","WEBKIT"];function setUserAgent(userAgent){for(var i=0;i<userAgents.length;i++){stubs.set(goog.userAgent,userAgents[i],userAgents[i]==userAgent)}}function setVersion(version){goog.userAgent.VERSION=version;goog.userAgent.isVersionOrHigherCache_={}}function assertImeMode(){assertTrue("Should be in IME mode.",imeHandler.isImeMode())}function assertNotImeMode(){assertFalse("Should not be in IME mode.",imeHandler.isImeMode())}