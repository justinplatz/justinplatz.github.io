goog.provide("goog.ui.HoverCardTest");goog.setTestOnly("goog.ui.HoverCardTest");goog.require("goog.dom");goog.require("goog.events");goog.require("goog.math.Coordinate");goog.require("goog.style");goog.require("goog.testing.MockClock");goog.require("goog.testing.events");goog.require("goog.testing.events.Event");goog.require("goog.testing.jsunit");goog.require("goog.ui.HoverCard");var timer=new goog.testing.MockClock,card,triggeredElement,cancelledElement,showDelay,shownCard,hideDelay,john,jane,james,bill,child,elsewhere,offAnchor;function setUpPage(){john=goog.dom.getElement("john");jane=goog.dom.getElement("jane");james=goog.dom.getElement("james");bill=goog.dom.getElement("bill");child=goog.dom.getElement("child")}function setUp(){timer.install();triggeredElement=null;cancelledElement=null;showDelay=null;shownCard=null;hideDelay=null;elsewhere=goog.dom.getElement("notpopup");offAnchor=new goog.math.Coordinate(1,1)}function initCard(opt_isAnchor,opt_checkChildren,opt_maxSearchSteps){var isAnchor=opt_isAnchor||{SPAN:"email"};card=new goog.ui.HoverCard(isAnchor,opt_checkChildren);card.setText("Test hovercard");if(null!=opt_maxSearchSteps){card.setMaxSearchSteps(opt_maxSearchSteps)}goog.events.listen(card,goog.ui.HoverCard.EventType.TRIGGER,onTrigger);goog.events.listen(card,goog.ui.HoverCard.EventType.CANCEL_TRIGGER,onCancel);goog.events.listen(card,goog.ui.HoverCard.EventType.BEFORE_SHOW,onBeforeShow);card.cursorPosition=new goog.math.Coordinate(1,1)}function onTrigger(event){triggeredElement=event.anchor;if(showDelay){card.setShowDelayMs(showDelay)}return!0}function onCancel(event){cancelledElement=event.anchor}function onBeforeShow(){shownCard=card.getAnchorElement();if(hideDelay){card.setHideDelayMs(hideDelay)}return!0}function tearDown(){card.dispose();timer.uninstall()}function testTrigger(){initCard();showDelay=500;goog.testing.events.fireMouseOverEvent(john,elsewhere);assertEquals("Hovercard should have triggered",john,triggeredElement);timer.tick(showDelay-1);assertNull("Card should not have shown",shownCard);assertFalse(card.isVisible());hideDelay=5e3;timer.tick(1);assertEquals("Card should have shown",john,shownCard);assertTrue(card.isVisible());goog.testing.events.fireMouseOutEvent(john,elsewhere);goog.testing.events.fireMouseMoveEvent(document,offAnchor);timer.tick(hideDelay-1);assertTrue("Card should still be visible",card.isVisible());timer.tick(10);assertFalse("Card should be hidden",card.isVisible())}function testOnCancel(){initCard();showDelay=500;goog.testing.events.fireMouseOverEvent(john,elsewhere);timer.tick(showDelay-1);goog.testing.events.fireMouseOutEvent(john,elsewhere);goog.testing.events.fireMouseMoveEvent(document,offAnchor);timer.tick(10);assertFalse("Card should be hidden",card.isVisible());assertEquals("Should have cancelled trigger",john,cancelledElement)}function testMouseOverNonTrigger(){initCard();showDelay=500;goog.testing.events.fireMouseOverEvent(john,elsewhere);timer.tick(showDelay);triggeredElement=null;goog.testing.events.fireMouseOverEvent(jane,elsewhere);timer.tick(showDelay+1);assertNull(triggeredElement)}function testMouseOverNoTarget(){initCard();card.handleTriggerMouseOver_(new goog.testing.events.Event)}function testMultipleTriggers(){initCard();showDelay=500;hideDelay=1e3;goog.testing.events.fireMouseOverEvent(john,elsewhere);timer.tick(250);goog.testing.events.fireMouseOutEvent(john,james);goog.testing.events.fireMouseOverEvent(james,john);assertEquals("Should cancel first trigger",john,cancelledElement);timer.tick(300);assertFalse(card.isVisible());timer.tick(250);assertEquals("Should show second card",james,shownCard);assertTrue(card.isVisible());goog.testing.events.fireMouseOutEvent(james,john);goog.testing.events.fireMouseOverEvent(john,james);assertEquals("Should still show second card",james,card.getAnchorElement());assertTrue(card.isVisible());shownCard=null;timer.tick(501);assertEquals("Should show first card again",john,shownCard);assertTrue(card.isVisible());cancelledElement=null;goog.testing.events.fireMouseOutEvent(john,james);goog.testing.events.fireMouseOverEvent(james,john);goog.testing.events.fireMouseOutEvent(james,elsewhere);assertEquals("Should cancel second card",james,cancelledElement)}function testManualTrigger(){initCard();showDelay=500;goog.testing.events.fireMouseOverEvent(bill,elsewhere);timer.tick(showDelay);assertFalse(card.isVisible());card.triggerForElement(bill);hideDelay=600;timer.tick(showDelay);assertTrue(card.isVisible());goog.testing.events.fireMouseOutEvent(bill,elsewhere);goog.testing.events.fireMouseMoveEvent(document,offAnchor);timer.tick(hideDelay);assertFalse(card.isVisible())}function testIsAnchor(){initCard(function(element){return element==bill});showDelay=500;goog.testing.events.fireMouseOverEvent(bill,elsewhere);timer.tick(showDelay);assertTrue("Should trigger card",card.isVisible());hideDelay=300;goog.testing.events.fireMouseOutEvent(bill,elsewhere);goog.testing.events.fireMouseMoveEvent(document,offAnchor);timer.tick(hideDelay);assertFalse(card.isVisible());goog.testing.events.fireMouseOverEvent(john,elsewhere);timer.tick(showDelay);assertFalse("Should not trigger card",card.isVisible())}function testAnchorWithChildren(){initCard();showDelay=500;goog.testing.events.fireMouseOverEvent(james,elsewhere);timer.tick(250);var childBounds=goog.style.getBounds(child),inChild=new goog.math.Coordinate(childBounds.left+1,childBounds.top+1);goog.testing.events.fireMouseOutEvent(james,child);goog.testing.events.fireMouseMoveEvent(child,inChild);assertNull("Shouldn't cancel trigger",cancelledElement);triggeredElement=null;goog.testing.events.fireMouseOverEvent(child,james);assertNull("Shouldn't retrigger card",triggeredElement);timer.tick(250);assertTrue("Card should show with original delay",card.isVisible());hideDelay=300;goog.testing.events.fireMouseOutEvent(child,elsewhere);goog.testing.events.fireMouseMoveEvent(child,offAnchor);timer.tick(hideDelay);assertFalse(card.isVisible());goog.testing.events.fireMouseOverEvent(child,elsewhere);timer.tick(showDelay);assertTrue("Mouse over child should trigger card",card.isVisible())}function testNoTriggerWithMaxSearchSteps(){initCard(void 0,!0,0);showDelay=500;goog.testing.events.fireMouseOverEvent(child,elsewhere);timer.tick(showDelay);assertFalse("Should not trigger card",card.isVisible())}function testTriggerWithMaxSearchSteps(){initCard(void 0,!0,2);showDelay=500;goog.testing.events.fireMouseOverEvent(child,elsewhere);timer.tick(showDelay);assertTrue("Should trigger card",card.isVisible())}function testPositionAfterSecondTriggerWithMaxSearchSteps(){initCard(void 0,!0,2);showDelay=500;goog.testing.events.fireMouseOverEvent(john,elsewhere);timer.tick(showDelay);assertTrue("Should trigger card",card.isVisible());assertEquals("Card cursor x coordinate should be 1",card.position_.coordinate.x,1);card.cursorPosition=new goog.math.Coordinate(2,2);goog.testing.events.fireMouseOverEvent(child,elsewhere);timer.tick(showDelay);assertTrue("Should trigger card",card.isVisible());assertEquals("Card cursor x coordinate should be 2",card.position_.coordinate.x,2)}