goog.provide("goog.editor.plugins.LinkBubble");goog.provide("goog.editor.plugins.LinkBubble.Action");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.Range");goog.require("goog.dom.TagName");goog.require("goog.editor.Command");goog.require("goog.editor.Link");goog.require("goog.editor.plugins.AbstractBubblePlugin");goog.require("goog.functions");goog.require("goog.string");goog.require("goog.style");goog.require("goog.ui.editor.messages");goog.require("goog.uri.utils");goog.require("goog.window");goog.editor.plugins.LinkBubble=function(var_args){goog.editor.plugins.LinkBubble.base(this,"constructor");this.extraActions_=goog.array.toArray(arguments);this.actionSpans_=[];this.safeToOpenSchemes_=["http","https","ftp"]};goog.inherits(goog.editor.plugins.LinkBubble,goog.editor.plugins.AbstractBubblePlugin);goog.editor.plugins.LinkBubble.LINK_TEXT_ID_="tr_link-text";goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_="tr_test-link-span";goog.editor.plugins.LinkBubble.TEST_LINK_ID_="tr_test-link";goog.editor.plugins.LinkBubble.CHANGE_LINK_SPAN_ID_="tr_change-link-span";goog.editor.plugins.LinkBubble.CHANGE_LINK_ID_="tr_change-link";goog.editor.plugins.LinkBubble.DELETE_LINK_SPAN_ID_="tr_delete-link-span";goog.editor.plugins.LinkBubble.DELETE_LINK_ID_="tr_delete-link";goog.editor.plugins.LinkBubble.LINK_DIV_ID_="tr_link-div";goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_TEST_LINK=goog.getMsg("Go to link: ");goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_CHANGE=goog.getMsg("Change");goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_REMOVE=goog.getMsg("Remove");goog.editor.plugins.LinkBubble.MSG_INVALID_URL_LINK_BUBBLE=goog.getMsg("invalid url");goog.editor.plugins.LinkBubble.prototype.stopReferrerLeaks_=!1;goog.editor.plugins.LinkBubble.prototype.blockOpeningUnsafeSchemes_=!0;goog.editor.plugins.LinkBubble.prototype.stopReferrerLeaks=function(){this.stopReferrerLeaks_=!0};goog.editor.plugins.LinkBubble.prototype.setBlockOpeningUnsafeSchemes=function(blockOpeningUnsafeSchemes){this.blockOpeningUnsafeSchemes_=blockOpeningUnsafeSchemes};goog.editor.plugins.LinkBubble.prototype.setSafeToOpenSchemes=function(schemes){this.safeToOpenSchemes_=schemes};goog.editor.plugins.LinkBubble.prototype.getTrogClassId=function(){return"LinkBubble"};goog.editor.plugins.LinkBubble.prototype.isSupportedCommand=function(command){return command==goog.editor.Command.UPDATE_LINK_BUBBLE};goog.editor.plugins.LinkBubble.prototype.execCommandInternal=function(command,var_args){if(command==goog.editor.Command.UPDATE_LINK_BUBBLE){this.updateLink_()}};goog.editor.plugins.LinkBubble.prototype.updateLink_=function(){var targetEl=this.getTargetElement();if(targetEl){this.closeBubble();this.createBubble(targetEl)}};goog.editor.plugins.LinkBubble.prototype.getBubbleTargetFromSelection=function(selectedElement){var bubbleTarget=goog.dom.getAncestorByTagNameAndClass(selectedElement,goog.dom.TagName.A);if(!bubbleTarget){var range=this.getFieldObject().getRange();if(range&&range.isCollapsed()&&0==range.getStartOffset()){var startNode=range.getStartNode(),previous=startNode.previousSibling;if(previous&&previous.tagName==goog.dom.TagName.A){bubbleTarget=previous}}}return bubbleTarget};goog.editor.plugins.LinkBubble.prototype.setTestLinkUrlFn=function(func){this.testLinkUrlFn_=func};goog.editor.plugins.LinkBubble.prototype.getTargetUrl=function(){return this.getTargetElement().getAttribute("href")||""};goog.editor.plugins.LinkBubble.prototype.getBubbleType=function(){return goog.dom.TagName.A+""};goog.editor.plugins.LinkBubble.prototype.getBubbleTitle=function(){return goog.ui.editor.messages.MSG_LINK_CAPTION};goog.editor.plugins.LinkBubble.prototype.getTestLinkMessage=function(){return goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_TEST_LINK};goog.editor.plugins.LinkBubble.prototype.createBubbleContents=function(bubbleContainer){var linkObj=this.getLinkToTextObj_(),color=linkObj.valid?"black":"red",shouldOpenUrl=this.shouldOpenUrl(linkObj.linkText),linkTextSpan;if(goog.editor.Link.isLikelyEmailAddress(linkObj.linkText)||!linkObj.valid||!shouldOpenUrl){linkTextSpan=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.LINK_TEXT_ID_,style:"color:"+color},this.dom_.createTextNode(linkObj.linkText))}else{var testMsgSpan=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_},this.getTestLinkMessage());linkTextSpan=this.dom_.createDom(goog.dom.TagName.SPAN,{id:goog.editor.plugins.LinkBubble.LINK_TEXT_ID_,style:"color:"+color},"");var linkText=goog.string.truncateMiddle(linkObj.linkText,48);this.createLink(goog.editor.plugins.LinkBubble.TEST_LINK_ID_,this.dom_.createTextNode(linkText).data,this.testLink,linkTextSpan)}var changeLinkSpan=this.createLinkOption(goog.editor.plugins.LinkBubble.CHANGE_LINK_SPAN_ID_);this.createLink(goog.editor.plugins.LinkBubble.CHANGE_LINK_ID_,goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_CHANGE,this.showLinkDialog_,changeLinkSpan);this.actionSpans_=[];for(var i=0;i<this.extraActions_.length;i++){var action=this.extraActions_[i],actionSpan=this.createLinkOption(action.spanId_);this.actionSpans_.push(actionSpan);this.createLink(action.linkId_,action.message_,function(){action.actionFn_(this.getTargetUrl())},actionSpan)}var removeLinkSpan=this.createLinkOption(goog.editor.plugins.LinkBubble.DELETE_LINK_SPAN_ID_);this.createLink(goog.editor.plugins.LinkBubble.DELETE_LINK_ID_,goog.editor.plugins.LinkBubble.MSG_LINK_BUBBLE_REMOVE,this.deleteLink_,removeLinkSpan);this.onShow();var bubbleContents=this.dom_.createDom(goog.dom.TagName.DIV,{id:goog.editor.plugins.LinkBubble.LINK_DIV_ID_},testMsgSpan||"",linkTextSpan,changeLinkSpan);for(i=0;i<this.actionSpans_.length;i++){bubbleContents.appendChild(this.actionSpans_[i])}bubbleContents.appendChild(removeLinkSpan);goog.dom.appendChild(bubbleContainer,bubbleContents)};goog.editor.plugins.LinkBubble.prototype.testLink=function(opt_event){goog.window.open(this.getTestLinkAction_(),{target:"_blank",noreferrer:this.stopReferrerLeaks_},this.getFieldObject().getAppWindow());if(opt_event){opt_event.stopPropagation();opt_event.preventDefault()}};goog.editor.plugins.LinkBubble.prototype.isInvalidUrl=goog.functions.FALSE;goog.editor.plugins.LinkBubble.prototype.getLinkToTextObj_=function(){var isError,targetUrl=this.getTargetUrl();if(this.isInvalidUrl(targetUrl)){targetUrl=goog.editor.plugins.LinkBubble.MSG_INVALID_URL_LINK_BUBBLE;isError=!0}else if(goog.editor.Link.isMailto(targetUrl)){targetUrl=targetUrl.substring(7)}return{linkText:targetUrl,valid:!isError}};goog.editor.plugins.LinkBubble.prototype.showLinkDialog_=function(e){e.preventDefault();this.getFieldObject().execCommand(goog.editor.Command.MODAL_LINK_EDITOR,new goog.editor.Link(this.getTargetElement(),!1));this.closeBubble()};goog.editor.plugins.LinkBubble.prototype.deleteLink_=function(e){e.preventDefault();this.getFieldObject().dispatchBeforeChange();var link=this.getTargetElement(),child=link.lastChild;goog.dom.flattenElement(link);var restoreScrollPosition=this.saveScrollPosition(),range=goog.dom.Range.createFromNodeContents(child);range.collapse(!1);range.select();this.closeBubble();this.getFieldObject().dispatchChange();this.getFieldObject().focus();restoreScrollPosition()};goog.editor.plugins.LinkBubble.prototype.onShow=function(){var linkDiv=this.dom_.getElement(goog.editor.plugins.LinkBubble.LINK_DIV_ID_);if(linkDiv){var testLinkSpan=this.dom_.getElement(goog.editor.plugins.LinkBubble.TEST_LINK_SPAN_ID_);if(testLinkSpan){var url=this.getTargetUrl();goog.style.setElementShown(testLinkSpan,!goog.editor.Link.isMailto(url))}for(var i=0;i<this.extraActions_.length;i++){var action=this.extraActions_[i],actionSpan=this.dom_.getElement(action.spanId_);if(actionSpan){goog.style.setElementShown(actionSpan,action.toShowFn_(this.getTargetUrl()))}}}};goog.editor.plugins.LinkBubble.prototype.getTestLinkAction_=function(){var targetUrl=this.getTargetUrl();return this.testLinkUrlFn_?this.testLinkUrlFn_(targetUrl):targetUrl};goog.editor.plugins.LinkBubble.prototype.shouldOpenUrl=function(url){return!this.blockOpeningUnsafeSchemes_||this.isSafeSchemeToOpen_(url)};goog.editor.plugins.LinkBubble.prototype.isSafeSchemeToOpen_=function(url){var scheme=goog.uri.utils.getScheme(url)||"http";return goog.array.contains(this.safeToOpenSchemes_,scheme.toLowerCase())};goog.editor.plugins.LinkBubble.Action=function(spanId,linkId,message,toShowFn,actionFn){this.spanId_=spanId;this.linkId_=linkId;this.message_=message;this.toShowFn_=toShowFn;this.actionFn_=actionFn};