goog.setTestOnly("goog.testing.TestCase");goog.provide("goog.testing.TestCase");goog.provide("goog.testing.TestCase.Error");goog.provide("goog.testing.TestCase.Order");goog.provide("goog.testing.TestCase.Result");goog.provide("goog.testing.TestCase.Test");goog.require("goog.Promise");goog.require("goog.Thenable");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.object");goog.require("goog.testing.JsUnitException");goog.require("goog.testing.asserts");goog.require("goog.testing.stacktrace");goog.testing.TestCase=function(opt_name){this.name_=opt_name||"Untitled Test Case";this.tests_=[];this.testsToRun_=null;this.order=goog.testing.TestCase.Order.SORTED;this.runNextTestCallback_=goog.nullFunction;this.depth_=0;this.curTest_=null;this.result_=new goog.testing.TestCase.Result(this);this.thrownAssertionExceptions_=[];this.failOnUnreportedAsserts=!0;this.promiseTimeout=1e3};goog.testing.TestCase.Order={NATURAL:"natural",RANDOM:"random",SORTED:"sorted"};goog.testing.TestCase.prototype.getName=function(){return this.name_};goog.testing.TestCase.maxRunTime=200;goog.testing.TestCase.MAX_STACK_DEPTH_=50;goog.testing.TestCase.protectedSetTimeout_=goog.global.setTimeout;goog.testing.TestCase.protectedClearTimeout_=goog.global.clearTimeout;goog.testing.TestCase.protectedDate_=Date;goog.testing.TestCase.setTimeoutAsString_=goog.global.setTimeout+"";goog.testing.TestCase.currentTestName=null;goog.testing.TestCase.IS_IE="undefined"==typeof opera&&!!goog.global.navigator&&-1!=goog.global.navigator.userAgent.indexOf("MSIE");goog.testing.TestCase.prototype.exceptionBeforeTest;goog.testing.TestCase.prototype.started=!1;goog.testing.TestCase.prototype.running=!1;goog.testing.TestCase.prototype.startTime_=0;goog.testing.TestCase.prototype.batchTime_=0;goog.testing.TestCase.prototype.currentTestPointer_=0;goog.testing.TestCase.prototype.onCompleteCallback_=null;goog.testing.TestCase.prototype.add=function(test){goog.asserts.assert(test);if(this.started){throw Error("Tests cannot be added after execute() has been called. "+"Test: "+test.name)}this.tests_.push(test)};goog.testing.TestCase.prototype.addNewTest=function(name,ref,opt_scope){var test=new goog.testing.TestCase.Test(name,ref,opt_scope||this);this.add(test)};goog.testing.TestCase.prototype.setTests=function(tests){this.tests_=tests};goog.testing.TestCase.prototype.getTests=function(){return this.tests_};goog.testing.TestCase.prototype.getCount=function(){return this.tests_.length};goog.testing.TestCase.prototype.getActuallyRunCount=function(){return this.testsToRun_?goog.object.getCount(this.testsToRun_):0};goog.testing.TestCase.prototype.next=function(){var test;while(test=this.tests_[this.currentTestPointer_++]){if(!this.testsToRun_||this.testsToRun_[test.name]||this.testsToRun_[this.currentTestPointer_-1]){return test}}return null};goog.testing.TestCase.prototype.reset=function(){this.currentTestPointer_=0;this.result_=new goog.testing.TestCase.Result(this)};goog.testing.TestCase.prototype.setCompletedCallback=function(fn){this.onCompleteCallback_=fn};goog.testing.TestCase.prototype.setOrder=function(order){this.order=order};goog.testing.TestCase.prototype.setTestsToRun=function(testsToRun){this.testsToRun_=testsToRun};goog.testing.TestCase.prototype.shouldRunTests=function(){return!0};goog.testing.TestCase.prototype.execute=function(){if(!this.prepareForRun_()){return}this.log("Starting tests: "+this.name_);this.cycleTests()};goog.testing.TestCase.prototype.prepareForRun_=function(){this.started=!0;this.reset();this.startTime_=this.now();this.running=!0;this.result_.totalCount=this.getCount();if(!this.shouldRunTests()){this.log("shouldRunTests() returned false, skipping these tests.");this.result_.testSuppressed=!0;this.finalize();return!1}return!0};goog.testing.TestCase.prototype.finalize=function(){this.saveMessage("Done");this.tearDownPage();var restoredSetTimeout=goog.testing.TestCase.protectedSetTimeout_==goog.global.setTimeout&&goog.testing.TestCase.protectedClearTimeout_==goog.global.clearTimeout;if(!restoredSetTimeout&&goog.testing.TestCase.IS_IE&&goog.global.setTimeout+""==goog.testing.TestCase.setTimeoutAsString_){restoredSetTimeout=!0}if(!restoredSetTimeout){var message="ERROR: Test did not restore setTimeout and clearTimeout";this.saveMessage(message);var err=new goog.testing.TestCase.Error(this.name_,message);this.result_.errors.push(err)}goog.global.clearTimeout=goog.testing.TestCase.protectedClearTimeout_;goog.global.setTimeout=goog.testing.TestCase.protectedSetTimeout_;this.endTime_=this.now();this.running=!1;this.result_.runTime=this.endTime_-this.startTime_;this.result_.numFilesLoaded=this.countNumFilesLoaded_();this.result_.complete=!0;this.log(this.result_.getSummary());if(this.result_.isSuccess()){this.log("Tests complete")}else{this.log("Tests Failed")}if(this.onCompleteCallback_){var fn=this.onCompleteCallback_;fn();this.onCompleteCallback_=null}};goog.testing.TestCase.prototype.saveMessage=function(message){this.result_.messages.push(this.getTimeStamp_()+"  "+message)};goog.testing.TestCase.prototype.isInsideMultiTestRunner=function(){var top=goog.global.top;return top&&"undefined"!=typeof top._allTests};goog.testing.TestCase.prototype.log=function(val){if(!this.isInsideMultiTestRunner()&&goog.global.console){if("string"==typeof val){val=this.getTimeStamp_()+" : "+val}if(val instanceof Error&&val.stack){goog.global.console.log(val,val.message,val.stack)}else{goog.global.console.log(val)}}};goog.testing.TestCase.prototype.isSuccess=function(){return!!this.result_&&this.result_.isSuccess()};goog.testing.TestCase.prototype.getReport=function(opt_verbose){var rv=[];if(this.running){rv.push(this.name_+" [RUNNING]")}else{var label=this.result_.isSuccess()?"PASSED":"FAILED";rv.push(this.name_+" ["+label+"]")}if(goog.global.location){rv.push(this.trimPath_(goog.global.location.href))}rv.push(this.result_.getSummary());if(opt_verbose){rv.push(".",this.result_.messages.join("\n"))}else if(!this.result_.isSuccess()){rv.push(this.result_.errors.join("\n"))}rv.push(" ");return rv.join("\n")};goog.testing.TestCase.prototype.getResult=function(){return this.result_};goog.testing.TestCase.prototype.getRunTime=function(){return this.result_.runTime};goog.testing.TestCase.prototype.getNumFilesLoaded=function(){return this.result_.numFilesLoaded};goog.testing.TestCase.prototype.getTestResults=function(){return this.result_.resultsByName};goog.testing.TestCase.prototype.runTests=function(){try{this.setUpPage()}catch(e){this.exceptionBeforeTest=e}this.execute()};goog.testing.TestCase.prototype.runTestsReturningPromise=function(){try{this.setUpPage()}catch(e){this.exceptionBeforeTest=e}if(!this.prepareForRun_()){return goog.Promise.resolve(this.result_)}this.log("Starting tests: "+this.name_);this.saveMessage("Start");this.batchTime_=this.now();return new goog.Promise(function(resolve){this.runNextTestCallback_=resolve;this.runNextTest_()},this)};goog.testing.TestCase.prototype.runNextTest_=function(){this.curTest_=this.next();if(!this.curTest_||!this.running){this.finalize();this.runNextTestCallback_(this.result_);return}this.result_.runCount++;this.log("Running test: "+this.curTest_.name);if(this.maybeFailTestEarly(this.curTest_)){this.finishTestInvocation_();return}goog.testing.TestCase.currentTestName=this.curTest_.name;this.invokeTestFunction_(this.setUp,this.safeRunTest_,this.safeTearDown_,"setUp")};goog.testing.TestCase.prototype.safeRunTest_=function(){this.invokeTestFunction_(goog.bind(this.curTest_.ref,this.curTest_.scope),this.safeTearDown_,this.safeTearDown_,this.curTest_.name)};goog.testing.TestCase.prototype.safeTearDown_=function(opt_error){if(1==arguments.length){this.doError(this.curTest_,opt_error)}this.invokeTestFunction_(this.tearDown,this.finishTestInvocation_,this.finishTestInvocation_,"tearDown")};goog.testing.TestCase.prototype.invokeTestFunction_=function(fn,onSuccess,onFailure,fnName){var testCase=this;this.thrownAssertionExceptions_=[];try{var retval=fn.call(this);if(goog.Thenable.isImplementedBy(retval)||goog.isFunction(retval&&retval.then)){var promise=goog.Promise.resolve(retval),self=this;promise=this.rejectIfPromiseTimesOut_(promise,self.promiseTimeout,"Timed out while waiting for a promise returned from "+fnName+" to resolve. Set goog.testing.TestCase.getActiveTestCase()"+".promiseTimeout to adjust the timeout.");promise.then(function(){self.resetBatchTimeAfterPromise_();if(0==testCase.thrownAssertionExceptions_.length){onSuccess.call(self)}else{onFailure.call(self,testCase.reportUnpropagatedAssertionExceptions_(fnName))}},function(e){self.resetBatchTimeAfterPromise_();onFailure.call(self,e)})}else{if(0==this.thrownAssertionExceptions_.length){onSuccess.call(this)}else{onFailure.call(this,this.reportUnpropagatedAssertionExceptions_(fnName))}}}catch(e){onFailure.call(this,e)}};goog.testing.TestCase.prototype.reportUnpropagatedAssertionExceptions_=function(testName){for(var numExceptions=this.thrownAssertionExceptions_.length,i=0;i<numExceptions;i++){this.recordError_(testName,this.thrownAssertionExceptions_[i])}return new goog.testing.JsUnitException("One or more assertions were raised but not caught by the testing "+"framework. These assertions may have been unintentionally captured "+"by a catch block or a thenCatch resolution of a Promise.")};goog.testing.TestCase.prototype.resetBatchTimeAfterPromise_=function(){this.batchTime_=this.now()};goog.testing.TestCase.prototype.finishTestInvocation_=function(opt_error){if(1==arguments.length){this.doError(this.curTest_,opt_error)}if(!(this.curTest_.name in this.result_.resultsByName)||!this.result_.resultsByName[this.curTest_.name].length){this.doSuccess(this.curTest_)}goog.testing.TestCase.currentTestName=null;if(this.depth_>goog.testing.TestCase.MAX_STACK_DEPTH_||this.now()-this.batchTime_>goog.testing.TestCase.maxRunTime){this.saveMessage("Breaking async");this.timeout(goog.bind(this.startNextBatch_,this),0)}else{++this.depth_;this.runNextTest_()}};goog.testing.TestCase.prototype.startNextBatch_=function(){this.batchTime_=this.now();this.depth_=0;this.runNextTest_()};goog.testing.TestCase.prototype.orderTests_=function(){switch(this.order){case goog.testing.TestCase.Order.RANDOM:var i=this.tests_.length;while(1<i){var j=Math.floor(Math.random()*i);i--;var tmp=this.tests_[i];this.tests_[i]=this.tests_[j];this.tests_[j]=tmp}break;case goog.testing.TestCase.Order.SORTED:this.tests_.sort(function(t1,t2){if(t1.name==t2.name){return 0}return t1.name<t2.name?-1:1});break;}};goog.testing.TestCase.prototype.getGlobals=function(opt_prefix){return goog.testing.TestCase.getGlobals(opt_prefix)};goog.testing.TestCase.getGlobals=function(opt_prefix){return"undefined"!=typeof goog.global.RuntimeObject?[goog.global.RuntimeObject((opt_prefix||"")+"*"),goog.global]:[goog.global]};goog.testing.TestCase.getActiveTestCase=function(){var gTestRunner=goog.global.G_testRunner;if(gTestRunner&&gTestRunner.testCase){return gTestRunner.testCase}else{return null}};goog.testing.TestCase.invalidateAssertionException=function(e){var testCase=goog.testing.TestCase.getActiveTestCase();if(testCase){testCase.invalidateAssertionException(e)}else{goog.global.console.error("Failed to remove expected exception: no test case is installed.")}};goog.testing.TestCase.prototype.setUpPage=function(){};goog.testing.TestCase.prototype.tearDownPage=function(){};goog.testing.TestCase.prototype.setUp=function(){};goog.testing.TestCase.prototype.tearDown=function(){};goog.testing.TestCase.prototype.getAutoDiscoveryPrefix=function(){return"test"};goog.testing.TestCase.prototype.getBatchTime=function(){return this.batchTime_};goog.testing.TestCase.prototype.setBatchTime=function(batchTime){this.batchTime_=batchTime};goog.testing.TestCase.prototype.createTestFromAutoDiscoveredFunction=function(name,ref){return new goog.testing.TestCase.Test(name,ref,goog.global)};goog.testing.TestCase.prototype.autoDiscoverLifecycle=function(opt_obj){var obj=opt_obj||goog.global;if(obj.setUp){this.setUp=goog.bind(obj.setUp,obj)}if(obj.tearDown){this.tearDown=goog.bind(obj.tearDown,obj)}if(obj.setUpPage){this.setUpPage=goog.bind(obj.setUpPage,obj)}if(obj.tearDownPage){this.tearDownPage=goog.bind(obj.tearDownPage,obj)}if(obj.runTests){this.runTests=goog.bind(obj.runTests,obj)}if(obj.shouldRunTests){this.shouldRunTests=goog.bind(obj.shouldRunTests,obj)}};goog.testing.TestCase.prototype.setTestObj=function(obj){goog.asserts.assert(0==this.tests_.length,"Test methods have already been configured.");for(var regex=new RegExp("^"+this.getAutoDiscoveryPrefix()),properties=goog.object.getAllPropertyNames(obj),i=0,name;i<properties.length;i++){name=properties[i];if(regex.test(name)){var testMethod=obj[name];if(goog.isFunction(testMethod)){this.addNewTest(name,testMethod,obj)}}}if(obj.getTestName){this.name_=obj.getTestName()}this.autoDiscoverLifecycle(obj)};goog.testing.TestCase.prototype.autoDiscoverTests=function(){for(var prefix=this.getAutoDiscoveryPrefix(),testSources=this.getGlobals(prefix),foundTests=[],i=0,testSource;i<testSources.length;i++){testSource=testSources[i];for(var name in testSource){if(new RegExp("^"+prefix).test(name)){var ref;try{ref=testSource[name]}catch(ex){ref=void 0}if(goog.isFunction(ref)){foundTests.push(this.createTestFromAutoDiscoveredFunction(name,ref))}}}}for(var i=0;i<foundTests.length;i++){this.add(foundTests[i])}this.orderTests_();this.log(this.getCount()+" tests auto-discovered");this.autoDiscoverLifecycle()};goog.testing.TestCase.prototype.maybeFailTestEarly=function(testCase){if(this.exceptionBeforeTest){testCase.name="setUpPage for "+testCase.name;this.doError(testCase,this.exceptionBeforeTest);return!0}return!1};goog.testing.TestCase.prototype.cycleTests=function(){this.saveMessage("Start");this.batchTime_=this.now();if(this.running){this.runNextTestCallback_=goog.nullFunction;this.runNextTest_()}};goog.testing.TestCase.prototype.countNumFilesLoaded_=function(){for(var scripts=goog.dom.getElementsByTagName(goog.dom.TagName.SCRIPT),count=0,i=0,n=scripts.length;i<n;i++){if(scripts[i].src){count++}}return count};goog.testing.TestCase.prototype.timeout=function(fn,time){var protectedSetTimeout=goog.testing.TestCase.protectedSetTimeout_;return protectedSetTimeout(fn,time)};goog.testing.TestCase.prototype.clearTimeout=function(id){var protectedClearTimeout=goog.testing.TestCase.protectedClearTimeout_;protectedClearTimeout(id)};goog.testing.TestCase.prototype.now=function(){var protectedDate=goog.testing.TestCase.protectedDate_;return new protectedDate().getTime()};goog.testing.TestCase.prototype.getTimeStamp_=function(){var protectedDate=goog.testing.TestCase.protectedDate_,d=new protectedDate,millis="00"+d.getMilliseconds();millis=millis.substr(millis.length-3);return this.pad_(d.getHours())+":"+this.pad_(d.getMinutes())+":"+this.pad_(d.getSeconds())+"."+millis};goog.testing.TestCase.prototype.pad_=function(number){return 10>number?"0"+number:number+""};goog.testing.TestCase.prototype.trimPath_=function(path){return path.substring(path.indexOf("google3")+8)};goog.testing.TestCase.prototype.doSuccess=function(test){this.result_.successCount++;if(!(test.name in this.result_.resultsByName)){this.result_.resultsByName[test.name]=[]}var message=test.name+" : PASSED";this.saveMessage(message);this.log(message)};goog.testing.TestCase.prototype.recordError_=function(testName,opt_e){var message=testName+" : FAILED";this.log(message);this.saveMessage(message);var err=this.logError(testName,opt_e);this.result_.errors.push(err);if(testName in this.result_.resultsByName){this.result_.resultsByName[testName].push(err.toString())}else{this.result_.resultsByName[testName]=[err.toString()]}};goog.testing.TestCase.prototype.doError=function(test,opt_e){this.recordError_(test.name,opt_e)};goog.testing.TestCase.prototype.raiseAssertionException=function(e){if(this.failOnUnreportedAsserts){this.thrownAssertionExceptions_.push(e)}throw e};goog.testing.TestCase.prototype.invalidateAssertionException=function(e){if(this.failOnUnreportedAsserts){goog.array.remove(this.thrownAssertionExceptions_,e)}};goog.testing.TestCase.prototype.logError=function(name,opt_e){var errMsg=null,stack=null;if(opt_e){this.log(opt_e);if(goog.isString(opt_e)){errMsg=opt_e}else{errMsg=opt_e.message||opt_e.description||opt_e.toString();stack=opt_e.stack?goog.testing.stacktrace.canonicalize(opt_e.stack):opt_e.stackTrace}}else{errMsg="An unknown error occurred"}var err=new goog.testing.TestCase.Error(name,errMsg,stack);if(!opt_e||!opt_e.isJsUnitException||!opt_e.loggedJsUnitException){this.saveMessage(err.toString())}if(opt_e&&opt_e.isJsUnitException){opt_e.loggedJsUnitException=!0}return err};goog.testing.TestCase.Test=function(name,ref,opt_scope){this.name=name;this.ref=ref;this.scope=opt_scope||null};goog.testing.TestCase.Test.prototype.execute=function(){this.ref.call(this.scope)};goog.testing.TestCase.Result=function(testCase){this.testCase_=testCase;this.totalCount=0;this.runCount=0;this.successCount=0;this.runTime=0;this.numFilesLoaded=0;this.testSuppressed=!1;this.resultsByName={};this.errors=[];this.messages=[];this.complete=!1};goog.testing.TestCase.Result.prototype.isSuccess=function(){return this.complete&&0==this.errors.length};goog.testing.TestCase.Result.prototype.getSummary=function(){var summary=this.runCount+" of "+this.totalCount+" tests run in "+this.runTime+"ms.\n";if(this.testSuppressed){summary+="Tests not run because shouldRunTests() returned false."}else{var failures=this.totalCount-this.successCount,suppressionMessage="",countOfRunTests=this.testCase_.getActuallyRunCount();if(countOfRunTests){failures=countOfRunTests-this.successCount;suppressionMessage=", "+(this.totalCount-countOfRunTests)+" suppressed by querystring"}summary+=this.successCount+" passed, "+failures+" failed"+suppressionMessage+".\n"+Math.round(this.runTime/this.runCount)+" ms/test. "+this.numFilesLoaded+" files loaded."}return summary};goog.testing.TestCase.initializeTestRunner=function(testCase){testCase.autoDiscoverTests();if(goog.global.location){var search=goog.global.location.search;testCase.setOrder(goog.testing.TestCase.parseOrder_(search)||goog.testing.TestCase.Order.SORTED);testCase.setTestsToRun(goog.testing.TestCase.parseRunTests_(search))}var gTestRunner=goog.global.G_testRunner;if(gTestRunner){gTestRunner.initialize(testCase)}else{throw Error("G_testRunner is undefined. Please ensure goog.testing.jsunit"+" is included.")}};goog.testing.TestCase.parseOrder_=function(search){var order=null,orderMatch=search.match(/(?:\?|&)order=(natural|random|sorted)/i);if(orderMatch){order=orderMatch[1].toLowerCase()}return order};goog.testing.TestCase.parseRunTests_=function(search){var testsToRun=null,runTestsMatch=search.match(/(?:\?|&)runTests=([^?&]+)/i);if(runTestsMatch){testsToRun={};for(var arr=runTestsMatch[1].split(","),i=0,len=arr.length;i<len;i++){testsToRun[arr[i]]=!0}}return testsToRun};goog.testing.TestCase.prototype.rejectIfPromiseTimesOut_=function(promise,timeoutInMs,errorMsg){var self=this,start=this.now();return new goog.Promise(function(resolve,reject){var timeoutId=self.timeout(function(){var elapsed=self.now()-start;reject(new Error(errorMsg+"\nElapsed time: "+elapsed+"ms."))},timeoutInMs);promise.then(resolve,reject);var clearTimeout=goog.bind(self.clearTimeout,self,timeoutId);promise.then(clearTimeout,clearTimeout)})};goog.testing.TestCase.Error=function(source,message,opt_stack){this.source=source;this.message=message;this.stack=null;if(opt_stack){this.stack=opt_stack}else{if(Error.captureStackTrace){Error.captureStackTrace(this,goog.testing.TestCase.Error)}else{var stack=new Error().stack;if(stack){this.stack=stack}}}};goog.testing.TestCase.Error.prototype.toString=function(){return"ERROR in "+this.source+"\n"+this.message+(this.stack?"\n"+this.stack:"")};