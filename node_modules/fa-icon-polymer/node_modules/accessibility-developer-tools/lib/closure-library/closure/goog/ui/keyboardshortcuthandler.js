goog.provide("goog.ui.KeyboardShortcutEvent");goog.provide("goog.ui.KeyboardShortcutHandler");goog.provide("goog.ui.KeyboardShortcutHandler.EventType");goog.provide("goog.ui.KeyboardShortcutHandler.Modifiers");goog.require("goog.Timer");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyNames");goog.require("goog.object");goog.require("goog.userAgent");goog.ui.KeyboardShortcutHandler=function(keyTarget){goog.events.EventTarget.call(this);this.shortcuts_={};this.currentTree_=this.shortcuts_;this.lastStrokeTime_=0;this.globalKeys_=goog.object.createSet(goog.ui.KeyboardShortcutHandler.DEFAULT_GLOBAL_KEYS_);this.textInputs_=goog.object.createSet(goog.ui.KeyboardShortcutHandler.DEFAULT_TEXT_INPUTS_);this.alwaysPreventDefault_=!0;this.alwaysStopPropagation_=!1;this.allShortcutsAreGlobal_=!1;this.modifierShortcutsAreGlobal_=!0;this.allowSpaceKeyOnButtons_=!1;this.activeShortcutKeyForGecko_=null;this.initializeKeyListener(keyTarget)};goog.inherits(goog.ui.KeyboardShortcutHandler,goog.events.EventTarget);goog.tagUnsealableClass(goog.ui.KeyboardShortcutHandler);goog.ui.KeyboardShortcutHandler.SequenceNode_=function(opt_shortcut){this.shortcut=opt_shortcut||null;this.next=opt_shortcut?null:{}};goog.ui.KeyboardShortcutHandler.createTerminalNode_=function(shortcut){return new goog.ui.KeyboardShortcutHandler.SequenceNode_(shortcut)};goog.ui.KeyboardShortcutHandler.createInternalNode_=function(){return new goog.ui.KeyboardShortcutHandler.SequenceNode_};goog.ui.KeyboardShortcutHandler.SequenceTree_;goog.ui.KeyboardShortcutHandler.MAX_KEY_SEQUENCE_DELAY=1500;goog.ui.KeyboardShortcutHandler.Modifiers={NONE:0,SHIFT:1,CTRL:2,ALT:4,META:8};goog.ui.KeyboardShortcutHandler.DEFAULT_GLOBAL_KEYS_=[goog.events.KeyCodes.ESC,goog.events.KeyCodes.F1,goog.events.KeyCodes.F2,goog.events.KeyCodes.F3,goog.events.KeyCodes.F4,goog.events.KeyCodes.F5,goog.events.KeyCodes.F6,goog.events.KeyCodes.F7,goog.events.KeyCodes.F8,goog.events.KeyCodes.F9,goog.events.KeyCodes.F10,goog.events.KeyCodes.F11,goog.events.KeyCodes.F12,goog.events.KeyCodes.PAUSE];goog.ui.KeyboardShortcutHandler.DEFAULT_TEXT_INPUTS_=["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"];goog.ui.KeyboardShortcutHandler.EventType={SHORTCUT_TRIGGERED:"shortcut",SHORTCUT_PREFIX:"shortcut_"};goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_;goog.ui.KeyboardShortcutHandler.prototype.keyTarget_;goog.ui.KeyboardShortcutHandler.prototype.metaKeyRecentlyReleased_;goog.ui.KeyboardShortcutHandler.prototype.isPrintableKey_;goog.ui.KeyboardShortcutHandler.getKeyCode=function(name){if(!goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_){var map={};for(var key in goog.events.KeyNames){map[goog.events.KeyNames[key]]=goog.events.KeyCodes.normalizeKeyCode(parseInt(key,10))}goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_=map}return goog.ui.KeyboardShortcutHandler.nameToKeyCodeCache_[name]};goog.ui.KeyboardShortcutHandler.prototype.setAlwaysPreventDefault=function(alwaysPreventDefault){this.alwaysPreventDefault_=alwaysPreventDefault};goog.ui.KeyboardShortcutHandler.prototype.getAlwaysPreventDefault=function(){return this.alwaysPreventDefault_};goog.ui.KeyboardShortcutHandler.prototype.setAlwaysStopPropagation=function(alwaysStopPropagation){this.alwaysStopPropagation_=alwaysStopPropagation};goog.ui.KeyboardShortcutHandler.prototype.getAlwaysStopPropagation=function(){return this.alwaysStopPropagation_};goog.ui.KeyboardShortcutHandler.prototype.setAllShortcutsAreGlobal=function(allShortcutsGlobal){this.allShortcutsAreGlobal_=allShortcutsGlobal};goog.ui.KeyboardShortcutHandler.prototype.getAllShortcutsAreGlobal=function(){return this.allShortcutsAreGlobal_};goog.ui.KeyboardShortcutHandler.prototype.setModifierShortcutsAreGlobal=function(modifierShortcutsGlobal){this.modifierShortcutsAreGlobal_=modifierShortcutsGlobal};goog.ui.KeyboardShortcutHandler.prototype.getModifierShortcutsAreGlobal=function(){return this.modifierShortcutsAreGlobal_};goog.ui.KeyboardShortcutHandler.prototype.setAllowSpaceKeyOnButtons=function(allowSpaceKeyOnButtons){this.allowSpaceKeyOnButtons_=allowSpaceKeyOnButtons};goog.ui.KeyboardShortcutHandler.prototype.registerShortcut=function(identifier,var_args){goog.ui.KeyboardShortcutHandler.setShortcut_(this.shortcuts_,this.interpretStrokes_(1,arguments),identifier)};goog.ui.KeyboardShortcutHandler.prototype.unregisterShortcut=function(var_args){goog.ui.KeyboardShortcutHandler.unsetShortcut_(this.shortcuts_,this.interpretStrokes_(0,arguments))};goog.ui.KeyboardShortcutHandler.prototype.isShortcutRegistered=function(var_args){return this.checkShortcut_(this.interpretStrokes_(0,arguments))};goog.ui.KeyboardShortcutHandler.prototype.interpretStrokes_=function(initialIndex,args){var strokes;if(goog.isString(args[initialIndex])){strokes=goog.array.map(goog.ui.KeyboardShortcutHandler.parseStringShortcut(args[initialIndex]),function(stroke){goog.asserts.assertNumber(stroke.keyCode,"A non-modifier key is needed in each stroke.");return goog.ui.KeyboardShortcutHandler.makeStroke_(stroke.keyCode,stroke.modifiers)})}else{var strokesArgs=args,i=initialIndex;if(goog.isArray(args[initialIndex])){strokesArgs=args[initialIndex];i=0}strokes=[];for(;i<strokesArgs.length;i+=2){strokes.push(goog.ui.KeyboardShortcutHandler.makeStroke_(strokesArgs[i],strokesArgs[i+1]))}}return strokes};goog.ui.KeyboardShortcutHandler.prototype.unregisterAll=function(){this.shortcuts_={}};goog.ui.KeyboardShortcutHandler.prototype.setGlobalKeys=function(keys){this.globalKeys_=goog.object.createSet(keys)};goog.ui.KeyboardShortcutHandler.prototype.getGlobalKeys=function(){return goog.object.getKeys(this.globalKeys_)};goog.ui.KeyboardShortcutHandler.prototype.disposeInternal=function(){goog.ui.KeyboardShortcutHandler.superClass_.disposeInternal.call(this);this.unregisterAll();this.clearKeyListener()};goog.ui.KeyboardShortcutHandler.prototype.getEventType=function(identifier){return goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_PREFIX+identifier};goog.ui.KeyboardShortcutHandler.parseStringShortcut=function(s){s=s.replace(/[ +]*\+[ +]*/g,"+").replace(/[ ]+/g," ").toLowerCase();for(var groups=s.split(" "),strokes=[],group,i=0;group=groups[i];i++){for(var keys=group.split("+"),keyCode=null,modifiers=goog.ui.KeyboardShortcutHandler.Modifiers.NONE,key,j=0;key=keys[j];j++){switch(key){case"shift":modifiers|=goog.ui.KeyboardShortcutHandler.Modifiers.SHIFT;continue;case"ctrl":modifiers|=goog.ui.KeyboardShortcutHandler.Modifiers.CTRL;continue;case"alt":modifiers|=goog.ui.KeyboardShortcutHandler.Modifiers.ALT;continue;case"meta":modifiers|=goog.ui.KeyboardShortcutHandler.Modifiers.META;continue;}if(!goog.isNull(keyCode)){goog.asserts.fail("At most one non-modifier key can be in a stroke.")}keyCode=goog.ui.KeyboardShortcutHandler.getKeyCode(key);goog.asserts.assertNumber(keyCode,"Key name not found in goog.events.KeyNames: "+key);break}strokes.push({keyCode:keyCode,modifiers:modifiers})}return strokes};goog.ui.KeyboardShortcutHandler.prototype.initializeKeyListener=function(keyTarget){this.keyTarget_=keyTarget;goog.events.listen(this.keyTarget_,goog.events.EventType.KEYDOWN,this.handleKeyDown_,void 0,this);if(goog.userAgent.WINDOWS){goog.events.listen(this.keyTarget_,goog.events.EventType.KEYPRESS,this.handleWindowsKeyPress_,void 0,this)}goog.events.listen(this.keyTarget_,goog.events.EventType.KEYUP,this.handleKeyUp_,void 0,this)};goog.ui.KeyboardShortcutHandler.prototype.handleKeyUp_=function(e){if(goog.userAgent.GECKO){this.handleGeckoKeyUp_(e)}if(goog.userAgent.WINDOWS){this.handleWindowsKeyUp_(e)}};goog.ui.KeyboardShortcutHandler.prototype.handleGeckoKeyUp_=function(e){if(goog.userAgent.MAC){if(e.keyCode==goog.events.KeyCodes.MAC_FF_META){this.metaKeyRecentlyReleased_=!0;goog.Timer.callOnce(function(){this.metaKeyRecentlyReleased_=!1},400,this);return}var metaKey=e.metaKey||this.metaKeyRecentlyReleased_;if((e.keyCode==goog.events.KeyCodes.C||e.keyCode==goog.events.KeyCodes.X||e.keyCode==goog.events.KeyCodes.V)&&metaKey){e.metaKey=metaKey;this.handleKeyDown_(e)}}if(goog.events.KeyCodes.SPACE==this.activeShortcutKeyForGecko_&&goog.events.KeyCodes.SPACE==e.keyCode){e.preventDefault()}this.activeShortcutKeyForGecko_=null};goog.ui.KeyboardShortcutHandler.prototype.isPossiblePrintableKey_=function(e){return goog.userAgent.WINDOWS&&e.ctrlKey&&e.altKey};goog.ui.KeyboardShortcutHandler.prototype.handleWindowsKeyPress_=function(e){if(32<e.keyCode&&this.isPossiblePrintableKey_(e)){this.isPrintableKey_=!0}};goog.ui.KeyboardShortcutHandler.prototype.handleWindowsKeyUp_=function(e){if(!this.isPrintableKey_&&this.isPossiblePrintableKey_(e)){this.handleKeyDown_(e)}};goog.ui.KeyboardShortcutHandler.prototype.clearKeyListener=function(){goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYDOWN,this.handleKeyDown_,!1,this);if(goog.userAgent.WINDOWS){goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYPRESS,this.handleWindowsKeyPress_,!1,this)}goog.events.unlisten(this.keyTarget_,goog.events.EventType.KEYUP,this.handleKeyUp_,!1,this);this.keyTarget_=null};goog.ui.KeyboardShortcutHandler.setShortcut_=function(tree,strokes,identifier){var stroke=strokes.shift(),node=tree[stroke];if(node&&(0==strokes.length||node.shortcut)){throw Error("Keyboard shortcut conflicts with existing shortcut")}if(strokes.length){node=goog.object.setIfUndefined(tree,stroke.toString(),goog.ui.KeyboardShortcutHandler.createInternalNode_());goog.ui.KeyboardShortcutHandler.setShortcut_(goog.asserts.assert(node.next,"An internal node must have a next map"),strokes,identifier)}else{tree[stroke]=goog.ui.KeyboardShortcutHandler.createTerminalNode_(identifier)}};goog.ui.KeyboardShortcutHandler.unsetShortcut_=function(tree,strokes){var stroke=strokes.shift(),node=tree[stroke];if(!node){return}if(0==strokes.length){if(!node.shortcut){return}delete tree[stroke]}else{if(!node.next){return}goog.ui.KeyboardShortcutHandler.unsetShortcut_(node.next,strokes);if(goog.object.isEmpty(node.next)){delete tree[stroke]}}};goog.ui.KeyboardShortcutHandler.prototype.checkShortcut_=function(strokes){var tree=this.shortcuts_;while(0<strokes.length&&tree){var node=tree[strokes.shift()];if(!node){return!1}if(0==strokes.length&&node.shortcut){return!0}tree=node.next}return!1};goog.ui.KeyboardShortcutHandler.makeStroke_=function(keyCode,modifiers){return 255&keyCode|modifiers<<8};goog.ui.KeyboardShortcutHandler.prototype.handleKeyDown_=function(event){if(!this.isValidShortcut_(event)){return}var keyCode=goog.events.KeyCodes.normalizeKeyCode(event.keyCode),modifiers=(event.shiftKey?goog.ui.KeyboardShortcutHandler.Modifiers.SHIFT:0)|(event.ctrlKey?goog.ui.KeyboardShortcutHandler.Modifiers.CTRL:0)|(event.altKey?goog.ui.KeyboardShortcutHandler.Modifiers.ALT:0)|(event.metaKey?goog.ui.KeyboardShortcutHandler.Modifiers.META:0),stroke=goog.ui.KeyboardShortcutHandler.makeStroke_(keyCode,modifiers);if(!this.currentTree_[stroke]||this.hasSequenceTimedOut_()){this.setCurrentTree_(this.shortcuts_)}var node=this.currentTree_[stroke];if(node&&node.next){this.setCurrentTree_(node.next)}if("keydown"==event.type&&this.isPossiblePrintableKey_(event)){this.isPrintableKey_=!1;return}else if(!node){return}else if(node.next){event.preventDefault();return}this.setCurrentTree_(this.shortcuts_);if(this.alwaysPreventDefault_){event.preventDefault()}if(this.alwaysStopPropagation_){event.stopPropagation()}var shortcut=goog.asserts.assertString(node.shortcut,"A terminal node must have a string shortcut identifier."),target=event.target,triggerEvent=new goog.ui.KeyboardShortcutEvent(goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_TRIGGERED,shortcut,target),retVal=this.dispatchEvent(triggerEvent),prefixEvent=new goog.ui.KeyboardShortcutEvent(goog.ui.KeyboardShortcutHandler.EventType.SHORTCUT_PREFIX+shortcut,shortcut,target);retVal&=this.dispatchEvent(prefixEvent);if(!retVal){event.preventDefault()}if(goog.userAgent.GECKO){this.activeShortcutKeyForGecko_=keyCode}};goog.ui.KeyboardShortcutHandler.prototype.isValidShortcut_=function(event){var keyCode=event.keyCode;if(keyCode==goog.events.KeyCodes.SHIFT||keyCode==goog.events.KeyCodes.CTRL||keyCode==goog.events.KeyCodes.ALT){return!1}var el=event.target,isFormElement=el.tagName==goog.dom.TagName.TEXTAREA||el.tagName==goog.dom.TagName.INPUT||el.tagName==goog.dom.TagName.BUTTON||el.tagName==goog.dom.TagName.SELECT,isContentEditable=!isFormElement&&(el.isContentEditable||el.ownerDocument&&"on"==el.ownerDocument.designMode);if(!isFormElement&&!isContentEditable){return!0}if(this.globalKeys_[keyCode]||this.allShortcutsAreGlobal_){return!0}if(isContentEditable){return!1}if(this.modifierShortcutsAreGlobal_&&(event.altKey||event.ctrlKey||event.metaKey)){return!0}if(el.tagName==goog.dom.TagName.INPUT&&this.textInputs_[el.type]){return keyCode==goog.events.KeyCodes.ENTER}if(el.tagName==goog.dom.TagName.INPUT||el.tagName==goog.dom.TagName.BUTTON){if(this.allowSpaceKeyOnButtons_){return!0}else{return keyCode!=goog.events.KeyCodes.SPACE}}return!1};goog.ui.KeyboardShortcutHandler.prototype.hasSequenceTimedOut_=function(){return goog.now()-this.lastStrokeTime_>=goog.ui.KeyboardShortcutHandler.MAX_KEY_SEQUENCE_DELAY};goog.ui.KeyboardShortcutHandler.prototype.setCurrentTree_=function(tree){this.currentTree_=tree;this.lastStrokeTime_=goog.now()};goog.ui.KeyboardShortcutEvent=function(type,identifier,target){goog.events.Event.call(this,type,target);this.identifier=identifier};goog.inherits(goog.ui.KeyboardShortcutEvent,goog.events.Event);