goog.provide("goog.html.safeUrlTest");goog.require("goog.html.SafeUrl");goog.require("goog.i18n.bidi.Dir");goog.require("goog.object");goog.require("goog.string.Const");goog.require("goog.testing.jsunit");goog.require("goog.userAgent");goog.setTestOnly("goog.html.safeUrlTest");function testSafeUrl(){var safeUrl=goog.html.SafeUrl.fromConstant(goog.string.Const.from("javascript:trusted();")),extracted=goog.html.SafeUrl.unwrap(safeUrl);assertEquals("javascript:trusted();",extracted);assertEquals("javascript:trusted();",goog.html.SafeUrl.unwrap(safeUrl));assertEquals("SafeUrl{javascript:trusted();}",safeUrl+"");assertEquals(goog.i18n.bidi.Dir.LTR,safeUrl.getDirection());assertTrue(safeUrl.implementsGoogStringTypedString);assertTrue(safeUrl.implementsGoogI18nBidiDirectionalString)}function testSafeUrlFromBlob_withSafeType(){if(isIE9OrLower()){return}assertBlobTypeIsSafe("image/png",!0);assertBlobTypeIsSafe("iMage/pNg",!0);assertBlobTypeIsSafe("video/mpeg",!0);assertBlobTypeIsSafe("video/ogg",!0);assertBlobTypeIsSafe("video/mp4",!0);assertBlobTypeIsSafe("video/ogg",!0);assertBlobTypeIsSafe("video/webm",!0)}function testSafeUrlFromBlob_withUnsafeType(){if(isIE9OrLower()){return}assertBlobTypeIsSafe("",!1);assertBlobTypeIsSafe("ximage/png",!1);assertBlobTypeIsSafe("image/pngx",!1);assertBlobTypeIsSafe("video/whatever",!1);assertBlobTypeIsSafe("video/",!1)}function isIE9OrLower(){return goog.userAgent.IE&&!goog.userAgent.isVersionOrHigher("10")}function assertBlobTypeIsSafe(type,isSafe){var safeUrl=goog.html.SafeUrl.fromBlob(new Blob(["test"],{type:type})),extracted=goog.html.SafeUrl.unwrap(safeUrl);if(isSafe){assertEquals("blob:",extracted.substring(0,5))}else{assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,extracted)}}function testSafeUrlFromDataUrl_withSafeType(){assertDataUrlIsSafe("data:image/png;base64,"+"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=",!0);assertDataUrlIsSafe("dATa:iMage/pNg;bASe64,abc===",!0);assertDataUrlIsSafe("data:image/webp;base64,abc===",!0);assertDataUrlIsSafe("data:video/mpeg;base64,abc",!0);assertDataUrlIsSafe("data:video/ogg;base64,z=",!0);assertDataUrlIsSafe("data:video/mp4;base64,z=",!0);assertDataUrlIsSafe("data:video/ogg;base64,z=",!0);assertDataUrlIsSafe("data:video/webm;base64,z=",!0)}function testSafeUrlFromDataUrl_withUnsafeType(){assertDataUrlIsSafe("",!1);assertDataUrlIsSafe(":",!1);assertDataUrlIsSafe("data:",!1);assertDataUrlIsSafe("not-data:image/png;base64,z=",!1);assertDataUrlIsSafe(" data:image/png;base64,z=",!1);assertDataUrlIsSafe("data:image/png;base64,z= ",!1);assertDataUrlIsSafe("data:ximage/png",!1);assertDataUrlIsSafe("data:ximage/png;base64,z=",!1);assertDataUrlIsSafe("data:image/pngx;base64,z=",!1);assertDataUrlIsSafe("data:video/whatever;base64,z=",!1);assertDataUrlIsSafe("data:video/;base64,z=",!1);assertDataUrlIsSafe("data:image/png;base64,",!1);assertDataUrlIsSafe("data:image/png;base64,abc=!",!1);assertDataUrlIsSafe("data:image/png;base64,$$",!1);assertDataUrlIsSafe("data:image/png;base64,\0",!1);assertDataUrlIsSafe("data:video/mp4;baze64,z=",!1);assertDataUrlIsSafe("data:video/mp4;,z=",!1);assertDataUrlIsSafe("data:text/html,sdfsdfsdfsfsdfs;base64,anything",!1)}function assertDataUrlIsSafe(url,isSafe){var safeUrl=goog.html.SafeUrl.fromDataUrl(url);assertEquals(isSafe?url:goog.html.SafeUrl.INNOCUOUS_STRING,goog.html.SafeUrl.unwrap(safeUrl))}function testSafeUrlFromTelUrl_withSafeType(){assertTelUrlIsSafe("tEl:+1(23)129-29192A.ABC#;eXt=29",!0);assertTelUrlIsSafe("tEL:123;randmomparam=123",!0)}function testSafeUrlFromTelUrl_withUnsafeType(){assertTelUrlIsSafe("",!1);assertTelUrlIsSafe(":",!1);assertTelUrlIsSafe("tell:",!1);assertTelUrlIsSafe("not-tel:+1",!1);assertTelUrlIsSafe(" tel:+1",!1)}function assertTelUrlIsSafe(url,isSafe){var safeUrl=goog.html.SafeUrl.fromTelUrl(url);assertEquals(isSafe?url:goog.html.SafeUrl.INNOCUOUS_STRING,goog.html.SafeUrl.unwrap(safeUrl))}function testUnwrap(){var privateFieldName="privateDoNotAccessOrElseSafeHtmlWrappedValue_",markerFieldName="SAFE_URL_TYPE_MARKER_GOOG_HTML_SECURITY_PRIVATE_",propNames=goog.object.getKeys(goog.html.SafeUrl.sanitize(""));assertContains(privateFieldName,propNames);assertContains(markerFieldName,propNames);var evil={};evil[privateFieldName]="javascript:evil()";evil[markerFieldName]={};var exception=assertThrows(function(){goog.html.SafeUrl.unwrap(evil)});assertContains("expected object of type SafeUrl",exception.message)}function assertGoodUrl(url){var expected=url;if(url.implementsGoogStringTypedString){expected=url.getTypedStringValue()}var safeUrl=goog.html.SafeUrl.sanitize(url),extracted=goog.html.SafeUrl.unwrap(safeUrl);assertEquals(expected,extracted)}function assertBadUrl(url){assertEquals(goog.html.SafeUrl.INNOCUOUS_STRING,goog.html.SafeUrl.unwrap(goog.html.SafeUrl.sanitize(url)))}function testSafeUrlSanitize_validatesUrl(){assertGoodUrl("http://example.com/");assertGoodUrl("https://example.com");assertGoodUrl("mailto:foo@example.com");assertGoodUrl("ftp://example.com");assertGoodUrl("ftp://username@example.com");assertGoodUrl("ftp://username:password@example.com");assertGoodUrl("HTtp://example.com/");assertGoodUrl("https://example.com/path?foo=bar#baz");assertGoodUrl("//example.com/path");assertGoodUrl("/path");assertGoodUrl("/path?foo=bar#baz");assertGoodUrl("path");assertGoodUrl("path?foo=bar#baz");assertGoodUrl("p//ath");assertGoodUrl("p//ath?foo=bar#baz");assertGoodUrl("#baz");assertGoodUrl("/&");assertGoodUrl("?:");assertGoodUrl(goog.string.Const.from("http://example.com/"));assertBadUrl("javascript:evil();");assertBadUrl("javascript:evil();//\nhttp://good.com/");assertBadUrl("data:blah");assertBadUrl("&");assertBadUrl(":");assertBadUrl("\\:");assertBadUrl(":/:");assertBadUrl("path\n:");assertBadUrl(goog.string.Const.from("data:blah"))}function testSafeUrlSanitize_idempotentForSafeUrlArgument(){var safeUrl=goog.html.SafeUrl.sanitize("https://www.google.com/"),safeUrl2=goog.html.SafeUrl.sanitize(safeUrl);assertEquals(goog.html.SafeUrl.unwrap(safeUrl),goog.html.SafeUrl.unwrap(safeUrl2));safeUrl=goog.html.SafeUrl.sanitize("disallowed:foo");safeUrl2=goog.html.SafeUrl.sanitize(safeUrl);assertEquals(goog.html.SafeUrl.unwrap(safeUrl),goog.html.SafeUrl.unwrap(safeUrl2))}