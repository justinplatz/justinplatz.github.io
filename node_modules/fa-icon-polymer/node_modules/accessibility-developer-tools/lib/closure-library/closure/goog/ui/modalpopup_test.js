goog.provide("goog.ui.ModalPopupTest");goog.setTestOnly("goog.ui.ModalPopupTest");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.State");goog.require("goog.dispose");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.EventTarget");goog.require("goog.events.EventType");goog.require("goog.fx.Transition");goog.require("goog.fx.css3");goog.require("goog.string");goog.require("goog.style");goog.require("goog.testing.MockClock");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.ui.ModalPopup");goog.require("goog.ui.PopupBase");var popup,main,mockClock;function setUp(){main=goog.dom.getElement("main");mockClock=new goog.testing.MockClock(!0)}function tearDown(){goog.dispose(popup);mockClock.dispose();goog.a11y.aria.removeState(main,goog.a11y.aria.State.HIDDEN)}function testOrientationChange(){var i=0;popup=new goog.ui.ModalPopup;popup.resizeBackgroundTask_=function(){i++};popup.render();popup.setVisible(!0);var event=new goog.events.Event(goog.events.EventType.ORIENTATIONCHANGE,popup.getDomHelper().getWindow());goog.testing.events.fireBrowserEvent(event);assertEquals(1,i);goog.testing.events.fireBrowserEvent(event);assertEquals(2,i);popup.setVisible(!1);goog.testing.events.fireBrowserEvent(event);assertEquals(2,i)}function testDispose(){popup=new goog.ui.ModalPopup;popup.render();goog.dispose(popup);assertNull(goog.dom.getElementByClass("goog-modalpopup-bg"));assertNull(goog.dom.getElementByClass("goog-modalpopup"));assertEquals(0,goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.SPAN).length)}function testRenderWithoutIframeMask(){popup=new goog.ui.ModalPopup;popup.render();assertEquals(0,goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME,"goog-modalpopup-bg").length);var bg=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.DIV,"goog-modalpopup-bg");assertEquals(1,bg.length);var content=goog.dom.getElementByClass("goog-modalpopup");assertNotNull(content);var tabCatcher=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.SPAN);assertEquals(1,tabCatcher.length);assertTrue(0>goog.dom.compareNodeOrder(bg[0],content));assertTrue(0>goog.dom.compareNodeOrder(content,tabCatcher[0]));assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN))));popup.setVisible(!0);assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(popup.getElementStrict(),goog.a11y.aria.State.HIDDEN))));assertEquals("true",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN));popup.setVisible(!1);assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN))))}function testRenderWithIframeMask(){popup=new goog.ui.ModalPopup(!0);popup.render();var iframe=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME,"goog-modalpopup-bg");assertEquals(1,iframe.length);var bg=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.DIV,"goog-modalpopup-bg");assertEquals(1,bg.length);var content=goog.dom.getElementByClass("goog-modalpopup");assertNotNull(content);var tabCatcher=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.SPAN);assertEquals(1,tabCatcher.length);assertTrue(0>goog.dom.compareNodeOrder(iframe[0],bg[0]));assertTrue(0>goog.dom.compareNodeOrder(bg[0],content));assertTrue(0>goog.dom.compareNodeOrder(content,tabCatcher[0]));assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN))));popup.setVisible(!0);assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(popup.getElementStrict(),goog.a11y.aria.State.HIDDEN))));assertEquals("true",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN));popup.setVisible(!1);assertTrue(goog.string.isEmptyOrWhitespace(goog.string.makeSafe(goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN))))}function testRenderWithAriaState(){popup=new goog.ui.ModalPopup;popup.render();goog.a11y.aria.setState(main,goog.a11y.aria.State.HIDDEN,!0);popup.setVisible(!0);assertEquals("true",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN));popup.setVisible(!1);assertEquals("true",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN));goog.a11y.aria.setState(main,goog.a11y.aria.State.HIDDEN,!1);popup.setVisible(!0);assertEquals("false",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN));popup.setVisible(!1);assertEquals("false",goog.a11y.aria.getState(main,goog.a11y.aria.State.HIDDEN))}function testRenderDoesNotShowAnyElement(){popup=new goog.ui.ModalPopup(!0);popup.render();var iframe=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME,"goog-modalpopup-bg");assertFalse(goog.style.isElementShown(iframe[0]));var bg=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.DIV,"goog-modalpopup-bg");assertFalse(goog.style.isElementShown(bg[0]));assertFalse(goog.style.isElementShown(goog.dom.getElementByClass("goog-modalpopup")));var tabCatcher=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.SPAN);assertFalse(goog.style.isElementShown(tabCatcher[0]))}function testIframeOpacityIsSetToZero(){popup=new goog.ui.ModalPopup(!0);popup.render();var iframe=goog.dom.getElementsByTagNameAndClass(goog.dom.TagName.IFRAME,"goog-modalpopup-bg")[0];assertEquals(0,goog.style.getOpacity(iframe))}function testEventFiredOnShow(){popup=new goog.ui.ModalPopup(!0);popup.render();var beforeShowCallCount=0,beforeShowHandler=function(){beforeShowCallCount++},showCallCount=!1,showHandler=function(){assertEquals("BEFORE_SHOW is not dispatched before SHOW",1,beforeShowCallCount);showCallCount++};goog.events.listen(popup,goog.ui.PopupBase.EventType.BEFORE_SHOW,beforeShowHandler);goog.events.listen(popup,goog.ui.PopupBase.EventType.SHOW,showHandler);popup.setVisible(!0);assertEquals(1,beforeShowCallCount);assertEquals(1,showCallCount)}function testEventFiredOnHide(){popup=new goog.ui.ModalPopup(!0);popup.render();popup.setVisible(!0);var beforeHideCallCount=0,beforeHideHandler=function(){beforeHideCallCount++},hideCallCount=!1,hideHandler=function(){assertEquals("BEFORE_HIDE is not dispatched before HIDE",1,beforeHideCallCount);hideCallCount++};goog.events.listen(popup,goog.ui.PopupBase.EventType.BEFORE_HIDE,beforeHideHandler);goog.events.listen(popup,goog.ui.PopupBase.EventType.HIDE,hideHandler);popup.setVisible(!1);assertEquals(1,beforeHideCallCount);assertEquals(1,hideCallCount)}function testShowEventFiredWithNoTransition(){popup=new goog.ui.ModalPopup;popup.render();var showHandlerCalled=!1;goog.events.listen(popup,goog.ui.PopupBase.EventType.SHOW,function(){showHandlerCalled=!0});popup.setVisible(!0);assertTrue(showHandlerCalled)}function testHideEventFiredWithNoTransition(){popup=new goog.ui.ModalPopup;popup.render();var hideHandlerCalled=!1;goog.events.listen(popup,goog.ui.PopupBase.EventType.HIDE,function(){hideHandlerCalled=!0});popup.setVisible(!0);popup.setVisible(!1);assertTrue(hideHandlerCalled)}function testTransitionsPlayedOnShow(){popup=new goog.ui.ModalPopup;popup.render();var mockPopupShowTransition=new MockTransition,mockPopupHideTransition=new MockTransition,mockBgShowTransition=new MockTransition,mockBgHideTransition=new MockTransition,showHandlerCalled=!1;goog.events.listen(popup,goog.ui.PopupBase.EventType.SHOW,function(){showHandlerCalled=!0});popup.setTransition(mockPopupShowTransition,mockPopupHideTransition,mockBgShowTransition,mockBgHideTransition);assertFalse(mockPopupShowTransition.wasPlayed);assertFalse(mockBgShowTransition.wasPlayed);popup.setVisible(!0);assertTrue(mockPopupShowTransition.wasPlayed);assertTrue(mockBgShowTransition.wasPlayed);assertFalse(showHandlerCalled);mockPopupShowTransition.dispatchEvent(goog.fx.Transition.EventType.END);assertTrue(showHandlerCalled)}function testTransitionsPlayedOnHide(){popup=new goog.ui.ModalPopup;popup.render();var mockPopupShowTransition=new MockTransition,mockPopupHideTransition=new MockTransition,mockBgShowTransition=new MockTransition,mockBgHideTransition=new MockTransition,hideHandlerCalled=!1;goog.events.listen(popup,goog.ui.PopupBase.EventType.HIDE,function(){hideHandlerCalled=!0});popup.setTransition(mockPopupShowTransition,mockPopupHideTransition,mockBgShowTransition,mockBgHideTransition);popup.setVisible(!0);assertFalse(mockPopupHideTransition.wasPlayed);assertFalse(mockBgHideTransition.wasPlayed);popup.setVisible(!1);assertTrue(mockPopupHideTransition.wasPlayed);assertTrue(mockBgHideTransition.wasPlayed);assertFalse(hideHandlerCalled);mockPopupHideTransition.dispatchEvent(goog.fx.Transition.EventType.END);assertTrue(hideHandlerCalled)}function testTransitionsAndDisposingOnHideWorks(){popup=new goog.ui.ModalPopup;popup.render();goog.events.listen(popup,goog.ui.PopupBase.EventType.HIDE,function(){popup.dispose()});var popupShowTransition=goog.fx.css3.fadeIn(popup.getElement(),.1),popupHideTransition=goog.fx.css3.fadeOut(popup.getElement(),.1),bgShowTransition=goog.fx.css3.fadeIn(popup.getElement(),.1),bgHideTransition=goog.fx.css3.fadeOut(popup.getElement(),.1);popup.setTransition(popupShowTransition,popupHideTransition,bgShowTransition,bgHideTransition);popup.setVisible(!0);popup.setVisible(!1)}function testSetVisibleWorksCorrectlyWithTransitions(){popup=new goog.ui.ModalPopup;popup.render();popup.setTransition(goog.fx.css3.fadeIn(popup.getElement(),1),goog.fx.css3.fadeIn(popup.getBackgroundElement(),1),goog.fx.css3.fadeOut(popup.getElement(),1),goog.fx.css3.fadeOut(popup.getBackgroundElement(),1));popup.setVisible(!0);assertTrue(popup.isVisible());popup.setVisible(!1);assertFalse(popup.isVisible());mockClock.tick(1100);popup.setVisible(!0);assertTrue(popup.isVisible());mockClock.tick(1100);popup.setVisible(!1);popup.setVisible(!0);assertTrue(popup.isVisible());mockClock.tick(1100);popup.setVisible(!1);assertFalse(popup.isVisible());mockClock.tick(1100)}function testTransitionsDisposed(){popup=new goog.ui.ModalPopup;popup.render();var transition=goog.fx.css3.fadeIn(popup.getElement(),.1),hideHandlerCalled=!1;goog.events.listen(popup,goog.ui.PopupBase.EventType.HIDE,function(){hideHandlerCalled=!0});popup.setTransition(transition,transition,transition,transition);popup.dispose();transition.dispatchEvent(goog.fx.Transition.EventType.END);assertFalse(hideHandlerCalled)}function testBackgroundHeight(){var viewportSize=goog.dom.getViewportSize(),w=2*viewportSize.width,h=2*viewportSize.height,dummy=goog.dom.createElement(goog.dom.TagName.DIV);dummy.style.position="absolute";goog.style.setSize(dummy,w,h);document.body.appendChild(dummy);try{popup=new goog.ui.ModalPopup;popup.render();popup.setVisible(!0);var size=goog.style.getSize(popup.getBackgroundElement());assertTrue("Background element must cover the size of the content",size.width>=w&&size.height>=h)}finally{goog.dom.removeNode(dummy)}}function testSetupBackwardTabWrapResetsFlagAfterTimeout(){popup.setupBackwardTabWrap();assertTrue("Backward tab wrap should be in progress",popup.backwardTabWrapInProgress_);mockClock.tick(1);assertFalse("Backward tab wrap flag should be reset after delay",popup.backwardTabWrapInProgress_)}function testPopupGetsFocus(){popup=new goog.ui.ModalPopup;popup.render();popup.setVisible(!0);assertTrue("Dialog must receive initial focus",goog.dom.getActiveElement(document)==popup.getElement())}function testDecoratedPopupGetsFocus(){var dialogElem=goog.dom.createElement(goog.dom.TagName.DIV);document.body.appendChild(dialogElem);popup=new goog.ui.ModalPopup;popup.decorate(dialogElem);popup.setVisible(!0);assertTrue("Dialog must receive initial focus",goog.dom.getActiveElement(document)==popup.getElement());goog.dom.removeNode(dialogElem)}var MockTransition=function(){MockTransition.base(this,"constructor");this.wasPlayed=!1};goog.inherits(MockTransition,goog.events.EventTarget);MockTransition.prototype.play=function(){this.wasPlayed=!0};MockTransition.prototype.stop=goog.nullFunction;