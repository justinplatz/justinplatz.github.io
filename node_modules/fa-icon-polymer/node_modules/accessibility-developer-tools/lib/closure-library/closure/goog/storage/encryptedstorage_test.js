goog.provide("goog.storage.EncryptedStorageTest");goog.setTestOnly("goog.storage.EncryptedStorageTest");goog.require("goog.json");goog.require("goog.storage.EncryptedStorage");goog.require("goog.storage.ErrorCode");goog.require("goog.storage.RichStorage");goog.require("goog.storage.collectableStorageTester");goog.require("goog.storage.storage_test");goog.require("goog.testing.MockClock");goog.require("goog.testing.PseudoRandom");goog.require("goog.testing.jsunit");goog.require("goog.testing.storage.FakeMechanism");function getEncryptedWrapper(storage,key){return goog.json.parse(storage.mechanism.get(storage.hashKeyWithSecret_(key)))}function getEncryptedData(storage,key){return getEncryptedWrapper(storage,key)[goog.storage.RichStorage.DATA_KEY]}function decryptWrapper(storage,key,wrapper){return goog.json.parse(storage.decryptValue_(wrapper[goog.storage.EncryptedStorage.SALT_KEY],key,wrapper[goog.storage.RichStorage.DATA_KEY]))}function hammingDistance(a,b){if(a.length!=b.length){throw Error("Lengths must be the same for Hamming distance")}for(var distance=0,i=0;i<a.length;++i){if(a.charAt(i)!=b.charAt(i)){++distance}}return distance}function testBasicOperations(){var mechanism=new goog.testing.storage.FakeMechanism,storage=new goog.storage.EncryptedStorage(mechanism,"secret");goog.storage.storage_test.runBasicTests(storage)}function testExpiredKeyCollection(){var mechanism=new goog.testing.storage.FakeMechanism,clock=new goog.testing.MockClock(!0),storage=new goog.storage.EncryptedStorage(mechanism,"secret");goog.storage.collectableStorageTester.runBasicTests(mechanism,clock,storage)}function testEncryption(){var mechanism=new goog.testing.storage.FakeMechanism,clock=new goog.testing.MockClock(!0),storage=new goog.storage.EncryptedStorage(mechanism,"secret"),mallory=new goog.storage.EncryptedStorage(mechanism,"guess");storage.set("first","Hello world!");storage.set("second",["one","two","three"],1e3);storage.set("third",{a:97,b:98});assertNull(mechanism.get("first"));assertNull(mechanism.get("second"));assertNull(mechanism.get("third"));assertUndefined(mallory.get("first"));assertUndefined(mallory.get("second"));assertUndefined(mallory.get("third"));mallory.set("first","Ho ho ho!");assertObjectEquals("Ho ho ho!",mallory.get("first"));assertObjectEquals("Hello world!",storage.get("first"));mallory.remove("first");assertObjectEquals("Hello world!",storage.get("first"));assertObjectEquals(["one","two","three"],storage.get("second"));assertObjectEquals({a:97,b:98},storage.get("third"));var encryptedWrapper=getEncryptedWrapper(storage,"first");assertObjectEquals("Hello world!",decryptWrapper(storage,"first",encryptedWrapper));assertThrows(function(){decryptWrapper(mallory,"first",encryptedWrapper)});encryptedWrapper[goog.storage.RichStorage.DATA_KEY]="kaboom";mechanism.set(storage.hashKeyWithSecret_("first"),goog.json.serialize(encryptedWrapper));assertEquals(goog.storage.ErrorCode.DECRYPTION_ERROR,assertThrows(function(){storage.get("first")}));storage.collect();assertNotNull(getEncryptedWrapper(storage,"first"));assertObjectEquals(["one","two","three"],storage.get("second"));assertObjectEquals({a:97,b:98},storage.get("third"));clock.tick(2e3);storage.collect();assertNotNull(getEncryptedWrapper(storage,"first"));assertUndefined(storage.get("second"));assertObjectEquals({a:97,b:98},storage.get("third"));mechanism.set(storage.hashKeyWithSecret_("first"),"\"kaboom\"");storage.collect();assertNotNull(getEncryptedWrapper(storage,"first"));assertObjectEquals({a:97,b:98},storage.get("third"));storage.collect(!0);assertUndefined(storage.get("first"));assertObjectEquals({a:97,b:98},storage.get("third"));storage.remove("third");assertUndefined(storage.get("third"));clock.uninstall()}function testSalting(){var mechanism=new goog.testing.storage.FakeMechanism,randomMock=new goog.testing.PseudoRandom(0,!0),storage=new goog.storage.EncryptedStorage(mechanism,"secret");storage.set("one","Hello world!");randomMock.seed(0);storage.set("two","Hello world!");var golden=getEncryptedData(storage,"one");assertRoughlyEquals("Ciphertext did not change with keys",golden.length,hammingDistance(golden,getEncryptedData(storage,"two")),2);storage.set("one","Hello world!");assertRoughlyEquals("Salting seems to have failed",golden.length,hammingDistance(golden,getEncryptedData(storage,"one")),2);storage.remove("1");storage.remove("2");randomMock.uninstall()}