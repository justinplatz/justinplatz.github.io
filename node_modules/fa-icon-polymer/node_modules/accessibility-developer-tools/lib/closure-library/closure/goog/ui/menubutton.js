goog.provide("goog.ui.MenuButton");goog.require("goog.Timer");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.State");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyHandler");goog.require("goog.math.Box");goog.require("goog.math.Rect");goog.require("goog.positioning");goog.require("goog.positioning.Corner");goog.require("goog.positioning.MenuAnchoredPosition");goog.require("goog.positioning.Overflow");goog.require("goog.style");goog.require("goog.ui.Button");goog.require("goog.ui.Component");goog.require("goog.ui.IdGenerator");goog.require("goog.ui.Menu");goog.require("goog.ui.MenuButtonRenderer");goog.require("goog.ui.MenuItem");goog.require("goog.ui.MenuRenderer");goog.require("goog.ui.registry");goog.require("goog.userAgent");goog.require("goog.userAgent.product");goog.ui.MenuButton=function(opt_content,opt_menu,opt_renderer,opt_domHelper,opt_menuRenderer){goog.ui.Button.call(this,opt_content,opt_renderer||goog.ui.MenuButtonRenderer.getInstance(),opt_domHelper);this.setSupportedState(goog.ui.Component.State.OPENED,!0);this.menuPosition_=new goog.positioning.MenuAnchoredPosition(null,goog.positioning.Corner.BOTTOM_START);if(opt_menu){this.setMenu(opt_menu)}this.menuMargin_=null;this.timer_=new goog.Timer(500);if((goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD)&&!goog.userAgent.isVersionOrHigher("533.17.9")){this.setFocusablePopupMenu(!0)}this.menuRenderer_=opt_menuRenderer||goog.ui.MenuRenderer.getInstance()};goog.inherits(goog.ui.MenuButton,goog.ui.Button);goog.tagUnsealableClass(goog.ui.MenuButton);goog.ui.MenuButton.prototype.menu_;goog.ui.MenuButton.prototype.positionElement_;goog.ui.MenuButton.prototype.menuMargin_;goog.ui.MenuButton.prototype.isFocusablePopupMenu_=!1;goog.ui.MenuButton.prototype.timer_;goog.ui.MenuButton.prototype.buttonRect_;goog.ui.MenuButton.prototype.viewportBox_;goog.ui.MenuButton.prototype.originalSize_;goog.ui.MenuButton.prototype.renderMenuAsSibling_=!1;goog.ui.MenuButton.prototype.selectFirstOnEnterOrSpace_=!1;goog.ui.MenuButton.prototype.enterDocument=function(){goog.ui.MenuButton.superClass_.enterDocument.call(this);this.attachKeyDownEventListener_(!0);if(this.menu_){this.attachMenuEventListeners_(this.menu_,!0)}goog.a11y.aria.setState(this.getElementStrict(),goog.a11y.aria.State.HASPOPUP,!!this.menu_)};goog.ui.MenuButton.prototype.exitDocument=function(){goog.ui.MenuButton.superClass_.exitDocument.call(this);this.attachKeyDownEventListener_(!1);if(this.menu_){this.setOpen(!1);this.menu_.exitDocument();this.attachMenuEventListeners_(this.menu_,!1);var menuElement=this.menu_.getElement();if(menuElement){goog.dom.removeNode(menuElement)}}};goog.ui.MenuButton.prototype.disposeInternal=function(){goog.ui.MenuButton.superClass_.disposeInternal.call(this);if(this.menu_){this.menu_.dispose();delete this.menu_}delete this.positionElement_;this.timer_.dispose()};goog.ui.MenuButton.prototype.handleMouseDown=function(e){goog.ui.MenuButton.superClass_.handleMouseDown.call(this,e);if(this.isActive()){this.setOpen(!this.isOpen(),e);if(this.menu_){this.menu_.setMouseButtonPressed(this.isOpen())}}};goog.ui.MenuButton.prototype.handleMouseUp=function(e){goog.ui.MenuButton.superClass_.handleMouseUp.call(this,e);if(this.menu_&&!this.isActive()){this.menu_.setMouseButtonPressed(!1)}};goog.ui.MenuButton.prototype.performActionInternal=function(e){this.setActive(!1);return!0};goog.ui.MenuButton.prototype.handleDocumentMouseDown=function(e){if(this.menu_&&this.menu_.isVisible()&&!this.containsElement(e.target)){this.setOpen(!1)}};goog.ui.MenuButton.prototype.containsElement=function(element){return element&&goog.dom.contains(this.getElement(),element)||this.menu_&&this.menu_.containsElement(element)||!1};goog.ui.MenuButton.prototype.handleKeyEventInternal=function(e){if(e.keyCode==goog.events.KeyCodes.SPACE){e.preventDefault();if(e.type!=goog.events.EventType.KEYUP){return!0}}else if(e.type!=goog.events.KeyHandler.EventType.KEY){return!1}if(this.menu_&&this.menu_.isVisible()){var isEnterOrSpace=e.keyCode==goog.events.KeyCodes.ENTER||e.keyCode==goog.events.KeyCodes.SPACE,handledByMenu=this.menu_.handleKeyEvent(e);if(e.keyCode==goog.events.KeyCodes.ESC||isEnterOrSpace){this.setOpen(!1);return!0}return handledByMenu}if(e.keyCode==goog.events.KeyCodes.DOWN||e.keyCode==goog.events.KeyCodes.UP||e.keyCode==goog.events.KeyCodes.SPACE||e.keyCode==goog.events.KeyCodes.ENTER){this.setOpen(!0,e);return!0}return!1};goog.ui.MenuButton.prototype.handleMenuAction=function(e){this.setOpen(!1)};goog.ui.MenuButton.prototype.handleMenuBlur=function(e){if(!this.isActive()){this.setOpen(!1)}};goog.ui.MenuButton.prototype.handleBlur=function(e){if(!this.isFocusablePopupMenu()){this.setOpen(!1)}goog.ui.MenuButton.superClass_.handleBlur.call(this,e)};goog.ui.MenuButton.prototype.getMenu=function(){if(!this.menu_){this.setMenu(new goog.ui.Menu(this.getDomHelper(),this.menuRenderer_))}return this.menu_||null};goog.ui.MenuButton.prototype.setMenu=function(menu){var oldMenu=this.menu_;if(menu!=oldMenu){if(oldMenu){this.setOpen(!1);if(this.isInDocument()){this.attachMenuEventListeners_(oldMenu,!1)}delete this.menu_}if(this.isInDocument()){goog.a11y.aria.setState(this.getElementStrict(),goog.a11y.aria.State.HASPOPUP,!!menu)}if(menu){this.menu_=menu;menu.setParent(this);menu.setVisible(!1);menu.setAllowAutoFocus(this.isFocusablePopupMenu());if(this.isInDocument()){this.attachMenuEventListeners_(menu,!0)}}}return oldMenu};goog.ui.MenuButton.prototype.setMenuPosition=function(position){if(position){this.menuPosition_=position;this.positionElement_=position.element}};goog.ui.MenuButton.prototype.setPositionElement=function(positionElement){this.positionElement_=positionElement;this.positionMenu()};goog.ui.MenuButton.prototype.setMenuMargin=function(margin){this.menuMargin_=margin};goog.ui.MenuButton.prototype.setSelectFirstOnEnterOrSpace=function(select){this.selectFirstOnEnterOrSpace_=select};goog.ui.MenuButton.prototype.addItem=function(item){this.getMenu().addChild(item,!0)};goog.ui.MenuButton.prototype.addItemAt=function(item,index){this.getMenu().addChildAt(item,index,!0)};goog.ui.MenuButton.prototype.removeItem=function(item){var child=this.getMenu().removeChild(item,!0);if(child){child.dispose()}};goog.ui.MenuButton.prototype.removeItemAt=function(index){var child=this.getMenu().removeChildAt(index,!0);if(child){child.dispose()}};goog.ui.MenuButton.prototype.getItemAt=function(index){return this.menu_?this.menu_.getChildAt(index):null};goog.ui.MenuButton.prototype.getItemCount=function(){return this.menu_?this.menu_.getChildCount():0};goog.ui.MenuButton.prototype.setVisible=function(visible,opt_force){var visibilityChanged=goog.ui.MenuButton.superClass_.setVisible.call(this,visible,opt_force);if(visibilityChanged&&!this.isVisible()){this.setOpen(!1)}return visibilityChanged};goog.ui.MenuButton.prototype.setEnabled=function(enable){goog.ui.MenuButton.superClass_.setEnabled.call(this,enable);if(!this.isEnabled()){this.setOpen(!1)}};goog.ui.MenuButton.prototype.isAlignMenuToStart=function(){var corner=this.menuPosition_.corner;return corner==goog.positioning.Corner.BOTTOM_START||corner==goog.positioning.Corner.TOP_START};goog.ui.MenuButton.prototype.setAlignMenuToStart=function(alignToStart){this.menuPosition_.corner=alignToStart?goog.positioning.Corner.BOTTOM_START:goog.positioning.Corner.BOTTOM_END};goog.ui.MenuButton.prototype.setScrollOnOverflow=function(scrollOnOverflow){if(this.menuPosition_.setLastResortOverflow){var overflowX=goog.positioning.Overflow.ADJUST_X,overflowY=scrollOnOverflow?goog.positioning.Overflow.RESIZE_HEIGHT:goog.positioning.Overflow.ADJUST_Y;this.menuPosition_.setLastResortOverflow(overflowX|overflowY)}};goog.ui.MenuButton.prototype.isScrollOnOverflow=function(){return this.menuPosition_.getLastResortOverflow&&!!(this.menuPosition_.getLastResortOverflow()&goog.positioning.Overflow.RESIZE_HEIGHT)};goog.ui.MenuButton.prototype.isFocusablePopupMenu=function(){return this.isFocusablePopupMenu_};goog.ui.MenuButton.prototype.setFocusablePopupMenu=function(focusable){this.isFocusablePopupMenu_=focusable};goog.ui.MenuButton.prototype.setRenderMenuAsSibling=function(renderMenuAsSibling){this.renderMenuAsSibling_=renderMenuAsSibling};goog.ui.MenuButton.prototype.showMenu=function(){this.setOpen(!0)};goog.ui.MenuButton.prototype.hideMenu=function(){this.setOpen(!1)};goog.ui.MenuButton.prototype.setOpen=function(open,opt_e){goog.ui.MenuButton.superClass_.setOpen.call(this,open);if(this.menu_&&this.hasState(goog.ui.Component.State.OPENED)==open){if(open){if(!this.menu_.isInDocument()){if(this.renderMenuAsSibling_){var nextElementSibling=goog.dom.getNextElementSibling(this.getElement());if(nextElementSibling){this.menu_.renderBefore(nextElementSibling)}else{this.menu_.render(this.getElement().parentNode)}}else{this.menu_.render()}}this.viewportBox_=goog.style.getVisibleRectForElement(this.getElement());this.buttonRect_=goog.style.getBounds(this.getElement());this.positionMenu();var isEnterOrSpace=!!opt_e&&(opt_e.keyCode==goog.events.KeyCodes.ENTER||opt_e.keyCode==goog.events.KeyCodes.SPACE),isUpOrDown=!!opt_e&&(opt_e.keyCode==goog.events.KeyCodes.DOWN||opt_e.keyCode==goog.events.KeyCodes.UP),focus=isUpOrDown||isEnterOrSpace&&this.selectFirstOnEnterOrSpace_;if(focus){this.menu_.highlightFirst()}else{this.menu_.setHighlightedIndex(-1)}}else{this.setActive(!1);this.menu_.setMouseButtonPressed(!1);var element=this.getElement();if(element){goog.a11y.aria.setState(element,goog.a11y.aria.State.ACTIVEDESCENDANT,"");goog.a11y.aria.setState(element,goog.a11y.aria.State.OWNS,"")}if(goog.isDefAndNotNull(this.originalSize_)){this.originalSize_=void 0;var elem=this.menu_.getElement();if(elem){goog.style.setSize(elem,"","")}}}this.menu_.setVisible(open,!1,opt_e);if(!this.isDisposed()){this.attachPopupListeners_(open)}}if(this.menu_&&this.menu_.getElement()){goog.a11y.aria.removeState(this.menu_.getElementStrict(),goog.a11y.aria.State.HIDDEN)}};goog.ui.MenuButton.prototype.invalidateMenuSize=function(){this.originalSize_=void 0};goog.ui.MenuButton.prototype.positionMenu=function(){if(!this.menu_.isInDocument()){return}var positionElement=this.positionElement_||this.getElement(),position=this.menuPosition_;this.menuPosition_.element=positionElement;var elem=this.menu_.getElement();if(!this.menu_.isVisible()){elem.style.visibility="hidden";goog.style.setElementShown(elem,!0)}if(!this.originalSize_&&this.isScrollOnOverflow()){this.originalSize_=goog.style.getSize(elem)}var popupCorner=goog.positioning.flipCornerVertical(position.corner);position.reposition(elem,popupCorner,this.menuMargin_,this.originalSize_);if(!this.menu_.isVisible()){goog.style.setElementShown(elem,!1);elem.style.visibility="visible"}};goog.ui.MenuButton.prototype.onTick_=function(e){var currentButtonRect=goog.style.getBounds(this.getElement()),currentViewport=goog.style.getVisibleRectForElement(this.getElement());if(!goog.math.Rect.equals(this.buttonRect_,currentButtonRect)||!goog.math.Box.equals(this.viewportBox_,currentViewport)){this.buttonRect_=currentButtonRect;this.viewportBox_=currentViewport;this.positionMenu()}};goog.ui.MenuButton.prototype.attachMenuEventListeners_=function(menu,attach){var handler=this.getHandler(),method=attach?handler.listen:handler.unlisten;method.call(handler,menu,goog.ui.Component.EventType.ACTION,this.handleMenuAction);method.call(handler,menu,goog.ui.Component.EventType.CLOSE,this.handleCloseItem);method.call(handler,menu,goog.ui.Component.EventType.HIGHLIGHT,this.handleHighlightItem);method.call(handler,menu,goog.ui.Component.EventType.UNHIGHLIGHT,this.handleUnHighlightItem)};goog.ui.MenuButton.prototype.attachKeyDownEventListener_=function(attach){var handler=this.getHandler(),method=attach?handler.listen:handler.unlisten;method.call(handler,this.getElement(),goog.events.EventType.KEYDOWN,this.handleKeyDownEvent_)};goog.ui.MenuButton.prototype.handleHighlightItem=function(e){var targetEl=e.target.getElement();if(targetEl){this.setAriaActiveDescendant_(targetEl)}};goog.ui.MenuButton.prototype.handleKeyDownEvent_=function(e){if(this.isSupportedState(goog.ui.Component.State.FOCUSED)&&this.getKeyEventTarget()&&this.menu_&&this.menu_.isVisible()){e.stopPropagation()}};goog.ui.MenuButton.prototype.handleUnHighlightItem=function(e){if(!this.menu_.getHighlighted()){var element=this.getElement();goog.asserts.assert(element,"The menu button DOM element cannot be null.");goog.a11y.aria.setState(element,goog.a11y.aria.State.ACTIVEDESCENDANT,"");goog.a11y.aria.setState(element,goog.a11y.aria.State.OWNS,"")}};goog.ui.MenuButton.prototype.handleCloseItem=function(e){if(this.isOpen()&&e.target instanceof goog.ui.MenuItem){var menuItem=e.target,menuItemEl=menuItem.getElement();if(menuItem.isVisible()&&menuItem.isHighlighted()&&null!=menuItemEl){this.setAriaActiveDescendant_(menuItemEl)}}};goog.ui.MenuButton.prototype.setAriaActiveDescendant_=function(targetEl){var element=this.getElement();goog.asserts.assert(element,"The menu button DOM element cannot be null.");var targetActiveDescendant=goog.a11y.aria.getActiveDescendant(targetEl),activeDescendant=targetActiveDescendant||targetEl;if(!activeDescendant.id){var idGenerator=goog.ui.IdGenerator.getInstance();activeDescendant.id=idGenerator.getNextUniqueId()}goog.a11y.aria.setActiveDescendant(element,activeDescendant);goog.a11y.aria.setState(element,goog.a11y.aria.State.OWNS,activeDescendant.id)};goog.ui.MenuButton.prototype.attachPopupListeners_=function(attach){var handler=this.getHandler(),method=attach?handler.listen:handler.unlisten;method.call(handler,this.getDomHelper().getDocument(),goog.events.EventType.MOUSEDOWN,this.handleDocumentMouseDown,!0);if(this.isFocusablePopupMenu()){method.call(handler,this.menu_,goog.ui.Component.EventType.BLUR,this.handleMenuBlur)}method.call(handler,this.timer_,goog.Timer.TICK,this.onTick_);if(attach){this.timer_.start()}else{this.timer_.stop()}};goog.ui.registry.setDecoratorByClassName(goog.ui.MenuButtonRenderer.CSS_CLASS,function(){return new goog.ui.MenuButton(null)});