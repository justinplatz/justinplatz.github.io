goog.provide("goog.ui.editor.LinkDialogTest");goog.setTestOnly("goog.ui.editor.LinkDialogTest");goog.require("goog.dom");goog.require("goog.dom.DomHelper");goog.require("goog.dom.TagName");goog.require("goog.editor.BrowserFeature");goog.require("goog.editor.Link");goog.require("goog.events");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.style");goog.require("goog.testing.MockControl");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.dom");goog.require("goog.testing.events");goog.require("goog.testing.events.Event");goog.require("goog.testing.jsunit");goog.require("goog.testing.mockmatchers");goog.require("goog.testing.mockmatchers.ArgumentMatcher");goog.require("goog.ui.editor.AbstractDialog");goog.require("goog.ui.editor.LinkDialog");goog.require("goog.ui.editor.messages");goog.require("goog.userAgent");var dialog,mockCtrl,mockLink,mockOkHandler,mockGetViewportSize,mockWindowOpen,isNew,anchorElem,stubs=new goog.testing.PropertyReplacer,ANCHOR_TEXT="anchor text",ANCHOR_URL="http://www.google.com/",ANCHOR_EMAIL="m@r.cos",ANCHOR_MAILTO="mailto:"+ANCHOR_EMAIL;function setUp(){anchorElem=goog.dom.createElement(goog.dom.TagName.A);goog.dom.appendChild(goog.dom.getDocument().body,anchorElem);mockCtrl=new goog.testing.MockControl;mockLink=mockCtrl.createLooseMock(goog.editor.Link);mockOkHandler=mockCtrl.createLooseMock(goog.events.EventHandler);isNew=!1;mockLink.isNew();mockLink.$anyTimes();mockLink.$does(function(){return isNew});mockLink.getCurrentText();mockLink.$anyTimes();mockLink.$does(function(){return anchorElem.innerHTML});mockLink.setTextAndUrl(goog.testing.mockmatchers.isString,goog.testing.mockmatchers.isString);mockLink.$anyTimes();mockLink.$does(function(text,url){anchorElem.innerHTML=text;anchorElem.href=url});mockLink.$registerArgumentListVerifier("placeCursorRightOf",function(){return!0});mockLink.placeCursorRightOf(goog.testing.mockmatchers.iBoolean);mockLink.$anyTimes();mockLink.getAnchor();mockLink.$anyTimes();mockLink.$returns(anchorElem);mockWindowOpen=mockCtrl.createFunctionMock("open");stubs.set(window,"open",mockWindowOpen)}function tearDown(){dialog.dispose();goog.dom.removeNode(anchorElem);stubs.reset()}function setUpAnchor(href,text,opt_isNew,opt_target,opt_rel){anchorElem.href=href;anchorElem.innerHTML=text;isNew=!!opt_isNew;if(opt_target){anchorElem.target=opt_target}if(opt_rel){anchorElem.rel=opt_rel}}function createAndShow(opt_document,opt_openInNewWindow,opt_noFollow){dialog=new goog.ui.editor.LinkDialog(new goog.dom.DomHelper(opt_document),mockLink);if(opt_openInNewWindow){dialog.showOpenLinkInNewWindow(!1)}if(opt_noFollow){dialog.showRelNoFollow()}dialog.addEventListener(goog.ui.editor.AbstractDialog.EventType.OK,mockOkHandler);dialog.show()}function expectOk(linkText,linkUrl,opt_openInNewWindow,opt_noFollow){mockOkHandler.handleEvent(new goog.testing.mockmatchers.ArgumentMatcher(function(arg){return arg.type==goog.ui.editor.AbstractDialog.EventType.OK&&arg.linkText==linkText&&arg.linkUrl==linkUrl&&arg.openInNewWindow==!!opt_openInNewWindow&&arg.noFollow==!!opt_noFollow},"{linkText: "+linkText+", linkUrl: "+linkUrl+", openInNewWindow: "+opt_openInNewWindow+", noFollow: "+opt_noFollow+"}"))}function useActiveElement(){return goog.editor.BrowserFeature.HAS_ACTIVE_ELEMENT||goog.userAgent.WEBKIT&&goog.userAgent.isVersionOrHigher(9)}function testShowNewLinkSwitchToUrl(opt_document){mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow(opt_document);var webRadio=dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB).firstChild,emailRadio=dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB).firstChild;assertTrue("Web Radio Button selected",webRadio.checked);assertFalse("Email Radio Button selected",emailRadio.checked);if(useActiveElement()){assertEquals("Focus should be on url input",getUrlInput(),dialog.dom.getActiveElement())}emailRadio.click();assertFalse("Web Radio Button selected",webRadio.checked);assertTrue("Email Radio Button selected",emailRadio.checked);if(useActiveElement()){assertEquals("Focus should be on url input",getEmailInput(),dialog.dom.getActiveElement())}mockCtrl.$verifyAll()}function testShowForNewLink(opt_document){mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow(opt_document);assertEquals("Display text input field should be empty","",getDisplayInputText());assertEquals("Url input field should be empty","",getUrlInputText());assertEquals("On the web tab should be selected",goog.ui.editor.LinkDialog.Id_.ON_WEB,dialog.curTabId_);if(useActiveElement()){assertEquals("Focus should be on url input",getUrlInput(),dialog.dom.getActiveElement())}mockCtrl.$verifyAll()}function testShowForNewLinkWithDiffAppWindow(){testShowForNewLink(goog.dom.getElement("appWindowIframe").contentDocument)}function testShowForUrlLink(){mockCtrl.$replayAll();setUpAnchor(ANCHOR_URL,ANCHOR_TEXT);createAndShow();assertEquals("Display text input field should be filled in",ANCHOR_TEXT,getDisplayInputText());assertEquals("Url input field should be filled in",ANCHOR_URL,getUrlInputText());assertEquals("On the web tab should be selected",goog.ui.editor.LinkDialog.Id_.ON_WEB,dialog.curTabId_);if(useActiveElement()){assertEquals("Focus should be on url input",getUrlInput(),dialog.dom.getActiveElement())}mockCtrl.$verifyAll()}function testShowForMailtoLink(){mockCtrl.$replayAll();setUpAnchor(ANCHOR_MAILTO,ANCHOR_TEXT);createAndShow();assertEquals("Display text input field should be filled in",ANCHOR_TEXT,getDisplayInputText());assertEquals("Email input field should be filled in",ANCHOR_EMAIL,getEmailInputText());assertEquals("Email tab should be selected",goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS,dialog.curTabId_);if(useActiveElement()){assertEquals("Focus should be on email input",getEmailInput(),dialog.dom.getActiveElement())}mockCtrl.$verifyAll()}function testAutogeneration(){mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();setUrlInputText(ANCHOR_URL);assertEquals("Display text should have been autogenerated",ANCHOR_URL,getDisplayInputText());setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_MAILTO);assertNotEquals("Display text should not have been autogenerated",ANCHOR_MAILTO,getDisplayInputText());assertEquals("Display text should have remained the same",ANCHOR_TEXT,getDisplayInputText());setDisplayInputText(ANCHOR_MAILTO);setUrlInputText(ANCHOR_URL);assertEquals("Display text should have been autogenerated",ANCHOR_URL,getDisplayInputText());mockCtrl.$verifyAll()}function testAutogenerationOff(){mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();dialog.setAutogenFeatureEnabled(!1);setUrlInputText(ANCHOR_URL);assertEquals("Display text should not have been autogenerated","",getDisplayInputText());setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_MAILTO);assertNotEquals("Display text should not have been autogenerated",ANCHOR_MAILTO,getDisplayInputText());assertEquals("Display text should have remained the same",ANCHOR_TEXT,getDisplayInputText());setDisplayInputText(ANCHOR_MAILTO);setUrlInputText(ANCHOR_URL);assertEquals("Display text should not have been autogenerated",ANCHOR_MAILTO,getDisplayInputText());mockCtrl.$verifyAll()}function testOkForUrl(){expectOk(ANCHOR_TEXT,ANCHOR_URL);mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);goog.testing.events.fireClickSequence(dialog.getOkButtonElement());mockCtrl.$verifyAll()}function testOkForUrlWithEmail(){expectOk(ANCHOR_TEXT,ANCHOR_MAILTO);mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_EMAIL);goog.testing.events.fireClickSequence(dialog.getOkButtonElement());mockCtrl.$verifyAll()}function testOkForEmail(){expectOk(ANCHOR_TEXT,ANCHOR_MAILTO);mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_TAB);setDisplayInputText(ANCHOR_TEXT);setEmailInputText(ANCHOR_EMAIL);goog.testing.events.fireClickSequence(dialog.getOkButtonElement());mockCtrl.$verifyAll()}function testOpenLinkInNewWindowNewLink(){expectOk(ANCHOR_TEXT,ANCHOR_URL,!0);expectOk(ANCHOR_TEXT,ANCHOR_URL,!1);mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow(void 0,!0);dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);assertFalse("\"Open in new window\" should start unchecked",getOpenInNewWindowCheckboxChecked());setOpenInNewWindowCheckboxChecked(!0);assertTrue("\"Open in new window\" should have gotten checked",getOpenInNewWindowCheckboxChecked());goog.testing.events.fireClickSequence(dialog.getOkButtonElement());dialog.show();dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);assertTrue("\"Open in new window\" should remember it was checked",getOpenInNewWindowCheckboxChecked());setOpenInNewWindowCheckboxChecked(!1);assertFalse("\"Open in new window\" should have gotten unchecked",getOpenInNewWindowCheckboxChecked());goog.testing.events.fireClickSequence(dialog.getOkButtonElement())}function testOpenLinkInNewWindowExistingLink(){mockCtrl.$replayAll();setUpAnchor("","",!1,"_blank");createAndShow(void 0,!0);dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);assertTrue("\"Open in new window\" should start checked for existing link",getOpenInNewWindowCheckboxChecked());mockCtrl.$verifyAll()}function testRelNoFollowNewLink(){expectOk(ANCHOR_TEXT,ANCHOR_URL,null,!0);expectOk(ANCHOR_TEXT,ANCHOR_URL,null,!1);mockCtrl.$replayAll();setUpAnchor("","",!0,!0);createAndShow(null,null,!0);dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);assertFalse("rel=nofollow should start unchecked",dialog.relNoFollowCheckbox_.checked);dialog.relNoFollowCheckbox_.checked=!0;goog.testing.events.fireClickSequence(dialog.getOkButtonElement());anchorElem.rel="foo nofollow bar";dialog.show();dialog.tabPane_.setSelectedTabId(goog.ui.editor.LinkDialog.Id_.ON_WEB_TAB);setDisplayInputText(ANCHOR_TEXT);setUrlInputText(ANCHOR_URL);assertTrue("rel=nofollow should start checked when reopening the dialog",dialog.relNoFollowCheckbox_.checked)}function testRelNoFollowExistingLink(){mockCtrl.$replayAll();setUpAnchor("","",null,null,"foo nofollow bar");createAndShow(null,null,!0);assertTrue("rel=nofollow should start checked for existing link",dialog.relNoFollowCheckbox_.checked);mockCtrl.$verifyAll()}function testWebTestButton(){var _Mathmax=Math.max;if(goog.userAgent.GECKO){return}var width,height;mockWindowOpen(ANCHOR_URL,"_blank",new goog.testing.mockmatchers.ArgumentMatcher(function(str){return str=="width="+width+",height="+height+",toolbar=1,scrollbars=1,location=1,statusbar=0,"+"menubar=1,resizable=1"},"3rd arg: (string) window.open() options"));mockCtrl.$replayAll();setUpAnchor(ANCHOR_URL,ANCHOR_TEXT);createAndShow();var size=goog.dom.getViewportSize(window);width=_Mathmax(size.width-50,50);height=_Mathmax(size.height-50,50);var testLink=goog.testing.dom.findTextNode(goog.ui.editor.messages.MSG_TEST_THIS_LINK,dialog.dialogInternal_.getElement());goog.testing.events.fireClickSequence(testLink.parentNode);mockCtrl.$verifyAll()}function testWebTestButtonPreventDefault(){mockCtrl.$replayAll();setUpAnchor(ANCHOR_URL,ANCHOR_TEXT);createAndShow();goog.events.listen(dialog,goog.ui.editor.LinkDialog.EventType.BEFORE_TEST_LINK,function(e){assertEquals(e.url,ANCHOR_URL);e.preventDefault()});var testLink=goog.testing.dom.findTextNode(goog.ui.editor.messages.MSG_TEST_THIS_LINK,dialog.dialogInternal_.getElement());goog.testing.events.fireClickSequence(testLink.parentNode);mockCtrl.$verifyAll()}function testSetTextToDisplayVisible(){mockCtrl.$replayAll();setUpAnchor("","",!0);createAndShow();assertNotEquals("none",goog.style.getStyle(dialog.textToDisplayDiv_,"display"));dialog.setTextToDisplayVisible(!1);assertEquals("none",goog.style.getStyle(dialog.textToDisplayDiv_,"display"));dialog.setTextToDisplayVisible(!0);assertNotEquals("none",goog.style.getStyle(dialog.textToDisplayDiv_,"display"));mockCtrl.$verifyAll()}function getDisplayInput(){return dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.TEXT_TO_DISPLAY)}function getDisplayInputText(){return getDisplayInput().value}function setDisplayInputText(text){var textInput=getDisplayInput();textInput.value=text;fireInputEvent(textInput,goog.events.KeyCodes.M)}function getUrlInput(){var elt=dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.ON_WEB_INPUT);assertNotNullNorUndefined("UrlInput must be found",elt);return elt}function getUrlInputText(){return getUrlInput().value}function setUrlInputText(text){var urlInput=getUrlInput();urlInput.value=text;fireInputEvent(dialog.urlInputHandler_,goog.events.KeyCodes.M)}function getEmailInput(){var elt=dialog.dom.getElement(goog.ui.editor.LinkDialog.Id_.EMAIL_ADDRESS_INPUT);assertNotNullNorUndefined("EmailInput must be found",elt);return elt}function getEmailInputText(){return getEmailInput().value}function setEmailInputText(text){var emailInput=getEmailInput();emailInput.value=text;fireInputEvent(dialog.emailInputHandler_,goog.events.KeyCodes.M)}function getOpenInNewWindowCheckboxChecked(){return dialog.openInNewWindowCheckbox_.checked}function setOpenInNewWindowCheckboxChecked(checked){dialog.openInNewWindowCheckbox_.checked=checked}function fireInputEvent(input,keyCode){var inputEvent=new goog.testing.events.Event(goog.events.EventType.INPUT,input);inputEvent.keyCode=keyCode;inputEvent.charCode=keyCode;goog.testing.events.fireBrowserEvent(inputEvent)}