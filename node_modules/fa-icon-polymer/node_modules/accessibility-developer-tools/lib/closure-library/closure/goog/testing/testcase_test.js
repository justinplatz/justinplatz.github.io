goog.provide("goog.testing.TestCaseTest");goog.setTestOnly("goog.testing.TestCaseTest");goog.require("goog.Promise");goog.require("goog.functions");goog.require("goog.string");goog.require("goog.testing.ExpectedFailures");goog.require("goog.testing.JsUnitException");goog.require("goog.testing.MethodMock");goog.require("goog.testing.MockRandom");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.TestCase");goog.require("goog.testing.jsunit");var ok=function(){assertTrue(!0)},okPromise=function(){return Promise.resolve(null)},failPromise=function(){return Promise.reject(null)},neverResolvedPromise=function(){return new Promise(function(){})},okGoogPromise=function(){return goog.Promise.resolve(null)},failGoogPromise=function(){return goog.Promise.reject(null)},neverResolvedGoogPromise=function(){return new goog.Promise(function(){})};function setUp(){goog.testing.TestCase.getActiveTestCase().failOnUnreportedAsserts=!1}function testEmptyTestCase(){var testCase=new goog.testing.TestCase;testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(0,result.totalCount);assertEquals(0,result.runCount);assertEquals(0,result.successCount);assertEquals(0,result.errors.length)}function testEmptyTestCaseReturningPromise(){return new goog.testing.TestCase().runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(0,result.totalCount);assertEquals(0,result.runCount);assertEquals(0,result.successCount);assertEquals(0,result.errors.length)})}function testTestCase_SyncSuccess(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",ok);testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(1,result.successCount);assertEquals(0,result.errors.length)}function testTestCaseReturningPromise_SyncSuccess(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",ok);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(1,result.successCount);assertEquals(0,result.errors.length)})}function testTestCaseReturningPromise_GoogPromiseResolve(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okGoogPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(1,result.successCount);assertEquals(0,result.errors.length)})}function testTestCaseReturningPromise_PromiseResolve(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(1,result.successCount);assertEquals(0,result.errors.length)})}function testTestCase_SyncFailure(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",fail);testCase.runTests();assertFalse(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertEquals("foo",result.errors[0].source)}function testTestCaseReturningPromise_SyncFailure(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",fail);return testCase.runTestsReturningPromise().then(function(result){assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertEquals("foo",result.errors[0].source)})}function testTestCaseReturningPromise_GoogPromiseReject(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",failGoogPromise);return testCase.runTestsReturningPromise().then(function(result){assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertEquals("foo",result.errors[0].source)})}function testTestCaseReturningPromise_GoogPromiseTimeout(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",neverResolvedGoogPromise);var startTimestamp=new Date().getTime();testCase.promiseTimeout=500;startTimestamp=new Date().getTime();return testCase.runTestsReturningPromise().then(function(result){var elapsedTime=new Date().getTime()-startTimestamp;assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertTrue(goog.string.contains(result.errors[0].message,"foo"));assertTrue(goog.string.contains(result.errors[0].message,"goog.testing.TestCase.getActiveTestCase().promiseTimeout"));assertTrue(elapsedTime>=testCase.promiseTimeout-100&&elapsedTime<=testCase.promiseTimeout+100)})}function testTestCaseReturningPromise_PromiseReject(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",failPromise);return testCase.runTestsReturningPromise().then(function(result){assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertEquals("foo",result.errors[0].source)})}function testTestCaseReturningPromise_PromiseTimeout(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",neverResolvedPromise);testCase.promiseTimeout=500;var startTimestamp=new Date().getTime();return testCase.runTestsReturningPromise().then(function(result){var elapsedTime=new Date().getTime()-startTimestamp;assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.totalCount);assertEquals(1,result.runCount);assertEquals(0,result.successCount);assertEquals(1,result.errors.length);assertTrue(goog.string.contains(result.errors[0].message,"foo"));assertTrue(goog.string.contains(result.errors[0].message,"goog.testing.TestCase.getActiveTestCase().promiseTimeout"));assertTrue(elapsedTime>=testCase.promiseTimeout-100&&elapsedTime<=testCase.promiseTimeout+100)})}function testTestCase_SyncSuccess_SyncFailure(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",ok);testCase.addNewTest("bar",fail);testCase.runTests();assertFalse(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)}function testTestCaseReturningPromise_SyncSuccess_SyncFailure(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",ok);testCase.addNewTest("bar",fail);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)})}function testTestCaseReturningPromise_GoogPromiseResolve_GoogPromiseReject(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okGoogPromise);testCase.addNewTest("bar",failGoogPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)})}function testTestCaseReturningPromise_PromiseResolve_PromiseReject(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okPromise);testCase.addNewTest("bar",failPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)})}function testTestCaseReturningPromise_PromiseResolve_GoogPromiseReject(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okPromise);testCase.addNewTest("bar",failGoogPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)})}function testTestCaseReturningPromise_GoogPromiseResolve_PromiseReject(){if(!("Promise"in goog.global)){return}var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",okGoogPromise);testCase.addNewTest("bar",failPromise);return testCase.runTestsReturningPromise().then(function(result){assertTrue(result.complete);assertEquals(2,result.totalCount);assertEquals(2,result.runCount);assertEquals(1,result.successCount);assertEquals(1,result.errors.length);assertEquals("bar",result.errors[0].source)})}function testTestCaseNeverRun(){var testCase=new goog.testing.TestCase;testCase.addNewTest("foo",fail);var result=testCase.getResult();assertFalse(result.complete);assertEquals(0,result.totalCount);assertEquals(0,result.runCount);assertEquals(0,result.successCount);assertEquals(0,result.errors.length)}function testParseOrder(){assertNull(goog.testing.TestCase.parseOrder_(""));assertNull(goog.testing.TestCase.parseOrder_("?order=invalid"));assertEquals("natural",goog.testing.TestCase.parseOrder_("?order=natural"));assertEquals("sorted",goog.testing.TestCase.parseOrder_("?a&order=sorted"));assertEquals("random",goog.testing.TestCase.parseOrder_("?b&order=random"));assertEquals("random",goog.testing.TestCase.parseOrder_("?ORDER=RANDOM"))}function testParseRunTests(){assertNull(goog.testing.TestCase.parseRunTests_(""));assertNull(goog.testing.TestCase.parseRunTests_("?runTests="));assertObjectEquals({testOne:!0},goog.testing.TestCase.parseRunTests_("?runTests=testOne"));assertObjectEquals({testOne:!0,testTwo:!0},goog.testing.TestCase.parseRunTests_("?foo=bar&runTests=testOne,testTwo"));assertObjectEquals({1:!0,2:!0,3:!0,testShouting:!0,TESTSHOUTING:!0},goog.testing.TestCase.parseRunTests_("?RUNTESTS=testShouting,TESTSHOUTING,1,2,3"))}function testSortOrder_natural(){var testCase=new goog.testing.TestCase;testCase.setOrder("natural");var testIndex=0;testCase.addNewTest("test_c",function(){assertEquals(0,testIndex++)});testCase.addNewTest("test_a",function(){assertEquals(1,testIndex++)});testCase.addNewTest("test_b",function(){assertEquals(2,testIndex++)});testCase.orderTests_();testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertEquals(3,result.totalCount);assertEquals(3,result.runCount);assertEquals(3,result.successCount);assertEquals(0,result.errors.length)}function testSortOrder_random(){var testCase=new goog.testing.TestCase;testCase.setOrder("random");var testIndex=0;testCase.addNewTest("test_c",function(){assertEquals(0,testIndex++)});testCase.addNewTest("test_a",function(){assertEquals(2,testIndex++)});testCase.addNewTest("test_b",function(){assertEquals(1,testIndex++)});var mockRandom=new goog.testing.MockRandom([.5,.5]);mockRandom.install();try{testCase.orderTests_()}finally{mockRandom.uninstall()}testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertEquals(3,result.totalCount);assertEquals(3,result.runCount);assertEquals(3,result.successCount);assertEquals(0,result.errors.length)}function testSortOrder_sorted(){var testCase=new goog.testing.TestCase;testCase.setOrder("sorted");var testIndex=0;testCase.addNewTest("test_c",function(){assertEquals(2,testIndex++)});testCase.addNewTest("test_a",function(){assertEquals(0,testIndex++)});testCase.addNewTest("test_b",function(){assertEquals(1,testIndex++)});testCase.orderTests_();testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertEquals(3,result.totalCount);assertEquals(3,result.runCount);assertEquals(3,result.successCount);assertEquals(0,result.errors.length)}function testRunTests(){var testCase=new goog.testing.TestCase;testCase.setTestsToRun({test_a:!0,test_c:!0});var testIndex=0;testCase.addNewTest("test_c",function(){assertEquals(0,testIndex++)});testCase.addNewTest("test_a",function(){assertEquals(1,testIndex++)});testCase.addNewTest("test_b",fail);testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertEquals(3,result.totalCount);assertEquals(2,result.runCount);assertEquals(2,result.successCount);assertEquals(0,result.errors.length)}function testRunTests_byIndex(){var testCase=new goog.testing.TestCase;testCase.setTestsToRun({0:!0,2:!0});var testIndex=0;testCase.addNewTest("test_c",function(){assertEquals(0,testIndex++)});testCase.addNewTest("test_a",fail);testCase.addNewTest("test_b",function(){assertEquals(1,testIndex++)});testCase.runTests();assertTrue(testCase.isSuccess());var result=testCase.getResult();assertEquals(3,result.totalCount);assertEquals(2,result.runCount);assertEquals(2,result.successCount);assertEquals(0,result.errors.length)}function testMaybeFailTestEarly(){var message="Error in setUpPage().",testCase=new goog.testing.TestCase;testCase.setUpPage=function(){throw Error(message)};testCase.addNewTest("test",ok);testCase.runTests();assertFalse(testCase.isSuccess());var errors=testCase.getResult().errors;assertEquals(1,errors.length);assertEquals(message,errors[0].message)}function testSetUpReturnsPromiseThatTimesOut(){var testCase=new goog.testing.TestCase;testCase.promiseTimeout=500;testCase.setUp=neverResolvedGoogPromise;testCase.addNewTest("test",ok);return testCase.runTestsReturningPromise().then(function(result){assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.errors.length);assertTrue(goog.string.contains(result.errors[0].message,"setUp"))})}function testTearDownReturnsPromiseThatTimesOut(){var testCase=new goog.testing.TestCase;testCase.promiseTimeout=500;testCase.tearDown=neverResolvedGoogPromise;testCase.addNewTest("test",ok);return testCase.runTestsReturningPromise().then(function(result){assertFalse(testCase.isSuccess());assertTrue(result.complete);assertEquals(1,result.errors.length);assertTrue(goog.string.contains(result.errors[0].message,"tearDown"))})}function testFailOnUnreportedAsserts_EnabledByDefault(){assertTrue(new goog.testing.TestCase().failOnUnreportedAsserts)}function verifyTestOutcomeForFailOnUnreportedAssertsFlag(shouldPassWithFlagEnabled,testFunction){return verifyWithFlagEnabledAndNoInvalidation(testFunction).then(function(){return verifyWithFlagEnabled(testFunction,shouldPassWithFlagEnabled)}).then(function(){return verifyWithFlagDisabled(testFunction)})}function verifyWithFlagDisabled(testFunction){var testCase=new goog.testing.TestCase,getTestCase=goog.functions.constant(testCase);testCase.addNewTest("test",testFunction);testCase.failOnUnreportedAsserts=!1;var stubs=new goog.testing.PropertyReplacer;stubs.replace(window,"_getCurrentTestCase",getTestCase);stubs.replace(goog.testing.TestCase,"getActiveTestCase",getTestCase);var promise=new goog.Promise(function(resolve,reject){testCase.setCompletedCallback(resolve)}).then(function(){assertTrue(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(0,result.errors.length)}).thenAlways(function(){stubs.reset()});testCase.runTests();return promise}function verifyWithFlagEnabled(testFunction,shouldPassWithFlagEnabled){var testCase=new goog.testing.TestCase,getTestCase=goog.functions.constant(testCase);testCase.addNewTest("test",testFunction);testCase.failOnUnreportedAsserts=!0;var stubs=new goog.testing.PropertyReplacer;stubs.replace(window,"_getCurrentTestCase",getTestCase);stubs.replace(goog.testing.TestCase,"getActiveTestCase",getTestCase);var promise=new goog.Promise(function(resolve,reject){testCase.setCompletedCallback(resolve)}).then(function(){assertEquals(shouldPassWithFlagEnabled,testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(shouldPassWithFlagEnabled?0:2,result.errors.length)}).thenAlways(function(){stubs.reset()});testCase.runTests();return promise}function verifyWithFlagEnabledAndNoInvalidation(testFunction){var testCase=new goog.testing.TestCase,getTestCase=goog.functions.constant(testCase);testCase.addNewTest("test",testFunction);testCase.failOnUnreportedAsserts=!0;var stubs=new goog.testing.PropertyReplacer;stubs.replace(window,"_getCurrentTestCase",getTestCase);stubs.replace(goog.testing.TestCase,"getActiveTestCase",getTestCase);stubs.replace(goog.testing.TestCase.prototype,"invalidateAssertionException",goog.nullFunction);var promise=new goog.Promise(function(resolve,reject){testCase.setCompletedCallback(resolve)}).then(function(){assertFalse(testCase.isSuccess());var result=testCase.getResult();assertTrue(result.complete);assertEquals(2,result.errors.length)}).thenAlways(function(){stubs.reset()});testCase.runTests();return promise}function testFailOnUnreportedAsserts_SwallowedException(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!1,function(){try{assertTrue(!1)}catch(e){}})}function testFailOnUnreportedAsserts_SwallowedFail(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!1,function(){try{fail()}catch(e){}})}function testFailOnUnreportedAsserts_SwallowedAssertThrowsException(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!1,function(){try{assertThrows(goog.nullFunction)}catch(e){}})}function testFailOnUnreportedAsserts_SwallowedAssertNotThrowsException(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!1,function(){try{assertNotThrows(goog.functions.error())}catch(e){}})}function testFailOnUnreportedAsserts_SwallowedExceptionViaPromise(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!1,function(){return goog.Promise.resolve().then(function(){assertTrue(!1)}).thenCatch(function(e){})})}function testFailOnUnreportedAsserts_NotForAssertThrowsJsUnitException(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!0,function(){assertThrowsJsUnitException(function(){assertTrue(!1)})})}function testFailOnUnreportedAsserts_NotForExpectedFailures(){return verifyTestOutcomeForFailOnUnreportedAssertsFlag(!0,function(){var expectedFailures=new goog.testing.ExpectedFailures;expectedFailures.expectFailureFor(!0);try{assertTrue(!1)}catch(e){expectedFailures.handleException(e)}})}function testFailOnUnreportedAsserts_ReportUnpropagatedAssertionExceptions(){var testCase=new goog.testing.TestCase,e1=new goog.testing.JsUnitException("foo123"),e2=new goog.testing.JsUnitException("bar456"),mockRecordError=goog.testing.MethodMock(testCase,"recordError_");mockRecordError("test",e1);mockRecordError("test",e2);mockRecordError.$replay();testCase.thrownAssertionExceptions_.push(e1);testCase.thrownAssertionExceptions_.push(e2);var exception=testCase.reportUnpropagatedAssertionExceptions_("test");assertContains("One or more assertions were",exception.toString());mockRecordError.$verify();mockRecordError.$tearDown()}function testSetObj(){var testCase=new goog.testing.TestCase;assertEquals(0,testCase.getCount());testCase.setTestObj({testOk:ok,somethingElse:fail});assertEquals(1,testCase.getCount())}function testSetObj_es6Class(){var FooTest;try{eval("FooTest = class { testOk() {assertTrue(true); } somethingElse() {} }")}catch(ex){return}var testCase=new goog.testing.TestCase;assertEquals(0,testCase.getCount());testCase.setTestObj(new FooTest);assertEquals(1,testCase.getCount())}