goog.provide("goog.testing.eventsTest");goog.setTestOnly("goog.testing.eventsTest");goog.require("goog.array");goog.require("goog.dom");goog.require("goog.dom.InputType");goog.require("goog.dom.TagName");goog.require("goog.events");goog.require("goog.events.EventType");goog.require("goog.events.KeyCodes");goog.require("goog.math.Coordinate");goog.require("goog.string");goog.require("goog.style");goog.require("goog.testing.PropertyReplacer");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.testing.recordFunction");goog.require("goog.userAgent");var firedEventTypes,firedEventCoordinates,firedScreenCoordinates,firedShiftKeys,firedKeyCodes,root,log,input,testButton,parentEl,childEl,coordinate=new goog.math.Coordinate(123,456),stubs=new goog.testing.PropertyReplacer,eventCount;function setUpPage(){root=goog.dom.getElement("root");log=goog.dom.getElement("log");input=goog.dom.getElement("input");testButton=goog.dom.getElement("testButton");parentEl=goog.dom.getElement("parentEl");childEl=goog.dom.getElement("childEl")}function setUp(){stubs.reset();goog.events.removeAll(root);goog.events.removeAll(log);goog.events.removeAll(input);goog.events.removeAll(testButton);goog.events.removeAll(parentEl);goog.events.removeAll(childEl);goog.dom.removeChildren(root);firedEventTypes=[];firedEventCoordinates=[];firedScreenCoordinates=[];firedShiftKeys=[];firedKeyCodes=[];for(var key in goog.events.EventType){goog.events.listen(root,goog.events.EventType[key],function(e){firedEventTypes.push(e.type);var coord=new goog.math.Coordinate(e.clientX,e.clientY);firedEventCoordinates.push(coord);firedScreenCoordinates.push(new goog.math.Coordinate(e.screenX,e.screenY));firedShiftKeys.push(!!e.shiftKey);firedKeyCodes.push(e.keyCode)})}eventCount={parentBubble:0,parentCapture:0,childCapture:0,childBubble:0};goog.events.listen(parentEl,goog.events.EventType.CLICK,function(e){eventCount.parentCapture++;assertEquals(parentEl,e.currentTarget);assertEquals(childEl,e.target)},!0);goog.events.listen(childEl,goog.events.EventType.CLICK,function(e){eventCount.childCapture++;assertEquals(childEl,e.currentTarget);assertEquals(childEl,e.target)},!0);goog.events.listen(childEl,goog.events.EventType.CLICK,function(e){eventCount.childBubble++;assertEquals(childEl,e.currentTarget);assertEquals(childEl,e.target)});goog.events.listen(parentEl,goog.events.EventType.CLICK,function(e){eventCount.parentBubble++;assertEquals(parentEl,e.currentTarget);assertEquals(childEl,e.target)})}function tearDownPage(){for(var key in goog.events.EventType){var type=goog.events.EventType[key];if("mousemove"==type||"mouseout"==type||"mouseover"==type){continue}goog.dom.appendChild(input,goog.dom.createDom(goog.dom.TagName.LABEL,null,goog.dom.createDom(goog.dom.TagName.INPUT,{id:type,type:goog.dom.InputType.CHECKBOX}),type,goog.dom.createDom(goog.dom.TagName.BR)));goog.events.listen(testButton,type,function(e){if(goog.dom.getElement(e.type).checked){e.preventDefault()}log.innerHTML+=goog.string.subs("<br />%s (%s, %s)",e.type,e.clientX,e.clientY)})}}function testMouseEnter(){goog.testing.events.fireMouseEnterEvent(root,null);goog.testing.events.fireMouseEnterEvent(root,null,coordinate);assertEventTypes(["mouseenter","mouseenter"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testMouseLeave(){goog.testing.events.fireMouseLeaveEvent(root,null);goog.testing.events.fireMouseLeaveEvent(root,null,coordinate);assertEventTypes(["mouseleave","mouseleave"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testMouseOver(){goog.testing.events.fireMouseOverEvent(root,null);goog.testing.events.fireMouseOverEvent(root,null,coordinate);assertEventTypes(["mouseover","mouseover"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testMouseOut(){goog.testing.events.fireMouseOutEvent(root,null);goog.testing.events.fireMouseOutEvent(root,null,coordinate);assertEventTypes(["mouseout","mouseout"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testFocus(){goog.testing.events.fireFocusEvent(root);assertEventTypes(["focus"])}function testFocusIn(){goog.testing.events.fireFocusInEvent(root);assertEventTypes([goog.events.EventType.FOCUSIN])}function testBlur(){goog.testing.events.fireBlurEvent(root);assertEventTypes(["blur"])}function testClickSequence(){assertTrue(goog.testing.events.fireClickSequence(root));assertEventTypes(["mousedown","mouseup","click"]);var rootPosition=goog.style.getClientPosition(root);assertCoordinates([rootPosition,rootPosition,rootPosition])}function testClickSequenceWithCoordinate(){assertTrue(goog.testing.events.fireClickSequence(root,null,coordinate));assertCoordinates([coordinate,coordinate,coordinate]);assertArrayEquals([!1,!1,!1],firedShiftKeys)}function testTouchStart(){goog.testing.events.fireTouchStartEvent(root);goog.testing.events.fireTouchStartEvent(root,coordinate);assertEventTypes(["touchstart","touchstart"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testTouchMove(){goog.testing.events.fireTouchMoveEvent(root);goog.testing.events.fireTouchMoveEvent(root,coordinate,{touches:[]});assertEventTypes(["touchmove","touchmove"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testTouchEnd(){goog.testing.events.fireTouchEndEvent(root);goog.testing.events.fireTouchEndEvent(root,coordinate);assertEventTypes(["touchend","touchend"]);assertCoordinates([goog.style.getClientPosition(root),coordinate])}function testTouchSequence(){assertTrue(goog.testing.events.fireTouchSequence(root));assertEventTypes(["touchstart","touchend"]);var rootPosition=goog.style.getClientPosition(root);assertCoordinates([rootPosition,rootPosition])}function testTouchSequenceWithCoordinate(){assertTrue(goog.testing.events.fireTouchSequence(root,coordinate));assertCoordinates([coordinate,coordinate])}function testClickSequenceWithEventProperty(){assertTrue(goog.testing.events.fireClickSequence(root,null,void 0,{shiftKey:!0}));assertArrayEquals([!0,!0,!0],firedShiftKeys)}function testClickSequenceCancellingMousedown(){preventDefaultEventType("mousedown");assertFalse(goog.testing.events.fireClickSequence(root));assertEventTypes(["mousedown","mouseup","click"])}function testClickSequenceCancellingMousedownWithCoordinate(){preventDefaultEventType("mousedown");assertFalse(goog.testing.events.fireClickSequence(root,null,coordinate));assertCoordinates([coordinate,coordinate,coordinate])}function testClickSequenceCancellingMouseup(){preventDefaultEventType("mouseup");assertFalse(goog.testing.events.fireClickSequence(root));assertEventTypes(["mousedown","mouseup","click"])}function testClickSequenceCancellingMouseupWithCoordinate(){preventDefaultEventType("mouseup");assertFalse(goog.testing.events.fireClickSequence(root,null,coordinate));assertCoordinates([coordinate,coordinate,coordinate])}function testClickSequenceCancellingClick(){preventDefaultEventType("click");assertFalse(goog.testing.events.fireClickSequence(root));assertEventTypes(["mousedown","mouseup","click"])}function testClickSequenceCancellingClickWithCoordinate(){preventDefaultEventType("click");assertFalse(goog.testing.events.fireClickSequence(root,null,coordinate));assertCoordinates([coordinate,coordinate,coordinate])}var DBLCLICK_SEQ=goog.userAgent.IE?["mousedown","mouseup","click","mouseup","dblclick"]:["mousedown","mouseup","click","mousedown","mouseup","click","dblclick"],DBLCLICK_SEQ_COORDS=goog.array.repeat(coordinate,DBLCLICK_SEQ.length);function testDoubleClickSequence(){assertTrue(goog.testing.events.fireDoubleClickSequence(root));assertEventTypes(DBLCLICK_SEQ)}function testDoubleClickSequenceWithCoordinate(){assertTrue(goog.testing.events.fireDoubleClickSequence(root,coordinate));assertCoordinates(DBLCLICK_SEQ_COORDS)}function testDoubleClickSequenceCancellingMousedown(){preventDefaultEventType("mousedown");assertFalse(goog.testing.events.fireDoubleClickSequence(root));assertEventTypes(DBLCLICK_SEQ)}function testDoubleClickSequenceCancellingMousedownWithCoordinate(){preventDefaultEventType("mousedown");assertFalse(goog.testing.events.fireDoubleClickSequence(root,coordinate));assertCoordinates(DBLCLICK_SEQ_COORDS)}function testDoubleClickSequenceCancellingMouseup(){preventDefaultEventType("mouseup");assertFalse(goog.testing.events.fireDoubleClickSequence(root));assertEventTypes(DBLCLICK_SEQ)}function testDoubleClickSequenceCancellingMouseupWithCoordinate(){preventDefaultEventType("mouseup");assertFalse(goog.testing.events.fireDoubleClickSequence(root,coordinate));assertCoordinates(DBLCLICK_SEQ_COORDS)}function testDoubleClickSequenceCancellingClick(){preventDefaultEventType("click");assertFalse(goog.testing.events.fireDoubleClickSequence(root));assertEventTypes(DBLCLICK_SEQ)}function testDoubleClickSequenceCancellingClickWithCoordinate(){preventDefaultEventType("click");assertFalse(goog.testing.events.fireDoubleClickSequence(root,coordinate));assertCoordinates(DBLCLICK_SEQ_COORDS)}function testDoubleClickSequenceCancellingDoubleClick(){preventDefaultEventType("dblclick");assertFalse(goog.testing.events.fireDoubleClickSequence(root));assertEventTypes(DBLCLICK_SEQ)}function testDoubleClickSequenceCancellingDoubleClickWithCoordinate(){preventDefaultEventType("dblclick");assertFalse(goog.testing.events.fireDoubleClickSequence(root,coordinate));assertCoordinates(DBLCLICK_SEQ_COORDS)}function testKeySequence(){assertTrue(goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.ZERO));assertEventTypes(["keydown","keypress","keyup"])}function testKeySequenceCancellingKeydown(){preventDefaultEventType("keydown");assertFalse(goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.ZERO));assertEventTypes(["keydown","keyup"])}function testKeySequenceCancellingKeypress(){preventDefaultEventType("keypress");assertFalse(goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.ZERO));assertEventTypes(["keydown","keypress","keyup"])}function testKeySequenceCancellingKeyup(){preventDefaultEventType("keyup");assertFalse(goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.ZERO));assertEventTypes(["keydown","keypress","keyup"])}function testKeySequenceWithEscapeKey(){assertTrue(goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.ESC));if(goog.userAgent.EDGE||goog.userAgent.WEBKIT&&goog.userAgent.isVersionOrHigher("525")){assertEventTypes(["keydown","keyup"])}else{assertEventTypes(["keydown","keypress","keyup"])}}function testKeySequenceForMacActionKeysNegative(){stubs.set(goog.userAgent,"GECKO",!1);goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.C,{metaKey:!0});assertEventTypes(["keydown","keypress","keyup"])}function testKeySequenceForMacActionKeysPositive(){stubs.set(goog.userAgent,"GECKO",!0);stubs.set(goog.userAgent,"MAC",!0);goog.testing.events.fireKeySequence(root,goog.events.KeyCodes.C,{metaKey:!0});assertEventTypes(["keypress","keyup"])}function testKeySequenceForOptionKeysOnMac(){stubs.set(goog.userAgent,"WEBKIT",!0);stubs.set(goog.userAgent,"MAC",!0);for(var optionKeyCodes=[[192,230],[188,8804],[189,8211],[190,8805],[191,247],[48,186],[49,161],[50,8482],[51,163],[52,162],[53,8734],[54,167],[55,182],[56,8226],[57,170],[186,8230],[187,8800],[219,8220],[220,171],[221,8216],[65,229],[66,8747],[67,231],[68,8706],[69,180],[70,402],[71,169],[72,729],[73,710],[74,8710],[75,730],[76,172],[77,181],[78,732],[79,248],[80,960],[81,339],[82,174],[83,223],[84,8224],[86,8730],[87,8721],[88,8776],[89,165],[90,937]],i=0;i<optionKeyCodes.length;++i){firedEventTypes=[];firedKeyCodes=[];var keyCode=optionKeyCodes[i][0],keyPressKeyCode=optionKeyCodes[i][1];goog.testing.events.fireNonAsciiKeySequence(root,keyCode,keyPressKeyCode,{altKey:!0});assertEventTypes(["keydown","keypress","keyup"]);assertArrayEquals([keyCode,keyPressKeyCode,keyCode],firedKeyCodes)}}var CONTEXTMENU_SEQ=goog.userAgent.WINDOWS?["mousedown","mouseup","contextmenu"]:goog.userAgent.GECKO?["mousedown","contextmenu","mouseup"]:goog.userAgent.WEBKIT&&goog.userAgent.MAC?["mousedown","contextmenu","mouseup","click"]:["mousedown","contextmenu","mouseup"];function testContextMenuSequence(){assertTrue(goog.testing.events.fireContextMenuSequence(root));assertEventTypes(CONTEXTMENU_SEQ)}function testContextMenuSequenceWithCoordinate(){assertTrue(goog.testing.events.fireContextMenuSequence(root,coordinate));assertEventTypes(CONTEXTMENU_SEQ);assertCoordinates(goog.array.repeat(coordinate,CONTEXTMENU_SEQ.length))}function testContextMenuSequenceCancellingMousedown(){preventDefaultEventType("mousedown");assertFalse(goog.testing.events.fireContextMenuSequence(root));assertEventTypes(CONTEXTMENU_SEQ)}function testContextMenuSequenceCancellingMouseup(){preventDefaultEventType("mouseup");assertFalse(goog.testing.events.fireContextMenuSequence(root));assertEventTypes(CONTEXTMENU_SEQ)}function testContextMenuSequenceCancellingContextMenu(){preventDefaultEventType("contextmenu");assertFalse(goog.testing.events.fireContextMenuSequence(root));assertEventTypes(CONTEXTMENU_SEQ)}function testContextMenuSequenceFakeMacWebkit(){stubs.set(goog.userAgent,"WINDOWS",!1);stubs.set(goog.userAgent,"MAC",!0);stubs.set(goog.userAgent,"WEBKIT",!0);assertTrue(goog.testing.events.fireContextMenuSequence(root));assertEventTypes(["mousedown","contextmenu","mouseup","click"])}function testCaptureBubble_simple(){assertTrue(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:1,childBubble:1,parentBubble:1},eventCount)}function testCaptureBubble_preventDefault(){goog.events.listen(childEl,goog.events.EventType.CLICK,function(e){e.preventDefault()});assertFalse(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:1,childBubble:1,parentBubble:1},eventCount)}function testCaptureBubble_stopPropagationParentCapture(){goog.events.listen(parentEl,goog.events.EventType.CLICK,function(e){e.stopPropagation()},!0);assertTrue(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:0,childBubble:0,parentBubble:0},eventCount)}function testCaptureBubble_stopPropagationChildCapture(){goog.events.listen(childEl,goog.events.EventType.CLICK,function(e){e.stopPropagation()},!0);assertTrue(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:1,childBubble:0,parentBubble:0},eventCount)}function testCaptureBubble_stopPropagationChildBubble(){goog.events.listen(childEl,goog.events.EventType.CLICK,function(e){e.stopPropagation()});assertTrue(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:1,childBubble:1,parentBubble:0},eventCount)}function testCaptureBubble_stopPropagationParentBubble(){goog.events.listen(parentEl,goog.events.EventType.CLICK,function(e){e.stopPropagation()});assertTrue(goog.testing.events.fireClickEvent(childEl));assertObjectEquals({parentCapture:1,childCapture:1,childBubble:1,parentBubble:1},eventCount)}function testMixinListenable(){var obj={doFoo:goog.testing.recordFunction()};goog.testing.events.mixinListenable(obj);obj.doFoo();assertEquals(1,obj.doFoo.getCallCount());var handler=goog.testing.recordFunction();goog.events.listen(obj,"test",handler);obj.dispatchEvent("test");assertEquals(1,handler.getCallCount());assertEquals(obj,handler.getLastCall().getArgument(0).target);goog.events.unlisten(obj,"test",handler);obj.dispatchEvent("test");assertEquals(1,handler.getCallCount());goog.events.listen(obj,"test",handler);obj.dispose();obj.dispatchEvent("test");assertEquals(1,handler.getCallCount())}function assertEventTypes(list){assertArrayEquals(list,firedEventTypes)}function assertCoordinates(list){assertArrayEquals(list,firedEventCoordinates);assertArrayEquals(list,firedScreenCoordinates)}function preventDefaultEventType(type){goog.events.listen(root,type,preventDefault)}function preventDefault(e){e.preventDefault()}