goog.provide("goog.ui.ac.AutoCompleteTest");goog.setTestOnly("goog.ui.ac.AutoCompleteTest");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.Role");goog.require("goog.dom");goog.require("goog.dom.InputType");goog.require("goog.dom.TagName");goog.require("goog.events.EventHandler");goog.require("goog.events.EventTarget");goog.require("goog.string");goog.require("goog.testing.MockControl");goog.require("goog.testing.events");goog.require("goog.testing.jsunit");goog.require("goog.testing.mockmatchers");goog.require("goog.ui.ac.AutoComplete");goog.require("goog.ui.ac.InputHandler");goog.require("goog.ui.ac.RenderOptions");goog.require("goog.ui.ac.Renderer");function MockDS(opt_autoHilite){this.autoHilite_=opt_autoHilite;var disabledRow={match:function(str){return this.text.match(str)},rowDisabled:!0,text:"hello@u.edu"};this.rows_=["\"Slartibartfast Theadore\" <fjordmaster@magrathea.com>","\"Zaphod Beeblebrox\" <theprez@universe.gov>","\"Ford Prefect\" <ford@theguide.com>","\"Arthur Dent\" <has.no.tea@gmail.com>","\"Marvin The Paranoid Android\" <marv@googlemail.com>","the.mice@magrathea.com","the.mice@myotherdomain.com","hello@a.com",disabledRow,"row@u.edu","person@a.edu"];this.isRowDisabled=function(row){return!!row.rowDisabled}}MockDS.prototype.requestMatchingRows=function(token,maxMatches,matchHandler){for(var escapedToken=goog.string.regExpEscape(token),matcher=new RegExp("(^|\\W+)"+escapedToken),matches=[],i=0,row;i<this.rows_.length&&matches.length<maxMatches;++i){row=this.rows_[i];if(row.match(matcher)){matches.push(row)}}if(this.autoHilite_===void 0){matchHandler(token,matches)}else{var options=new goog.ui.ac.RenderOptions;options.setAutoHilite(this.autoHilite_);matchHandler(token,matches,options)}};function MockSelect(){}goog.inherits(MockSelect,goog.events.EventTarget);MockSelect.prototype.selectRow=function(row){this.selectedRow=row};function TestRend(){goog.ui.ac.Renderer.call(this,goog.dom.getElement("test-area"))}goog.inherits(TestRend,goog.ui.ac.Renderer);TestRend.prototype.getRenderedRows=function(){return this.rows_};TestRend.prototype.getHilitedRowIndex=function(){return this.hilitedRow_};TestRend.prototype.getHilitedRowDiv=function(){return this.rowDivs_[this.hilitedRow_]};TestRend.prototype.getRowDiv=function(index){return this.rowDivs_[index]};var handler,inputElement,mockControl;function setUp(){inputElement=goog.dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT});handler=new goog.events.EventHandler;mockControl=new goog.testing.MockControl}function tearDown(){handler.dispose();mockControl.$tearDown();goog.dom.removeChildren(goog.dom.getElement("test-area"))}function testMaxMatches(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setMaxMatches(2);ac.setToken("the");assertEquals(2,rend.getRenderedRows().length);ac.setToken("");ac.setMaxMatches(3);ac.setToken("the");assertEquals(3,rend.getRenderedRows().length);ac.setToken("");ac.setMaxMatches(1e3);ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);ac.setToken("")}function testHiliteViaMouse(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,updates=0,row=null,rowNode=null;handler.listen(rend,goog.ui.ac.AutoComplete.EventType.ROW_HILITE,function(evt){updates++;rowNode=evt.rowNode});var ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setMaxMatches(4);ac.setToken("the");rend.startRenderingRows_=-1;var hilitedRowDiv=rend.getRowDiv(3);goog.testing.events.fireMouseOverEvent(hilitedRowDiv);assertEquals(2,updates);assertTrue(goog.string.contains(rowNode.innerHTML,"mice@myotherdomain.com"))}function testMouseClickBeforeHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setMaxMatches(4);ac.setToken("the");rend.startRenderingRows_=-1;var hilitedRowDiv=rend.getRowDiv(3);goog.testing.events.fireMouseOverEvent(hilitedRowDiv);var targetRowDiv=rend.getRowDiv(2);goog.testing.events.fireClickEvent(targetRowDiv);assertEquals("the.mice@magrathea.com",select.selectedRow)}function testMouseClickOnFirstRowBeforeHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAutoHilite(!1);ac.setMaxMatches(4);ac.setToken("the");var targetRowDiv=rend.getRowDiv(0);goog.testing.events.fireClickEvent(targetRowDiv);assertEquals("\"Zaphod Beeblebrox\" <theprez@universe.gov>",select.selectedRow)}function testMouseClickOnRowAfterBlur(){var ds=new MockDS,rend=new TestRend,ih=new goog.ui.ac.InputHandler;ih.attachInput(inputElement);var ac=new goog.ui.ac.AutoComplete(ds,rend,ih);goog.testing.events.fireFocusEvent(inputElement);ac.setToken("the");var targetRowDiv=rend.getRowDiv(0);goog.testing.events.fireBlurEvent(inputElement);assertNotThrows(function(){goog.testing.events.fireClickEvent(targetRowDiv)})}function testSelectEventEmptyRow(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setMaxMatches(4);ac.setToken("the");rend.startRenderingRows_=-1;var hilitedRowDiv=rend.getRowDiv(2);goog.testing.events.fireMouseOverEvent(hilitedRowDiv);assertUndefined(select.selectedRow);rend.dispatchEvent({type:goog.ui.ac.AutoComplete.EventType.SELECT,row:""});assertEquals("the.mice@magrathea.com",select.selectedRow)}function testSuggestionsUpdateEvent(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),updates=0;handler.listen(ac,goog.ui.ac.AutoComplete.EventType.SUGGESTIONS_UPDATE,function(){updates++});ac.setToken("the");assertEquals(1,updates);ac.setToken("beeb");assertEquals(2,updates);ac.setToken("ford");assertEquals(3,updates);ac.dismiss();assertEquals(4,updates);ac.setToken("dent");assertEquals(5,updates)}function checkHilitedIndex(renderer,index){assertEquals(index,renderer.getHilitedRowIndex())}function testGetRowCount(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);assertEquals(0,ac.getRowCount());ac.setToken("Zaphod");assertEquals(1,ac.getRowCount());ac.setMaxMatches(2);ac.setToken("the");assertEquals(2,ac.getRowCount())}function testHiliteNextPrev_default(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),updates=0;handler.listen(rend,goog.ui.ac.AutoComplete.EventType.ROW_HILITE,function(){updates++});ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hilitePrev();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,0)}assertEquals(21,updates)}function testHiliteNextPrevWithDisabledFirstRow_default(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),updates=0;handler.listen(rend,goog.ui.ac.AutoComplete.EventType.ROW_HILITE,function(){updates++});ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(3);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("edu");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,1)}assertEquals(9,updates)}function testHiliteNextPrevWithDisabledMiddleRow_default(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),updates=0;handler.listen(rend,goog.ui.ac.AutoComplete.EventType.ROW_HILITE,function(){updates++});ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(3);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("u");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,0)}assertEquals(9,updates)}function testHiliteNextPrevWithDisabledLastRow_default(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),updates=0;handler.listen(rend,goog.ui.ac.AutoComplete.EventType.ROW_HILITE,function(){updates++});ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(3);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("h");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,0)}assertEquals(9,updates)}function testHiliteNextPrev_allowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1)}}function testHiliteNextPrevWithDisabledFirstRow_allowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("edu");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,-1)}}function testHiliteNextPrevWithDisabledMiddleRow_allowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("u");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1)}}function testHiliteNextPrevWithDisabledLastRow_allowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("h");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1)}}function testHiliteNextPrev_wrap(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,3)}}function testHiliteNextPrevWithDisabledFirstRow_wrap(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("edu");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledMiddleRow_wrap(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("u");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledLastRow_wrap(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("h");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,1)}}function testHiliteNextPrev_wrapAndAllowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,3)}}function testHiliteNextPrevWithDisabledFirstRow_wrapAndAllowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("edu");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledMiddleRow_wrapAndAllowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("u");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledLastRow_wrapAndAllowFreeSelect(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("h");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,1)}}function testHiliteNextPrev_wrapAndAllowFreeSelectNoAutoHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!1);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,3);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,3)}}function testHiliteNextPrevWithDisabledFirstRow_wrapAndAllowFreeSelectNoAutoHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!1);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("edu");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledMiddleRow_wrapAndAllowFreeSelectNoAutoHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!1);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("u");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,2);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,2)}}function testHiliteNextPrevWithDisabledLastRow_wrapAndAllowFreeSelectNoAutoHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!1);ac.hiliteNext();ac.hilitePrev();ac.setMaxMatches(4);assertEquals(0,rend.getRenderedRows().length);for(var i=0;3>i;++i){ac.setToken("");ac.setToken("h");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hiliteNext();checkHilitedIndex(rend,-1);ac.hiliteNext();checkHilitedIndex(rend,0);ac.hiliteNext();checkHilitedIndex(rend,1);ac.hilitePrev();checkHilitedIndex(rend,0);ac.hilitePrev();checkHilitedIndex(rend,-1);ac.hilitePrev();checkHilitedIndex(rend,1)}}function testHiliteWithChangingNumberOfRows(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setAutoHilite(!0);ac.setMaxMatches(4);ac.setToken("m");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.setToken("ma");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);var id=rend.getRenderedRows()[1].id;ac.hiliteId(id);ac.setToken("mar");assertEquals(1,rend.getRenderedRows().length);checkHilitedIndex(rend,0);ac.setToken("ma");assertEquals(3,rend.getRenderedRows().length);checkHilitedIndex(rend,0);var id=rend.getRenderedRows()[1].id;ac.hiliteId(id);ac.setToken("m");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0)}function testNoAutoHiliteWhenTokenIsEmpty(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!0);ac.setMaxMatches(4);ac.setToken("");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0)}function testPreserveHilitedWithoutAutoHilite(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setMaxMatches(4);ac.setAutoHilite(!1);ac.setToken("m");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,-1);var id=rend.getRenderedRows()[1].id;ac.hiliteId(id);checkHilitedIndex(rend,1);ac.renderRows(rend.getRenderedRows(),!0);checkHilitedIndex(rend,1);ac.renderRows(rend.getRenderedRows());checkHilitedIndex(rend,-1)}function testAutoHiliteFromMatcherTrue(){var ds=new MockDS(!0),rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!1);ac.setMaxMatches(4);ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,0)}function testAutoHiliteFromMatcherFalse(){var ds=new MockDS(!1),rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setWrap(!0);ac.setAllowFreeSelect(!0);ac.setAutoHilite(!0);ac.setMaxMatches(4);ac.setToken("the");assertEquals(4,rend.getRenderedRows().length);checkHilitedIndex(rend,-1)}function testHiliteId(){for(var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),i=0;3>i;++i){ac.setToken("m");assertEquals(4,rend.getRenderedRows().length);for(var x=0,id;4>x;++x){id=rend.getRenderedRows()[x].id;ac.hiliteId(id);assertEquals(ac.getIdOfIndex_(x),id)}}}function testSelection(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac;ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setToken("m");ac.selectHilited();assertEquals("\"Slartibartfast Theadore\" <fjordmaster@magrathea.com>",select.selectedRow);ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setToken("the");ac.hiliteNext();ac.selectHilited();assertEquals("\"Ford Prefect\" <ford@theguide.com>",select.selectedRow)}function testDismiss(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),dismissed=0;handler.listen(ac,goog.ui.ac.AutoComplete.EventType.DISMISS,function(){dismissed++});ac.dismiss();assertEquals(1,dismissed);ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setToken("sir not seen in this picture");ac.dismiss();ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setToken("t");ac.dismiss()}function testTriggerSuggestionsOnUpdate(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select),dismissCalled=0;rend.dismiss=function(){dismissCalled++};var updateCalled=0;select.update=function(opt_force){updateCalled++};ac.setToken("the");ac.selectHilited();assertEquals(1,dismissCalled);assertEquals(0,updateCalled);ac.setTriggerSuggestionsOnUpdate(!0);ac.setToken("the");ac.selectHilited();assertEquals(1,dismissCalled);assertEquals(1,updateCalled)}function testDispose(){var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setToken("the");ac.dispose()}function testRolesAndStates(){function checkActiveDescendant(activeDescendant){assertNotNull(inputElement);assertEquals(goog.a11y.aria.getActiveDescendant(inputElement),activeDescendant)}function checkRole(el,role){assertNotNull(el);assertEquals(goog.a11y.aria.getRole(el),role)}var ds=new MockDS,rend=new TestRend,select=new MockSelect,ac=new goog.ui.ac.AutoComplete(ds,rend,select);ac.setTarget(inputElement);checkActiveDescendant(null);ac.setToken("");ac.setToken("the");ac.hiliteNext();checkActiveDescendant(rend.getHilitedRowDiv());checkRole(rend.getHilitedRowDiv(),goog.a11y.aria.Role.OPTION);ac.dismiss();checkActiveDescendant(null)}function testAttachInputWithAnchor(){var anchorElement=goog.dom.createDom(goog.dom.TagName.DIV,null,inputElement),mockRenderer=mockControl.createLooseMock(goog.ui.ac.Renderer,!0);mockRenderer.setAnchorElement(anchorElement);var ignore=goog.testing.mockmatchers.ignoreArgument;mockRenderer.renderRows(ignore,ignore,inputElement);var mockInputHandler=mockControl.createLooseMock(goog.ui.ac.InputHandler,!0);mockInputHandler.attachInputs(inputElement);mockControl.$replayAll();var autoComplete=new goog.ui.ac.AutoComplete(null,mockRenderer,mockInputHandler);autoComplete.attachInputWithAnchor(inputElement,anchorElement);autoComplete.setTarget(inputElement);autoComplete.renderRows(["abc","def"]);mockControl.$verifyAll()}function testDetachInputWithAnchor(){var mockRenderer=mockControl.createLooseMock(goog.ui.ac.Renderer,!0),mockInputHandler=mockControl.createLooseMock(goog.ui.ac.InputHandler,!0),anchorElement=goog.dom.createDom(goog.dom.TagName.DIV,null,inputElement),inputElement2=goog.dom.createDom(goog.dom.TagName.INPUT,{type:goog.dom.InputType.TEXT}),anchorElement2=goog.dom.createDom(goog.dom.TagName.DIV,null,inputElement2);mockControl.$replayAll();var autoComplete=new goog.ui.ac.AutoComplete(null,mockRenderer,mockInputHandler);autoComplete.attachInputWithAnchor(inputElement,anchorElement);autoComplete.attachInputWithAnchor(inputElement2,anchorElement2);autoComplete.detachInputs(inputElement,inputElement2);assertFalse(goog.getUid(inputElement)in autoComplete.inputToAnchorMap_);assertFalse(goog.getUid(inputElement2)in autoComplete.inputToAnchorMap_);mockControl.$verifyAll()}