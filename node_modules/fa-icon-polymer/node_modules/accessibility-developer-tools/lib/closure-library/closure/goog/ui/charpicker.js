goog.provide("goog.ui.CharPicker");goog.require("goog.a11y.aria");goog.require("goog.a11y.aria.State");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.dom");goog.require("goog.dom.TagName");goog.require("goog.dom.classlist");goog.require("goog.events");goog.require("goog.events.Event");goog.require("goog.events.EventHandler");goog.require("goog.events.EventType");goog.require("goog.events.InputHandler");goog.require("goog.events.KeyCodes");goog.require("goog.events.KeyHandler");goog.require("goog.i18n.CharListDecompressor");goog.require("goog.i18n.uChar");goog.require("goog.structs.Set");goog.require("goog.style");goog.require("goog.ui.Button");goog.require("goog.ui.Component");goog.require("goog.ui.ContainerScroller");goog.require("goog.ui.FlatButtonRenderer");goog.require("goog.ui.HoverCard");goog.require("goog.ui.LabelInput");goog.require("goog.ui.Menu");goog.require("goog.ui.MenuButton");goog.require("goog.ui.MenuItem");goog.require("goog.ui.Tooltip");goog.ui.CharPicker=function(charPickerData,charNameFetcher,opt_recents,opt_initCategory,opt_initSubcategory,opt_rowCount,opt_columnCount,opt_domHelper){goog.ui.Component.call(this,opt_domHelper);this.charNameFetcher_=charNameFetcher;this.data_=charPickerData;this.initCategory_=opt_initCategory||0;this.initSubcategory_=opt_initSubcategory||0;this.columnCount_=opt_columnCount||10;this.gridsize_=(opt_rowCount||10)*this.columnCount_;this.recentwidth_=this.columnCount_+1;this.recents_=opt_recents||[];this.eventHandler_=new goog.events.EventHandler(this);this.decompressor_=new goog.i18n.CharListDecompressor};goog.inherits(goog.ui.CharPicker,goog.ui.Component);goog.ui.CharPicker.prototype.selectedChar_=null;goog.ui.CharPicker.prototype.layoutAlteringChars_=null;goog.ui.CharPicker.prototype.menu_=null;goog.ui.CharPicker.prototype.menubutton_=null;goog.ui.CharPicker.prototype.submenu_=null;goog.ui.CharPicker.prototype.submenubutton_=null;goog.ui.CharPicker.prototype.itempos;goog.ui.CharPicker.prototype.items;goog.ui.CharPicker.prototype.keyHandler_;goog.ui.CharPicker.prototype.category;goog.ui.CharPicker.prototype.stick_=null;goog.ui.CharPicker.prototype.stickwrap_=null;goog.ui.CharPicker.prototype.grid_=null;goog.ui.CharPicker.prototype.notice_=null;goog.ui.CharPicker.prototype.recentgrid_=null;goog.ui.CharPicker.prototype.input_=null;goog.ui.CharPicker.prototype.okbutton_=null;goog.ui.CharPicker.prototype.charNameEl_=null;goog.ui.CharPicker.prototype.zoomEl_=null;goog.ui.CharPicker.prototype.unicodeEl_=null;goog.ui.CharPicker.prototype.hc_=null;goog.ui.CharPicker.prototype.getSelectedChar=function(){return this.selectedChar_};goog.ui.CharPicker.prototype.getRecentChars=function(){return this.recents_};goog.ui.CharPicker.prototype.createDom=function(){goog.ui.CharPicker.superClass_.createDom.call(this);this.decorateInternal(this.getDomHelper().createElement(goog.dom.TagName.DIV))};goog.ui.CharPicker.prototype.disposeInternal=function(){goog.dispose(this.hc_);this.hc_=null;goog.dispose(this.eventHandler_);this.eventHandler_=null;goog.ui.CharPicker.superClass_.disposeInternal.call(this)};goog.ui.CharPicker.prototype.decorateInternal=function(element){goog.ui.CharPicker.superClass_.decorateInternal.call(this,element);var chrs=this.decompressor_.toCharList(":2%C^O80V1H2s2G40Q%s0");this.layoutAlteringChars_=new goog.structs.Set(chrs);this.menu_=new goog.ui.Menu(this.getDomHelper());for(var categories=this.data_.categories,i=0;i<this.data_.categories.length;i++){this.menu_.addChild(this.createMenuItem_(i,categories[i]),!0)}this.menubutton_=new goog.ui.MenuButton("Category Menu",this.menu_,void 0,this.getDomHelper());this.addChild(this.menubutton_,!0);this.submenu_=new goog.ui.Menu(this.getDomHelper());this.submenubutton_=new goog.ui.MenuButton("Subcategory Menu",this.submenu_,void 0,this.getDomHelper());this.addChild(this.submenubutton_,!0);var gridcontainer=new goog.ui.Component(this.getDomHelper());this.addChild(gridcontainer,!0);var stickwrap=new goog.ui.Component(this.getDomHelper());gridcontainer.addChild(stickwrap,!0);this.stickwrap_=stickwrap.getElement();var stick=new goog.ui.Component(this.getDomHelper());stickwrap.addChild(stick,!0);this.stick_=stick.getElement();this.grid_=new goog.ui.Component(this.getDomHelper());gridcontainer.addChild(this.grid_,!0);this.notice_=new goog.ui.Component(this.getDomHelper());this.notice_.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.DIV));this.addChild(this.notice_,!0);var MSG_CHAR_PICKER_RECENT_SELECTIONS=goog.getMsg("Recent Selections:"),recenttext=new goog.ui.Component(this.getDomHelper());recenttext.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,MSG_CHAR_PICKER_RECENT_SELECTIONS));this.addChild(recenttext,!0);this.recentgrid_=new goog.ui.Component(this.getDomHelper());this.addChild(this.recentgrid_,!0);var uplus=new goog.ui.Component(this.getDomHelper());uplus.setElementInternal(this.getDomHelper().createDom(goog.dom.TagName.SPAN,null,"U+"));this.addChild(uplus,!0);var MSG_CHAR_PICKER_HEX_INPUT=goog.getMsg("Hex Input");this.input_=new goog.ui.LabelInput(MSG_CHAR_PICKER_HEX_INPUT,this.getDomHelper());this.addChild(this.input_,!0);this.okbutton_=new goog.ui.Button("OK",void 0,this.getDomHelper());this.addChild(this.okbutton_,!0);this.okbutton_.setEnabled(!1);this.zoomEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"zoom",className:goog.getCssName("goog-char-picker-char-zoom")});this.charNameEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"charName",className:goog.getCssName("goog-char-picker-name")});this.unicodeEl_=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"unicode",className:goog.getCssName("goog-char-picker-unicode")});var card=this.getDomHelper().createDom(goog.dom.TagName.DIV,{id:"preview"},this.zoomEl_,this.charNameEl_,this.unicodeEl_);goog.style.setElementShown(card,!1);this.hc_=new goog.ui.HoverCard({DIV:"char"},void 0,this.getDomHelper());this.hc_.setElement(card);var self=this;function onBeforeShow(){var trigger=self.hc_.getAnchorElement(),ch=self.getChar_(trigger);if(ch){goog.dom.setTextContent(self.zoomEl_,self.displayChar_(ch));goog.dom.setTextContent(self.unicodeEl_,goog.i18n.uChar.toHexString(ch));goog.dom.setTextContent(self.charNameEl_,"");self.charNameFetcher_.getName(ch,function(charName){if(charName){goog.dom.setTextContent(self.charNameEl_,charName)}})}}goog.events.listen(this.hc_,goog.ui.HoverCard.EventType.BEFORE_SHOW,onBeforeShow);goog.asserts.assert(element);goog.dom.classlist.add(element,goog.getCssName("goog-char-picker"));goog.dom.classlist.add(goog.asserts.assert(this.stick_),goog.getCssName("goog-stick"));goog.dom.classlist.add(goog.asserts.assert(this.stickwrap_),goog.getCssName("goog-stickwrap"));goog.dom.classlist.add(goog.asserts.assert(gridcontainer.getElement()),goog.getCssName("goog-char-picker-grid-container"));goog.dom.classlist.add(goog.asserts.assert(this.grid_.getElement()),goog.getCssName("goog-char-picker-grid"));goog.dom.classlist.add(goog.asserts.assert(this.recentgrid_.getElement()),goog.getCssName("goog-char-picker-grid"));goog.dom.classlist.add(goog.asserts.assert(this.recentgrid_.getElement()),goog.getCssName("goog-char-picker-recents"));goog.dom.classlist.add(goog.asserts.assert(this.notice_.getElement()),goog.getCssName("goog-char-picker-notice"));goog.dom.classlist.add(goog.asserts.assert(uplus.getElement()),goog.getCssName("goog-char-picker-uplus"));goog.dom.classlist.add(goog.asserts.assert(this.input_.getElement()),goog.getCssName("goog-char-picker-input-box"));goog.dom.classlist.add(goog.asserts.assert(this.okbutton_.getElement()),goog.getCssName("goog-char-picker-okbutton"));goog.dom.classlist.add(goog.asserts.assert(card),goog.getCssName("goog-char-picker-hovercard"));this.hc_.className=goog.getCssName("goog-char-picker-hovercard");this.grid_.buttoncount=this.gridsize_;this.recentgrid_.buttoncount=this.recentwidth_;this.populateGridWithButtons_(this.grid_);this.populateGridWithButtons_(this.recentgrid_);this.updateGrid_(this.recentgrid_,this.recents_);this.setSelectedCategory_(this.initCategory_,this.initSubcategory_);new goog.ui.ContainerScroller(this.menu_);new goog.ui.ContainerScroller(this.submenu_);goog.dom.classlist.add(goog.asserts.assert(this.menu_.getElement()),goog.getCssName("goog-char-picker-menu"));goog.dom.classlist.add(goog.asserts.assert(this.submenu_.getElement()),goog.getCssName("goog-char-picker-menu"))};goog.ui.CharPicker.prototype.enterDocument=function(){goog.ui.CharPicker.superClass_.enterDocument.call(this);var inputkh=new goog.events.InputHandler(this.input_.getElement());this.keyHandler_=new goog.events.KeyHandler(this.input_.getElement());this.eventHandler_.listen(this.menubutton_,goog.ui.Component.EventType.ACTION,goog.events.Event.stopPropagation).listen(this.submenubutton_,goog.ui.Component.EventType.ACTION,goog.events.Event.stopPropagation).listen(this,goog.ui.Component.EventType.ACTION,this.handleSelectedItem_,!0).listen(inputkh,goog.events.InputHandler.EventType.INPUT,this.handleInput_).listen(this.keyHandler_,goog.events.KeyHandler.EventType.KEY,this.handleEnter_).listen(this.recentgrid_,goog.ui.Component.EventType.FOCUS,this.handleFocus_).listen(this.grid_,goog.ui.Component.EventType.FOCUS,this.handleFocus_);goog.events.listen(this.okbutton_.getElement(),goog.events.EventType.MOUSEDOWN,this.handleOkClick_,!0,this);goog.events.listen(this.stickwrap_,goog.events.EventType.SCROLL,this.handleScroll_,!0,this)};goog.ui.CharPicker.prototype.handleFocus_=function(e){var button=e.target,element=button.getElement(),ch=this.getChar_(element);goog.a11y.aria.setState(element,goog.a11y.aria.State.LABEL,"");if(ch){this.charNameFetcher_.getName(ch,function(charName){if(charName){goog.a11y.aria.setState(element,goog.a11y.aria.State.LABEL,charName)}})}};goog.ui.CharPicker.prototype.handleScroll_=function(e){var height=e.target.scrollHeight,top=e.target.scrollTop,itempos=Math.ceil(top*this.items.length/(this.columnCount_*height))*this.columnCount_;if(this.itempos!=itempos){this.itempos=itempos;this.modifyGridWithItems_(this.grid_,this.items,itempos)}e.stopPropagation()};goog.ui.CharPicker.prototype.handleSelectedItem_=function(e){var parent=e.target.getParent();if(parent==this.menu_){this.menu_.setVisible(!1);this.setSelectedCategory_(e.target.getValue())}else if(parent==this.submenu_){this.submenu_.setVisible(!1);this.setSelectedSubcategory_(e.target.getValue())}else if(parent==this.grid_){var button=e.target.getElement();this.selectedChar_=this.getChar_(button);this.updateRecents_(this.selectedChar_)}else if(parent==this.recentgrid_){this.selectedChar_=this.getChar_(e.target.getElement())}};goog.ui.CharPicker.prototype.handleInput_=function(e){var ch=this.getInputChar();if(ch){goog.dom.setTextContent(this.zoomEl_,ch);goog.dom.setTextContent(this.unicodeEl_,goog.i18n.uChar.toHexString(ch));goog.dom.setTextContent(this.charNameEl_,"");var coord=new goog.ui.Tooltip.ElementTooltipPosition(this.input_.getElement());this.hc_.setPosition(coord);this.hc_.triggerForElement(this.input_.getElement());this.okbutton_.setEnabled(!0)}else{this.hc_.cancelTrigger();this.hc_.setVisible(!1);this.okbutton_.setEnabled(!1)}};goog.ui.CharPicker.prototype.handleOkClick_=function(opt_event){var ch=this.getInputChar();if(ch&&ch.charCodeAt(0)){this.selectedChar_=ch;this.updateRecents_(ch);return!0}return!1};goog.ui.CharPicker.prototype.handleEnter_=function(e){if(e.keyCode==goog.events.KeyCodes.ENTER){return this.handleOkClick_()?this.dispatchEvent(goog.ui.Component.EventType.ACTION):!1}return!1};goog.ui.CharPicker.prototype.getChar_=function(e){return e.getAttribute("char")};goog.ui.CharPicker.prototype.createMenuItem_=function(id,caption){var item=new goog.ui.MenuItem(caption,id,this.getDomHelper());item.setVisible(!0);return item};goog.ui.CharPicker.prototype.setSelectedCategory_=function(category,opt_subcategory){this.category=category;this.menubutton_.setCaption(this.data_.categories[category]);while(this.submenu_.hasChildren()){this.submenu_.removeChildAt(0,!0).dispose()}for(var subcategories=this.data_.subcategories[category],charList=this.data_.charList[category],i=0,item;i<subcategories.length;i++){item=this.createMenuItem_(i,subcategories[i]);this.submenu_.addChild(item,!0)}this.setSelectedSubcategory_(opt_subcategory||0)};goog.ui.CharPicker.prototype.setSelectedSubcategory_=function(subcategory){var subcategories=this.data_.subcategories,name=subcategories[this.category][subcategory];this.submenubutton_.setCaption(name);this.setSelectedGrid_(this.category,subcategory)};goog.ui.CharPicker.prototype.setSelectedGrid_=function(category,subcategory){var charLists=this.data_.charList,charListStr=charLists[category][subcategory],content=this.decompressor_.toCharList(charListStr);this.charNameFetcher_.prefetch(charListStr);this.updateGrid_(this.grid_,content)};goog.ui.CharPicker.prototype.updateGrid_=function(grid,items){if(grid==this.grid_){var MSG_PLEASE_HOVER=goog.getMsg("Please hover over each cell for the character name.");goog.dom.setTextContent(this.notice_.getElement(),this.charNameFetcher_.isNameAvailable(items[0])?MSG_PLEASE_HOVER:"");this.items=items;if(0<this.stickwrap_.offsetHeight){this.stick_.style.height=this.stickwrap_.offsetHeight*items.length/this.gridsize_+"px"}else{this.stick_.style.height=3*this.columnCount_*items.length/this.gridsize_+"em"}this.stickwrap_.scrollTop=0}this.modifyGridWithItems_(grid,items,0)};goog.ui.CharPicker.prototype.modifyGridWithItems_=function(grid,items,start){for(var buttonpos=0,itempos=start;buttonpos<grid.buttoncount&&itempos<items.length;buttonpos++,itempos++){this.modifyCharNode_(grid.getChildAt(buttonpos),items[itempos])}for(;buttonpos<grid.buttoncount;buttonpos++){grid.getChildAt(buttonpos).setVisible(!1)}};goog.ui.CharPicker.prototype.populateGridWithButtons_=function(grid){for(var i=0,button;i<grid.buttoncount;i++){button=new goog.ui.Button(" ",goog.ui.FlatButtonRenderer.getInstance(),this.getDomHelper());button.setDispatchTransitionEvents(goog.ui.Component.State.FOCUSED,!0);grid.addChild(button,!0);button.setVisible(!1);var buttonEl=button.getElement();goog.asserts.assert(buttonEl,"The button DOM element cannot be null.");goog.a11y.aria.removeRole(buttonEl)}};goog.ui.CharPicker.prototype.modifyCharNode_=function(button,ch){var text=this.displayChar_(ch),buttonEl=button.getElement();goog.dom.setTextContent(buttonEl,text);buttonEl.setAttribute("char",ch);button.setVisible(!0)};goog.ui.CharPicker.prototype.updateRecents_=function(character){if(character&&character.charCodeAt(0)&&!goog.array.contains(this.recents_,character)){this.recents_.unshift(character);if(this.recents_.length>this.recentwidth_){this.recents_.pop()}this.updateGrid_(this.recentgrid_,this.recents_)}};goog.ui.CharPicker.prototype.getInputChar=function(){var text=this.input_.getValue(),code=parseInt(text,16);return goog.i18n.uChar.fromCharCode(code)};goog.ui.CharPicker.prototype.displayChar_=function(ch){return this.layoutAlteringChars_.contains(ch)?"\xA0":ch};