goog.provide("goog.net.FetchXmlHttp");goog.provide("goog.net.FetchXmlHttpFactory");goog.require("goog.asserts");goog.require("goog.events.EventTarget");goog.require("goog.functions");goog.require("goog.log");goog.require("goog.net.XhrLike");goog.require("goog.net.XmlHttpFactory");goog.net.FetchXmlHttpFactory=function(worker){goog.net.FetchXmlHttpFactory.base(this,"constructor");this.worker_=worker;this.credentialsMode_=void 0;this.cacheMode_=void 0};goog.inherits(goog.net.FetchXmlHttpFactory,goog.net.XmlHttpFactory);goog.net.FetchXmlHttpFactory.prototype.createInstance=function(){var instance=new goog.net.FetchXmlHttp(this.worker_);if(this.credentialsMode_){instance.setCredentialsMode(this.credentialsMode_)}if(this.cacheMode_){instance.setCacheMode(this.cacheMode_)}return instance};goog.net.FetchXmlHttpFactory.prototype.internalGetOptions=goog.functions.constant({});goog.net.FetchXmlHttpFactory.prototype.setCredentialsMode=function(credentialsMode){this.credentialsMode_=credentialsMode};goog.net.FetchXmlHttpFactory.prototype.setCacheMode=function(cacheMode){this.cacheMode_=cacheMode};goog.net.FetchXmlHttp=function(worker){goog.net.FetchXmlHttp.base(this,"constructor");this.worker_=worker;this.credentialsMode_=void 0;this.cacheMode_=void 0;this.readyState=goog.net.FetchXmlHttp.RequestState.UNSENT;this.status=0;this.statusText="";this.responseText="";this.responseXML=null;this.onreadystatechange=null;this.requestHeaders_=new Headers;this.responseHeaders_=null;this.method_="GET";this.url_="";this.inProgress_=!1;this.logger_=goog.log.getLogger("goog.net.FetchXmlHttp")};goog.inherits(goog.net.FetchXmlHttp,goog.events.EventTarget);goog.net.FetchXmlHttp.RequestState={UNSENT:0,OPENED:1,HEADER_RECEIVED:2,LOADING:3,DONE:4};goog.net.FetchXmlHttp.prototype.open=function(method,url,opt_async){goog.asserts.assert(!!opt_async,"Only async requests are supported.");if(this.readyState!=goog.net.FetchXmlHttp.RequestState.UNSENT){this.abort();throw Error("Error reopening a connection")}this.method_=method;this.url_=url;this.readyState=goog.net.FetchXmlHttp.RequestState.OPENED;this.dispatchCallback_()};goog.net.FetchXmlHttp.prototype.send=function(opt_data){if(this.readyState!=goog.net.FetchXmlHttp.RequestState.OPENED){this.abort();throw Error("need to call open() first. ")}this.inProgress_=!0;var requestInit={headers:this.requestHeaders_,method:this.method_,credentials:this.credentialsMode_,cache:this.cacheMode_};if(opt_data){requestInit.body=opt_data}this.worker_.fetch(new Request(this.url_,requestInit)).then(this.handleResponse_.bind(this),this.handleSendFailure_.bind(this))};goog.net.FetchXmlHttp.prototype.abort=function(){this.responseText="";this.requestHeaders_=new Headers;this.status=0;if(this.readyState>=goog.net.FetchXmlHttp.RequestState.OPENED&&this.inProgress_&&this.readyState!=goog.net.FetchXmlHttp.RequestState.DONE){this.readyState=goog.net.FetchXmlHttp.RequestState.DONE;this.inProgress_=!1;this.dispatchCallback_()}this.readyState=goog.net.FetchXmlHttp.RequestState.UNSENT};goog.net.FetchXmlHttp.prototype.handleResponse_=function(response){if(!this.inProgress_){return}if(!this.responseHeaders_){this.responseHeaders_=response.headers;this.readyState=goog.net.FetchXmlHttp.RequestState.HEADER_RECEIVED;this.dispatchCallback_()}if(!this.inProgress_){return}this.readyState=goog.net.FetchXmlHttp.RequestState.LOADING;this.dispatchCallback_();if(!this.inProgress_){return}response.text().then(this.handleResponseText_.bind(this,response),this.handleSendFailure_.bind(this))};goog.net.FetchXmlHttp.prototype.handleResponseText_=function(response,responseText){if(!this.inProgress_){return}this.status=response.status;this.statusText=response.statusText;this.responseText=responseText;this.readyState=goog.net.FetchXmlHttp.RequestState.DONE;this.dispatchCallback_()};goog.net.FetchXmlHttp.prototype.handleSendFailure_=function(error){var e=error instanceof Error?error:Error(error);goog.log.warning(this.logger_,"Failed to fetch url "+this.url_,e);if(!this.inProgress_){return}this.readyState=goog.net.FetchXmlHttp.RequestState.DONE;this.dispatchCallback_()};goog.net.FetchXmlHttp.prototype.setRequestHeader=function(header,value){this.requestHeaders_.append(header,value)};goog.net.FetchXmlHttp.prototype.getResponseHeader=function(header){return this.responseHeaders_.get(header.toLowerCase())||""};goog.net.FetchXmlHttp.prototype.getAllResponseHeaders=function(){return""};goog.net.FetchXmlHttp.prototype.setCredentialsMode=function(credentialsMode){this.credentialsMode_=credentialsMode};goog.net.FetchXmlHttp.prototype.setCacheMode=function(cacheMode){this.cacheMode_=cacheMode};goog.net.FetchXmlHttp.prototype.dispatchCallback_=function(){if(this.onreadystatechange){this.onreadystatechange.call(this)}};