goog.provide("goog.module.ModuleManager");goog.provide("goog.module.ModuleManager.CallbackType");goog.provide("goog.module.ModuleManager.FailureType");goog.require("goog.Disposable");goog.require("goog.array");goog.require("goog.asserts");goog.require("goog.async.Deferred");goog.require("goog.debug.Trace");goog.require("goog.dispose");goog.require("goog.log");goog.require("goog.module");goog.require("goog.module.AbstractModuleLoader");goog.require("goog.module.ModuleInfo");goog.require("goog.module.ModuleLoadCallback");goog.require("goog.object");goog.module.ModuleManager=function(){goog.module.ModuleManager.base(this,"constructor");this.moduleInfoMap_={};this.loadingModuleIds_=[];this.requestedLoadingModuleIds_=[];this.requestedModuleIds_=[];this.requestedModuleIdsQueue_=[];this.userInitiatedLoadingModuleIds_=[];this.callbackMap_={};this.baseModuleInfo_=new goog.module.ModuleInfo([],"");this.currentlyLoadingModule_=this.baseModuleInfo_;this.lastInitialModuleId_=null;this.initialModulesLoaded_=new goog.async.Deferred;this.logger_=goog.log.getLogger("goog.module.ModuleManager");this.batchModeEnabled_=!1;this.concurrentLoadingEnabled_=!1;this.loader_=null;this.loadTracer_=null;this.consecutiveFailures_=0;this.lastActive_=!1;this.userLastActive_=!1;this.moduleContext_=null};goog.inherits(goog.module.ModuleManager,goog.Disposable);goog.addSingletonGetter(goog.module.ModuleManager);goog.module.ModuleManager.CallbackType={ERROR:"error",IDLE:"idle",ACTIVE:"active",USER_IDLE:"userIdle",USER_ACTIVE:"userActive"};goog.module.ModuleManager.CORRUPT_RESPONSE_STATUS_CODE=8001;goog.module.ModuleManager.prototype.setBatchModeEnabled=function(enabled){this.batchModeEnabled_=enabled};goog.module.ModuleManager.prototype.setConcurrentLoadingEnabled=function(enabled){this.concurrentLoadingEnabled_=enabled};goog.module.ModuleManager.prototype.setAllModuleInfo=function(infoMap){for(var id in infoMap){this.moduleInfoMap_[id]=new goog.module.ModuleInfo(infoMap[id],id)}if(!this.initialModulesLoaded_.hasFired()){this.initialModulesLoaded_.callback()}this.maybeFinishBaseLoad_()};goog.module.ModuleManager.prototype.setAllModuleInfoString=function(opt_info,opt_loadingModuleIds){if(!goog.isString(opt_info)){return}for(var modules=opt_info.split("/"),moduleIds=[],i=0;i<modules.length;i++){var parts=modules[i].split(":"),id=parts[0],deps;if(parts[1]){deps=parts[1].split(",");for(var j=0,index;j<deps.length;j++){index=parseInt(deps[j],36);goog.asserts.assert(moduleIds[index],"No module @ %s, dep of %s @ %s",index,id,i);deps[j]=moduleIds[index]}}else{deps=[]}moduleIds.push(id);this.moduleInfoMap_[id]=new goog.module.ModuleInfo(deps,id)}if(opt_loadingModuleIds&&opt_loadingModuleIds.length){goog.array.extend(this.loadingModuleIds_,opt_loadingModuleIds);this.lastInitialModuleId_=goog.array.peek(opt_loadingModuleIds)}else{if(!this.initialModulesLoaded_.hasFired()){this.initialModulesLoaded_.callback()}}this.maybeFinishBaseLoad_()};goog.module.ModuleManager.prototype.getModuleInfo=function(id){return this.moduleInfoMap_[id]};goog.module.ModuleManager.prototype.setModuleUris=function(moduleUriMap){for(var id in moduleUriMap){this.moduleInfoMap_[id].setUris(moduleUriMap[id])}};goog.module.ModuleManager.prototype.getLoader=function(){return this.loader_};goog.module.ModuleManager.prototype.setLoader=function(loader){this.loader_=loader};goog.module.ModuleManager.prototype.getModuleContext=function(){return this.moduleContext_};goog.module.ModuleManager.prototype.setModuleContext=function(context){this.moduleContext_=context;this.maybeFinishBaseLoad_()};goog.module.ModuleManager.prototype.isActive=function(){return 0<this.loadingModuleIds_.length};goog.module.ModuleManager.prototype.isUserActive=function(){return 0<this.userInitiatedLoadingModuleIds_.length};goog.module.ModuleManager.prototype.dispatchActiveIdleChangeIfNeeded_=function(){var lastActive=this.lastActive_,active=this.isActive();if(active!=lastActive){this.executeCallbacks_(active?goog.module.ModuleManager.CallbackType.ACTIVE:goog.module.ModuleManager.CallbackType.IDLE);this.lastActive_=active}var userLastActive=this.userLastActive_,userActive=this.isUserActive();if(userActive!=userLastActive){this.executeCallbacks_(userActive?goog.module.ModuleManager.CallbackType.USER_ACTIVE:goog.module.ModuleManager.CallbackType.USER_IDLE);this.userLastActive_=userActive}};goog.module.ModuleManager.prototype.preloadModule=function(id,opt_timeout){var d=new goog.async.Deferred;window.setTimeout(goog.bind(this.addLoadModule_,this,id,d),opt_timeout||0);return d};goog.module.ModuleManager.prototype.prefetchModule=function(id){var moduleInfo=this.getModuleInfo(id);if(moduleInfo.isLoaded()||this.isModuleLoading(id)){throw Error("Module load already requested: "+id)}else if(this.batchModeEnabled_){throw Error("Modules prefetching is not supported in batch mode")}else{for(var idWithDeps=this.getNotYetLoadedTransitiveDepIds_(id),i=0;i<idWithDeps.length;i++){this.loader_.prefetchModule(idWithDeps[i],this.moduleInfoMap_[idWithDeps[i]])}}};goog.module.ModuleManager.prototype.addLoadModule_=function(id,d){var moduleInfo=this.getModuleInfo(id);if(moduleInfo.isLoaded()){d.callback(this.moduleContext_);return}this.registerModuleLoadCallbacks_(id,moduleInfo,!1,d);if(!this.isModuleLoading(id)){this.loadModulesOrEnqueue_([id])}};goog.module.ModuleManager.prototype.loadModulesOrEnqueueIfNotLoadedOrLoading_=function(ids,opt_userInitiated){var uniqueIds=[];goog.array.removeDuplicates(ids,uniqueIds);for(var idsToLoad=[],deferredMap={},i=0;i<uniqueIds.length;i++){var id=uniqueIds[i],moduleInfo=this.getModuleInfo(id);if(!moduleInfo){throw new Error("Unknown module: "+id)}var d=new goog.async.Deferred;deferredMap[id]=d;if(moduleInfo.isLoaded()){d.callback(this.moduleContext_)}else{this.registerModuleLoadCallbacks_(id,moduleInfo,!!opt_userInitiated,d);if(!this.isModuleLoading(id)){idsToLoad.push(id)}}}if(0<idsToLoad.length){this.loadModulesOrEnqueue_(idsToLoad)}return deferredMap};goog.module.ModuleManager.prototype.registerModuleLoadCallbacks_=function(id,moduleInfo,userInitiated,d){moduleInfo.registerCallback(d.callback,d);moduleInfo.registerErrback(function(err){d.errback(Error(err))});if(this.isModuleLoading(id)){if(userInitiated){goog.log.info(this.logger_,"User initiated module already loading: "+id);this.addUserInitiatedLoadingModule_(id);this.dispatchActiveIdleChangeIfNeeded_()}}else{if(userInitiated){goog.log.info(this.logger_,"User initiated module load: "+id);this.addUserInitiatedLoadingModule_(id)}else{goog.log.info(this.logger_,"Initiating module load: "+id)}}};goog.module.ModuleManager.prototype.loadModulesOrEnqueue_=function(ids){if(this.concurrentLoadingEnabled_){this.initialModulesLoaded_.addCallback(goog.bind(this.loadModules_,this,ids))}else{if(goog.array.isEmpty(this.loadingModuleIds_)){this.loadModules_(ids)}else{this.requestedModuleIdsQueue_.push(ids);this.dispatchActiveIdleChangeIfNeeded_()}}};goog.module.ModuleManager.prototype.getBackOff_=function(){return 5e3*Math.pow(this.consecutiveFailures_,2)};goog.module.ModuleManager.prototype.loadModules_=function(ids,opt_isRetry,opt_forceReload){if(!opt_isRetry){this.consecutiveFailures_=0}var idsToLoadImmediately=this.processModulesForLoad_(ids);goog.log.info(this.logger_,"Loading module(s): "+idsToLoadImmediately);this.loadingModuleIds_=idsToLoadImmediately;if(this.batchModeEnabled_){this.requestedLoadingModuleIds_=ids}else{this.requestedLoadingModuleIds_=goog.array.clone(idsToLoadImmediately)}this.dispatchActiveIdleChangeIfNeeded_();if(goog.array.isEmpty(idsToLoadImmediately)){return}this.requestedModuleIds_.push.apply(this.requestedModuleIds_,idsToLoadImmediately);var loadFn=goog.bind(this.loader_.loadModules,this.loader_,goog.array.clone(idsToLoadImmediately),this.moduleInfoMap_,null,goog.bind(this.handleLoadError_,this,this.requestedLoadingModuleIds_,idsToLoadImmediately),goog.bind(this.handleLoadTimeout_,this),!!opt_forceReload),delay=this.getBackOff_();if(delay){window.setTimeout(loadFn,delay)}else{loadFn()}};goog.module.ModuleManager.prototype.processModulesForLoad_=function(ids){for(var i=0,moduleInfo;i<ids.length;i++){moduleInfo=this.moduleInfoMap_[ids[i]];if(moduleInfo.isLoaded()){throw Error("Module already loaded: "+ids[i])}}for(var idsWithDeps=[],i=0;i<ids.length;i++){idsWithDeps=idsWithDeps.concat(this.getNotYetLoadedTransitiveDepIds_(ids[i]))}goog.array.removeDuplicates(idsWithDeps);if(!this.batchModeEnabled_&&1<idsWithDeps.length){var idToLoad=idsWithDeps.shift();goog.log.info(this.logger_,"Must load "+idToLoad+" module before "+ids);var queuedModules=goog.array.map(idsWithDeps,function(id){return[id]});this.requestedModuleIdsQueue_=queuedModules.concat(this.requestedModuleIdsQueue_);return[idToLoad]}else{return idsWithDeps}};goog.module.ModuleManager.prototype.getNotYetLoadedTransitiveDepIds_=function(id){var ids=[];if(!goog.array.contains(this.requestedModuleIds_,id)){ids.push(id)}var depIds=goog.array.clone(this.getModuleInfo(id).getDependencies());while(depIds.length){var depId=depIds.pop();if(!this.getModuleInfo(depId).isLoaded()&&!goog.array.contains(this.requestedModuleIds_,depId)){ids.unshift(depId);Array.prototype.unshift.apply(depIds,this.getModuleInfo(depId).getDependencies())}}goog.array.removeDuplicates(ids);return ids};goog.module.ModuleManager.prototype.maybeFinishBaseLoad_=function(){if(this.currentlyLoadingModule_==this.baseModuleInfo_){this.currentlyLoadingModule_=null;var error=this.baseModuleInfo_.onLoad(goog.bind(this.getModuleContext,this));if(error){this.dispatchModuleLoadFailed_(goog.module.ModuleManager.FailureType.INIT_ERROR)}this.dispatchActiveIdleChangeIfNeeded_()}};goog.module.ModuleManager.prototype.setLoaded=function(id){if(this.isDisposed()){goog.log.warning(this.logger_,"Module loaded after module manager was disposed: "+id);return}goog.log.info(this.logger_,"Module loaded: "+id);var error=this.moduleInfoMap_[id].onLoad(goog.bind(this.getModuleContext,this));if(error){this.dispatchModuleLoadFailed_(goog.module.ModuleManager.FailureType.INIT_ERROR)}goog.array.remove(this.userInitiatedLoadingModuleIds_,id);goog.array.remove(this.loadingModuleIds_,id);if(goog.array.isEmpty(this.loadingModuleIds_)){this.loadNextModules_()}if(this.lastInitialModuleId_&&id==this.lastInitialModuleId_){if(!this.initialModulesLoaded_.hasFired()){this.initialModulesLoaded_.callback()}}this.dispatchActiveIdleChangeIfNeeded_()};goog.module.ModuleManager.prototype.isModuleLoading=function(id){if(goog.array.contains(this.loadingModuleIds_,id)){return!0}for(var i=0;i<this.requestedModuleIdsQueue_.length;i++){if(goog.array.contains(this.requestedModuleIdsQueue_[i],id)){return!0}}return!1};goog.module.ModuleManager.prototype.execOnLoad=function(moduleId,fn,opt_handler,opt_noLoad,opt_userInitiated,opt_preferSynchronous){var moduleInfo=this.moduleInfoMap_[moduleId],callbackWrapper;if(moduleInfo.isLoaded()){goog.log.info(this.logger_,moduleId+" module already loaded");callbackWrapper=new goog.module.ModuleLoadCallback(fn,opt_handler);if(opt_preferSynchronous){callbackWrapper.execute(this.moduleContext_)}else{window.setTimeout(goog.bind(callbackWrapper.execute,callbackWrapper),0)}}else if(this.isModuleLoading(moduleId)){goog.log.info(this.logger_,moduleId+" module already loading");callbackWrapper=moduleInfo.registerCallback(fn,opt_handler);if(opt_userInitiated){goog.log.info(this.logger_,"User initiated module already loading: "+moduleId);this.addUserInitiatedLoadingModule_(moduleId);this.dispatchActiveIdleChangeIfNeeded_()}}else{goog.log.info(this.logger_,"Registering callback for module: "+moduleId);callbackWrapper=moduleInfo.registerCallback(fn,opt_handler);if(!opt_noLoad){if(opt_userInitiated){goog.log.info(this.logger_,"User initiated module load: "+moduleId);this.addUserInitiatedLoadingModule_(moduleId)}goog.log.info(this.logger_,"Initiating module load: "+moduleId);this.loadModulesOrEnqueue_([moduleId])}}return callbackWrapper};goog.module.ModuleManager.prototype.load=function(moduleId,opt_userInitiated){return this.loadModulesOrEnqueueIfNotLoadedOrLoading_([moduleId],opt_userInitiated)[moduleId]};goog.module.ModuleManager.prototype.loadMultiple=function(moduleIds,opt_userInitiated){return this.loadModulesOrEnqueueIfNotLoadedOrLoading_(moduleIds,opt_userInitiated)};goog.module.ModuleManager.prototype.addUserInitiatedLoadingModule_=function(id){if(!goog.array.contains(this.userInitiatedLoadingModuleIds_,id)){this.userInitiatedLoadingModuleIds_.push(id)}};goog.module.ModuleManager.prototype.beforeLoadModuleCode=function(id){this.loadTracer_=goog.debug.Trace.startTracer("Module Load: "+id,"Module Load");if(this.currentlyLoadingModule_){goog.log.error(this.logger_,"beforeLoadModuleCode called with module \""+id+"\" while module \""+this.currentlyLoadingModule_.getId()+"\" is loading")}this.currentlyLoadingModule_=this.getModuleInfo(id)};goog.module.ModuleManager.prototype.afterLoadModuleCode=function(id){if(!this.currentlyLoadingModule_||id!=this.currentlyLoadingModule_.getId()){goog.log.error(this.logger_,"afterLoadModuleCode called with module \""+id+"\" while loading module \""+(this.currentlyLoadingModule_&&this.currentlyLoadingModule_.getId())+"\"")}this.currentlyLoadingModule_=null;goog.debug.Trace.stopTracer(this.loadTracer_)};goog.module.ModuleManager.prototype.registerInitializationCallback=function(fn,opt_handler){if(!this.currentlyLoadingModule_){goog.log.error(this.logger_,"No module is currently loading")}else{this.currentlyLoadingModule_.registerEarlyCallback(fn,opt_handler)}};goog.module.ModuleManager.prototype.registerLateInitializationCallback=function(fn,opt_handler){if(!this.currentlyLoadingModule_){goog.log.error(this.logger_,"No module is currently loading")}else{this.currentlyLoadingModule_.registerCallback(fn,opt_handler)}};goog.module.ModuleManager.prototype.setModuleConstructor=function(fn){if(!this.currentlyLoadingModule_){goog.log.error(this.logger_,"No module is currently loading");return}this.currentlyLoadingModule_.setModuleConstructor(fn)};goog.module.ModuleManager.FailureType={UNAUTHORIZED:0,CONSECUTIVE_FAILURES:1,TIMEOUT:2,OLD_CODE_GONE:3,INIT_ERROR:4};goog.module.ModuleManager.prototype.handleLoadError_=function(requestedLoadingModuleIds,requestedModuleIdsWithDeps,status){this.consecutiveFailures_++;this.requestedLoadingModuleIds_=requestedLoadingModuleIds;goog.array.forEach(requestedModuleIdsWithDeps,goog.partial(goog.array.remove,this.requestedModuleIds_),this);if(401==status){goog.log.info(this.logger_,"Module loading unauthorized");this.dispatchModuleLoadFailed_(goog.module.ModuleManager.FailureType.UNAUTHORIZED);this.requestedModuleIdsQueue_.length=0}else if(410==status){this.requeueBatchOrDispatchFailure_(goog.module.ModuleManager.FailureType.OLD_CODE_GONE);this.loadNextModules_()}else if(3<=this.consecutiveFailures_){goog.log.info(this.logger_,"Aborting after failure to load: "+this.loadingModuleIds_);this.requeueBatchOrDispatchFailure_(goog.module.ModuleManager.FailureType.CONSECUTIVE_FAILURES);this.loadNextModules_()}else{goog.log.info(this.logger_,"Retrying after failure to load: "+this.loadingModuleIds_);var forceReload=status==goog.module.ModuleManager.CORRUPT_RESPONSE_STATUS_CODE;this.loadModules_(this.requestedLoadingModuleIds_,!0,forceReload)}};goog.module.ModuleManager.prototype.handleLoadTimeout_=function(){goog.log.info(this.logger_,"Aborting after timeout: "+this.loadingModuleIds_);this.requeueBatchOrDispatchFailure_(goog.module.ModuleManager.FailureType.TIMEOUT);this.loadNextModules_()};goog.module.ModuleManager.prototype.requeueBatchOrDispatchFailure_=function(cause){if(1<this.requestedLoadingModuleIds_.length){var queuedModules=goog.array.map(this.requestedLoadingModuleIds_,function(id){return[id]});this.requestedModuleIdsQueue_=queuedModules.concat(this.requestedModuleIdsQueue_)}else{this.dispatchModuleLoadFailed_(cause)}};goog.module.ModuleManager.prototype.dispatchModuleLoadFailed_=function(cause){var failedIds=this.requestedLoadingModuleIds_;this.loadingModuleIds_.length=0;for(var idsToCancel=[],i=0,dependentModules;i<this.requestedModuleIdsQueue_.length;i++){dependentModules=goog.array.filter(this.requestedModuleIdsQueue_[i],function(requestedId){var requestedDeps=this.getNotYetLoadedTransitiveDepIds_(requestedId);return goog.array.some(failedIds,function(id){return goog.array.contains(requestedDeps,id)})},this);goog.array.extend(idsToCancel,dependentModules)}for(var i=0;i<failedIds.length;i++){goog.array.insert(idsToCancel,failedIds[i])}for(var i=0;i<idsToCancel.length;i++){for(var j=0;j<this.requestedModuleIdsQueue_.length;j++){goog.array.remove(this.requestedModuleIdsQueue_[j],idsToCancel[i])}goog.array.remove(this.userInitiatedLoadingModuleIds_,idsToCancel[i])}var errorCallbacks=this.callbackMap_[goog.module.ModuleManager.CallbackType.ERROR];if(errorCallbacks){for(var i=0,callback;i<errorCallbacks.length;i++){callback=errorCallbacks[i];for(var j=0;j<idsToCancel.length;j++){callback(goog.module.ModuleManager.CallbackType.ERROR,idsToCancel[j],cause)}}}for(var i=0;i<failedIds.length;i++){if(this.moduleInfoMap_[failedIds[i]]){this.moduleInfoMap_[failedIds[i]].onError(cause)}}this.requestedLoadingModuleIds_.length=0;this.dispatchActiveIdleChangeIfNeeded_()};goog.module.ModuleManager.prototype.loadNextModules_=function(){while(this.requestedModuleIdsQueue_.length){var nextIds=goog.array.filter(this.requestedModuleIdsQueue_.shift(),function(id){return!this.getModuleInfo(id).isLoaded()},this);if(0<nextIds.length){this.loadModules_(nextIds);return}}this.dispatchActiveIdleChangeIfNeeded_()};goog.module.ModuleManager.prototype.registerCallback=function(types,fn){if(!goog.isArray(types)){types=[types]}for(var i=0;i<types.length;i++){this.registerCallback_(types[i],fn)}};goog.module.ModuleManager.prototype.registerCallback_=function(type,fn){var callbackMap=this.callbackMap_;if(!callbackMap[type]){callbackMap[type]=[]}callbackMap[type].push(fn)};goog.module.ModuleManager.prototype.executeCallbacks_=function(type){for(var callbacks=this.callbackMap_[type],i=0;callbacks&&i<callbacks.length;i++){callbacks[i](type)}};goog.module.ModuleManager.prototype.disposeInternal=function(){goog.module.ModuleManager.base(this,"disposeInternal");goog.disposeAll(goog.object.getValues(this.moduleInfoMap_),this.baseModuleInfo_);this.moduleInfoMap_=null;this.loadingModuleIds_=null;this.requestedLoadingModuleIds_=null;this.userInitiatedLoadingModuleIds_=null;this.requestedModuleIdsQueue_=null;this.callbackMap_=null};