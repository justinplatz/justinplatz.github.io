<!DOCTYPE html><html><head><title>Closure Unit Tests - goog.async.DeferredList</title><script src="../../../../../closure/goog/base.js"></script><script>goog.require("goog.array");goog.require("goog.async.Deferred");goog.require("goog.async.DeferredList");goog.require("goog.testing.jsunit");</script></head><body><script>var Deferred=goog.async.Deferred,DeferredList=goog.async.DeferredList;Deferred.STRICT_ERRORS=!0;var storedErrors=[];function addCatchAll(var_args){for(var i=0,d;d=arguments[i];i++){d.addErrback(function(res){storedErrors.push(res)})}}function checkCatchAll(){var err=storedErrors.shift();goog.array.clear(storedErrors);if(err){throw err}}function tearDown(){checkCatchAll()}function neverHappen(res){fail("This should not happen")}function testNoInputs(){var count=0,d=new DeferredList([]);d.addCallback(function(res){assertArrayEquals([],res);count++});addCatchAll(d);assertEquals("An empty DeferredList should fire immediately with an empty "+"list of results.",1,count)}function testNoInputsAndFireOnOneCallback(){var count=0,d=new DeferredList([],!0);d.addCallback(function(res){assertArrayEquals([],res);count++});addCatchAll(d);assertEquals("An empty DeferredList with opt_fireOnOneCallback set should "+"not fire unless callback is invoked explicitly.",0,count);d.callback([]);assertEquals("Calling callback explicitly should still fire.",1,count)}function testDeferredList(){var count=0,results,a=new Deferred,b=new Deferred,c=new Deferred,dl=new DeferredList([a,b,c]);dl.addCallback(function(res){assertEquals("Expected 3 Deferred results.",3,res.length);assertTrue("Deferred a should return success.",res[0][0]);assertFalse("Deferred b should return failure.",res[1][0]);assertTrue("Deferred c should return success.",res[2][0]);assertEquals("Unexpected return value for a.","A",res[0][1]);assertEquals("Unexpected return value for c.","C",res[2][1]);assertEquals("B",res[1][1]);count++});addCatchAll(dl);c.callback("C");assertEquals(0,count);b.errback("B");assertEquals(0,count);a.callback("A");checkCatchAll();assertEquals("DeferredList should fire on last call or errback.",1,count)}function testFireOnFirstCallback(){var a=new Deferred,b=new Deferred,c=new Deferred,dl=new DeferredList([a,b,c],!0);dl.addCallback(function(res){assertEquals("Should be the deferred index in this mode.",1,res[0]);assertEquals("B",res[1])});dl.addErrback(neverHappen);addCatchAll(dl);a.errback("A");b.callback("B");c.callback("C")}function testFireOnFirstErrback(){var a=new Deferred,b=new Deferred,c=new Deferred,dl=new DeferredList([a,b,c],!1,!0);dl.addCallback(neverHappen);dl.addErrback(function(res){assertEquals("A",res);return null});addCatchAll(dl);b.callback("B");a.errback("A");assertTrue(c.hasFired());c.addErrback(function(res){assertTrue("The DeferredList errback should have canceled all pending inputs.",res instanceof Deferred.CanceledError);return null});addCatchAll(c);c.callback("C")}function testNoConsumeErrors(){var count=0,a=new Deferred,dl=new DeferredList([a]);a.addErrback(function(res){count++;return null});addCatchAll(a,dl);a.errback("oh noes");assertEquals(1,count)}function testConsumeErrors(){var count=0,a=new Deferred,dl=new DeferredList([a],!1,!1,!0);a.addErrback(neverHappen);addCatchAll(a,dl);a.errback("oh noes");assertEquals(0,count)}function testNesting(){function upperCase(res){return res.toUpperCase()}function combine(res){return goog.array.map(res,function(result){return result[1]}).join("")}var a=new Deferred,b=new Deferred,c=new Deferred,d=new Deferred;a.addCallback(upperCase);b.addCallback(upperCase);c.addCallback(upperCase);d.addCallback(upperCase);var dl1=new DeferredList([a,b]),dl2=new DeferredList([c,d]);dl1.addCallback(combine);dl2.addCallback(combine);var dl3=new DeferredList([dl1,dl2]);dl3.addCallback(combine);dl3.addCallback(function(res){assertEquals("AbCd",res)});addCatchAll(dl1,dl2,dl3);a.callback("a");c.callback("c");b.errback("b");d.errback("d")}function testGatherResults(){var a=new Deferred,b=new Deferred,c=new Deferred,dl=DeferredList.gatherResults([a,b,c]);dl.addCallback(function(res){assertArrayEquals(["A","B","C"],res)});addCatchAll(dl);b.callback("B");a.callback("A");c.callback("C")}function testGatherResultsFailure(){var a=new Deferred,b=new Deferred,c=new Deferred,dl=DeferredList.gatherResults([a,b,c]),firedErrback=!1,firedCallback=!1;dl.addCallback(function(){firedCallback=!0});dl.addErrback(function(){firedErrback=!0;return null});addCatchAll(dl);b.callback("B");a.callback("A");c.errback();assertTrue("Errback should be called",firedErrback);assertFalse("Callback should not be called",firedCallback)}function testGatherResults_cancelCancelsChildren(){var canceled=[],a=new Deferred(function(){canceled.push("a")}),b=new Deferred(function(){canceled.push("b")}),c=new Deferred(function(){canceled.push("c")}),dl=new DeferredList([a,b,c]),firedErrback=!1,firedCallback=!1;dl.addCallback(function(){firedCallback=!0});dl.addErrback(function(){firedErrback=!0;return null});addCatchAll(dl);b.callback("b");dl.cancel();assertTrue("Errback should be called",firedErrback);assertFalse("Callback should not be called",firedCallback);assertArrayEquals(["a","c"],canceled)}function testErrorCancelsPendingChildrenWhenFireOnFirstError(){var canceled=[],a=new Deferred(function(){canceled.push("a")}),b=new Deferred(function(){canceled.push("b")}),c=new Deferred(function(){canceled.push("c")}),dl=new DeferredList([a,b,c],!1,!0),firedErrback=!1,firedCallback=!1;dl.addCallback(function(){firedCallback=!0});dl.addErrback(function(){firedErrback=!0;return null});addCatchAll(dl);a.callback("a");b.errback();assertTrue("Errback should be called",firedErrback);assertFalse("Callback should not be called",firedCallback);assertArrayEquals("Only C should be canceled since A and B fired.",["c"],canceled)}function testErrorDoesNotCancelPendingChildrenForVanillaLists(){var canceled=[],a=new Deferred(function(){canceled.push("a")}),b=new Deferred(function(){canceled.push("b")}),c=new Deferred(function(){canceled.push("c")}),dl=new DeferredList([a,b,c]),firedErrback=!1,firedCallback=!1;dl.addCallback(function(){firedCallback=!0});dl.addErrback(function(){firedErrback=!0;return null});addCatchAll(dl);a.callback("a");b.errback();c.callback("c");assertFalse("Errback should not be called",firedErrback);assertTrue("Callback should be called",firedCallback);assertArrayEquals("No cancellations",[],canceled)}function testInputDeferredsStillUsable(){var increment=function(res){return res+1},incrementErrback=function(res){throw res+1},aComplete=!1,bComplete=!1,hadListCallback=!1,a=new Deferred().addCallback(increment),b=new Deferred().addErrback(incrementErrback),c=new Deferred,dl=new DeferredList([a,b,c]);a.callback(0);a.addCallback(increment);a.addCallback(function(res){aComplete=!0;assertEquals("The \"a\" Deferred should have had two increment callbacks.",2,res)});assertTrue("The \"a\" deferred should complete before the list.",aComplete);b.errback(0);b.addErrback(incrementErrback);b.addErrback(function(res){bComplete=!0;assertEquals("The \"b\" Deferred should have had two increment errbacks.",2,res)});assertTrue("The \"b\" deferred should complete before the list.",bComplete);assertFalse("The list should not fire until every input has.",dl.hasFired());c.callback();assertTrue(dl.hasFired());assertFalse(hadListCallback);dl.addCallback(function(results){hadListCallback=!0;var aResult=results[0],bResult=results[1],cResult=results[2];assertTrue(aResult[0]);assertEquals("Should see the result from before the second callback was added.",1,aResult[1]);assertFalse(bResult[0]);assertEquals("Should see the result from before the second errback was added.",1,aResult[1]);assertTrue(cResult[0])});assertTrue(hadListCallback);addCatchAll(dl)}</script></body></html>