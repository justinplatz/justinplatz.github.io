goog.provide("svgpan.SvgPan");goog.require("goog.Disposable");goog.require("goog.events");goog.require("goog.events.EventType");goog.require("goog.events.MouseWheelHandler");svgpan.SvgPan=function(opt_graphElementId,opt_root){svgpan.SvgPan.base(this,"constructor");this.root_=opt_root||document.documentElement;this.graphElementId_=opt_graphElementId||null;this.cancelNextClick_=!1;this.enablePan_=!0;this.enableZoom_=!0;this.enableDrag_=!1;this.zoomScale_=.4;this.state_=svgpan.SvgPan.State.NONE;this.svgRoot_=null;this.stateTarget_=null;this.stateOrigin_=null;this.stateTf_=null;this.mouseWheelHandler_=null;this.setupHandlers_()};goog.inherits(svgpan.SvgPan,goog.Disposable);svgpan.SvgPan.prototype.disposeInternal=function(){svgpan.SvgPan.base(this,"disposeInternal");goog.events.removeAll(this.root_);this.mouseWheelHandler_.dispose()};svgpan.SvgPan.State={NONE:"none",PAN:"pan",DRAG:"drag"};svgpan.SvgPan.prototype.setPanEnabled=function(enabled){this.enablePan_=enabled};svgpan.SvgPan.prototype.setZoomEnabled=function(enabled){this.enableZoom_=enabled};svgpan.SvgPan.prototype.setDragEnabled=function(enabled){this.enableDrag_=enabled};svgpan.SvgPan.prototype.setZoomScale=function(scale){this.zoomScale_=scale};svgpan.SvgPan.prototype.setupHandlers_=function(){goog.events.listen(this.root_,goog.events.EventType.CLICK,goog.bind(this.handleMouseClick_,this));goog.events.listen(this.root_,goog.events.EventType.MOUSEUP,goog.bind(this.handleMouseUp_,this));goog.events.listen(this.root_,goog.events.EventType.MOUSEDOWN,goog.bind(this.handleMouseDown_,this));goog.events.listen(this.root_,goog.events.EventType.MOUSEMOVE,goog.bind(this.handleMouseMove_,this));this.mouseWheelHandler_=new goog.events.MouseWheelHandler(this.root_);goog.events.listen(this.mouseWheelHandler_,goog.events.MouseWheelHandler.EventType.MOUSEWHEEL,goog.bind(this.handleMouseWheel_,this))};svgpan.SvgPan.prototype.getRoot_=function(svgDoc){if(!this.svgRoot_){var r=this.graphElementId_?svgDoc.getElementById(this.graphElementId_):svgDoc.documentElement,t=r;while(t!=svgDoc){if(t.getAttribute("viewBox")){this.setCtm_(r,r.getCTM());t.removeAttribute("viewBox")}t=t.parentNode}this.svgRoot_=r}return this.svgRoot_};svgpan.SvgPan.prototype.getEventPoint_=function(evt){return this.newPoint_(evt.clientX,evt.clientY)};svgpan.SvgPan.prototype.newPoint_=function(x,y){var p=this.root_.createSVGPoint();p.x=x;p.y=y;return p};svgpan.SvgPan.prototype.setCtm_=function(element,matrix){var s="matrix("+matrix.a+","+matrix.b+","+matrix.c+","+matrix.d+","+matrix.e+","+matrix.f+")";element.setAttribute("transform",s)};svgpan.SvgPan.prototype.handleMouseWheel_=function(evt){if(!this.enableZoom_)return;evt.preventDefault();var svgDoc=evt.target.ownerDocument,delta=evt.deltaY/-9,z=Math.pow(1+this.zoomScale_,delta),g=this.getRoot_(svgDoc),p=this.getEventPoint_(evt);p=p.matrixTransform(g.getCTM().inverse());var k=this.root_.createSVGMatrix().translate(p.x,p.y).scale(z).translate(-p.x,-p.y);this.setCtm_(g,g.getCTM().multiply(k));if("undefined"==typeof this.stateTf_){this.stateTf_=g.getCTM().inverse()}this.stateTf_=this.stateTf_?this.stateTf_.multiply(k.inverse()):this.stateTf_};svgpan.SvgPan.prototype.handleMouseMove_=function(evt){if(0!=evt.button){return}this.handleMove(evt.clientX,evt.clientY,evt.target.ownerDocument)};svgpan.SvgPan.prototype.handleMove=function(x,y,svgDoc){var g=this.getRoot_(svgDoc);if(this.state_==svgpan.SvgPan.State.PAN&&this.enablePan_){var p=this.newPoint_(x,y).matrixTransform(this.stateTf_);this.setCtm_(g,this.stateTf_.inverse().translate(p.x-this.stateOrigin_.x,p.y-this.stateOrigin_.y));this.cancelNextClick_=!0}else if(this.state_==svgpan.SvgPan.State.DRAG&&this.enableDrag_){var p=this.newPoint_(x,y).matrixTransform(g.getCTM().inverse());this.setCtm_(this.stateTarget_,this.root_.createSVGMatrix().translate(p.x-this.stateOrigin_.x,p.y-this.stateOrigin_.y).multiply(g.getCTM().inverse()).multiply(this.stateTarget_.getCTM()));this.stateOrigin_=p}};svgpan.SvgPan.prototype.handleMouseDown_=function(evt){if(0!=evt.button){return}evt.preventDefault();var svgDoc=evt.target.ownerDocument,g=this.getRoot_(svgDoc);if("svg"==evt.target.tagName||!this.enableDrag_){this.state_=svgpan.SvgPan.State.PAN;this.stateTf_=g.getCTM().inverse();this.stateOrigin_=this.getEventPoint_(evt).matrixTransform(this.stateTf_)}else{this.state_=svgpan.SvgPan.State.DRAG;this.stateTarget_=evt.target;this.stateTf_=g.getCTM().inverse();this.stateOrigin_=this.getEventPoint_(evt).matrixTransform(this.stateTf_)}};svgpan.SvgPan.prototype.handleMouseUp_=function(evt){if(this.state_!=svgpan.SvgPan.State.NONE){this.endPanOrDrag()}};svgpan.SvgPan.prototype.endPanOrDrag=function(){if(this.state_!=svgpan.SvgPan.State.NONE){this.state_=svgpan.SvgPan.State.NONE}};svgpan.SvgPan.prototype.handleMouseClick_=function(evt){if(this.cancelNextClick_){evt.stopPropagation();evt.preventDefault()}this.cancelNextClick_=!1};svgpan.SvgPan.prototype.getState=function(){return this.state_};